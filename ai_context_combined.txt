Project Root: C:\Users\isy73\remix-of-botida-flow
Included Targets: public, supabase, src



============================================================
File Path: .env
============================================================
VITE_SUPABASE_PROJECT_ID="matcnptzugnaisuhowbk"
VITE_SUPABASE_PUBLISHABLE_KEY="sb_publishable_nLy7XdGa-odfm4xyvFq2Fw_XPCiA2Bj"
VITE_SUPABASE_URL="https://matcnptzugnaisuhowbk.supabase.co"


============================================================
File Path: components.json
============================================================
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "src/index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  }
}



============================================================
File Path: eslint.config.js
============================================================
import js from "@eslint/js";
import globals from "globals";
import reactHooks from "eslint-plugin-react-hooks";
import reactRefresh from "eslint-plugin-react-refresh";
import tseslint from "typescript-eslint";

export default tseslint.config(
  { ignores: ["dist"] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      "react-hooks": reactHooks,
      "react-refresh": reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      "react-refresh/only-export-components": ["warn", { allowConstantExport: true }],
      "@typescript-eslint/no-unused-vars": "off",
    },
  },
);



============================================================
File Path: index.html
============================================================
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArkPort - 차세대 엔터프라이즈 관리 시스템</title>
    <meta name="description" content="ArkPort - 멀티 테넌트 아키텍처 기반의 올인원 비즈니스 운영 플랫폼. 청구 관리부터 전자결재, 그룹웨어까지." />
    <meta name="author" content="ArkPort" />
    <meta name="robots" content="index, follow" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <meta property="og:title" content="ArkPort - 차세대 엔터프라이즈 관리 시스템" />
    <meta property="og:description" content="ArkPort - 멀티 테넌트 아키텍처 기반의 올인원 비즈니스 운영 플랫폼" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@BotedaOS" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>



============================================================
File Path: package.json
============================================================
{
  "name": "vite_react_shadcn_ts",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:dev": "vite build --mode development",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "^1.2.11",
    "@radix-ui/react-alert-dialog": "^1.1.14",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-avatar": "^1.1.10",
    "@radix-ui/react-checkbox": "^1.3.2",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-context-menu": "^2.2.15",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-dropdown-menu": "^2.1.15",
    "@radix-ui/react-hover-card": "^1.1.14",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-menubar": "^1.1.15",
    "@radix-ui/react-navigation-menu": "^1.2.13",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-progress": "^1.1.7",
    "@radix-ui/react-radio-group": "^1.3.7",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.5",
    "@radix-ui/react-separator": "^1.1.7",
    "@radix-ui/react-slider": "^1.3.5",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-tabs": "^1.1.12",
    "@radix-ui/react-toast": "^1.2.14",
    "@radix-ui/react-toggle": "^1.1.9",
    "@radix-ui/react-toggle-group": "^1.1.10",
    "@radix-ui/react-tooltip": "^1.2.7",
    "@supabase/supabase-js": "^2.90.1",
    "@tanstack/react-query": "^5.83.0",
    "@types/dompurify": "^3.2.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^3.6.0",
    "dompurify": "^3.3.1",
    "embla-carousel-react": "^8.6.0",
    "html2canvas": "^1.4.1",
    "input-otp": "^1.4.2",
    "jspdf": "^4.1.0",
    "lucide-react": "^0.462.0",
    "next-themes": "^0.3.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.61.1",
    "react-resizable-panels": "^2.1.9",
    "react-router-dom": "^6.30.1",
    "recharts": "^2.15.4",
    "sonner": "^1.7.4",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^0.9.9",
    "xlsx": "^0.18.5",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "@eslint/js": "^9.32.0",
    "@tailwindcss/typography": "^0.5.16",
    "@testing-library/jest-dom": "^6.6.0",
    "@testing-library/react": "^16.0.0",
    "@types/node": "^22.16.5",
    "@types/react": "^18.3.23",
    "@types/react-dom": "^18.3.7",
    "@vitejs/plugin-react-swc": "^3.11.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.32.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.20",
    "globals": "^15.15.0",
    "jsdom": "^20.0.3",
    "lovable-tagger": "^1.1.13",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.8.3",
    "typescript-eslint": "^8.38.0",
    "vite": "^5.4.19",
    "vitest": "^3.2.4"
  }
}



============================================================
File Path: postcss.config.js
============================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};



============================================================
File Path: README.md
============================================================
# Welcome to your Lovable project

## Project info

**URL**: https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID

## How can I edit this code?

There are several ways of editing your application.

**Use Lovable**

Simply visit the [Lovable Project](https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID) and start prompting.

Changes made via Lovable will be committed automatically to this repo.

**Use your preferred IDE**

If you want to work locally using your own IDE, you can clone this repo and push changes. Pushed changes will also be reflected in Lovable.

The only requirement is having Node.js & npm installed - [install with nvm](https://github.com/nvm-sh/nvm#installing-and-updating)

Follow these steps:

```sh
# Step 1: Clone the repository using the project's Git URL.
git clone <YOUR_GIT_URL>

# Step 2: Navigate to the project directory.
cd <YOUR_PROJECT_NAME>

# Step 3: Install the necessary dependencies.
npm i

# Step 4: Start the development server with auto-reloading and an instant preview.
npm run dev
```

**Edit a file directly in GitHub**

- Navigate to the desired file(s).
- Click the "Edit" button (pencil icon) at the top right of the file view.
- Make your changes and commit the changes.

**Use GitHub Codespaces**

- Navigate to the main page of your repository.
- Click on the "Code" button (green button) near the top right.
- Select the "Codespaces" tab.
- Click on "New codespace" to launch a new Codespace environment.
- Edit files directly within the Codespace and commit and push your changes once you're done.

## What technologies are used for this project?

This project is built with:

- Vite
- TypeScript
- React
- shadcn-ui
- Tailwind CSS

## How can I deploy this project?

Simply open [Lovable](https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID) and click on Share -> Publish.

## Can I connect a custom domain to my Lovable project?

Yes, you can!

To connect a domain, navigate to Project > Settings > Domains and click Connect Domain.

Read more here: [Setting up a custom domain](https://docs.lovable.dev/features/custom-domain#custom-domain)



============================================================
File Path: tsconfig.app.json
============================================================
{
  "compilerOptions": {
    "types": ["vitest/globals"],
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noImplicitAny": false,
    "noFallthroughCasesInSwitch": false,

    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"]
}



============================================================
File Path: tsconfig.json
============================================================
{
  "files": [],
  "references": [{ "path": "./tsconfig.app.json" }, { "path": "./tsconfig.node.json" }],
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "noImplicitAny": false,
    "noUnusedParameters": false,
    "skipLibCheck": true,
    "allowJs": true,
    "noUnusedLocals": false,
    "strictNullChecks": false
  }
}



============================================================
File Path: tsconfig.node.json
============================================================
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["vite.config.ts"]
}



============================================================
File Path: public/robots.txt
============================================================
User-agent: Googlebot
Allow: /

User-agent: Bingbot
Allow: /

User-agent: Twitterbot
Allow: /

User-agent: facebookexternalhit
Allow: /

User-agent: *
Allow: /



============================================================
File Path: supabase/config.toml
============================================================
project_id = "matcnptzugnaisuhowbk"


============================================================
File Path: supabase/.temp/cli-latest
============================================================
v2.72.7


============================================================
File Path: supabase/.temp/gotrue-version
============================================================
v2.186.0


============================================================
File Path: supabase/.temp/pooler-url
============================================================
postgresql://postgres.matcnptzugnaisuhowbk@aws-1-ap-south-1.pooler.supabase.com:5432/postgres


============================================================
File Path: supabase/.temp/postgres-version
============================================================
17.6.1.063


============================================================
File Path: supabase/.temp/project-ref
============================================================
matcnptzugnaisuhowbk


============================================================
File Path: supabase/.temp/rest-version
============================================================
v14.1


============================================================
File Path: supabase/.temp/storage-migration
============================================================
fix-optimized-search-function


============================================================
File Path: supabase/.temp/storage-version
============================================================
v1.37.7


============================================================
File Path: supabase/functions/analyze-artist-trends/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Verify authentication
    const authHeader = req.headers.get("Authorization");
    if (!authHeader?.startsWith("Bearer ")) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const supabaseClient = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      { global: { headers: { Authorization: authHeader } } }
    );

    const token = authHeader.replace("Bearer ", "");
    const { data: claimsData, error: claimsError } = await supabaseClient.auth.getClaims(token);
    if (claimsError || !claimsData?.claims) {
      return new Response(
        JSON.stringify({ error: "Invalid token" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const { artistName, stageName } = await req.json();
    const searchName = stageName || artistName;

    if (!searchName) {
      return new Response(
        JSON.stringify({ error: "아티스트 이름이 필요합니다." }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // AI를 사용해서 마켓 인사이트 데이터 생성
    const systemPrompt = `당신은 한국 엔터테인먼트 산업 전문 마케팅 애널리스트입니다. 
주어진 연예인/아티스트 이름에 대해 시장 분석 데이터를 JSON 형식으로 생성해주세요.

다음 형식으로 응답해주세요:
{
  "searchVolume": {
    "monthly": 숫자 (월간 검색량 추정치),
    "trend": "up" | "stable" | "down" (트렌드 방향),
    "changePercent": 숫자 (-100 ~ 100, 전월 대비 변화율)
  },
  "contentSaturation": {
    "percentage": 숫자 (0-100, 콘텐츠 포화도),
    "level": "매우 낮음" | "낮음" | "보통" | "높음" | "매우 높음"
  },
  "audienceInterest": {
    "grade": "A" | "B" | "C" | "D" (관심도 등급),
    "description": "한 줄 설명"
  },
  "demographics": {
    "femaleRatio": 숫자 (0-100, 여성 비율),
    "topAgeGroups": [
      { "age": "20대", "percentage": 숫자 },
      { "age": "30대", "percentage": 숫자 },
      { "age": "40대", "percentage": 숫자 }
    ]
  },
  "keywords": ["키워드1", "키워드2", ...] (최대 15개),
  "trendData": [
    { "year": "2020", "value": 숫자 (0-100) },
    { "year": "2021", "value": 숫자 },
    { "year": "2022", "value": 숫자 },
    { "year": "2023", "value": 숫자 },
    { "year": "2024", "value": 숫자 },
    { "year": "2025", "value": 숫자 }
  ],
  "summary": "3-4문장의 마케팅 전략 요약"
}

실제 인지도 트렌드를 반영하여 현실적인 수치를 생성해주세요.`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-3-flash-preview",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: `아티스트 "${searchName}"에 대한 마켓 인사이트 분석을 생성해주세요.` }
        ],
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(
          JSON.stringify({ error: "요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요." }),
          { status: 429, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      if (response.status === 402) {
        return new Response(
          JSON.stringify({ error: "크레딧이 부족합니다. 워크스페이스에 크레딧을 추가해주세요." }),
          { status: 402, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      throw new Error("AI 분석 중 오류가 발생했습니다.");
    }

    const aiResult = await response.json();
    const content = aiResult.choices?.[0]?.message?.content;

    if (!content) {
      throw new Error("AI 응답이 비어있습니다.");
    }

    // JSON 파싱 시도
    let analysisData;
    try {
      // JSON 블록 추출 (```json ... ``` 형태 처리)
      const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/\{[\s\S]*\}/);
      const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : content;
      analysisData = JSON.parse(jsonStr);
    } catch (parseError) {
      console.error("JSON parse error:", parseError, "Content:", content);
      throw new Error("분석 결과 파싱에 실패했습니다.");
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        artistName: searchName,
        analysis: analysisData,
        generatedAt: new Date().toISOString()
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error) {
    console.error("analyze-artist-trends error:", error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : "알 수 없는 오류가 발생했습니다." }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});



============================================================
File Path: supabase/functions/auto-clock-out/index.ts
============================================================
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabase = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
    );

    // auto_clock_out DB 함수 호출
    const { data, error } = await supabase.rpc("auto_clock_out");

    if (error) {
      console.error("auto_clock_out error:", error);
      return new Response(
        JSON.stringify({ error: error.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`Auto clock-out processed: ${data} records affected`);

    return new Response(
      JSON.stringify({ success: true, affected: data }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("Unexpected error:", err);
    return new Response(
      JSON.stringify({ error: "Internal server error" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});



============================================================
File Path: supabase/functions/backup-to-drive/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

interface BackupRequest {
  tenantId: string;
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Verify authorization
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Initialize Supabase client
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Verify user token
    const token = authHeader.replace("Bearer ", "");
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);
    
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: "Invalid token" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Parse request body
    const { tenantId }: BackupRequest = await req.json();

    if (!tenantId) {
      return new Response(
        JSON.stringify({ error: "Missing required field: tenantId" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Check user is admin of tenant
    const { data: membership, error: membershipError } = await supabase
      .from("tenant_memberships")
      .select("role")
      .eq("tenant_id", tenantId)
      .eq("user_id", user.id)
      .single();

    if (membershipError || !membership || membership.role !== "company_admin") {
      return new Response(
        JSON.stringify({ error: "Only company admins can create backups" }),
        { status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Get tenant's Google credentials
    const { data: tenant, error: tenantError } = await supabase
      .from("tenants")
      .select("*")
      .eq("id", tenantId)
      .single();

    if (tenantError || !tenant) {
      return new Response(
        JSON.stringify({ error: "Tenant not found" }),
        { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (!tenant.google_credentials || !tenant.drive_folder_id) {
      return new Response(
        JSON.stringify({ error: "Google Drive not configured for this tenant" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Collect all tenant data
    const backupData = await collectTenantData(supabase, tenantId);

    // Decode credentials (base64 -> JSON)
    const credentialsJson = atob(tenant.google_credentials);
    const credentials = JSON.parse(credentialsJson);

    // Get Google access token
    const accessToken = await getGoogleAccessToken(credentials);

    // Create backup folder
    const backupFolderId = await getOrCreateSubfolder(accessToken, tenant.drive_folder_id, "Backups");

    // Generate backup file
    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    const fileName = `backup_${tenant.name}_${timestamp}.json`;
    const fileContent = btoa(unescape(encodeURIComponent(JSON.stringify(backupData, null, 2))));

    // Upload to Google Drive
    const driveResult = await uploadToGoogleDrive(
      accessToken,
      backupFolderId,
      fileName,
      fileContent,
      "application/json"
    );

    return new Response(
      JSON.stringify({
        success: true,
        message: "Backup created successfully",
        fileId: driveResult.id,
        fileName: driveResult.name,
        webViewLink: driveResult.webViewLink,
        backupTimestamp: new Date().toISOString(),
        recordCounts: {
          tenant: 1,
          memberships: backupData.memberships.length,
          invoices: backupData.invoices.length,
          attachments: backupData.attachments.length,
        },
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("Backup error:", err);
    const errorMessage = err instanceof Error ? err.message : "Backup failed";
    return new Response(
      JSON.stringify({ error: errorMessage }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

// Collect all tenant-related data
// deno-lint-ignore no-explicit-any
async function collectTenantData(supabase: any, tenantId: string) {
  // Get memberships with profile data
  const { data: memberships } = await supabase
    .from("tenant_memberships")
    .select(`
      id,
      role,
      department,
      job_title,
      created_at,
      user_id,
      profiles:user_id (
        email,
        full_name,
        phone
      )
    `)
    .eq("tenant_id", tenantId);

  // Get invoices
  const { data: invoices } = await supabase
    .from("vendor_invoices")
    .select("*")
    .eq("tenant_id", tenantId);

  // Get attachments for invoices
  // deno-lint-ignore no-explicit-any
  const invoiceIds = invoices?.map((i: any) => i.id) || [];
  const { data: attachments } = await supabase
    .from("invoice_attachments")
    .select("*")
    .in("invoice_id", invoiceIds.length > 0 ? invoiceIds : ["none"]);

  return {
    backupVersion: "1.0",
    createdAt: new Date().toISOString(),
    tenantId,
    memberships: memberships || [],
    invoices: invoices || [],
    attachments: attachments || [],
  };
}

// Get Google OAuth2 access token using service account
async function getGoogleAccessToken(credentials: {
  client_email: string;
  private_key: string;
}): Promise<string> {
  const now = Math.floor(Date.now() / 1000);
  const payload = {
    iss: credentials.client_email,
    scope: "https://www.googleapis.com/auth/drive.file",
    aud: "https://oauth2.googleapis.com/token",
    iat: now,
    exp: now + 3600,
  };

  const header = { alg: "RS256", typ: "JWT" };
  const encodedHeader = base64UrlEncode(JSON.stringify(header));
  const encodedPayload = base64UrlEncode(JSON.stringify(payload));
  const signatureInput = `${encodedHeader}.${encodedPayload}`;

  const privateKey = await crypto.subtle.importKey(
    "pkcs8",
    pemToArrayBuffer(credentials.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const signature = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    privateKey,
    new TextEncoder().encode(signatureInput)
  );

  const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));
  const jwt = `${signatureInput}.${encodedSignature}`;

  const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
    }),
  });

  const tokenData = await tokenResponse.json();
  if (!tokenData.access_token) {
    throw new Error("Failed to get Google access token");
  }

  return tokenData.access_token;
}

// Upload file to Google Drive
async function uploadToGoogleDrive(
  accessToken: string,
  folderId: string,
  fileName: string,
  fileContent: string,
  mimeType: string
): Promise<{ id: string; name: string; webViewLink: string }> {
  const binaryContent = Uint8Array.from(atob(fileContent), (c) => c.charCodeAt(0));

  const boundary = "---MultipartBoundary" + Date.now();
  const metadata = { name: fileName, parents: [folderId] };
  const metadataPart = JSON.stringify(metadata);

  const multipartBody = new Uint8Array([
    ...new TextEncoder().encode(
      `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${metadataPart}\r\n--${boundary}\r\nContent-Type: ${mimeType}\r\nContent-Transfer-Encoding: base64\r\n\r\n`
    ),
    ...binaryContent,
    ...new TextEncoder().encode(`\r\n--${boundary}--`),
  ]);

  const response = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink",
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": `multipart/related; boundary=${boundary}`,
      },
      body: multipartBody,
    }
  );

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Google Drive upload failed: ${error}`);
  }

  return response.json();
}

// Get or create subfolder
async function getOrCreateSubfolder(
  accessToken: string,
  parentId: string,
  folderName: string
): Promise<string> {
  const searchResponse = await fetch(
    `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(folderName)}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );

  const searchResult = await searchResponse.json();
  if (searchResult.files && searchResult.files.length > 0) {
    return searchResult.files[0].id;
  }

  const createResponse = await fetch("https://www.googleapis.com/drive/v3/files", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      name: folderName,
      mimeType: "application/vnd.google-apps.folder",
      parents: [parentId],
    }),
  });

  const folder = await createResponse.json();
  return folder.id;
}

function base64UrlEncode(str: string): string {
  return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function pemToArrayBuffer(pem: string): ArrayBuffer {
  const b64 = pem
    .replace(/-----BEGIN PRIVATE KEY-----/, "")
    .replace(/-----END PRIVATE KEY-----/, "")
    .replace(/\s/g, "");
  const binary = atob(b64);
  const buffer = new ArrayBuffer(binary.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return buffer;
}



============================================================
File Path: supabase/functions/codef-api/index.ts
============================================================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import forge from "npm:node-forge@1.3.1";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

const TOKEN_URL = "https://oauth.codef.io/oauth/token";
const BASE_URL = "https://development.codef.io";
const CREATE_ACCOUNT_URL = `${BASE_URL}/v1/account/create`;

function encryptRsa(plainText: string, publicKeyPem: string): string {
  const publicKey = forge.pki.publicKeyFromPem(publicKeyPem);
  const encrypted = publicKey.encrypt(plainText, "RSAES-PKCS1-V1_5");
  return forge.util.encode64(encrypted);
}

async function getAccessToken(clientId: string, clientSecret: string): Promise<string> {
  const authStr = `${clientId}:${clientSecret}`;
  const b64Auth = btoa(authStr);

  const response = await fetch(TOKEN_URL, {
    method: "POST",
    headers: {
      Authorization: `Basic ${b64Auth}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "grant_type=client_credentials&scope=read",
  });

  if (!response.ok) {
    const text = await response.text();
    throw new Error(`토큰 발급 실패 [${response.status}]: ${text}`);
  }

  const data = await response.json();
  if (!data.access_token) throw new Error("access_token이 응답에 없습니다.");
  return data.access_token;
}

async function parseSafeJSON(response: Response) {
  const raw = await response.text();
  let decoded = raw;
  try { decoded = decodeURIComponent(raw); } catch (_) {}
  try {
    return JSON.parse(decoded);
  } catch (_) {
    try {
      return JSON.parse(raw);
    } catch (_) {
      throw new Error(`CODEF 응답 파싱 실패: ${raw.substring(0, 200)}`);
    }
  }
}

async function getCodefConfigs(supabase: any, tenantId: string) {
  const { data: configs, error } = await supabase
    .from("tenant_api_configs")
    .select("config_key, config_value")
    .eq("tenant_id", tenantId)
    .in("config_key", ["CODEF_CLIENT_ID", "CODEF_CLIENT_SECRET", "CODEF_PUBLIC_KEY"]);

  if (error) throw new Error(`설정 조회 실패: ${error.message}`);

  const configMap: Record<string, string> = {};
  (configs || []).forEach((c: any) => { configMap[c.config_key] = c.config_value; });

  const clientId = configMap["CODEF_CLIENT_ID"];
  const clientSecret = configMap["CODEF_CLIENT_SECRET"];
  const publicKey = configMap["CODEF_PUBLIC_KEY"];

  if (!clientId || !clientSecret) {
    throw new Error("CODEF API 설정(CLIENT_ID, CLIENT_SECRET)이 누락되었습니다.");
  }

  return { clientId, clientSecret, publicKey };
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const body = await req.json();
    const { action, tenantId } = body;

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, serviceRoleKey);

    const configs = await getCodefConfigs(supabase, tenantId);
    const token = await getAccessToken(configs.clientId, configs.clientSecret);

    let result: any;

    if (action === "create_connected_id") {
      // ─── 기존: Connected ID 생성 ───
      const { businessType, organization, derFile, keyFile, password, loginId } = body;

      if (!configs.publicKey) throw new Error("CODEF PUBLIC_KEY가 누락되었습니다.");
      const encryptedPw = encryptRsa(password, configs.publicKey);

      let accountEntry: Record<string, any>;
      if (businessType === "BK") {
        if (!derFile || !keyFile) throw new Error("은행 연동에는 인증서 파일(der, key)이 필요합니다.");
        accountEntry = {
          countryCode: "KR", businessType: "BK", clientType: "B",
          organization, loginType: "0", certType: "1",
          derFile, keyFile, password: encryptedPw,
        };
      } else {
        if (!loginId) throw new Error("카드 연동에는 로그인 ID가 필요합니다.");
        accountEntry = {
          countryCode: "KR", businessType: "CD", clientType: "B",
          organization, loginType: "1", id: loginId, password: encryptedPw,
        };
      }

      console.log(`CODEF 계정 등록 요청: ${businessType} / ${organization}`);
      const response = await fetch(CREATE_ACCOUNT_URL, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ accountList: [accountEntry] }),
      });

      result = await parseSafeJSON(response);

      // 성공 시 connectedId 저장
      if (result?.result?.code === "CF-00000" && result?.data?.connectedId) {
        const connectedId = result.data.connectedId;
        const orgName = businessType === "BK"
          ? `CONNECTED_ID_BK_${organization}`
          : `CONNECTED_ID_CD_${organization}`;

        await supabase.from("tenant_api_configs").upsert(
          { tenant_id: tenantId, config_key: orgName, config_value: connectedId, category: "finance_connected" },
          { onConflict: "tenant_id,config_key" }
        );
      }

    } else if (action === "transaction_list") {
      // ─── 신규: 은행 거래내역 조회 ───
      const { connectedId, organization, account, startDate, endDate, orderBy } = body;

      if (!connectedId) throw new Error("connectedId가 필요합니다.");

      const parameter: Record<string, any> = {
        organization,
        connectedId,
        startDate: startDate || "",
        endDate: endDate || "",
        orderBy: orderBy || "0",
      };
      if (account) parameter.account = account;

      const endpoint = "/v1/kr/bank/b/account/transaction-list";
      console.log(`거래내역 조회: ${organization} / ${account || "전체"}`);

      const response = await fetch(BASE_URL + endpoint, {
        method: "POST",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(parameter),
      });

      result = await parseSafeJSON(response);

    } else if (action === "card_transaction_list") {
      // ─── 신규: 카드 이용내역 조회 ───
      const { connectedId, organization, startDate, endDate, orderBy, cardNo } = body;

      if (!connectedId) throw new Error("connectedId가 필요합니다.");

      const parameter: Record<string, any> = {
        organization,
        connectedId,
        startDate: startDate || "",
        endDate: endDate || "",
        orderBy: orderBy || "0",
      };
      if (cardNo) parameter.cardNo = cardNo;

      const endpoint = "/v1/kr/card/b/account/transaction-list";
      console.log(`카드내역 조회: ${organization} / ${cardNo || "전체"}`);

      const response = await fetch(BASE_URL + endpoint, {
        method: "POST",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(parameter),
      });

      result = await parseSafeJSON(response);

    } else {
      return new Response(JSON.stringify({ error: "Unknown action" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(JSON.stringify(result), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error: any) {
    console.error("codef-api 오류:", error);
    return new Response(
      JSON.stringify({ error: error.message, result: { code: "ERROR", message: error.message } }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});



============================================================
File Path: supabase/functions/fetch-mail/index.ts
============================================================
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const authHeader = req.headers.get("Authorization");
    if (!authHeader?.startsWith("Bearer ")) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY")!;

    const supabase = createClient(supabaseUrl, supabaseAnonKey, {
      global: { headers: { Authorization: authHeader } },
    });

    const token = authHeader.replace("Bearer ", "");
    const { data: claimsData, error: claimsError } = await supabase.auth.getClaims(token);
    if (claimsError || !claimsData?.claims) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }
    const userId = claimsData.claims.sub;

    const body = await req.json();
    const { action, configId, provider, page, maxResults } = body;

    // Fetch user's mail config
    const { data: config, error: configError } = await supabase
      .from("user_mail_configs")
      .select("*")
      .eq("id", configId)
      .eq("user_id", userId)
      .single();

    if (configError || !config) {
      return new Response(JSON.stringify({ error: "메일 설정을 찾을 수 없습니다." }), {
        status: 404,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    if (action === "test") {
      // Test connection
      if (provider === "gmail") {
        const result = await testGmail(config);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      } else if (provider === "naverworks") {
        const result = await testNaverWorks(config);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
    }

    if (action === "list") {
      // List mails
      if (provider === "gmail") {
        const result = await listGmail(config, maxResults || 20, page);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      } else if (provider === "naverworks") {
        const result = await listNaverWorks(config, maxResults || 20, page);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
    }

    if (action === "read") {
      const { messageId } = body;
      if (provider === "gmail") {
        const result = await readGmail(config, messageId);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      } else if (provider === "naverworks") {
        const result = await readNaverWorks(config, messageId);
        return new Response(JSON.stringify(result), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
    }

    return new Response(JSON.stringify({ error: "Invalid action" }), {
      status: 400,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  } catch (e) {
    console.error("fetch-mail error:", e);
    return new Response(JSON.stringify({ error: e.message || "Internal server error" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});

// ─── Gmail helpers ───

async function getGmailAccessToken(config: any): Promise<string> {
  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const adminClient = createClient(supabaseUrl, supabaseServiceKey);

  const { data: tenantConfigs } = await adminClient
    .from("tenant_api_configs")
    .select("config_key, config_value")
    .eq("tenant_id", config.tenant_id)
    .in("config_key", ["GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET"]);

  const clientId = tenantConfigs?.find((c: any) => c.config_key === "GOOGLE_CLIENT_ID")?.config_value;
  const clientSecret = tenantConfigs?.find((c: any) => c.config_key === "GOOGLE_CLIENT_SECRET")?.config_value;

  if (!clientId || !clientSecret || !config.google_refresh_token) {
    throw new Error("Google OAuth 설정이 불완전합니다. 관리자에게 GOOGLE_CLIENT_ID/SECRET 등록을 요청하세요.");
  }

  const tokenRes = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      client_id: clientId,
      client_secret: clientSecret,
      refresh_token: config.google_refresh_token,
      grant_type: "refresh_token",
    }),
  });

  const tokenData = await tokenRes.json();
  if (!tokenData.access_token) {
    throw new Error("Gmail 토큰 갱신 실패: " + (tokenData.error_description || tokenData.error));
  }

  return tokenData.access_token;
}

async function testGmail(config: any) {
  try {
    const accessToken = await getGmailAccessToken(config);
    const res = await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=1", {
      headers: { Authorization: `Bearer ${accessToken}` },
    });
    if (!res.ok) throw new Error(`Gmail API error: ${res.status}`);
    return { success: true };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

async function listGmail(config: any, maxResults: number, pageToken?: string) {
  const accessToken = await getGmailAccessToken(config);

  let url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${maxResults}`;
  if (pageToken) url += `&pageToken=${pageToken}`;

  const listRes = await fetch(url, {
    headers: { Authorization: `Bearer ${accessToken}` },
  });
  if (!listRes.ok) throw new Error(`Gmail list error: ${listRes.status}`);
  const listData = await listRes.json();

  if (!listData.messages || listData.messages.length === 0) {
    return { mails: [], nextPageToken: null };
  }

  // Fetch metadata for each message (batch)
  const mails = await Promise.all(
    listData.messages.slice(0, maxResults).map(async (msg: any) => {
      const msgRes = await fetch(
        `https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=metadata&metadataHeaders=Subject&metadataHeaders=From&metadataHeaders=Date`,
        { headers: { Authorization: `Bearer ${accessToken}` } },
      );
      if (!msgRes.ok) return null;
      const msgData = await msgRes.json();

      const headers = msgData.payload?.headers || [];
      const getHeader = (name: string) => headers.find((h: any) => h.name === name)?.value || "";

      return {
        id: msg.id,
        subject: getHeader("Subject") || "(제목 없음)",
        sender: getHeader("From"),
        date: getHeader("Date"),
        snippet: msgData.snippet || "",
        unread: msgData.labelIds?.includes("UNREAD") || false,
      };
    }),
  );

  return {
    mails: mails.filter(Boolean),
    nextPageToken: listData.nextPageToken || null,
  };
}

async function readGmail(config: any, messageId: string) {
  const accessToken = await getGmailAccessToken(config);
  const res = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}?format=full`, {
    headers: { Authorization: `Bearer ${accessToken}` },
  });
  if (!res.ok) throw new Error(`Gmail read error: ${res.status}`);
  const data = await res.json();

  const headers = data.payload?.headers || [];
  const getHeader = (name: string) => headers.find((h: any) => h.name === name)?.value || "";

  // Extract body
  let body = "";
  const extractBody = (part: any): string => {
    if (part.mimeType === "text/plain" && part.body?.data) {
      return atob(part.body.data.replace(/-/g, "+").replace(/_/g, "/"));
    }
    if (part.mimeType === "text/html" && part.body?.data) {
      return atob(part.body.data.replace(/-/g, "+").replace(/_/g, "/"));
    }
    if (part.parts) {
      for (const sub of part.parts) {
        const result = extractBody(sub);
        if (result) return result;
      }
    }
    return "";
  };
  body = extractBody(data.payload);

  // Extract attachments info
  const attachments: any[] = [];
  const extractAttachments = (part: any) => {
    if (part.filename && part.body?.attachmentId) {
      attachments.push({
        id: part.body.attachmentId,
        filename: part.filename,
        mimeType: part.mimeType,
        size: part.body.size,
      });
    }
    if (part.parts) part.parts.forEach(extractAttachments);
  };
  extractAttachments(data.payload);

  return {
    id: data.id,
    subject: getHeader("Subject"),
    sender: getHeader("From"),
    to: getHeader("To"),
    date: getHeader("Date"),
    body,
    attachments,
  };
}

// ─── NaverWorks helpers ───

// --- JWT 서명 및 토큰 발급을 위한 유틸리티 함수 (backup-to-drive에서 복사) ---
function base64UrlEncode(str: string): string {
  return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function pemToArrayBuffer(pem: string): ArrayBuffer {
  const b64 = pem
    .replace(/-----BEGIN PRIVATE KEY-----/, "")
    .replace(/-----END PRIVATE KEY-----/, "")
    .replace(/\s/g, "");
  const binary = atob(b64);
  const buffer = new ArrayBuffer(binary.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return buffer;
}

async function signJwt(payload: any, privateKeyPem: string): Promise<string> {
  const header = { alg: "RS256", typ: "JWT" };
  const encodedHeader = base64UrlEncode(JSON.stringify(header));
  const encodedPayload = base64UrlEncode(JSON.stringify(payload));
  const signatureInput = `${encodedHeader}.${encodedPayload}`;

  const privateKey = await crypto.subtle.importKey(
    "pkcs8",
    pemToArrayBuffer(privateKeyPem),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"],
  );

  const signature = await crypto.subtle.sign("RSASSA-PKCS1-v1_5", privateKey, new TextEncoder().encode(signatureInput));

  const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));
  return `${signatureInput}.${encodedSignature}`;
}
// --- JWT 서명 및 토큰 발급을 위한 유틸리티 함수 끝 ---

async function getNaverWorksToken(config: any): Promise<string> {
  const clientId = config.nw_client_id;
  const serviceAccount = config.nw_service_account;
  const privateKey = config.nw_private_key;
  const domainId = config.nw_domain_id;

  if (!clientId || !serviceAccount || !privateKey || !domainId) {
    throw new Error(
      "네이버웍스 OAuth 설정 키가 누락되었습니다 (Client ID, Service Account, Private Key, Domain ID 확인 필요).",
    );
  }

  // 1. JWT Assertion 생성
  const now = Math.floor(Date.now() / 1000);
  const payload = {
    iss: clientId,
    sub: serviceAccount,
    aud: "https://auth.worksmobile.com/oauth2/v2.0/token",
    iat: now,
    exp: now + 3600, // 1시간 유효
    // 네이버웍스 JWT 전용 클레임 (Domain ID 사용)
    "https://auth.worksmobile.com/claims/domain_id": domainId,
  };

  const jwt = await signJwt(payload, privateKey);

  // 2. JWT를 이용해 Access Token 요청 (Grant Type: urn:ietf:params:oauth:grant-type:jwt-bearer)
  const tokenRes = await fetch("https://auth.worksmobile.com/oauth2/v2.0/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
      client_id: clientId, // Client ID도 함께 전송해야 함
      scope: "mail.read",
    }),
  });

  const tokenData = await tokenRes.json();

  if (!tokenData.access_token) {
    // 에러 발생 시 네이버웍스 서버 응답 메시지를 포함하여 에러 발생
    throw new Error(
      `네이버웍스 토큰 발급 실패: ${tokenData.error_description || tokenData.error || JSON.stringify(tokenData)}`,
    );
  }

  return tokenData.access_token;
}

async function testNaverWorks(config: any) {
  try {
    // 테스트 시에는 유저 ID 대신 Service Account를 사용해 토큰을 받아옴
    const accessToken = await getNaverWorksToken(config);

    // 토큰으로 사용자 정보 조회 (Test)
    const userId = config.nw_user_id || config.nw_service_account;
    if (!userId) throw new Error("테스트를 위한 사용자 ID(nw_user_id)가 설정되지 않았습니다.");

    const res = await fetch(
      `https://www.worksapis.com/v1.0/users/${encodeURIComponent(userId)}/mail/messages?folderId=INBOX&count=1`,
      { headers: { Authorization: `Bearer ${accessToken}` } },
    );

    if (!res.ok) throw new Error(`NaverWorks API Test Error: ${res.status}`);

    return { success: true };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

async function listNaverWorks(config: any, maxResults: number, page?: number) {
  const accessToken = await getNaverWorksToken(config);
  const userId = config.nw_user_id || config.nw_service_account;

  const offset = (page || 0) * maxResults;
  const res = await fetch(
    `https://www.worksapis.com/v1.0/users/${encodeURIComponent(userId)}/mail/messages?folderId=INBOX&count=${maxResults}&offset=${offset}`,
    { headers: { Authorization: `Bearer ${accessToken}` } },
  );

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`NaverWorks mail list error: ${res.status} - ${errText}`);
  }

  const data = await res.json();
  const mails = (data.messages || data.mails || []).map((m: any) => ({
    id: m.mailId || m.id,
    subject: m.subject || "(제목 없음)",
    sender: m.from?.name ? `${m.from.name} <${m.from.address}>` : m.from?.address || "",
    date: m.receivedDate || m.sentDate || "",
    snippet: m.body?.substring(0, 100) || "",
    unread: !m.isRead,
  }));

  return { mails, nextPage: mails.length === maxResults ? (page || 0) + 1 : null };
}

async function readNaverWorks(config: any, messageId: string) {
  const accessToken = await getNaverWorksToken(config);
  const userId = config.nw_user_id || config.nw_service_account;

  const res = await fetch(
    `https://www.worksapis.com/v1.0/users/${encodeURIComponent(userId)}/mail/messages/${messageId}`,
    { headers: { Authorization: `Bearer ${accessToken}` } },
  );

  if (!res.ok) throw new Error(`NaverWorks read error: ${res.status}`);
  const data = await res.json();

  return {
    id: data.mailId || data.id,
    subject: data.subject,
    sender: data.from?.name ? `${data.from.name} <${data.from.address}>` : data.from?.address || "",
    to: data.to?.map((t: any) => t.address).join(", ") || "",
    date: data.receivedDate || data.sentDate || "",
    body: data.body || "",
    attachments: (data.attachments || []).map((a: any) => ({
      id: a.attachmentId,
      filename: a.fileName,
      mimeType: a.contentType,
      size: a.size,
    })),
  };
}



============================================================
File Path: supabase/functions/gmail-oauth/index.ts
============================================================
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY")!;
    const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;

    const body = await req.json();
    const { action } = body;

    // ── Action 1: Generate OAuth URL ──
    if (action === "get_auth_url") {
      const authHeader = req.headers.get("Authorization");
      if (!authHeader?.startsWith("Bearer ")) {
        return jsonResponse({ error: "Unauthorized" }, 401);
      }

      const supabase = createClient(supabaseUrl, supabaseAnonKey, {
        global: { headers: { Authorization: authHeader } },
      });

      const token = authHeader.replace("Bearer ", "");
      const { data: claimsData, error: claimsError } = await supabase.auth.getClaims(token);
      if (claimsError || !claimsData?.claims) {
        return jsonResponse({ error: "Unauthorized" }, 401);
      }

      const { tenantId, redirectUri } = body;
      if (!tenantId || !redirectUri) {
        return jsonResponse({ error: "tenantId and redirectUri are required" }, 400);
      }

      // Get Google OAuth credentials from tenant_api_configs
      const adminClient = createClient(supabaseUrl, serviceRoleKey);
      const { data: tenantConfigs } = await adminClient
        .from("tenant_api_configs")
        .select("config_key, config_value")
        .eq("tenant_id", tenantId)
        .in("config_key", ["GOOGLE_CLIENT_ID"]);

      const clientId = tenantConfigs?.find((c: any) => c.config_key === "GOOGLE_CLIENT_ID")?.config_value;
      if (!clientId) {
        return jsonResponse({ error: "GOOGLE_CLIENT_ID가 설정되지 않았습니다. 관리자에게 문의하세요." }, 400);
      }

      const scopes = "https://www.googleapis.com/auth/gmail.readonly";
      const state = crypto.randomUUID();

      const authUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
      authUrl.searchParams.set("client_id", clientId);
      authUrl.searchParams.set("redirect_uri", redirectUri);
      authUrl.searchParams.set("response_type", "code");
      authUrl.searchParams.set("scope", scopes);
      authUrl.searchParams.set("access_type", "offline");
      authUrl.searchParams.set("prompt", "consent");
      authUrl.searchParams.set("state", state);

      return jsonResponse({ authUrl: authUrl.toString(), state });
    }

    // ── Action 2: Exchange code for tokens ──
    if (action === "exchange_code") {
      const authHeader = req.headers.get("Authorization");
      if (!authHeader?.startsWith("Bearer ")) {
        return jsonResponse({ error: "Unauthorized" }, 401);
      }

      const supabase = createClient(supabaseUrl, supabaseAnonKey, {
        global: { headers: { Authorization: authHeader } },
      });

      const token = authHeader.replace("Bearer ", "");
      const { data: claimsData, error: claimsError } = await supabase.auth.getClaims(token);
      if (claimsError || !claimsData?.claims) {
        return jsonResponse({ error: "Unauthorized" }, 401);
      }
      const userId = claimsData.claims.sub;

      const { code, tenantId, redirectUri } = body;
      if (!code || !tenantId || !redirectUri) {
        return jsonResponse({ error: "code, tenantId, redirectUri are required" }, 400);
      }

      // Get Google OAuth credentials
      const adminClient = createClient(supabaseUrl, serviceRoleKey);
      const { data: tenantConfigs } = await adminClient
        .from("tenant_api_configs")
        .select("config_key, config_value")
        .eq("tenant_id", tenantId)
        .in("config_key", ["GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET"]);

      const clientId = tenantConfigs?.find((c: any) => c.config_key === "GOOGLE_CLIENT_ID")?.config_value;
      const clientSecret = tenantConfigs?.find((c: any) => c.config_key === "GOOGLE_CLIENT_SECRET")?.config_value;

      if (!clientId || !clientSecret) {
        return jsonResponse({ error: "Google OAuth 설정이 불완전합니다." }, 400);
      }

      // Exchange authorization code for tokens
      const tokenRes = await fetch("https://oauth2.googleapis.com/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type: "authorization_code",
          code,
          redirect_uri: redirectUri,
          client_id: clientId,
          client_secret: clientSecret,
        }),
      });

      const tokenData = await tokenRes.json();
      if (!tokenData.refresh_token) {
        return jsonResponse({
          error: "토큰 발급 실패: " + (tokenData.error_description || tokenData.error || "refresh_token이 없습니다."),
        }, 400);
      }

      // Get user email from Google
      const userInfoRes = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
        headers: { Authorization: `Bearer ${tokenData.access_token}` },
      });
      const userInfo = await userInfoRes.json();
      const googleEmail = userInfo.email || "";

      // Upsert into user_mail_configs
      const expiresAt = new Date(Date.now() + (tokenData.expires_in || 3600) * 1000).toISOString();

      // Check existing
      const { data: existing } = await supabase
        .from("user_mail_configs")
        .select("id")
        .eq("user_id", userId)
        .eq("tenant_id", tenantId)
        .eq("provider", "gmail")
        .maybeSingle();

      if (existing) {
        await supabase.from("user_mail_configs").update({
          google_email: googleEmail,
          google_refresh_token: tokenData.refresh_token,
          google_access_token: tokenData.access_token,
          google_token_expiry: expiresAt,
          is_active: true,
        }).eq("id", existing.id);
      } else {
        await supabase.from("user_mail_configs").insert({
          user_id: userId,
          tenant_id: tenantId,
          provider: "gmail",
          google_email: googleEmail,
          google_refresh_token: tokenData.refresh_token,
          google_access_token: tokenData.access_token,
          google_token_expiry: expiresAt,
        });
      }

      return jsonResponse({ success: true, email: googleEmail });
    }

    return jsonResponse({ error: "Invalid action" }, 400);
  } catch (e) {
    console.error("gmail-oauth error:", e);
    return jsonResponse({ error: e.message || "Internal server error" }, 500);
  }
});

function jsonResponse(data: any, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { ...corsHeaders, "Content-Type": "application/json" },
  });
}



============================================================
File Path: supabase/functions/manage-system-config/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // Validate auth token
    const authHeader = req.headers.get("Authorization");
    if (!authHeader?.startsWith("Bearer ")) {
      return new Response(JSON.stringify({ error: "Authorization required" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const supabaseClient = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      { global: { headers: { Authorization: authHeader } } }
    );

    // Verify the user is a sys_super_admin
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !user) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Check super admin role via DB
    const supabaseAdmin = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
    );

    const { data: profile, error: profileError } = await supabaseAdmin
      .from("profiles")
      .select("system_role")
      .eq("id", user.id)
      .single();

    if (profileError || profile?.system_role !== "sys_super_admin") {
      return new Response(JSON.stringify({ error: "Forbidden: Super admin only" }), {
        status: 403,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const url = new URL(req.url);
    const action = url.searchParams.get("action") || (req.method === "GET" ? "list" : "update");

    if (action === "list" || req.method === "GET") {
      // Fetch configs but MASK the actual values
      const { data, error } = await supabaseAdmin
        .from("system_configs")
        .select("key, value, description, category")
        .order("category");

      if (error) throw error;

      // Mask sensitive values - only return whether a value is set, not the actual value
      const maskedData = (data || []).map((item) => ({
        key: item.key,
        // Return masked value: show first 3 chars + asterisks if value exists
        value: item.value && item.value.trim().length > 0
          ? item.value.substring(0, 3) + "••••••••••••••••"
          : "",
        is_set: item.value && item.value.trim().length > 0,
        description: item.description,
        category: item.category,
      }));

      return new Response(JSON.stringify({ data: maskedData }), {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    if (req.method === "POST") {
      const body = await req.json();
      const { key, value } = body;

      if (!key || typeof key !== "string" || key.length > 100) {
        return new Response(JSON.stringify({ error: "Invalid key" }), {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      if (typeof value !== "string" || value.length > 5000) {
        return new Response(JSON.stringify({ error: "Invalid value" }), {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      // Only allow updating existing keys, not creating new ones
      const { data: existing } = await supabaseAdmin
        .from("system_configs")
        .select("key")
        .eq("key", key)
        .single();

      if (!existing) {
        return new Response(JSON.stringify({ error: "Config key not found" }), {
          status: 404,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      const { error } = await supabaseAdmin
        .from("system_configs")
        .update({ value, updated_at: new Date().toISOString() })
        .eq("key", key);

      if (error) throw error;

      return new Response(JSON.stringify({ success: true }), {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(JSON.stringify({ error: "Method not allowed" }), {
      status: 405,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error: any) {
    console.error("manage-system-config error:", error);
    return new Response(JSON.stringify({ error: "Internal server error" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});



============================================================
File Path: supabase/functions/polish-text/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  // CORS 프리플라이트 요청 처리
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    console.log("🚀 Edge Function 'polish-text' 시작됨");

    // Authentication check
    const authHeader = req.headers.get("Authorization");
    if (!authHeader?.startsWith("Bearer ")) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const supabaseClient = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_ANON_KEY")!,
      { global: { headers: { Authorization: authHeader } } }
    );

    const token = authHeader.replace("Bearer ", "");
    const { data: claimsData, error: claimsError } = await supabaseClient.auth.getClaims(token);
    if (claimsError || !claimsData?.claims) {
      return new Response(
        JSON.stringify({ error: "Invalid token" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 1. Supabase Admin 클라이언트 생성
    const supabaseUrl = Deno.env.get("DB_URL") ?? Deno.env.get("SUPABASE_URL");
    const supabaseServiceKey = Deno.env.get("DB_ADMIN_KEY") ?? Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

    if (!supabaseUrl || !supabaseServiceKey) {
      throw new Error("관리자 비밀키(DB_ADMIN_KEY)가 설정되지 않았습니다.");
    }

    const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);

    // 2. DB에서 설정 값(토큰, 모델) 가져오기
    console.log("🔍 DB에서 시스템 설정 조회 중...");
    const { data: configs, error: configError } = await supabaseAdmin
      .from("system_configs")
      .select("key, value")
      .in("key", ["huggingface_token", "huggingface_model"]);

    if (configError) {
      console.error("❌ DB 조회 에러:", configError);
      throw new Error("시스템 설정을 DB에서 불러올 수 없습니다.");
    }

    if (!configs || configs.length === 0) {
      throw new Error("system_configs 테이블에 설정 값이 없습니다. 슈퍼 어드민 페이지를 확인하세요.");
    }

    // 배열을 객체로 변환
    const settings = configs.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);
    
    const HF_TOKEN = settings["huggingface_token"];
    const MODEL_ID = settings["huggingface_model"];

    // 토큰 값 검증
    if (!HF_TOKEN || HF_TOKEN.trim() === "") {
      throw new Error("Hugging Face 토큰이 비어있습니다. [슈퍼 어드민 > 시스템 API 설정]에서 토큰을 저장해주세요.");
    }

    // 3. 클라이언트 요청 데이터 받기
    const { text } = await req.json();
    if (!text) throw new Error("입력된 텍스트가 없습니다.");

    // Input validation
    if (typeof text !== "string" || text.length > 5000) {
      return new Response(
        JSON.stringify({ error: "텍스트는 5000자 이하여야 합니다." }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`📝 텍스트 처리 요청 (길이: ${text.length}자)`);

    // 4. Hugging Face API 호출
    console.log(`🤖 AI 모델 호출 중 (${MODEL_ID})...`);
    
    const response = await fetch(
      `https://router.huggingface.co/v1/chat/completions`, 
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${HF_TOKEN}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: MODEL_ID,
          messages: [
            { role: "system", content: "당신은 전문적인 에디터입니다. 입력된 문장을 정중하고 세련된 비즈니스 문체로 다듬어주세요. 설명 없이 결과 문장만 출력하세요." },
            { role: "user", content: `다음 문장을 다듬어줘:\n\n${text}` }
          ],
          max_tokens: 500,
          temperature: 0.2,
        }),
      }
    );

    const result = await response.json();

    // AI 응답 에러 체크
    if (result.error) {
      console.error("❌ Hugging Face API 에러:", result.error);
      
      // 모델 로딩 중 에러(자주 발생함)에 대한 친절한 메시지 처리
      if (typeof result.error === 'string' && result.error.includes("loading")) {
        throw new Error("AI 모델을 서버에 로딩 중입니다. 약 30초 뒤에 다시 시도해주세요. (Estimated time error)");
      }
      
      throw new Error("AI 호출 중 오류가 발생했습니다.");
    }

    console.log("✅ 변환 성공!");

    return new Response(JSON.stringify({ result: result.choices[0].message.content }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error: any) {
    console.error("🔥 Edge Function 내부 오류 발생:", error);

    return new Response(JSON.stringify({ error: error.message || "알 수 없는 서버 오류" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});



============================================================
File Path: supabase/functions/read-drive-csv/index.ts
============================================================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Verify auth
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), {
        status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, serviceRoleKey);

    const token = authHeader.replace("Bearer ", "");
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);
    if (authError || !user) {
      return new Response(JSON.stringify({ error: "Invalid token" }), {
        status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const { tenantId, folderKey, dateRange } = await req.json();

    if (!tenantId || !folderKey) {
      return new Response(JSON.stringify({ error: "Missing tenantId or folderKey" }), {
        status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Verify membership
    const { data: membership } = await supabase
      .from("tenant_memberships")
      .select("id")
      .eq("tenant_id", tenantId)
      .eq("user_id", user.id)
      .single();

    if (!membership) {
      return new Response(JSON.stringify({ error: "Not a member" }), {
        status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Get folder mapping
    const { data: mapping } = await supabase
      .from("drive_folder_mappings")
      .select("folder_id")
      .eq("tenant_id", tenantId)
      .eq("folder_key", folderKey)
      .eq("is_active", true)
      .single();

    if (!mapping) {
      return new Response(JSON.stringify({ error: "Folder mapping not found", files: [] }), {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Get tenant Google credentials
    const { data: tenant } = await supabase
      .from("tenants")
      .select("google_credentials, drive_connected_by")
      .eq("id", tenantId)
      .single();

    if (!tenant?.google_credentials) {
      return new Response(JSON.stringify({ error: "Google Drive not configured" }), {
        status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    let driveOwnerEmail: string | null = null;
    if (tenant.drive_connected_by) {
      const { data: ownerProfile } = await supabase
        .from("profiles")
        .select("email")
        .eq("id", tenant.drive_connected_by)
        .single();
      driveOwnerEmail = ownerProfile?.email || null;
    }

    const credentials = JSON.parse(atob(tenant.google_credentials));
    const accessToken = await getGoogleAccessToken(credentials, driveOwnerEmail);

    // List CSV files in folder
    let query = `'${mapping.folder_id}' in parents and mimeType='text/csv' and trashed=false`;

    // Optional date filtering by filename pattern
    if (dateRange?.startDate) {
      // Files are named like bank_0004_08660104141706_20260216.csv
      // We'll fetch all and filter client-side for simplicity
    }

    const listResponse = await fetch(
      `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&orderBy=name desc&pageSize=100&fields=files(id,name,modifiedTime,size)`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );

    const listResult = await listResponse.json();
    const files = listResult.files || [];

    // Filter by date range if specified
    let filteredFiles = files;
    if (dateRange?.startDate && dateRange?.endDate) {
      filteredFiles = files.filter((f: any) => {
        const match = f.name.match(/_(\d{8})\.csv$/);
        if (!match) return true;
        const fileDate = match[1];
        return fileDate >= dateRange.startDate.replace(/-/g, "") && fileDate <= dateRange.endDate.replace(/-/g, "");
      });
    }

    // Read and parse CSV files (limit to 30 most recent)
    const recentFiles = filteredFiles.slice(0, 30);
    const allRows: any[] = [];

    for (const file of recentFiles) {
      try {
        const contentResponse = await fetch(
          `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const csvText = await contentResponse.text();
        const rows = parseCsv(csvText, file.name);
        allRows.push(...rows);
      } catch (e: any) {
        console.error(`Error reading file ${file.name}:`, e.message);
      }
    }

    return new Response(JSON.stringify({
      success: true,
      files: recentFiles.map((f: any) => ({ name: f.name, modifiedTime: f.modifiedTime })),
      data: allRows,
      totalFiles: filteredFiles.length,
    }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error: any) {
    console.error("Read drive CSV error:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});

function parseCsv(csvText: string, fileName: string): any[] {
  // Remove BOM
  const text = csvText.replace(/^\uFEFF/, "");
  const lines = text.split("\n").filter(l => l.trim());
  if (lines.length < 2) return [];

  const headers = lines[0].split(",");
  const rows: any[] = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseCsvLine(lines[i]);
    const row: Record<string, string> = { _fileName: fileName };
    headers.forEach((h, idx) => {
      row[h.trim()] = (values[idx] || "").trim();
    });
    rows.push(row);
  }

  return rows;
}

function parseCsvLine(line: string): string[] {
  const result: string[] = [];
  let current = "";
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

// ─── Google Auth (same as other functions) ───

async function getGoogleAccessToken(credentials: any, impersonateEmail: string | null): Promise<string> {
  const now = Math.floor(Date.now() / 1000);
  const payload: Record<string, unknown> = {
    iss: credentials.client_email,
    scope: "https://www.googleapis.com/auth/drive.readonly",
    aud: "https://oauth2.googleapis.com/token",
    iat: now,
    exp: now + 3600,
  };
  if (impersonateEmail) payload.sub = impersonateEmail;

  const header = { alg: "RS256", typ: "JWT" };
  const encodedHeader = base64UrlEncode(JSON.stringify(header));
  const encodedPayload = base64UrlEncode(JSON.stringify(payload));
  const signatureInput = `${encodedHeader}.${encodedPayload}`;

  const privateKey = await crypto.subtle.importKey(
    "pkcs8",
    pemToArrayBuffer(credentials.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const signature = await crypto.subtle.sign("RSASSA-PKCS1-v1_5", privateKey, new TextEncoder().encode(signatureInput));
  const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));
  const jwt = `${signatureInput}.${encodedSignature}`;

  const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer", assertion: jwt }),
  });

  const tokenData = await tokenResponse.json();
  if (!tokenData.access_token) throw new Error("Google access token 발급 실패");
  return tokenData.access_token;
}

function base64UrlEncode(str: string): string {
  return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function pemToArrayBuffer(pem: string): ArrayBuffer {
  const b64 = pem.replace(/-----BEGIN PRIVATE KEY-----/, "").replace(/-----END PRIVATE KEY-----/, "").replace(/\s/g, "");
  const binary = atob(b64);
  const buffer = new ArrayBuffer(binary.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) view[i] = binary.charCodeAt(i);
  return buffer;
}



============================================================
File Path: supabase/functions/send-invitation-email/index.ts
============================================================
import { serve } from "https://deno.land/std@0.190.0/http/server.ts";
import { Resend } from "https://esm.sh/resend@2.0.0";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// CORS 헤더 설정
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

interface InvitationEmailRequest {
  email: string;
  companyName: string;
  role: string;
  department?: string;
  jobTitle?: string;
  inviterName?: string;
  signupUrl: string;
  tenantId: string;
}

const getRoleLabel = (role: string): string => {
  switch (role) {
    case "company_admin":
      return "관리자";
    case "manager":
      return "매니저";
    default:
      return "사원";
  }
};

const handler = async (req: Request): Promise<Response> => {
  // 1. CORS 프리플라이트(사전 검사) 요청 처리
  if (req.method === "OPTIONS") {
    return new Response("ok", { 
      status: 200, 
      headers: corsHeaders 
    });
  }

  try {
    // Authentication check - verify the caller is authenticated
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Initialize Supabase client with user's token
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseAnonKey, {
      global: { headers: { Authorization: authHeader } }
    });

    // Verify the user's token
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: "Invalid token" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Resend API 키 확인
    const resendKey = Deno.env.get("RESEND_API_KEY");
    if (!resendKey) {
      throw new Error("RESEND_API_KEY가 설정되지 않았습니다.");
    }
    const resend = new Resend(resendKey);

    // 요청 데이터 파싱
    const {
      email,
      companyName,
      role,
      department,
      jobTitle,
      inviterName,
      signupUrl,
      tenantId,
    }: InvitationEmailRequest = await req.json();

    // Input validation
    if (!email || !companyName || !role || !signupUrl || !tenantId) {
      return new Response(
        JSON.stringify({ error: "Missing required fields: email, companyName, role, signupUrl, tenantId" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Email format validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return new Response(
        JSON.stringify({ error: "Invalid email format" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Verify the user is a company_admin for the tenant
    const { data: membership, error: membershipError } = await supabase
      .from("tenant_memberships")
      .select("role")
      .eq("tenant_id", tenantId)
      .eq("user_id", user.id)
      .single();

    if (membershipError || !membership) {
      return new Response(
        JSON.stringify({ error: "Not authorized to send invitations for this tenant" }),
        { status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (membership.role !== "company_admin") {
      // Check if user is super admin
      const { data: profile } = await supabase
        .from("profiles")
        .select("system_role")
        .eq("id", user.id)
        .single();

      if (!profile || profile.system_role !== "sys_super_admin") {
        return new Response(
          JSON.stringify({ error: "Only company admins can send invitation emails" }),
          { status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
    }

    console.log(`Sending invitation email to: ${email} for company: ${companyName}`);

    const roleLabel = getRoleLabel(role);
    const positionInfo = [department, jobTitle].filter(Boolean).join(" · ");

    // 이메일 발송
    const { data, error: sendError } = await resend.emails.send({
      from: "Boteda OS <onboarding@resend.dev>",
      to: [email],
      subject: `[Boteda OS] ${companyName}에서 초대합니다`,
      html: `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f5;">
          <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border-radius: 16px 16px 0 0; padding: 40px 32px; text-align: center;">
              <div style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: white; font-weight: bold; font-size: 24px;">B</span>
                </div>
              </div>
              <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">Boteda OS</h1>
              <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 14px;">엔터테인먼트 기업 통합 관리 솔루션</p>
            </div>
            
            <div style="background: white; border-radius: 0 0 16px 16px; padding: 40px 32px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
              <h2 style="color: #18181b; margin: 0 0 24px 0; font-size: 22px; font-weight: 600;">
                🎉 ${companyName}에서 초대했습니다
              </h2>
              
              <p style="color: #52525b; margin: 0 0 24px 0; font-size: 16px; line-height: 1.6;">
                ${inviterName ? `${inviterName}님이` : '회사 관리자가'} 귀하를 <strong>${companyName}</strong>의 ${roleLabel}로 초대했습니다.
              </p>
              
              ${positionInfo ? `
              <div style="background: #f4f4f5; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px;">
                <p style="color: #71717a; margin: 0 0 4px 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">배정된 직책</p>
                <p style="color: #18181b; margin: 0; font-size: 16px; font-weight: 600;">${positionInfo}</p>
              </div>
              ` : ''}
              
              <p style="color: #52525b; margin: 0 0 32px 0; font-size: 15px; line-height: 1.6;">
                아래 버튼을 클릭하여 회원가입을 완료하시면, 바로 ${companyName} 시스템에 접속하실 수 있습니다.
              </p>
              
              <div style="text-align: center; margin-bottom: 32px;">
                <a href="${signupUrl}" style="display: inline-block; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; text-decoration: none; padding: 16px 48px; border-radius: 12px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);">
                  회원가입 하기
                </a>
              </div>
              
              <div style="border-top: 1px solid #e4e4e7; padding-top: 24px;">
                <p style="color: #a1a1aa; margin: 0; font-size: 13px; line-height: 1.5;">
                  이 초대는 7일 후 만료됩니다.<br>
                  본인이 요청하지 않은 초대라면 이 이메일을 무시하셔도 됩니다.
                </p>
              </div>
            </div>
            
            <p style="text-align: center; color: #a1a1aa; margin: 24px 0 0 0; font-size: 12px;">
              © 2025 Boteda OS. All rights reserved.
            </p>
          </div>
        </body>
        </html>
      `,
    });

    if (sendError) throw sendError;

    console.log("Email sent successfully:", data);

    return new Response(JSON.stringify(data), {
      status: 200,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  } catch (error: any) {
    console.error("Error in send-invitation-email function:", error);
    return new Response(
      JSON.stringify({ error: error.message }),
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
};

serve(handler);


============================================================
File Path: supabase/functions/send-to-telegram/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

interface TelegramRequest {
  tenantId: string;
  fileName: string;
  fileContent: string; // base64 encoded
  mimeType: string;
  caption?: string;
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Verify user
    const token = authHeader.replace("Bearer ", "");
    const { data: claimsData, error: claimsError } = await supabase.auth.getClaims(token);
    if (claimsError || !claimsData?.claims) {
      return new Response(
        JSON.stringify({ error: "Unauthorized" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }
    const userId = claimsData.claims.sub as string;

    const { tenantId, fileName, fileContent, mimeType, caption }: TelegramRequest = await req.json();

    if (!tenantId || !fileName || !fileContent) {
      return new Response(
        JSON.stringify({ error: "Missing required fields" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Check membership
    const { data: membership } = await supabase
      .from("tenant_memberships")
      .select("id")
      .eq("tenant_id", tenantId)
      .eq("user_id", userId)
      .single();

    if (!membership) {
      return new Response(
        JSON.stringify({ error: "Not a member of this tenant" }),
        { status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Get Telegram bot config from tenant_api_configs
    const { data: configs } = await supabase
      .from("tenant_api_configs")
      .select("config_key, config_value")
      .eq("tenant_id", tenantId)
      .in("config_key", ["TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"]);

    const configMap = new Map((configs || []).map((c: any) => [c.config_key, c.config_value]));
    const botToken = configMap.get("TELEGRAM_BOT_TOKEN");
    const chatId = configMap.get("TELEGRAM_CHAT_ID");

    if (!botToken || !chatId) {
      return new Response(
        JSON.stringify({ success: false, error: "Telegram bot not configured for this tenant" }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Decode base64 to binary
    const binaryString = atob(fileContent);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }

    // Get tenant name for caption
    const { data: tenant } = await supabase
      .from("tenants")
      .select("name")
      .eq("id", tenantId)
      .single();

    const { data: profile } = await supabase
      .from("profiles")
      .select("full_name, email")
      .eq("id", userId)
      .single();

    const fullCaption = caption || 
      `📎 ${fileName}\n🏢 ${tenant?.name || "Unknown"}\n👤 ${profile?.full_name || profile?.email || "Unknown"}\n📅 ${new Date().toISOString().split("T")[0]}`;

    // Send document to Telegram
    const blob = new Blob([bytes], { type: mimeType || "application/octet-stream" });
    const formData = new FormData();
    formData.append("chat_id", chatId);
    formData.append("document", blob, fileName);
    formData.append("caption", fullCaption);

    const telegramResponse = await fetch(
      `https://api.telegram.org/bot${botToken}/sendDocument`,
      { method: "POST", body: formData }
    );

    const telegramResult = await telegramResponse.json();

    if (!telegramResult.ok) {
      console.error("Telegram API error:", telegramResult);
      return new Response(
        JSON.stringify({ success: false, error: `Telegram error: ${telegramResult.description}` }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    return new Response(
      JSON.stringify({ success: true, messageId: telegramResult.result?.message_id }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("Telegram send error:", err);
    return new Response(
      JSON.stringify({ error: err instanceof Error ? err.message : "Unknown error" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});



============================================================
File Path: supabase/functions/sync-finance-to-drive/index.ts
============================================================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import forge from "npm:node-forge@1.3.1";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

const TOKEN_URL = "https://oauth.codef.io/oauth/token";
const BASE_URL = "https://development.codef.io";

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, serviceRoleKey);

  const results: any[] = [];

  try {
    // 1. Get all tenants with Drive configured and finance accounts
    const { data: tenants } = await supabase
      .from("tenants")
      .select("id, name, google_credentials, drive_folder_id, drive_connected_by");

    if (!tenants || tenants.length === 0) {
      return new Response(JSON.stringify({ message: "No tenants found" }), {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    for (const tenant of tenants) {
      if (!tenant.google_credentials || !tenant.drive_folder_id) continue;

      try {
        // 2. Check if tenant has bank_transactions folder mapping
        const { data: mappings } = await supabase
          .from("drive_folder_mappings")
          .select("*")
          .eq("tenant_id", tenant.id)
          .eq("is_active", true)
          .in("folder_key", ["bank_transactions", "card_transactions"]);

        if (!mappings || mappings.length === 0) continue;

        // 3. Get CODEF configs
        const { data: configs } = await supabase
          .from("tenant_api_configs")
          .select("config_key, config_value")
          .eq("tenant_id", tenant.id)
          .in("config_key", ["CODEF_CLIENT_ID", "CODEF_CLIENT_SECRET"]);

        const configMap: Record<string, string> = {};
        (configs || []).forEach((c: any) => { configMap[c.config_key] = c.config_value; });

        if (!configMap["CODEF_CLIENT_ID"] || !configMap["CODEF_CLIENT_SECRET"]) continue;

        const token = await getCodefToken(configMap["CODEF_CLIENT_ID"], configMap["CODEF_CLIENT_SECRET"]);

        // 4. Get finance accounts
        const { data: accounts } = await supabase
          .from("finance_accounts")
          .select("*")
          .eq("tenant_id", tenant.id)
          .eq("is_active", true);

        if (!accounts || accounts.length === 0) continue;

        // Get connected ID map
        const { data: connConfigs } = await supabase
          .from("tenant_api_configs")
          .select("config_key, config_value")
          .eq("tenant_id", tenant.id)
          .eq("category", "finance_connected");

        const connMap: Record<string, string> = {};
        (connConfigs || []).forEach((c: any) => { connMap[c.config_key] = c.config_value; });

        // Get Drive access token
        const credentialsJson = atob(tenant.google_credentials);
        const credentials = JSON.parse(credentialsJson);

        let driveOwnerEmail: string | null = null;
        if (tenant.drive_connected_by) {
          const { data: ownerProfile } = await supabase
            .from("profiles")
            .select("email")
            .eq("id", tenant.drive_connected_by)
            .single();
          driveOwnerEmail = ownerProfile?.email || null;
        }

        const driveToken = await getGoogleAccessToken(credentials, driveOwnerEmail);

        // Yesterday's date
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateStr = formatDate(yesterday);

        // 5. Process bank accounts
        const bankMapping = mappings.find(m => m.folder_key === "bank_transactions");
        const cardMapping = mappings.find(m => m.folder_key === "card_transactions");

        const bankAccounts = accounts.filter(a => a.business_type === "BK");
        const cardAccounts = accounts.filter(a => a.business_type === "CD");

        // Bank transactions
        if (bankMapping && bankAccounts.length > 0) {
          for (const acc of bankAccounts) {
            const connectedId = connMap[acc.connected_id_key];
            if (!connectedId) continue;

            try {
              const txData = await fetchCodefTransactions(token, {
                organization: acc.organization,
                connectedId,
                account: acc.account_number || "",
                startDate: dateStr,
                endDate: dateStr,
                orderBy: "0",
              }, "/v1/kr/bank/b/account/transaction-list");

              if (txData && txData.resTrHistoryList) {
                const csv = bankTransactionsToCsv(txData, acc);
                const fileName = `bank_${acc.organization}_${acc.account_number || "all"}_${dateStr}.csv`;
                await uploadCsvToDrive(driveToken, bankMapping.folder_id, fileName, csv);
                results.push({ tenant: tenant.name, type: "bank", account: acc.account_number, records: txData.resTrHistoryList.length });
              }
            } catch (e: any) {
              console.error(`Bank sync error for ${acc.account_number}:`, e.message);
              results.push({ tenant: tenant.name, type: "bank", account: acc.account_number, error: e.message });
            }
          }
        }

        // Card transactions
        if (cardMapping && cardAccounts.length > 0) {
          for (const acc of cardAccounts) {
            const connectedId = connMap[acc.connected_id_key];
            if (!connectedId) continue;

            try {
              const txData = await fetchCodefTransactions(token, {
                organization: acc.organization,
                connectedId,
                cardNo: acc.account_number || "",
                startDate: dateStr,
                endDate: dateStr,
                orderBy: "0",
              }, "/v1/kr/card/b/account/transaction-list");

              if (txData) {
                const list = txData.resTrHistoryList || txData.resCardHistoryList || [];
                if (list.length > 0) {
                  const csv = cardTransactionsToCsv(list, acc);
                  const fileName = `card_${acc.organization}_${acc.account_number || "all"}_${dateStr}.csv`;
                  await uploadCsvToDrive(driveToken, cardMapping.folder_id, fileName, csv);
                  results.push({ tenant: tenant.name, type: "card", account: acc.account_number, records: list.length });
                }
              }
            } catch (e: any) {
              console.error(`Card sync error for ${acc.account_number}:`, e.message);
              results.push({ tenant: tenant.name, type: "card", account: acc.account_number, error: e.message });
            }
          }
        }

      } catch (tenantError: any) {
        console.error(`Tenant ${tenant.name} sync error:`, tenantError.message);
        results.push({ tenant: tenant.name, error: tenantError.message });
      }
    }

    return new Response(JSON.stringify({ success: true, results }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error: any) {
    console.error("Sync error:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});

// ─── Helper Functions ───

function formatDate(d: Date): string {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}${m}${day}`;
}

async function getCodefToken(clientId: string, clientSecret: string): Promise<string> {
  const response = await fetch(TOKEN_URL, {
    method: "POST",
    headers: {
      Authorization: `Basic ${btoa(`${clientId}:${clientSecret}`)}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "grant_type=client_credentials&scope=read",
  });
  const data = await response.json();
  if (!data.access_token) throw new Error("CODEF 토큰 발급 실패");
  return data.access_token;
}

async function fetchCodefTransactions(
  token: string,
  params: Record<string, any>,
  endpoint: string
): Promise<any> {
  const response = await fetch(BASE_URL + endpoint, {
    method: "POST",
    headers: {
      Accept: "application/json",
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(params),
  });

  const raw = await response.text();
  let decoded = raw;
  try { decoded = decodeURIComponent(raw); } catch (_) {}
  const parsed = JSON.parse(decoded);

  if (parsed?.result?.code !== "CF-00000") {
    throw new Error(`CODEF 조회 실패: ${parsed?.result?.message || "unknown"}`);
  }

  return parsed.data;
}

function bankTransactionsToCsv(data: any, account: any): string {
  const header = "거래일,거래시간,입금,출금,거래후잔액,적요1,적요2,적요3,적요4,계좌번호,계좌명,예금주";
  const rows = (data.resTrHistoryList || []).map((t: any) =>
    [
      t.resAccountTrDate || "",
      t.resAccountTrTime || "",
      t.resAccountIn || "0",
      t.resAccountOut || "0",
      t.resAfterTranBalance || "0",
      csvEscape(t.resAccountDesc1 || ""),
      csvEscape(t.resAccountDesc2 || ""),
      csvEscape(t.resAccountDesc3 || ""),
      csvEscape(t.resAccountDesc4 || ""),
      data.resAccount || account.account_number || "",
      csvEscape(data.resAccountName || ""),
      csvEscape(data.resAccountHolder || ""),
    ].join(",")
  );
  return "\uFEFF" + header + "\n" + rows.join("\n");
}

function cardTransactionsToCsv(list: any[], account: any): string {
  const header = "거래일,거래시간,가맹점,금액,통화,카드번호,승인번호,할부,상태";
  const rows = list.map((t: any) =>
    [
      t.resUsedDate || t.resTranDate || "",
      t.resUsedTime || t.resTranTime || "",
      csvEscape(t.resStoreName || t.resMerchantName || ""),
      t.resUsedAmount || t.resTranAmount || "0",
      t.resCurrency || "KRW",
      t.resCardNo || account.account_number || "",
      t.resApprovalNo || "",
      t.resInstallmentCount || "일시불",
      t.resStatus || "",
    ].join(",")
  );
  return "\uFEFF" + header + "\n" + rows.join("\n");
}

function csvEscape(val: string): string {
  if (val.includes(",") || val.includes('"') || val.includes("\n")) {
    return `"${val.replace(/"/g, '""')}"`;
  }
  return val;
}

async function getGoogleAccessToken(credentials: any, impersonateEmail: string | null): Promise<string> {
  const now = Math.floor(Date.now() / 1000);
  const payload: Record<string, unknown> = {
    iss: credentials.client_email,
    scope: "https://www.googleapis.com/auth/drive",
    aud: "https://oauth2.googleapis.com/token",
    iat: now,
    exp: now + 3600,
  };
  if (impersonateEmail) payload.sub = impersonateEmail;

  const header = { alg: "RS256", typ: "JWT" };
  const encodedHeader = base64UrlEncode(JSON.stringify(header));
  const encodedPayload = base64UrlEncode(JSON.stringify(payload));
  const signatureInput = `${encodedHeader}.${encodedPayload}`;

  const privateKey = await crypto.subtle.importKey(
    "pkcs8",
    pemToArrayBuffer(credentials.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const signature = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    privateKey,
    new TextEncoder().encode(signatureInput)
  );

  const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));
  const jwt = `${signatureInput}.${encodedSignature}`;

  const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
    }),
  });

  const tokenData = await tokenResponse.json();
  if (!tokenData.access_token) throw new Error("Google Drive 토큰 발급 실패");
  return tokenData.access_token;
}

async function uploadCsvToDrive(accessToken: string, folderId: string, fileName: string, csvContent: string) {
  // Check if file already exists and update, or create new
  const searchResponse = await fetch(
    `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(fileName)}' and '${folderId}' in parents and trashed=false`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const searchResult = await searchResponse.json();

  const csvBytes = new TextEncoder().encode(csvContent);

  if (searchResult.files && searchResult.files.length > 0) {
    // Update existing file
    const fileId = searchResult.files[0].id;
    const response = await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
      {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "text/csv",
        },
        body: csvBytes,
      }
    );
    if (!response.ok) throw new Error(`Drive 업데이트 실패: ${await response.text()}`);
  } else {
    // Create new file
    const boundary = "---Boundary" + Date.now();
    const metadata = JSON.stringify({ name: fileName, parents: [folderId], mimeType: "text/csv" });
    const encoder = new TextEncoder();

    const metaPart = encoder.encode(`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${metadata}\r\n`);
    const filePreamble = encoder.encode(`--${boundary}\r\nContent-Type: text/csv\r\n\r\n`);
    const closing = encoder.encode(`\r\n--${boundary}--`);

    const body = new Uint8Array(metaPart.length + filePreamble.length + csvBytes.length + closing.length);
    let offset = 0;
    body.set(metaPart, offset); offset += metaPart.length;
    body.set(filePreamble, offset); offset += filePreamble.length;
    body.set(csvBytes, offset); offset += csvBytes.length;
    body.set(closing, offset);

    const response = await fetch(
      "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": `multipart/related; boundary=${boundary}`,
        },
        body,
      }
    );
    if (!response.ok) throw new Error(`Drive 업로드 실패: ${await response.text()}`);
  }
}

function base64UrlEncode(str: string): string {
  return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function pemToArrayBuffer(pem: string): ArrayBuffer {
  const b64 = pem.replace(/-----BEGIN PRIVATE KEY-----/, "").replace(/-----END PRIVATE KEY-----/, "").replace(/\s/g, "");
  const binary = atob(b64);
  const buffer = new ArrayBuffer(binary.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) view[i] = binary.charCodeAt(i);
  return buffer;
}



============================================================
File Path: supabase/functions/upload-to-drive/index.ts
============================================================
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

interface UploadRequest {
  tenantId: string;
  fileName: string;
  fileContent: string; // base64 encoded
  mimeType: string;
  subfolder?: string;
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Verify authorization
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: "Authorization required" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Initialize Supabase client
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Verify user token
    const token = authHeader.replace("Bearer ", "");
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);
    
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: "Invalid token" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Parse request body
    const { tenantId, fileName, fileContent, mimeType, subfolder }: UploadRequest = await req.json();

    if (!tenantId || !fileName || !fileContent || !mimeType) {
      return new Response(
        JSON.stringify({ error: "Missing required fields: tenantId, fileName, fileContent, mimeType" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Input validation: file size limit (10MB)
    const MAX_FILE_SIZE = 10 * 1024 * 1024;
    const decodedSize = Math.ceil(fileContent.length * 0.75);
    if (decodedSize > MAX_FILE_SIZE) {
      return new Response(
        JSON.stringify({ error: `파일 크기가 너무 큽니다. 최대 10MB까지 허용됩니다.` }),
        { status: 413, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // MIME type whitelist
    const ALLOWED_MIME_TYPES = [
      "application/pdf",
      "image/jpeg", "image/png", "image/gif", "image/webp",
      "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      "application/vnd.openxmlformats-officedocument.presentationml.presentation",
      "application/msword", "application/vnd.ms-excel", "application/vnd.ms-powerpoint",
      "text/plain", "text/csv",
      "application/json",
      "video/mp4", "video/quicktime",
      "audio/mpeg", "audio/wav",
    ];
    if (!ALLOWED_MIME_TYPES.includes(mimeType)) {
      return new Response(
        JSON.stringify({ error: `허용되지 않는 파일 형식입니다: ${mimeType}` }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Filename sanitization
    const sanitizedFileName = fileName
      .replace(/\.\.\//g, "")
      .replace(/[^a-zA-Z0-9가-힣._\-\s]/g, "_")
      .substring(0, 255);

    // Subfolder sanitization
    const sanitizedSubfolder = subfolder
      ? subfolder.replace(/\.\.\//g, "").replace(/[^a-zA-Z0-9가-힣._\-\s/]/g, "_").substring(0, 100)
      : undefined;

    // Check user is member of tenant
    const { data: membership, error: membershipError } = await supabase
      .from("tenant_memberships")
      .select("id")
      .eq("tenant_id", tenantId)
      .eq("user_id", user.id)
      .single();

    if (membershipError || !membership) {
      return new Response(
        JSON.stringify({ error: "Not a member of this tenant" }),
        { status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Get tenant's Google credentials and drive owner email
    const { data: tenant, error: tenantError } = await supabase
      .from("tenants")
      .select("google_credentials, drive_folder_id, name, drive_connected_by")
      .eq("id", tenantId)
      .single();

    if (tenantError || !tenant) {
      return new Response(
        JSON.stringify({ error: "Tenant not found" }),
        { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (!tenant.google_credentials || !tenant.drive_folder_id) {
      return new Response(
        JSON.stringify({ error: "Google Drive not configured for this tenant" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Get drive owner email for impersonation
    let driveOwnerEmail: string | null = null;
    if (tenant.drive_connected_by) {
      const { data: ownerProfile } = await supabase
        .from("profiles")
        .select("email")
        .eq("id", tenant.drive_connected_by)
        .single();
      driveOwnerEmail = ownerProfile?.email || null;
    }

    // Decode credentials (base64 -> JSON)
    const credentialsJson = atob(tenant.google_credentials);
    const credentials = JSON.parse(credentialsJson);

    // Get Google access token using service account with impersonation
    const accessToken = await getGoogleAccessToken(credentials, driveOwnerEmail);

    // Determine target folder (create subfolder if needed)
    let targetFolderId = tenant.drive_folder_id;
    if (sanitizedSubfolder) {
      targetFolderId = await getOrCreateSubfolder(accessToken, tenant.drive_folder_id, sanitizedSubfolder);
    }

    // Upload file to Google Drive
    const driveResult = await uploadToGoogleDrive(
      accessToken,
      targetFolderId,
      sanitizedFileName,
      fileContent,
      mimeType
    );

    return new Response(
      JSON.stringify({
        success: true,
        fileId: driveResult.id,
        fileName: driveResult.name,
        webViewLink: driveResult.webViewLink,
        webContentLink: driveResult.webContentLink,
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    console.error("Upload error:", err);
    const errorMessage = err instanceof Error ? err.message : "Upload failed";
    return new Response(
      JSON.stringify({ error: errorMessage }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

// Get Google OAuth2 access token using service account with impersonation
async function getGoogleAccessToken(credentials: {
  client_email: string;
  private_key: string;
}, impersonateEmail: string | null): Promise<string> {
  const now = Math.floor(Date.now() / 1000);
  const payload: Record<string, unknown> = {
    iss: credentials.client_email,
    scope: "https://www.googleapis.com/auth/drive",
    aud: "https://oauth2.googleapis.com/token",
    iat: now,
    exp: now + 3600,
  };

  // Add impersonation subject if available
  if (impersonateEmail) {
    payload.sub = impersonateEmail;
  }

  // Create JWT
  const header = { alg: "RS256", typ: "JWT" };
  const encodedHeader = base64UrlEncode(JSON.stringify(header));
  const encodedPayload = base64UrlEncode(JSON.stringify(payload));
  const signatureInput = `${encodedHeader}.${encodedPayload}`;

  // Sign with private key
  const privateKey = await crypto.subtle.importKey(
    "pkcs8",
    pemToArrayBuffer(credentials.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const signature = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    privateKey,
    new TextEncoder().encode(signatureInput)
  );

  const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));
  const jwt = `${signatureInput}.${encodedSignature}`;

  // Exchange JWT for access token
  const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
    }),
  });

  const tokenData = await tokenResponse.json();
  if (!tokenData.access_token) {
    throw new Error("Failed to get Google access token");
  }

  return tokenData.access_token;
}

// Upload file to Google Drive
async function uploadToGoogleDrive(
  accessToken: string,
  folderId: string,
  fileName: string,
  fileContent: string,
  mimeType: string
): Promise<{ id: string; name: string; webViewLink: string; webContentLink: string }> {
  // Decode base64 content to binary
  const binaryString = atob(fileContent);
  const binaryContent = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    binaryContent[i] = binaryString.charCodeAt(i);
  }

  const boundary = "---MultipartBoundary" + Date.now();
  const metadata = JSON.stringify({
    name: fileName,
    parents: [folderId],
  });

  // Build multipart body properly: metadata part (text) + file part (binary)
  const encoder = new TextEncoder();
  const metadataPart = encoder.encode(
    `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${metadata}\r\n`
  );
  const filePreamble = encoder.encode(
    `--${boundary}\r\nContent-Type: ${mimeType}\r\n\r\n`
  );
  const closing = encoder.encode(`\r\n--${boundary}--`);

  // Concatenate all parts into a single Uint8Array
  const body = new Uint8Array(metadataPart.length + filePreamble.length + binaryContent.length + closing.length);
  let offset = 0;
  body.set(metadataPart, offset); offset += metadataPart.length;
  body.set(filePreamble, offset); offset += filePreamble.length;
  body.set(binaryContent, offset); offset += binaryContent.length;
  body.set(closing, offset);

  const response = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink",
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": `multipart/related; boundary=${boundary}`,
      },
      body: body,
    }
  );

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Google Drive upload failed: ${error}`);
  }

  return response.json();
}

// Get or create subfolder
async function getOrCreateSubfolder(
  accessToken: string,
  parentId: string,
  folderName: string
): Promise<string> {
  // Search for existing folder
  const searchResponse = await fetch(
    `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(folderName)}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    {
      headers: { Authorization: `Bearer ${accessToken}` },
    }
  );

  const searchResult = await searchResponse.json();
  if (searchResult.files && searchResult.files.length > 0) {
    return searchResult.files[0].id;
  }

  // Create new folder
  const createResponse = await fetch("https://www.googleapis.com/drive/v3/files", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      name: folderName,
      mimeType: "application/vnd.google-apps.folder",
      parents: [parentId],
    }),
  });

  const folder = await createResponse.json();
  return folder.id;
}

// Helper functions
function base64UrlEncode(str: string): string {
  return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function pemToArrayBuffer(pem: string): ArrayBuffer {
  const b64 = pem
    .replace(/-----BEGIN PRIVATE KEY-----/, "")
    .replace(/-----END PRIVATE KEY-----/, "")
    .replace(/\s/g, "");
  const binary = atob(b64);
  const buffer = new ArrayBuffer(binary.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return buffer;
}



============================================================
File Path: supabase/migrations/20260116105919_df827dbb-3655-44ac-9367-68b77054d7a5.sql
============================================================
-- =============================================
-- Botida OS 멀티 테넌트 데이터베이스 스키마 (Idempotent)
-- =============================================

-- 0) 필수 확장 (gen_random_uuid)
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 1) 역할 Enum 생성 (이미 있으면 스킵)
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'tenant_role') THEN
    CREATE TYPE public.tenant_role AS ENUM ('company_admin', 'manager', 'employee');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'system_role') THEN
    CREATE TYPE public.system_role AS ENUM ('sys_super_admin', 'regular_user');
  END IF;
END $$;

-- 2) 프로필 테이블 (사용자 기본 정보)
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  phone TEXT,
  system_role public.system_role NOT NULL DEFAULT 'regular_user',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 3) 테넌트(회사) 테이블
CREATE TABLE IF NOT EXISTS public.tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  domain TEXT UNIQUE,
  logo_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 4) 테넌트 멤버십 테이블 (사용자-회사 연결 + 역할)
CREATE TABLE IF NOT EXISTS public.tenant_memberships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  role public.tenant_role NOT NULL DEFAULT 'employee',
  department TEXT,
  job_title TEXT,
  invited_by UUID REFERENCES public.profiles(id),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  UNIQUE(user_id, tenant_id)
);

-- 5) 외부 거래처 청구 테이블
CREATE TABLE IF NOT EXISTS public.vendor_invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  vendor_name TEXT NOT NULL,
  business_number TEXT,
  description TEXT,
  amount DECIMAL(15,2) NOT NULL,
  bank_name TEXT,
  account_number TEXT,
  account_holder TEXT,
  assigned_to UUID REFERENCES public.profiles(id),
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'approved', 'rejected', 'paid')),
  submitted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  processed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 6) 청구서 첨부파일 테이블
CREATE TABLE IF NOT EXISTS public.invoice_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invoice_id UUID NOT NULL REFERENCES public.vendor_invoices(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_url TEXT NOT NULL,
  file_type TEXT,
  file_size INTEGER,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- =============================================
-- 헬퍼 함수들
-- =============================================

-- 시스템 슈퍼어드민 확인 함수
CREATE OR REPLACE FUNCTION public.is_sys_super_admin()
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid()
      AND system_role = 'sys_super_admin'
  )
$$;

-- 테넌트 멤버 확인 함수
CREATE OR REPLACE FUNCTION public.is_tenant_member(_tenant_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.tenant_memberships
    WHERE user_id = auth.uid()
      AND tenant_id = _tenant_id
  )
$$;

-- 테넌트 관리자 확인 함수
CREATE OR REPLACE FUNCTION public.is_tenant_admin(_tenant_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.tenant_memberships
    WHERE user_id = auth.uid()
      AND tenant_id = _tenant_id
      AND role = 'company_admin'
  )
$$;

-- 테넌트 매니저 이상 확인 함수
CREATE OR REPLACE FUNCTION public.is_tenant_manager_or_admin(_tenant_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.tenant_memberships
    WHERE user_id = auth.uid()
      AND tenant_id = _tenant_id
      AND role IN ('company_admin', 'manager')
  )
$$;

-- 사용자의 모든 테넌트 ID 반환 함수
CREATE OR REPLACE FUNCTION public.get_user_tenant_ids()
RETURNS SETOF UUID
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT tenant_id
  FROM public.tenant_memberships
  WHERE user_id = auth.uid()
$$;

-- =============================================
-- RLS 활성화
-- =============================================

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tenant_memberships ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vendor_invoices ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.invoice_attachments ENABLE ROW LEVEL SECURITY;

-- =============================================
-- RLS 정책 (재실행 가능: DROP -> CREATE)
-- =============================================

-- Profiles 정책
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
CREATE POLICY "Users can view their own profile"
  ON public.profiles FOR SELECT
  USING (id = auth.uid() OR public.is_sys_super_admin());

DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
CREATE POLICY "Users can update their own profile"
  ON public.profiles FOR UPDATE
  USING (id = auth.uid())
  WITH CHECK (id = auth.uid());

-- ⚠️ 트리거가 profiles를 생성하므로, 클라이언트 INSERT 정책은 보통 불필요
-- (원하면 아래 2줄을 살려서 사용해도 됨. 단, DROP/CREATE 형태로 유지)
-- DROP POLICY IF EXISTS "System creates profile on signup" ON public.profiles;
-- CREATE POLICY "System creates profile on signup" ON public.profiles FOR INSERT WITH CHECK (id = auth.uid());

-- Tenants 정책
DROP POLICY IF EXISTS "Members can view their tenants" ON public.tenants;
CREATE POLICY "Members can view their tenants"
  ON public.tenants FOR SELECT
  USING (public.is_tenant_member(id) OR public.is_sys_super_admin());

DROP POLICY IF EXISTS "Super admins can create tenants" ON public.tenants;
CREATE POLICY "Super admins can create tenants"
  ON public.tenants FOR INSERT
  WITH CHECK (public.is_sys_super_admin());

DROP POLICY IF EXISTS "Super admins can update tenants" ON public.tenants;
CREATE POLICY "Super admins can update tenants"
  ON public.tenants FOR UPDATE
  USING (public.is_sys_super_admin())
  WITH CHECK (public.is_sys_super_admin());

DROP POLICY IF EXISTS "Super admins can delete tenants" ON public.tenants;
CREATE POLICY "Super admins can delete tenants"
  ON public.tenants FOR DELETE
  USING (public.is_sys_super_admin());

-- Tenant Memberships 정책
DROP POLICY IF EXISTS "Members can view tenant memberships" ON public.tenant_memberships;
CREATE POLICY "Members can view tenant memberships"
  ON public.tenant_memberships FOR SELECT
  USING (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin());

DROP POLICY IF EXISTS "Admins can create memberships" ON public.tenant_memberships;
CREATE POLICY "Admins can create memberships"
  ON public.tenant_memberships FOR INSERT
  WITH CHECK (
    public.is_sys_super_admin()
    OR (public.is_tenant_admin(tenant_id) AND invited_by = auth.uid())
  );

DROP POLICY IF EXISTS "Admins can update memberships" ON public.tenant_memberships;
CREATE POLICY "Admins can update memberships"
  ON public.tenant_memberships FOR UPDATE
  USING (
    public.is_sys_super_admin()
    OR public.is_tenant_admin(tenant_id)
  )
  WITH CHECK (
    public.is_sys_super_admin()
    OR public.is_tenant_admin(tenant_id)
  );

DROP POLICY IF EXISTS "Admins can delete memberships" ON public.tenant_memberships;
CREATE POLICY "Admins can delete memberships"
  ON public.tenant_memberships FOR DELETE
  USING (
    public.is_sys_super_admin()
    OR (public.is_tenant_admin(tenant_id) AND user_id <> auth.uid())
  );

-- Vendor Invoices 정책
DROP POLICY IF EXISTS "Members can view tenant invoices" ON public.vendor_invoices;
CREATE POLICY "Members can view tenant invoices"
  ON public.vendor_invoices FOR SELECT
  USING (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin());

DROP POLICY IF EXISTS "Anyone can submit invoice (guest form)" ON public.vendor_invoices;
CREATE POLICY "Anyone can submit invoice (guest form)"
  ON public.vendor_invoices FOR INSERT
  WITH CHECK (true);

DROP POLICY IF EXISTS "Members can update invoices" ON public.vendor_invoices;
CREATE POLICY "Members can update invoices"
  ON public.vendor_invoices FOR UPDATE
  USING (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin())
  WITH CHECK (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin());

-- Invoice Attachments 정책
DROP POLICY IF EXISTS "Members can view attachments" ON public.invoice_attachments;
CREATE POLICY "Members can view attachments"
  ON public.invoice_attachments FOR SELECT
  USING (
    EXISTS (
      SELECT 1
      FROM public.vendor_invoices vi
      WHERE vi.id = invoice_id
        AND (public.is_tenant_member(vi.tenant_id) OR public.is_sys_super_admin())
    )
  );

DROP POLICY IF EXISTS "Anyone can add attachments (guest form)" ON public.invoice_attachments;
CREATE POLICY "Anyone can add attachments (guest form)"
  ON public.invoice_attachments FOR INSERT
  WITH CHECK (true);

-- =============================================
-- 자동 프로필 생성 트리거
-- =============================================

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email)
  )
  ON CONFLICT (id) DO UPDATE
    SET email = EXCLUDED.email,
        full_name = EXCLUDED.full_name;

  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- =============================================
-- Updated_at 자동 업데이트 트리거
-- =============================================

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS update_profiles_updated_at ON public.profiles;
CREATE TRIGGER update_profiles_updated_at
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

DROP TRIGGER IF EXISTS update_tenants_updated_at ON public.tenants;
CREATE TRIGGER update_tenants_updated_at
  BEFORE UPDATE ON public.tenants
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

DROP TRIGGER IF EXISTS update_tenant_memberships_updated_at ON public.tenant_memberships;
CREATE TRIGGER update_tenant_memberships_updated_at
  BEFORE UPDATE ON public.tenant_memberships
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

DROP TRIGGER IF EXISTS update_vendor_invoices_updated_at ON public.vendor_invoices;
CREATE TRIGGER update_vendor_invoices_updated_at
  BEFORE UPDATE ON public.vendor_invoices
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260116105945_1ea1ea21-74f1-4f96-84da-ab5430af9eda.sql
============================================================
-- search_path 설정이 누락된 함수 수정
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY INVOKER
SET search_path = public
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;


============================================================
File Path: supabase/migrations/20260116110714_b387a50c-2974-4070-8bfa-0dee4cfce0cc.sql
============================================================
-- 회원가입 시 첫 사용자를 Boteda 본사 company_admin으로 자동 설정하는 함수
CREATE OR REPLACE FUNCTION public.auto_assign_first_user_to_boteda()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  boteda_tenant_id uuid;
  membership_count integer;
BEGIN
  -- Boteda 본사 테넌트 ID 조회
  SELECT id INTO boteda_tenant_id FROM tenants WHERE name = 'Boteda 본사' LIMIT 1;
  
  -- 테넌트가 없으면 종료
  IF boteda_tenant_id IS NULL THEN
    RETURN NEW;
  END IF;
  
  -- 현재 멤버십 수 확인
  SELECT COUNT(*) INTO membership_count FROM tenant_memberships;
  
  -- 첫 번째 사용자인 경우 (멤버십이 없는 경우)
  IF membership_count = 0 THEN
    -- Boteda 본사에 company_admin으로 추가
    INSERT INTO tenant_memberships (user_id, tenant_id, role, department, job_title)
    VALUES (NEW.id, boteda_tenant_id, 'company_admin', '경영지원', '시스템 관리자');
    
    -- 시스템 슈퍼 어드민 권한도 부여
    UPDATE profiles SET system_role = 'sys_super_admin' WHERE id = NEW.id;
  END IF;
  
  RETURN NEW;
END;
$$;

-- 프로필 생성 후 트리거 실행
DROP TRIGGER IF EXISTS on_profile_created_assign_first_user ON profiles;
CREATE TRIGGER on_profile_created_assign_first_user
  AFTER INSERT ON profiles
  FOR EACH ROW
  EXECUTE FUNCTION auto_assign_first_user_to_boteda();


============================================================
File Path: supabase/migrations/20260116110928_2e6fb979-78eb-43b4-a463-22a1b32a4f6c.sql
============================================================
-- 회원가입 요청 테이블 (승인 대기)
CREATE TABLE public.signup_requests (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  company_name text NOT NULL,
  status text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  reviewed_by uuid REFERENCES profiles(id),
  reviewed_at timestamp with time zone,
  assigned_tenant_id uuid REFERENCES tenants(id),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now()
);

-- RLS 활성화
ALTER TABLE public.signup_requests ENABLE ROW LEVEL SECURITY;

-- 사용자는 자신의 요청만 볼 수 있음
CREATE POLICY "Users can view their own requests"
ON public.signup_requests
FOR SELECT
USING (user_id = auth.uid() OR is_sys_super_admin());

-- 사용자는 자신의 요청 생성 가능
CREATE POLICY "Users can create their own requests"
ON public.signup_requests
FOR INSERT
WITH CHECK (user_id = auth.uid());

-- 슈퍼 어드민만 요청 수정 가능 (승인/거절)
CREATE POLICY "Super admins can update requests"
ON public.signup_requests
FOR UPDATE
USING (is_sys_super_admin());

-- 슈퍼 어드민만 요청 삭제 가능
CREATE POLICY "Super admins can delete requests"
ON public.signup_requests
FOR DELETE
USING (is_sys_super_admin());

-- updated_at 자동 업데이트 트리거
CREATE TRIGGER update_signup_requests_updated_at
BEFORE UPDATE ON public.signup_requests
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();

-- 첫 사용자 자동 배정 트리거 삭제 (더 이상 필요 없음)
DROP TRIGGER IF EXISTS on_profile_created_assign_first_user ON profiles;
DROP FUNCTION IF EXISTS auto_assign_first_user_to_boteda();


============================================================
File Path: supabase/migrations/20260116150350_850e071e-50f5-49c1-a281-a4fd7708261c.sql
============================================================
-- Add business registration fields to tenants table
ALTER TABLE public.tenants
ADD COLUMN biz_number text,
ADD COLUMN corp_number text,
ADD COLUMN rep_name text,
ADD COLUMN opening_date text,
ADD COLUMN tax_email text,
ADD COLUMN biz_type text,
ADD COLUMN biz_item text,
ADD COLUMN address text;


============================================================
File Path: supabase/migrations/20260116154752_e376eadb-3c5d-436c-a3d2-782ac9e92ac5.sql
============================================================
-- Add Google Drive integration fields to tenants table
-- google_credentials stores the encrypted service account JSON key
-- drive_folder_id stores the target folder ID for file uploads

ALTER TABLE public.tenants
ADD COLUMN google_credentials text,
ADD COLUMN drive_folder_id text,
ADD COLUMN drive_connected_at timestamptz,
ADD COLUMN drive_connected_by uuid REFERENCES public.profiles(id);

-- Add comment for documentation
COMMENT ON COLUMN public.tenants.google_credentials IS 'Encrypted Google service account JSON key';
COMMENT ON COLUMN public.tenants.drive_folder_id IS 'Google Drive folder ID for file storage';
COMMENT ON COLUMN public.tenants.drive_connected_at IS 'When Google Drive was connected';
COMMENT ON COLUMN public.tenants.drive_connected_by IS 'Who connected Google Drive';


============================================================
File Path: supabase/migrations/20260116154824_d7aa9e86-8b00-42c3-a821-09c422390111.sql
============================================================
-- Allow company admins to update their own tenant's Google Drive settings
DROP POLICY IF EXISTS "Super admins can update tenants" ON public.tenants;

CREATE POLICY "Admins can update tenants"
ON public.tenants
FOR UPDATE
USING (is_sys_super_admin() OR is_tenant_admin(id));


============================================================
File Path: supabase/migrations/20260120105658_fa39420f-87cb-4019-9e02-ec555835f426.sql
============================================================
-- 키워드 관리 테이블
CREATE TABLE public.keywords (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  keyword TEXT NOT NULL,
  category TEXT,
  priority INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- 배우/아티스트 정보 테이블
CREATE TABLE public.artists (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  stage_name TEXT,
  birth_date DATE,
  gender TEXT CHECK (gender IN ('male', 'female', 'other')),
  profile_image_url TEXT,
  bio TEXT,
  agency TEXT,
  debut_date DATE,
  social_links JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- 회사별 API 설정 테이블
CREATE TABLE public.tenant_api_configs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  config_key TEXT NOT NULL,
  config_value TEXT NOT NULL,
  description TEXT,
  category TEXT DEFAULT 'general',
  is_encrypted BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  UNIQUE(tenant_id, config_key)
);

-- 시스템 전역 설정 테이블 (슈퍼어드민용)
CREATE TABLE public.system_configs (
  key TEXT NOT NULL PRIMARY KEY,
  value TEXT NOT NULL,
  description TEXT,
  category TEXT DEFAULT 'general',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 언론사 연락처 테이블
CREATE TABLE public.press_contacts (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  media_company TEXT NOT NULL,
  reporter_name TEXT NOT NULL,
  contact_email TEXT NOT NULL UNIQUE,
  contact_phone TEXT,
  purpose TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  created_by UUID REFERENCES auth.users(id)
);

-- RLS 활성화
ALTER TABLE public.keywords ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.artists ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tenant_api_configs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.system_configs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.press_contacts ENABLE ROW LEVEL SECURITY;

-- keywords RLS 정책
CREATE POLICY "Tenant members can view keywords"
  ON public.keywords FOR SELECT
  USING (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can manage keywords"
  ON public.keywords FOR ALL
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

-- artists RLS 정책
CREATE POLICY "Tenant members can view artists"
  ON public.artists FOR SELECT
  USING (public.is_tenant_member(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can manage artists"
  ON public.artists FOR ALL
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

-- tenant_api_configs RLS 정책 (관리자만)
CREATE POLICY "Tenant admins can view api configs"
  ON public.tenant_api_configs FOR SELECT
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can manage api configs"
  ON public.tenant_api_configs FOR ALL
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

-- system_configs RLS 정책 (슈퍼어드민만)
CREATE POLICY "Super admins can view system configs"
  ON public.system_configs FOR SELECT
  USING (public.is_sys_super_admin());

CREATE POLICY "Super admins can manage system configs"
  ON public.system_configs FOR ALL
  USING (public.is_sys_super_admin());

-- press_contacts RLS 정책 (슈퍼어드민만)
CREATE POLICY "Super admins can view press contacts"
  ON public.press_contacts FOR SELECT
  USING (public.is_sys_super_admin());

CREATE POLICY "Super admins can manage press contacts"
  ON public.press_contacts FOR ALL
  USING (public.is_sys_super_admin());

-- 업데이트 트리거 적용
CREATE TRIGGER update_keywords_updated_at
  BEFORE UPDATE ON public.keywords
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_artists_updated_at
  BEFORE UPDATE ON public.artists
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_tenant_api_configs_updated_at
  BEFORE UPDATE ON public.tenant_api_configs
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_system_configs_updated_at
  BEFORE UPDATE ON public.system_configs
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_press_contacts_updated_at
  BEFORE UPDATE ON public.press_contacts
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- 초기 시스템 설정값 삽입
INSERT INTO public.system_configs (key, value, description, category) VALUES
  ('huggingface_token', '', 'Hugging Face API 토큰', 'AI'),
  ('huggingface_model', 'meta-llama/Llama-3.1-8B-Instruct', '사용할 HuggingFace 모델', 'AI');


============================================================
File Path: supabase/migrations/20260120111044_ad31b45c-32f3-4aa9-aa76-d25222ec0ac8.sql
============================================================
-- 직원 초대 테이블
CREATE TABLE public.employee_invitations (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'employee' CHECK (role IN ('company_admin', 'manager', 'employee')),
  department TEXT,
  job_title TEXT,
  invited_by UUID REFERENCES auth.users(id),
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled')),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() + interval '7 days'),
  accepted_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  UNIQUE(tenant_id, email, status)
);

-- RLS 활성화
ALTER TABLE public.employee_invitations ENABLE ROW LEVEL SECURITY;

-- 회사 관리자는 자기 회사의 초대를 관리할 수 있음
CREATE POLICY "Tenant admins can view invitations"
  ON public.employee_invitations FOR SELECT
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can create invitations"
  ON public.employee_invitations FOR INSERT
  WITH CHECK (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can update invitations"
  ON public.employee_invitations FOR UPDATE
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

CREATE POLICY "Tenant admins can delete invitations"
  ON public.employee_invitations FOR DELETE
  USING (public.is_tenant_admin(tenant_id) OR public.is_sys_super_admin());

-- 초대받은 사람도 본인의 초대를 볼 수 있음 (이메일 기반)
CREATE POLICY "Users can view their own invitations"
  ON public.employee_invitations FOR SELECT
  USING (
    email = (SELECT email FROM auth.users WHERE id = auth.uid())
    AND status = 'pending'
  );

-- 업데이트 트리거
CREATE TRIGGER update_employee_invitations_updated_at
  BEFORE UPDATE ON public.employee_invitations
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


============================================================
File Path: supabase/migrations/20260204145331_e31a75dd-b17f-400a-a20b-a4e80870490d.sql
============================================================
-- 1. 부서 테이블
CREATE TABLE public.departments (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  parent_id UUID REFERENCES public.departments(id) ON DELETE SET NULL,
  description TEXT,
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 2. 직급 테이블
CREATE TABLE public.job_titles (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  level INTEGER DEFAULT 0,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 3. 프로젝트 테이블
CREATE TABLE public.projects (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  code TEXT,
  description TEXT,
  status TEXT DEFAULT 'active',
  start_date DATE,
  end_date DATE,
  budget NUMERIC,
  pm_user_id UUID,
  created_by UUID,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 4. 법인카드 테이블
CREATE TABLE public.corporate_cards (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  card_number TEXT NOT NULL,
  card_name TEXT,
  card_company TEXT,
  holder_user_id UUID,
  monthly_limit NUMERIC,
  is_active BOOLEAN DEFAULT true,
  expiry_date DATE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 5. 법인카드 사용내역 테이블
CREATE TABLE public.card_transactions (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  card_id UUID NOT NULL REFERENCES public.corporate_cards(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  amount NUMERIC NOT NULL,
  merchant_name TEXT,
  transaction_date TIMESTAMP WITH TIME ZONE NOT NULL,
  category TEXT,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  receipt_url TEXT,
  memo TEXT,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 6. 차량 테이블
CREATE TABLE public.vehicles (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  plate_number TEXT NOT NULL,
  model TEXT,
  manufacturer TEXT,
  year INTEGER,
  vin TEXT,
  lease_company TEXT,
  lease_start_date DATE,
  lease_end_date DATE,
  monthly_lease_cost NUMERIC,
  insurance_company TEXT,
  insurance_expiry DATE,
  assigned_user_id UUID,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 7. 차량 사고 이력 테이블
CREATE TABLE public.vehicle_accidents (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  vehicle_id UUID NOT NULL REFERENCES public.vehicles(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  accident_date DATE NOT NULL,
  description TEXT,
  damage_cost NUMERIC,
  insurance_claim BOOLEAN DEFAULT false,
  claim_amount NUMERIC,
  driver_user_id UUID,
  status TEXT DEFAULT 'reported',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Enable RLS on all tables
ALTER TABLE public.departments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.job_titles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.corporate_cards ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.card_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vehicles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vehicle_accidents ENABLE ROW LEVEL SECURITY;

-- RLS Policies for departments
CREATE POLICY "Tenant members can view departments" ON public.departments
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage departments" ON public.departments
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for job_titles
CREATE POLICY "Tenant members can view job_titles" ON public.job_titles
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage job_titles" ON public.job_titles
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for projects
CREATE POLICY "Tenant members can view projects" ON public.projects
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage projects" ON public.projects
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for corporate_cards
CREATE POLICY "Tenant members can view corporate_cards" ON public.corporate_cards
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage corporate_cards" ON public.corporate_cards
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for card_transactions
CREATE POLICY "Tenant members can view card_transactions" ON public.card_transactions
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage card_transactions" ON public.card_transactions
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for vehicles
CREATE POLICY "Tenant members can view vehicles" ON public.vehicles
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage vehicles" ON public.vehicles
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS Policies for vehicle_accidents
CREATE POLICY "Tenant members can view vehicle_accidents" ON public.vehicle_accidents
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());
CREATE POLICY "Tenant admins can manage vehicle_accidents" ON public.vehicle_accidents
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- Add updated_at triggers
CREATE TRIGGER update_departments_updated_at BEFORE UPDATE ON public.departments
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
CREATE TRIGGER update_job_titles_updated_at BEFORE UPDATE ON public.job_titles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON public.projects
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
CREATE TRIGGER update_corporate_cards_updated_at BEFORE UPDATE ON public.corporate_cards
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
CREATE TRIGGER update_vehicles_updated_at BEFORE UPDATE ON public.vehicles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
CREATE TRIGGER update_vehicle_accidents_updated_at BEFORE UPDATE ON public.vehicle_accidents
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


============================================================
File Path: supabase/migrations/20260204151131_a350310a-beb8-4ae8-8d64-3b83d7a5e167.sql
============================================================

-- Create driving_logs table for GPS-based trip logging
CREATE TABLE public.driving_logs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  vehicle_id UUID NOT NULL REFERENCES public.vehicles(id) ON DELETE CASCADE,
  driver_user_id UUID REFERENCES public.profiles(id),
  start_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  end_time TIMESTAMP WITH TIME ZONE,
  start_location_lat NUMERIC,
  start_location_lng NUMERIC,
  start_address TEXT,
  end_location_lat NUMERIC,
  end_location_lng NUMERIC,
  end_address TEXT,
  distance_km NUMERIC DEFAULT 0,
  purpose TEXT,
  memo TEXT,
  status TEXT NOT NULL DEFAULT 'in_progress',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Create driving_log_waypoints for tracking route
CREATE TABLE public.driving_log_waypoints (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  log_id UUID NOT NULL REFERENCES public.driving_logs(id) ON DELETE CASCADE,
  latitude NUMERIC NOT NULL,
  longitude NUMERIC NOT NULL,
  recorded_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  speed_kmh NUMERIC,
  heading NUMERIC
);

-- Enable RLS
ALTER TABLE public.driving_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.driving_log_waypoints ENABLE ROW LEVEL SECURITY;

-- RLS policies for driving_logs
CREATE POLICY "Tenant members can view driving_logs"
  ON public.driving_logs FOR SELECT
  USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can create driving_logs"
  ON public.driving_logs FOR INSERT
  WITH CHECK (is_tenant_member(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can update their driving_logs"
  ON public.driving_logs FOR UPDATE
  USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant admins can delete driving_logs"
  ON public.driving_logs FOR DELETE
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- RLS policies for driving_log_waypoints
CREATE POLICY "Members can view waypoints"
  ON public.driving_log_waypoints FOR SELECT
  USING (EXISTS (
    SELECT 1 FROM public.driving_logs dl
    WHERE dl.id = driving_log_waypoints.log_id
    AND (is_tenant_member(dl.tenant_id) OR is_sys_super_admin())
  ));

CREATE POLICY "Members can create waypoints"
  ON public.driving_log_waypoints FOR INSERT
  WITH CHECK (EXISTS (
    SELECT 1 FROM public.driving_logs dl
    WHERE dl.id = driving_log_waypoints.log_id
    AND (is_tenant_member(dl.tenant_id) OR is_sys_super_admin())
  ));

CREATE POLICY "Members can delete waypoints"
  ON public.driving_log_waypoints FOR DELETE
  USING (EXISTS (
    SELECT 1 FROM public.driving_logs dl
    WHERE dl.id = driving_log_waypoints.log_id
    AND (is_tenant_admin(dl.tenant_id) OR is_sys_super_admin())
  ));

-- Triggers for updated_at
CREATE TRIGGER update_driving_logs_updated_at
  BEFORE UPDATE ON public.driving_logs
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- Create index for performance
CREATE INDEX idx_driving_logs_tenant_id ON public.driving_logs(tenant_id);
CREATE INDEX idx_driving_logs_vehicle_id ON public.driving_logs(vehicle_id);
CREATE INDEX idx_driving_logs_driver_user_id ON public.driving_logs(driver_user_id);
CREATE INDEX idx_driving_log_waypoints_log_id ON public.driving_log_waypoints(log_id);



============================================================
File Path: supabase/migrations/20260204151716_47ad90b9-6ded-440b-9bb4-c814e2fb50c0.sql
============================================================

-- Create HR records table for tracking employee history
CREATE TABLE public.hr_records (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  record_type TEXT NOT NULL, -- 'hire', 'promotion', 'transfer', 'leave', 'return', 'resignation', 'note'
  title TEXT NOT NULL,
  description TEXT,
  effective_date DATE NOT NULL DEFAULT CURRENT_DATE,
  old_department TEXT,
  new_department TEXT,
  old_job_title TEXT,
  new_job_title TEXT,
  old_role TEXT,
  new_role TEXT,
  created_by UUID REFERENCES public.profiles(id),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Enable RLS
ALTER TABLE public.hr_records ENABLE ROW LEVEL SECURITY;

-- RLS policies for hr_records
CREATE POLICY "Tenant members can view hr_records"
  ON public.hr_records FOR SELECT
  USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant admins can create hr_records"
  ON public.hr_records FOR INSERT
  WITH CHECK (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant admins can update hr_records"
  ON public.hr_records FOR UPDATE
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant admins can delete hr_records"
  ON public.hr_records FOR DELETE
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- Trigger for updated_at
CREATE TRIGGER update_hr_records_updated_at
  BEFORE UPDATE ON public.hr_records
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- Create indexes
CREATE INDEX idx_hr_records_tenant_id ON public.hr_records(tenant_id);
CREATE INDEX idx_hr_records_user_id ON public.hr_records(user_id);
CREATE INDEX idx_hr_records_effective_date ON public.hr_records(effective_date);

-- Add SELECT policy for profiles within same tenant (for viewing other employees)
CREATE POLICY "Tenant members can view tenant member profiles"
  ON public.profiles FOR SELECT
  USING (
    id = auth.uid() 
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm1
      JOIN public.tenant_memberships tm2 ON tm1.tenant_id = tm2.tenant_id
      WHERE tm1.user_id = auth.uid() AND tm2.user_id = profiles.id
    )
  );



============================================================
File Path: supabase/migrations/20260206141733_fdad27b0-a531-4916-82d7-4f7e93d75f2c.sql
============================================================
-- Fix corporate_cards RLS policy to restrict access to admins and card holders only
-- Drop the existing overly permissive SELECT policy
DROP POLICY IF EXISTS "Tenant members can view corporate_cards" ON public.corporate_cards;

-- Create more restrictive SELECT policy - only admins and card holders can view
CREATE POLICY "Only admins and card holders can view corporate_cards"
  ON public.corporate_cards
  FOR SELECT
  USING (
    is_tenant_admin(tenant_id) 
    OR is_sys_super_admin() 
    OR holder_user_id = auth.uid()
  );

-- Add explicit policy to block anonymous access to profiles
DROP POLICY IF EXISTS "Block anonymous access to profiles" ON public.profiles;
CREATE POLICY "Block anonymous access to profiles"
  ON public.profiles
  FOR SELECT
  TO anon
  USING (false);

-- Create a secure server-side function for invoice submission with validation
CREATE OR REPLACE FUNCTION public.submit_vendor_invoice(
  p_tenant_id uuid,
  p_vendor_name text,
  p_amount numeric,
  p_description text DEFAULT NULL,
  p_bank_name text DEFAULT NULL,
  p_account_number text DEFAULT NULL,
  p_account_holder text DEFAULT NULL,
  p_business_number text DEFAULT NULL
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_invoice_id uuid;
BEGIN
  -- Validate tenant exists
  IF NOT EXISTS (SELECT 1 FROM public.tenants WHERE id = p_tenant_id) THEN
    RAISE EXCEPTION 'Invalid tenant';
  END IF;
  
  -- Validate vendor_name is not empty and within limits
  IF p_vendor_name IS NULL OR length(trim(p_vendor_name)) = 0 THEN
    RAISE EXCEPTION 'Vendor name is required';
  END IF;
  IF length(p_vendor_name) > 200 THEN
    RAISE EXCEPTION 'Vendor name is too long (max 200 characters)';
  END IF;
  
  -- Validate amount
  IF p_amount IS NULL OR p_amount <= 0 THEN
    RAISE EXCEPTION 'Amount must be greater than 0';
  END IF;
  IF p_amount > 999999999999 THEN
    RAISE EXCEPTION 'Amount exceeds maximum allowed value';
  END IF;
  
  -- Validate description length if provided
  IF p_description IS NOT NULL AND length(p_description) > 2000 THEN
    RAISE EXCEPTION 'Description is too long (max 2000 characters)';
  END IF;
  
  -- Validate other fields length
  IF p_bank_name IS NOT NULL AND length(p_bank_name) > 100 THEN
    RAISE EXCEPTION 'Bank name is too long (max 100 characters)';
  END IF;
  IF p_account_number IS NOT NULL AND length(p_account_number) > 50 THEN
    RAISE EXCEPTION 'Account number is too long (max 50 characters)';
  END IF;
  IF p_account_holder IS NOT NULL AND length(p_account_holder) > 100 THEN
    RAISE EXCEPTION 'Account holder is too long (max 100 characters)';
  END IF;
  IF p_business_number IS NOT NULL AND length(p_business_number) > 20 THEN
    RAISE EXCEPTION 'Business number is too long (max 20 characters)';
  END IF;

  -- Insert the validated invoice
  INSERT INTO public.vendor_invoices (
    tenant_id,
    vendor_name,
    amount,
    description,
    bank_name,
    account_number,
    account_holder,
    business_number,
    status,
    submitted_at
  ) VALUES (
    p_tenant_id,
    trim(p_vendor_name),
    p_amount,
    trim(p_description),
    trim(p_bank_name),
    trim(p_account_number),
    trim(p_account_holder),
    trim(p_business_number),
    'pending',
    now()
  )
  RETURNING id INTO v_invoice_id;
  
  RETURN v_invoice_id;
END;
$$;

-- Grant execute permission on the function
GRANT EXECUTE ON FUNCTION public.submit_vendor_invoice TO anon, authenticated;


============================================================
File Path: supabase/migrations/20260209150747_ebdfdc57-2122-4776-84a9-d1c1af1b54f4.sql
============================================================

-- 1. 회사 유형 enum 생성
CREATE TYPE public.company_type AS ENUM (
  'talent_agency',       -- 배우 매니지먼트사
  'pr_agency',           -- PR 에이전시
  'finance_outsourcing', -- 재무 아웃소싱사
  'marketing_agency',    -- 마케팅 에이전시
  'production_agency',   -- 작품 에이전시
  'sales_agency'         -- 영업 에이전시
);

-- 2. tenants 테이블에 company_type 컬럼 추가
ALTER TABLE public.tenants
ADD COLUMN company_type public.company_type DEFAULT 'talent_agency';

-- 3. signup_requests에도 company_type 추가 (가입 신청 시 유형 선택)
ALTER TABLE public.signup_requests
ADD COLUMN company_type public.company_type DEFAULT 'talent_agency';



============================================================
File Path: supabase/migrations/20260209151101_d4789416-b78c-4a31-bd3e-44816239d2f0.sql
============================================================

-- 1. 파트너십 테이블 생성
CREATE TABLE public.tenant_partnerships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  requester_tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  target_tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending',  -- pending, active, rejected, revoked
  data_scopes TEXT[] NOT NULL DEFAULT '{}', -- 공유 데이터 범위: artists, projects, hr, finance, keywords
  message TEXT,  -- 초대 시 메시지
  invited_by UUID REFERENCES public.profiles(id),
  accepted_by UUID REFERENCES public.profiles(id),
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT unique_partnership UNIQUE(requester_tenant_id, target_tenant_id),
  CONSTRAINT no_self_partnership CHECK (requester_tenant_id != target_tenant_id)
);

-- 2. RLS 활성화
ALTER TABLE public.tenant_partnerships ENABLE ROW LEVEL SECURITY;

-- 3. 양쪽 테넌트의 멤버가 조회 가능
CREATE POLICY "Members can view their partnerships"
  ON public.tenant_partnerships FOR SELECT
  USING (
    is_tenant_member(requester_tenant_id) 
    OR is_tenant_member(target_tenant_id) 
    OR is_sys_super_admin()
  );

-- 4. 테넌트 어드민만 파트너십 생성 가능
CREATE POLICY "Admins can create partnerships"
  ON public.tenant_partnerships FOR INSERT
  WITH CHECK (
    is_tenant_admin(requester_tenant_id) 
    OR is_sys_super_admin()
  );

-- 5. 양쪽 어드민이 업데이트 가능 (수락/거절/취소)
CREATE POLICY "Admins can update partnerships"
  ON public.tenant_partnerships FOR UPDATE
  USING (
    is_tenant_admin(requester_tenant_id) 
    OR is_tenant_admin(target_tenant_id) 
    OR is_sys_super_admin()
  );

-- 6. 요청한 쪽 어드민만 삭제 가능
CREATE POLICY "Requester admins can delete partnerships"
  ON public.tenant_partnerships FOR DELETE
  USING (
    is_tenant_admin(requester_tenant_id) 
    OR is_sys_super_admin()
  );

-- 7. 인덱스
CREATE INDEX idx_partnerships_requester ON public.tenant_partnerships(requester_tenant_id);
CREATE INDEX idx_partnerships_target ON public.tenant_partnerships(target_tenant_id);
CREATE INDEX idx_partnerships_status ON public.tenant_partnerships(status);

-- 8. updated_at 트리거
CREATE TRIGGER update_partnerships_updated_at
  BEFORE UPDATE ON public.tenant_partnerships
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

-- 9. 파트너 여부를 확인하는 security definer 함수
CREATE OR REPLACE FUNCTION public.is_active_partner(tenant_a UUID, tenant_b UUID)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.tenant_partnerships
    WHERE status = 'active'
    AND (
      (requester_tenant_id = tenant_a AND target_tenant_id = tenant_b)
      OR (requester_tenant_id = tenant_b AND target_tenant_id = tenant_a)
    )
  )
$$;

-- 10. 특정 데이터 스코프가 공유되었는지 확인하는 함수
CREATE OR REPLACE FUNCTION public.has_partner_scope(tenant_a UUID, tenant_b UUID, scope TEXT)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.tenant_partnerships
    WHERE status = 'active'
    AND scope = ANY(data_scopes)
    AND (
      (requester_tenant_id = tenant_a AND target_tenant_id = tenant_b)
      OR (requester_tenant_id = tenant_b AND target_tenant_id = tenant_a)
    )
  )
$$;



============================================================
File Path: supabase/migrations/20260209151555_11730a65-ca43-4ebe-9b97-1d59a849180b.sql
============================================================

-- =============================================
-- Phase 3: Extend RLS for partner data access
-- =============================================
-- 파트너사가 data_scopes에 따라 연결된 회사의 데이터를 열람할 수 있도록 
-- 각 테이블의 SELECT 정책에 파트너 접근 조건을 추가합니다.

-- 1. artists 테이블: 'artists' 스코프
DROP POLICY IF EXISTS "Tenant members can view artists" ON public.artists;
CREATE POLICY "Tenant members and partners can view artists"
  ON public.artists FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, artists.tenant_id, 'artists')
    )
  );

-- 2. projects 테이블: 'projects' 스코프
DROP POLICY IF EXISTS "Tenant members can view projects" ON public.projects;
CREATE POLICY "Tenant members and partners can view projects"
  ON public.projects FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, projects.tenant_id, 'projects')
    )
  );

-- 3. keywords 테이블: 'keywords' 스코프
DROP POLICY IF EXISTS "Tenant members can view keywords" ON public.keywords;
CREATE POLICY "Tenant members and partners can view keywords"
  ON public.keywords FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, keywords.tenant_id, 'keywords')
    )
  );

-- 4. hr_records 테이블: 'hr' 스코프
DROP POLICY IF EXISTS "Tenant members can view hr_records" ON public.hr_records;
CREATE POLICY "Tenant members and partners can view hr_records"
  ON public.hr_records FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, hr_records.tenant_id, 'hr')
    )
  );

-- 5. corporate_cards 테이블: 'finance' 스코프 (기존 정책 유지 + 파트너 추가)
DROP POLICY IF EXISTS "Only admins and card holders can view corporate_cards" ON public.corporate_cards;
CREATE POLICY "Admins card holders and partners can view corporate_cards"
  ON public.corporate_cards FOR SELECT
  USING (
    is_tenant_admin(tenant_id)
    OR is_sys_super_admin()
    OR (holder_user_id = auth.uid())
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, corporate_cards.tenant_id, 'finance')
    )
  );

-- 6. card_transactions 테이블: 'finance' 스코프
DROP POLICY IF EXISTS "Tenant members can view card_transactions" ON public.card_transactions;
CREATE POLICY "Tenant members and partners can view card_transactions"
  ON public.card_transactions FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, card_transactions.tenant_id, 'finance')
    )
  );

-- 7. tenant_memberships 테이블: 파트너사가 'hr' 스코프로 직원 정보 열람
DROP POLICY IF EXISTS "Members can view tenant memberships" ON public.tenant_memberships;
CREATE POLICY "Members and partners can view tenant memberships"
  ON public.tenant_memberships FOR SELECT
  USING (
    is_tenant_member(tenant_id)
    OR is_sys_super_admin()
    OR EXISTS (
      SELECT 1 FROM public.tenant_memberships my_tm
      WHERE my_tm.user_id = auth.uid()
      AND has_partner_scope(my_tm.tenant_id, tenant_memberships.tenant_id, 'hr')
    )
  );



============================================================
File Path: supabase/migrations/20260209222854_bb2de25c-a648-43f4-8fcf-af02880dc2ee.sql
============================================================

-- Create artist_schedules table
CREATE TABLE public.artist_schedules (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  artist_id UUID NOT NULL REFERENCES public.artists(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,
  is_all_day BOOLEAN DEFAULT false,
  schedule_type TEXT DEFAULT 'schedule',
  location TEXT,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

ALTER TABLE public.artist_schedules ENABLE ROW LEVEL SECURITY;

-- Trigger for updated_at
CREATE TRIGGER update_artist_schedules_updated_at
  BEFORE UPDATE ON public.artist_schedules
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

-- Index
CREATE INDEX idx_artist_schedules_tenant ON public.artist_schedules(tenant_id);
CREATE INDEX idx_artist_schedules_artist ON public.artist_schedules(artist_id);
CREATE INDEX idx_artist_schedules_time ON public.artist_schedules(start_time, end_time);

-- RLS: Tenant members full access
CREATE POLICY "Tenant members can view schedules"
  ON public.artist_schedules FOR SELECT
  USING (is_tenant_member(tenant_id));

CREATE POLICY "Tenant managers can insert schedules"
  ON public.artist_schedules FOR INSERT
  WITH CHECK (is_tenant_manager_or_admin(tenant_id));

CREATE POLICY "Tenant managers can update schedules"
  ON public.artist_schedules FOR UPDATE
  USING (is_tenant_manager_or_admin(tenant_id));

CREATE POLICY "Tenant managers can delete schedules"
  ON public.artist_schedules FOR DELETE
  USING (is_tenant_manager_or_admin(tenant_id));

-- Partner view: only shows availability (no title/description/location)
CREATE VIEW public.artist_schedule_availability
WITH (security_invoker = on) AS
  SELECT 
    id,
    artist_id,
    tenant_id,
    start_time,
    end_time,
    is_all_day,
    schedule_type,
    created_at
  FROM public.artist_schedules;

-- Partners can view schedule availability (not full details)
CREATE POLICY "Partners can view schedule availability"
  ON public.artist_schedules FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.tenant_memberships tm
      WHERE tm.user_id = auth.uid()
      AND has_partner_scope(tm.tenant_id, artist_schedules.tenant_id, 'artists')
    )
  );



============================================================
File Path: supabase/migrations/20260212134836_9c1775c7-eaa4-4396-a3cd-3d671ce97193.sql
============================================================

-- 1. Fix tenant_memberships SELECT policy (self-referencing causes infinite recursion)
DROP POLICY IF EXISTS "Members and partners can view tenant memberships" ON public.tenant_memberships;

CREATE POLICY "Members and partners can view tenant memberships"
ON public.tenant_memberships
FOR SELECT
USING (
  is_tenant_member(tenant_id)
  OR is_sys_super_admin()
  OR has_partner_scope((SELECT tm.tenant_id FROM public.tenant_memberships tm WHERE tm.user_id = auth.uid() LIMIT 1), tenant_id, 'hr')
);

-- 2. Fix profiles SELECT policy (references tenant_memberships causing recursion through its policies)
DROP POLICY IF EXISTS "Tenant members can view tenant member profiles" ON public.profiles;
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;

-- Create a SECURITY DEFINER function to check if two users share a tenant
CREATE OR REPLACE FUNCTION public.shares_tenant_with(target_user_id uuid)
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.tenant_memberships tm1
    JOIN public.tenant_memberships tm2 ON tm1.tenant_id = tm2.tenant_id
    WHERE tm1.user_id = auth.uid()
    AND tm2.user_id = target_user_id
  )
$$;

CREATE POLICY "Users can view accessible profiles"
ON public.profiles
FOR SELECT
USING (
  id = auth.uid()
  OR is_sys_super_admin()
  OR shares_tenant_with(id)
);



============================================================
File Path: supabase/migrations/20260212134916_31e0ae69-a98c-45b1-a96d-a72e4633e479.sql
============================================================

-- Create a helper function to check if user has partner HR scope to a tenant
CREATE OR REPLACE FUNCTION public.user_has_partner_hr_scope(_target_tenant_id uuid)
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.tenant_memberships tm
    JOIN public.tenant_partnerships tp ON (
      (tp.requester_tenant_id = tm.tenant_id AND tp.target_tenant_id = _target_tenant_id)
      OR (tp.target_tenant_id = tm.tenant_id AND tp.requester_tenant_id = _target_tenant_id)
    )
    WHERE tm.user_id = auth.uid()
    AND tp.status = 'active'
    AND 'hr' = ANY(tp.data_scopes)
  )
$$;

-- Replace the tenant_memberships SELECT policy to avoid any self-reference
DROP POLICY IF EXISTS "Members and partners can view tenant memberships" ON public.tenant_memberships;

CREATE POLICY "Members and partners can view tenant memberships"
ON public.tenant_memberships
FOR SELECT
USING (
  is_tenant_member(tenant_id)
  OR is_sys_super_admin()
  OR user_has_partner_hr_scope(tenant_id)
);



============================================================
File Path: supabase/migrations/20260212135155_4905fc6a-31e4-405d-8108-b24887a50de5.sql
============================================================

-- Allow all tenant members to insert schedules (not just managers)
DROP POLICY IF EXISTS "Tenant managers can insert schedules" ON public.artist_schedules;
CREATE POLICY "Tenant members can insert schedules"
ON public.artist_schedules
FOR INSERT
WITH CHECK (is_tenant_member(tenant_id));

-- Allow all tenant members to update schedules
DROP POLICY IF EXISTS "Tenant managers can update schedules" ON public.artist_schedules;
CREATE POLICY "Tenant members can update schedules"
ON public.artist_schedules
FOR UPDATE
USING (is_tenant_member(tenant_id));

-- Allow all tenant members to delete schedules
DROP POLICY IF EXISTS "Tenant managers can delete schedules" ON public.artist_schedules;
CREATE POLICY "Tenant members can delete schedules"
ON public.artist_schedules
FOR DELETE
USING (is_tenant_member(tenant_id));



============================================================
File Path: supabase/migrations/20260212161953_79772d56-2d1f-46d1-bb9b-dfd6a9798542.sql
============================================================

ALTER TABLE public.artists
  ADD COLUMN IF NOT EXISTS email text,
  ADD COLUMN IF NOT EXISTS contact_phone text,
  ADD COLUMN IF NOT EXISTS resident_number text,
  ADD COLUMN IF NOT EXISTS address text,
  ADD COLUMN IF NOT EXISTS contract_start_date date,
  ADD COLUMN IF NOT EXISTS contract_end_date date,
  ADD COLUMN IF NOT EXISTS namuwiki_url text,
  ADD COLUMN IF NOT EXISTS instagram_url text,
  ADD COLUMN IF NOT EXISTS youtube_url text,
  ADD COLUMN IF NOT EXISTS id_card_url text,
  ADD COLUMN IF NOT EXISTS id_card_masked_url text,
  ADD COLUMN IF NOT EXISTS signature_url text;



============================================================
File Path: supabase/migrations/20260213145419_98adfe57-133e-4808-90be-877c47df9759.sql
============================================================
-- Create storage bucket for artist assets
INSERT INTO storage.buckets (id, name, public)
VALUES ('artist-assets', 'artist-assets', true)
ON CONFLICT (id) DO NOTHING;

-- Allow authenticated users to upload
CREATE POLICY "Authenticated users can upload artist assets"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'artist-assets' AND auth.role() = 'authenticated');

-- Allow authenticated users to update their uploads
CREATE POLICY "Authenticated users can update artist assets"
ON storage.objects FOR UPDATE
USING (bucket_id = 'artist-assets' AND auth.role() = 'authenticated');

-- Allow public read access
CREATE POLICY "Public read access for artist assets"
ON storage.objects FOR SELECT
USING (bucket_id = 'artist-assets');

-- Allow authenticated users to delete
CREATE POLICY "Authenticated users can delete artist assets"
ON storage.objects FOR DELETE
USING (bucket_id = 'artist-assets' AND auth.role() = 'authenticated');



============================================================
File Path: supabase/migrations/20260213154825_bf4d6616-2447-4bdc-9eba-8c7eb134b9ba.sql
============================================================

-- Drop existing overly permissive storage policies for artist-assets
DROP POLICY IF EXISTS "Authenticated users can upload artist assets" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can update artist assets" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can delete artist assets" ON storage.objects;
DROP POLICY IF EXISTS "Public read access for artist assets" ON storage.objects;

-- Tenant-scoped upload: only members can upload to their tenant's folder
CREATE POLICY "Tenant members can upload artist assets"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'artist-assets'
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] IN (
    SELECT tenant_id::text FROM public.tenant_memberships
    WHERE user_id = auth.uid()
  )
);

-- Tenant-scoped update: only members can update their tenant's files
CREATE POLICY "Tenant members can update artist assets"
ON storage.objects FOR UPDATE
USING (
  bucket_id = 'artist-assets'
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] IN (
    SELECT tenant_id::text FROM public.tenant_memberships
    WHERE user_id = auth.uid()
  )
);

-- Tenant-scoped delete: only admins/managers can delete their tenant's files
CREATE POLICY "Tenant admins can delete artist assets"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'artist-assets'
  AND (storage.foldername(name))[1] IN (
    SELECT tm.tenant_id::text
    FROM public.tenant_memberships tm
    WHERE tm.user_id = auth.uid()
    AND tm.role IN ('company_admin', 'manager')
  )
);

-- Keep public read access for portfolio images
CREATE POLICY "Public read access for artist assets"
ON storage.objects FOR SELECT
USING (bucket_id = 'artist-assets');



============================================================
File Path: supabase/migrations/20260214145522_828b09bd-578e-4d6f-8e1d-1fef5651ba85.sql
============================================================

-- 1. 프로필에 서명 URL 추가
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS signature_url text;

-- 2. 결제라인 테이블 생성
CREATE TABLE public.approval_lines (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  step_order integer NOT NULL,
  approver_user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (tenant_id, user_id, step_order)
);

-- RLS 활성화
ALTER TABLE public.approval_lines ENABLE ROW LEVEL SECURITY;

-- 본인의 결제라인 조회
CREATE POLICY "Users can view own approval lines"
ON public.approval_lines FOR SELECT
USING (
  user_id = auth.uid()
  OR is_tenant_admin(tenant_id)
  OR is_sys_super_admin()
);

-- 본인의 결제라인 생성
CREATE POLICY "Users can create own approval lines"
ON public.approval_lines FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR is_tenant_admin(tenant_id)
  OR is_sys_super_admin()
);

-- 본인의 결제라인 수정
CREATE POLICY "Users can update own approval lines"
ON public.approval_lines FOR UPDATE
USING (
  user_id = auth.uid()
  OR is_tenant_admin(tenant_id)
  OR is_sys_super_admin()
);

-- 본인의 결제라인 삭제
CREATE POLICY "Users can delete own approval lines"
ON public.approval_lines FOR DELETE
USING (
  user_id = auth.uid()
  OR is_tenant_admin(tenant_id)
  OR is_sys_super_admin()
);

-- updated_at 트리거
CREATE TRIGGER update_approval_lines_updated_at
BEFORE UPDATE ON public.approval_lines
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260214145931_fb444a92-cb32-4b67-a380-ec07505b6270.sql
============================================================
-- Allow authenticated users to upload their own signature
CREATE POLICY "Users can upload own signature"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'artist-assets'
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] = 'signatures'
  AND (storage.foldername(name))[2] = auth.uid()::text
);

-- Allow authenticated users to update their own signature
CREATE POLICY "Users can update own signature"
ON storage.objects FOR UPDATE
USING (
  bucket_id = 'artist-assets'
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] = 'signatures'
  AND (storage.foldername(name))[2] = auth.uid()::text
);

-- Allow authenticated users to delete their own signature
CREATE POLICY "Users can delete own signature"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'artist-assets'
  AND auth.role() = 'authenticated'
  AND (storage.foldername(name))[1] = 'signatures'
  AND (storage.foldername(name))[2] = auth.uid()::text
);


============================================================
File Path: supabase/migrations/20260214150806_17124bd1-5d79-47e5-9ffb-c0e9198ef9c9.sql
============================================================

-- Add missing columns to vehicles table for the vehicle master form
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS vehicle_number text;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS model_name text;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS fuel_type text DEFAULT '휘발유';
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS initial_mileage numeric DEFAULT 0;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS usage_category text DEFAULT '비영업용승용차';
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS ownership_type text DEFAULT '리스';
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS vendor_name text;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS contract_manager text;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS contact_number text;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS monthly_fee numeric DEFAULT 0;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS payment_day integer DEFAULT 1;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS payment_method text DEFAULT '카드 결제';
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS primary_driver uuid REFERENCES public.profiles(id);
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS requires_log boolean DEFAULT false;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS insurance_start_date date;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS insurance_end_date date;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS insurance_driver_age text DEFAULT '만 26세 이상';
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS contract_start_date date;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS contract_end_date date;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS annual_contract_mileage integer DEFAULT 20000;
ALTER TABLE public.vehicles ADD COLUMN IF NOT EXISTS excess_mileage_fee numeric DEFAULT 0;

-- Make plate_number nullable since the form uses vehicle_number instead
ALTER TABLE public.vehicles ALTER COLUMN plate_number DROP NOT NULL;
ALTER TABLE public.vehicles ALTER COLUMN plate_number SET DEFAULT '';



============================================================
File Path: supabase/migrations/20260216031708_48cc44b2-69f5-4e80-a4c4-c831e4434e58.sql
============================================================

-- Add is_suspended column to tenant_memberships
ALTER TABLE public.tenant_memberships
ADD COLUMN is_suspended boolean NOT NULL DEFAULT false;

-- Add suspended_at timestamp
ALTER TABLE public.tenant_memberships
ADD COLUMN suspended_at timestamp with time zone DEFAULT NULL;

-- Add suspended_by (who suspended)
ALTER TABLE public.tenant_memberships
ADD COLUMN suspended_by uuid DEFAULT NULL;

-- Add suspension_reason
ALTER TABLE public.tenant_memberships
ADD COLUMN suspension_reason text DEFAULT NULL;



============================================================
File Path: supabase/migrations/20260216041530_9054082f-5a88-454c-bc4a-f359546c77cc.sql
============================================================

-- 직원 온보딩 상세 정보 테이블
CREATE TABLE public.employee_details (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.profiles(id),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id),
  hire_date DATE,
  resignation_date DATE,
  resident_number TEXT,
  is_foreigner TEXT DEFAULT '내국인',
  nationality TEXT DEFAULT '대한민국',
  address TEXT,
  phone_mobile TEXT,
  phone_tel TEXT,
  email TEXT,
  bank_name TEXT,
  account_number TEXT,
  account_holder TEXT,
  emergency_contacts JSONB DEFAULT '[]'::jsonb,
  id_card_url TEXT,
  bankbook_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(user_id, tenant_id)
);

-- RLS 활성화
ALTER TABLE public.employee_details ENABLE ROW LEVEL SECURITY;

-- 본인 또는 테넌트 관리자가 조회 가능
CREATE POLICY "Users can view own details"
  ON public.employee_details FOR SELECT
  USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 본인이 등록 가능
CREATE POLICY "Users can insert own details"
  ON public.employee_details FOR INSERT
  WITH CHECK (user_id = auth.uid() AND is_tenant_member(tenant_id));

-- 본인 또는 관리자가 수정 가능
CREATE POLICY "Users can update own details"
  ON public.employee_details FOR UPDATE
  USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 관리자만 삭제 가능
CREATE POLICY "Admins can delete details"
  ON public.employee_details FOR DELETE
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 파트너사 HR 스코프로 열람 가능
CREATE POLICY "Partners with hr scope can view"
  ON public.employee_details FOR SELECT
  USING (user_has_partner_hr_scope(tenant_id));

-- 타임스탬프 트리거
CREATE TRIGGER update_employee_details_updated_at
  BEFORE UPDATE ON public.employee_details
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260216133619_ef820ebc-cf82-48a8-ad1b-710227701231.sql
============================================================

-- Create a SECURITY DEFINER function so employees can update their own job_title/department during onboarding
CREATE OR REPLACE FUNCTION public.complete_onboarding(
  _tenant_id uuid,
  _department text,
  _job_title text
) RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
BEGIN
  -- Only allow updating own membership
  IF auth.uid() IS NULL THEN
    RAISE EXCEPTION 'Not authenticated';
  END IF;

  -- Verify user is a member of this tenant
  IF NOT EXISTS (
    SELECT 1 FROM public.tenant_memberships 
    WHERE user_id = auth.uid() AND tenant_id = _tenant_id
  ) THEN
    RAISE EXCEPTION 'Not a member of this tenant';
  END IF;

  UPDATE public.tenant_memberships
  SET department = _department, 
      job_title = _job_title, 
      updated_at = now()
  WHERE user_id = auth.uid() AND tenant_id = _tenant_id;
END;
$$;



============================================================
File Path: supabase/migrations/20260216134331_0d43d4b4-5e01-4160-8683-c333f5fce05b.sql
============================================================

-- 출퇴근지 정보 테이블
CREATE TABLE public.commute_locations (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.profiles(id),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id),
  home_address text,
  home_lat numeric,
  home_lng numeric,
  office_address text,
  office_lat numeric,
  office_lng numeric,
  distance_km numeric DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  UNIQUE(user_id, tenant_id)
);

ALTER TABLE public.commute_locations ENABLE ROW LEVEL SECURITY;

-- 본인 데이터 조회
CREATE POLICY "Users can view own commute locations"
ON public.commute_locations FOR SELECT
USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 본인 데이터 생성
CREATE POLICY "Users can insert own commute locations"
ON public.commute_locations FOR INSERT
WITH CHECK (user_id = auth.uid() AND is_tenant_member(tenant_id));

-- 본인 데이터 수정
CREATE POLICY "Users can update own commute locations"
ON public.commute_locations FOR UPDATE
USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 관리자 삭제
CREATE POLICY "Admins can delete commute locations"
ON public.commute_locations FOR DELETE
USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- updated_at 트리거
CREATE TRIGGER update_commute_locations_updated_at
BEFORE UPDATE ON public.commute_locations
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260216134847_58f3f830-15f2-4013-bc75-c0a3f047b3ac.sql
============================================================

-- 근로규칙 테이블 (tenant_id가 NULL이면 시스템 기본값)
CREATE TABLE public.work_rules (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid REFERENCES public.tenants(id),
  name text NOT NULL,
  -- 소정근로요일
  work_days text[] NOT NULL DEFAULT '{월,화,수,목,금}',
  -- 소정근로규칙
  standard_work_unit text NOT NULL DEFAULT '1주',
  standard_work_hours numeric NOT NULL DEFAULT 40,
  overtime_min_unit text NOT NULL DEFAULT '1주',
  overtime_min_hours numeric NOT NULL DEFAULT 0,
  overtime_max_unit text NOT NULL DEFAULT '1주',
  overtime_max_hours numeric NOT NULL DEFAULT 12,
  standard_period text NOT NULL DEFAULT '1주',
  standard_period_start_day integer DEFAULT 1,
  standard_include_holidays boolean NOT NULL DEFAULT false,
  -- 최대근로규칙
  max_work_unit text NOT NULL DEFAULT '1주',
  max_work_hours numeric NOT NULL DEFAULT 52,
  max_period text NOT NULL DEFAULT '1주',
  max_period_start_day integer DEFAULT 1,
  max_include_holidays boolean NOT NULL DEFAULT false,
  -- 메타
  is_default boolean NOT NULL DEFAULT false,
  is_active boolean NOT NULL DEFAULT true,
  description text,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now()
);

ALTER TABLE public.work_rules ENABLE ROW LEVEL SECURITY;

-- 슈퍼어드민: 시스템 기본 규칙(tenant_id IS NULL) 전체 관리
CREATE POLICY "Super admins can manage system work rules"
ON public.work_rules FOR ALL
USING (is_sys_super_admin());

-- 테넌트 관리자: 자기 테넌트 규칙 관리
CREATE POLICY "Tenant admins can manage tenant work rules"
ON public.work_rules FOR ALL
USING (tenant_id IS NOT NULL AND (is_tenant_admin(tenant_id) OR is_sys_super_admin()));

-- 테넌트 멤버: 자기 테넌트 규칙 조회
CREATE POLICY "Tenant members can view work rules"
ON public.work_rules FOR SELECT
USING (tenant_id IS NOT NULL AND is_tenant_member(tenant_id));

-- 모든 인증 사용자: 시스템 기본값 조회
CREATE POLICY "Authenticated users can view system defaults"
ON public.work_rules FOR SELECT
USING (tenant_id IS NULL AND auth.uid() IS NOT NULL);

-- updated_at 트리거
CREATE TRIGGER update_work_rules_updated_at
BEFORE UPDATE ON public.work_rules
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260216170454_47d07771-bbe3-4345-81a1-28e7e6267f8e.sql
============================================================

-- 1. 출퇴근 기록 테이블
CREATE TABLE public.attendance_records (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL,
  tenant_id uuid NOT NULL,
  date date NOT NULL DEFAULT CURRENT_DATE,
  clock_in timestamp with time zone,
  clock_out timestamp with time zone,
  clock_in_method text NOT NULL DEFAULT 'manual',
  clock_out_method text NOT NULL DEFAULT 'manual',
  memo text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  UNIQUE(user_id, tenant_id, date)
);

ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own attendance"
  ON public.attendance_records FOR SELECT
  USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Users can insert own attendance"
  ON public.attendance_records FOR INSERT
  WITH CHECK (user_id = auth.uid() AND is_tenant_member(tenant_id));

CREATE POLICY "Users can update own attendance"
  ON public.attendance_records FOR UPDATE
  USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Admins can delete attendance"
  ON public.attendance_records FOR DELETE
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE TRIGGER update_attendance_records_updated_at
  BEFORE UPDATE ON public.attendance_records
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- 2. 일정 참석자 테이블
CREATE TABLE public.schedule_participants (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  schedule_id uuid NOT NULL REFERENCES public.artist_schedules(id) ON DELETE CASCADE,
  user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  tenant_id uuid NOT NULL,
  participant_name text,
  participant_company text,
  participant_type text NOT NULL DEFAULT 'internal',
  created_at timestamp with time zone NOT NULL DEFAULT now()
);

ALTER TABLE public.schedule_participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant members can view participants"
  ON public.schedule_participants FOR SELECT
  USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can manage participants"
  ON public.schedule_participants FOR INSERT
  WITH CHECK (is_tenant_member(tenant_id));

CREATE POLICY "Tenant members can update participants"
  ON public.schedule_participants FOR UPDATE
  USING (is_tenant_member(tenant_id));

CREATE POLICY "Tenant members can delete participants"
  ON public.schedule_participants FOR DELETE
  USING (is_tenant_member(tenant_id));



============================================================
File Path: supabase/migrations/20260216171404_ffcf542b-5f9b-49af-97d0-2aee17da065d.sql
============================================================

CREATE OR REPLACE FUNCTION public.auto_clock_out()
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
DECLARE
  affected_count int := 0;
  rec RECORD;
  auto_count int := 0;
BEGIN
  -- Step 1: 일정 참석자 기반 퇴근 처리
  FOR rec IN
    SELECT DISTINCT
      sp.user_id,
      ar.tenant_id,
      ar.id AS attendance_id,
      MAX(s.end_time) AS latest_end
    FROM public.attendance_records ar
    JOIN public.schedule_participants sp ON sp.user_id = ar.user_id AND sp.tenant_id = ar.tenant_id
    JOIN public.artist_schedules s ON s.id = sp.schedule_id
    WHERE ar.date = CURRENT_DATE
      AND ar.clock_in IS NOT NULL
      AND ar.clock_out IS NULL
      AND s.end_time::date = CURRENT_DATE
      AND s.end_time <= now()
      AND sp.user_id IS NOT NULL
    GROUP BY sp.user_id, ar.tenant_id, ar.id
  LOOP
    UPDATE public.attendance_records
    SET clock_out = rec.latest_end,
        clock_out_method = 'schedule'
    WHERE id = rec.attendance_id;
    affected_count := affected_count + 1;
  END LOOP;

  -- Step 2: 18시 이후 미퇴근자 자동 퇴근 처리
  UPDATE public.attendance_records
  SET clock_out = (date || ' 18:00:00')::timestamp with time zone,
      clock_out_method = 'auto'
  WHERE date = CURRENT_DATE
    AND clock_in IS NOT NULL
    AND clock_out IS NULL
    AND now() >= (date || ' 18:00:00')::timestamp with time zone;

  GET DIAGNOSTICS auto_count = ROW_COUNT;
  affected_count := affected_count + auto_count;

  RETURN affected_count;
END;
$$;



============================================================
File Path: supabase/migrations/20260216171545_6547e09c-a42b-4a63-beed-ce60f3d9419e.sql
============================================================

-- pg_cron, pg_net 확장 활성화
CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA pg_catalog;
CREATE EXTENSION IF NOT EXISTS pg_net WITH SCHEMA extensions;



============================================================
File Path: supabase/migrations/20260217040512_7db5a3c1-c839-4d97-b785-c4e65bdde223.sql
============================================================

-- 주간 근무시간 계산 함수
CREATE OR REPLACE FUNCTION public.get_weekly_work_hours(
  _user_id uuid,
  _tenant_id uuid,
  _week_start date
)
RETURNS numeric
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path TO 'public'
AS $$
  SELECT COALESCE(
    SUM(
      EXTRACT(EPOCH FROM (clock_out - clock_in)) / 3600.0
    ), 0
  )::numeric
  FROM public.attendance_records
  WHERE user_id = _user_id
    AND tenant_id = _tenant_id
    AND date >= _week_start
    AND date < _week_start + 7
    AND clock_in IS NOT NULL
    AND clock_out IS NOT NULL;
$$;

-- 월간 근무시간 상세 데이터 함수
CREATE OR REPLACE FUNCTION public.get_monthly_work_hours(
  _user_id uuid,
  _tenant_id uuid,
  _year int,
  _month int
)
RETURNS TABLE(
  work_date date,
  hours_worked numeric,
  clock_in_time timestamptz,
  clock_out_time timestamptz,
  clock_out_method text
)
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path TO 'public'
AS $$
  SELECT
    ar.date AS work_date,
    COALESCE(EXTRACT(EPOCH FROM (ar.clock_out - ar.clock_in)) / 3600.0, 0)::numeric AS hours_worked,
    ar.clock_in AS clock_in_time,
    ar.clock_out AS clock_out_time,
    ar.clock_out_method
  FROM public.attendance_records ar
  WHERE ar.user_id = _user_id
    AND ar.tenant_id = _tenant_id
    AND EXTRACT(YEAR FROM ar.date) = _year
    AND EXTRACT(MONTH FROM ar.date) = _month
    AND ar.clock_in IS NOT NULL
  ORDER BY ar.date ASC;
$$;



============================================================
File Path: supabase/migrations/20260217042100_8043a5c6-4ae5-487e-b107-b3d49edd14c7.sql
============================================================

-- departments 테이블: tenant_id를 nullable로 변경 (시스템 기본값용)
ALTER TABLE public.departments ALTER COLUMN tenant_id DROP NOT NULL;

-- job_titles 테이블: tenant_id를 nullable로 변경 (시스템 기본값용)
ALTER TABLE public.job_titles ALTER COLUMN tenant_id DROP NOT NULL;

-- departments: 시스템 기본값 조회 정책 (모든 인증 사용자)
CREATE POLICY "Authenticated users can view system default departments"
ON public.departments FOR SELECT
USING (tenant_id IS NULL AND auth.uid() IS NOT NULL);

-- departments: 슈퍼어드민 시스템 기본값 관리 정책
CREATE POLICY "Super admins can manage system default departments"
ON public.departments FOR ALL
USING (is_sys_super_admin());

-- job_titles: 시스템 기본값 조회 정책 (모든 인증 사용자)
CREATE POLICY "Authenticated users can view system default job_titles"
ON public.job_titles FOR SELECT
USING (tenant_id IS NULL AND auth.uid() IS NOT NULL);

-- job_titles: 슈퍼어드민 시스템 기본값 관리 정책
CREATE POLICY "Super admins can manage system default job_titles"
ON public.job_titles FOR ALL
USING (is_sys_super_admin());



============================================================
File Path: supabase/migrations/20260217045624_f041f3a6-3013-4612-ab78-29ef3c290d81.sql
============================================================

-- 1. 휴가 그룹 (연차, 보상휴가 등 그룹)
CREATE TABLE public.leave_groups (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  overdraft_limit numeric DEFAULT NULL, -- NULL=제한없음, 0=초과불가, N=N일까지 마이너스 허용
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.leave_groups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant admins can manage leave_groups" ON public.leave_groups
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can view leave_groups" ON public.leave_groups
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

-- 2. 휴가 유형 (연차, 반차, 병가, 출산휴가 등)
CREATE TABLE public.leave_types (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  group_id uuid REFERENCES public.leave_groups(id) ON DELETE SET NULL,
  name text NOT NULL,
  display_name text, -- 다른 직원에게 보이는 이름
  time_option text NOT NULL DEFAULT 'full_day', -- 'full_day' | 'time_input'
  paid_hours numeric DEFAULT 8, -- 유급시간
  deduction_days numeric DEFAULT 1, -- 차감 일수
  special_option text DEFAULT 'none', -- 'none' | 'long_term' | 'day_off' | 'holiday'
  min_consecutive_days integer DEFAULT 1,
  max_consecutive_days integer,
  include_holidays_in_consecutive boolean DEFAULT false,
  is_paid boolean DEFAULT true,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.leave_types ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant admins can manage leave_types" ON public.leave_types
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can view leave_types" ON public.leave_types
  FOR SELECT USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

-- 3. 휴가 잔여일수 (발생 건 단위)
CREATE TABLE public.leave_balances (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  group_id uuid REFERENCES public.leave_groups(id) ON DELETE SET NULL,
  total_days numeric NOT NULL DEFAULT 0, -- 총 발생일수
  used_days numeric NOT NULL DEFAULT 0, -- 사용일수
  generation_type text NOT NULL DEFAULT 'manual', -- 'manual' | 'auto_annual' | 'compensatory'
  memo text,
  valid_from date NOT NULL DEFAULT CURRENT_DATE,
  valid_until date, -- NULL=무제한
  created_by uuid,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.leave_balances ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admins can manage leave_balances" ON public.leave_balances
  FOR ALL USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Users can view own leave_balances" ON public.leave_balances
  FOR SELECT USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 4. 휴가 신청 (결재 워크플로우 포함)
CREATE TABLE public.leave_requests (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  leave_type_id uuid NOT NULL REFERENCES public.leave_types(id) ON DELETE RESTRICT,
  start_date date NOT NULL,
  end_date date NOT NULL,
  start_time time, -- 시간 입력 휴가용
  end_time time,
  total_days numeric NOT NULL DEFAULT 1, -- 실제 차감일수
  reason text,
  status text NOT NULL DEFAULT 'pending', -- 'pending' | 'approved' | 'rejected' | 'cancelled'
  approved_by uuid,
  approved_at timestamptz,
  reject_reason text,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.leave_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can create own leave_requests" ON public.leave_requests
  FOR INSERT WITH CHECK (user_id = auth.uid() AND is_tenant_member(tenant_id));

CREATE POLICY "Users can view own leave_requests" ON public.leave_requests
  FOR SELECT USING (user_id = auth.uid() OR is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Users can update own pending requests" ON public.leave_requests
  FOR UPDATE USING (
    (user_id = auth.uid() AND status = 'pending') 
    OR is_tenant_admin(tenant_id) 
    OR is_sys_super_admin()
  );

CREATE POLICY "Admins can delete leave_requests" ON public.leave_requests
  FOR DELETE USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- 5. 한국 근로기준법 연차 자동계산 함수
CREATE OR REPLACE FUNCTION public.calculate_annual_leave_days(_hire_date date, _reference_date date DEFAULT CURRENT_DATE)
RETURNS numeric
LANGUAGE plpgsql
STABLE
SECURITY DEFINER
SET search_path TO 'public'
AS $$
DECLARE
  _months_worked integer;
  _years_worked integer;
  _total_days numeric := 0;
BEGIN
  IF _hire_date IS NULL OR _reference_date < _hire_date THEN
    RETURN 0;
  END IF;

  _months_worked := (EXTRACT(YEAR FROM age(_reference_date, _hire_date)) * 12 
                     + EXTRACT(MONTH FROM age(_reference_date, _hire_date)))::integer;
  _years_worked := EXTRACT(YEAR FROM age(_reference_date, _hire_date))::integer;

  IF _years_worked < 1 THEN
    -- 1년 미만: 1개월 개근 시 1일 (최대 11일)
    _total_days := LEAST(_months_worked, 11);
  ELSE
    -- 1년 이상: 15일 기본 + 2년마다 1일 추가 (최대 25일)
    _total_days := LEAST(15 + GREATEST(0, (_years_worked - 1) / 2), 25);
  END IF;

  RETURN _total_days;
END;
$$;

-- Triggers
CREATE TRIGGER update_leave_groups_updated_at BEFORE UPDATE ON public.leave_groups
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_leave_types_updated_at BEFORE UPDATE ON public.leave_types
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_leave_balances_updated_at BEFORE UPDATE ON public.leave_balances
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_leave_requests_updated_at BEFORE UPDATE ON public.leave_requests
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260217050725_7198530d-b474-4e2e-a42f-5ea0373fad8e.sql
============================================================
-- Update RLS policies for leave_groups to allow reading system defaults (tenant_id IS NULL)
DROP POLICY IF EXISTS "Tenant members can view leave_groups" ON public.leave_groups;
CREATE POLICY "Tenant members can view leave_groups" ON public.leave_groups
  FOR SELECT USING (
    tenant_id IS NULL  -- system defaults readable by all authenticated users
    OR is_tenant_member(tenant_id)
    OR is_sys_super_admin()
  );

-- Super admins can manage system defaults (tenant_id IS NULL)
DROP POLICY IF EXISTS "Tenant admins can manage leave_groups" ON public.leave_groups;
CREATE POLICY "Tenant admins can manage leave_groups" ON public.leave_groups
  FOR ALL USING (
    (tenant_id IS NULL AND is_sys_super_admin())
    OR is_tenant_admin(tenant_id)
    OR is_sys_super_admin()
  );

-- Same for leave_types
DROP POLICY IF EXISTS "Tenant members can view leave_types" ON public.leave_types;
CREATE POLICY "Tenant members can view leave_types" ON public.leave_types
  FOR SELECT USING (
    tenant_id IS NULL
    OR is_tenant_member(tenant_id)
    OR is_sys_super_admin()
  );

DROP POLICY IF EXISTS "Tenant admins can manage leave_types" ON public.leave_types;
CREATE POLICY "Tenant admins can manage leave_types" ON public.leave_types
  FOR ALL USING (
    (tenant_id IS NULL AND is_sys_super_admin())
    OR is_tenant_admin(tenant_id)
    OR is_sys_super_admin()
  );


============================================================
File Path: supabase/migrations/20260217050754_12239454-7a4e-4355-95c6-f760850ff507.sql
============================================================
-- Allow tenant_id to be NULL for system defaults in leave_groups and leave_types
ALTER TABLE public.leave_groups ALTER COLUMN tenant_id DROP NOT NULL;
ALTER TABLE public.leave_types ALTER COLUMN tenant_id DROP NOT NULL;


============================================================
File Path: supabase/migrations/20260217061329_d9f15d90-3950-42a6-9250-2e1c6d9a4c8b.sql
============================================================

-- 사용자별 메일 연동 설정 테이블
CREATE TABLE public.user_mail_configs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.profiles(id),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id),
  provider TEXT NOT NULL CHECK (provider IN ('gmail', 'naverworks')),
  
  -- Gmail OAuth fields
  google_access_token TEXT,
  google_refresh_token TEXT,
  google_token_expiry TIMESTAMP WITH TIME ZONE,
  google_email TEXT,
  
  -- NaverWorks API key fields
  nw_client_id TEXT,
  nw_client_secret TEXT,
  nw_service_account TEXT,
  nw_private_key TEXT,
  nw_domain_id TEXT,
  nw_user_id TEXT,
  
  is_active BOOLEAN NOT NULL DEFAULT true,
  last_synced_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  
  UNIQUE(user_id, tenant_id, provider)
);

-- Enable RLS
ALTER TABLE public.user_mail_configs ENABLE ROW LEVEL SECURITY;

-- Users can only manage their own mail configs
CREATE POLICY "Users can view own mail configs"
  ON public.user_mail_configs FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can insert own mail configs"
  ON public.user_mail_configs FOR INSERT
  WITH CHECK (user_id = auth.uid() AND is_tenant_member(tenant_id));

CREATE POLICY "Users can update own mail configs"
  ON public.user_mail_configs FOR UPDATE
  USING (user_id = auth.uid());

CREATE POLICY "Users can delete own mail configs"
  ON public.user_mail_configs FOR DELETE
  USING (user_id = auth.uid());

-- Trigger for updated_at
CREATE TRIGGER update_user_mail_configs_updated_at
  BEFORE UPDATE ON public.user_mail_configs
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260217111300_c78acec4-7798-480c-8a96-c2163c21e5b1.sql
============================================================

-- Add new columns to corporate_cards
ALTER TABLE public.corporate_cards
  ADD COLUMN IF NOT EXISTS card_type text DEFAULT '일반',
  ADD COLUMN IF NOT EXISTS card_holder_name text,
  ADD COLUMN IF NOT EXISTS is_skypass boolean DEFAULT false,
  ADD COLUMN IF NOT EXISTS cvc text,
  ADD COLUMN IF NOT EXISTS card_image_url text;

-- Add comment for clarity
COMMENT ON COLUMN public.corporate_cards.card_type IS '카드 종류: 일반, 하이패스, 클린카드';
COMMENT ON COLUMN public.corporate_cards.card_holder_name IS '실제 카드 명의자';
COMMENT ON COLUMN public.corporate_cards.is_skypass IS '스카이패스 적립 여부';
COMMENT ON COLUMN public.corporate_cards.cvc IS 'CVC 번호';
COMMENT ON COLUMN public.corporate_cards.card_image_url IS '카드 이미지 URL';



============================================================
File Path: supabase/migrations/20260217163243_346fb583-78f9-4f24-8a6b-c2016147fd0a.sql
============================================================

-- 은행 계좌 및 카드 계정 정보를 저장하는 테이블
CREATE TABLE public.finance_accounts (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  connected_id_key TEXT NOT NULL, -- tenant_api_configs의 config_key (예: CONNECTED_ID_BK_0004)
  business_type TEXT NOT NULL CHECK (business_type IN ('BK', 'CD')), -- BK: 은행, CD: 카드
  organization TEXT NOT NULL, -- 기관코드
  account_number TEXT, -- 계좌번호 (은행) 또는 카드번호 (카드), 비워두면 전체
  account_alias TEXT, -- 별칭 (예: "급여통장", "운영자금")
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

ALTER TABLE public.finance_accounts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant admins can manage finance_accounts"
  ON public.finance_accounts FOR ALL
  USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

CREATE POLICY "Tenant members can view finance_accounts"
  ON public.finance_accounts FOR SELECT
  USING (is_tenant_member(tenant_id) OR is_sys_super_admin());



============================================================
File Path: supabase/migrations/20260217170331_c53229ac-8304-4e8e-ae43-02cec1b8b5cb.sql
============================================================

-- 기능별 Google Drive 폴더 매핑 테이블
CREATE TABLE public.drive_folder_mappings (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  folder_key TEXT NOT NULL,          -- 예: 'bank_transactions', 'card_receipts', 'hr_documents'
  folder_id TEXT NOT NULL,           -- Google Drive 폴더 ID
  folder_name TEXT,                  -- 표시용 폴더 이름
  folder_path TEXT,                  -- 표시용 경로 (예: '재무/은행내역')
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  UNIQUE(tenant_id, folder_key)
);

-- Enable RLS
ALTER TABLE public.drive_folder_mappings ENABLE ROW LEVEL SECURITY;

-- Tenant admins can manage
CREATE POLICY "Tenant admins can manage drive_folder_mappings"
ON public.drive_folder_mappings
FOR ALL
USING (is_tenant_admin(tenant_id) OR is_sys_super_admin());

-- Tenant members can view
CREATE POLICY "Tenant members can view drive_folder_mappings"
ON public.drive_folder_mappings
FOR SELECT
USING (is_tenant_member(tenant_id) OR is_sys_super_admin());

-- Trigger for updated_at
CREATE TRIGGER update_drive_folder_mappings_updated_at
BEFORE UPDATE ON public.drive_folder_mappings
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();



============================================================
File Path: supabase/migrations/20260218113617_52ecfeb2-95fb-45bb-bdbf-f9bb07c5de63.sql
============================================================
-- Make artist-assets bucket private to prevent unauthenticated access
UPDATE storage.buckets 
SET public = false 
WHERE id = 'artist-assets';


============================================================
File Path: src/App.css
============================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}



============================================================
File Path: src/App.tsx
============================================================
import { Toaster } from "@/components/ui/toaster";
import { Toaster as Sonner } from "@/components/ui/sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import { AuthProvider } from "@/hooks/useAuth";
import { ProtectedLayout } from "@/components/ProtectedLayout";

// 페이지 임포트
import InternalMail from "./pages/admin/InternalMail";
import LeaveRequest from "./pages/LeaveRequest";
import MailSettings from "./pages/admin/MailSettings";
import MyCardExpenses from "./pages/finance/MyCardExpenses";
import BankTransactions from "./pages/finance/BankTransactions";
import CardHistory from "./pages/finance/CardHistory";
import FinanceSettings from "./pages/admin/FinanceSettings"; // [추가]

// 공개 페이지
import Index from "./pages/Index";
import Auth from "./pages/Auth";
import GuestForm from "./pages/GuestForm";
import GmailOAuthCallback from "./pages/GmailOAuthCallback";
import NotFound from "./pages/NotFound";

// 일반 사용자 경로
import Dashboard from "./pages/Dashboard";
import ProfileManagement from "./pages/ProfileManagement";
import ArtistPortfolio from "./pages/ArtistPortfolio";
import Onboarding from "./pages/Onboarding";
import MyPage from "./pages/MyPage";
import AppModule from "./pages/AppModule";

// 본사 관리자 (Admin) 페이지
import AdminSystem from "./pages/AdminSystem";
import CompanyManagement from "./pages/admin/CompanyManagement";
import HRManagement from "./pages/admin/HRManagement";
import MemberDetail from "./pages/admin/MemberDetail";
import ArtistManagement from "./pages/admin/ArtistManagement";
import CorporateCardManagement from "./pages/admin/CorporateCardManagement";
import VehicleManagement from "./pages/admin/VehicleManagement";
import OrgManagement from "./pages/admin/OrgManagement";
import ProjectManagement from "./pages/admin/ProjectManagement";
import DrivingControl from "./pages/admin/DrivingControl";
import KeywordManagement from "./pages/admin/KeywordManagement";
import MediaPitching from "./pages/admin/MediaPitching";
import TenantAPISettings from "./pages/admin/TenantAPISettings";
import DriveSettings from "./pages/admin/DriveSettings";
import PartnershipManagement from "./pages/admin/PartnershipManagement";
import PartnerDataView from "./pages/admin/PartnerDataView";
import ScheduleManagement from "./pages/admin/ScheduleManagement";
import WorkRuleManagement from "./pages/admin/WorkRuleManagement";
import AttendanceManagement from "./pages/admin/AttendanceManagement";

// 슈퍼 어드민 (Super Admin) 페이지
import SuperAdmin from "./pages/SuperAdmin";
import TenantRegistration from "./pages/TenantRegistration";
import MessageManagement from "./pages/SuperAdmin/MessageManagement";
import PressContacts from "./pages/SuperAdmin/PressContacts";
import APIManagement from "./pages/SuperAdmin/APIManagement";
import WorkRuleDefaults from "./pages/SuperAdmin/WorkRuleDefaults";

const queryClient = new QueryClient();

const App = () => (
  <QueryClientProvider client={queryClient}>
    <AuthProvider>
      <TooltipProvider>
        <Toaster />
        <Sonner position="top-center" />
        <BrowserRouter>
          <Routes>
            {/* 1. 공개 경로 */}
            <Route path="/" element={<Index />} />
            <Route path="/auth" element={<Auth />} />
            <Route path="/auth/gmail/callback" element={<GmailOAuthCallback />} />
            <Route path="/guest-form" element={<GuestForm />} />

            {/* 2. 사이드바 레이아웃이 적용되는 인증 경로 */}
            <Route element={<ProtectedLayout />}>
              <Route path="/dashboard" element={<Dashboard />} />
              <Route path="/profiles" element={<ProfileManagement />} />
              <Route path="/leave-request" element={<LeaveRequest />} />
              <Route path="/portfolio/:id" element={<ArtistPortfolio />} />
              <Route path="/onboarding" element={<Onboarding />} />
              <Route path="/my-page" element={<MyPage />} />
              <Route path="/apps/:category" element={<AppModule />} />
              {/* 재무 앱 경로 */}
              <Route path="/apps/finance/cards" element={<MyCardExpenses />} />
              <Route path="/apps/finance/transactions" element={<BankTransactions />} />
              <Route path="/apps/finance/card-history" element={<CardHistory />} />
              {/* 본사 관리 시스템 (Admin) */}
              <Route path="/admin" element={<AdminSystem />} />
              <Route path="/admin/company" element={<CompanyManagement />} />
              <Route path="/admin/hr" element={<HRManagement />} />
              <Route path="/admin/hr/:id" element={<MemberDetail />} />
              <Route path="/admin/artists" element={<ArtistManagement />} />
              <Route path="/admin/cards" element={<CorporateCardManagement />} />
              <Route path="/admin/vehicles" element={<VehicleManagement />} />
              <Route path="/admin/org-chart" element={<OrgManagement />} />
              <Route path="/admin/projects" element={<ProjectManagement />} />
              <Route path="/admin/driving" element={<DrivingControl />} />
              <Route path="/admin/keywords" element={<KeywordManagement />} />
              <Route path="/admin/mail" element={<InternalMail />} />
              <Route path="/admin/media-pitching" element={<MediaPitching />} />
              <Route path="/admin/api-settings" element={<TenantAPISettings />} />
              <Route path="/admin/drive-settings" element={<DriveSettings />} />
              <Route path="/admin/partnerships" element={<PartnershipManagement />} />
              <Route path="/admin/partner-data" element={<PartnerDataView />} />
              <Route path="/admin/schedules" element={<ScheduleManagement />} />
              <Route path="/admin/work-rules" element={<WorkRuleManagement />} />
              <Route path="/admin/attendance" element={<AttendanceManagement />} />
              <Route path="/admin/mail-settings" element={<MailSettings />} />
              <Route path="/admin/finance-settings" element={<FinanceSettings />} /> {/* [금융 연동 설정 추가] */}
            </Route>

            {/* 3. 슈퍼 어드민 경로 (사이드바 포함) */}
            <Route element={<ProtectedLayout requireSuperAdmin />}>
              <Route path="/super-admin" element={<SuperAdmin />} />
              <Route path="/super-admin/tenants/new" element={<TenantRegistration />} />
              <Route path="/super-admin/tenants/edit/:id" element={<TenantRegistration />} />
              <Route path="/super-admin/api-management" element={<APIManagement />} />
              <Route path="/super-admin/messages" element={<MessageManagement />} />
              <Route path="/super-admin/press-contacts" element={<PressContacts />} />
              <Route path="/super-admin/work-rules" element={<WorkRuleDefaults />} />
            </Route>

            {/* 4. 404 페이지 */}
            <Route path="*" element={<NotFound />} />
          </Routes>
        </BrowserRouter>
      </TooltipProvider>
    </AuthProvider>
  </QueryClientProvider>
);

export default App;



============================================================
File Path: src/index.css
============================================================
/* 가장 세련된 한글/영문 가변 폰트 Pretendard 임포트 */
@import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 210 40% 98%;
    --foreground: 222 47% 11%;

    --card: 0 0% 100%;
    --card-foreground: 222 47% 11%;

    --popover: 0 0% 100%;
    --popover-foreground: 222 47% 11%;

    --primary: 217 91% 55%;
    --primary-foreground: 0 0% 100%;

    --secondary: 214 32% 94%;
    --secondary-foreground: 222 47% 11%;

    --muted: 214 32% 91%;
    --muted-foreground: 215 16% 47%;

    --accent: 262 83% 58%;
    --accent-foreground: 0 0% 100%;

    --destructive: 0 72% 51%;
    --destructive-foreground: 0 0% 100%;

    --success: 142 76% 36%;
    --success-foreground: 0 0% 100%;

    --warning: 38 92% 50%;
    --warning-foreground: 222 47% 11%;

    --border: 214 32% 88%;
    --input: 214 32% 91%;
    --ring: 217 91% 55%;

    --radius: 0.75rem;

    /* Custom Boteda tokens - Light theme */
    --gradient-primary: linear-gradient(135deg, hsl(217 91% 55%) 0%, hsl(262 83% 58%) 100%);
    --gradient-surface: linear-gradient(180deg, hsl(210 40% 98%) 0%, hsl(214 32% 96%) 100%);
    --gradient-glow: radial-gradient(ellipse at center, hsl(217 91% 55% / 0.08) 0%, transparent 70%);
    
    --glass-bg: hsl(0 0% 100% / 0.9);
    --glass-border: hsl(214 32% 88% / 0.8);
    
    --shadow-glow: 0 0 60px -12px hsl(217 91% 55% / 0.2);
    --shadow-card: 0 4px 24px -4px hsl(222 47% 11% / 0.08);
    --shadow-elevated: 0 20px 60px -15px hsl(222 47% 11% / 0.12);

    --sidebar-background: 0 0% 100%;
    --sidebar-foreground: 222 47% 11%;
    --sidebar-primary: 217 91% 55%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 214 32% 94%;
    --sidebar-accent-foreground: 222 47% 11%;
    --sidebar-border: 214 32% 88%;
    --sidebar-ring: 217 91% 55%;
  }

  .dark {
    --background: 222 47% 6%;
    --foreground: 210 40% 98%;

    --card: 222 47% 8%;
    --card-foreground: 210 40% 98%;

    --popover: 222 47% 8%;
    --popover-foreground: 210 40% 98%;

    --primary: 217 91% 55%;
    --primary-foreground: 0 0% 100%;

    --secondary: 222 30% 15%;
    --secondary-foreground: 210 40% 98%;

    --muted: 222 30% 12%;
    --muted-foreground: 215 20% 55%;

    --accent: 262 83% 65%;
    --accent-foreground: 210 40% 98%;

    --destructive: 0 72% 51%;
    --destructive-foreground: 210 40% 98%;

    --success: 142 76% 45%;
    --success-foreground: 210 40% 98%;

    --warning: 38 92% 50%;
    --warning-foreground: 222 47% 6%;

    --border: 222 30% 18%;
    --input: 222 30% 15%;
    --ring: 217 91% 55%;

    --glass-bg: hsl(222 47% 8% / 0.8);
    --glass-border: hsl(222 30% 20% / 0.5);
    
    --shadow-glow: 0 0 60px -12px hsl(217 91% 55% / 0.4);
    --shadow-card: 0 4px 24px -4px hsl(222 47% 4% / 0.5);
    --shadow-elevated: 0 20px 60px -15px hsl(222 47% 4% / 0.7);

    --sidebar-background: 222 47% 7%;
    --sidebar-foreground: 210 40% 85%;
    --sidebar-primary: 217 91% 55%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 222 30% 12%;
    --sidebar-accent-foreground: 210 40% 98%;
    --sidebar-border: 222 30% 15%;
    --sidebar-ring: 217 91% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    @apply bg-background text-foreground antialiased;
    /* 폰트 설정: 프리텐다드를 최우선으로, 없으면 시스템 폰트 사용 */
    font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
    /* 한글 가독성을 위해 자간을 살짝 조절 */
    letter-spacing: -0.02em;
  }
  
  /* 헤딩 서체 강조 */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold tracking-tight;
  }
}

@layer components {
  .glass-card {
    @apply bg-card backdrop-blur-xl border border-border rounded-xl;
    box-shadow: var(--shadow-card);
  }

  .glass-card-hover {
    @apply glass-card transition-all duration-300;
  }

  .glass-card-hover:hover {
    @apply border-primary/30;
    box-shadow: var(--shadow-glow);
  }

  .gradient-text {
    @apply bg-clip-text text-transparent;
    background-image: var(--gradient-primary);
  }

  .gradient-border {
    position: relative;
  }

  .gradient-border::before {
    content: '';
    position: absolute;
    inset: 0;
    padding: 1px;
    border-radius: inherit;
    background: var(--gradient-primary);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }

  .glow-effect {
    position: relative;
  }

  .glow-effect::after {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    background: var(--gradient-primary);
    opacity: 0;
    filter: blur(20px);
    transition: opacity 0.3s ease;
    z-index: -1;
  }

  .glow-effect:hover::after {
    opacity: 0.4;
  }

  .timeline-connector {
    @apply absolute left-6 top-12 bottom-0 w-px bg-gradient-to-b from-border to-transparent;
  }

  .status-badge {
    @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
  }

  .status-pending {
    @apply bg-warning/15 text-warning border border-warning/30;
  }

  .status-approved {
    @apply bg-success/15 text-success border border-success/30;
  }

  .status-rejected {
    @apply bg-destructive/15 text-destructive border border-destructive/30;
  }

  .status-inprogress {
    @apply bg-primary/15 text-primary border border-primary/30;
  }
}

@layer utilities {
  .animate-float {
    animation: float 6s ease-in-out infinite;
  }

  .animate-pulse-slow {
    animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .animate-gradient {
    background-size: 200% 200%;
    animation: gradient 8s ease infinite;
  }

  .animate-slide-up {
    animation: slideUp 0.5s ease-out forwards;
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-20px);
  }
}

@keyframes gradient {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: hsl(var(--muted));
}

::-webkit-scrollbar-thumb {
  background: hsl(var(--border));
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: hsl(var(--muted-foreground));
}


============================================================
File Path: src/main.tsx
============================================================
import { createRoot } from "react-dom/client";
import App from "./App.tsx";
import "./index.css";

createRoot(document.getElementById("root")!).render(<App />);



============================================================
File Path: src/vite-env.d.ts
============================================================
/// <reference types="vite/client" />



============================================================
File Path: src/components/DashboardLayout.tsx
============================================================
import React, { useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Header, HeaderRenderedProvider } from "@/components/landing/Header";
import { NAV_CATEGORIES, SUB_MENUS } from "@/lib/navigation";
import { Badge } from "@/components/ui/badge";
import { 
  ChevronRight, Home, Mail, Car, Calendar, FileText, ClipboardCheck, Layers, Sparkles 
} from "lucide-react"; 
import { cn } from "@/lib/utils";

interface DashboardLayoutProps {
  children: React.ReactNode;
}

export const DashboardLayout = ({ children }: DashboardLayoutProps) => {
  const navigate = useNavigate();
  const location = useLocation();
  
  // Auto-detect category from URL
  const detectCategory = () => {
    const path = location.pathname;
    if (path.startsWith("/apps/")) return path.split("/")[2] || "management";
    if (path.startsWith("/admin/media-pitching") || path === "/profiles") return "pr";
    if (path.startsWith("/admin/driving")) return "finance";
    if (path.startsWith("/admin/schedules")) return "common";
    if (path.startsWith("/admin/hr") || path.startsWith("/admin/org") || path === "/my-page" || path.startsWith("/admin/attendance")) return "hr";
    if (path.startsWith("/admin/cards") || path.startsWith("/admin/vehicles")) return "finance";
    if (path.startsWith("/admin/keywords")) return "pr";
    return "management";
  };
  
  const [activeCategory, setActiveCategory] = useState(detectCategory);
  const [isMenuVisible, setIsMenuVisible] = useState(false);

  const currentCategoryInfo = NAV_CATEGORIES.find(c => c.id === activeCategory);
  const subMenuItems = SUB_MENUS[activeCategory] || [];

  return (
    <div className="min-h-screen bg-white flex flex-col overflow-hidden">
      {/* 1. 헤더 영역 (최상위) */}
      <div className="z-[60] shrink-0">
        <Header />
      </div>
      
      {/* 2. 메인 바디 영역 */}
      <main className="flex-1 flex relative h-[calc(100vh-64px)] mt-16">
        
        {/* 사이드바 컨테이너 */}
        <div 
          className="flex h-full z-40 shrink-0"
          onMouseLeave={() => setIsMenuVisible(false)}
        >
          {/* Tier 1: 최좌측 아이콘 바 (항상 보임) */}
          <aside 
            className="w-[70px] bg-white border-r border-slate-100 flex flex-col items-center py-6 gap-4 shrink-0 z-50 shadow-[10px_0_30px_rgba(0,0,0,0.03)]"
            onMouseEnter={() => setIsMenuVisible(true)}
          >
            <button onClick={() => navigate("/dashboard")} className="w-11 h-11 rounded-2xl flex items-center justify-center text-slate-400 hover:text-blue-600 hover:bg-blue-50 mb-2 transition-all">
              <Home className="w-5 h-5" />
            </button>
            
            {NAV_CATEGORIES.map((cat) => (
              <button
                key={cat.id}
                onMouseEnter={() => setActiveCategory(cat.id)}
                onClick={() => navigate(`/apps/${cat.id}`)}
                className={cn(
                  "w-12 h-12 rounded-2xl flex items-center justify-center transition-all duration-300 relative group",
                  activeCategory === cat.id 
                    ? `${cat.color} text-white shadow-lg shadow-current/30 scale-105` 
                    : "text-slate-400 hover:text-slate-600 hover:bg-slate-50"
                )}
              >
                {cat.icon}
                {activeCategory === cat.id && (
                  <div className="absolute -left-1 top-1/2 -translate-y-1/2 w-1.5 h-6 bg-slate-800 rounded-r-full" />
                )}
              </button>
            ))}

            <div className="w-8 h-[1px] bg-slate-100 my-2" />

            <div className="flex flex-col gap-3">
              {[
                { icon: <Mail className="w-5 h-5" />, path: "/apps/common" },
                { icon: <Car className="w-5 h-5" />, path: "/admin/driving" },
                { icon: <Calendar className="w-5 h-5" />, path: "/admin/schedules" },
                { icon: <FileText className="w-5 h-5" />, path: "/apps/finance" },
                { icon: <ClipboardCheck className="w-5 h-5" />, path: "/apps/finance" },
              ].map((item, idx) => (
                <button key={idx} onClick={() => navigate(item.path)} className="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-slate-900 transition-colors">
                  {item.icon}
                </button>
              ))}
            </div>
          </aside>

          {/* Tier 2: 슬라이딩 메뉴 패널 (수정 핵심) */}
          <aside className={cn(
              "absolute left-[70px] top-0 h-full w-64 text-white flex flex-col transition-all duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] z-40 shadow-[30px_0_60px_rgba(0,0,0,0.1)]",
              `bg-gradient-to-br ${currentCategoryInfo?.gradient}`,
              isMenuVisible ? "translate-x-0 opacity-100" : "-translate-x-10 opacity-0 pointer-events-none"
            )}>
            
            {/* 상단 텍스트 영역: pt-12 정도로 적절한 여백 부여 */}
            <div className="px-8 pt-12 pb-6"> 
              <div className="flex items-center gap-2 mb-2 opacity-70">
                <Layers className="w-3 h-3" />
                <span className="text-[10px] font-black uppercase tracking-widest">ArkPort Engine</span>
              </div>
              <h2 className="text-3xl font-black tracking-tighter leading-tight">
                {currentCategoryInfo?.label}
              </h2>
            </div>
            
            <nav className="flex-1 overflow-y-auto py-4 px-4 space-y-1.5 scrollbar-hide">
              {subMenuItems.map((item) => (
                <button key={item.id} onClick={() => { if (item.path) navigate(item.path); setIsMenuVisible(false); }}
                  className={cn("w-full flex items-center justify-between px-5 py-3.5 rounded-2xl text-[13px] font-extrabold transition-all duration-300 group",
                    location.pathname === item.path 
                      ? "bg-white text-slate-900 shadow-xl scale-[1.02]" 
                      : "hover:bg-white/15 text-white/80 hover:text-white"
                  )}>
                  <div className="flex items-center gap-4">
                    {React.cloneElement(item.icon as React.ReactElement, { 
                      className: cn("w-4 h-4 transition-colors", location.pathname === item.path ? "text-blue-600" : "text-white/60 group-hover:text-white") 
                    })}
                    <span>{item.name}</span>
                  </div>
                  <ChevronRight className={cn("w-3 h-3 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all", location.pathname === item.path && "hidden")} />
                </button>
              ))}
            </nav>
            
            <div className="p-6 bg-black/5 flex items-center justify-between shrink-0">
              <span className="text-[10px] font-black text-white/30 uppercase tracking-widest">Platform OS</span>
              <Badge className="bg-white/20 hover:bg-white/20 text-[9px] border-none font-black">PRO</Badge>
            </div>
          </aside>
        </div>

        {/* 3. 본문 영역 */}
        <div className="flex-1 bg-white overflow-y-auto relative z-0 scrollbar-hide">
          <HeaderRenderedProvider>
            {children}
          </HeaderRenderedProvider>
        </div>
      </main>
    </div>
  );
};



============================================================
File Path: src/components/NavLink.tsx
============================================================
import { NavLink as RouterNavLink, NavLinkProps } from "react-router-dom";
import { forwardRef } from "react";
import { cn } from "@/lib/utils";

interface NavLinkCompatProps extends Omit<NavLinkProps, "className"> {
  className?: string;
  activeClassName?: string;
  pendingClassName?: string;
}

const NavLink = forwardRef<HTMLAnchorElement, NavLinkCompatProps>(
  ({ className, activeClassName, pendingClassName, to, ...props }, ref) => {
    return (
      <RouterNavLink
        ref={ref}
        to={to}
        className={({ isActive, isPending }) =>
          cn(className, isActive && activeClassName, isPending && pendingClassName)
        }
        {...props}
      />
    );
  },
);

NavLink.displayName = "NavLink";

export { NavLink };



============================================================
File Path: src/components/PendingApproval.tsx
============================================================
import { useAuth } from "@/hooks/useAuth";
import { Button } from "@/components/ui/button";
import { Clock, Building2, LogOut } from "lucide-react";

export const PendingApproval = () => {
  const { signOut, signupRequest, profile } = useAuth();

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      {/* Background Effects */}
      <div className="absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-accent/5" />
      <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-primary/10 rounded-full blur-3xl" />
      <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-accent/10 rounded-full blur-3xl" />

      <div className="relative z-10 w-full max-w-md text-center">
        {/* Logo */}
        <div className="inline-flex items-center gap-2 mb-8">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center">
            <span className="text-primary-foreground font-bold text-lg">A</span>
          </div>
          <span className="font-bold text-2xl">
            <span className="gradient-text">Ark</span>Port
          </span>
        </div>

        {/* Status Card */}
        <div className="glass-card p-8">
          <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-amber-100 flex items-center justify-center">
            <Clock className="w-8 h-8 text-amber-600" />
          </div>

          <h2 className="text-2xl font-bold mb-2">승인 대기 중</h2>
          <p className="text-muted-foreground mb-6">
            관리자가 회원가입 요청을 검토하고 있습니다.
          </p>

          {signupRequest && (
            <div className="bg-secondary/50 rounded-lg p-4 mb-6 text-left">
              <div className="flex items-center gap-2 text-sm text-muted-foreground mb-2">
                <Building2 className="w-4 h-4" />
                <span>요청한 회사</span>
              </div>
              <p className="font-medium">{signupRequest.company_name}</p>
            </div>
          )}

          <div className="space-y-3 text-sm text-muted-foreground">
            <p>• 관리자 승인 후 시스템을 이용할 수 있습니다</p>
            <p>• 승인 완료 시 이메일로 알림을 받게 됩니다</p>
            <p>• 문의사항은 시스템 관리자에게 연락해주세요</p>
          </div>

          <Button
            variant="outline"
            className="mt-8 w-full"
            onClick={signOut}
          >
            <LogOut className="w-4 h-4 mr-2" />
            로그아웃
          </Button>
        </div>

        <p className="text-xs text-muted-foreground mt-6">
          {profile?.email}로 로그인됨
        </p>
      </div>
    </div>
  );
};



============================================================
File Path: src/components/ProtectedLayout.tsx
============================================================
import { Outlet } from "react-router-dom";
import { ProtectedRoute } from "./ProtectedRoute";
import { DashboardLayout } from "./DashboardLayout";

interface ProtectedLayoutProps {
  requireSuperAdmin?: boolean;
}

export const ProtectedLayout = ({ requireSuperAdmin = false }: ProtectedLayoutProps) => {
  return (
    <ProtectedRoute requireSuperAdmin={requireSuperAdmin}>
      <DashboardLayout>
        <Outlet />
      </DashboardLayout>
    </ProtectedRoute>
  );
};



============================================================
File Path: src/components/ProtectedRoute.tsx
============================================================
import { ReactNode } from "react";
import { Navigate, useLocation } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { PendingApproval } from "./PendingApproval";
import { Loader2, Ban } from "lucide-react";

interface ProtectedRouteProps {
  children: ReactNode;
  requireSuperAdmin?: boolean;
}

export const ProtectedRoute = ({ children, requireSuperAdmin = false }: ProtectedRouteProps) => {
  const { user, loading, isPendingApproval, isSuperAdmin, currentTenant, isSuspended } = useAuth();
  const location = useLocation();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  // 1. 로그인이 안 된 경우
  if (!user) {
    return <Navigate to="/auth" replace />;
  }

  // 2. 가입 승인 대기 중인 경우
  if (isPendingApproval && !isSuperAdmin) {
    return <PendingApproval />;
  }

  // 2.5. 계정 정지된 경우
  if (isSuspended && !isSuperAdmin) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 px-4">
        <div className="bg-white rounded-2xl shadow-lg border border-red-200 p-8 max-w-md w-full text-center">
          <div className="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
            <Ban className="w-8 h-8 text-red-500" />
          </div>
          <h2 className="text-xl font-bold text-slate-900 mb-2">계정이 정지되었습니다</h2>
          <p className="text-sm text-slate-500 mb-6">
            관리자에 의해 계정이 정지되었습니다. 문의가 필요한 경우 관리자에게 연락해 주세요.
          </p>
        </div>
      </div>
    );
  }

  // 3. 핵심: 온보딩 체크 (정보 등록 여부)
  // 소속 회사(currentTenant)는 있는데 직급(job_title) 정보가 없다면 미등록자로 간주
  // 단, 슈퍼어드민은 이 과정을 건너뛰게 하거나, 온보딩 페이지 자체에서는 무한 루프 방지
  const needsOnboarding = currentTenant && !currentTenant.job_title && !isSuperAdmin;

  if (needsOnboarding && location.pathname !== "/onboarding") {
    console.log("정보 미등록 감지: 온보딩 페이지로 강제 이동합니다.");
    return <Navigate to="/onboarding" replace />;
  }

  // 4. 슈퍼 어드민 전용 경로 체크
  if (requireSuperAdmin && !isSuperAdmin) {
    return <Navigate to="/dashboard" replace />;
  }

  return <>{children}</>;
};


============================================================
File Path: src/components/artist/TrendAnalysisPanel.tsx
============================================================
import { useState } from "react";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { 
  TrendingUp, TrendingDown, Minus, Sparkles, Loader2, 
  Users, Search, BarChart3, Target, RefreshCw 
} from "lucide-react";
import { toast } from "sonner";

interface TrendAnalysis {
  searchVolume: {
    monthly: number;
    trend: "up" | "stable" | "down";
    changePercent: number;
  };
  contentSaturation: {
    percentage: number;
    level: string;
  };
  audienceInterest: {
    grade: string;
    description: string;
  };
  demographics: {
    femaleRatio: number;
    topAgeGroups: { age: string; percentage: number }[];
  };
  keywords: string[];
  trendData: { year: string; value: number }[];
  summary: string;
}

interface TrendAnalysisPanelProps {
  artistName: string;
  stageName?: string | null;
}

export const TrendAnalysisPanel = ({ artistName, stageName }: TrendAnalysisPanelProps) => {
  const [analysis, setAnalysis] = useState<TrendAnalysis | null>(null);
  const [loading, setLoading] = useState(false);
  const [lastUpdated, setLastUpdated] = useState<string | null>(null);

  const runAnalysis = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke("analyze-artist-trends", {
        body: { artistName, stageName }
      });

      if (error) throw error;
      if (data.error) throw new Error(data.error);

      setAnalysis(data.analysis);
      setLastUpdated(new Date().toLocaleString("ko-KR"));
      toast.success("트렌드 분석이 완료되었습니다!");
    } catch (e: any) {
      console.error("Analysis error:", e);
      toast.error(e.message || "분석 중 오류가 발생했습니다.");
    } finally {
      setLoading(false);
    }
  };

  const getTrendIcon = (trend: string) => {
    switch (trend) {
      case "up": return <TrendingUp className="w-4 h-4 text-emerald-500" />;
      case "down": return <TrendingDown className="w-4 h-4 text-rose-500" />;
      default: return <Minus className="w-4 h-4 text-slate-400" />;
    }
  };

  const getGradeColor = (grade: string) => {
    switch (grade) {
      case "A": return "bg-emerald-500";
      case "B": return "bg-blue-500";
      case "C": return "bg-amber-500";
      default: return "bg-slate-400";
    }
  };

  if (!analysis) {
    return (
      <Card className="border-2 border-dashed border-slate-200 bg-slate-50/50">
        <CardContent className="p-8 text-center">
          <div className="inline-flex p-4 rounded-full bg-indigo-50 mb-4">
            <Sparkles className="w-8 h-8 text-indigo-500" />
          </div>
          <h3 className="font-bold text-slate-700 mb-2">AI 트렌드 분석</h3>
          <p className="text-sm text-slate-500 mb-4">
            Google Trends, 블랙키위 기반의 마켓 인사이트를 AI가 자동 분석합니다.
          </p>
          <Button onClick={runAnalysis} disabled={loading} className="bg-indigo-600 hover:bg-indigo-700">
            {loading ? (
              <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> 분석 중...</>
            ) : (
              <><Sparkles className="w-4 h-4 mr-2" /> 분석 시작</>
            )}
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* 헤더 */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <BarChart3 className="w-5 h-5 text-indigo-600" />
          <h3 className="font-bold text-slate-800">Market Insight Dashboard</h3>
          <Badge variant="outline" className="text-[9px] bg-indigo-50 border-indigo-200 text-indigo-600">
            AI POWERED
          </Badge>
        </div>
        <div className="flex items-center gap-2">
          {lastUpdated && (
            <span className="text-[10px] text-slate-400">업데이트: {lastUpdated}</span>
          )}
          <Button variant="ghost" size="sm" onClick={runAnalysis} disabled={loading}>
            <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
          </Button>
        </div>
      </div>

      {/* 메인 통계 그리드 */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
        {/* 월간 검색량 */}
        <Card className="border-slate-200 bg-white">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <Search className="w-4 h-4 text-slate-400" />
              <span className="text-[10px] font-bold text-slate-400 uppercase">Monthly Search</span>
            </div>
            <div className="flex items-baseline gap-2">
              <span className="text-2xl font-black text-indigo-600">
                {analysis.searchVolume.monthly.toLocaleString()}
              </span>
              <div className="flex items-center gap-1">
                {getTrendIcon(analysis.searchVolume.trend)}
                <span className={`text-xs font-bold ${
                  analysis.searchVolume.changePercent >= 0 ? 'text-emerald-500' : 'text-rose-500'
                }`}>
                  {analysis.searchVolume.changePercent >= 0 ? '+' : ''}{analysis.searchVolume.changePercent}%
                </span>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 콘텐츠 포화도 */}
        <Card className="border-slate-200 bg-white">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <Target className="w-4 h-4 text-slate-400" />
              <span className="text-[10px] font-bold text-slate-400 uppercase">Content Saturation</span>
            </div>
            <div className="flex items-baseline gap-2">
              <span className="text-2xl font-black text-indigo-600">
                {analysis.contentSaturation.percentage.toFixed(1)}%
              </span>
              <Badge variant="outline" className="text-[9px]">
                {analysis.contentSaturation.level}
              </Badge>
            </div>
          </CardContent>
        </Card>

        {/* 관심도 등급 */}
        <Card className="border-slate-200 bg-white">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <BarChart3 className="w-4 h-4 text-slate-400" />
              <span className="text-[10px] font-bold text-slate-400 uppercase">Interest Grade</span>
            </div>
            <div className="flex items-center gap-2">
              <span className={`text-2xl font-black text-white w-10 h-10 rounded-lg flex items-center justify-center ${getGradeColor(analysis.audienceInterest.grade)}`}>
                {analysis.audienceInterest.grade}
              </span>
              <span className="text-xs text-slate-500">{analysis.audienceInterest.description}</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* 트렌드 차트 + 인구통계 */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {/* 연도별 트렌드 */}
        <Card className="border-slate-200 bg-indigo-600 text-white">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 mb-4">
              <TrendingUp className="w-4 h-4 text-white/70" />
              <span className="text-[10px] font-bold text-white/70 uppercase">Yearly Trend</span>
            </div>
            <div className="flex items-end justify-between h-32 gap-2">
              {analysis.trendData.map((item, idx) => {
                const isMax = item.value === Math.max(...analysis.trendData.map(d => d.value));
                return (
                  <div key={idx} className="flex flex-col items-center flex-1">
                    <div
                      className={`w-full rounded-t transition-all ${isMax ? 'bg-white' : 'bg-white/30'}`}
                      style={{ height: `${item.value}%` }}
                    />
                    <span className="text-[10px] mt-2 text-white/60">{item.year}</span>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>

        {/* 성별/연령 분포 */}
        <Card className="border-slate-200 bg-white">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 mb-4">
              <Users className="w-4 h-4 text-slate-400" />
              <span className="text-[10px] font-bold text-slate-400 uppercase">Demographics</span>
            </div>
            <div className="flex items-center gap-4 mb-4">
              <div className="relative w-16 h-16">
                <svg className="w-full h-full -rotate-90" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="15" fill="none" stroke="#e2e8f0" strokeWidth="3" />
                  <circle
                    cx="18" cy="18" r="15" fill="none" stroke="#6366f1" strokeWidth="3"
                    strokeDasharray={`${analysis.demographics.femaleRatio} 100`}
                  />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center">
                  <span className="text-xs font-black">{analysis.demographics.femaleRatio}%</span>
                </div>
              </div>
              <div className="text-xs text-slate-500">
                <p className="font-bold text-indigo-600">여성 {analysis.demographics.femaleRatio}%</p>
                <p>남성 {100 - analysis.demographics.femaleRatio}%</p>
              </div>
            </div>
            <div className="space-y-2">
              {analysis.demographics.topAgeGroups.map((group, idx) => (
                <div key={idx} className="flex items-center gap-2">
                  <span className="text-[10px] font-bold text-slate-400 w-8">{group.age}</span>
                  <Progress value={group.percentage} className="h-2 flex-1" />
                  <span className="text-[10px] font-bold text-slate-600 w-8">{group.percentage}%</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* 키워드 클라우드 */}
      <Card className="border-slate-200 bg-white">
        <CardContent className="p-4">
          <div className="flex items-center gap-2 mb-3">
            <Sparkles className="w-4 h-4 text-slate-400" />
            <span className="text-[10px] font-bold text-slate-400 uppercase">Related Keywords</span>
          </div>
          <div className="flex flex-wrap gap-2">
            {analysis.keywords.map((keyword, idx) => (
              <Badge 
                key={idx} 
                variant="outline" 
                className={`text-xs ${idx < 3 ? 'bg-indigo-50 border-indigo-200 text-indigo-700 font-bold' : 'text-slate-600'}`}
              >
                {keyword}
              </Badge>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* AI 요약 */}
      <Card className="border-indigo-200 bg-indigo-50">
        <CardContent className="p-4">
          <div className="flex items-start gap-3">
            <div className="p-2 rounded-lg bg-indigo-600">
              <Sparkles className="w-4 h-4 text-white" />
            </div>
            <div>
              <h4 className="font-bold text-indigo-900 text-sm mb-1">AI 마케팅 전략 요약</h4>
              <p className="text-sm text-indigo-800 leading-relaxed">{analysis.summary}</p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};



============================================================
File Path: src/components/attendance/ClockInPopup.tsx
============================================================
import React, { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { LogIn, Clock } from "lucide-react";
import { format } from "date-fns";
import { ko } from "date-fns/locale";
import { toast } from "sonner";

export const ClockInPopup = () => {
  const { user, currentTenant } = useAuth();
  const [open, setOpen] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [loading, setLoading] = useState(false);
  const [checked, setChecked] = useState(false);

  const tenantId = currentTenant?.tenant_id;
  const todayStr = format(new Date(), "yyyy-MM-dd");

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    if (!user || !tenantId || checked) return;

    const checkAttendance = async () => {
      const { data } = await supabase
        .from("attendance_records")
        .select("id")
        .eq("user_id", user.id)
        .eq("tenant_id", tenantId)
        .eq("date", todayStr)
        .maybeSingle();

      if (!data) {
        setOpen(true);
      }
      setChecked(true);
    };

    checkAttendance();
  }, [user, tenantId, checked]);

  const handleClockIn = async () => {
    if (!user || !tenantId) return;
    setLoading(true);
    const now = new Date().toISOString();
    const { error } = await supabase.from("attendance_records").insert({
      user_id: user.id,
      tenant_id: tenantId,
      date: todayStr,
      clock_in: now,
      clock_in_method: "popup",
    });
    setLoading(false);
    if (error) {
      toast.error("출근 기록 실패: " + error.message);
    } else {
      toast.success(`출근이 기록되었습니다. (${format(new Date(), "HH:mm")})`);
      setOpen(false);
    }
  };

  const handleSkip = () => {
    setOpen(false);
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogContent className="sm:max-w-md rounded-[2rem]">
        <DialogHeader className="text-center space-y-4">
          <div className="mx-auto w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg">
            <Clock className="w-8 h-8 text-white" />
          </div>
          <DialogTitle className="text-xl font-black">출근 기록</DialogTitle>
          <DialogDescription className="text-muted-foreground">
            {format(new Date(), "yyyy년 M월 d일 (EEEE)", { locale: ko })}
          </DialogDescription>
        </DialogHeader>

        <div className="text-center py-6">
          <p className="text-5xl font-black text-foreground tracking-tight tabular-nums">
            {format(currentTime, "HH:mm:ss")}
          </p>
          <p className="text-sm text-muted-foreground mt-2">현재 시각에 출근을 기록하시겠습니까?</p>
        </div>

        <DialogFooter className="flex gap-2 sm:justify-center">
          <Button variant="ghost" onClick={handleSkip} className="rounded-xl">
            나중에
          </Button>
          <Button
            onClick={handleClockIn}
            disabled={loading}
            className="rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-8"
          >
            <LogIn className="w-4 h-4 mr-2" />
            {loading ? "기록 중..." : "출근하기"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};



============================================================
File Path: src/components/dashboard/AppGrid.tsx
============================================================
import React from "react";
import { useNavigate } from "react-router-dom";
import {
  // 매니지먼트
  Film,
  FileSearch,
  ClipboardCheck,
  Monitor,
  Mail,
  // 홍보
  PenTool,
  Star,
  BellRing,
  Send,
  UserSearch,
  StickyNote,
  Share2,
  // 마케팅
  Target,
  FilePieChart,
  Megaphone,
  Inbox,
  BarChart3,
  Calculator,
  // 재무
  Receipt,
  FileText,
  FileCheck2,
  ScrollText,
  Car,
  Wallet,
  TrendingUp,
  CalendarClock,
  CreditCard,
  // 인사
  Palmtree,
  CalendarDays,
  Clock,
  Network,
  FileSignature,
  Gift,
  // 공용
  Calendar,
  BookOpen,
  FolderOpen,
  FileArchive,
  Bell,
  Search,
  Flower2,
  KeyRound,
} from "lucide-react";
import { toast } from "sonner";

interface AppItem {
  id: string;
  name: string;
  icon: React.ReactNode;
  color: string;
  bgColor: string;
  path?: string;
}

interface AppCategory {
  title: string;
  apps: AppItem[];
}

export const AppGrid = () => {
  const navigate = useNavigate();

  const appCategories: AppCategory[] = [
    {
      title: "매니지먼트",
      apps: [
        {
          id: "scenario",
          name: "시나리오 분석",
          icon: <Film className="w-6 h-6" />,
          color: "text-indigo-600",
          bgColor: "bg-indigo-50",
        },
        {
          id: "contract-analysis",
          name: "계약서 분석",
          icon: <FileSearch className="w-6 h-6" />,
          color: "text-blue-600",
          bgColor: "bg-blue-50",
        },
        {
          id: "site-review",
          name: "현장 검토 사항",
          icon: <ClipboardCheck className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
        },
        {
          id: "select-monitor",
          name: "작품 셀렉 모니터링",
          icon: <Monitor className="w-6 h-6" />,
          color: "text-amber-600",
          bgColor: "bg-amber-50",
        },
        {
          id: "internal-mail",
          name: "사내 메일/소통",
          icon: <Mail className="w-6 h-6" />,
          color: "text-blue-600",
          bgColor: "bg-blue-50",
          path: "/admin/mail",
        },
      ],
    },
    {
      title: "홍보",
      apps: [
        {
          id: "press-release",
          name: "원고생성",
          icon: <PenTool className="w-6 h-6" />,
          color: "text-blue-600",
          bgColor: "bg-blue-50",
        },
        {
          id: "profile-create",
          name: "프로필 제작",
          icon: <Star className="w-6 h-6" />,
          color: "text-indigo-600",
          bgColor: "bg-indigo-50",
          path: "/profiles",
        },
        {
          id: "news-monitor",
          name: "키워드 알림",
          icon: <BellRing className="w-6 h-6" />,
          color: "text-amber-600",
          bgColor: "bg-amber-50",
        },
        {
          id: "media-sending",
          name: "언론 보도 발송",
          icon: <Send className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
          path: "/admin/media-pitching",
        },
        {
          id: "profile-mgmt",
          name: "인물정보 관리",
          icon: <UserSearch className="w-6 h-6" />,
          color: "text-purple-600",
          bgColor: "bg-purple-50",
          path: "/profiles",
        },
        {
          id: "media-memo",
          name: "미디어 관계 메모",
          icon: <StickyNote className="w-6 h-6" />,
          color: "text-rose-500",
          bgColor: "bg-rose-50",
        },
        {
          id: "sns-posting",
          name: "SNS포스팅 생성",
          icon: <Share2 className="w-6 h-6" />,
          color: "text-cyan-600",
          bgColor: "bg-cyan-50",
        },
      ],
    },
    {
      title: "마케팅",
      apps: [
        {
          id: "marketing-plan",
          name: "마케팅 전략",
          icon: <Target className="w-6 h-6" />,
          color: "text-rose-600",
          bgColor: "bg-rose-50",
        },
        {
          id: "performance",
          name: "성과보고서",
          icon: <FilePieChart className="w-6 h-6" />,
          color: "text-slate-600",
          bgColor: "bg-slate-100",
        },
        {
          id: "campaign",
          name: "캠페인 관리",
          icon: <Megaphone className="w-6 h-6" />,
          color: "text-orange-600",
          bgColor: "bg-orange-50",
        },
        {
          id: "brand-review",
          name: "브랜드 제안 검토함",
          icon: <Inbox className="w-6 h-6" />,
          color: "text-violet-600",
          bgColor: "bg-violet-50",
        },
        {
          id: "sns-dashboard",
          name: "SNS/노출 지표",
          icon: <BarChart3 className="w-6 h-6" />,
          color: "text-blue-500",
          bgColor: "bg-blue-50",
        },
        {
          id: "roi-sim",
          name: "ROI 시뮬레이션",
          icon: <Calculator className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
        },
      ],
    },
    {
      title: "재무",
      apps: [
        {
          id: "billing-inbox",
          name: "외부청구함",
          icon: <Receipt className="w-6 h-6" />,
          color: "text-rose-500",
          bgColor: "bg-rose-50",
        },
        {
          id: "draft",
          name: "기안서",
          icon: <FileText className="w-6 h-6" />,
          color: "text-blue-600",
          bgColor: "bg-blue-50",
        },
        {
          id: "approval",
          name: "지출결의서",
          icon: <FileCheck2 className="w-6 h-6" />,
          color: "text-orange-500",
          bgColor: "bg-orange-50",
        },
        {
          id: "civil-doc",
          name: "민원서류",
          icon: <ScrollText className="w-6 h-6" />,
          color: "text-slate-600",
          bgColor: "bg-slate-100",
        },
        {
          id: "vehicle-report",
          name: "차량 운행정산서",
          icon: <Car className="w-6 h-6" />,
          color: "text-slate-700",
          bgColor: "bg-slate-100",
          path: "/admin/driving",
        },
        {
          id: "monthly-budget",
          name: "월간예산",
          icon: <Wallet className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
        },
        {
          id: "my-cards",
          name: "내 법인카드",
          icon: <CreditCard className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
          path: "/apps/finance/cards",
        },
        {
          id: "revenue-track",
          name: "계약별 수익 트래킹",
          icon: <TrendingUp className="w-6 h-6" />,
          color: "text-indigo-600",
          bgColor: "bg-indigo-50",
        },
        {
          id: "cashflow-cal",
          name: "현금흐름 캘린더",
          icon: <CalendarClock className="w-6 h-6" />,
          color: "text-cyan-600",
          bgColor: "bg-cyan-50",
        },
      ],
    },
    {
      title: "인사",
      apps: [
        {
          id: "leave-request",
          name: "휴가신청",
          icon: <Palmtree className="w-6 h-6" />,
          color: "text-emerald-500",
          bgColor: "bg-emerald-50",
          path: "/leave-request",
        },
        {
          id: "leave-mgmt",
          name: "휴가 관리",
          icon: <CalendarDays className="w-6 h-6" />,
          color: "text-teal-600",
          bgColor: "bg-teal-50",
        },
        {
          id: "attendance",
          name: "출퇴근",
          icon: <Clock className="w-6 h-6" />,
          color: "text-blue-600",
          bgColor: "bg-blue-50",
          path: "/admin/attendance",
        },
        {
          id: "org-chart",
          name: "조직도",
          icon: <Network className="w-6 h-6" />,
          color: "text-purple-600",
          bgColor: "bg-purple-50",
        },
        {
          id: "labor-contract",
          name: "근로계약서",
          icon: <FileSignature className="w-6 h-6" />,
          color: "text-amber-600",
          bgColor: "bg-amber-50",
        },
        {
          id: "comp-leave",
          name: "보상휴가 관리",
          icon: <Gift className="w-6 h-6" />,
          color: "text-pink-500",
          bgColor: "bg-pink-50",
        },
      ],
    },
    {
      title: "공용",
      apps: [
        {
          id: "scheduler",
          name: "통합 스케줄러",
          icon: <Calendar className="w-6 h-6" />,
          color: "text-indigo-600",
          bgColor: "bg-indigo-50",
          path: "/admin/schedules",
        },
        {
          id: "regulations",
          name: "규정",
          icon: <BookOpen className="w-6 h-6" />,
          color: "text-slate-600",
          bgColor: "bg-slate-100",
        },
        {
          id: "project-info",
          name: "프로젝트 정보",
          icon: <FolderOpen className="w-6 h-6" />,
          color: "text-amber-500",
          bgColor: "bg-amber-50",
        },
        {
          id: "docs-minutes",
          name: "문서&회의록",
          icon: <FileArchive className="w-6 h-6" />,
          color: "text-blue-500",
          bgColor: "bg-blue-50",
        },
        {
          id: "notifications",
          name: "알림 센터",
          icon: <Bell className="w-6 h-6" />,
          color: "text-rose-500",
          bgColor: "bg-rose-50",
        },
        {
          id: "global-search",
          name: "통합 검색",
          icon: <Search className="w-6 h-6" />,
          color: "text-emerald-600",
          bgColor: "bg-emerald-50",
        },
        {
          id: "wreath",
          name: "화환신청",
          icon: <Flower2 className="w-6 h-6" />,
          color: "text-pink-500",
          bgColor: "bg-pink-50",
        },
        {
          id: "password-mgmt",
          name: "비밀번호 관리",
          icon: <KeyRound className="w-6 h-6" />,
          color: "text-slate-700",
          bgColor: "bg-slate-100",
        },
      ],
    },
  ];

  const categoryRouteMap: Record<string, string> = {
    매니지먼트: "management",
    홍보: "pr",
    마케팅: "marketing",
    재무: "finance",
    인사: "hr",
    공용: "common",
  };

  const handleAppClick = (app: AppItem) => {
    if (app.path) {
      navigate(app.path);
    } else {
      toast.info("준비 중인 기능입니다.");
    }
  };

  const handleCategoryClick = (title: string) => {
    const route = categoryRouteMap[title];
    if (route) {
      navigate(`/apps/${route}`);
    }
  };

  return (
    <div className="relative rounded-3xl overflow-hidden shadow-2xl">
      <div className="absolute inset-0 bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-900" />
      <div className="relative z-10 p-8">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          {appCategories.map((category) => (
            <div
              key={category.title}
              className="bg-white/95 backdrop-blur-md rounded-2xl p-5 shadow-xl border border-white/50"
            >
              <button
                onClick={() => handleCategoryClick(category.title)}
                className="w-full font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2 text-sm tracking-wide text-left hover:text-blue-600 transition-colors flex items-center justify-between"
              >
                <span>
                  {category.title}
                  <span className="ml-2 text-xs font-normal text-slate-400">{category.apps.length}</span>
                </span>
                <span className="text-xs text-slate-400">전체보기 →</span>
              </button>
              <div className="grid grid-cols-4 gap-3">
                {category.apps.map((app) => (
                  <button
                    key={app.id}
                    onClick={() => handleAppClick(app)}
                    className="flex flex-col items-center gap-1.5 group"
                  >
                    <div
                      className={`w-12 h-12 ${app.bgColor} rounded-xl flex items-center justify-center ${app.color} group-hover:scale-110 transition-transform shadow-sm border border-white`}
                    >
                      {app.icon}
                    </div>
                    <span className="text-[10px] font-medium text-slate-600 text-center leading-tight break-keep">
                      {app.name}
                    </span>
                  </button>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};



============================================================
File Path: src/components/dashboard/CalendarWidget.tsx
============================================================
import { useState, useEffect } from "react";
import { Calendar } from "@/components/ui/calendar";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter,
} from "@/components/ui/dialog";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  ChevronLeft,
  ChevronRight,
  Plus,
  CalendarDays,
  Clock,
  Edit2,
  Trash2,
  MapPin,
  User,
  Loader2,
} from "lucide-react";
import { format, isSameDay, parseISO, startOfMonth, endOfMonth } from "date-fns";
import { ko } from "date-fns/locale";
import { cn } from "@/lib/utils";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";

interface Schedule {
  id: string;
  artist_id: string;
  tenant_id: string;
  title: string;
  description: string | null;
  start_time: string;
  end_time: string;
  is_all_day: boolean;
  schedule_type: string;
  location: string | null;
  created_by: string | null;
  artist?: { id: string; name: string; stage_name: string | null };
}

interface Artist {
  id: string;
  name: string;
  stage_name: string | null;
}

const SCHEDULE_TYPES = [
  { value: "schedule", label: "일반 일정" },
  { value: "filming", label: "촬영" },
  { value: "meeting", label: "미팅" },
  { value: "event", label: "행사" },
  { value: "rehearsal", label: "리허설" },
  { value: "interview", label: "인터뷰" },
  { value: "travel", label: "이동" },
  { value: "rest", label: "휴식" },
];

const TYPE_COLORS: Record<string, string> = {
  filming: "bg-red-500",
  meeting: "bg-blue-500",
  event: "bg-purple-500",
  rehearsal: "bg-amber-500",
  interview: "bg-cyan-500",
  travel: "bg-green-500",
  rest: "bg-slate-400",
  schedule: "bg-primary",
};

export const CalendarWidget = () => {
  const { currentTenant, profile } = useAuth();
  const myTenantId = currentTenant?.tenant_id;

  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [currentMonth, setCurrentMonth] = useState<Date>(new Date());
  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [artists, setArtists] = useState<Artist[]>([]);
  const [loading, setLoading] = useState(true);

  // CRUD state
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<Schedule | null>(null);
  const [deleteTarget, setDeleteTarget] = useState<Schedule | null>(null);
  const [processing, setProcessing] = useState(false);
  const [form, setForm] = useState({
    artist_id: "",
    title: "",
    description: "",
    start_time: "",
    end_time: "",
    is_all_day: false,
    schedule_type: "schedule",
    location: "",
  });

  const fetchData = async () => {
    if (!myTenantId) { setLoading(false); return; }
    try {
      const [scheduleRes, artistRes] = await Promise.all([
        supabase
          .from("artist_schedules")
          .select("*, artist:artist_id ( id, name, stage_name )" as any)
          .eq("tenant_id", myTenantId)
          .order("start_time", { ascending: true }),
        supabase
          .from("artists")
          .select("id, name, stage_name")
          .eq("tenant_id", myTenantId)
          .eq("is_active", true)
          .order("name"),
      ]);
      if (scheduleRes.error) throw scheduleRes.error;
      setSchedules((scheduleRes.data || []) as unknown as Schedule[]);
      setArtists((artistRes.data || []) as Artist[]);
    } catch (e) {
      console.error("Calendar fetch error:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchData(); }, [myTenantId]);

  // Schedules for selected date
  const daySchedules = schedules.filter((s) =>
    isSameDay(parseISO(s.start_time), selectedDate)
  );

  // Dates with schedules for dot indicators
  const scheduledDates = [...new Set(
    schedules.map((s) => format(parseISO(s.start_time), "yyyy-MM-dd"))
  )].map((d) => new Date(d));

  const handlePrevMonth = () => {
    setCurrentMonth((prev) => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
  };
  const handleNextMonth = () => {
    setCurrentMonth((prev) => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
  };

  // Form helpers
  const resetForm = () => {
    setForm({
      artist_id: "",
      title: "",
      description: "",
      start_time: "",
      end_time: "",
      is_all_day: false,
      schedule_type: "schedule",
      location: "",
    });
    setEditingSchedule(null);
  };

  const openCreate = () => {
    resetForm();
    // Pre-fill date from selected date
    const dateStr = format(selectedDate, "yyyy-MM-dd");
    setForm((f) => ({
      ...f,
      start_time: `${dateStr}T09:00`,
      end_time: `${dateStr}T10:00`,
    }));
    setIsDialogOpen(true);
  };

  const openEdit = (s: Schedule) => {
    setEditingSchedule(s);
    setForm({
      artist_id: s.artist_id,
      title: s.title,
      description: s.description || "",
      start_time: s.start_time.slice(0, 16),
      end_time: s.end_time.slice(0, 16),
      is_all_day: s.is_all_day,
      schedule_type: s.schedule_type || "schedule",
      location: s.location || "",
    });
    setIsDialogOpen(true);
  };

  const handleSave = async () => {
    if (!form.artist_id || !form.title || !form.start_time || !form.end_time) {
      toast.error("배우, 제목, 시작/종료 시간을 입력해주세요.");
      return;
    }
    if (new Date(form.end_time) <= new Date(form.start_time)) {
      toast.error("종료 시간은 시작 시간 이후여야 합니다.");
      return;
    }
    setProcessing(true);
    try {
      const payload = {
        artist_id: form.artist_id,
        tenant_id: myTenantId,
        title: form.title,
        description: form.description || null,
        start_time: new Date(form.start_time).toISOString(),
        end_time: new Date(form.end_time).toISOString(),
        is_all_day: form.is_all_day,
        schedule_type: form.schedule_type,
        location: form.location || null,
        ...(editingSchedule ? {} : { created_by: profile?.id }),
      };

      if (editingSchedule) {
        const { error } = await supabase
          .from("artist_schedules")
          .update(payload as any)
          .eq("id", editingSchedule.id);
        if (error) throw error;
        toast.success("일정이 수정되었습니다.");
      } else {
        const { error } = await supabase
          .from("artist_schedules")
          .insert(payload as any);
        if (error) throw error;
        toast.success("일정이 등록되었습니다.");
      }
      setIsDialogOpen(false);
      resetForm();
      fetchData();
    } catch (error: any) {
      toast.error("저장 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    setProcessing(true);
    try {
      const { error } = await supabase
        .from("artist_schedules")
        .delete()
        .eq("id", deleteTarget.id);
      if (error) throw error;
      toast.success("일정이 삭제되었습니다.");
      setDeleteTarget(null);
      fetchData();
    } catch (error: any) {
      toast.error("삭제 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const getTypeLabel = (type: string) =>
    SCHEDULE_TYPES.find((t) => t.value === type)?.label || type;

  return (
    <>
      <div className="grid md:grid-cols-2 gap-4">
        {/* Calendar Section */}
        <div className="glass-card p-5">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <Button variant="ghost" size="icon" className="w-8 h-8" onClick={handlePrevMonth}>
                <ChevronLeft className="w-4 h-4" />
              </Button>
            </div>
            <h3 className="font-semibold text-lg">
              {format(currentMonth, "yyyy.MM", { locale: ko })}
            </h3>
            <div className="flex items-center gap-2">
              <Button variant="ghost" size="icon" className="w-8 h-8" onClick={handleNextMonth}>
                <ChevronRight className="w-4 h-4" />
              </Button>
            </div>
          </div>

          <Calendar
            mode="single"
            selected={selectedDate}
            onSelect={(date) => date && setSelectedDate(date)}
            month={currentMonth}
            onMonthChange={setCurrentMonth}
            locale={ko}
            className="p-0 pointer-events-auto"
            classNames={{
              months: "w-full",
              month: "w-full space-y-4",
              caption: "hidden",
              caption_label: "text-sm font-medium",
              nav: "hidden",
              table: "w-full border-collapse",
              head_row: "flex w-full",
              head_cell: "text-muted-foreground rounded-md w-full font-normal text-xs",
              row: "flex w-full mt-1",
              cell: cn(
                "relative w-full p-0 text-center text-sm focus-within:relative focus-within:z-20",
                "[&:has([aria-selected])]:bg-transparent"
              ),
              day: cn(
                "h-9 w-9 p-0 font-normal mx-auto rounded-full hover:bg-secondary transition-colors",
                "aria-selected:opacity-100"
              ),
              day_selected: "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground",
              day_today: "bg-primary/10 text-primary font-semibold",
              day_outside: "text-muted-foreground/50",
              day_disabled: "text-muted-foreground opacity-50",
            }}
            modifiers={{ scheduled: scheduledDates }}
            modifiersClassNames={{
              scheduled: "after:absolute after:bottom-1 after:left-1/2 after:-translate-x-1/2 after:w-1 after:h-1 after:bg-primary after:rounded-full",
            }}
          />
        </div>

        {/* Schedule List Section */}
        <div className="glass-card p-5">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-semibold text-lg">
              {format(selectedDate, "MM.dd(eee)", { locale: ko })} 일정
            </h3>
            <Button variant="ghost" size="icon" className="w-8 h-8" onClick={openCreate}>
              <Plus className="w-4 h-4" />
            </Button>
          </div>

          {loading ? (
            <div className="flex justify-center py-12">
              <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
            </div>
          ) : daySchedules.length > 0 ? (
            <div className="space-y-3 max-h-[360px] overflow-y-auto">
              {daySchedules.map((s) => (
                <div
                  key={s.id}
                  className="flex items-start gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 transition-colors group"
                >
                  <div className={`w-1 self-stretch min-h-[40px] ${TYPE_COLORS[s.schedule_type] || "bg-primary"} rounded-full`} />
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-1.5 mb-0.5">
                      <Badge variant="outline" className="text-[10px] px-1.5 py-0">
                        {getTypeLabel(s.schedule_type)}
                      </Badge>
                      {s.is_all_day && (
                        <Badge variant="secondary" className="text-[10px] px-1.5 py-0">종일</Badge>
                      )}
                    </div>
                    <div className="font-medium text-sm">{s.title}</div>
                    <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground mt-1">
                      <span className="flex items-center gap-0.5">
                        <User className="w-3 h-3" />
                        {(s.artist as any)?.name || "미지정"}
                      </span>
                      {!s.is_all_day && (
                        <span className="flex items-center gap-0.5">
                          <Clock className="w-3 h-3" />
                          {format(parseISO(s.start_time), "HH:mm")} - {format(parseISO(s.end_time), "HH:mm")}
                        </span>
                      )}
                      {s.location && (
                        <span className="flex items-center gap-0.5">
                          <MapPin className="w-3 h-3" />
                          {s.location}
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                    <Button variant="ghost" size="icon" className="w-7 h-7" onClick={() => openEdit(s)}>
                      <Edit2 className="w-3.5 h-3.5" />
                    </Button>
                    <Button variant="ghost" size="icon" className="w-7 h-7 text-destructive" onClick={() => setDeleteTarget(s)}>
                      <Trash2 className="w-3.5 h-3.5" />
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center py-12 text-center">
              <div className="w-16 h-16 rounded-full bg-secondary flex items-center justify-center mb-4">
                <CalendarDays className="w-8 h-8 text-muted-foreground" />
              </div>
              <p className="text-muted-foreground text-sm">등록된 일정이 없습니다</p>
              <Button variant="link" size="sm" className="mt-2" onClick={openCreate}>
                <Plus className="w-3 h-3 mr-1" /> 일정 등록하기
              </Button>
            </div>
          )}
        </div>
      </div>

      {/* Create/Edit Dialog */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <CalendarDays className="w-5 h-5 text-primary" />
              {editingSchedule ? "일정 수정" : "일정 등록"}
            </DialogTitle>
            <DialogDescription>
              배우 스케줄을 {editingSchedule ? "수정" : "등록"}합니다.
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-2">
            <div className="space-y-2">
              <Label>배우 *</Label>
              <Select value={form.artist_id} onValueChange={(v) => setForm((f) => ({ ...f, artist_id: v }))}>
                <SelectTrigger><SelectValue placeholder="배우 선택" /></SelectTrigger>
                <SelectContent>
                  {artists.map((a) => (
                    <SelectItem key={a.id} value={a.id}>
                      {a.name}{a.stage_name ? ` (${a.stage_name})` : ""}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>제목 *</Label>
              <Input
                value={form.title}
                onChange={(e) => setForm((f) => ({ ...f, title: e.target.value }))}
                placeholder="일정 제목"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>유형</Label>
                <Select value={form.schedule_type} onValueChange={(v) => setForm((f) => ({ ...f, schedule_type: v }))}>
                  <SelectTrigger><SelectValue /></SelectTrigger>
                  <SelectContent>
                    {SCHEDULE_TYPES.map((t) => (
                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>장소</Label>
                <Input
                  value={form.location}
                  onChange={(e) => setForm((f) => ({ ...f, location: e.target.value }))}
                  placeholder="선택 입력"
                />
              </div>
            </div>

            <div className="flex items-center gap-3">
              <Switch
                checked={form.is_all_day}
                onCheckedChange={(v) => setForm((f) => ({ ...f, is_all_day: v }))}
              />
              <Label>종일 일정</Label>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>시작 *</Label>
                <Input
                  type="datetime-local"
                  value={form.start_time}
                  onChange={(e) => setForm((f) => ({ ...f, start_time: e.target.value }))}
                />
              </div>
              <div className="space-y-2">
                <Label>종료 *</Label>
                <Input
                  type="datetime-local"
                  value={form.end_time}
                  onChange={(e) => setForm((f) => ({ ...f, end_time: e.target.value }))}
                />
              </div>
            </div>

            <div className="space-y-2">
              <Label>메모</Label>
              <Textarea
                value={form.description}
                onChange={(e) => setForm((f) => ({ ...f, description: e.target.value }))}
                placeholder="메모 (선택)"
                rows={2}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsDialogOpen(false)}>취소</Button>
            <Button onClick={handleSave} disabled={processing}>
              {processing && <Loader2 className="w-4 h-4 animate-spin mr-1" />}
              {editingSchedule ? "수정" : "등록"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteTarget} onOpenChange={() => setDeleteTarget(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>일정 삭제</AlertDialogTitle>
            <AlertDialogDescription>
              "{deleteTarget?.title}" 일정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
              {processing && <Loader2 className="w-4 h-4 animate-spin mr-1" />}
              삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
};



============================================================
File Path: src/components/landing/ArchitectureSection.tsx
============================================================
import React, { useMemo, useRef, useLayoutEffect, useState } from "react";
import {
  Building2,
  Zap,
  Palette,
  Film,
  Tv,
  Target,
  Megaphone,
  ArrowDown,
  CreditCard,
  MessageSquare,
  RefreshCw,
} from "lucide-react";

/**
 * ✅ 전체 코드 (화살표 "보이게" 확실히 수정한 버전)
 * 핵심 수정:
 * 1) SVG를 flex 내부가 아니라, PR 영역을 감싸는 "relative overlay 래퍼"에 absolute로 올림 (z-index 정리)
 * 2) 자동 좌표 계산을 SVG 높이(overlayHeight) 기준으로 제대로 환산
 * 3) SVG viewBox 높이를 180으로 키워서 여유 확보 + stroke/opacity 조금 올려 가시성 강화
 */

export const ArchitectureSection = () => {
  const masterHubModules = [
    { title: "비주얼", icon: <Palette size={20} /> },
    { title: "작품", icon: <Film size={20} /> },
    { title: "광고", icon: <Tv size={20} /> },
    { title: "기획", icon: <Target size={20} /> },
    { title: "디지털", icon: <Megaphone size={20} /> },
  ];

  // refs
  const prWrapRef = useRef<HTMLDivElement | null>(null); // PR 영역(overlay 기준)
  const alphaRef = useRef<HTMLDivElement | null>(null);
  const betaRef = useRef<HTMLDivElement | null>(null);
  const agencyRef = useRef<HTMLDivElement | null>(null);
  const masterRef = useRef<HTMLDivElement | null>(null);

  // SVG overlay 설정
  const overlayTopPx = 92; // PR 카드 아래로 SVG를 얼마나 내릴지 (필요하면 80~110 사이로 미세조정)
  const overlayHeightPx = 180; // SVG overlay 실제 높이(px)
  const vbW = 1000;
  const vbH = 180;

  const [autoPoints, setAutoPoints] = useState<null | {
    a: { x: number; y: number };
    b: { x: number; y: number };
    c: { x: number; y: number };
    d: { x: number; y: number };
  }>(null);

  useLayoutEffect(() => {
    const wrapEl = prWrapRef.current;
    const aEl = alphaRef.current;
    const bEl = betaRef.current;
    const agencyEl = agencyRef.current;
    const masterEl = masterRef.current;

    if (!wrapEl || !aEl || !bEl || !agencyEl || !masterEl) return;

    const compute = () => {
      const wrap = wrapEl.getBoundingClientRect();
      const alpha = aEl.getBoundingClientRect();
      const beta = bEl.getBoundingClientRect();
      const agency = agencyEl.getBoundingClientRect();
      const master = masterEl.getBoundingClientRect();

      const svgW = wrap.width || 1;
      const svgH = overlayHeightPx;

      // 화면 좌표 -> overlay(SVG) 로컬 좌표(px)
      const toLocal = (x: number, y: number) => ({
        x: x - wrap.left,
        y: y - (wrap.top + overlayTopPx),
      });

      // 로컬(px) -> viewBox 좌표
      const toVB = (x: number, y: number) => ({
        x: (x / svgW) * vbW,
        y: (y / svgH) * vbH,
      });

      // 시작점: PR 카드 "하단 중앙"에서 살짝 아래
      const aLocal = toLocal(alpha.left + alpha.width / 2, alpha.bottom + 8);
      const bLocal = toLocal(beta.left + beta.width / 2, beta.bottom + 8);

      // 도착점: 아래 박스(배우기획사 / MasterHub) "상단 중앙"에서 살짝 위/아래
      const cLocal = toLocal(agency.left + agency.width / 2, agency.top - 6);
      const dLocal = toLocal(master.left + master.width / 2, master.top - 6);

      const A = toVB(aLocal.x, Math.max(6, aLocal.y));
      const B = toVB(bLocal.x, Math.max(6, bLocal.y));

      // 도착점 y를 overlay 하단 가까이로 클램프(화살표가 overlay 영역 밖으로 빠지지 않게)
      const C = toVB(cLocal.x, Math.min(vbH - 10, Math.max(40, cLocal.y)));
      const D = toVB(dLocal.x, Math.min(vbH - 10, Math.max(40, dLocal.y)));

      setAutoPoints({
        a: { x: A.x, y: A.y },
        b: { x: B.x, y: B.y },
        c: { x: C.x, y: C.y },
        d: { x: D.x, y: D.y },
      });
    };

    compute();
    const ro = new ResizeObserver(() => compute());
    ro.observe(wrapEl);

    window.addEventListener("resize", compute);
    return () => {
      ro.disconnect();
      window.removeEventListener("resize", compute);
    };
  }, [overlayTopPx, overlayHeightPx]);

  // 고정 좌표(자동이 없을 때 fallback)
  const points = useMemo(() => {
    if (autoPoints) return autoPoints;
    return {
      a: { x: 360, y: 20 },
      b: { x: 640, y: 20 },
      c: { x: 500, y: 165 },
      d: { x: 760, y: 165 },
    };
  }, [autoPoints]);

  return (
    <section className="py-24 bg-[#F8FAFC] relative overflow-hidden font-sans">
      <div className="container px-4 mx-auto max-w-7xl relative">
        {/* 1) 상단: PR & 바이럴 */}
        <div className="flex flex-col items-center mb-10" ref={prWrapRef}>
          {/* ✅ overlay 기준이 되는 relative wrapper */}
          <div className="relative w-full flex justify-center">
            {/* ✅ PR 카드들 (z-10) */}
            <div className="flex justify-center gap-10 relative z-10">
              {[
                { type: "Alpha", ref: alphaRef },
                { type: "Beta", ref: betaRef },
              ].map(({ type, ref }) => (
                <div key={type} className="relative" ref={ref}>
                  <div className="bg-[#004d71] text-white px-12 py-6 rounded-[2.5rem] shadow-2xl text-center relative border-2 border-white/20 transition-transform hover:-translate-y-1">
                    <div className="text-[11px] font-black italic tracking-widest mb-1.5 opacity-60 uppercase">
                      COMMUNICATION HUB
                    </div>
                    <div className="text-xl font-bold italic tracking-tight">PR &amp; 바이럴 {type}</div>
                    <div className="absolute -top-3 -right-2 bg-emerald-500 rounded-full p-2 border-2 border-white shadow-lg">
                      <CreditCard size={14} className="text-white" />
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* ✅ 화살표 SVG: flex 밖 / overlay로 absolute (z-0) */}
            <svg
              className="hidden lg:block absolute left-0 top-[92px] w-full h-[180px] pointer-events-none z-0"
              viewBox={`0 0 ${vbW} ${vbH}`}
              preserveAspectRatio="none"
            >
              <defs>
                <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
                  <path d="M0,0 L6,3 L0,6" fill="#64748b" opacity="0.95" />
                </marker>
              </defs>

              {/* Alpha -> 배우 기획사 */}
              <path
                d={`M${points.a.x} ${points.a.y} C${points.a.x} 70, ${Math.round(
                  (points.a.x + points.c.x) / 2,
                )} 90, ${points.c.x} ${points.c.y}`}
                fill="none"
                stroke="#64748b"
                strokeWidth="2.5"
                strokeDasharray="6 8"
                opacity="0.75"
                markerEnd="url(#arrowHead)"
              />

              {/* Beta -> Master Hub */}
              <path
                d={`M${points.b.x} ${points.b.y} C${points.b.x} 70, ${Math.round(
                  (points.b.x + points.d.x) / 2,
                )} 90, ${points.d.x} ${points.d.y}`}
                fill="none"
                stroke="#64748b"
                strokeWidth="2.5"
                strokeDasharray="6 8"
                opacity="0.75"
                markerEnd="url(#arrowHead)"
              />

              {/* (선택) 양쪽 끝 은은한 점선 */}
              <path
                d="M140 20 L140 160"
                fill="none"
                stroke="#cbd5e1"
                strokeWidth="2"
                strokeDasharray="6 10"
                opacity="0.25"
                markerEnd="url(#arrowHead)"
              />
              <path
                d="M900 20 L900 160"
                fill="none"
                stroke="#cbd5e1"
                strokeWidth="2"
                strokeDasharray="6 10"
                opacity="0.25"
                markerEnd="url(#arrowHead)"
              />
            </svg>
          </div>

          <div className="mt-14 text-[10px] font-black text-slate-300 uppercase tracking-[0.4em]">
            Collaborative Interface
          </div>
        </div>

        {/* 2) 메인 수평 레이어: ArkPort - 배우 기획사 - 마스터 허브 */}
        <div className="flex flex-col lg:flex-row items-stretch justify-center gap-8 relative">
          {/* ArkPort OS */}
          <div className="lg:w-1/4 bg-white border-2 border-slate-100 rounded-[3rem] p-10 shadow-lg flex flex-col items-center justify-center text-center">
            <div className="w-16 h-16 bg-blue-600 rounded-[1.5rem] flex items-center justify-center mb-8 shadow-xl shadow-blue-100 font-bold text-white italic text-2xl">
              B
            </div>
            <h3 className="text-2xl font-bold text-slate-900 mb-4 italic uppercase leading-none">ArkPort OS</h3>
            <div className="space-y-3 w-full mt-4">
              {["정산/결제 자동화", "세무 리스크 방어", "법무 계약 검토"].map((t) => (
                <div
                  key={t}
                  className="py-3 bg-slate-50 rounded-2xl text-[12px] font-bold text-slate-500 border border-slate-100 uppercase tracking-tighter"
                >
                  {t}
                </div>
              ))}
            </div>
          </div>

          {/* 중앙: 배우 기획사 */}
          <div className="lg:w-2/5 flex flex-col items-center justify-center px-4" ref={agencyRef}>
            <div className="relative group w-full text-center">
              <div className="bg-white border-[10px] border-slate-900 rounded-[5rem] p-16 shadow-[30px_30px_0px_0px_rgba(15,23,42,0.05)] transition-all">
                <div className="w-24 h-24 bg-slate-900 rounded-[3rem] flex items-center justify-center mx-auto mb-8 shadow-2xl">
                  <Building2 className="text-white" size={48} />
                </div>
                <h3 className="text-5xl font-black text-slate-900 tracking-tighter uppercase mb-6 leading-none italic">
                  배우 기획사
                </h3>
                <div className="flex flex-col gap-3 max-w-xs mx-auto">
                  <div className="inline-flex items-center justify-center gap-3 px-6 py-3 bg-blue-50 rounded-2xl text-[13px] font-bold text-blue-600 border border-blue-100 uppercase tracking-tight">
                    <CreditCard size={14} /> 예산 집행 및 직접 결제
                  </div>
                  <div className="inline-flex items-center justify-center gap-3 px-6 py-3 bg-slate-50 rounded-2xl text-[13px] font-bold text-slate-400 uppercase tracking-tight">
                    <MessageSquare size={14} /> 최종 전략 의사결정
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* 우측: 마스터 허브 */}
          <div className="lg:w-2/5 flex flex-col gap-4" ref={masterRef}>
            <div className="bg-white border-[6px] border-slate-900 rounded-[3.5rem] p-10 shadow-2xl relative flex-1 flex flex-col justify-center transition-all">
              <div className="absolute -top-5 left-12 bg-slate-900 text-white px-8 py-2 rounded-full font-black text-[12px] uppercase tracking-[0.2em] italic shadow-lg">
                Master Hub
              </div>

              <div className="mb-8 text-center">
                <h4 className="text-2xl font-bold text-slate-900 italic tracking-tighter leading-none mb-2 uppercase">
                  Casting Agency X
                </h4>
                <p className="text-[12px] font-bold text-orange-600 uppercase tracking-[0.3em]">
                  Creative Business Engine
                </p>
              </div>

              <div className="grid grid-cols-5 gap-3 mb-8 border-b-2 border-slate-100 pb-8">
                {masterHubModules.map((m) => (
                  <div key={m.title} className="flex flex-col items-center gap-2 group cursor-pointer">
                    <div className="w-12 h-12 bg-slate-50 border border-slate-200 rounded-[1.25rem] flex items-center justify-center text-slate-400 group-hover:bg-slate-900 group-hover:text-white transition-all shadow-sm">
                      {m.icon}
                    </div>
                    <span className="text-[11px] font-bold text-slate-800 leading-none uppercase tracking-tighter">
                      {m.title}
                    </span>
                  </div>
                ))}
              </div>

              <div className="space-y-4">
                <div className="flex items-center gap-2 mb-2 px-2">
                  <ArrowDown className="text-orange-400 animate-bounce" size={16} />
                  <span className="text-[11px] font-bold text-slate-400 uppercase tracking-[0.2em] italic">
                    Direct Managed Partners
                  </span>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-slate-900 text-white p-5 rounded-[1.75rem] flex items-center justify-between group cursor-pointer hover:bg-orange-600 transition-colors shadow-lg border border-slate-800">
                    <span className="text-[13px] font-bold italic tracking-tighter">트랜드 이슈폴리시</span>
                    <Zap size={12} className="text-orange-400 fill-orange-400" />
                  </div>

                  <div className="bg-white border-2 border-slate-200 p-5 rounded-[1.75rem] text-center shadow-md hover:border-orange-500 transition-colors cursor-pointer">
                    <span className="text-[13px] font-bold text-slate-600 italic tracking-tighter">콜리플라워</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 3) 하단 데이터 싱크 라인 */}
        <div className="mt-12 flex justify-center w-full">
          <div className="flex items-center gap-4 bg-white/95 px-8 py-3 rounded-full border-2 border-slate-100 shadow-xl pointer-events-auto backdrop-blur-sm">
            <RefreshCw size={14} className="text-blue-500 animate-spin" style={{ animationDuration: "8s" }} />
            <span className="text-[12px] font-bold text-slate-500 uppercase italic tracking-[0.1em]">
              Data Sync &amp; Contract Review
            </span>
            <div className="w-48 h-1.5 bg-gradient-to-r from-blue-500 to-orange-500 mx-2 opacity-20 rounded-full" />
          </div>
        </div>
      </div>
    </section>
  );
};



============================================================
File Path: src/components/landing/FeaturesSection.tsx
============================================================
import { FileText, Users, ShieldCheck, Workflow, Calendar, Car, MessageSquare, Lock } from "lucide-react";

const features = [
  {
    icon: FileText,
    title: "AI 행정 증빙 처리",
    description:
      "외부 거래처의 청구서와 영수증을 AI가 분석합니다. 로그인 없이도 증빙 자료를 수집하고 데이터를 구조화하여 세무 리스크를 사전 방어합니다.",
    gradient: "from-primary to-cyan-400",
  },
  {
    icon: Workflow,
    title: "최종 의사결정 시스템",
    description:
      "모든 자금 집행은 배우 법인 대표의 전자 승인을 거칩니다. 실질적 경영 주체가 누구인지 법적으로 증명하는 가장 강력한 수단입니다.",
    gradient: "from-accent to-pink-400",
  },
  {
    icon: MessageSquare,
    title: "전사적 감사 로그 (Audit)",
    description:
      "단순한 채팅이 아닙니다. 파트너사와의 모든 소통과 업무 변경 이력이 타임라인에 기록되어, 향후 분쟁이나 세무 조사 시 완벽한 증거가 됩니다.",
    gradient: "from-violet-500 to-purple-400",
  },
  {
    icon: Lock,
    title: "독립 법인 인프라",
    description:
      "멀티 테넌트 기술로 각 배우 법인의 데이터를 완벽하게 격리합니다. 파트너사가 바뀌어도 법인의 소중한 경영 데이터는 오직 법인 소유로 남습니다.",
    gradient: "from-warning to-orange-400",
  },
  {
    icon: ShieldCheck,
    title: "권한 기반 보안 제어",
    description:
      "에이전시, 세무사 등 외부 파트너에게 필요한 만큼의 권한만 부여하세요. 계약 종료와 동시에 버튼 하나로 모든 접근 권한을 즉시 회수할 수 있습니다.",
    gradient: "from-red-500 to-rose-400",
  },
  {
    icon: Calendar,
    title: "투명한 일정 매칭",
    description:
      "에이전시와 배우 간의 일정을 실시간 공유합니다. 지휘 관계가 아닌 협업 관계로서, 투명한 정보 공유를 통해 업무 효율을 극대화합니다.",
    gradient: "from-blue-500 to-indigo-400",
  },
  {
    icon: Car,
    title: "법인 경비 자동 정산",
    description:
      "차량 주행 기록, 식비 등 현장에서 발생하는 실비 지출을 사진 한 장으로 정산합니다. 법인 운영의 투명성을 확보하고 세무 신고를 자동화합니다.",
    gradient: "from-teal-500 to-cyan-400",
  },
  {
    icon: Users,
    title: "아티스트 팀 그룹웨어",
    description:
      "배우 개인이 아닌 '법인'을 중심으로 팀이 움직입니다. 근태 관리부터 프로젝트 협업까지, 독립 법인에 최적화된 경영 환경을 제공합니다.",
    gradient: "from-success to-emerald-400",
  },
];

export const FeaturesSection = () => {
  return (
    <section className="py-24 relative">
      <div className="container px-4">
        {/* Section Header */}
        <div className="text-center mb-16">
          <h2 className="text-3xl md:text-5xl font-black mb-6 tracking-tight">
            독립 경영을 완성하는
            <br />
            <span className="gradient-text">핵심 인프라 솔루션</span>
          </h2>
          <p className="text-muted-foreground text-lg max-w-3xl mx-auto leading-relaxed">
            ArkPort OS는 단순한 편의 기능을 넘어, 배우 법인의 법적 실체를 보호하고
            <br className="hidden md:block" />
            자립적인 경영이 가능한 완벽한 기술적 환경을 구축합니다.
          </p>
        </div>

        {/* Features Grid */}
        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {features.map((feature, index) => (
            <div
              key={feature.title}
              className="glass-card-hover p-6 group flex flex-col h-full"
              style={{ animationDelay: `${index * 0.05}s` }}
            >
              {/* Icon */}
              <div
                className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${feature.gradient} p-2.5 mb-6 transition-transform group-hover:scale-110 group-hover:rotate-3 shadow-lg`}
              >
                <feature.icon className="w-full h-full text-white" />
              </div>

              {/* Content */}
              <h3 className="text-xl font-bold mb-3 text-foreground group-hover:text-primary transition-colors">
                {feature.title}
              </h3>
              <p className="text-sm text-muted-foreground leading-relaxed flex-1">{feature.description}</p>

              {/* Subtle Arrow for Hover Effect */}
              <div className="mt-6 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                <div className="w-6 h-6 rounded-full bg-secondary flex items-center justify-center">
                  <div className="w-1.5 h-1.5 rounded-full bg-primary animate-pulse" />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
};



============================================================
File Path: src/components/landing/Footer.tsx
============================================================
import { Link } from "react-router-dom";

export const Footer = () => {
  return (
    <footer className="border-t border-border/50 py-16 bg-background">
      <div className="container px-4">
        <div className="grid md:grid-cols-4 gap-12">
          {/* Brand & Mission */}
          <div className="md:col-span-1">
            <Link to="/" className="flex items-center gap-2 mb-6">
              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center shadow-lg shadow-primary/20">
                <span className="text-primary-foreground font-bold text-sm">B</span>
              </div>
              <span className="font-bold text-xl tracking-tight">
                <span className="gradient-text">ArkPort</span> OS
              </span>
            </Link>
            <p className="text-sm text-muted-foreground leading-relaxed mb-4">
              ArkPort OS는 배우 법인의 자립 경영을 지원하는 차세대 운영 인프라입니다. 지휘와 통제가 아닌 기술과 기록으로
              법인의 경영 주권을 보호합니다.
            </p>
            <div className="text-[11px] text-primary font-semibold tracking-wider uppercase">
              The Artist Operating System
            </div>
          </div>

          {/* Product Links */}
          <div>
            <h4 className="font-bold mb-6 text-sm text-foreground">솔루션</h4>
            <ul className="space-y-3">
              <li>
                <Link to="/guest-form" className="text-sm text-muted-foreground hover:text-primary transition-colors">
                  외부 거래처 청구
                </Link>
              </li>
              <li>
                <Link to="/dashboard" className="text-sm text-muted-foreground hover:text-primary transition-colors">
                  법인 경영 대시보드
                </Link>
              </li>
              <li>
                <Link
                  to="/admin/drive-settings"
                  className="text-sm text-muted-foreground hover:text-primary transition-colors"
                >
                  중앙 집중 저장소
                </Link>
              </li>
              <li>
                <Link to="/super-admin" className="text-sm text-muted-foreground hover:text-primary transition-colors">
                  시스템 총괄 관리
                </Link>
              </li>
            </ul>
          </div>

          {/* Feature Links */}
          <div>
            <h4 className="font-bold mb-6 text-sm text-foreground">핵심 기능</h4>
            <ul className="space-y-3">
              <li>
                <span className="text-sm text-muted-foreground hover:text-foreground cursor-default transition-colors">
                  의사결정 및 전자결재
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-foreground cursor-default transition-colors">
                  전사적 감사 로그 (Audit)
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-foreground cursor-default transition-colors">
                  AI 행정 자동화
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-foreground cursor-default transition-colors">
                  독립 파트너십 워크스페이스
                </span>
              </li>
            </ul>
          </div>

          {/* Support Links */}
          <div>
            <h4 className="font-bold mb-6 text-sm text-foreground">지원 및 문의</h4>
            <ul className="space-y-3">
              <li>
                <span className="text-sm text-muted-foreground hover:text-primary cursor-pointer transition-colors">
                  도입 문의 (Sales)
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-primary cursor-pointer transition-colors">
                  운영 가이드 문서
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-primary cursor-pointer transition-colors">
                  API 레퍼런스
                </span>
              </li>
              <li>
                <span className="text-sm text-muted-foreground hover:text-primary cursor-pointer transition-colors">
                  고객 지원 센터
                </span>
              </li>
            </ul>
          </div>
        </div>

        {/* Legal & Copyright */}
        <div className="mt-16 pt-8 border-t border-border/50">
          <div className="flex flex-col md:flex-row items-center justify-between gap-6">
            <div className="text-center md:text-left">
              <p className="text-xs text-muted-foreground mb-2">© 2025 ArkPort Inc. All rights reserved.</p>
              <p className="text-[10px] text-muted-foreground/60 max-w-md leading-normal">
                본 서비스는 각 배우 법인의 독립적인 경영권을 존중하며, 시스템 인프라 및 행정 대행 업무를 기술적으로
                제공합니다. 최종 의사결정과 책임은 해당 법인에 귀속됩니다.
              </p>
            </div>

            <div className="flex gap-8 items-center">
              <span className="text-xs text-muted-foreground hover:text-foreground font-medium cursor-pointer transition-colors">
                이용약관
              </span>
              <span className="text-xs text-muted-foreground hover:text-foreground font-medium cursor-pointer transition-colors">
                개인정보처리방침
              </span>
              <span className="text-xs text-muted-foreground hover:text-foreground font-medium cursor-pointer transition-colors">
                쿠키 설정
              </span>
            </div>
          </div>
        </div>
      </div>
    </footer>
  );
};



============================================================
File Path: src/components/landing/Header.tsx
============================================================
import { useState, useEffect, createContext, useContext } from "react";
import { Link, useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Menu,
  X,
  Search,
  Bell,
  Settings,
  User,
  LogOut,
  CreditCard,
  Building2,
  ChevronDown,
  Users,
  ShieldCheck,
  LayoutDashboard,
  LayoutGrid,
} from "lucide-react";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "sonner";

// Context to prevent duplicate Header rendering inside DashboardLayout
const HeaderRenderedContext = createContext(false);
export const HeaderRenderedProvider = ({ children }: { children: React.ReactNode }) => (
  <HeaderRenderedContext.Provider value={true}>{children}</HeaderRenderedContext.Provider>
);

export const Header = () => {
  const isAlreadyRendered = useContext(HeaderRenderedContext);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const {
    user,
    profile,
    currentTenant,
    memberships,
    setCurrentTenant,
    signOut,
    isSuperAdmin,
    isCompanyAdmin,
    loading,
  } = useAuth();
  const navigate = useNavigate();

  // 권한 상태 확인용 (브라우저 콘솔에서 확인 가능)
  useEffect(() => {
    if (user && !loading) {
      console.log("Header UI Status:", {
        isSuperAdmin,
        isCompanyAdmin,
        tenant: currentTenant?.tenant.name,
      });
    }
  }, [user, loading, isSuperAdmin, isCompanyAdmin, currentTenant]);

  const navLinks = [];

  const handleSignOut = async () => {
    await signOut();
    toast.success("로그아웃되었습니다");
    navigate("/");
  };

  const getInitials = (name: string | null) => {
    if (!name) return "U";
    return name.slice(0, 2);
  };

  // If Header is already rendered by DashboardLayout, skip this instance
  if (isAlreadyRendered) return null;

  return (
    <header className="fixed top-0 left-0 right-0 z-50 bg-card/95 backdrop-blur-xl border-b border-border shadow-sm">
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16 gap-4">
          {/* 1. 로고 섹션 */}
          <Link to="/dashboard" className="flex items-center gap-2 shrink-0">
            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center">
              <span className="text-primary-foreground font-bold text-sm">B</span>
            </div>
            <span className="font-bold text-lg hidden sm:block">
              <span className="gradient-text">ArkPort</span> OS
            </span>
          </Link>

          {/* 2. 회사 선택기 (로그인 시 노출) */}
          {user && memberships.length > 0 && (
            <div className="hidden lg:flex items-center gap-2">
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    className="gap-2 text-sm font-normal min-w-[140px] justify-between border-primary/20 bg-primary/5 hover:bg-primary/10"
                  >
                    <div className="flex items-center gap-2 truncate">
                      <Building2 className="w-4 h-4 text-primary shrink-0" />
                      <span className="truncate font-semibold text-primary">
                        {currentTenant?.tenant.name || "회사 선택"}
                      </span>
                    </div>
                    <ChevronDown className="w-3 h-3 text-primary shrink-0" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="start" className="w-64">
                  <DropdownMenuLabel className="text-xs text-muted-foreground">접속 회사 전환</DropdownMenuLabel>
                  <DropdownMenuSeparator />
                  {memberships.map((membership) => (
                    <DropdownMenuItem
                      key={membership.id}
                      className="cursor-pointer"
                      onClick={() => setCurrentTenant(membership)}
                    >
                      <Building2 className="w-4 h-4 mr-2" />
                      {membership.tenant.name}
                    </DropdownMenuItem>
                  ))}
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          )}

          {/* 3. 검색바 (중앙) */}
          <div className="hidden md:flex flex-1 max-w-md mx-4">
            <div className="relative w-full">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
              <Input
                type="text"
                placeholder="검색어를 입력하세요..."
                className="pl-10 h-9 bg-secondary/50 border-transparent focus:border-primary/30"
              />
            </div>
          </div>

          {/* 4. 내비게이션 & 관리 버튼 세트 (우측) */}
          <div className="flex items-center gap-1 sm:gap-3">
            {/* 기본 메뉴 링크 (데스크탑 전용) */}
            <nav className="hidden xl:flex items-center gap-4 mr-2">
              {navLinks.map((link) => (
                <Link
                  key={link.href}
                  to={link.href}
                  className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
                >
                  {link.label}
                </Link>
              ))}
            </nav>

            {user && !loading && (
              <div className="flex items-center gap-2 mr-2">
                {/* [스크린샷 반영] 슈퍼 어드민 센터 버튼 (빨간색) */}
                {isSuperAdmin && (
                  <Button
                    variant="destructive"
                    size="sm"
                    className="hidden sm:flex items-center gap-1.5 bg-rose-600 hover:bg-rose-700 font-bold h-9 px-4 rounded-lg shadow-sm border-none text-white"
                    onClick={() => navigate("/super-admin")}
                  >
                    <ShieldCheck className="w-4 h-4" />
                    슈퍼 어드민 센터
                  </Button>
                )}

                {/* [스크린샷 반영] 관리 시스템 버튼 (파란색) */}
                {isCompanyAdmin && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="hidden sm:flex items-center gap-1.5 border-primary text-primary hover:bg-primary/5 font-bold h-9 px-4 rounded-lg shadow-sm"
                    onClick={() => navigate("/admin")}
                  >
                    <Settings className="w-4 h-4" />
                    관리 시스템
                  </Button>
                )}
              </div>
            )}

            {user ? (
              <>
                <Button variant="ghost" size="icon" className="w-9 h-9 text-muted-foreground hidden sm:flex">
                  <Bell className="w-5 h-5" />
                </Button>

                {/* 프로필 드롭다운 */}
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" className="gap-2 px-2 h-9 hover:bg-primary/5">
                      <Avatar className="w-7 h-7 border border-primary/20">
                        <AvatarFallback className="bg-primary/10 text-primary text-xs font-bold uppercase">
                          {getInitials(profile?.full_name)}
                        </AvatarFallback>
                      </Avatar>
                      <span className="hidden md:block text-sm font-semibold">{profile?.full_name}</span>
                      <ChevronDown className="w-3 h-3 text-muted-foreground hidden md:block" />
                    </Button>
                  </DropdownMenuTrigger>

                  <DropdownMenuContent align="end" className="w-64 border border-border shadow-xl">
                    <DropdownMenuLabel>
                      <div className="flex flex-col space-y-1">
                        <span className="text-sm font-bold">{profile?.full_name}</span>
                        <span className="text-xs text-muted-foreground font-normal truncate">{profile?.email}</span>
                      </div>
                    </DropdownMenuLabel>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem className="cursor-pointer" onClick={() => navigate("/dashboard")}>
                      <LayoutDashboard className="w-4 h-4 mr-2 text-muted-foreground" /> 대시보드 홈
                    </DropdownMenuItem>
                    <DropdownMenuItem className="cursor-pointer" onClick={() => navigate("/my-page")}>
                      <User className="w-4 h-4 mr-2 text-muted-foreground" /> 마이페이지
                    </DropdownMenuItem>

                    {/* 드롭다운 내 관리자 메뉴 백업 */}
                    {(isSuperAdmin || isCompanyAdmin) && (
                      <>
                        <DropdownMenuSeparator />
                        <DropdownMenuLabel className="text-[10px] font-bold text-primary uppercase px-2 py-2">
                          Quick Access
                        </DropdownMenuLabel>
                        {isSuperAdmin && (
                          <DropdownMenuItem
                            className="text-rose-600 font-bold"
                            onClick={() => navigate("/super-admin")}
                          >
                            <ShieldCheck className="w-4 h-4 mr-2" /> 슈퍼 어드민 센터
                          </DropdownMenuItem>
                        )}
                        {isCompanyAdmin && (
                          <DropdownMenuItem className="text-primary font-bold" onClick={() => navigate("/admin")}>
                            <LayoutGrid className="w-4 h-4 mr-2" /> 통합 관리 센터
                          </DropdownMenuItem>
                        )}
                      </>
                    )}

                    <DropdownMenuSeparator />
                    <DropdownMenuItem className="cursor-pointer">
                      <CreditCard className="w-4 h-4 mr-2" /> 결제 및 구독
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      className="cursor-pointer text-destructive focus:text-destructive"
                      onClick={handleSignOut}
                    >
                      <LogOut className="w-4 h-4 mr-2" /> 로그아웃
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </>
            ) : (
              <div className="flex items-center gap-2">
                <Link to="/auth">
                  <Button variant="ghost" size="sm">
                    로그인
                  </Button>
                </Link>
                <Link to="/auth">
                  <Button variant="default" size="sm" className="bg-primary">
                    시작하기
                  </Button>
                </Link>
              </div>
            )}

            {/* 모바일 메뉴 토글 버튼 */}
            <button className="xl:hidden p-2 text-muted-foreground" onClick={() => setIsMenuOpen(!isMenuOpen)}>
              {isMenuOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
            </button>
          </div>
        </div>
      </div>

      {/* 5. 모바일 메뉴 (반응형) */}
      {isMenuOpen && (
        <div className="xl:hidden border-t border-border bg-card p-4 space-y-4 shadow-inner">
          <nav className="flex flex-col gap-1">
            {navLinks.map((link) => (
              <Link
                key={link.href}
                to={link.href}
                className="px-4 py-3 text-sm font-medium hover:bg-secondary rounded-lg"
                onClick={() => setIsMenuOpen(false)}
              >
                {link.label}
              </Link>
            ))}

            {/* 모바일 버전 관리자 버튼 */}
            {user && (isSuperAdmin || isCompanyAdmin) && (
              <div className="pt-4 mt-2 border-t border-border space-y-2">
                <p className="px-4 text-[10px] font-bold text-muted-foreground uppercase mb-2">관리 도구</p>
                {isSuperAdmin && (
                  <Button
                    variant="destructive"
                    className="w-full justify-start bg-rose-600"
                    onClick={() => {
                      navigate("/super-admin");
                      setIsMenuOpen(false);
                    }}
                  >
                    <ShieldCheck className="w-4 h-4 mr-2" /> 슈퍼 어드민 센터
                  </Button>
                )}
                {isCompanyAdmin && (
                  <Button
                    variant="outline"
                    className="w-full justify-start border-primary text-primary"
                    onClick={() => {
                      navigate("/admin");
                      setIsMenuOpen(false);
                    }}
                  >
                    <Settings className="w-4 h-4 mr-2" /> 관리 시스템
                  </Button>
                )}
              </div>
            )}
          </nav>
        </div>
      )}
    </header>
  );
};



============================================================
File Path: src/components/landing/HeroSection.tsx
============================================================
import { Button } from "@/components/ui/button";
import { ArrowRight, ShieldCheck, Zap } from "lucide-react";
import { Link } from "react-router-dom";

export const HeroSection = () => {
  return (
    <section className="relative min-h-screen flex items-center justify-center overflow-hidden">
      {/* Background Effects - 기존의 세련된 블루 블롭 유지 */}
      <div className="absolute inset-0 bg-gradient-to-b from-background via-background to-primary/5" />
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-gradient-to-r from-primary/15 via-primary/25 to-accent/15 rounded-full blur-[100px]" />
      <div className="absolute top-1/4 right-0 w-[300px] h-[300px] bg-accent/20 rounded-full blur-[80px]" />
      <div className="absolute bottom-1/4 left-0 w-[250px] h-[250px] bg-primary/15 rounded-full blur-[60px]" />

      {/* Grid Pattern */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,hsl(var(--border)/0.5)_1px,transparent_1px),linear-gradient(to_bottom,hsl(var(--border)/0.5)_1px,transparent_1px)] bg-[size:6rem_6rem] opacity-30" />

      <div className="container relative z-10 px-4 py-20 text-center">
        {/* Badge: 운영 헌법 강조 */}
        <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/5 border border-primary/20 backdrop-blur-sm mb-8 animate-fade-in">
          <ShieldCheck className="w-4 h-4 text-primary" />
          <span className="text-sm font-semibold text-primary">Operating Constitution v1.0 준수</span>
        </div>

        {/* Main Heading: 아티스트의 독립성 강조 */}
        <h1 className="text-5xl md:text-7xl lg:text-8xl font-black mb-8 tracking-tighter animate-slide-up leading-[1.1]">
          관리받는 배우에서
          <br />
          <span className="gradient-text">경영하는 아티스트</span>로
        </h1>

        {/* Subtitle: 시스템과 인프라의 가치 전달 */}
        <p
          className="text-lg md:text-2xl text-muted-foreground max-w-3xl mx-auto mb-12 leading-relaxed animate-slide-up font-medium"
          style={{ animationDelay: "0.1s" }}
        >
          BOTEDA OS는 매니지먼트사가 아닙니다.
          <br className="hidden md:block" />
          배우 법인이 스스로 일어서도록 돕는 <strong>기술 인프라</strong>이자 <strong>운영 OS</strong>입니다.
          <br className="hidden md:block" />
          지휘와 통제 대신, <strong>권한과 기록</strong>으로 투명한 경영 환경을 제공합니다.
        </p>

        {/* CTA Buttons */}
        <div
          className="flex flex-col sm:flex-row gap-4 justify-center items-center animate-slide-up"
          style={{ animationDelay: "0.2s" }}
        >
          <Link to="/guest-form">
            <Button variant="hero" size="xl" className="group px-8">
              운영 인프라 도입 문의
              <ArrowRight className="w-5 h-5 transition-transform group-hover:translate-x-1" />
            </Button>
          </Link>
          <Link to="/dashboard">
            <Button variant="glass" size="xl" className="px-8">
              대시보드 미리보기
            </Button>
          </Link>
        </div>

        {/* Stats: 플랫폼의 철학적 수치화 */}
        <div
          className="grid grid-cols-2 md:grid-cols-4 gap-8 mt-24 animate-slide-up border-t border-border/50 pt-12"
          style={{ animationDelay: "0.3s" }}
        >
          {[
            {
              value: "0%",
              label: "의사결정 개입",
              icon: <Zap className="w-4 h-4 text-amber-500" />,
            },
            {
              value: "100%",
              label: "모든 행위 로그화",
              icon: <ShieldCheck className="w-4 h-4 text-blue-500" />,
            },
            {
              value: "No %",
              label: "운영 구조 기반 요금",
              icon: <Zap className="w-4 h-4 text-emerald-500" />,
            },
            {
              value: "Legal",
              label: "세무/노무 리스크 방어",
              icon: <ShieldCheck className="w-4 h-4 text-purple-500" />,
            },
          ].map((stat) => (
            <div key={stat.label} className="text-center group">
              <div className="flex items-center justify-center gap-1 mb-2">
                {stat.icon}
                <div className="text-3xl md:text-4xl font-black text-foreground group-hover:gradient-text transition-all">
                  {stat.value}
                </div>
              </div>
              <div className="text-xs md:text-sm font-bold text-muted-foreground uppercase tracking-wider">
                {stat.label}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
};



============================================================
File Path: src/components/landing/PartnerControl.tsx
============================================================
import { ShieldCheck, UserMinus, Zap, Activity, Database } from "lucide-react";

export const WorkflowIndependence = () => {
  const partners = [
    { name: "A 캐스팅 에이전시", status: "연결됨", activity: "Access Level: Partial", type: "외부 파트너" },
    { name: "B 마케팅사", status: "대기", activity: "Access Level: Denied", type: "외부 파트너" },
    { name: "C 세무회계법인", status: "연결됨", activity: "Access Level: Admin-Only", type: "전문가 파트너" },
  ];

  return (
    <section className="py-20 bg-background">
      <div className="container px-4">
        <div className="flex flex-col md:flex-row gap-12 items-center">
          {/* 왼쪽: 설명 (SaaS 인프라 정체성 강조) */}
          <div className="flex-1">
            <h2 className="text-3xl md:text-4xl font-bold mb-6 tracking-tight">
              회사는 독립되어야 하고,
              <br />
              <span className="gradient-text">경영 데이터는 보호되어야 합니다</span>
            </h2>
            <p className="text-muted-foreground mb-8 leading-relaxed">
              ArkPort OS는 배우 법인이 외부 협업(에이전시, 전문직 등) 시 발생하는 모든 행정 기록을 법인 고유의 자산으로
              격리 보관하는 <strong>클라우드 인프라</strong>입니다. 플랫폼 이용 종료 시에도 모든 데이터는 표준 포맷으로{" "}
              <strong>완전한 이관 및 백업을 보장</strong>합니다.
            </p>
            <div className="space-y-6">
              <div className="flex gap-3 items-start">
                <div className="p-2 rounded-lg bg-primary/10 text-primary shrink-0">
                  <ShieldCheck className="w-5 h-5" />
                </div>
                <div>
                  <div className="font-bold">데이터 소유권 독립 (Data Sovereignty)</div>
                  <div className="text-sm text-muted-foreground mt-1">
                    협업 중 발생하는 모든 시스템 로그와 문서는 오직 법인의 소유입니다. 계약 해지 시 권한 회수 버튼
                    하나로 파트너로부터 데이터를 완벽하게 격리할 수 있습니다.
                  </div>
                </div>
              </div>
              <div className="flex gap-3 items-start">
                <div className="p-2 rounded-lg bg-primary/10 text-primary shrink-0">
                  <Database className="w-5 h-5" />
                </div>
                <div>
                  <div className="font-bold">인프라 구독 모델 (SaaS Subscription)</div>
                  <div className="text-sm text-muted-foreground mt-1">
                    본 서비스는 매출 성과를 공유하지 않는 기술 솔루션입니다. 법인의 운영 규모 및 데이터 보존 리소스에
                    최적화된 엔터프라이즈 플랜을 제공합니다.
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* 오른쪽: 시각화 카드 (IT 보안 시스템 느낌으로 수정) */}
          <div className="flex-1 w-full max-w-md">
            <div className="glass-card p-6 border-primary/20 shadow-2xl shadow-primary/10">
              <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-lg">외부 협업 권한 관리 (Access Control)</h3>
                <span className="text-[10px] bg-primary/10 text-primary px-2 py-1 rounded-full font-bold uppercase tracking-wider">
                  Admin: Actor Company
                </span>
              </div>

              <div className="space-y-4">
                {partners.map((p) => (
                  <div
                    key={p.name}
                    className="flex items-center justify-between p-4 rounded-xl bg-secondary/30 border border-border/50 group hover:border-primary/30 transition-all"
                  >
                    <div className="flex items-center gap-3">
                      <div
                        className={`w-2 h-2 rounded-full ${p.status === "연결됨" ? "bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]" : "bg-slate-400"}`}
                      />
                      <div>
                        <div className="text-sm font-bold">{p.name}</div>
                        <div className="text-[10px] text-muted-foreground font-mono">{p.activity}</div>
                      </div>
                    </div>
                    <button className="text-[10px] flex items-center gap-1 px-2.5 py-1.5 rounded-lg bg-destructive/5 text-destructive border border-destructive/10 hover:bg-destructive hover:text-white transition-all font-bold">
                      <UserMinus className="w-3 h-3" /> 권한 회수
                    </button>
                  </div>
                ))}
              </div>

              {/* 하단 요금제 정보: '공동사업' 느낌을 지우기 위한 SaaS 요금 체계 강조 */}
              <div className="mt-8 pt-6 border-t border-border/50">
                <div className="flex justify-between items-end">
                  <div className="space-y-1">
                    <span className="text-xs text-muted-foreground flex items-center gap-1.5 font-medium font-mono">
                      <Activity className="w-3.5 h-3.5" /> Enterprise Subscription
                    </span>
                    <div className="text-xs font-bold text-foreground">인프라 라이선스 플랜</div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-black text-primary tracking-tight">Tier-based</div>
                    <div className="text-[9px] text-muted-foreground uppercase font-bold">Infrastructure Usage Fee</div>
                  </div>
                </div>
                <div className="mt-4 p-3 rounded-lg bg-secondary/50 border border-border/50 text-[10px] text-muted-foreground leading-normal">
                  ※ ArkPort OS는 법인 운영을 위한 IT 인프라만을 기술적으로 제공하며, 배우 법인과 파트너사 간의 계약,
                  지휘 관계 및 개별 의사결정에는 일체 개입하지 않는 <strong>독립적인 기술 솔루션</strong>입니다.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  );
};



============================================================
File Path: src/components/landing/PricingSection.tsx
============================================================
import { Check, ShieldCheck, Zap, ClipboardCheck } from "lucide-react";

export const PricingSection = () => {
  /**
   * ✅ 전체 수정 반영 (헤더 폭 vs 카드 폭 분리 + 전체 가로 확장)
   * - (중요) 퍼센트/매출 연동 표현은 전면 비노출
   * - Casting Agency X / ArkPort OS / Backoffice / KPI Incentive를 "역할"로 분리
   * - ArkPort는 SaaS(인프라) + 운영 KPI 인센티브(매출 권리 아님)로만 정의
   * - 헤더(문장)는 "좁게" 유지, 카드 그리드(내용)는 "넓게" 사용 → 답답함 해소
   * - 하단 각주도 카드 폭 기준으로 자연스럽게 확장
   */

  const plans = [
    // ✅ 1) Casting Agency X (전면 운영)
    {
      title: "전면 운영 파트너십 (Casting Agency X)",
      pricing: { big: "Custom", sub: "/ 운영 구조 기반" },
      role: "영업·PR·운영 통합 수행",
      description:
        "작품·브랜딩·광고·PR 등 아티스트 활동 전반을 ‘프로젝트 단위’로 통합 수행합니다. 비용은 성과(매출) 공유가 아니라 운영 구조·투입 리소스·활동 구성에 따라 개별 산정됩니다.",
      features: [
        "작품 영업(드라마·영화) 및 계약 조건 협상(프로젝트 단위)",
        "광고/커머셜 세일즈 및 캠페인 운영(프로젝트 단위)",
        "PR/마케팅 운영 및 홍보 채널 커뮤니케이션(업무 범위 명시)",
        "매니저 교육·운영 가이드 및 현장 매니지먼트(옵션)",
        "사무실·회의·촬영 공간 제공(옵션)",
      ],
      border: "border-border",
      bg: "bg-background/50",
      buttonText: "개별 계약 주체",
      iconType: "shield",
      subnote:
        "※ 전속/지휘 관계가 아닌 ‘외부 운영 파트너십’입니다. 계약 범위·기간·투입 인력을 문서로 확정하며, 백오피스·행정은 Boteda 영역으로 분리됩니다.",
    },

    // ✅ 2) ArkPort 정액 - 시스템 관리
    {
      title: "시스템 관리 (ArkPort OS)",
      pricing: { big: "정액", sub: "/ 월·법인 단위" },
      role: "시스템 운영 및 통제",
      description:
        "권한·워크플로우·감사 로그·문서 표준 등 법인 운영 인프라를 제공하고, 모든 행위가 로그로 남는 ‘증거 기반 경영 환경’을 구축합니다.",
      features: [
        "권한 기반 승인·기록(전자결재) 체계",
        "전사적 감사 로그(Audit) 및 증빙 보관",
        "정산·계약·문서 워크플로우 관리",
        "데이터 격리(멀티 테넌트) 및 보안·접근 통제",
      ],
      border: "border-primary/40",
      bg: "bg-primary/5 shadow-2xl shadow-primary/10",
      highlight: true,
      buttonText: "System Subscription",
      iconType: "zap",
      subnote:
        "※ 정액 기반의 인프라 이용료이며, 영업·섭외·계약 체결 대가 또는 매출 권리와 무관합니다. 최종 승인 주체는 항상 ‘배우 법인’입니다.",
    },

    // ✅ 3) ArkPort 정액 - 백오피스(재무/행정/인사)
    {
      title: "백오피스 대행 (Finance · Admin · HR)",
      pricing: { big: "정액", sub: "/ 월 또는 건별" },
      role: "재무·행정·인사 지원",
      description:
        "정산·청구·증빙·기장 보조 등 법인 백오피스 업무를 지원하거나 대행합니다. 의사결정이 아닌 ‘자료·프로세스·증빙 완결성’에 집중합니다.",
      features: [
        "정산·청구·증빙 수집 및 검수",
        "기장·신고용 자료 정리(보조)",
        "지출 관리 및 비용 처리 프로세스 운영",
        "인사·총무 운영 지원(계약·근태·서류)",
      ],
      border: "border-border",
      bg: "bg-background/50",
      buttonText: "업무위탁(대행) 계약",
      iconType: "ops",
      subnote:
        "※ 법무·세무는 1차 자료 정리 및 리스크 체크까지 지원하며, 최종 판단은 외부 전문가 또는 ‘법인 결재’로 진행됩니다.",
    },

    // ✅ 4) ArkPort 성과 인센티브(변동)
    {
      title: "성과 인센티브 (Performance Incentive)",
      pricing: { big: "Variable", sub: "/ KPI 달성 시" },
      role: "운영 성과 보상",
      description:
        "오류·분쟁 감소, 리드타임 단축, 증빙 완결성 향상, 미수·누락 최소화 등 ‘운영 KPI’ 달성 시에만 지급되는 성과 보상입니다.",
      features: [
        "성과 지표 충족 시에만 지급",
        "연 환산 상한(Cap) 설정",
        "KPI·산정 기간을 계약서로 명확화",
        "매출·출연료·계약 금액과 무관한 운영 성과 보상",
      ],
      border: "border-border",
      bg: "bg-background/50",
      buttonText: "성과 인센티브 조항",
      iconType: "shield",
      subnote:
        "※ 성과 인센티브는 정액 비용과 별도로 운영되며, 총 비용에는 상한(Cap)이 설정됩니다. ‘매출 권리’가 아니라 ‘운영 품질 KPI’에 대한 보상입니다.",
    },
  ];

  const iconFor = (iconType: string) => {
    if (iconType === "zap") return <Zap className="w-4 h-4" />;
    if (iconType === "ops") return <ClipboardCheck className="w-4 h-4" />;
    return <ShieldCheck className="w-4 h-4" />;
  };

  return (
    <section className="py-28 relative overflow-hidden">
      {/* ✅ 배경 블러: 무대가 넓어졌으니 블러도 살짝 키움 */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-[140px] -z-10" />

      {/* ✅ 1) 헤더 컨테이너(좁게) */}
      <div className="mx-auto max-w-[920px] px-6">
        <div className="text-center mb-16">
          <h2 className="text-3xl md:text-5xl font-bold mb-4">
            투명한 <span className="gradient-text">운영 분리</span> 구조
          </h2>

          <p className="text-muted-foreground text-lg max-w-3xl mx-auto leading-relaxed">
            매니지먼트 수수료 모델이 아닙니다. <strong>전면 운영(에이전시)</strong>과{" "}
            <strong>시스템·백오피스(ArkPort)</strong>를 분리하여
            <br className="hidden md:block" />
            배우 법인의 <strong>독립성</strong>과 <strong>증거 기반 경영</strong>을 보장합니다.
          </p>

          {/* ✅ “초기 1명 → 다수 확장” 메시지 (리스크 방어용) */}
          <div className="mt-6 text-[12px] text-muted-foreground/70 max-w-3xl mx-auto leading-relaxed">
            ※ ArkPort OS는 특정 1개 법인을 위한 맞춤 구조가 아니라, 동일한 운영 표준을 다수 아티스트/법인에 확장하는
            인프라입니다. 초기에는 단일 법인의 사용 비중이 높을 수 있으나, 동일한 계약·권한·로그 원칙을 기반으로 다수
            법인으로 확장됩니다.
          </div>
        </div>
      </div>

      {/* ✅ 2) 카드/각주 컨테이너(넓게) */}
      <div className="mx-auto max-w-[1920px] px-12">
        {/* 카드 */}
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-10">
          {plans.map((plan) => (
            <div key={plan.title} className={`glass-card px-10 py-12 flex flex-col ${plan.border} ${plan.bg} relative`}>
              {plan.highlight && (
                <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest">
                  ArkPort Core
                </div>
              )}

              <div className="mb-10">
                <div className="text-sm font-bold text-primary mb-2 flex items-center gap-2">
                  {iconFor(plan.iconType)}
                  {plan.role}
                </div>

                <h3 className="text-2xl font-bold mb-4">{plan.title}</h3>

                <div className="flex items-baseline gap-2 mb-2">
                  <span className="text-4xl md:text-5xl font-black tracking-tighter">{plan.pricing.big}</span>
                  <span className="text-muted-foreground font-medium">{plan.pricing.sub}</span>
                </div>

                {plan.subnote && (
                  <div className="text-[11px] text-muted-foreground/70 mb-5 leading-relaxed">{plan.subnote}</div>
                )}

                <p className="text-sm text-muted-foreground leading-relaxed">{plan.description}</p>
              </div>

              <div className="space-y-4 mb-10 flex-1">
                {plan.features.map((feature) => (
                  <div key={feature} className="flex items-center gap-3 text-sm">
                    <Check className="w-4 h-4 text-primary shrink-0" />
                    <span>{feature}</span>
                  </div>
                ))}
              </div>

              <div className="pt-6 border-t border-border/50 text-center">
                <span className="text-xs font-bold text-muted-foreground tracking-widest uppercase">
                  {plan.buttonText}
                </span>
              </div>
            </div>
          ))}
        </div>

        {/* 하단 각주 */}
        <div className="mt-14 text-center space-y-3">
          <p className="text-sm text-muted-foreground">
            * 모든 비용은 배우 기획사(법인)와 각 파트너 간 <strong>독립적 서비스 계약</strong>에 근거하여 집행됩니다.
          </p>

          <p className="text-[11px] text-muted-foreground/60 max-w-5xl mx-auto leading-relaxed">
            Casting Agency X는 프로젝트 단위의 전면 운영을 담당하며, 비용은 성과(매출) 공유가 아닌 운영 구조·활동
            구성·투입 리소스에 따라 개별 산정됩니다.
            <br />
            ArkPort는 시스템 및 백오피스(재무·행정·인사) 지원을 정액 기반으로 수행하며, 성과 인센티브는 운영 KPI 달성
            시에만 적용되고 연 환산 상한(Cap)이 설정됩니다.
            <br />
            모든 최종 승인과 의사결정, 데이터 소유권은 배우 기획사(법인)에 귀속되며, ArkPort는 지휘·통제·개별 계약
            결정에 개입하지 않는 독립 인프라 솔루션입니다.
          </p>
        </div>
      </div>
    </section>
  );
};



============================================================
File Path: src/components/mypage/MailIntegrationTab.tsx
============================================================
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Mail, Shield, CheckCircle2, AlertCircle, Loader2, 
  Trash2, Eye, EyeOff, RefreshCw 
} from "lucide-react";
import { toast } from "sonner";

interface MailConfig {
  id: string;
  provider: string;
  is_active: boolean;
  google_email: string | null;
  nw_client_id: string | null;
  nw_service_account: string | null;
  nw_domain_id: string | null;
  nw_user_id: string | null;
  last_synced_at: string | null;
  created_at: string;
}

interface Props {
  userId: string;
  tenantId: string;
}

export const MailIntegrationTab = ({ userId, tenantId }: Props) => {
  const [configs, setConfigs] = useState<MailConfig[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [testing, setTesting] = useState<string | null>(null);

  // NaverWorks form
  const [nwForm, setNwForm] = useState({
    nw_client_id: "",
    nw_client_secret: "",
    nw_service_account: "",
    nw_private_key: "",
    nw_domain_id: "",
    nw_user_id: "",
  });
  const [showSecret, setShowSecret] = useState(false);
  const [showPrivateKey, setShowPrivateKey] = useState(false);

  useEffect(() => {
    fetchConfigs();
  }, [userId, tenantId]);

  const fetchConfigs = async () => {
    setLoading(true);
    const { data, error } = await supabase
      .from("user_mail_configs")
      .select("id, provider, is_active, google_email, nw_client_id, nw_service_account, nw_domain_id, nw_user_id, last_synced_at, created_at")
      .eq("user_id", userId)
      .eq("tenant_id", tenantId);

    if (!error && data) setConfigs(data as MailConfig[]);
    setLoading(false);
  };

  const maskValue = (val: string | null) => {
    if (!val) return "-";
    if (val.length <= 6) return "****";
    return val.substring(0, 4) + "****" + val.substring(val.length - 4);
  };

  const saveNaverWorks = async () => {
    if (!nwForm.nw_client_id || !nwForm.nw_client_secret || !nwForm.nw_service_account || !nwForm.nw_private_key) {
      toast.error("필수 항목을 모두 입력해주세요.");
      return;
    }
    setSaving(true);
    try {
      const existing = configs.find(c => c.provider === "naverworks");
      if (existing) {
        const { error } = await supabase.from("user_mail_configs").update({
          nw_client_id: nwForm.nw_client_id,
          nw_client_secret: nwForm.nw_client_secret,
          nw_service_account: nwForm.nw_service_account,
          nw_private_key: nwForm.nw_private_key,
          nw_domain_id: nwForm.nw_domain_id,
          nw_user_id: nwForm.nw_user_id,
          is_active: true,
        }).eq("id", existing.id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("user_mail_configs").insert({
          user_id: userId,
          tenant_id: tenantId,
          provider: "naverworks",
          nw_client_id: nwForm.nw_client_id,
          nw_client_secret: nwForm.nw_client_secret,
          nw_service_account: nwForm.nw_service_account,
          nw_private_key: nwForm.nw_private_key,
          nw_domain_id: nwForm.nw_domain_id,
          nw_user_id: nwForm.nw_user_id,
        });
        if (error) throw error;
      }
      toast.success("네이버웍스 연동 정보가 저장되었습니다.");
      setNwForm({ nw_client_id: "", nw_client_secret: "", nw_service_account: "", nw_private_key: "", nw_domain_id: "", nw_user_id: "" });
      await fetchConfigs();
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const handleGmailOAuth = async () => {
    setSaving(true);
    try {
      const redirectUri = `${window.location.origin}/auth/gmail/callback`;
      const res = await supabase.functions.invoke("gmail-oauth", {
        body: { action: "get_auth_url", tenantId, redirectUri },
      });
      if (res.error) throw res.error;
      if (!res.data?.authUrl) throw new Error(res.data?.error || "OAuth URL 생성 실패");
      
      // Store state for CSRF validation
      sessionStorage.setItem("gmail_oauth_state", res.data.state);
      sessionStorage.setItem("gmail_oauth_tenant_id", tenantId);
      
      // Redirect to Google
      window.location.href = res.data.authUrl;
    } catch (e: any) {
      toast.error("Gmail 연동 시작 실패: " + e.message);
      setSaving(false);
    }
  };

  const testConnection = async (configId: string, provider: string) => {
    setTesting(configId);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("인증이 필요합니다.");

      const res = await supabase.functions.invoke("fetch-mail", {
        body: { action: "test", configId, provider },
      });

      if (res.error) throw res.error;
      if (res.data?.success) {
        toast.success(`${provider === "gmail" ? "Gmail" : "네이버웍스"} 연동 테스트 성공!`);
      } else {
        toast.error("연동 실패: " + (res.data?.error || "알 수 없는 오류"));
      }
    } catch (e: any) {
      toast.error("테스트 실패: " + e.message);
    } finally {
      setTesting(null);
    }
  };

  const deleteConfig = async (configId: string) => {
    try {
      const { error } = await supabase.from("user_mail_configs").delete().eq("id", configId);
      if (error) throw error;
      toast.success("연동 정보가 삭제되었습니다.");
      await fetchConfigs();
    } catch (e: any) {
      toast.error("삭제 실패: " + e.message);
    }
  };

  const gmailConfig = configs.find(c => c.provider === "gmail");
  const nwConfig = configs.find(c => c.provider === "naverworks");

  if (loading) {
    return (
      <Card className="border-none shadow-lg rounded-2xl">
        <CardContent className="p-8 text-center">
          <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2 text-primary" />
          <p className="text-muted-foreground text-sm">불러오는 중...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="border-none shadow-xl rounded-[2.5rem] overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-primary/5 to-accent/5 pb-4">
        <CardTitle className="text-lg flex items-center gap-2">
          <Mail className="w-5 h-5 text-primary" /> 메일 연동 설정
        </CardTitle>
        <p className="text-xs text-muted-foreground mt-1">
          외부 메일 서비스를 연동하여 사내 메일함에서 실시간으로 메일을 조회할 수 있습니다.
        </p>
        <div className="flex items-center gap-2 mt-2 p-2.5 rounded-xl bg-amber-50 border border-amber-200 dark:bg-amber-950/30 dark:border-amber-800">
          <Shield className="w-4 h-4 text-amber-600 shrink-0" />
          <p className="text-[11px] text-amber-700 dark:text-amber-400">
            입력된 정보는 암호화 저장되며, 메일 본문은 서버에 저장되지 않습니다. (Stateless 방식)
          </p>
        </div>
      </CardHeader>

      <CardContent className="p-6 md:p-8">
        {/* 연동 현황 */}
        {configs.length > 0 && (
          <div className="mb-8 space-y-3">
            <h3 className="text-sm font-bold text-foreground mb-3">연동 현황</h3>
            {configs.map(config => (
              <div key={config.id} className="flex items-center justify-between p-4 rounded-2xl border border-border/50 bg-muted/30">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold ${
                    config.provider === "gmail" 
                      ? "bg-red-50 text-red-600 dark:bg-red-950/30" 
                      : "bg-green-50 text-green-600 dark:bg-green-950/30"
                  }`}>
                    {config.provider === "gmail" ? "G" : "NW"}
                  </div>
                  <div>
                    <p className="text-sm font-bold">
                      {config.provider === "gmail" ? "Google Gmail" : "네이버웍스"}
                    </p>
                    <p className="text-xs text-muted-foreground">
                      {config.provider === "gmail" 
                        ? config.google_email || "이메일 미등록"
                        : maskValue(config.nw_client_id)
                      }
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Badge variant={config.is_active ? "default" : "secondary"} className="text-[10px]">
                    {config.is_active ? (
                      <><CheckCircle2 className="w-3 h-3 mr-1" /> 활성</>
                    ) : (
                      <><AlertCircle className="w-3 h-3 mr-1" /> 비활성</>
                    )}
                  </Badge>
                  <Button variant="ghost" size="sm" className="h-8 text-xs"
                    onClick={() => testConnection(config.id, config.provider)}
                    disabled={testing === config.id}>
                    {testing === config.id 
                      ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> 
                      : <RefreshCw className="w-3.5 h-3.5" />}
                  </Button>
                  <Button variant="ghost" size="sm" className="h-8 text-xs text-destructive hover:text-destructive"
                    onClick={() => deleteConfig(config.id)}>
                    <Trash2 className="w-3.5 h-3.5" />
                  </Button>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* 새 연동 추가 */}
        <Tabs defaultValue="gmail" className="space-y-4">
          <TabsList className="w-full">
            <TabsTrigger value="gmail" className="flex-1 gap-1.5">
              <span className="text-red-500 font-bold text-xs">G</span> Gmail
            </TabsTrigger>
            <TabsTrigger value="naverworks" className="flex-1 gap-1.5">
              <span className="text-green-500 font-bold text-xs">NW</span> 네이버웍스
            </TabsTrigger>
          </TabsList>

          {/* Gmail 설정 */}
          <TabsContent value="gmail">
            <div className="space-y-4 p-4 rounded-2xl bg-muted/30 border border-border/50">
              {gmailConfig ? (
                <div className="text-center py-4">
                  <CheckCircle2 className="w-8 h-8 text-green-500 mx-auto mb-2" />
                  <p className="text-sm font-medium">Gmail이 이미 연동되어 있습니다.</p>
                  <p className="text-xs text-muted-foreground mt-1">{gmailConfig.google_email}</p>
                  <p className="text-xs text-muted-foreground mt-3">
                    수정하려면 기존 연동을 삭제 후 다시 등록해주세요.
                  </p>
                </div>
              ) : (
                <>
                  <div className="p-3 rounded-xl bg-blue-50 border border-blue-200 dark:bg-blue-950/30 dark:border-blue-800">
                    <p className="text-[11px] text-blue-700 dark:text-blue-400 leading-relaxed">
                      <strong>Gmail 연동 방법:</strong> 아래 버튼을 클릭하면 Google 로그인 화면으로 이동합니다. 
                      로그인 후 메일 읽기 권한을 허용하면 자동으로 연동이 완료됩니다.
                    </p>
                  </div>
                  <Button 
                    onClick={handleGmailOAuth} 
                    disabled={saving} 
                    className="w-full rounded-xl h-12 text-sm font-semibold gap-2"
                  >
                    {saving ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Mail className="w-4 h-4" />
                    )}
                    Google 계정으로 연동하기
                  </Button>
                </>
              )}
            </div>
          </TabsContent>

          {/* 네이버웍스 설정 */}
          <TabsContent value="naverworks">
            <div className="space-y-4 p-4 rounded-2xl bg-muted/30 border border-border/50">
              {nwConfig ? (
                <div className="text-center py-4">
                  <CheckCircle2 className="w-8 h-8 text-green-500 mx-auto mb-2" />
                  <p className="text-sm font-medium">네이버웍스가 이미 연동되어 있습니다.</p>
                  <p className="text-xs text-muted-foreground mt-1">Client ID: {maskValue(nwConfig.nw_client_id)}</p>
                  <p className="text-xs text-muted-foreground mt-3">
                    수정하려면 기존 연동을 삭제 후 다시 등록해주세요.
                  </p>
                </div>
              ) : (
                <>
                  <div className="p-3 rounded-xl bg-green-50 border border-green-200 dark:bg-green-950/30 dark:border-green-800">
                    <p className="text-[11px] text-green-700 dark:text-green-400 leading-relaxed">
                      <strong>네이버웍스 연동 방법:</strong> 네이버웍스 Developer Console에서 
                      Server API 앱을 생성하고, 메일 읽기 권한(mail.read)을 부여한 후, 발급받은 정보를 입력해주세요.
                    </p>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className="space-y-1.5">
                      <Label className="text-xs font-semibold">Client ID <span className="text-destructive">*</span></Label>
                      <Input 
                        placeholder="Client ID" 
                        value={nwForm.nw_client_id}
                        onChange={e => setNwForm({...nwForm, nw_client_id: e.target.value})}
                        className="rounded-xl" 
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label className="text-xs font-semibold">Client Secret <span className="text-destructive">*</span></Label>
                      <div className="relative">
                        <Input 
                          type={showSecret ? "text" : "password"} 
                          placeholder="Client Secret"
                          value={nwForm.nw_client_secret}
                          onChange={e => setNwForm({...nwForm, nw_client_secret: e.target.value})}
                          className="rounded-xl pr-10" 
                        />
                        <button 
                          type="button"
                          onClick={() => setShowSecret(!showSecret)}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
                          {showSecret ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                        </button>
                      </div>
                    </div>
                    <div className="space-y-1.5">
                      <Label className="text-xs font-semibold">Service Account <span className="text-destructive">*</span></Label>
                      <Input 
                        placeholder="xxxxx.serviceaccount@example.com" 
                        value={nwForm.nw_service_account}
                        onChange={e => setNwForm({...nwForm, nw_service_account: e.target.value})}
                        className="rounded-xl" 
                      />
                    </div>
                    <div className="space-y-1.5">
                      <Label className="text-xs font-semibold">Domain ID</Label>
                      <Input 
                        placeholder="Domain ID" 
                        value={nwForm.nw_domain_id}
                        onChange={e => setNwForm({...nwForm, nw_domain_id: e.target.value})}
                        className="rounded-xl" 
                      />
                    </div>
                    <div className="space-y-1.5 md:col-span-2">
                      <Label className="text-xs font-semibold">User ID (메일 사용자)</Label>
                      <Input 
                        placeholder="user@company.com" 
                        value={nwForm.nw_user_id}
                        onChange={e => setNwForm({...nwForm, nw_user_id: e.target.value})}
                        className="rounded-xl" 
                      />
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-xs font-semibold">Private Key <span className="text-destructive">*</span></Label>
                    <div className="relative">
                      <textarea 
                        rows={4}
                        placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"
                        value={nwForm.nw_private_key}
                        onChange={e => setNwForm({...nwForm, nw_private_key: e.target.value})}
                        className="w-full rounded-xl border border-input bg-background px-3 py-2 text-xs font-mono ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-none" 
                        style={{ fontFamily: "monospace" }}
                      />
                      <button 
                        type="button"
                        onClick={() => setShowPrivateKey(!showPrivateKey)}
                        className="absolute right-3 top-3 text-muted-foreground hover:text-foreground">
                        {showPrivateKey ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                      </button>
                    </div>
                  </div>
                  <Button onClick={saveNaverWorks} disabled={saving} className="w-full rounded-xl">
                    {saving ? <Loader2 className="w-4 h-4 animate-spin mr-1.5" /> : <Mail className="w-4 h-4 mr-1.5" />}
                    네이버웍스 연동 저장
                  </Button>
                </>
              )}
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
};



============================================================
File Path: src/components/mypage/MyVehicleTab.tsx
============================================================
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Car, MapPin, Save, Loader2, PenTool, Home, Building,
  Fuel, Calendar, FileText, Route,
} from "lucide-react";
import { toast } from "sonner";

interface VehicleInfo {
  id: string;
  vehicle_number: string | null;
  model_name: string | null;
  manufacturer: string | null;
  fuel_type: string | null;
  ownership_type: string | null;
  lease_company: string | null;
  insurance_company: string | null;
  insurance_end_date: string | null;
  contract_start_date: string | null;
  contract_end_date: string | null;
  initial_mileage: number | null;
  is_active: boolean | null;
}

interface CommuteLocation {
  id?: string;
  home_address: string;
  home_lat: number | null;
  home_lng: number | null;
  office_address: string;
  office_lat: number | null;
  office_lng: number | null;
  distance_km: number | null;
}

interface MyVehicleTabProps {
  userId: string;
  tenantId: string;
}

export const MyVehicleTab = ({ userId, tenantId }: MyVehicleTabProps) => {
  const [vehicle, setVehicle] = useState<VehicleInfo | null>(null);
  const [commute, setCommute] = useState<CommuteLocation | null>(null);
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState<CommuteLocation>({
    home_address: "",
    home_lat: null,
    home_lng: null,
    office_address: "",
    office_lat: null,
    office_lng: null,
    distance_km: null,
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    fetchData();
  }, [userId, tenantId]);

  const fetchData = async () => {
    setLoading(true);
    const [vehicleRes, commuteRes] = await Promise.all([
      supabase
        .from("vehicles")
        .select("id, vehicle_number, model_name, manufacturer, fuel_type, ownership_type, lease_company, insurance_company, insurance_end_date, contract_start_date, contract_end_date, initial_mileage, is_active")
        .eq("tenant_id", tenantId)
        .eq("primary_driver", userId)
        .eq("is_active", true)
        .maybeSingle(),
      supabase
        .from("commute_locations")
        .select("*")
        .eq("user_id", userId)
        .eq("tenant_id", tenantId)
        .maybeSingle(),
    ]);

    if (vehicleRes.data) setVehicle(vehicleRes.data as VehicleInfo);
    if (commuteRes.data) {
      const c = commuteRes.data as any;
      setCommute({
        id: c.id,
        home_address: c.home_address || "",
        home_lat: c.home_lat,
        home_lng: c.home_lng,
        office_address: c.office_address || "",
        office_lat: c.office_lat,
        office_lng: c.office_lng,
        distance_km: c.distance_km,
      });
    }
    setLoading(false);
  };

  const startEdit = () => {
    setForm(
      commute || {
        home_address: "",
        home_lat: null,
        home_lng: null,
        office_address: "",
        office_lat: null,
        office_lng: null,
        distance_km: null,
      }
    );
    setEditing(true);
  };

  const cancelEdit = () => {
    setEditing(false);
  };

  const saveCommute = async () => {
    if (!form.home_address && !form.office_address) {
      toast.error("출근지 또는 퇴근지를 입력해주세요.");
      return;
    }
    setSaving(true);
    try {
      if (commute?.id) {
        const { error } = await supabase
          .from("commute_locations")
          .update({
            home_address: form.home_address || null,
            home_lat: form.home_lat,
            home_lng: form.home_lng,
            office_address: form.office_address || null,
            office_lat: form.office_lat,
            office_lng: form.office_lng,
            distance_km: form.distance_km,
          })
          .eq("id", commute.id);
        if (error) throw error;
      } else {
        const { error } = await supabase
          .from("commute_locations")
          .insert({
            user_id: userId,
            tenant_id: tenantId,
            home_address: form.home_address || null,
            home_lat: form.home_lat,
            home_lng: form.home_lng,
            office_address: form.office_address || null,
            office_lat: form.office_lat,
            office_lng: form.office_lng,
            distance_km: form.distance_km,
          });
        if (error) throw error;
      }
      toast.success("출퇴근지 정보가 저장되었습니다.");
      setEditing(false);
      await fetchData();
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const InfoRow = ({ label, value, icon }: { label: string; value: string | null | undefined; icon?: React.ReactNode }) => (
    <div className="flex justify-between items-center py-2.5 border-b border-border/50 last:border-0">
      <span className="text-xs font-semibold text-muted-foreground flex items-center gap-1.5">
        {icon}
        {label}
      </span>
      <span className="text-sm text-right">{value || "-"}</span>
    </div>
  );

  if (loading) {
    return (
      <Card className="border-none shadow-lg rounded-2xl">
        <CardContent className="p-12 flex justify-center">
          <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
        </CardContent>
      </Card>
    );
  }

  if (!vehicle) {
    return (
      <Card className="border-none shadow-lg rounded-2xl">
        <CardContent className="p-12 text-center">
          <Car className="w-12 h-12 mx-auto text-muted-foreground/30 mb-3" />
          <p className="text-muted-foreground text-sm">배정된 차량이 없습니다.</p>
          <p className="text-muted-foreground/60 text-xs mt-1">
            차량 관리 대장에서 운행자로 지정되면 여기에 표시됩니다.
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* 배정 차량 정보 */}
      <Card className="border-none shadow-lg rounded-2xl">
        <CardHeader className="pb-3">
          <CardTitle className="text-base flex items-center gap-2">
            <Car className="w-4 h-4 text-primary" /> 배정 차량 정보
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-0">
          <div className="flex items-center gap-3 mb-4 p-3 rounded-xl bg-primary/5 border border-primary/10">
            <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
              <Car className="w-5 h-5 text-primary" />
            </div>
            <div className="flex-1">
              <p className="font-bold text-sm">
                {vehicle.manufacturer} {vehicle.model_name}
              </p>
              <p className="text-xs text-muted-foreground">{vehicle.vehicle_number}</p>
            </div>
            <Badge variant={vehicle.is_active ? "default" : "secondary"}>
              {vehicle.is_active ? "운행중" : "미사용"}
            </Badge>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div>
              <InfoRow label="차량번호" value={vehicle.vehicle_number} />
              <InfoRow label="차종" value={`${vehicle.manufacturer || ""} ${vehicle.model_name || ""}`} icon={<Car className="w-3 h-3" />} />
              <InfoRow label="유류" value={vehicle.fuel_type} icon={<Fuel className="w-3 h-3" />} />
              <InfoRow label="소유형태" value={vehicle.ownership_type} />
            </div>
            <div>
              <InfoRow label="리스사" value={vehicle.lease_company} />
              <InfoRow label="보험사" value={vehicle.insurance_company} />
              <InfoRow label="보험 만기" value={vehicle.insurance_end_date} icon={<Calendar className="w-3 h-3" />} />
              <InfoRow label="계약기간" value={
                vehicle.contract_start_date && vehicle.contract_end_date
                  ? `${vehicle.contract_start_date} ~ ${vehicle.contract_end_date}`
                  : null
              } />
            </div>
          </div>
        </CardContent>
      </Card>

      {/* 출퇴근지 등록 */}
      <Card className="border-none shadow-lg rounded-2xl">
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-base flex items-center gap-2">
              <Route className="w-4 h-4 text-primary" /> 출퇴근지 정보
            </CardTitle>
            {!editing && (
              <Button variant="outline" size="sm" onClick={startEdit}>
                <PenTool className="w-3.5 h-3.5 mr-1" /> {commute ? "수정" : "등록"}
              </Button>
            )}
          </div>
          <p className="text-xs text-muted-foreground mt-1">
            차량 운행 정산서 자동 생성 시 출퇴근 경로 계산에 사용됩니다.
          </p>
        </CardHeader>
        <CardContent className="pt-0">
          {editing ? (
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-3 p-4 rounded-xl border border-border bg-muted/30">
                  <div className="flex items-center gap-2 text-sm font-semibold">
                    <Home className="w-4 h-4 text-primary" /> 자택 (출근지)
                  </div>
                  <div>
                    <Label className="text-xs">주소</Label>
                    <Input
                      value={form.home_address}
                      onChange={(e) => setForm({ ...form, home_address: e.target.value })}
                      placeholder="자택 주소 입력"
                      className="mt-1"
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-xs">위도</Label>
                      <Input
                        type="number"
                        step="any"
                        value={form.home_lat ?? ""}
                        onChange={(e) => setForm({ ...form, home_lat: e.target.value ? Number(e.target.value) : null })}
                        placeholder="37.xxx"
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label className="text-xs">경도</Label>
                      <Input
                        type="number"
                        step="any"
                        value={form.home_lng ?? ""}
                        onChange={(e) => setForm({ ...form, home_lng: e.target.value ? Number(e.target.value) : null })}
                        placeholder="127.xxx"
                        className="mt-1"
                      />
                    </div>
                  </div>
                </div>

                <div className="space-y-3 p-4 rounded-xl border border-border bg-muted/30">
                  <div className="flex items-center gap-2 text-sm font-semibold">
                    <Building className="w-4 h-4 text-primary" /> 사무실 (퇴근지)
                  </div>
                  <div>
                    <Label className="text-xs">주소</Label>
                    <Input
                      value={form.office_address}
                      onChange={(e) => setForm({ ...form, office_address: e.target.value })}
                      placeholder="사무실 주소 입력"
                      className="mt-1"
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-xs">위도</Label>
                      <Input
                        type="number"
                        step="any"
                        value={form.office_lat ?? ""}
                        onChange={(e) => setForm({ ...form, office_lat: e.target.value ? Number(e.target.value) : null })}
                        placeholder="37.xxx"
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label className="text-xs">경도</Label>
                      <Input
                        type="number"
                        step="any"
                        value={form.office_lng ?? ""}
                        onChange={(e) => setForm({ ...form, office_lng: e.target.value ? Number(e.target.value) : null })}
                        placeholder="127.xxx"
                        className="mt-1"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="max-w-xs">
                <Label className="text-xs">편도 거리 (km)</Label>
                <Input
                  type="number"
                  step="0.1"
                  value={form.distance_km ?? ""}
                  onChange={(e) => setForm({ ...form, distance_km: e.target.value ? Number(e.target.value) : null })}
                  placeholder="편도 출퇴근 거리"
                  className="mt-1"
                />
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <Button variant="ghost" size="sm" onClick={cancelEdit}>취소</Button>
                <Button size="sm" onClick={saveCommute} disabled={saving}>
                  {saving ? <Loader2 className="w-3.5 h-3.5 mr-1 animate-spin" /> : <Save className="w-3.5 h-3.5 mr-1" />}
                  저장
                </Button>
              </div>
            </div>
          ) : commute ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
              <div>
                <InfoRow label="자택 주소" value={commute.home_address} icon={<Home className="w-3 h-3" />} />
                {commute.home_lat && commute.home_lng && (
                  <InfoRow label="좌표" value={`${commute.home_lat}, ${commute.home_lng}`} icon={<MapPin className="w-3 h-3" />} />
                )}
              </div>
              <div>
                <InfoRow label="사무실 주소" value={commute.office_address} icon={<Building className="w-3 h-3" />} />
                {commute.office_lat && commute.office_lng && (
                  <InfoRow label="좌표" value={`${commute.office_lat}, ${commute.office_lng}`} icon={<MapPin className="w-3 h-3" />} />
                )}
              </div>
              {commute.distance_km && (
                <div className="col-span-full mt-2">
                  <InfoRow label="편도 거리" value={`${commute.distance_km} km`} icon={<Route className="w-3 h-3" />} />
                </div>
              )}
            </div>
          ) : (
            <div className="text-center py-6">
              <MapPin className="w-8 h-8 mx-auto text-muted-foreground/30 mb-2" />
              <p className="text-sm text-muted-foreground">등록된 출퇴근지가 없습니다.</p>
              <p className="text-xs text-muted-foreground/60 mt-1">
                출퇴근지를 등록하면 차량 운행 정산서 자동 생성에 활용됩니다.
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
};



============================================================
File Path: src/components/profile/PortalDocTemplate.tsx
============================================================
import type { Artist, Employee, TenantInfo, ExtraInfo } from "@/pages/ProfileManagement";

interface Props {
  type: "naver" | "daum" | "certificate";
  artist: Artist | null;
  employee: Employee | null;
  tenantInfo: TenantInfo;
  extraInfo: ExtraInfo;
}

const pageStyle: React.CSSProperties = {
  width: "210mm",
  minHeight: "297mm",
  backgroundColor: "white",
  color: "black",
  fontFamily: "'Malgun Gothic', 'Dotum', sans-serif",
  padding: "15mm 15mm",
  boxSizing: "border-box",
  position: "relative",
  lineHeight: "1.4",
};

const tableStyle: React.CSSProperties = {
  width: "100%",
  borderCollapse: "collapse",
  fontSize: "10pt",
  marginBottom: "5px",
  borderTop: "2px solid black",
};

const thStyle: React.CSSProperties = {
  border: "1px solid #000",
  backgroundColor: "#e8e8e8",
  padding: "6px 2px",
  textAlign: "center",
  fontWeight: "bold",
  wordBreak: "keep-all",
  verticalAlign: "middle",
};

const tdStyle: React.CSSProperties = {
  border: "1px solid #000",
  padding: "6px 5px",
  textAlign: "center",
  verticalAlign: "middle",
};

const tdLeftStyle: React.CSSProperties = {
  border: "1px solid #000",
  padding: "8px",
  textAlign: "left",
  verticalAlign: "middle",
  lineHeight: "1.6",
};

const SignatureInline = ({ url }: { url?: string | null }) => {
  if (!url) return null;
  return (
    <img
      src={url}
      alt="서명"
      style={{ maxHeight: "40px", maxWidth: "100px", verticalAlign: "middle", display: "inline-block" }}
    />
  );
};

// ========== NAVER ==========
const NaverTemplate = ({ artist, employee, tenantInfo, extraInfo }: Omit<Props, "type">) => {
  if (!artist || !employee) return <p style={{ padding: "40px", textAlign: "center" }}>배우와 담당자를 선택해주세요.</p>;
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth() + 1, d = today.getDate();
  const startDate = `${y}년 ${m}월 ${d}일`;
  const endObj = new Date(y + 3, today.getMonth(), today.getDate());
  const endDate = `${endObj.getFullYear()}년 ${endObj.getMonth() + 1}월 ${endObj.getDate()}일`;

  return (
    <>
      <div style={pageStyle}>
        <h1 style={{ fontSize: "22pt", fontWeight: "bold", textAlign: "center", marginBottom: "30px" }}>
          인물정보 등 관리 위임장
        </h1>

        {/* 위임인 테이블 */}
        <table style={tableStyle}>
          <tbody>
            <tr>
              <th style={{ ...thStyle, width: "60px" }} rowSpan={5}>본인<br />(위임인)</th>
              <th style={{ ...thStyle, width: "80px" }}>본명</th>
              <td style={tdStyle}>{artist.name}</td>
              <th style={{ ...thStyle, width: "80px" }}>생년월일</th>
              <td style={tdStyle}>{artist.birth_date?.replace(/-/g, "")}</td>
              <th style={{ ...thStyle, width: "50px" }}>성별</th>
              <td style={tdStyle}>{artist.gender === "male" ? "남" : artist.gender === "female" ? "여" : ""}</td>
            </tr>
            <tr>
              <th style={thStyle}>전화번호</th>
              <td style={tdStyle} colSpan={2}>{artist.contact_phone}</td>
              <th style={thStyle}>이메일</th>
              <td style={tdStyle} colSpan={2}>{artist.email}</td>
            </tr>
            <tr>
              <th style={thStyle}>예명/그룹명</th>
              <td style={tdStyle} colSpan={5}>
                {artist.name} {artist.stage_name && artist.stage_name !== artist.name ? `(${artist.stage_name})` : ""}
              </td>
            </tr>
            <tr>
              <th style={thStyle}>위임내용</th>
              <td style={tdLeftStyle} colSpan={5}>
                <p>- 네이버 인물정보 서비스에서 본인의 인물정보가 제공되는 것과 관련, 네이버㈜를 상대로
                  그 인물정보의 등록, 수정 또는 삭제를 단독으로 신청하는 것에 관한 일체의 업무</p>
                <p style={{ marginTop: "6px" }}>- 네이버㈜를 상대로 본인의 명예, 사생활, 저작권 등 권리를 침해하는, 게시물 등 검색결과
                  의 제외(게시중단 포함) 또는 검색어의 제외를 단독으로 요청하는 것에 관한 일체의 업무</p>
              </td>
            </tr>
            <tr>
              <th style={thStyle}>위임기간</th>
              <td style={tdLeftStyle} colSpan={5}>
                <p>{startDate} ~ {endDate} (최단 1주일에서 최장 36개월)</p>
                <p style={{ fontSize: "8pt", color: "#555", marginTop: "4px" }}>
                  ※ 본 위임을 철회하신 경우 인물정보 고객센터로 알려주셔야 하며, 그 전까지는 기재된 위임기간이 경과하지 않은 한 대리인의 관리권한이 유효한 것으로 간주됩니다.
                </p>
              </td>
            </tr>
          </tbody>
        </table>

        <div style={{ height: "16px" }} />

        {/* 대리인 테이블 */}
        <table style={tableStyle}>
          <tbody>
            <tr>
              <th style={{ ...thStyle, width: "60px" }} rowSpan={6}>대리인<br />(수임인)</th>
              <th style={{ ...thStyle, width: "80px" }}>성명</th>
              <td style={tdStyle} colSpan={2}>{employee.full_name}</td>
              <th style={{ ...thStyle, width: "80px" }}>생년월일</th>
              <td style={tdStyle}>{extraInfo.empBirth?.replace(/-/g, "")}</td>
            </tr>
            <tr>
              <th style={thStyle}>전화번호</th>
              <td style={tdStyle} colSpan={2}>{employee.phone}</td>
              <th style={thStyle}>이메일</th>
              <td style={tdStyle}>{employee.email}</td>
            </tr>
            <tr>
              <th style={thStyle}>본인과의 관계</th>
              <td style={tdStyle} colSpan={4}>{extraInfo.relation} ({tenantInfo.name})</td>
            </tr>
            <tr>
              <th style={thStyle}>본인참여 ID</th>
              <td style={tdLeftStyle} colSpan={4}>
                <p>(관리권한을 행사할 네이버 ID로서, 실명 확인 필수)</p>
                <p style={{ fontSize: "8pt", color: "#d00", marginTop: "4px" }}>
                  ※ 신청자 정보(ID, 성명)와 동일하지 않을 시 권한신청이 보류될 수 있으니 작성 시 주의해주세요!
                </p>
              </td>
            </tr>
            <tr>
              <th style={thStyle}>정보수집 동의</th>
              <td style={tdLeftStyle} colSpan={4}>
                <p style={{ fontSize: "8.5pt" }}>
                  ※ 대리인(수임인)은 본 위임장 제출 과정에서 대리인의 이름, 생년월일, 전화번호,
                  이메일, 본인과의 관계, 네이버 ID, 아래 위임관계 증빙용 필수 제출 서류가 네이버
                  ㈜에 의해 수집되어, 상기 본인의 인물정보 등록, 수정, 삭제를 위해 이용되며, 위
                  임에 의한 신청 또는 요청 처리 이력, 불만 처리 이력 등은 분쟁 해결을 위해 필요
                  한 기록 보관을 목적으로 서비스 이용기간 또는 관련 법령에 따라 보관되는 것에 동의하십니까?
                </p>
                <p style={{ marginTop: "8px", fontWeight: "bold" }}>동의합니다. ( V )</p>
                <p style={{ fontSize: "8pt", color: "#d00", backgroundColor: "#ffff00", display: "inline-block", padding: "2px 4px", marginTop: "4px" }}>
                  괄호안에 동의체크 " V " 해주셔야 정상 처리됩니다.
                </p>
              </td>
            </tr>
          </tbody>
        </table>

        {/* 본문 */}
        <div style={{ marginTop: "20px", fontSize: "9.5pt", lineHeight: "1.7" }}>
          <p>본인(위임인)은 네이버 인물정보 등 서비스에서의 본인의 인물정보 등의 관리에 관하여 상기 위임내용
            상의 일체의 업무를 상기 대리인(수임인)에게 위임합니다.</p>
          <p style={{ marginTop: "8px" }}>본인(위임인)은 대리인(수임인)이 그의 관리권한이 유효하게 존속하는 기간 중 네이버㈜를 상대로 신청
            또는 요청한 사항이 추후 사실이 아님이 밝혀질 경우 그로 인해 발생하는 책임을 본인이 부담할 것임
            을 확인합니다.</p>
        </div>

        {/* 날짜/서명 */}
        <div style={{ marginTop: "40px", fontSize: "16pt", fontWeight: "bold", textAlign: "center" }}>
          {y}  년    {m}  월    {d}  일
        </div>
        <div style={{ display: "flex", justifyContent: "center", alignItems: "center", fontSize: "12pt", gap: "10px", marginTop: "20px" }}>
          <span>본인(위임인)</span>
          <span style={{ position: "relative" }}>
            {artist.name} (인)
            <SignatureInline url={artist.signature_url} />
          </span>
          <span>(날인 또는 서명)</span>
        </div>
      </div>

      {/* 증빙 서류 페이지 */}
      <AttachmentPage artist={artist} />
    </>
  );
};

// ========== DAUM ==========
const DaumTemplate = ({ artist, employee, tenantInfo, extraInfo }: Omit<Props, "type">) => {
  if (!artist || !employee) return <p style={{ padding: "40px", textAlign: "center" }}>배우와 담당자를 선택해주세요.</p>;
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth() + 1, d = today.getDate();
  const startDate = `${y}년 ${m}월 ${d}일`;
  const endObj = new Date(y + 3, today.getMonth(), today.getDate());
  const endDate = `${endObj.getFullYear()}년 ${endObj.getMonth() + 1}월 ${endObj.getDate()}일`;

  return (
    <>
      <div style={pageStyle}>
        <h1 style={{ fontSize: "22pt", fontWeight: "bold", textAlign: "center", marginBottom: "30px", letterSpacing: "5px" }}>
          위 임 장(개인)
        </h1>

        {/* 위임인 */}
        <table style={tableStyle}>
          <tbody>
            <tr>
              <th style={{ ...thStyle, width: "60px" }} rowSpan={5}>위임인</th>
              <th style={{ ...thStyle, width: "90px" }}>성명</th>
              <td style={tdStyle}>
                {artist.name} (인) <SignatureInline url={artist.signature_url} />
              </td>
              <th style={{ ...thStyle, width: "80px" }}>생년월일</th>
              <td style={tdStyle}>{artist.birth_date?.replace(/-/g, ". ")}</td>
            </tr>
            <tr>
              <th style={thStyle}>주소</th>
              <td style={tdStyle} colSpan={3}>{artist.address}</td>
            </tr>
            <tr>
              <th style={thStyle}>전화번호</th>
              <td style={tdStyle} colSpan={3}>{artist.contact_phone}</td>
            </tr>
            <tr>
              <th style={thStyle}>프로필 이름</th>
              <td style={tdStyle} colSpan={3}>{artist.name}</td>
            </tr>
            <tr>
              <th style={thStyle}>위임기간</th>
              <td style={tdLeftStyle} colSpan={3}>
                <p>{startDate} 부터 {endDate} (최장 3년 이내로 가능)</p>
                <p style={{ fontSize: "8pt", color: "#555", marginTop: "4px" }}>
                  (※ 기한을 명시하지 않았거나 3년이 넘는 경우, 위임일로부터 3년간으로 일괄 적용함
                  ※ 위임기간은 인물검색 등 kakao에서 운영하는 서비스에 프로필정보가 사용되는 기간과 상이할 수 있으며,
                  프로필 정보가 사용 및 보존되는 기간은 개인정보처리방침에 따름)
                </p>
              </td>
            </tr>
            <tr>
              <th style={thStyle} colSpan={1}>&nbsp;</th>
              <th style={thStyle}>이용서비스</th>
              <td style={tdStyle} colSpan={3}>마이프로필(인물검색 프로필 수정 서비스)</td>
            </tr>
          </tbody>
        </table>

        <div style={{ height: "16px" }} />

        {/* 수임인 */}
        <table style={tableStyle}>
          <tbody>
            <tr>
              <th style={{ ...thStyle, width: "60px" }} rowSpan={4}>수임인<br />(대리인)</th>
              <th style={{ ...thStyle, width: "90px" }}>성명(법인명)</th>
              <td style={tdStyle}>{employee.full_name} (인)</td>
              <th style={{ ...thStyle, width: "100px" }}>생년월일<br />(법인인 경우 사업자등록번호)</th>
              <td style={tdStyle}>{extraInfo.empBirth?.replace(/-/g, ". ")}</td>
            </tr>
            <tr>
              <th style={thStyle}>주소</th>
              <td style={tdStyle} colSpan={3}>{extraInfo.empAddress}</td>
            </tr>
            <tr>
              <th style={thStyle}>위임인과의 관계</th>
              <td style={tdStyle} colSpan={3}>{extraInfo.relation} ({tenantInfo.name})</td>
            </tr>
          </tbody>
        </table>

        {/* 위임 본문 */}
        <div style={{ marginTop: "20px", fontSize: "9.5pt", lineHeight: "1.8", border: "1px solid #000", padding: "12px" }}>
          상기 위임인 <strong>{artist.name}</strong> 은 인물검색을 포함하여, kakao에서 운영하는 모든 서비스에서 사용되게 할 목적으로
          위임인의 프로필 정보를 마이프로필(인물검색 프로필 등록 및 수정 서비스)을 통하여 kakao에 제공함과 관련한
          모든 권한(개인정보의 열람, 제공, 등록·정정·삭제, 처리정지 요구 포함)을 수임인 <strong>{employee.full_name}</strong> 에게 위임합니다.
          위임 기간 중 수임인의 요청으로 수정, 등록, 삭제되는 프로필 정보로 인해 발생하는 문제는 위임인 본인이 모든 책임을 지고,
          kakao에 민, 형사상 어떠한 이의도 하지 않을 것을 확인하였습니다.
        </div>

        {/* 첨부서류 안내 */}
        <p style={{ fontSize: "10pt", fontWeight: "bold", marginTop: "20px" }}>*진위확인 및 관계증명을 위한 첨부서류</p>
        <table style={{ ...tableStyle, marginTop: "6px" }}>
          <thead>
            <tr>
              <th style={thStyle}>구분</th>
              <th style={thStyle}>본인(위임인)</th>
              <th style={thStyle}>가족</th>
              <th style={thStyle}>소속사</th>
              <th style={thStyle}>기타대리인</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th style={thStyle}>첨부서류</th>
              <td style={{ ...tdLeftStyle, fontSize: "8pt" }}>-신분증 사본</td>
              <td style={{ ...tdLeftStyle, fontSize: "8pt" }}>-위임인의 신분증 사본<br />-가족관계증명서와 의료보험증 사본 중 택 1</td>
              <td style={{ ...tdLeftStyle, fontSize: "8pt" }}>-위임인의 신분증 사본<br />-사업자등록증, 수임인의 재직증명서, 위임인의 인감증명서 중 택 1</td>
              <td style={{ ...tdLeftStyle, fontSize: "8pt" }}>-위임인의 신분증 사본<br />-위임인의 인감증명서</td>
            </tr>
          </tbody>
        </table>

        {/* 날짜/서명 */}
        <div style={{ marginTop: "40px", textAlign: "right", fontSize: "11pt" }}>
          <p>{y} 년   {m} 월   {d} 일</p>
          <p style={{ marginTop: "12px" }}>
            위임인       {artist.name}       (인) <SignatureInline url={artist.signature_url} />
          </p>
        </div>
      </div>

      {/* 증빙 서류 페이지 */}
      <AttachmentPage artist={artist} />
    </>
  );
};

// ========== CERTIFICATE ==========
const CertificateTemplate = ({ employee, tenantInfo, extraInfo }: Omit<Props, "type" | "artist">) => {
  if (!employee) return <p style={{ padding: "40px", textAlign: "center" }}>직원을 선택해주세요.</p>;
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth() + 1, d = today.getDate();

  return (
    <div style={pageStyle}>
      <h1 style={{ fontSize: "28pt", fontWeight: "bold", textAlign: "center", marginBottom: "50px", letterSpacing: "5px" }}>
        재 직 증 명 서
      </h1>

      <h3 style={{ fontSize: "12pt", fontWeight: "bold", marginBottom: "8px" }}>1. 인적사항</h3>
      <table style={tableStyle}>
        <tbody>
          <tr>
            <th style={{ ...thStyle, width: "100px" }}>성 명</th>
            <td style={tdStyle}>{employee.full_name}</td>
            <th style={{ ...thStyle, width: "100px" }}>생년월일</th>
            <td style={tdStyle}>{extraInfo.empBirth}</td>
          </tr>
          <tr>
            <th style={thStyle}>주 소</th>
            <td style={tdStyle} colSpan={3}>{extraInfo.empAddress}</td>
          </tr>
        </tbody>
      </table>

      <h3 style={{ fontSize: "12pt", fontWeight: "bold", marginTop: "24px", marginBottom: "8px" }}>2. 재직사항</h3>
      <table style={tableStyle}>
        <tbody>
          <tr>
            <th style={{ ...thStyle, width: "100px" }}>소 속</th>
            <td style={tdStyle}>{tenantInfo.name}</td>
            <th style={{ ...thStyle, width: "100px" }}>부 서</th>
            <td style={tdStyle}>{employee.department || "-"}</td>
          </tr>
          <tr>
            <th style={thStyle}>직 위</th>
            <td style={tdStyle}>{employee.job_title || "매니저"}</td>
            <th style={thStyle}>재직기간</th>
            <td style={tdStyle}>
              {employee.join_date ? new Date(employee.join_date).toLocaleDateString() : "입사일 미상"} ~ 현재
            </td>
          </tr>
        </tbody>
      </table>

      <h3 style={{ fontSize: "12pt", fontWeight: "bold", marginTop: "24px", marginBottom: "8px" }}>3. 발급용도</h3>
      <table style={tableStyle}>
        <tbody>
          <tr>
            <th style={{ ...thStyle, width: "100px" }}>용 도</th>
            <td style={tdStyle}>{extraInfo.usage}</td>
          </tr>
        </tbody>
      </table>

      <div style={{ marginTop: "60px", textAlign: "center", fontSize: "12pt", lineHeight: "2" }}>
        <p>상기 인은 위와 같이 당사에 재직하고 있음을 증명합니다.</p>
      </div>

      <div style={{ marginTop: "60px", textAlign: "center" }}>
        <p style={{ fontSize: "16pt", fontWeight: "bold" }}>{y}년  {m}월  {d}일</p>
        <p style={{ fontSize: "14pt", fontWeight: "bold", marginTop: "30px" }}>{tenantInfo.name}</p>
        <p style={{ fontSize: "12pt", marginTop: "10px" }}>대표이사    {tenantInfo.rep_name || "(대표자명)"}    (인)</p>
        <p style={{ fontSize: "9pt", color: "#666", marginTop: "10px" }}>{tenantInfo.address}</p>
      </div>
    </div>
  );
};

// ========== 증빙 서류 첨부 페이지 ==========
const AttachmentPage = ({ artist }: { artist: Artist }) => (
  <div style={{ ...pageStyle }} className="page-break-before-always">
    <h2 style={{ fontSize: "16pt", fontWeight: "bold", textAlign: "center", marginBottom: "30px" }}>
      첨부 서류 (증빙)
    </h2>
    <div style={{ display: "flex", gap: "20px", flexDirection: "column" }}>
      <div>
        <h3 style={{ fontSize: "12pt", fontWeight: "bold", marginBottom: "10px" }}>1. 위임인(배우) 신분증 사본</h3>
        <div style={{ border: "1px solid #ccc", minHeight: "300px", display: "flex", alignItems: "center", justifyContent: "center", padding: "20px" }}>
          {artist.id_card_masked_url || artist.id_card_url ? (
            <img
              src={artist.id_card_masked_url || artist.id_card_url}
              alt="신분증 사본"
              style={{ maxWidth: "100%", maxHeight: "400px" }}
            />
          ) : (
            <p style={{ color: "#999" }}>신분증 이미지가 등록되지 않았습니다.</p>
          )}
        </div>
      </div>
      <div>
        <h3 style={{ fontSize: "12pt", fontWeight: "bold", marginBottom: "10px" }}>2. 수임인(대리인) 신분증 사본</h3>
        <div style={{ border: "1px solid #ccc", minHeight: "300px", display: "flex", alignItems: "center", justifyContent: "center", padding: "20px" }}>
          <p style={{ color: "#999" }}>이곳에 대리인 신분증을 부착하세요.</p>
        </div>
      </div>
    </div>
  </div>
);

// ========== MAIN EXPORT ==========
export const PortalDocTemplate = ({ type, artist, employee, tenantInfo, extraInfo }: Props) => {
  if (type === "certificate") {
    return <CertificateTemplate employee={employee} tenantInfo={tenantInfo} extraInfo={extraInfo} />;
  }
  if (type === "daum") {
    return <DaumTemplate artist={artist} employee={employee} tenantInfo={tenantInfo} extraInfo={extraInfo} />;
  }
  return <NaverTemplate artist={artist} employee={employee} tenantInfo={tenantInfo} extraInfo={extraInfo} />;
};



============================================================
File Path: src/components/schedule/ScheduleCalendar.tsx
============================================================
import { useState, useMemo } from "react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  ChevronLeft, ChevronRight, Calendar as CalendarIcon, LayoutGrid,
} from "lucide-react";
import {
  format, startOfMonth, endOfMonth, startOfWeek, endOfWeek,
  addMonths, subMonths, addWeeks, subWeeks, eachDayOfInterval,
  isSameMonth, isSameDay, isToday,
} from "date-fns";
import { ko } from "date-fns/locale";

interface ScheduleEvent {
  id: string;
  artist_id: string;
  title: string;
  start_time: string;
  end_time: string;
  is_all_day: boolean;
  schedule_type: string;
  location: string | null;
  artist?: { id: string; name: string; stage_name: string | null };
}

interface ScheduleCalendarProps {
  schedules: ScheduleEvent[];
  onEventClick?: (schedule: ScheduleEvent) => void;
}

const TYPE_COLORS: Record<string, string> = {
  filming: "bg-red-500",
  meeting: "bg-blue-500",
  event: "bg-purple-500",
  rehearsal: "bg-amber-500",
  interview: "bg-cyan-500",
  travel: "bg-green-500",
  rest: "bg-slate-400",
  schedule: "bg-indigo-500",
};

const TYPE_LABELS: Record<string, string> = {
  schedule: "일정",
  filming: "촬영",
  meeting: "미팅",
  event: "행사",
  rehearsal: "리허설",
  interview: "인터뷰",
  travel: "이동",
  rest: "휴식",
};

type ViewMode = "month" | "week";

export const ScheduleCalendar = ({ schedules, onEventClick }: ScheduleCalendarProps) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [viewMode, setViewMode] = useState<ViewMode>("month");

  const days = useMemo(() => {
    if (viewMode === "month") {
      const monthStart = startOfMonth(currentDate);
      const monthEnd = endOfMonth(currentDate);
      const calStart = startOfWeek(monthStart, { weekStartsOn: 0 });
      const calEnd = endOfWeek(monthEnd, { weekStartsOn: 0 });
      return eachDayOfInterval({ start: calStart, end: calEnd });
    } else {
      const weekStart = startOfWeek(currentDate, { weekStartsOn: 0 });
      const weekEnd = endOfWeek(currentDate, { weekStartsOn: 0 });
      return eachDayOfInterval({ start: weekStart, end: weekEnd });
    }
  }, [currentDate, viewMode]);

  const eventsByDay = useMemo(() => {
    const map = new Map<string, ScheduleEvent[]>();
    schedules.forEach((s) => {
      const start = new Date(s.start_time);
      const end = new Date(s.end_time);
      days.forEach((day) => {
        const dayStart = new Date(day);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(day);
        dayEnd.setHours(23, 59, 59, 999);
        if (start <= dayEnd && end >= dayStart) {
          const key = format(day, "yyyy-MM-dd");
          if (!map.has(key)) map.set(key, []);
          map.get(key)!.push(s);
        }
      });
    });
    return map;
  }, [schedules, days]);

  const navigate = (direction: number) => {
    if (viewMode === "month") {
      setCurrentDate(direction > 0 ? addMonths(currentDate, 1) : subMonths(currentDate, 1));
    } else {
      setCurrentDate(direction > 0 ? addWeeks(currentDate, 1) : subWeeks(currentDate, 1));
    }
  };

  const headerLabel = viewMode === "month"
    ? format(currentDate, "yyyy년 M월", { locale: ko })
    : `${format(days[0], "M/d", { locale: ko })} ~ ${format(days[6], "M/d", { locale: ko })}`;

  const weekDays = ["일", "월", "화", "수", "목", "금", "토"];

  return (
    <div className="bg-white rounded-xl border border-slate-200">
      {/* Calendar Header */}
      <div className="flex items-center justify-between p-4 border-b border-slate-100">
        <div className="flex items-center gap-3">
          <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
            <ChevronLeft className="w-4 h-4" />
          </Button>
          <h3 className="text-lg font-bold text-slate-900 min-w-[160px] text-center">
            {headerLabel}
          </h3>
          <Button variant="ghost" size="icon" onClick={() => navigate(1)}>
            <ChevronRight className="w-4 h-4" />
          </Button>
          <Button
            variant="outline"
            size="sm"
            className="ml-2 text-xs"
            onClick={() => setCurrentDate(new Date())}
          >
            오늘
          </Button>
        </div>
        <div className="flex gap-1 bg-slate-100 rounded-lg p-0.5">
          <Button
            variant={viewMode === "month" ? "default" : "ghost"}
            size="sm"
            className="gap-1.5 h-7 text-xs"
            onClick={() => setViewMode("month")}
          >
            <CalendarIcon className="w-3.5 h-3.5" /> 월간
          </Button>
          <Button
            variant={viewMode === "week" ? "default" : "ghost"}
            size="sm"
            className="gap-1.5 h-7 text-xs"
            onClick={() => setViewMode("week")}
          >
            <LayoutGrid className="w-3.5 h-3.5" /> 주간
          </Button>
        </div>
      </div>

      {/* Weekday Headers */}
      <div className="grid grid-cols-7 border-b border-slate-100">
        {weekDays.map((d, i) => (
          <div
            key={d}
            className={`text-center py-2 text-xs font-semibold ${
              i === 0 ? "text-red-400" : i === 6 ? "text-blue-400" : "text-slate-500"
            }`}
          >
            {d}
          </div>
        ))}
      </div>

      {/* Calendar Grid */}
      <div className={`grid grid-cols-7 ${viewMode === "week" ? "min-h-[200px]" : ""}`}>
        {days.map((day, idx) => {
          const key = format(day, "yyyy-MM-dd");
          const events = eventsByDay.get(key) || [];
          const inMonth = viewMode === "month" ? isSameMonth(day, currentDate) : true;
          const today = isToday(day);
          const dayOfWeek = day.getDay();

          return (
            <div
              key={idx}
              className={`border-b border-r border-slate-100 ${
                viewMode === "week" ? "min-h-[180px]" : "min-h-[100px]"
              } ${!inMonth ? "bg-slate-50/50" : ""} ${today ? "bg-primary/5" : ""}`}
            >
              <div className="p-1">
                <span
                  className={`inline-flex items-center justify-center w-6 h-6 text-xs rounded-full ${
                    today
                      ? "bg-primary text-primary-foreground font-bold"
                      : !inMonth
                      ? "text-slate-300"
                      : dayOfWeek === 0
                      ? "text-red-500"
                      : dayOfWeek === 6
                      ? "text-blue-500"
                      : "text-slate-700"
                  }`}
                >
                  {format(day, "d")}
                </span>
              </div>
              <div className="px-1 pb-1 space-y-0.5">
                {events.slice(0, viewMode === "week" ? 8 : 3).map((ev) => (
                  <button
                    key={ev.id}
                    onClick={() => onEventClick?.(ev)}
                    className={`w-full text-left px-1.5 py-0.5 rounded text-[10px] leading-tight text-white truncate ${
                      TYPE_COLORS[ev.schedule_type] || TYPE_COLORS.schedule
                    } hover:opacity-80 transition-opacity`}
                    title={`${(ev.artist as any)?.name || ""} - ${ev.title}`}
                  >
                    {viewMode === "week" && (
                      <span className="font-medium">
                        {!ev.is_all_day && format(new Date(ev.start_time), "HH:mm")}{" "}
                      </span>
                    )}
                    {(ev.artist as any)?.name?.charAt(0)}{" "}
                    {ev.title}
                  </button>
                ))}
                {events.length > (viewMode === "week" ? 8 : 3) && (
                  <p className="text-[10px] text-slate-400 px-1">
                    +{events.length - (viewMode === "week" ? 8 : 3)}건
                  </p>
                )}
              </div>
            </div>
          );
        })}
      </div>

      {/* Legend */}
      <div className="flex flex-wrap gap-3 p-3 border-t border-slate-100">
        {Object.entries(TYPE_LABELS).map(([key, label]) => (
          <div key={key} className="flex items-center gap-1.5">
            <div className={`w-2.5 h-2.5 rounded-full ${TYPE_COLORS[key]}`} />
            <span className="text-[11px] text-slate-500">{label}</span>
          </div>
        ))}
      </div>
    </div>
  );
};



============================================================
File Path: src/components/ui/accordion.tsx
============================================================
import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion";
import { ChevronDown } from "lucide-react";

import { cn } from "@/lib/utils";

const Accordion = AccordionPrimitive.Root;

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item ref={ref} className={cn("border-b", className)} {...props} />
));
AccordionItem.displayName = "AccordionItem";

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
));
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName;

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
));

AccordionContent.displayName = AccordionPrimitive.Content.displayName;

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };



============================================================
File Path: src/components/ui/alert-dialog.tsx
============================================================
import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

const AlertDialog = AlertDialogPrimitive.Root;

const AlertDialogTrigger = AlertDialogPrimitive.Trigger;

const AlertDialogPortal = AlertDialogPrimitive.Portal;

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
    ref={ref}
  />
));
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName;

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className,
      )}
      {...props}
    />
  </AlertDialogPortal>
));
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName;

const AlertDialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-2 text-center sm:text-left", className)} {...props} />
);
AlertDialogHeader.displayName = "AlertDialogHeader";

const AlertDialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
AlertDialogFooter.displayName = "AlertDialogFooter";

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title ref={ref} className={cn("text-lg font-semibold", className)} {...props} />
));
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName;

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
AlertDialogDescription.displayName = AlertDialogPrimitive.Description.displayName;

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action ref={ref} className={cn(buttonVariants(), className)} {...props} />
));
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName;

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(buttonVariants({ variant: "outline" }), "mt-2 sm:mt-0", className)}
    {...props}
  />
));
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName;

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};



============================================================
File Path: src/components/ui/alert.tsx
============================================================
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive: "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div ref={ref} role="alert" className={cn(alertVariants({ variant }), className)} {...props} />
));
Alert.displayName = "Alert";

const AlertTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h5 ref={ref} className={cn("mb-1 font-medium leading-none tracking-tight", className)} {...props} />
  ),
);
AlertTitle.displayName = "AlertTitle";

const AlertDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("text-sm [&_p]:leading-relaxed", className)} {...props} />
  ),
);
AlertDescription.displayName = "AlertDescription";

export { Alert, AlertTitle, AlertDescription };



============================================================
File Path: src/components/ui/aspect-ratio.tsx
============================================================
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio";

const AspectRatio = AspectRatioPrimitive.Root;

export { AspectRatio };



============================================================
File Path: src/components/ui/avatar.tsx
============================================================
import * as React from "react";
import * as AvatarPrimitive from "@radix-ui/react-avatar";

import { cn } from "@/lib/utils";

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full", className)}
    {...props}
  />
));
Avatar.displayName = AvatarPrimitive.Root.displayName;

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image ref={ref} className={cn("aspect-square h-full w-full", className)} {...props} />
));
AvatarImage.displayName = AvatarPrimitive.Image.displayName;

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn("flex h-full w-full items-center justify-center rounded-full bg-muted", className)}
    {...props}
  />
));
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName;

export { Avatar, AvatarImage, AvatarFallback };



============================================================
File Path: src/components/ui/badge.tsx
============================================================
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

export interface BadgeProps extends React.HTMLAttributes<HTMLDivElement>, VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return <div className={cn(badgeVariants({ variant }), className)} {...props} />;
}

export { Badge, badgeVariants };



============================================================
File Path: src/components/ui/breadcrumb.tsx
============================================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/lib/utils";

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode;
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />);
Breadcrumb.displayName = "Breadcrumb";

const BreadcrumbList = React.forwardRef<HTMLOListElement, React.ComponentPropsWithoutRef<"ol">>(
  ({ className, ...props }, ref) => (
    <ol
      ref={ref}
      className={cn(
        "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
        className,
      )}
      {...props}
    />
  ),
);
BreadcrumbList.displayName = "BreadcrumbList";

const BreadcrumbItem = React.forwardRef<HTMLLIElement, React.ComponentPropsWithoutRef<"li">>(
  ({ className, ...props }, ref) => (
    <li ref={ref} className={cn("inline-flex items-center gap-1.5", className)} {...props} />
  ),
);
BreadcrumbItem.displayName = "BreadcrumbItem";

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean;
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a";

  return <Comp ref={ref} className={cn("transition-colors hover:text-foreground", className)} {...props} />;
});
BreadcrumbLink.displayName = "BreadcrumbLink";

const BreadcrumbPage = React.forwardRef<HTMLSpanElement, React.ComponentPropsWithoutRef<"span">>(
  ({ className, ...props }, ref) => (
    <span
      ref={ref}
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("font-normal text-foreground", className)}
      {...props}
    />
  ),
);
BreadcrumbPage.displayName = "BreadcrumbPage";

const BreadcrumbSeparator = ({ children, className, ...props }: React.ComponentProps<"li">) => (
  <li role="presentation" aria-hidden="true" className={cn("[&>svg]:size-3.5", className)} {...props}>
    {children ?? <ChevronRight />}
  </li>
);
BreadcrumbSeparator.displayName = "BreadcrumbSeparator";

const BreadcrumbEllipsis = ({ className, ...props }: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
);
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis";

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
};



============================================================
File Path: src/components/ui/button.tsx
============================================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium ring-offset-background transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90 shadow-md hover:shadow-lg",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-md",
        outline: "border border-border bg-transparent hover:bg-secondary hover:text-secondary-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-secondary hover:text-secondary-foreground",
        link: "text-primary underline-offset-4 hover:underline",
        hero: "bg-gradient-to-r from-primary to-accent text-primary-foreground shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98]",
        glass: "bg-card/50 backdrop-blur-sm border border-border/50 text-foreground hover:bg-card/70 hover:border-primary/30",
        success: "bg-success text-success-foreground hover:bg-success/90 shadow-md",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-12 rounded-lg px-8 text-base",
        xl: "h-14 rounded-xl px-10 text-lg",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return <Comp className={cn(buttonVariants({ variant, size, className }))} ref={ref} {...props} />;
  },
);
Button.displayName = "Button";

export { Button, buttonVariants };



============================================================
File Path: src/components/ui/calendar.tsx
============================================================
import * as React from "react";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { DayPicker } from "react-day-picker";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

export type CalendarProps = React.ComponentProps<typeof DayPicker>;

function Calendar({ className, classNames, showOutsideDays = true, ...props }: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100",
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell: "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(buttonVariants({ variant: "ghost" }), "h-9 w-9 p-0 font-normal aria-selected:opacity-100"),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle: "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ ..._props }) => <ChevronLeft className="h-4 w-4" />,
        IconRight: ({ ..._props }) => <ChevronRight className="h-4 w-4" />,
      }}
      {...props}
    />
  );
}
Calendar.displayName = "Calendar";

export { Calendar };



============================================================
File Path: src/components/ui/card.tsx
============================================================
import * as React from "react";

import { cn } from "@/lib/utils";

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)} {...props} />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
  ),
);
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
  ),
);
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => (
    <p ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
  ),
);
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />,
);
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex items-center p-6 pt-0", className)} {...props} />
  ),
);
CardFooter.displayName = "CardFooter";

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };



============================================================
File Path: src/components/ui/carousel.tsx
============================================================
import * as React from "react";
import useEmblaCarousel, { type UseEmblaCarouselType } from "embla-carousel-react";
import { ArrowLeft, ArrowRight } from "lucide-react";

import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";

type CarouselApi = UseEmblaCarouselType[1];
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>;
type CarouselOptions = UseCarouselParameters[0];
type CarouselPlugin = UseCarouselParameters[1];

type CarouselProps = {
  opts?: CarouselOptions;
  plugins?: CarouselPlugin;
  orientation?: "horizontal" | "vertical";
  setApi?: (api: CarouselApi) => void;
};

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0];
  api: ReturnType<typeof useEmblaCarousel>[1];
  scrollPrev: () => void;
  scrollNext: () => void;
  canScrollPrev: boolean;
  canScrollNext: boolean;
} & CarouselProps;

const CarouselContext = React.createContext<CarouselContextProps | null>(null);

function useCarousel() {
  const context = React.useContext(CarouselContext);

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />");
  }

  return context;
}

const Carousel = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement> & CarouselProps>(
  ({ orientation = "horizontal", opts, setApi, plugins, className, children, ...props }, ref) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins,
    );
    const [canScrollPrev, setCanScrollPrev] = React.useState(false);
    const [canScrollNext, setCanScrollNext] = React.useState(false);

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return;
      }

      setCanScrollPrev(api.canScrollPrev());
      setCanScrollNext(api.canScrollNext());
    }, []);

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev();
    }, [api]);

    const scrollNext = React.useCallback(() => {
      api?.scrollNext();
    }, [api]);

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault();
          scrollPrev();
        } else if (event.key === "ArrowRight") {
          event.preventDefault();
          scrollNext();
        }
      },
      [scrollPrev, scrollNext],
    );

    React.useEffect(() => {
      if (!api || !setApi) {
        return;
      }

      setApi(api);
    }, [api, setApi]);

    React.useEffect(() => {
      if (!api) {
        return;
      }

      onSelect(api);
      api.on("reInit", onSelect);
      api.on("select", onSelect);

      return () => {
        api?.off("select", onSelect);
      };
    }, [api, onSelect]);

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation: orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    );
  },
);
Carousel.displayName = "Carousel";

const CarouselContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const { carouselRef, orientation } = useCarousel();

    return (
      <div ref={carouselRef} className="overflow-hidden">
        <div
          ref={ref}
          className={cn("flex", orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col", className)}
          {...props}
        />
      </div>
    );
  },
);
CarouselContent.displayName = "CarouselContent";

const CarouselItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const { orientation } = useCarousel();

    return (
      <div
        ref={ref}
        role="group"
        aria-roledescription="slide"
        className={cn("min-w-0 shrink-0 grow-0 basis-full", orientation === "horizontal" ? "pl-4" : "pt-4", className)}
        {...props}
      />
    );
  },
);
CarouselItem.displayName = "CarouselItem";

const CarouselPrevious = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, variant = "outline", size = "icon", ...props }, ref) => {
    const { orientation, scrollPrev, canScrollPrev } = useCarousel();

    return (
      <Button
        ref={ref}
        variant={variant}
        size={size}
        className={cn(
          "absolute h-8 w-8 rounded-full",
          orientation === "horizontal"
            ? "-left-12 top-1/2 -translate-y-1/2"
            : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
          className,
        )}
        disabled={!canScrollPrev}
        onClick={scrollPrev}
        {...props}
      >
        <ArrowLeft className="h-4 w-4" />
        <span className="sr-only">Previous slide</span>
      </Button>
    );
  },
);
CarouselPrevious.displayName = "CarouselPrevious";

const CarouselNext = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, variant = "outline", size = "icon", ...props }, ref) => {
    const { orientation, scrollNext, canScrollNext } = useCarousel();

    return (
      <Button
        ref={ref}
        variant={variant}
        size={size}
        className={cn(
          "absolute h-8 w-8 rounded-full",
          orientation === "horizontal"
            ? "-right-12 top-1/2 -translate-y-1/2"
            : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
          className,
        )}
        disabled={!canScrollNext}
        onClick={scrollNext}
        {...props}
      >
        <ArrowRight className="h-4 w-4" />
        <span className="sr-only">Next slide</span>
      </Button>
    );
  },
);
CarouselNext.displayName = "CarouselNext";

export { type CarouselApi, Carousel, CarouselContent, CarouselItem, CarouselPrevious, CarouselNext };



============================================================
File Path: src/components/ui/chart.tsx
============================================================
import * as React from "react";
import * as RechartsPrimitive from "recharts";

import { cn } from "@/lib/utils";

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const;

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode;
    icon?: React.ComponentType;
  } & ({ color?: string; theme?: never } | { color?: never; theme: Record<keyof typeof THEMES, string> });
};

type ChartContextProps = {
  config: ChartConfig;
};

const ChartContext = React.createContext<ChartContextProps | null>(null);

function useChart() {
  const context = React.useContext(ChartContext);

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />");
  }

  return context;
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig;
    children: React.ComponentProps<typeof RechartsPrimitive.ResponsiveContainer>["children"];
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId();
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`;

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>{children}</RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  );
});
ChartContainer.displayName = "Chart";

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(([_, config]) => config.theme || config.color);

  if (!colorConfig.length) {
    return null;
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color = itemConfig.theme?.[theme as keyof typeof itemConfig.theme] || itemConfig.color;
    return color ? `  --color-${key}: ${color};` : null;
  })
  .join("\n")}
}
`,
          )
          .join("\n"),
      }}
    />
  );
};

const ChartTooltip = RechartsPrimitive.Tooltip;

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean;
      hideIndicator?: boolean;
      indicator?: "line" | "dot" | "dashed";
      nameKey?: string;
      labelKey?: string;
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref,
  ) => {
    const { config } = useChart();

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null;
      }

      const [item] = payload;
      const key = `${labelKey || item.dataKey || item.name || "value"}`;
      const itemConfig = getPayloadConfigFromPayload(config, item, key);
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label;

      if (labelFormatter) {
        return <div className={cn("font-medium", labelClassName)}>{labelFormatter(value, payload)}</div>;
      }

      if (!value) {
        return null;
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>;
    }, [label, labelFormatter, payload, hideLabel, labelClassName, config, labelKey]);

    if (!active || !payload?.length) {
      return null;
    }

    const nestLabel = payload.length === 1 && indicator !== "dot";

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className,
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`;
            const itemConfig = getPayloadConfigFromPayload(config, item, key);
            const indicatorColor = color || item.payload.fill || item.color;

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center",
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn("shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]", {
                            "h-2.5 w-2.5": indicator === "dot",
                            "w-1": indicator === "line",
                            "w-0 border-[1.5px] border-dashed bg-transparent": indicator === "dashed",
                            "my-0.5": nestLabel && indicator === "dashed",
                          })}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center",
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">{itemConfig?.label || item.name}</span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>
    );
  },
);
ChartTooltipContent.displayName = "ChartTooltip";

const ChartLegend = RechartsPrimitive.Legend;

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean;
      nameKey?: string;
    }
>(({ className, hideIcon = false, payload, verticalAlign = "bottom", nameKey }, ref) => {
  const { config } = useChart();

  if (!payload?.length) {
    return null;
  }

  return (
    <div
      ref={ref}
      className={cn("flex items-center justify-center gap-4", verticalAlign === "top" ? "pb-3" : "pt-3", className)}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`;
        const itemConfig = getPayloadConfigFromPayload(config, item, key);

        return (
          <div
            key={item.value}
            className={cn("flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground")}
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        );
      })}
    </div>
  );
});
ChartLegendContent.displayName = "ChartLegend";

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(config: ChartConfig, payload: unknown, key: string) {
  if (typeof payload !== "object" || payload === null) {
    return undefined;
  }

  const payloadPayload =
    "payload" in payload && typeof payload.payload === "object" && payload.payload !== null
      ? payload.payload
      : undefined;

  let configLabelKey: string = key;

  if (key in payload && typeof payload[key as keyof typeof payload] === "string") {
    configLabelKey = payload[key as keyof typeof payload] as string;
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[key as keyof typeof payloadPayload] as string;
  }

  return configLabelKey in config ? config[configLabelKey] : config[key as keyof typeof config];
}

export { ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, ChartStyle };



============================================================
File Path: src/components/ui/checkbox.tsx
============================================================
import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { Check } from "lucide-react";

import { cn } from "@/lib/utils";

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
      className,
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator className={cn("flex items-center justify-center text-current")}>
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };



============================================================
File Path: src/components/ui/collapsible.tsx
============================================================
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

const Collapsible = CollapsiblePrimitive.Root;

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger;

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent;

export { Collapsible, CollapsibleTrigger, CollapsibleContent };



============================================================
File Path: src/components/ui/command.tsx
============================================================
import * as React from "react";
import { type DialogProps } from "@radix-ui/react-dialog";
import { Command as CommandPrimitive } from "cmdk";
import { Search } from "lucide-react";

import { cn } from "@/lib/utils";
import { Dialog, DialogContent } from "@/components/ui/dialog";

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className,
    )}
    {...props}
  />
));
Command.displayName = CommandPrimitive.displayName;

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
};

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    />
  </div>
));

CommandInput.displayName = CommandPrimitive.Input.displayName;

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
));

CommandList.displayName = CommandPrimitive.List.displayName;

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => <CommandPrimitive.Empty ref={ref} className="py-6 text-center text-sm" {...props} />);

CommandEmpty.displayName = CommandPrimitive.Empty.displayName;

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className,
    )}
    {...props}
  />
));

CommandGroup.displayName = CommandPrimitive.Group.displayName;

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator ref={ref} className={cn("-mx-1 h-px bg-border", className)} {...props} />
));
CommandSeparator.displayName = CommandPrimitive.Separator.displayName;

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
      className,
    )}
    {...props}
  />
));

CommandItem.displayName = CommandPrimitive.Item.displayName;

const CommandShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
CommandShortcut.displayName = "CommandShortcut";

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
};



============================================================
File Path: src/components/ui/context-menu.tsx
============================================================
import * as React from "react";
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const ContextMenu = ContextMenuPrimitive.Root;

const ContextMenuTrigger = ContextMenuPrimitive.Trigger;

const ContextMenuGroup = ContextMenuPrimitive.Group;

const ContextMenuPortal = ContextMenuPrimitive.Portal;

const ContextMenuSub = ContextMenuPrimitive.Sub;

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup;

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
));
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName;

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName;

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
));
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName;

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName;

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
));
ContextMenuCheckboxItem.displayName = ContextMenuPrimitive.CheckboxItem.displayName;

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
));
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName;

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold text-foreground", inset && "pl-8", className)}
    {...props}
  />
));
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName;

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-border", className)} {...props} />
));
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName;

const ContextMenuShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
ContextMenuShortcut.displayName = "ContextMenuShortcut";

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};



============================================================
File Path: src/components/ui/dialog.tsx
============================================================
import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const Dialog = DialogPrimitive.Root;

const DialogTrigger = DialogPrimitive.Trigger;

const DialogPortal = DialogPrimitive.Portal;

const DialogClose = DialogPrimitive.Close;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className,
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
));
DialogContent.displayName = DialogPrimitive.Content.displayName;

const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-1.5 text-center sm:text-left", className)} {...props} />
);
DialogHeader.displayName = "DialogHeader";

const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
DialogFooter.displayName = "DialogFooter";

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
};



============================================================
File Path: src/components/ui/drawer.tsx
============================================================
import * as React from "react";
import { Drawer as DrawerPrimitive } from "vaul";

import { cn } from "@/lib/utils";

const Drawer = ({ shouldScaleBackground = true, ...props }: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root shouldScaleBackground={shouldScaleBackground} {...props} />
);
Drawer.displayName = "Drawer";

const DrawerTrigger = DrawerPrimitive.Trigger;

const DrawerPortal = DrawerPrimitive.Portal;

const DrawerClose = DrawerPrimitive.Close;

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay ref={ref} className={cn("fixed inset-0 z-50 bg-black/80", className)} {...props} />
));
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName;

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className,
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
));
DrawerContent.displayName = "DrawerContent";

const DrawerHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)} {...props} />
);
DrawerHeader.displayName = "DrawerHeader";

const DrawerFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("mt-auto flex flex-col gap-2 p-4", className)} {...props} />
);
DrawerFooter.displayName = "DrawerFooter";

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
DrawerTitle.displayName = DrawerPrimitive.Title.displayName;

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
DrawerDescription.displayName = DrawerPrimitive.Description.displayName;

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
};



============================================================
File Path: src/components/ui/dropdown-menu.tsx
============================================================
import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName = DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName = DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName = DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest opacity-60", className)} {...props} />;
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};



============================================================
File Path: src/components/ui/form.tsx
============================================================
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { Slot } from "@radix-ui/react-slot";
import { Controller, ControllerProps, FieldPath, FieldValues, FormProvider, useFormContext } from "react-hook-form";

import { cn } from "@/lib/utils";
import { Label } from "@/components/ui/label";

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>({} as FormFieldContextValue);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState, formState } = useFormContext();

  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue>({} as FormItemContextValue);

const FormItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const id = React.useId();

    return (
      <FormItemContext.Provider value={{ id }}>
        <div ref={ref} className={cn("space-y-2", className)} {...props} />
      </FormItemContext.Provider>
    );
  },
);
FormItem.displayName = "FormItem";

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField();

  return <Label ref={ref} className={cn(error && "text-destructive", className)} htmlFor={formItemId} {...props} />;
});
FormLabel.displayName = "FormLabel";

const FormControl = React.forwardRef<React.ElementRef<typeof Slot>, React.ComponentPropsWithoutRef<typeof Slot>>(
  ({ ...props }, ref) => {
    const { error, formItemId, formDescriptionId, formMessageId } = useFormField();

    return (
      <Slot
        ref={ref}
        id={formItemId}
        aria-describedby={!error ? `${formDescriptionId}` : `${formDescriptionId} ${formMessageId}`}
        aria-invalid={!!error}
        {...props}
      />
    );
  },
);
FormControl.displayName = "FormControl";

const FormDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => {
    const { formDescriptionId } = useFormField();

    return <p ref={ref} id={formDescriptionId} className={cn("text-sm text-muted-foreground", className)} {...props} />;
  },
);
FormDescription.displayName = "FormDescription";

const FormMessage = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, children, ...props }, ref) => {
    const { error, formMessageId } = useFormField();
    const body = error ? String(error?.message) : children;

    if (!body) {
      return null;
    }

    return (
      <p ref={ref} id={formMessageId} className={cn("text-sm font-medium text-destructive", className)} {...props}>
        {body}
      </p>
    );
  },
);
FormMessage.displayName = "FormMessage";

export { useFormField, Form, FormItem, FormLabel, FormControl, FormDescription, FormMessage, FormField };



============================================================
File Path: src/components/ui/hover-card.tsx
============================================================
import * as React from "react";
import * as HoverCardPrimitive from "@radix-ui/react-hover-card";

import { cn } from "@/lib/utils";

const HoverCard = HoverCardPrimitive.Root;

const HoverCardTrigger = HoverCardPrimitive.Trigger;

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName;

export { HoverCard, HoverCardTrigger, HoverCardContent };



============================================================
File Path: src/components/ui/input-otp.tsx
============================================================
import * as React from "react";
import { OTPInput, OTPInputContext } from "input-otp";
import { Dot } from "lucide-react";

import { cn } from "@/lib/utils";

const InputOTP = React.forwardRef<React.ElementRef<typeof OTPInput>, React.ComponentPropsWithoutRef<typeof OTPInput>>(
  ({ className, containerClassName, ...props }, ref) => (
    <OTPInput
      ref={ref}
      containerClassName={cn("flex items-center gap-2 has-[:disabled]:opacity-50", containerClassName)}
      className={cn("disabled:cursor-not-allowed", className)}
      {...props}
    />
  ),
);
InputOTP.displayName = "InputOTP";

const InputOTPGroup = React.forwardRef<React.ElementRef<"div">, React.ComponentPropsWithoutRef<"div">>(
  ({ className, ...props }, ref) => <div ref={ref} className={cn("flex items-center", className)} {...props} />,
);
InputOTPGroup.displayName = "InputOTPGroup";

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext);
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index];

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-2 ring-ring ring-offset-background",
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink h-4 w-px bg-foreground duration-1000" />
        </div>
      )}
    </div>
  );
});
InputOTPSlot.displayName = "InputOTPSlot";

const InputOTPSeparator = React.forwardRef<React.ElementRef<"div">, React.ComponentPropsWithoutRef<"div">>(
  ({ ...props }, ref) => (
    <div ref={ref} role="separator" {...props}>
      <Dot />
    </div>
  ),
);
InputOTPSeparator.displayName = "InputOTPSeparator";

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator };



============================================================
File Path: src/components/ui/input.tsx
============================================================
import * as React from "react";

import { cn } from "@/lib/utils";

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className,
        )}
        ref={ref}
        {...props}
      />
    );
  },
);
Input.displayName = "Input";

export { Input };



============================================================
File Path: src/components/ui/label.tsx
============================================================
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const labelVariants = cva("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70");

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> & VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root ref={ref} className={cn(labelVariants(), className)} {...props} />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };



============================================================
File Path: src/components/ui/menubar.tsx
============================================================
import * as React from "react";
import * as MenubarPrimitive from "@radix-ui/react-menubar";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const MenubarMenu = MenubarPrimitive.Menu;

const MenubarGroup = MenubarPrimitive.Group;

const MenubarPortal = MenubarPrimitive.Portal;

const MenubarSub = MenubarPrimitive.Sub;

const MenubarRadioGroup = MenubarPrimitive.RadioGroup;

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn("flex h-10 items-center space-x-1 rounded-md border bg-background p-1", className)}
    {...props}
  />
));
Menubar.displayName = MenubarPrimitive.Root.displayName;

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  />
));
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName;

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
));
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName;

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName;

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(({ className, align = "start", alignOffset = -4, sideOffset = 8, ...props }, ref) => (
  <MenubarPrimitive.Portal>
    <MenubarPrimitive.Content
      ref={ref}
      align={align}
      alignOffset={alignOffset}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </MenubarPrimitive.Portal>
));
MenubarContent.displayName = MenubarPrimitive.Content.displayName;

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
MenubarItem.displayName = MenubarPrimitive.Item.displayName;

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
));
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName;

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
));
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName;

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props}
  />
));
MenubarLabel.displayName = MenubarPrimitive.Label.displayName;

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName;

const MenubarShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
MenubarShortcut.displayname = "MenubarShortcut";

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
};



============================================================
File Path: src/components/ui/navigation-menu.tsx
============================================================
import * as React from "react";
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu";
import { cva } from "class-variance-authority";
import { ChevronDown } from "lucide-react";

import { cn } from "@/lib/utils";

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn("relative z-10 flex max-w-max flex-1 items-center justify-center", className)}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
));
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName;

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn("group flex flex-1 list-none items-center justify-center space-x-1", className)}
    {...props}
  />
));
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName;

const NavigationMenuItem = NavigationMenuPrimitive.Item;

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50",
);

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
));
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName;

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto",
      className,
    )}
    {...props}
  />
));
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName;

const NavigationMenuLink = NavigationMenuPrimitive.Link;

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className,
      )}
      ref={ref}
      {...props}
    />
  </div>
));
NavigationMenuViewport.displayName = NavigationMenuPrimitive.Viewport.displayName;

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className,
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
));
NavigationMenuIndicator.displayName = NavigationMenuPrimitive.Indicator.displayName;

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
};



============================================================
File Path: src/components/ui/pagination.tsx
============================================================
import * as React from "react";
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/lib/utils";
import { ButtonProps, buttonVariants } from "@/components/ui/button";

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
);
Pagination.displayName = "Pagination";

const PaginationContent = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(
  ({ className, ...props }, ref) => (
    <ul ref={ref} className={cn("flex flex-row items-center gap-1", className)} {...props} />
  ),
);
PaginationContent.displayName = "PaginationContent";

const PaginationItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
));
PaginationItem.displayName = "PaginationItem";

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">;

const PaginationLink = ({ className, isActive, size = "icon", ...props }: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className,
    )}
    {...props}
  />
);
PaginationLink.displayName = "PaginationLink";

const PaginationPrevious = ({ className, ...props }: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink aria-label="Go to previous page" size="default" className={cn("gap-1 pl-2.5", className)} {...props}>
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
);
PaginationPrevious.displayName = "PaginationPrevious";

const PaginationNext = ({ className, ...props }: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink aria-label="Go to next page" size="default" className={cn("gap-1 pr-2.5", className)} {...props}>
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
);
PaginationNext.displayName = "PaginationNext";

const PaginationEllipsis = ({ className, ...props }: React.ComponentProps<"span">) => (
  <span aria-hidden className={cn("flex h-9 w-9 items-center justify-center", className)} {...props}>
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
);
PaginationEllipsis.displayName = "PaginationEllipsis";

export {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
};



============================================================
File Path: src/components/ui/popover.tsx
============================================================
import * as React from "react";
import * as PopoverPrimitive from "@radix-ui/react-popover";

import { cn } from "@/lib/utils";

const Popover = PopoverPrimitive.Root;

const PopoverTrigger = PopoverPrimitive.Trigger;

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
));
PopoverContent.displayName = PopoverPrimitive.Content.displayName;

export { Popover, PopoverTrigger, PopoverContent };



============================================================
File Path: src/components/ui/progress.tsx
============================================================
import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress";

import { cn } from "@/lib/utils";

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn("relative h-4 w-full overflow-hidden rounded-full bg-secondary", className)}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
));
Progress.displayName = ProgressPrimitive.Root.displayName;

export { Progress };



============================================================
File Path: src/components/ui/radio-group.tsx
============================================================
import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return <RadioGroupPrimitive.Root className={cn("grid gap-2", className)} {...props} ref={ref} />;
});
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName;

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
});
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName;

export { RadioGroup, RadioGroupItem };



============================================================
File Path: src/components/ui/resizable.tsx
============================================================
import { GripVertical } from "lucide-react";
import * as ResizablePrimitive from "react-resizable-panels";

import { cn } from "@/lib/utils";

const ResizablePanelGroup = ({ className, ...props }: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn("flex h-full w-full data-[panel-group-direction=vertical]:flex-col", className)}
    {...props}
  />
);

const ResizablePanel = ResizablePrimitive.Panel;

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className,
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
);

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };



============================================================
File Path: src/components/ui/scroll-area.tsx
============================================================
import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area";

import { cn } from "@/lib/utils";

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root ref={ref} className={cn("relative overflow-hidden", className)} {...props}>
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">{children}</ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
));
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName;

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" && "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" && "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className,
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
));
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName;

export { ScrollArea, ScrollBar };



============================================================
File Path: src/components/ui/select.tsx
============================================================
import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { Check, ChevronDown, ChevronUp } from "lucide-react";

import { cn } from "@/lib/utils";

const Select = SelectPrimitive.Root;

const SelectGroup = SelectPrimitive.Group;

const SelectValue = SelectPrimitive.Value;

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className,
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
));
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName;

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
));
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName;

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
));
SelectScrollDownButton.displayName = SelectPrimitive.ScrollDownButton.displayName;

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className,
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]",
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
));
SelectContent.displayName = SelectPrimitive.Content.displayName;

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label ref={ref} className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)} {...props} />
));
SelectLabel.displayName = SelectPrimitive.Label.displayName;

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
));
SelectItem.displayName = SelectPrimitive.Item.displayName;

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
SelectSeparator.displayName = SelectPrimitive.Separator.displayName;

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
};



============================================================
File Path: src/components/ui/separator.tsx
============================================================
import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator";

import { cn } from "@/lib/utils";

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(({ className, orientation = "horizontal", decorative = true, ...props }, ref) => (
  <SeparatorPrimitive.Root
    ref={ref}
    decorative={decorative}
    orientation={orientation}
    className={cn("shrink-0 bg-border", orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]", className)}
    {...props}
  />
));
Separator.displayName = SeparatorPrimitive.Root.displayName;

export { Separator };



============================================================
File Path: src/components/ui/sheet.tsx
============================================================
import * as SheetPrimitive from "@radix-ui/react-dialog";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";
import * as React from "react";

import { cn } from "@/lib/utils";

const Sheet = SheetPrimitive.Root;

const SheetTrigger = SheetPrimitive.Trigger;

const SheetClose = SheetPrimitive.Close;

const SheetPortal = SheetPrimitive.Portal;

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
    ref={ref}
  />
));
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName;

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  },
);

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<React.ElementRef<typeof SheetPrimitive.Content>, SheetContentProps>(
  ({ side = "right", className, children, ...props }, ref) => (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content ref={ref} className={cn(sheetVariants({ side }), className)} {...props}>
        {children}
        <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none">
          <X className="h-4 w-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  ),
);
SheetContent.displayName = SheetPrimitive.Content.displayName;

const SheetHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-2 text-center sm:text-left", className)} {...props} />
);
SheetHeader.displayName = "SheetHeader";

const SheetFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
SheetFooter.displayName = "SheetFooter";

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title ref={ref} className={cn("text-lg font-semibold text-foreground", className)} {...props} />
));
SheetTitle.displayName = SheetPrimitive.Title.displayName;

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
SheetDescription.displayName = SheetPrimitive.Description.displayName;

export {
  Sheet,
  SheetClose,
  SheetContent,
  SheetDescription,
  SheetFooter,
  SheetHeader,
  SheetOverlay,
  SheetPortal,
  SheetTitle,
  SheetTrigger,
};



============================================================
File Path: src/components/ui/sidebar.tsx
============================================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { VariantProps, cva } from "class-variance-authority";
import { PanelLeft } from "lucide-react";

import { useIsMobile } from "@/hooks/use-mobile";
import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { Sheet, SheetContent } from "@/components/ui/sheet";
import { Skeleton } from "@/components/ui/skeleton";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";

const SIDEBAR_COOKIE_NAME = "sidebar:state";
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const SIDEBAR_WIDTH = "16rem";
const SIDEBAR_WIDTH_MOBILE = "18rem";
const SIDEBAR_WIDTH_ICON = "3rem";
const SIDEBAR_KEYBOARD_SHORTCUT = "b";

type SidebarContext = {
  state: "expanded" | "collapsed";
  open: boolean;
  setOpen: (open: boolean) => void;
  openMobile: boolean;
  setOpenMobile: (open: boolean) => void;
  isMobile: boolean;
  toggleSidebar: () => void;
};

const SidebarContext = React.createContext<SidebarContext | null>(null);

function useSidebar() {
  const context = React.useContext(SidebarContext);
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.");
  }

  return context;
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean;
    open?: boolean;
    onOpenChange?: (open: boolean) => void;
  }
>(({ defaultOpen = true, open: openProp, onOpenChange: setOpenProp, className, style, children, ...props }, ref) => {
  const isMobile = useIsMobile();
  const [openMobile, setOpenMobile] = React.useState(false);

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen);
  const open = openProp ?? _open;
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value;
      if (setOpenProp) {
        setOpenProp(openState);
      } else {
        _setOpen(openState);
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;
    },
    [setOpenProp, open],
  );

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open);
  }, [isMobile, setOpen, setOpenMobile]);

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === SIDEBAR_KEYBOARD_SHORTCUT && (event.metaKey || event.ctrlKey)) {
        event.preventDefault();
        toggleSidebar();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar]);

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed";

  const contextValue = React.useMemo<SidebarContext>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  );

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar", className)}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  );
});
SidebarProvider.displayName = "SidebarProvider";

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right";
    variant?: "sidebar" | "floating" | "inset";
    collapsible?: "offcanvas" | "icon" | "none";
  }
>(({ side = "left", variant = "sidebar", collapsible = "offcanvas", className, children, ...props }, ref) => {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();

  if (collapsible === "none") {
    return (
      <div
        className={cn("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground", className)}
        ref={ref}
        {...props}
      >
        {children}
      </div>
    );
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-mobile="true"
          className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    );
  }

  return (
    <div
      ref={ref}
      className="group peer hidden text-sidebar-foreground md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        className={cn(
          "relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]",
        )}
      />
      <div
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
        >
          {children}
        </div>
      </div>
    </div>
  );
});
Sidebar.displayName = "Sidebar";

const SidebarTrigger = React.forwardRef<React.ElementRef<typeof Button>, React.ComponentProps<typeof Button>>(
  ({ className, onClick, ...props }, ref) => {
    const { toggleSidebar } = useSidebar();

    return (
      <Button
        ref={ref}
        data-sidebar="trigger"
        variant="ghost"
        size="icon"
        className={cn("h-7 w-7", className)}
        onClick={(event) => {
          onClick?.(event);
          toggleSidebar();
        }}
        {...props}
      >
        <PanelLeft />
        <span className="sr-only">Toggle Sidebar</span>
      </Button>
    );
  },
);
SidebarTrigger.displayName = "SidebarTrigger";

const SidebarRail = React.forwardRef<HTMLButtonElement, React.ComponentProps<"button">>(
  ({ className, ...props }, ref) => {
    const { toggleSidebar } = useSidebar();

    return (
      <button
        ref={ref}
        data-sidebar="rail"
        aria-label="Toggle Sidebar"
        tabIndex={-1}
        onClick={toggleSidebar}
        title="Toggle Sidebar"
        className={cn(
          "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] group-data-[side=left]:-right-4 group-data-[side=right]:left-0 hover:after:bg-sidebar-border sm:flex",
          "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
          "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
          "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
          "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
          "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarRail.displayName = "SidebarRail";

const SidebarInset = React.forwardRef<HTMLDivElement, React.ComponentProps<"main">>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className,
      )}
      {...props}
    />
  );
});
SidebarInset.displayName = "SidebarInset";

const SidebarInput = React.forwardRef<React.ElementRef<typeof Input>, React.ComponentProps<typeof Input>>(
  ({ className, ...props }, ref) => {
    return (
      <Input
        ref={ref}
        data-sidebar="input"
        className={cn(
          "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarInput.displayName = "SidebarInput";

const SidebarHeader = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return <div ref={ref} data-sidebar="header" className={cn("flex flex-col gap-2 p-2", className)} {...props} />;
});
SidebarHeader.displayName = "SidebarHeader";

const SidebarFooter = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return <div ref={ref} data-sidebar="footer" className={cn("flex flex-col gap-2 p-2", className)} {...props} />;
});
SidebarFooter.displayName = "SidebarFooter";

const SidebarSeparator = React.forwardRef<React.ElementRef<typeof Separator>, React.ComponentProps<typeof Separator>>(
  ({ className, ...props }, ref) => {
    return (
      <Separator
        ref={ref}
        data-sidebar="separator"
        className={cn("mx-2 w-auto bg-sidebar-border", className)}
        {...props}
      />
    );
  },
);
SidebarSeparator.displayName = "SidebarSeparator";

const SidebarContent = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className,
      )}
      {...props}
    />
  );
});
SidebarContent.displayName = "SidebarContent";

const SidebarGroup = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  );
});
SidebarGroup.displayName = "SidebarGroup";

const SidebarGroupLabel = React.forwardRef<HTMLDivElement, React.ComponentProps<"div"> & { asChild?: boolean }>(
  ({ className, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "div";

    return (
      <Comp
        ref={ref}
        data-sidebar="group-label"
        className={cn(
          "flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
          "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarGroupLabel.displayName = "SidebarGroupLabel";

const SidebarGroupAction = React.forwardRef<HTMLButtonElement, React.ComponentProps<"button"> & { asChild?: boolean }>(
  ({ className, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";

    return (
      <Comp
        ref={ref}
        data-sidebar="group-action"
        className={cn(
          "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
          // Increases the hit area of the button on mobile.
          "after:absolute after:-inset-2 after:md:hidden",
          "group-data-[collapsible=icon]:hidden",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarGroupAction.displayName = "SidebarGroupAction";

const SidebarGroupContent = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(
  ({ className, ...props }, ref) => (
    <div ref={ref} data-sidebar="group-content" className={cn("w-full text-sm", className)} {...props} />
  ),
);
SidebarGroupContent.displayName = "SidebarGroupContent";

const SidebarMenu = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(({ className, ...props }, ref) => (
  <ul ref={ref} data-sidebar="menu" className={cn("flex w-full min-w-0 flex-col gap-1", className)} {...props} />
));
SidebarMenu.displayName = "SidebarMenu";

const SidebarMenuItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ className, ...props }, ref) => (
  <li ref={ref} data-sidebar="menu-item" className={cn("group/menu-item relative", className)} {...props} />
));
SidebarMenuItem.displayName = "SidebarMenuItem";

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean;
    isActive?: boolean;
    tooltip?: string | React.ComponentProps<typeof TooltipContent>;
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(({ asChild = false, isActive = false, variant = "default", size = "default", tooltip, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "button";
  const { isMobile, state } = useSidebar();

  const button = (
    <Comp
      ref={ref}
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  );

  if (!tooltip) {
    return button;
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    };
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent side="right" align="center" hidden={state !== "collapsed" || isMobile} {...tooltip} />
    </Tooltip>
  );
});
SidebarMenuButton.displayName = "SidebarMenuButton";

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean;
    showOnHover?: boolean;
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform peer-hover/menu-button:text-sidebar-accent-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className,
      )}
      {...props}
    />
  );
});
SidebarMenuAction.displayName = "SidebarMenuAction";

const SidebarMenuBadge = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      data-sidebar="menu-badge"
      className={cn(
        "pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  ),
);
SidebarMenuBadge.displayName = "SidebarMenuBadge";

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean;
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, []);

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && <Skeleton className="size-4 rounded-md" data-sidebar="menu-skeleton-icon" />}
      <Skeleton
        className="h-4 max-w-[--skeleton-width] flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  );
});
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton";

const SidebarMenuSub = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(
  ({ className, ...props }, ref) => (
    <ul
      ref={ref}
      data-sidebar="menu-sub"
      className={cn(
        "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  ),
);
SidebarMenuSub.displayName = "SidebarMenuSub";

const SidebarMenuSubItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ ...props }, ref) => (
  <li ref={ref} {...props} />
));
SidebarMenuSubItem.displayName = "SidebarMenuSubItem";

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean;
    size?: "sm" | "md";
    isActive?: boolean;
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring aria-disabled:pointer-events-none aria-disabled:opacity-50 hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
});
SidebarMenuSubButton.displayName = "SidebarMenuSubButton";

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
};



============================================================
File Path: src/components/ui/skeleton.tsx
============================================================
import { cn } from "@/lib/utils";

function Skeleton({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) {
  return <div className={cn("animate-pulse rounded-md bg-muted", className)} {...props} />;
}

export { Skeleton };



============================================================
File Path: src/components/ui/slider.tsx
============================================================
import * as React from "react";
import * as SliderPrimitive from "@radix-ui/react-slider";

import { cn } from "@/lib/utils";

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn("relative flex w-full touch-none select-none items-center", className)}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
));
Slider.displayName = SliderPrimitive.Root.displayName;

export { Slider };



============================================================
File Path: src/components/ui/sonner.tsx
============================================================
import { useTheme } from "next-themes";
import { Toaster as Sonner, toast } from "sonner";

type ToasterProps = React.ComponentProps<typeof Sonner>;

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme();

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton: "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton: "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  );
};

export { Toaster, toast };



============================================================
File Path: src/components/ui/switch.tsx
============================================================
import * as React from "react";
import * as SwitchPrimitives from "@radix-ui/react-switch";

import { cn } from "@/lib/utils";

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",
      className,
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0",
      )}
    />
  </SwitchPrimitives.Root>
));
Switch.displayName = SwitchPrimitives.Root.displayName;

export { Switch };



============================================================
File Path: src/components/ui/table.tsx
============================================================
import * as React from "react";

import { cn } from "@/lib/utils";

const Table = React.forwardRef<HTMLTableElement, React.HTMLAttributes<HTMLTableElement>>(
  ({ className, ...props }, ref) => (
    <div className="relative w-full overflow-auto">
      <table ref={ref} className={cn("w-full caption-bottom text-sm", className)} {...props} />
    </div>
  ),
);
Table.displayName = "Table";

const TableHeader = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />,
);
TableHeader.displayName = "TableHeader";

const TableBody = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => (
    <tbody ref={ref} className={cn("[&_tr:last-child]:border-0", className)} {...props} />
  ),
);
TableBody.displayName = "TableBody";

const TableFooter = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => (
    <tfoot ref={ref} className={cn("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0", className)} {...props} />
  ),
);
TableFooter.displayName = "TableFooter";

const TableRow = React.forwardRef<HTMLTableRowElement, React.HTMLAttributes<HTMLTableRowElement>>(
  ({ className, ...props }, ref) => (
    <tr
      ref={ref}
      className={cn("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50", className)}
      {...props}
    />
  ),
);
TableRow.displayName = "TableRow";

const TableHead = React.forwardRef<HTMLTableCellElement, React.ThHTMLAttributes<HTMLTableCellElement>>(
  ({ className, ...props }, ref) => (
    <th
      ref={ref}
      className={cn(
        "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
        className,
      )}
      {...props}
    />
  ),
);
TableHead.displayName = "TableHead";

const TableCell = React.forwardRef<HTMLTableCellElement, React.TdHTMLAttributes<HTMLTableCellElement>>(
  ({ className, ...props }, ref) => (
    <td ref={ref} className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)} {...props} />
  ),
);
TableCell.displayName = "TableCell";

const TableCaption = React.forwardRef<HTMLTableCaptionElement, React.HTMLAttributes<HTMLTableCaptionElement>>(
  ({ className, ...props }, ref) => (
    <caption ref={ref} className={cn("mt-4 text-sm text-muted-foreground", className)} {...props} />
  ),
);
TableCaption.displayName = "TableCaption";

export { Table, TableHeader, TableBody, TableFooter, TableHead, TableRow, TableCell, TableCaption };



============================================================
File Path: src/components/ui/tabs.tsx
============================================================
import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";

import { cn } from "@/lib/utils";

const Tabs = TabsPrimitive.Root;

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className,
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
      className,
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className,
    )}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export { Tabs, TabsList, TabsTrigger, TabsContent };



============================================================
File Path: src/components/ui/textarea.tsx
============================================================
import * as React from "react";

import { cn } from "@/lib/utils";

export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      ref={ref}
      {...props}
    />
  );
});
Textarea.displayName = "Textarea";

export { Textarea };



============================================================
File Path: src/components/ui/toast.tsx
============================================================
import * as React from "react";
import * as ToastPrimitives from "@radix-ui/react-toast";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const ToastProvider = ToastPrimitives.Provider;

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className,
    )}
    {...props}
  />
));
ToastViewport.displayName = ToastPrimitives.Viewport.displayName;

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive: "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> & VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return <ToastPrimitives.Root ref={ref} className={cn(toastVariants({ variant }), className)} {...props} />;
});
Toast.displayName = ToastPrimitives.Root.displayName;

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors group-[.destructive]:border-muted/40 hover:bg-secondary group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 group-[.destructive]:focus:ring-destructive disabled:pointer-events-none disabled:opacity-50",
      className,
    )}
    {...props}
  />
));
ToastAction.displayName = ToastPrimitives.Action.displayName;

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity group-hover:opacity-100 group-[.destructive]:text-red-300 hover:text-foreground group-[.destructive]:hover:text-red-50 focus:opacity-100 focus:outline-none focus:ring-2 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className,
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
));
ToastClose.displayName = ToastPrimitives.Close.displayName;

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title ref={ref} className={cn("text-sm font-semibold", className)} {...props} />
));
ToastTitle.displayName = ToastPrimitives.Title.displayName;

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description ref={ref} className={cn("text-sm opacity-90", className)} {...props} />
));
ToastDescription.displayName = ToastPrimitives.Description.displayName;

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>;

type ToastActionElement = React.ReactElement<typeof ToastAction>;

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
};



============================================================
File Path: src/components/ui/toaster.tsx
============================================================
import { useToast } from "@/hooks/use-toast";
import { Toast, ToastClose, ToastDescription, ToastProvider, ToastTitle, ToastViewport } from "@/components/ui/toast";

export function Toaster() {
  const { toasts } = useToast();

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && <ToastDescription>{description}</ToastDescription>}
            </div>
            {action}
            <ToastClose />
          </Toast>
        );
      })}
      <ToastViewport />
    </ToastProvider>
  );
}



============================================================
File Path: src/components/ui/toggle-group.tsx
============================================================
import * as React from "react";
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group";
import { type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { toggleVariants } from "@/components/ui/toggle";

const ToggleGroupContext = React.createContext<VariantProps<typeof toggleVariants>>({
  size: "default",
  variant: "default",
});

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> & VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root ref={ref} className={cn("flex items-center justify-center gap-1", className)} {...props}>
    <ToggleGroupContext.Provider value={{ variant, size }}>{children}</ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
));

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName;

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> & VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext);

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  );
});

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName;

export { ToggleGroup, ToggleGroupItem };



============================================================
File Path: src/components/ui/toggle.tsx
============================================================
import * as React from "react";
import * as TogglePrimitive from "@radix-ui/react-toggle";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3",
        sm: "h-9 px-2.5",
        lg: "h-11 px-5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> & VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root ref={ref} className={cn(toggleVariants({ variant, size, className }))} {...props} />
));

Toggle.displayName = TogglePrimitive.Root.displayName;

export { Toggle, toggleVariants };



============================================================
File Path: src/components/ui/tooltip.tsx
============================================================
import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";

import { cn } from "@/lib/utils";

const TooltipProvider = TooltipPrimitive.Provider;

const Tooltip = TooltipPrimitive.Root;

const TooltipTrigger = TooltipPrimitive.Trigger;

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };



============================================================
File Path: src/components/ui/use-toast.ts
============================================================
import { useToast, toast } from "@/hooks/use-toast";

export { useToast, toast };



============================================================
File Path: src/hooks/use-mobile.tsx
============================================================
import * as React from "react";

const MOBILE_BREAKPOINT = 768;

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined);

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    };
    mql.addEventListener("change", onChange);
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  return !!isMobile;
}



============================================================
File Path: src/hooks/use-toast.ts
============================================================
import * as React from "react";

import type { ToastActionElement, ToastProps } from "@/components/ui/toast";

const TOAST_LIMIT = 1;
const TOAST_REMOVE_DELAY = 1000000;

type ToasterToast = ToastProps & {
  id: string;
  title?: React.ReactNode;
  description?: React.ReactNode;
  action?: ToastActionElement;
};

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const;

let count = 0;

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER;
  return count.toString();
}

type ActionType = typeof actionTypes;

type Action =
  | {
      type: ActionType["ADD_TOAST"];
      toast: ToasterToast;
    }
  | {
      type: ActionType["UPDATE_TOAST"];
      toast: Partial<ToasterToast>;
    }
  | {
      type: ActionType["DISMISS_TOAST"];
      toastId?: ToasterToast["id"];
    }
  | {
      type: ActionType["REMOVE_TOAST"];
      toastId?: ToasterToast["id"];
    };

interface State {
  toasts: ToasterToast[];
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>();

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return;
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId);
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    });
  }, TOAST_REMOVE_DELAY);

  toastTimeouts.set(toastId, timeout);
};

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      };

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) => (t.id === action.toast.id ? { ...t, ...action.toast } : t)),
      };

    case "DISMISS_TOAST": {
      const { toastId } = action;

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId);
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id);
        });
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      };
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        };
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      };
  }
};

const listeners: Array<(state: State) => void> = [];

let memoryState: State = { toasts: [] };

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
}

type Toast = Omit<ToasterToast, "id">;

function toast({ ...props }: Toast) {
  const id = genId();

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    });
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id });

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss();
      },
    },
  });

  return {
    id: id,
    dismiss,
    update,
  };
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState);

  React.useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  };
}

export { useToast, toast };



============================================================
File Path: src/hooks/useAuth.tsx
============================================================
import { useState, useEffect, createContext, useContext, ReactNode } from "react";
import { supabase } from "@/integrations/supabase/client";
import { User, Session } from "@supabase/supabase-js";

interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
  phone: string | null;
  system_role: "sys_super_admin" | "regular_user";
}

interface TenantMembership {
  id: string;
  tenant_id: string;
  role: "company_admin" | "manager" | "employee";
  department: string | null;
  job_title: string | null;
  is_suspended?: boolean;
  tenant: {
    id: string;
    name: string;
    domain: string | null;
    logo_url: string | null;
  };
}

interface SignupRequest {
  id: string;
  user_id: string;
  company_name: string;
  status: "pending" | "approved" | "rejected";
  assigned_tenant_id: string | null;
  created_at: string;
}

interface AuthContextType {
  user: User | null;
  session: Session | null;
  profile: Profile | null;
  memberships: TenantMembership[];
  currentTenant: TenantMembership | null;
  setCurrentTenant: (membership: TenantMembership | null) => void;
  loading: boolean;
  signUp: (email: string, password: string, fullName: string, companyName: string, companyType?: string) => Promise<{ error: Error | null }>;
  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;
  signOut: () => Promise<void>;
  isSuperAdmin: boolean;
  isCompanyAdmin: boolean;
  signupRequest: SignupRequest | null;
  isPendingApproval: boolean;
  isSuspended: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [memberships, setMemberships] = useState<TenantMembership[]>([]);
  const [currentTenant, setCurrentTenant] = useState<TenantMembership | null>(null);
  const [loading, setLoading] = useState(true);
  const [signupRequest, setSignupRequest] = useState<SignupRequest | null>(null);

  const isSuperAdmin = profile?.system_role === "sys_super_admin";
  const isCompanyAdmin = isSuperAdmin || currentTenant?.role === "company_admin";
  const isPendingApproval = signupRequest?.status === "pending" && memberships.length === 0;
  const isSuspended = currentTenant?.is_suspended === true;

  const fetchProfile = async (userId: string) => {
    const { data, error } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", userId)
      .single();
    if (error) return null;
    return data as Profile;
  };

  const fetchMemberships = async (userId: string) => {
    const { data, error } = await supabase
      .from("tenant_memberships")
      .select(`
        id, tenant_id, role, department, job_title, is_suspended,
        tenant:tenants ( id, name, domain, logo_url )
      `)
      .eq("user_id", userId);
    if (error) return [];
    return data as unknown as TenantMembership[];
  };

  const fetchAllTenantsAsMemberships = async () => {
    const { data, error } = await supabase
      .from("tenants")
      .select("id, name, domain, logo_url")
      .order("name");
    if (error) return [];
    return data.map((t) => ({
      id: `admin-${t.id}`,
      tenant_id: t.id,
      role: "company_admin" as const,
      tenant: t,
      department: "시스템 총괄",
      job_title: "Super Admin",
    })) as TenantMembership[];
  };

  const fetchSignupRequest = async (userId: string) => {
    const { data, error } = await supabase
      .from("signup_requests")
      .select("*")
      .eq("user_id", userId)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();
    if (error) return null;
    return data as SignupRequest | null;
  };

  const loadUserData = async (userId: string) => {
    try {
      const profileData = await fetchProfile(userId);
      setProfile(profileData);

      let mData: TenantMembership[] = [];
      if (profileData?.system_role === "sys_super_admin") {
        mData = await fetchAllTenantsAsMemberships();
      } else {
        mData = await fetchMemberships(userId);
      }
      
      setMemberships(mData);
      if (mData.length > 0) {
        setCurrentTenant(mData[0]);
      }

      const sData = await fetchSignupRequest(userId);
      setSignupRequest(sData);
    } catch (error) {
      console.error("loadUserData error:", error);
      // 에러가 나도 상태를 초기화하여 앱이 멈추지 않도록 함
    }
  };

  useEffect(() => {
    let mounted = true;

    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (!mounted) return;

        if (event === 'SIGNED_OUT') {
          setSession(null);
          setUser(null);
          setProfile(null);
          setMemberships([]);
          setCurrentTenant(null);
          setSignupRequest(null);
          setLoading(false);
          return;
        }

        if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
          setSession(session);
          setUser(session?.user ?? null);
          if (session?.user) {
            // setTimeout으로 Supabase 내부 콜백 외부에서 실행 (데드락 방지)
            setTimeout(async () => {
              if (!mounted) return;
              await loadUserData(session.user.id);
              if (mounted) setLoading(false);
            }, 0);
          } else {
            setLoading(false);
          }
        }
      }
    );

    return () => {
      mounted = false;
      subscription.unsubscribe();
    };
  }, []);

  const signUp = async (email: string, password: string, fullName: string, companyName: string, companyType?: string) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: window.location.origin,
        data: { full_name: fullName },
      },
    });

    if (!error && data.user) {
      const { data: invitations } = await supabase
        .from("employee_invitations")
        .select("*")
        .eq("email", email.toLowerCase())
        .eq("status", "pending")
        .gt("expires_at", new Date().toISOString());

      if (invitations && invitations.length > 0) {
        const invite = invitations[0];
        
        await supabase.from("tenant_memberships").insert([{
          user_id: data.user.id,
          tenant_id: invite.tenant_id,
          role: invite.role as "company_admin" | "manager" | "employee",
          department: invite.department,
          job_title: invite.job_title,
        }]);

        await supabase
          .from("employee_invitations")
          .update({ status: "accepted", accepted_at: new Date().toISOString() })
          .eq("id", invite.id);
      } else {
        await supabase.from("signup_requests").insert({
          user_id: data.user.id,
          company_name: companyName,
          ...(companyType ? { company_type: companyType } : {}),
        } as any);
      }
    }
    return { error };
  };

  const signIn = async (email: string, password: string) => {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    return { error };
  };

  const signOut = async () => {
    // 1. Supabase 세션을 먼저 무효화 (SDK 내부 메모리 + 스토리지 정리)
    try {
      await supabase.auth.signOut({ scope: "local" });
    } catch (error) {
      console.error("Sign out error:", error);
    }

    // 2. SDK가 혹시 다시 쓸 수 있으므로 signOut 이후에 스토리지 강제 삭제
    try {
      sessionStorage.clear();
      localStorage.clear();
    } catch (e) {
      console.warn("Storage clear error:", e);
    }

    // 3. 상태 초기화
    setSession(null);
    setUser(null);
    setProfile(null);
    setMemberships([]);
    setCurrentTenant(null);
    setSignupRequest(null);

    // 4. 뒤로가기 복원 불가능하도록 replace
    window.location.replace("/auth");
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        session,
        profile,
        memberships,
        currentTenant,
        setCurrentTenant,
        loading,
        signUp,
        signIn,
        signOut,
        isSuperAdmin,
        isCompanyAdmin,
        signupRequest,
        isPendingApproval,
        isSuspended,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error("useAuth must be used within an AuthProvider");
  }
  return context;
};


============================================================
File Path: src/hooks/useGeolocation.ts
============================================================
import { useState, useEffect, useCallback, useRef } from "react";

interface GeolocationState {
  latitude: number | null;
  longitude: number | null;
  accuracy: number | null;
  speed: number | null;
  heading: number | null;
  timestamp: number | null;
  error: string | null;
  isTracking: boolean;
}

interface UseGeolocationOptions {
  enableHighAccuracy?: boolean;
  timeout?: number;
  maximumAge?: number;
}

export function useGeolocation(options: UseGeolocationOptions = {}) {
  const [state, setState] = useState<GeolocationState>({
    latitude: null,
    longitude: null,
    accuracy: null,
    speed: null,
    heading: null,
    timestamp: null,
    error: null,
    isTracking: false,
  });

  const watchIdRef = useRef<number | null>(null);
  const positionHistoryRef = useRef<{ lat: number; lng: number; time: number }[]>([]);

  const calculateDistance = useCallback((lat1: number, lon1: number, lat2: number, lon2: number): number => {
    const R = 6371; // Earth's radius in km
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }, []);

  const getTotalDistance = useCallback((): number => {
    let totalDistance = 0;
    const history = positionHistoryRef.current;
    for (let i = 1; i < history.length; i++) {
      totalDistance += calculateDistance(
        history[i - 1].lat,
        history[i - 1].lng,
        history[i].lat,
        history[i].lng
      );
    }
    return totalDistance;
  }, [calculateDistance]);

  const startTracking = useCallback(() => {
    if (!navigator.geolocation) {
      setState((prev) => ({ ...prev, error: "Geolocation is not supported" }));
      return;
    }

    positionHistoryRef.current = [];

    const handleSuccess = (position: GeolocationPosition) => {
      const { latitude, longitude, accuracy, speed, heading } = position.coords;
      
      positionHistoryRef.current.push({
        lat: latitude,
        lng: longitude,
        time: position.timestamp,
      });

      setState({
        latitude,
        longitude,
        accuracy,
        speed: speed ? speed * 3.6 : null, // Convert m/s to km/h
        heading,
        timestamp: position.timestamp,
        error: null,
        isTracking: true,
      });
    };

    const handleError = (error: GeolocationPositionError) => {
      setState((prev) => ({
        ...prev,
        error: error.message,
        isTracking: false,
      }));
    };

    watchIdRef.current = navigator.geolocation.watchPosition(
      handleSuccess,
      handleError,
      {
        enableHighAccuracy: options.enableHighAccuracy ?? true,
        timeout: options.timeout ?? 10000,
        maximumAge: options.maximumAge ?? 0,
      }
    );

    setState((prev) => ({ ...prev, isTracking: true }));
  }, [options.enableHighAccuracy, options.timeout, options.maximumAge]);

  const stopTracking = useCallback(() => {
    if (watchIdRef.current !== null) {
      navigator.geolocation.clearWatch(watchIdRef.current);
      watchIdRef.current = null;
    }
    setState((prev) => ({ ...prev, isTracking: false }));
  }, []);

  const getCurrentPosition = useCallback((): Promise<GeolocationPosition> => {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation is not supported"));
        return;
      }

      navigator.geolocation.getCurrentPosition(
        resolve,
        reject,
        {
          enableHighAccuracy: options.enableHighAccuracy ?? true,
          timeout: options.timeout ?? 10000,
          maximumAge: options.maximumAge ?? 0,
        }
      );
    });
  }, [options.enableHighAccuracy, options.timeout, options.maximumAge]);

  useEffect(() => {
    return () => {
      if (watchIdRef.current !== null) {
        navigator.geolocation.clearWatch(watchIdRef.current);
      }
    };
  }, []);

  return {
    ...state,
    startTracking,
    stopTracking,
    getCurrentPosition,
    getTotalDistance,
    positionHistory: positionHistoryRef.current,
  };
}



============================================================
File Path: src/integrations/supabase/client.ts
============================================================
// This file is automatically generated. Do not edit it directly.
// (If you need to customize behavior, do it here in your own repo after export.)
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL as string | undefined;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY as string | undefined;

// 작은 헬퍼: 브라우저 환경인지 체크 (빌드/프리렌더/SSR 대비)
const isBrowser = typeof window !== 'undefined';

// env 누락 시 원인 파악이 어렵기 때문에, 개발 중에는 즉시 터뜨려주는 게 좋음
if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  // production에서도 조용히 실패하면 디버깅이 더 어려워서 에러를 명확히
  throw new Error(
    [
      'Missing Supabase environment variables.',
      'Please set:',
      '- VITE_SUPABASE_URL',
      '- VITE_SUPABASE_PUBLISHABLE_KEY',
    ].join('\n')
  );
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    // 브라우저가 아닐 때(localStorage 없음) 크래시 방지
    storage: isBrowser ? window.localStorage : undefined,
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
});



============================================================
File Path: src/integrations/supabase/types.ts
============================================================
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "14.1"
  }
  public: {
    Tables: {
      approval_lines: {
        Row: {
          approver_user_id: string
          created_at: string
          id: string
          step_order: number
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          approver_user_id: string
          created_at?: string
          id?: string
          step_order: number
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          approver_user_id?: string
          created_at?: string
          id?: string
          step_order?: number
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "approval_lines_approver_user_id_fkey"
            columns: ["approver_user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "approval_lines_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "approval_lines_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      artist_schedules: {
        Row: {
          artist_id: string
          created_at: string
          created_by: string | null
          description: string | null
          end_time: string
          id: string
          is_all_day: boolean | null
          location: string | null
          schedule_type: string | null
          start_time: string
          tenant_id: string
          title: string
          updated_at: string
        }
        Insert: {
          artist_id: string
          created_at?: string
          created_by?: string | null
          description?: string | null
          end_time: string
          id?: string
          is_all_day?: boolean | null
          location?: string | null
          schedule_type?: string | null
          start_time: string
          tenant_id: string
          title: string
          updated_at?: string
        }
        Update: {
          artist_id?: string
          created_at?: string
          created_by?: string | null
          description?: string | null
          end_time?: string
          id?: string
          is_all_day?: boolean | null
          location?: string | null
          schedule_type?: string | null
          start_time?: string
          tenant_id?: string
          title?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "artist_schedules_artist_id_fkey"
            columns: ["artist_id"]
            isOneToOne: false
            referencedRelation: "artists"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "artist_schedules_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      artists: {
        Row: {
          address: string | null
          agency: string | null
          bio: string | null
          birth_date: string | null
          contact_phone: string | null
          contract_end_date: string | null
          contract_start_date: string | null
          created_at: string
          created_by: string | null
          debut_date: string | null
          email: string | null
          gender: string | null
          id: string
          id_card_masked_url: string | null
          id_card_url: string | null
          instagram_url: string | null
          is_active: boolean | null
          name: string
          namuwiki_url: string | null
          profile_image_url: string | null
          resident_number: string | null
          signature_url: string | null
          social_links: Json | null
          stage_name: string | null
          tenant_id: string
          updated_at: string
          youtube_url: string | null
        }
        Insert: {
          address?: string | null
          agency?: string | null
          bio?: string | null
          birth_date?: string | null
          contact_phone?: string | null
          contract_end_date?: string | null
          contract_start_date?: string | null
          created_at?: string
          created_by?: string | null
          debut_date?: string | null
          email?: string | null
          gender?: string | null
          id?: string
          id_card_masked_url?: string | null
          id_card_url?: string | null
          instagram_url?: string | null
          is_active?: boolean | null
          name: string
          namuwiki_url?: string | null
          profile_image_url?: string | null
          resident_number?: string | null
          signature_url?: string | null
          social_links?: Json | null
          stage_name?: string | null
          tenant_id: string
          updated_at?: string
          youtube_url?: string | null
        }
        Update: {
          address?: string | null
          agency?: string | null
          bio?: string | null
          birth_date?: string | null
          contact_phone?: string | null
          contract_end_date?: string | null
          contract_start_date?: string | null
          created_at?: string
          created_by?: string | null
          debut_date?: string | null
          email?: string | null
          gender?: string | null
          id?: string
          id_card_masked_url?: string | null
          id_card_url?: string | null
          instagram_url?: string | null
          is_active?: boolean | null
          name?: string
          namuwiki_url?: string | null
          profile_image_url?: string | null
          resident_number?: string | null
          signature_url?: string | null
          social_links?: Json | null
          stage_name?: string | null
          tenant_id?: string
          updated_at?: string
          youtube_url?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "artists_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      attendance_records: {
        Row: {
          clock_in: string | null
          clock_in_method: string
          clock_out: string | null
          clock_out_method: string
          created_at: string
          date: string
          id: string
          memo: string | null
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          clock_in?: string | null
          clock_in_method?: string
          clock_out?: string | null
          clock_out_method?: string
          created_at?: string
          date?: string
          id?: string
          memo?: string | null
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          clock_in?: string | null
          clock_in_method?: string
          clock_out?: string | null
          clock_out_method?: string
          created_at?: string
          date?: string
          id?: string
          memo?: string | null
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: []
      }
      card_transactions: {
        Row: {
          amount: number
          card_id: string
          category: string | null
          created_at: string
          id: string
          memo: string | null
          merchant_name: string | null
          project_id: string | null
          receipt_url: string | null
          status: string | null
          tenant_id: string
          transaction_date: string
        }
        Insert: {
          amount: number
          card_id: string
          category?: string | null
          created_at?: string
          id?: string
          memo?: string | null
          merchant_name?: string | null
          project_id?: string | null
          receipt_url?: string | null
          status?: string | null
          tenant_id: string
          transaction_date: string
        }
        Update: {
          amount?: number
          card_id?: string
          category?: string | null
          created_at?: string
          id?: string
          memo?: string | null
          merchant_name?: string | null
          project_id?: string | null
          receipt_url?: string | null
          status?: string | null
          tenant_id?: string
          transaction_date?: string
        }
        Relationships: [
          {
            foreignKeyName: "card_transactions_card_id_fkey"
            columns: ["card_id"]
            isOneToOne: false
            referencedRelation: "corporate_cards"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "card_transactions_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "card_transactions_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      commute_locations: {
        Row: {
          created_at: string
          distance_km: number | null
          home_address: string | null
          home_lat: number | null
          home_lng: number | null
          id: string
          office_address: string | null
          office_lat: number | null
          office_lng: number | null
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          created_at?: string
          distance_km?: number | null
          home_address?: string | null
          home_lat?: number | null
          home_lng?: number | null
          id?: string
          office_address?: string | null
          office_lat?: number | null
          office_lng?: number | null
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          created_at?: string
          distance_km?: number | null
          home_address?: string | null
          home_lat?: number | null
          home_lng?: number | null
          id?: string
          office_address?: string | null
          office_lat?: number | null
          office_lng?: number | null
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "commute_locations_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "commute_locations_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      corporate_cards: {
        Row: {
          card_company: string | null
          card_holder_name: string | null
          card_image_url: string | null
          card_name: string | null
          card_number: string
          card_type: string | null
          created_at: string
          cvc: string | null
          expiry_date: string | null
          holder_user_id: string | null
          id: string
          is_active: boolean | null
          is_skypass: boolean | null
          monthly_limit: number | null
          tenant_id: string
          updated_at: string
        }
        Insert: {
          card_company?: string | null
          card_holder_name?: string | null
          card_image_url?: string | null
          card_name?: string | null
          card_number: string
          card_type?: string | null
          created_at?: string
          cvc?: string | null
          expiry_date?: string | null
          holder_user_id?: string | null
          id?: string
          is_active?: boolean | null
          is_skypass?: boolean | null
          monthly_limit?: number | null
          tenant_id: string
          updated_at?: string
        }
        Update: {
          card_company?: string | null
          card_holder_name?: string | null
          card_image_url?: string | null
          card_name?: string | null
          card_number?: string
          card_type?: string | null
          created_at?: string
          cvc?: string | null
          expiry_date?: string | null
          holder_user_id?: string | null
          id?: string
          is_active?: boolean | null
          is_skypass?: boolean | null
          monthly_limit?: number | null
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "corporate_cards_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      departments: {
        Row: {
          created_at: string
          description: string | null
          id: string
          is_active: boolean | null
          name: string
          parent_id: string | null
          sort_order: number | null
          tenant_id: string | null
          updated_at: string
        }
        Insert: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean | null
          name: string
          parent_id?: string | null
          sort_order?: number | null
          tenant_id?: string | null
          updated_at?: string
        }
        Update: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean | null
          name?: string
          parent_id?: string | null
          sort_order?: number | null
          tenant_id?: string | null
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "departments_parent_id_fkey"
            columns: ["parent_id"]
            isOneToOne: false
            referencedRelation: "departments"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "departments_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      drive_folder_mappings: {
        Row: {
          created_at: string
          folder_id: string
          folder_key: string
          folder_name: string | null
          folder_path: string | null
          id: string
          is_active: boolean
          tenant_id: string
          updated_at: string
        }
        Insert: {
          created_at?: string
          folder_id: string
          folder_key: string
          folder_name?: string | null
          folder_path?: string | null
          id?: string
          is_active?: boolean
          tenant_id: string
          updated_at?: string
        }
        Update: {
          created_at?: string
          folder_id?: string
          folder_key?: string
          folder_name?: string | null
          folder_path?: string | null
          id?: string
          is_active?: boolean
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "drive_folder_mappings_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      driving_log_waypoints: {
        Row: {
          heading: number | null
          id: string
          latitude: number
          log_id: string
          longitude: number
          recorded_at: string
          speed_kmh: number | null
        }
        Insert: {
          heading?: number | null
          id?: string
          latitude: number
          log_id: string
          longitude: number
          recorded_at?: string
          speed_kmh?: number | null
        }
        Update: {
          heading?: number | null
          id?: string
          latitude?: number
          log_id?: string
          longitude?: number
          recorded_at?: string
          speed_kmh?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "driving_log_waypoints_log_id_fkey"
            columns: ["log_id"]
            isOneToOne: false
            referencedRelation: "driving_logs"
            referencedColumns: ["id"]
          },
        ]
      }
      driving_logs: {
        Row: {
          created_at: string
          distance_km: number | null
          driver_user_id: string | null
          end_address: string | null
          end_location_lat: number | null
          end_location_lng: number | null
          end_time: string | null
          id: string
          memo: string | null
          purpose: string | null
          start_address: string | null
          start_location_lat: number | null
          start_location_lng: number | null
          start_time: string
          status: string
          tenant_id: string
          updated_at: string
          vehicle_id: string
        }
        Insert: {
          created_at?: string
          distance_km?: number | null
          driver_user_id?: string | null
          end_address?: string | null
          end_location_lat?: number | null
          end_location_lng?: number | null
          end_time?: string | null
          id?: string
          memo?: string | null
          purpose?: string | null
          start_address?: string | null
          start_location_lat?: number | null
          start_location_lng?: number | null
          start_time?: string
          status?: string
          tenant_id: string
          updated_at?: string
          vehicle_id: string
        }
        Update: {
          created_at?: string
          distance_km?: number | null
          driver_user_id?: string | null
          end_address?: string | null
          end_location_lat?: number | null
          end_location_lng?: number | null
          end_time?: string | null
          id?: string
          memo?: string | null
          purpose?: string | null
          start_address?: string | null
          start_location_lat?: number | null
          start_location_lng?: number | null
          start_time?: string
          status?: string
          tenant_id?: string
          updated_at?: string
          vehicle_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "driving_logs_driver_user_id_fkey"
            columns: ["driver_user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "driving_logs_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "driving_logs_vehicle_id_fkey"
            columns: ["vehicle_id"]
            isOneToOne: false
            referencedRelation: "vehicles"
            referencedColumns: ["id"]
          },
        ]
      }
      employee_details: {
        Row: {
          account_holder: string | null
          account_number: string | null
          address: string | null
          bank_name: string | null
          bankbook_url: string | null
          created_at: string
          email: string | null
          emergency_contacts: Json | null
          hire_date: string | null
          id: string
          id_card_url: string | null
          is_foreigner: string | null
          nationality: string | null
          phone_mobile: string | null
          phone_tel: string | null
          resident_number: string | null
          resignation_date: string | null
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          account_holder?: string | null
          account_number?: string | null
          address?: string | null
          bank_name?: string | null
          bankbook_url?: string | null
          created_at?: string
          email?: string | null
          emergency_contacts?: Json | null
          hire_date?: string | null
          id?: string
          id_card_url?: string | null
          is_foreigner?: string | null
          nationality?: string | null
          phone_mobile?: string | null
          phone_tel?: string | null
          resident_number?: string | null
          resignation_date?: string | null
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          account_holder?: string | null
          account_number?: string | null
          address?: string | null
          bank_name?: string | null
          bankbook_url?: string | null
          created_at?: string
          email?: string | null
          emergency_contacts?: Json | null
          hire_date?: string | null
          id?: string
          id_card_url?: string | null
          is_foreigner?: string | null
          nationality?: string | null
          phone_mobile?: string | null
          phone_tel?: string | null
          resident_number?: string | null
          resignation_date?: string | null
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "employee_details_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "employee_details_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      employee_invitations: {
        Row: {
          accepted_at: string | null
          created_at: string
          department: string | null
          email: string
          expires_at: string
          id: string
          invited_by: string | null
          job_title: string | null
          role: string
          status: string
          tenant_id: string
          updated_at: string
        }
        Insert: {
          accepted_at?: string | null
          created_at?: string
          department?: string | null
          email: string
          expires_at?: string
          id?: string
          invited_by?: string | null
          job_title?: string | null
          role?: string
          status?: string
          tenant_id: string
          updated_at?: string
        }
        Update: {
          accepted_at?: string | null
          created_at?: string
          department?: string | null
          email?: string
          expires_at?: string
          id?: string
          invited_by?: string | null
          job_title?: string | null
          role?: string
          status?: string
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "employee_invitations_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      finance_accounts: {
        Row: {
          account_alias: string | null
          account_number: string | null
          business_type: string
          connected_id_key: string
          created_at: string
          id: string
          is_active: boolean
          organization: string
          tenant_id: string
          updated_at: string
        }
        Insert: {
          account_alias?: string | null
          account_number?: string | null
          business_type: string
          connected_id_key: string
          created_at?: string
          id?: string
          is_active?: boolean
          organization: string
          tenant_id: string
          updated_at?: string
        }
        Update: {
          account_alias?: string | null
          account_number?: string | null
          business_type?: string
          connected_id_key?: string
          created_at?: string
          id?: string
          is_active?: boolean
          organization?: string
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "finance_accounts_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      hr_records: {
        Row: {
          created_at: string
          created_by: string | null
          description: string | null
          effective_date: string
          id: string
          new_department: string | null
          new_job_title: string | null
          new_role: string | null
          old_department: string | null
          old_job_title: string | null
          old_role: string | null
          record_type: string
          tenant_id: string
          title: string
          updated_at: string
          user_id: string
        }
        Insert: {
          created_at?: string
          created_by?: string | null
          description?: string | null
          effective_date?: string
          id?: string
          new_department?: string | null
          new_job_title?: string | null
          new_role?: string | null
          old_department?: string | null
          old_job_title?: string | null
          old_role?: string | null
          record_type: string
          tenant_id: string
          title: string
          updated_at?: string
          user_id: string
        }
        Update: {
          created_at?: string
          created_by?: string | null
          description?: string | null
          effective_date?: string
          id?: string
          new_department?: string | null
          new_job_title?: string | null
          new_role?: string | null
          old_department?: string | null
          old_job_title?: string | null
          old_role?: string | null
          record_type?: string
          tenant_id?: string
          title?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "hr_records_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "hr_records_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "hr_records_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      invoice_attachments: {
        Row: {
          created_at: string
          file_name: string
          file_size: number | null
          file_type: string | null
          file_url: string
          id: string
          invoice_id: string
        }
        Insert: {
          created_at?: string
          file_name: string
          file_size?: number | null
          file_type?: string | null
          file_url: string
          id?: string
          invoice_id: string
        }
        Update: {
          created_at?: string
          file_name?: string
          file_size?: number | null
          file_type?: string | null
          file_url?: string
          id?: string
          invoice_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "invoice_attachments_invoice_id_fkey"
            columns: ["invoice_id"]
            isOneToOne: false
            referencedRelation: "vendor_invoices"
            referencedColumns: ["id"]
          },
        ]
      }
      job_titles: {
        Row: {
          created_at: string
          description: string | null
          id: string
          is_active: boolean | null
          level: number | null
          name: string
          tenant_id: string | null
          updated_at: string
        }
        Insert: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean | null
          level?: number | null
          name: string
          tenant_id?: string | null
          updated_at?: string
        }
        Update: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean | null
          level?: number | null
          name?: string
          tenant_id?: string | null
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "job_titles_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      keywords: {
        Row: {
          category: string | null
          created_at: string
          created_by: string | null
          id: string
          is_active: boolean | null
          keyword: string
          priority: number | null
          tenant_id: string
          updated_at: string
        }
        Insert: {
          category?: string | null
          created_at?: string
          created_by?: string | null
          id?: string
          is_active?: boolean | null
          keyword: string
          priority?: number | null
          tenant_id: string
          updated_at?: string
        }
        Update: {
          category?: string | null
          created_at?: string
          created_by?: string | null
          id?: string
          is_active?: boolean | null
          keyword?: string
          priority?: number | null
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "keywords_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      leave_balances: {
        Row: {
          created_at: string
          created_by: string | null
          generation_type: string
          group_id: string | null
          id: string
          memo: string | null
          tenant_id: string
          total_days: number
          updated_at: string
          used_days: number
          user_id: string
          valid_from: string
          valid_until: string | null
        }
        Insert: {
          created_at?: string
          created_by?: string | null
          generation_type?: string
          group_id?: string | null
          id?: string
          memo?: string | null
          tenant_id: string
          total_days?: number
          updated_at?: string
          used_days?: number
          user_id: string
          valid_from?: string
          valid_until?: string | null
        }
        Update: {
          created_at?: string
          created_by?: string | null
          generation_type?: string
          group_id?: string | null
          id?: string
          memo?: string | null
          tenant_id?: string
          total_days?: number
          updated_at?: string
          used_days?: number
          user_id?: string
          valid_from?: string
          valid_until?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "leave_balances_group_id_fkey"
            columns: ["group_id"]
            isOneToOne: false
            referencedRelation: "leave_groups"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "leave_balances_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "leave_balances_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      leave_groups: {
        Row: {
          created_at: string
          description: string | null
          id: string
          is_active: boolean
          name: string
          overdraft_limit: number | null
          sort_order: number | null
          tenant_id: string | null
          updated_at: string
        }
        Insert: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean
          name: string
          overdraft_limit?: number | null
          sort_order?: number | null
          tenant_id?: string | null
          updated_at?: string
        }
        Update: {
          created_at?: string
          description?: string | null
          id?: string
          is_active?: boolean
          name?: string
          overdraft_limit?: number | null
          sort_order?: number | null
          tenant_id?: string | null
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "leave_groups_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      leave_requests: {
        Row: {
          approved_at: string | null
          approved_by: string | null
          created_at: string
          end_date: string
          end_time: string | null
          id: string
          leave_type_id: string
          reason: string | null
          reject_reason: string | null
          start_date: string
          start_time: string | null
          status: string
          tenant_id: string
          total_days: number
          updated_at: string
          user_id: string
        }
        Insert: {
          approved_at?: string | null
          approved_by?: string | null
          created_at?: string
          end_date: string
          end_time?: string | null
          id?: string
          leave_type_id: string
          reason?: string | null
          reject_reason?: string | null
          start_date: string
          start_time?: string | null
          status?: string
          tenant_id: string
          total_days?: number
          updated_at?: string
          user_id: string
        }
        Update: {
          approved_at?: string | null
          approved_by?: string | null
          created_at?: string
          end_date?: string
          end_time?: string | null
          id?: string
          leave_type_id?: string
          reason?: string | null
          reject_reason?: string | null
          start_date?: string
          start_time?: string | null
          status?: string
          tenant_id?: string
          total_days?: number
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "leave_requests_leave_type_id_fkey"
            columns: ["leave_type_id"]
            isOneToOne: false
            referencedRelation: "leave_types"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "leave_requests_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "leave_requests_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      leave_types: {
        Row: {
          created_at: string
          deduction_days: number | null
          display_name: string | null
          group_id: string | null
          id: string
          include_holidays_in_consecutive: boolean | null
          is_active: boolean
          is_paid: boolean | null
          max_consecutive_days: number | null
          min_consecutive_days: number | null
          name: string
          paid_hours: number | null
          sort_order: number | null
          special_option: string | null
          tenant_id: string | null
          time_option: string
          updated_at: string
        }
        Insert: {
          created_at?: string
          deduction_days?: number | null
          display_name?: string | null
          group_id?: string | null
          id?: string
          include_holidays_in_consecutive?: boolean | null
          is_active?: boolean
          is_paid?: boolean | null
          max_consecutive_days?: number | null
          min_consecutive_days?: number | null
          name: string
          paid_hours?: number | null
          sort_order?: number | null
          special_option?: string | null
          tenant_id?: string | null
          time_option?: string
          updated_at?: string
        }
        Update: {
          created_at?: string
          deduction_days?: number | null
          display_name?: string | null
          group_id?: string | null
          id?: string
          include_holidays_in_consecutive?: boolean | null
          is_active?: boolean
          is_paid?: boolean | null
          max_consecutive_days?: number | null
          min_consecutive_days?: number | null
          name?: string
          paid_hours?: number | null
          sort_order?: number | null
          special_option?: string | null
          tenant_id?: string | null
          time_option?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "leave_types_group_id_fkey"
            columns: ["group_id"]
            isOneToOne: false
            referencedRelation: "leave_groups"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "leave_types_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      press_contacts: {
        Row: {
          contact_email: string
          contact_phone: string | null
          created_at: string
          created_by: string | null
          id: string
          media_company: string
          purpose: string | null
          reporter_name: string
          updated_at: string
        }
        Insert: {
          contact_email: string
          contact_phone?: string | null
          created_at?: string
          created_by?: string | null
          id?: string
          media_company: string
          purpose?: string | null
          reporter_name: string
          updated_at?: string
        }
        Update: {
          contact_email?: string
          contact_phone?: string | null
          created_at?: string
          created_by?: string | null
          id?: string
          media_company?: string
          purpose?: string | null
          reporter_name?: string
          updated_at?: string
        }
        Relationships: []
      }
      profiles: {
        Row: {
          avatar_url: string | null
          created_at: string
          email: string
          full_name: string | null
          id: string
          phone: string | null
          signature_url: string | null
          system_role: Database["public"]["Enums"]["system_role"]
          updated_at: string
        }
        Insert: {
          avatar_url?: string | null
          created_at?: string
          email: string
          full_name?: string | null
          id: string
          phone?: string | null
          signature_url?: string | null
          system_role?: Database["public"]["Enums"]["system_role"]
          updated_at?: string
        }
        Update: {
          avatar_url?: string | null
          created_at?: string
          email?: string
          full_name?: string | null
          id?: string
          phone?: string | null
          signature_url?: string | null
          system_role?: Database["public"]["Enums"]["system_role"]
          updated_at?: string
        }
        Relationships: []
      }
      projects: {
        Row: {
          budget: number | null
          code: string | null
          created_at: string
          created_by: string | null
          description: string | null
          end_date: string | null
          id: string
          is_active: boolean | null
          name: string
          pm_user_id: string | null
          start_date: string | null
          status: string | null
          tenant_id: string
          updated_at: string
        }
        Insert: {
          budget?: number | null
          code?: string | null
          created_at?: string
          created_by?: string | null
          description?: string | null
          end_date?: string | null
          id?: string
          is_active?: boolean | null
          name: string
          pm_user_id?: string | null
          start_date?: string | null
          status?: string | null
          tenant_id: string
          updated_at?: string
        }
        Update: {
          budget?: number | null
          code?: string | null
          created_at?: string
          created_by?: string | null
          description?: string | null
          end_date?: string | null
          id?: string
          is_active?: boolean | null
          name?: string
          pm_user_id?: string | null
          start_date?: string | null
          status?: string | null
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "projects_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      schedule_participants: {
        Row: {
          created_at: string
          id: string
          participant_company: string | null
          participant_name: string | null
          participant_type: string
          schedule_id: string
          tenant_id: string
          user_id: string | null
        }
        Insert: {
          created_at?: string
          id?: string
          participant_company?: string | null
          participant_name?: string | null
          participant_type?: string
          schedule_id: string
          tenant_id: string
          user_id?: string | null
        }
        Update: {
          created_at?: string
          id?: string
          participant_company?: string | null
          participant_name?: string | null
          participant_type?: string
          schedule_id?: string
          tenant_id?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "schedule_participants_schedule_id_fkey"
            columns: ["schedule_id"]
            isOneToOne: false
            referencedRelation: "artist_schedule_availability"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "schedule_participants_schedule_id_fkey"
            columns: ["schedule_id"]
            isOneToOne: false
            referencedRelation: "artist_schedules"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "schedule_participants_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      signup_requests: {
        Row: {
          assigned_tenant_id: string | null
          company_name: string
          company_type: Database["public"]["Enums"]["company_type"] | null
          created_at: string
          id: string
          reviewed_at: string | null
          reviewed_by: string | null
          status: string
          updated_at: string
          user_id: string
        }
        Insert: {
          assigned_tenant_id?: string | null
          company_name: string
          company_type?: Database["public"]["Enums"]["company_type"] | null
          created_at?: string
          id?: string
          reviewed_at?: string | null
          reviewed_by?: string | null
          status?: string
          updated_at?: string
          user_id: string
        }
        Update: {
          assigned_tenant_id?: string | null
          company_name?: string
          company_type?: Database["public"]["Enums"]["company_type"] | null
          created_at?: string
          id?: string
          reviewed_at?: string | null
          reviewed_by?: string | null
          status?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "signup_requests_assigned_tenant_id_fkey"
            columns: ["assigned_tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "signup_requests_reviewed_by_fkey"
            columns: ["reviewed_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      system_configs: {
        Row: {
          category: string | null
          created_at: string
          description: string | null
          key: string
          updated_at: string
          value: string
        }
        Insert: {
          category?: string | null
          created_at?: string
          description?: string | null
          key: string
          updated_at?: string
          value: string
        }
        Update: {
          category?: string | null
          created_at?: string
          description?: string | null
          key?: string
          updated_at?: string
          value?: string
        }
        Relationships: []
      }
      tenant_api_configs: {
        Row: {
          category: string | null
          config_key: string
          config_value: string
          created_at: string
          description: string | null
          id: string
          is_encrypted: boolean | null
          tenant_id: string
          updated_at: string
        }
        Insert: {
          category?: string | null
          config_key: string
          config_value: string
          created_at?: string
          description?: string | null
          id?: string
          is_encrypted?: boolean | null
          tenant_id: string
          updated_at?: string
        }
        Update: {
          category?: string | null
          config_key?: string
          config_value?: string
          created_at?: string
          description?: string | null
          id?: string
          is_encrypted?: boolean | null
          tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "tenant_api_configs_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      tenant_memberships: {
        Row: {
          created_at: string
          department: string | null
          id: string
          invited_by: string | null
          is_suspended: boolean
          job_title: string | null
          role: Database["public"]["Enums"]["tenant_role"]
          suspended_at: string | null
          suspended_by: string | null
          suspension_reason: string | null
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          created_at?: string
          department?: string | null
          id?: string
          invited_by?: string | null
          is_suspended?: boolean
          job_title?: string | null
          role?: Database["public"]["Enums"]["tenant_role"]
          suspended_at?: string | null
          suspended_by?: string | null
          suspension_reason?: string | null
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          created_at?: string
          department?: string | null
          id?: string
          invited_by?: string | null
          is_suspended?: boolean
          job_title?: string | null
          role?: Database["public"]["Enums"]["tenant_role"]
          suspended_at?: string | null
          suspended_by?: string | null
          suspension_reason?: string | null
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "tenant_memberships_invited_by_fkey"
            columns: ["invited_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tenant_memberships_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tenant_memberships_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      tenant_partnerships: {
        Row: {
          accepted_at: string | null
          accepted_by: string | null
          created_at: string
          data_scopes: string[]
          id: string
          invited_by: string | null
          message: string | null
          requester_tenant_id: string
          status: string
          target_tenant_id: string
          updated_at: string
        }
        Insert: {
          accepted_at?: string | null
          accepted_by?: string | null
          created_at?: string
          data_scopes?: string[]
          id?: string
          invited_by?: string | null
          message?: string | null
          requester_tenant_id: string
          status?: string
          target_tenant_id: string
          updated_at?: string
        }
        Update: {
          accepted_at?: string | null
          accepted_by?: string | null
          created_at?: string
          data_scopes?: string[]
          id?: string
          invited_by?: string | null
          message?: string | null
          requester_tenant_id?: string
          status?: string
          target_tenant_id?: string
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "tenant_partnerships_accepted_by_fkey"
            columns: ["accepted_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tenant_partnerships_invited_by_fkey"
            columns: ["invited_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tenant_partnerships_requester_tenant_id_fkey"
            columns: ["requester_tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tenant_partnerships_target_tenant_id_fkey"
            columns: ["target_tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      tenants: {
        Row: {
          address: string | null
          biz_item: string | null
          biz_number: string | null
          biz_type: string | null
          company_type: Database["public"]["Enums"]["company_type"] | null
          corp_number: string | null
          created_at: string
          domain: string | null
          drive_connected_at: string | null
          drive_connected_by: string | null
          drive_folder_id: string | null
          google_credentials: string | null
          id: string
          logo_url: string | null
          name: string
          opening_date: string | null
          rep_name: string | null
          tax_email: string | null
          updated_at: string
        }
        Insert: {
          address?: string | null
          biz_item?: string | null
          biz_number?: string | null
          biz_type?: string | null
          company_type?: Database["public"]["Enums"]["company_type"] | null
          corp_number?: string | null
          created_at?: string
          domain?: string | null
          drive_connected_at?: string | null
          drive_connected_by?: string | null
          drive_folder_id?: string | null
          google_credentials?: string | null
          id?: string
          logo_url?: string | null
          name: string
          opening_date?: string | null
          rep_name?: string | null
          tax_email?: string | null
          updated_at?: string
        }
        Update: {
          address?: string | null
          biz_item?: string | null
          biz_number?: string | null
          biz_type?: string | null
          company_type?: Database["public"]["Enums"]["company_type"] | null
          corp_number?: string | null
          created_at?: string
          domain?: string | null
          drive_connected_at?: string | null
          drive_connected_by?: string | null
          drive_folder_id?: string | null
          google_credentials?: string | null
          id?: string
          logo_url?: string | null
          name?: string
          opening_date?: string | null
          rep_name?: string | null
          tax_email?: string | null
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "tenants_drive_connected_by_fkey"
            columns: ["drive_connected_by"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      user_mail_configs: {
        Row: {
          created_at: string
          google_access_token: string | null
          google_email: string | null
          google_refresh_token: string | null
          google_token_expiry: string | null
          id: string
          is_active: boolean
          last_synced_at: string | null
          nw_client_id: string | null
          nw_client_secret: string | null
          nw_domain_id: string | null
          nw_private_key: string | null
          nw_service_account: string | null
          nw_user_id: string | null
          provider: string
          tenant_id: string
          updated_at: string
          user_id: string
        }
        Insert: {
          created_at?: string
          google_access_token?: string | null
          google_email?: string | null
          google_refresh_token?: string | null
          google_token_expiry?: string | null
          id?: string
          is_active?: boolean
          last_synced_at?: string | null
          nw_client_id?: string | null
          nw_client_secret?: string | null
          nw_domain_id?: string | null
          nw_private_key?: string | null
          nw_service_account?: string | null
          nw_user_id?: string | null
          provider: string
          tenant_id: string
          updated_at?: string
          user_id: string
        }
        Update: {
          created_at?: string
          google_access_token?: string | null
          google_email?: string | null
          google_refresh_token?: string | null
          google_token_expiry?: string | null
          id?: string
          is_active?: boolean
          last_synced_at?: string | null
          nw_client_id?: string | null
          nw_client_secret?: string | null
          nw_domain_id?: string | null
          nw_private_key?: string | null
          nw_service_account?: string | null
          nw_user_id?: string | null
          provider?: string
          tenant_id?: string
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "user_mail_configs_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "user_mail_configs_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      vehicle_accidents: {
        Row: {
          accident_date: string
          claim_amount: number | null
          created_at: string
          damage_cost: number | null
          description: string | null
          driver_user_id: string | null
          id: string
          insurance_claim: boolean | null
          status: string | null
          tenant_id: string
          updated_at: string
          vehicle_id: string
        }
        Insert: {
          accident_date: string
          claim_amount?: number | null
          created_at?: string
          damage_cost?: number | null
          description?: string | null
          driver_user_id?: string | null
          id?: string
          insurance_claim?: boolean | null
          status?: string | null
          tenant_id: string
          updated_at?: string
          vehicle_id: string
        }
        Update: {
          accident_date?: string
          claim_amount?: number | null
          created_at?: string
          damage_cost?: number | null
          description?: string | null
          driver_user_id?: string | null
          id?: string
          insurance_claim?: boolean | null
          status?: string | null
          tenant_id?: string
          updated_at?: string
          vehicle_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "vehicle_accidents_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "vehicle_accidents_vehicle_id_fkey"
            columns: ["vehicle_id"]
            isOneToOne: false
            referencedRelation: "vehicles"
            referencedColumns: ["id"]
          },
        ]
      }
      vehicles: {
        Row: {
          annual_contract_mileage: number | null
          assigned_user_id: string | null
          contact_number: string | null
          contract_end_date: string | null
          contract_manager: string | null
          contract_start_date: string | null
          created_at: string
          excess_mileage_fee: number | null
          fuel_type: string | null
          id: string
          initial_mileage: number | null
          insurance_company: string | null
          insurance_driver_age: string | null
          insurance_end_date: string | null
          insurance_expiry: string | null
          insurance_start_date: string | null
          is_active: boolean | null
          lease_company: string | null
          lease_end_date: string | null
          lease_start_date: string | null
          manufacturer: string | null
          model: string | null
          model_name: string | null
          monthly_fee: number | null
          monthly_lease_cost: number | null
          ownership_type: string | null
          payment_day: number | null
          payment_method: string | null
          plate_number: string | null
          primary_driver: string | null
          requires_log: boolean | null
          tenant_id: string
          updated_at: string
          usage_category: string | null
          vehicle_number: string | null
          vendor_name: string | null
          vin: string | null
          year: number | null
        }
        Insert: {
          annual_contract_mileage?: number | null
          assigned_user_id?: string | null
          contact_number?: string | null
          contract_end_date?: string | null
          contract_manager?: string | null
          contract_start_date?: string | null
          created_at?: string
          excess_mileage_fee?: number | null
          fuel_type?: string | null
          id?: string
          initial_mileage?: number | null
          insurance_company?: string | null
          insurance_driver_age?: string | null
          insurance_end_date?: string | null
          insurance_expiry?: string | null
          insurance_start_date?: string | null
          is_active?: boolean | null
          lease_company?: string | null
          lease_end_date?: string | null
          lease_start_date?: string | null
          manufacturer?: string | null
          model?: string | null
          model_name?: string | null
          monthly_fee?: number | null
          monthly_lease_cost?: number | null
          ownership_type?: string | null
          payment_day?: number | null
          payment_method?: string | null
          plate_number?: string | null
          primary_driver?: string | null
          requires_log?: boolean | null
          tenant_id: string
          updated_at?: string
          usage_category?: string | null
          vehicle_number?: string | null
          vendor_name?: string | null
          vin?: string | null
          year?: number | null
        }
        Update: {
          annual_contract_mileage?: number | null
          assigned_user_id?: string | null
          contact_number?: string | null
          contract_end_date?: string | null
          contract_manager?: string | null
          contract_start_date?: string | null
          created_at?: string
          excess_mileage_fee?: number | null
          fuel_type?: string | null
          id?: string
          initial_mileage?: number | null
          insurance_company?: string | null
          insurance_driver_age?: string | null
          insurance_end_date?: string | null
          insurance_expiry?: string | null
          insurance_start_date?: string | null
          is_active?: boolean | null
          lease_company?: string | null
          lease_end_date?: string | null
          lease_start_date?: string | null
          manufacturer?: string | null
          model?: string | null
          model_name?: string | null
          monthly_fee?: number | null
          monthly_lease_cost?: number | null
          ownership_type?: string | null
          payment_day?: number | null
          payment_method?: string | null
          plate_number?: string | null
          primary_driver?: string | null
          requires_log?: boolean | null
          tenant_id?: string
          updated_at?: string
          usage_category?: string | null
          vehicle_number?: string | null
          vendor_name?: string | null
          vin?: string | null
          year?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "vehicles_primary_driver_fkey"
            columns: ["primary_driver"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "vehicles_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      vendor_invoices: {
        Row: {
          account_holder: string | null
          account_number: string | null
          amount: number
          assigned_to: string | null
          bank_name: string | null
          business_number: string | null
          created_at: string
          description: string | null
          id: string
          processed_at: string | null
          status: string
          submitted_at: string
          tenant_id: string
          updated_at: string
          vendor_name: string
        }
        Insert: {
          account_holder?: string | null
          account_number?: string | null
          amount: number
          assigned_to?: string | null
          bank_name?: string | null
          business_number?: string | null
          created_at?: string
          description?: string | null
          id?: string
          processed_at?: string | null
          status?: string
          submitted_at?: string
          tenant_id: string
          updated_at?: string
          vendor_name: string
        }
        Update: {
          account_holder?: string | null
          account_number?: string | null
          amount?: number
          assigned_to?: string | null
          bank_name?: string | null
          business_number?: string | null
          created_at?: string
          description?: string | null
          id?: string
          processed_at?: string | null
          status?: string
          submitted_at?: string
          tenant_id?: string
          updated_at?: string
          vendor_name?: string
        }
        Relationships: [
          {
            foreignKeyName: "vendor_invoices_assigned_to_fkey"
            columns: ["assigned_to"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "vendor_invoices_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
      work_rules: {
        Row: {
          created_at: string
          created_by: string | null
          description: string | null
          id: string
          is_active: boolean
          is_default: boolean
          max_include_holidays: boolean
          max_period: string
          max_period_start_day: number | null
          max_work_hours: number
          max_work_unit: string
          name: string
          overtime_max_hours: number
          overtime_max_unit: string
          overtime_min_hours: number
          overtime_min_unit: string
          standard_include_holidays: boolean
          standard_period: string
          standard_period_start_day: number | null
          standard_work_hours: number
          standard_work_unit: string
          tenant_id: string | null
          updated_at: string
          work_days: string[]
        }
        Insert: {
          created_at?: string
          created_by?: string | null
          description?: string | null
          id?: string
          is_active?: boolean
          is_default?: boolean
          max_include_holidays?: boolean
          max_period?: string
          max_period_start_day?: number | null
          max_work_hours?: number
          max_work_unit?: string
          name: string
          overtime_max_hours?: number
          overtime_max_unit?: string
          overtime_min_hours?: number
          overtime_min_unit?: string
          standard_include_holidays?: boolean
          standard_period?: string
          standard_period_start_day?: number | null
          standard_work_hours?: number
          standard_work_unit?: string
          tenant_id?: string | null
          updated_at?: string
          work_days?: string[]
        }
        Update: {
          created_at?: string
          created_by?: string | null
          description?: string | null
          id?: string
          is_active?: boolean
          is_default?: boolean
          max_include_holidays?: boolean
          max_period?: string
          max_period_start_day?: number | null
          max_work_hours?: number
          max_work_unit?: string
          name?: string
          overtime_max_hours?: number
          overtime_max_unit?: string
          overtime_min_hours?: number
          overtime_min_unit?: string
          standard_include_holidays?: boolean
          standard_period?: string
          standard_period_start_day?: number | null
          standard_work_hours?: number
          standard_work_unit?: string
          tenant_id?: string | null
          updated_at?: string
          work_days?: string[]
        }
        Relationships: [
          {
            foreignKeyName: "work_rules_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      artist_schedule_availability: {
        Row: {
          artist_id: string | null
          created_at: string | null
          end_time: string | null
          id: string | null
          is_all_day: boolean | null
          schedule_type: string | null
          start_time: string | null
          tenant_id: string | null
        }
        Insert: {
          artist_id?: string | null
          created_at?: string | null
          end_time?: string | null
          id?: string | null
          is_all_day?: boolean | null
          schedule_type?: string | null
          start_time?: string | null
          tenant_id?: string | null
        }
        Update: {
          artist_id?: string | null
          created_at?: string | null
          end_time?: string | null
          id?: string | null
          is_all_day?: boolean | null
          schedule_type?: string | null
          start_time?: string | null
          tenant_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "artist_schedules_artist_id_fkey"
            columns: ["artist_id"]
            isOneToOne: false
            referencedRelation: "artists"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "artist_schedules_tenant_id_fkey"
            columns: ["tenant_id"]
            isOneToOne: false
            referencedRelation: "tenants"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Functions: {
      auto_clock_out: { Args: never; Returns: number }
      calculate_annual_leave_days: {
        Args: { _hire_date: string; _reference_date?: string }
        Returns: number
      }
      complete_onboarding: {
        Args: { _department: string; _job_title: string; _tenant_id: string }
        Returns: undefined
      }
      get_monthly_work_hours: {
        Args: {
          _month: number
          _tenant_id: string
          _user_id: string
          _year: number
        }
        Returns: {
          clock_in_time: string
          clock_out_method: string
          clock_out_time: string
          hours_worked: number
          work_date: string
        }[]
      }
      get_user_tenant_ids: { Args: never; Returns: string[] }
      get_weekly_work_hours: {
        Args: { _tenant_id: string; _user_id: string; _week_start: string }
        Returns: number
      }
      has_partner_scope: {
        Args: { scope: string; tenant_a: string; tenant_b: string }
        Returns: boolean
      }
      is_active_partner: {
        Args: { tenant_a: string; tenant_b: string }
        Returns: boolean
      }
      is_sys_super_admin: { Args: never; Returns: boolean }
      is_tenant_admin: { Args: { _tenant_id: string }; Returns: boolean }
      is_tenant_manager_or_admin: {
        Args: { _tenant_id: string }
        Returns: boolean
      }
      is_tenant_member: { Args: { _tenant_id: string }; Returns: boolean }
      shares_tenant_with: { Args: { target_user_id: string }; Returns: boolean }
      submit_vendor_invoice: {
        Args: {
          p_account_holder?: string
          p_account_number?: string
          p_amount: number
          p_bank_name?: string
          p_business_number?: string
          p_description?: string
          p_tenant_id: string
          p_vendor_name: string
        }
        Returns: string
      }
      user_has_partner_hr_scope: {
        Args: { _target_tenant_id: string }
        Returns: boolean
      }
    }
    Enums: {
      company_type:
        | "talent_agency"
        | "pr_agency"
        | "finance_outsourcing"
        | "marketing_agency"
        | "production_agency"
        | "sales_agency"
      system_role: "sys_super_admin" | "regular_user"
      tenant_role: "company_admin" | "manager" | "employee"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {
      company_type: [
        "talent_agency",
        "pr_agency",
        "finance_outsourcing",
        "marketing_agency",
        "production_agency",
        "sales_agency",
      ],
      system_role: ["sys_super_admin", "regular_user"],
      tenant_role: ["company_admin", "manager", "employee"],
    },
  },
} as const



============================================================
File Path: src/lib/companyTypes.ts
============================================================
export const COMPANY_TYPES = [
  { value: "talent_agency", label: "배우 매니지먼트사", emoji: "🎬" },
  { value: "pr_agency", label: "PR 에이전시", emoji: "📢" },
  { value: "finance_outsourcing", label: "재무 아웃소싱사", emoji: "💰" },
  { value: "marketing_agency", label: "마케팅 에이전시", emoji: "📊" },
  { value: "production_agency", label: "작품 에이전시", emoji: "🎭" },
  { value: "sales_agency", label: "영업 에이전시", emoji: "🤝" },
] as const;

export type CompanyType = typeof COMPANY_TYPES[number]["value"];

export const getCompanyTypeLabel = (value: string) => {
  const found = COMPANY_TYPES.find(t => t.value === value);
  return found ? `${found.emoji} ${found.label}` : value;
};

export const getCompanyTypeBadge = (value: string) => {
  const found = COMPANY_TYPES.find(t => t.value === value);
  return found ? found.label : value;
};



============================================================
File Path: src/lib/driveApi.ts
============================================================
import { supabase } from "@/integrations/supabase/client";

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;

interface UploadResult {
  success: boolean;
  fileId?: string;
  fileName?: string;
  webViewLink?: string;
  webContentLink?: string;
  error?: string;
}

interface BackupResult {
  success: boolean;
  fileId?: string;
  fileName?: string;
  webViewLink?: string;
  backupTimestamp?: string;
  recordCounts?: {
    tenant: number;
    memberships: number;
    invoices: number;
    attachments: number;
  };
  error?: string;
}

/**
 * Upload a file to the tenant's Google Drive
 */
export async function uploadFileToDrive(
  tenantId: string,
  file: File,
  subfolder?: string
): Promise<UploadResult> {
  try {
    // Get current session
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      return { success: false, error: "Not authenticated" };
    }

    // Convert file to base64
    const fileContent = await fileToBase64(file);

    // Call edge function
    const response = await fetch(`${SUPABASE_URL}/functions/v1/upload-to-drive`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        tenantId,
        fileName: file.name,
        fileContent,
        mimeType: file.type || "application/octet-stream",
        subfolder,
      }),
    });

    const result = await response.json();

    if (!response.ok) {
      return { success: false, error: result.error || "Upload failed" };
    }

    return result;
  } catch (error) {
    console.error("Upload error:", error);
    return { success: false, error: error instanceof Error ? error.message : "Upload failed" };
  }
}

/**
 * Create a backup of all tenant data to Google Drive
 */
export async function createDriveBackup(tenantId: string): Promise<BackupResult> {
  try {
    // Get current session
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      return { success: false, error: "Not authenticated" };
    }

    // Call edge function
    const response = await fetch(`${SUPABASE_URL}/functions/v1/backup-to-drive`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({ tenantId }),
    });

    const result = await response.json();

    if (!response.ok) {
      return { success: false, error: result.error || "Backup failed" };
    }

    return result;
  } catch (error) {
    console.error("Backup error:", error);
    return { success: false, error: error instanceof Error ? error.message : "Backup failed" };
  }
}

/**
 * Convert File to base64 string
 */
function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result as string;
      // Remove data URL prefix
      const base64 = result.split(",")[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}



============================================================
File Path: src/lib/generateOnboardingPdf.ts
============================================================
import jsPDF from "jspdf";
import html2canvas from "html2canvas";

interface OnboardingData {
  fullName: string;
  email: string;
  tenantName: string;
  hire_date: string;
  resignation_date?: string;
  department: string;
  job_title: string;
  resident_number: string;
  is_foreigner: string;
  nationality: string;
  address: string;
  phone_mobile: string;
  phone_tel?: string;
  bank_name: string;
  account_number: string;
  account_holder: string;
  emergency_contacts: { relation: string; name: string; phone: string }[];
}

/**
 * Generate a PDF document containing all onboarding employee information.
 * Uses html2canvas to properly render Korean characters.
 * Returns a File object ready for upload/telegram sending.
 */
export async function generateOnboardingPdf(data: OnboardingData): Promise<File> {
  // Build HTML content with Korean labels
  const validContacts = data.emergency_contacts.filter(c => c.name || c.phone);
  const emergencyRows = validContacts.map((c, i) => `
    <tr><td class="label">#${i + 1} 관계</td><td>${c.relation || "-"}</td></tr>
    <tr><td class="label">이름</td><td>${c.name || "-"}</td></tr>
    <tr><td class="label">연락처</td><td>${c.phone || "-"}</td></tr>
  `).join("");

  const maskedResident = data.resident_number
    ? data.resident_number.replace(/(.{6}).+/, "$1-*******")
    : "-";

  const today = new Date().toISOString().split("T")[0];

  const html = `
    <div style="width:700px;padding:40px;font-family:'Apple SD Gothic Neo','Malgun Gothic','맑은 고딕',sans-serif;color:#1e293b;background:#fff;">
      <!-- Header -->
      <div style="background:#0f172a;color:#fff;padding:20px 30px;border-radius:8px;margin-bottom:24px;text-align:center;">
        <div style="font-size:22px;font-weight:700;margin-bottom:6px;">인사 정보등록</div>
        <div style="font-size:14px;opacity:0.9;">${data.tenantName} | ${data.fullName}</div>
        <div style="font-size:11px;opacity:0.7;margin-top:4px;">생성일: ${today}</div>
      </div>

      <!-- 재직 정보 -->
      <div style="margin-bottom:20px;">
        <div style="background:#0f172a;color:#fff;padding:8px 16px;border-radius:4px;font-size:13px;font-weight:700;margin-bottom:8px;">재직 정보</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr><td class="label">성명</td><td>${data.fullName || "-"}</td></tr>
          <tr><td class="label">이메일</td><td>${data.email || "-"}</td></tr>
          <tr><td class="label">입사일</td><td>${data.hire_date || "-"}</td></tr>
          ${data.resignation_date ? `<tr><td class="label">퇴사일</td><td>${data.resignation_date}</td></tr>` : ""}
          <tr><td class="label">부서</td><td>${data.department || "-"}</td></tr>
          <tr><td class="label">직책</td><td>${data.job_title || "-"}</td></tr>
        </table>
      </div>

      <!-- 개인 정보 -->
      <div style="margin-bottom:20px;">
        <div style="background:#0f172a;color:#fff;padding:8px 16px;border-radius:4px;font-size:13px;font-weight:700;margin-bottom:8px;">개인 정보</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr><td class="label">주민등록번호</td><td>${maskedResident}</td></tr>
          <tr><td class="label">내/외국인</td><td>${data.is_foreigner || "-"}</td></tr>
          <tr><td class="label">국적</td><td>${data.nationality || "-"}</td></tr>
          <tr><td class="label">주소</td><td>${data.address || "-"}</td></tr>
          <tr><td class="label">휴대폰</td><td>${data.phone_mobile || "-"}</td></tr>
          ${data.phone_tel ? `<tr><td class="label">유선전화</td><td>${data.phone_tel}</td></tr>` : ""}
        </table>
      </div>

      <!-- 급여 계좌 -->
      <div style="margin-bottom:20px;">
        <div style="background:#0f172a;color:#fff;padding:8px 16px;border-radius:4px;font-size:13px;font-weight:700;margin-bottom:8px;">급여 계좌</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr><td class="label">은행명</td><td>${data.bank_name || "-"}</td></tr>
          <tr><td class="label">계좌번호</td><td>${data.account_number || "-"}</td></tr>
          <tr><td class="label">예금주</td><td>${data.account_holder || "-"}</td></tr>
        </table>
      </div>

      ${validContacts.length > 0 ? `
      <!-- 비상 연락처 -->
      <div style="margin-bottom:20px;">
        <div style="background:#0f172a;color:#fff;padding:8px 16px;border-radius:4px;font-size:13px;font-weight:700;margin-bottom:8px;">비상 연락처</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          ${emergencyRows}
        </table>
      </div>
      ` : ""}

      <!-- Footer -->
      <div style="border-top:1px solid #e2e8f0;padding-top:12px;text-align:center;font-size:10px;color:#94a3b8;">
        본 문서는 사내 전용 기밀 문서입니다.
      </div>
    </div>

    <style>
      td.label {
        width: 130px;
        padding: 6px 12px;
        font-weight: 600;
        color: #475569;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: top;
      }
      td {
        padding: 6px 12px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: top;
      }
    </style>
  `;

  // Create temporary off-screen element
  const container = document.createElement("div");
  container.style.position = "fixed";
  container.style.left = "-9999px";
  container.style.top = "0";
  container.innerHTML = html;
  document.body.appendChild(container);

  try {
    const canvas = await html2canvas(container.firstElementChild as HTMLElement, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: "#ffffff",
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = 210;
    const pageHeight = 297;
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    const blob = pdf.output("blob");
    const fileName = `인사 정보등록_${data.fullName}_${today}.pdf`;
    return new File([blob], fileName, { type: "application/pdf" });
  } finally {
    document.body.removeChild(container);
  }
}



============================================================
File Path: src/lib/navigation.tsx
============================================================
import {
  Briefcase,
  Megaphone,
  Target,
  Wallet,
  CreditCard,
  Users,
  LayoutGrid,
  Film,
  Landmark,
  FileSearch,
  ClipboardCheck,
  Mail,
  Monitor,
  PenTool,
  Star,
  BellRing,
  Send,
  UserSearch,
  StickyNote,
  Share2,
  FilePieChart,
  Inbox,
  BarChart3,
  Calculator,
  Receipt,
  FileText,
  FileCheck2,
  ScrollText,
  Car,
  TrendingUp,
  CalendarClock,
  Palmtree,
  CalendarDays,
  Clock,
  Network,
  FileSignature,
  Gift,
  Calendar,
  BookOpen,
  FolderOpen,
  FileArchive,
  Bell,
  Search,
  Flower2,
  KeyRound,
  Settings, // Settings 추가
} from "lucide-react";

export const NAV_CATEGORIES = [
  {
    id: "management",
    label: "매니지먼트",
    icon: <Briefcase className="w-6 h-6" />,
    color: "bg-indigo-500",
    gradient: "from-indigo-600 to-violet-700",
  },
  {
    id: "pr",
    label: "홍보",
    icon: <Megaphone className="w-6 h-6" />,
    color: "bg-blue-500",
    gradient: "from-blue-500 to-cyan-600",
  },
  {
    id: "marketing",
    label: "마케팅",
    icon: <Target className="w-6 h-6" />,
    color: "bg-rose-500",
    gradient: "from-rose-500 to-orange-600",
  },
  {
    id: "finance",
    label: "재무",
    icon: <Wallet className="w-6 h-6" />,
    color: "bg-emerald-500",
    gradient: "from-emerald-500 to-teal-600",
  },
  {
    id: "hr",
    label: "인사",
    icon: <Users className="w-6 h-6" />,
    color: "bg-amber-500",
    gradient: "from-amber-500 to-orange-500",
  },
  {
    id: "common",
    label: "공용",
    icon: <LayoutGrid className="w-6 h-6" />,
    color: "bg-slate-500",
    gradient: "from-slate-500 to-slate-700",
  },
];

export const SUB_MENUS: Record<string, any[]> = {
  management: [
    { id: "scenario", name: "시나리오 분석", icon: <Film /> },
    { id: "internal-mail", name: "사내 메일/커뮤니케이션", icon: <Mail />, path: "/admin/mail" },
    { id: "contract-analysis", name: "계약서 분석", icon: <FileSearch /> },
    { id: "site-review", name: "현장 검토 사항", icon: <ClipboardCheck /> },
    { id: "select-monitor", name: "작품 셀렉 모니터링", icon: <Monitor /> },
  ],
  pr: [
    { id: "press-release", name: "원고생성", icon: <PenTool /> },
    { id: "profile-create", name: "프로필 제작", icon: <Star />, path: "/profiles" },
    { id: "news-monitor", name: "키워드 알림", icon: <BellRing /> },
    { id: "media-sending", name: "언론 보도 발송", icon: <Send />, path: "/admin/media-pitching" },
    { id: "profile-mgmt", name: "인물정보 관리", icon: <UserSearch />, path: "/profiles" },
    { id: "media-memo", name: "미디어 관계 메모", icon: <StickyNote /> },
    { id: "sns-posting", name: "SNS포스팅 생성", icon: <Share2 /> },
  ],
  marketing: [
    { id: "marketing-plan", name: "마케팅 전략", icon: <Target /> },
    { id: "performance", name: "성과보고서", icon: <FilePieChart /> },
    { id: "campaign", name: "캠페인 관리", icon: <Megaphone /> },
    { id: "brand-review", name: "브랜드 제안 검토함", icon: <Inbox /> },
    { id: "sns-dashboard", name: "SNS/노출 지표", icon: <BarChart3 /> },
    { id: "roi-sim", name: "ROI 시뮬레이션", icon: <Calculator /> },
  ],
  finance: [
    { id: "bank-transactions", name: "거래내역조회 (통장)", icon: <Landmark />, path: "/apps/finance/transactions" },
    { id: "card-history", name: "법인카드 사용내역", icon: <CreditCard />, path: "/apps/finance/card-history" },
    { id: "billing-inbox", name: "외부청구함", icon: <Receipt />, path: "/apps/finance/billing" },
    { id: "draft", name: "기안서", icon: <FileText /> },
    { id: "approval", name: "지출결의서", icon: <FileCheck2 /> },
    { id: "vehicle-report", name: "차량 운행정산서", icon: <Car />, path: "/admin/driving" },
    { id: "monthly-budget", name: "월간예산", icon: <Wallet /> },
    { id: "revenue-track", name: "계약별 수익 트래킹", icon: <TrendingUp /> },
    { id: "cashflow-cal", name: "현금흐름 캘린더", icon: <CalendarClock /> },
    { id: "finance-settings", name: "금융 연동 설정", icon: <Settings />, path: "/admin/finance-settings" }, // CODEF 설정 페이지 연동
  ],
  hr: [
    { id: "leave-request", name: "휴가신청", icon: <Palmtree />, path: "/leave-request" },
    { id: "leave-mgmt", name: "휴가 관리", icon: <CalendarDays />, path: "/admin/leave" },
    { id: "attendance", name: "출퇴근", icon: <Clock />, path: "/admin/attendance" },
    { id: "org-chart", name: "조직도", icon: <Network />, path: "/admin/org-chart" },
    { id: "labor-contract", name: "근로계약서", icon: <FileSignature /> },
    { id: "comp-leave", name: "보상휴가 관리", icon: <Gift /> },
  ],
  common: [
    { id: "scheduler", name: "통합 스케줄러", icon: <Calendar />, path: "/admin/schedules" },
    { id: "regulations", name: "규정", icon: <BookOpen /> },
    { id: "project-info", name: "프로젝트 정보", icon: <FolderOpen />, path: "/admin/projects" },
    { id: "docs-minutes", name: "문서&회의록", icon: <FileArchive /> },
    { id: "notifications", name: "알림 센터", icon: <Bell /> },
    { id: "global-search", name: "통합 검색", icon: <Search /> },
    { id: "wreath", name: "화환신청", icon: <Flower2 /> },
    { id: "password-mgmt", name: "비밀번호 관리", icon: <KeyRound /> },
  ],
};



============================================================
File Path: src/lib/telegramApi.ts
============================================================
import { supabase } from "@/integrations/supabase/client";

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;

interface TelegramResult {
  success: boolean;
  messageId?: number;
  error?: string;
}

/**
 * Send a file to tenant's Telegram bot for backup
 */
export async function sendFileToTelegram(
  tenantId: string,
  file: File,
  caption?: string
): Promise<TelegramResult> {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      return { success: false, error: "Not authenticated" };
    }

    const fileContent = await fileToBase64(file);

    const response = await fetch(`${SUPABASE_URL}/functions/v1/send-to-telegram`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        tenantId,
        fileName: file.name,
        fileContent,
        mimeType: file.type || "application/octet-stream",
        caption,
      }),
    });

    const result = await response.json();
    if (!response.ok) {
      return { success: false, error: result.error || "Failed to send" };
    }
    return result;
  } catch (error) {
    console.error("Telegram send error:", error);
    return { success: false, error: error instanceof Error ? error.message : "Send failed" };
  }
}

function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result as string;
      const base64 = result.split(",")[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}



============================================================
File Path: src/lib/utils.ts
============================================================
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}



============================================================
File Path: src/pages/AdminDashboard.tsx
============================================================
import { Header } from "@/components/landing/Header";
import { Card, CardContent } from "@/components/ui/card";
import { 
  Users, 
  Key, 
  UserCog, 
  Settings, 
  Database, 
  ArrowLeft, 
  ShieldCheck, 
  CreditCard, 
  CarFront,
  Building,
  Megaphone,
  Clock
} from "lucide-react";
import { Link, useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";

const AdminSystem = () => {
  const navigate = useNavigate();

  // App.tsx의 Route path와 정확히 일치시켜야 합니다.
  const adminMenus = [
    { 
      title: "회사 정보 관리", 
      icon: <Building className="w-6 h-6 text-slate-600" />, 
      path: "/admin/company", 
      desc: "사업자 정보 및 공식 문서 관리" 
    },
    { 
      title: "인사 관리", 
      icon: <Users className="w-6 h-6 text-blue-600" />, 
      path: "/admin/hr", 
      desc: "임직원 정보, 권한 및 서류 관리" 
    },
    { 
      title: "배우 관리", 
      icon: <UserCog className="w-6 h-6 text-indigo-600" />, 
      path: "/admin/artists", 
      desc: "아티스트 DB 및 프로필 마스터 데이터" 
    },
    { 
      title: "법인카드 관리", 
      icon: <CreditCard className="w-6 h-6 text-orange-500" />, 
      path: "/admin/cards", 
      desc: "법인카드 사용자 및 결제 증빙 관리" 
    },
    { 
      title: "차량 관리", 
      icon: <CarFront className="w-6 h-6 text-emerald-600" />, 
      path: "/admin/vehicles", 
      desc: "법인 차량 리스료 및 보험, 사고 관리" 
    },
    { 
      title: "키워드 관리", 
      icon: <Key className="w-6 h-6 text-amber-500" />, 
      path: "/admin/keywords", 
      desc: "시스템 검색어 및 태그 데이터 관리" 
    },
    { 
      title: "미디어 피칭", 
      icon: <Megaphone className="w-6 h-6 text-rose-500" />, 
      path: "/admin/media-pitching", 
      desc: "언론사 배포 및 홍보 관리" 
    },
    { 
      title: "근로규칙 관리", 
      icon: <Clock className="w-6 h-6 text-teal-600" />, 
      path: "/admin/work-rules", 
      desc: "소정근로 및 최대근로 규칙 설정" 
    },
    { 
      title: "API 설정", 
      icon: <Settings className="w-6 h-6 text-slate-500" />, 
      path: "/admin/api-settings", 
      desc: "외부 연동 키 및 서비스 설정" 
    },
    { 
      title: "Drive 설정", 
      icon: <Database className="w-6 h-6 text-blue-500" />, 
      path: "/admin/drive-settings", 
      desc: "전사 저장소(Google Drive) 연동" 
    },
  ];

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-10">
          <div>
            <div className="flex items-center gap-2 text-primary mb-2">
              <ShieldCheck className="w-5 h-5" />
              <span className="font-semibold text-sm">Corporate Admin Hub</span>
            </div>
            <h1 className="text-3xl font-bold tracking-tight text-slate-900">본사 통합 관리 시스템</h1>
            <p className="text-muted-foreground mt-1">회사 운영 전반에 필요한 설정을 통합 제어합니다.</p>
          </div>
          <Button variant="ghost" className="gap-2" onClick={() => navigate("/")}>
            <ArrowLeft className="w-4 h-4" /> 대시보드
          </Button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {adminMenus.map((menu) => (
            <Link key={menu.title} to={menu.path} className="block h-full">
              <Card className="hover:shadow-xl transition-all border-none bg-white group cursor-pointer h-full border-b-4 border-transparent hover:border-primary">
                <CardContent className="p-8 flex flex-col items-start gap-4">
                  <div className="p-4 rounded-2xl bg-slate-50 group-hover:bg-primary group-hover:text-white transition-all duration-300">
                    {menu.icon}
                  </div>
                  <div>
                    <h3 className="text-xl font-bold mb-1 group-hover:text-primary transition-colors">
                      {menu.title}
                    </h3>
                    <p className="text-muted-foreground text-sm leading-relaxed">
                      {menu.desc}
                    </p>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      </main>
    </div>
  );
};

export default AdminSystem;


============================================================
File Path: src/pages/AdminSystem.tsx
============================================================
import { Card, CardContent } from "@/components/ui/card";
import { 
  Users, Key, UserCog, Laptop, Database, ShieldCheck, ArrowLeft, Mail,
  Building, CreditCard, CarFront, Megaphone, Target, Navigation, Handshake, Eye, Calendar
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";

const AdminSystem = () => {
  const navigate = useNavigate();
  const adminMenus = [
    { 
      title: "회사 정보 관리", 
      icon: <Building className="w-6 h-6" />, 
      path: "/admin/company", 
      color: "bg-orange-500", 
      desc: "사업자 정보 및 공식 문서 관리" 
    },
    { 
      title: "금융 연동 설정", 
      icon: <Database className="w-6 h-6" />, 
      path: "/admin/finance-settings", // 아까 App.tsx에 등록한 경로
      color: "bg-blue-600", 
      desc: "CODEF API 인증 및 계좌/카드 연동 관리" 
    },
    { 
      title: "메일 서버 설정", 
      icon: <Mail className="w-6 h-6" />, 
      path: "/admin/mail-settings", 
      color: "bg-blue-400", 
      desc: "전사 Gmail / 네이버웍스 API 및 OAuth 연동 관리" 
    },
    { 
      title: "인사 관리", 
      icon: <Users className="w-6 h-6" />, 
      path: "/admin/hr", 
      color: "bg-blue-500", 
      desc: "직원 명부 및 부서 관리" 
    },
    { 
      title: "배우 관리", 
      icon: <UserCog className="w-6 h-6" />, 
      path: "/admin/artists", 
      color: "bg-indigo-500", 
      desc: "아티스트 마스터 데이터 관리" 
    },
    { 
      title: "법인카드 관리", 
      icon: <CreditCard className="w-6 h-6" />, 
      path: "/admin/cards", 
      color: "bg-rose-500", 
      desc: "법인카드 사용 내역 및 증빙 관리" 
    },
    { 
      title: "차량 관리", 
      icon: <CarFront className="w-6 h-6" />, 
      path: "/admin/vehicles", 
      color: "bg-emerald-500", 
      desc: "법인 차량 리스 및 보험 관리" 
    },
    { 
    title: "부서 및 직급 관리", 
    icon: <Users className="w-6 h-6" />, 
    path: "/admin/org-chart", 
    color: "bg-emerald-500", 
    desc: "사내 조직도, 부서장 및 직급 체계 설정" 
    },
    { 
      title: "프로젝트 마스터", 
      icon: <Target className="w-6 h-6" />, 
      path: "/admin/projects", 
      color: "bg-violet-500", 
      desc: "진행 사업 관리 및 비용 정산 코드 제어" 
    },
    { 
      title: "실시간 운행 관제", 
      icon: <Navigation className="w-6 h-6" />, 
      path: "/admin/driving", 
      color: "bg-slate-900", 
      desc: "GPS 기반 주행일지 자동 생성 및 기록" 
    },
    { 
      title: "키워드 관리", 
      icon: <Key className="w-6 h-6" />, 
      path: "/admin/keywords", 
      color: "bg-amber-500", 
      desc: "검색어 필터링 및 태그 관리" 
    },
    { 
      title: "미디어 피칭", 
      icon: <Megaphone className="w-6 h-6" />, 
      path: "/admin/media-pitching", 
      color: "bg-pink-500", 
      desc: "언론사 배포 및 홍보 관리" 
    },
    { 
      title: "API 설정", 
      icon: <Laptop className="w-6 h-6" />, 
      path: "/admin/api-settings", 
      color: "bg-slate-600", 
      desc: "외부 시스템 연동 설정" 
    },
    { 
      title: "배우 스케줄 관리", 
      icon: <Calendar className="w-6 h-6" />, 
      path: "/admin/schedules", 
      color: "bg-sky-500", 
      desc: "배우별 일정 등록 및 관리" 
    },
    { 
      title: "파트너사 관리", 
      icon: <Handshake className="w-6 h-6" />, 
      path: "/admin/partnerships", 
      color: "bg-teal-500", 
      desc: "외부 파트너 회사와 데이터 공유 관리" 
    },
    { 
      title: "파트너 데이터 열람", 
      icon: <Eye className="w-6 h-6" />, 
      path: "/admin/partner-data", 
      color: "bg-cyan-500", 
      desc: "연결된 파트너사의 공유 데이터 조회" 
    },
    { 
      title: "Drive 설정", 
      icon: <Database className="w-6 h-6" />, 
      path: "/admin/drive-settings", 
      color: "bg-blue-600", 
      desc: "전사 스토리지 구성" 
    },
  ];

  return (
    <div className="pb-16 px-6 max-w-7xl mx-auto py-8">
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12">
          <div>
            <div className="flex items-center gap-2 text-primary font-bold mb-2">
              <ShieldCheck className="w-5 h-5" /> Admin System Only
            </div>
            <h1 className="text-4xl font-extrabold tracking-tight text-slate-900">본사 통합 관리 센터</h1>
            <p className="text-slate-500 mt-2 text-lg">회사 인프라와 권한 설정을 관리하는 시스템 허브입니다.</p>
          </div>
          <Button variant="ghost" className="gap-2" onClick={() => navigate("/dashboard")}>
            <ArrowLeft className="w-4 h-4" /> 대시보드로 돌아가기
          </Button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {adminMenus.map((menu) => (
            <div key={menu.title} onClick={() => navigate(menu.path)} className="cursor-pointer">
              <Card className="hover:shadow-xl transition-all border-none shadow-sm group overflow-hidden bg-white">
                <CardContent className="p-8 flex items-start gap-6">
                  <div className={`p-4 rounded-2xl ${menu.color} text-white shadow-lg shadow-current/20 group-hover:scale-110 transition-transform`}>
                    {menu.icon}
                  </div>
                  <div>
                    <h3 className="text-xl font-bold mb-2 text-slate-800">{menu.title}</h3>
                    <p className="text-slate-500 text-sm leading-relaxed">{menu.desc}</p>
                  </div>
                </CardContent>
              </Card>
            </div>
          ))}
        </div>
    </div>
  );
};

export default AdminSystem;



============================================================
File Path: src/pages/AppModule.tsx
============================================================
import React from "react";
import { useParams, useNavigate } from "react-router-dom";
import { NAV_CATEGORIES, SUB_MENUS } from "@/lib/navigation";
import { Construction } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { cn } from "@/lib/utils";
import { toast } from "sonner";

const AppModule = () => {
  const { category } = useParams<{ category: string }>();
  const navigate = useNavigate();
  
  // 현재 카테고리 정보 가져오기
  const currentCategory = category || "management";
  const categoryInfo = NAV_CATEGORIES.find(c => c.id === currentCategory);
  const subMenuItems = SUB_MENUS[currentCategory] || [];

  const handleSubMenuClick = (item: any) => {
    if (item.path) {
      navigate(item.path);
    } else {
      toast.info(`'${item.name}' 기능은 준비 중입니다.`);
    }
  };

  return (
      <div className="p-8 md:p-12 max-w-7xl mx-auto animate-in fade-in duration-500">
        
        {/* 상단 타이틀 */}
        <div className="mb-10">
          <div className="flex items-center gap-3 mb-2">
            <div className={cn("p-2 rounded-xl text-white", categoryInfo?.color)}>
              {categoryInfo?.icon}
            </div>
            <h3 className="text-3xl font-black text-slate-900 tracking-tight">
              {categoryInfo?.label} <span className="text-slate-400">전체 서비스</span>
            </h3>
          </div>
          <p className="text-slate-500 font-medium ml-12">
            원하시는 메뉴를 선택하여 업무를 시작하세요.
          </p>
        </div>

        {/* 서비스 앱 그리드 */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {subMenuItems.map((item) => (
            <button
              key={item.id}
              onClick={() => handleSubMenuClick(item)}
              className="flex items-center gap-5 p-6 rounded-[2rem] bg-white border border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-500/50 hover:-translate-y-1 transition-all text-left group"
            >
              <div className={cn(
                "w-14 h-14 rounded-2xl flex items-center justify-center transition-transform group-hover:scale-110",
                `${categoryInfo?.color}/10`,
                categoryInfo?.color
              )}>
                {React.cloneElement(item.icon as React.ReactElement, { className: "w-7 h-7" })}
              </div>
              <div>
                <span className="font-bold text-lg text-slate-800 block group-hover:text-blue-600 transition-colors">
                  {item.name}
                </span>
                <span className="text-xs text-slate-400 font-medium uppercase tracking-wider">
                  Launch Service
                </span>
              </div>
            </button>
          ))}
        </div>

        {/* 하단 안내 (선택 사항) */}
        <div className="mt-16 p-10 rounded-[3rem] bg-slate-50 border border-slate-100 text-center">
          <Construction className="w-12 h-12 mx-auto text-slate-200 mb-4" />
          <p className="text-slate-400 font-medium">더 많은 서비스가 곧 추가될 예정입니다.</p>
        </div>
      </div>
  );
};

export default AppModule;



============================================================
File Path: src/pages/ArtistPortfolio.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { TrendAnalysisPanel } from "@/components/artist/TrendAnalysisPanel";
import { toast } from "sonner";
import {
  ArrowLeft, Download, Share2, Printer, User, Calendar, Building2,
  Instagram, Youtube, Globe, TrendingUp, FileText, ImageIcon, Loader2
} from "lucide-react";

interface Artist {
  id: string;
  name: string;
  stage_name: string | null;
  birth_date: string | null;
  gender: string | null;
  bio: string | null;
  agency: string | null;
  debut_date: string | null;
  profile_image_url: string | null;
  social_links: any;
  is_active: boolean | null;
}

const ArtistPortfolio = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [artist, setArtist] = useState<Artist | null>(null);
  const [loading, setLoading] = useState(true);
  const printRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const fetchArtist = async () => {
      if (!id) return;
      setLoading(true);
      
      const { data, error } = await supabase
        .from("artists")
        .select("*")
        .eq("id", id)
        .single();
      
      if (error) {
        toast.error("아티스트 정보를 불러올 수 없습니다.");
        navigate("/profiles");
        return;
      }
      
      setArtist(data);
      setLoading(false);
    };

    fetchArtist();
  }, [id, navigate]);

  const handlePrint = () => {
    window.print();
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!artist) {
    return null;
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-24 pb-16 px-6 max-w-7xl mx-auto">
        {/* 상단 네비게이션 */}
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={() => navigate("/profiles")}>
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-2xl font-black text-slate-900">
                {artist.stage_name || artist.name}
              </h1>
              <p className="text-slate-500 text-sm">마케팅 포트폴리오</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Button variant="outline" size="sm" onClick={handlePrint}>
              <Printer className="w-4 h-4 mr-2" /> 인쇄
            </Button>
            <Button variant="outline" size="sm">
              <Download className="w-4 h-4 mr-2" /> PDF
            </Button>
            <Button variant="outline" size="sm">
              <Share2 className="w-4 h-4 mr-2" /> 공유
            </Button>
          </div>
        </div>

        <div ref={printRef}>
          {/* 프로필 헤더 */}
          <Card className="mb-6 border-none shadow-lg overflow-hidden">
            <div className="bg-gradient-to-r from-indigo-600 via-blue-600 to-indigo-700 p-8">
              <div className="flex flex-col md:flex-row gap-8 items-center md:items-start">
                {/* 프로필 이미지 */}
                <div className="w-48 h-64 bg-white/10 rounded-xl overflow-hidden shadow-2xl border-4 border-white/30">
                  {artist.profile_image_url ? (
                    <img 
                      src={artist.profile_image_url} 
                      alt={artist.name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center">
                      <User className="w-16 h-16 text-white/40" />
                    </div>
                  )}
                </div>

                {/* 기본 정보 */}
                <div className="flex-1 text-white text-center md:text-left">
                  <Badge className="mb-3 bg-white/20 border-white/30 text-white">
                    {artist.is_active ? "ACTIVE" : "INACTIVE"}
                  </Badge>
                  <h2 className="text-4xl font-black mb-2">{artist.name}</h2>
                  {artist.stage_name && (
                    <p className="text-xl text-white/80 mb-4">{artist.stage_name}</p>
                  )}
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    {artist.birth_date && (
                      <div className="bg-white/10 rounded-lg p-3">
                        <Calendar className="w-4 h-4 text-white/60 mb-1" />
                        <p className="text-xs text-white/60">생년월일</p>
                        <p className="font-bold">{artist.birth_date}</p>
                      </div>
                    )}
                    {artist.agency && (
                      <div className="bg-white/10 rounded-lg p-3">
                        <Building2 className="w-4 h-4 text-white/60 mb-1" />
                        <p className="text-xs text-white/60">소속사</p>
                        <p className="font-bold">{artist.agency}</p>
                      </div>
                    )}
                    {artist.debut_date && (
                      <div className="bg-white/10 rounded-lg p-3">
                        <TrendingUp className="w-4 h-4 text-white/60 mb-1" />
                        <p className="text-xs text-white/60">데뷔일</p>
                        <p className="font-bold">{artist.debut_date}</p>
                      </div>
                    )}
                    <div className="bg-white/10 rounded-lg p-3">
                      <User className="w-4 h-4 text-white/60 mb-1" />
                      <p className="text-xs text-white/60">성별</p>
                      <p className="font-bold">{artist.gender === 'male' ? '남성' : '여성'}</p>
                    </div>
                  </div>

                  {/* 소셜 링크 */}
                  <div className="flex gap-3 mt-6 justify-center md:justify-start">
                    <Button size="sm" variant="secondary" className="bg-white/20 hover:bg-white/30 border-none">
                      <Instagram className="w-4 h-4" />
                    </Button>
                    <Button size="sm" variant="secondary" className="bg-white/20 hover:bg-white/30 border-none">
                      <Youtube className="w-4 h-4" />
                    </Button>
                    <Button size="sm" variant="secondary" className="bg-white/20 hover:bg-white/30 border-none">
                      <Globe className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* 탭 콘텐츠 */}
          <Tabs defaultValue="insight" className="space-y-6">
            <TabsList className="bg-white shadow-sm border">
              <TabsTrigger value="insight" className="gap-2">
                <TrendingUp className="w-4 h-4" /> 마켓 인사이트
              </TabsTrigger>
              <TabsTrigger value="bio" className="gap-2">
                <FileText className="w-4 h-4" /> 프로필 상세
              </TabsTrigger>
              <TabsTrigger value="gallery" className="gap-2">
                <ImageIcon className="w-4 h-4" /> 갤러리
              </TabsTrigger>
            </TabsList>

            <TabsContent value="insight">
              <TrendAnalysisPanel 
                artistName={artist.name} 
                stageName={artist.stage_name} 
              />
            </TabsContent>

            <TabsContent value="bio">
              <Card className="border-none shadow-lg">
                <CardContent className="p-8">
                  <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-indigo-600" />
                    아티스트 소개
                  </h3>
                  <div className="prose prose-slate max-w-none">
                    <p className="text-slate-600 leading-relaxed whitespace-pre-wrap">
                      {artist.bio || "등록된 소개가 없습니다."}
                    </p>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="gallery">
              <Card className="border-none shadow-lg">
                <CardContent className="p-8 text-center">
                  <div className="inline-flex p-6 rounded-full bg-slate-100 mb-4">
                    <ImageIcon className="w-12 h-12 text-slate-400" />
                  </div>
                  <h3 className="text-lg font-bold text-slate-800 mb-2">갤러리 준비 중</h3>
                  <p className="text-slate-500">화보, 포스터 등 비주얼 자료가 곧 추가됩니다.</p>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        </div>
      </main>
    </div>
  );
};

export default ArtistPortfolio;



============================================================
File Path: src/pages/Auth.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import { Loader2, Mail, Lock, User, Building2, CheckCircle, Briefcase } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { COMPANY_TYPES } from "@/lib/companyTypes";

interface InvitationInfo {
  id: string;
  email: string;
  role: string;
  department: string | null;
  job_title: string | null;
  tenant_name: string;
  tenant_id: string;
}

const Auth = () => {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [fullName, setFullName] = useState("");
  const [companyName, setCompanyName] = useState("");
  const [companyType, setCompanyType] = useState<string>("talent_agency");
  const [loading, setLoading] = useState(false);
  const [invitationInfo, setInvitationInfo] = useState<InvitationInfo | null>(null);
  const [checkingInvite, setCheckingInvite] = useState(false);
  const { signIn, signUp } = useAuth();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  // 이미 로그인된 사용자는 대시보드로 리다이렉트
  const { user: authUser, loading: authLoading } = useAuth();
  useEffect(() => {
    if (!authLoading && authUser && !searchParams.get("invite")) {
      navigate("/dashboard", { replace: true });
    }
  }, [authUser, authLoading, navigate, searchParams]);

  // URL에서 초대 이메일 파라미터 확인
  useEffect(() => {
    const inviteEmail = searchParams.get("invite");
    if (inviteEmail) {
      setEmail(inviteEmail);
      setIsLogin(false);
      checkInvitation(inviteEmail);
    }
  }, [searchParams]);

  // 이메일 변경 시 초대 확인
  const checkInvitation = async (emailToCheck: string) => {
    if (!emailToCheck || emailToCheck.length < 5) {
      setInvitationInfo(null);
      return;
    }

    setCheckingInvite(true);
    try {
      const { data, error } = await supabase
        .from("employee_invitations")
        .select(`
          id, email, role, department, job_title, tenant_id,
          tenants:tenant_id ( name )
        `)
        .eq("email", emailToCheck.toLowerCase())
        .eq("status", "pending")
        .gt("expires_at", new Date().toISOString())
        .limit(1)
        .maybeSingle();

      if (data && !error) {
        const tenantData = data.tenants as any;
        setInvitationInfo({
          id: data.id,
          email: data.email,
          role: data.role,
          department: data.department,
          job_title: data.job_title,
          tenant_name: tenantData?.name || "알 수 없음",
          tenant_id: data.tenant_id,
        });
      } else {
        setInvitationInfo(null);
      }
    } catch (err) {
      console.error("Invitation check error:", err);
      setInvitationInfo(null);
    } finally {
      setCheckingInvite(false);
    }
  };

  // 이메일 입력 변경 핸들러 (디바운스)
  useEffect(() => {
    if (!isLogin && email) {
      const timer = setTimeout(() => {
        checkInvitation(email);
      }, 500);
      return () => clearTimeout(timer);
    } else {
      setInvitationInfo(null);
    }
  }, [email, isLogin]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      if (isLogin) {
        const { error } = await signIn(email, password);
        if (error) {
          toast.error("로그인 실패", {
            description: error.message,
          });
        } else {
          toast.success("로그인 성공!");
          navigate("/dashboard");
        }
      } else {
        if (!fullName.trim()) {
          toast.error("이름을 입력해주세요");
          setLoading(false);
          return;
        }
        // 초대가 없는 경우에만 회사명 필수
        if (!invitationInfo && !companyName.trim()) {
          toast.error("회사명을 입력해주세요");
          setLoading(false);
          return;
        }
        const { error } = await signUp(
          email,
          password,
          fullName,
          invitationInfo ? invitationInfo.tenant_name : companyName,
          invitationInfo ? undefined : companyType
        );
        if (error) {
          toast.error("회원가입 실패", {
            description: error.message,
          });
        } else {
          if (invitationInfo) {
            toast.success("회원가입이 완료되었습니다!", {
              description: `${invitationInfo.tenant_name}에 자동으로 등록되었습니다. 로그인해주세요.`,
            });
          } else {
            toast.success("회원가입이 완료되었습니다!", {
              description: "관리자 승인 후 시스템을 이용할 수 있습니다.",
            });
          }
          setIsLogin(true);
        }
      }
    } catch (err) {
      toast.error("오류가 발생했습니다");
    } finally {
      setLoading(false);
    }
  };

  const getRoleLabel = (role: string) => {
    switch (role) {
      case "company_admin":
        return "관리자";
      case "manager":
        return "매니저";
      default:
        return "사원";
    }
  };

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      {/* Background Effects */}
      <div className="absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-accent/5" />
      <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-primary/10 rounded-full blur-3xl" />
      <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-accent/10 rounded-full blur-3xl" />

      <div className="relative z-10 w-full max-w-md">
        {/* Logo */}
        <div className="text-center mb-8">
          <div className="inline-flex items-center gap-2 mb-4">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center">
              <span className="text-primary-foreground font-bold text-lg">A</span>
            </div>
            <span className="font-bold text-2xl">
              <span className="gradient-text">Ark</span>Port
            </span>
          </div>
          <p className="text-muted-foreground">
            {isLogin ? "계정에 로그인하세요" : "새 계정을 만드세요"}
          </p>
        </div>

        {/* Auth Card */}
        <div className="glass-card p-8">
          {/* 초대 정보 배너 */}
          {!isLogin && invitationInfo && (
            <div className="mb-6 p-4 rounded-xl bg-gradient-to-r from-primary/10 to-accent/10 border border-primary/20">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                  <CheckCircle className="w-5 h-5 text-primary" />
                </div>
                <div className="flex-1">
                  <p className="font-semibold text-sm text-foreground">
                    {invitationInfo.tenant_name}에서 초대했습니다
                  </p>
                  <div className="flex flex-wrap gap-2 mt-2">
                    <Badge variant="secondary" className="text-xs">
                      {getRoleLabel(invitationInfo.role)}
                    </Badge>
                    {invitationInfo.department && (
                      <Badge variant="outline" className="text-xs">
                        {invitationInfo.department}
                      </Badge>
                    )}
                    {invitationInfo.job_title && (
                      <Badge variant="outline" className="text-xs">
                        {invitationInfo.job_title}
                      </Badge>
                    )}
                  </div>
                  <p className="text-xs text-muted-foreground mt-2">
                    가입 완료 시 자동으로 소속됩니다
                  </p>
                </div>
              </div>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-5">
            {!isLogin && (
              <>
                <div className="space-y-2">
                  <Label htmlFor="fullName">이름</Label>
                  <div className="relative">
                    <User className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                    <Input
                      id="fullName"
                      type="text"
                      placeholder="홍길동"
                      value={fullName}
                      onChange={(e) => setFullName(e.target.value)}
                      className="pl-10"
                      required={!isLogin}
                    />
                  </div>
                </div>
                {/* 초대가 없는 경우에만 회사명 입력 표시 */}
                {!invitationInfo && (
                  <>
                    <div className="space-y-2">
                      <Label htmlFor="companyName">회사명</Label>
                      <div className="relative">
                        <Building2 className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                        <Input
                          id="companyName"
                          type="text"
                          placeholder="회사명을 입력하세요"
                          value={companyName}
                          onChange={(e) => setCompanyName(e.target.value)}
                          className="pl-10"
                          required={!isLogin && !invitationInfo}
                        />
                      </div>
                    </div>
                    <div className="space-y-2">
                      <Label>회사 유형</Label>
                      <Select value={companyType} onValueChange={setCompanyType}>
                        <SelectTrigger>
                          <SelectValue placeholder="회사 유형을 선택하세요" />
                        </SelectTrigger>
                        <SelectContent>
                          {COMPANY_TYPES.map((t) => (
                            <SelectItem key={t.value} value={t.value}>
                              {t.emoji} {t.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <p className="text-xs text-muted-foreground">
                        관리자 승인 후 해당 회사에 소속됩니다
                      </p>
                    </div>
                  </>
                )}
              </>
            )}

            <div className="space-y-2">
              <Label htmlFor="email">이메일</Label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                <Input
                  id="email"
                  type="email"
                  placeholder="email@example.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="pl-10"
                  required
                  disabled={!!searchParams.get("invite")}
                />
                {checkingInvite && !isLogin && (
                  <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 animate-spin text-muted-foreground" />
                )}
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="password">비밀번호</Label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                <Input
                  id="password"
                  type="password"
                  placeholder="••••••••"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="pl-10"
                  required
                  minLength={6}
                />
              </div>
            </div>

            <Button type="submit" className="w-full" size="lg" disabled={loading}>
              {loading ? (
                <>
                  <Loader2 className="w-4 h-4 animate-spin mr-2" />
                  처리 중...
                </>
              ) : isLogin ? (
                "로그인"
              ) : (
                "회원가입"
              )}
            </Button>
          </form>

          <div className="mt-6 text-center">
            <button
              type="button"
              onClick={() => {
                setIsLogin(!isLogin);
                setInvitationInfo(null);
              }}
              className="text-sm text-muted-foreground hover:text-foreground transition-colors"
            >
              {isLogin ? (
                <>
                  계정이 없으신가요?{" "}
                  <span className="text-primary font-medium">회원가입</span>
                </>
              ) : (
                <>
                  이미 계정이 있으신가요?{" "}
                  <span className="text-primary font-medium">로그인</span>
                </>
              )}
            </button>
          </div>
        </div>

        {/* Info */}
        <p className="text-center text-xs text-muted-foreground mt-6">
          로그인하면 ArkPort 이용약관 및 개인정보처리방침에 동의하게 됩니다.
        </p>
      </div>
    </div>
  );
};

export default Auth;


============================================================
File Path: src/pages/Dashboard.tsx
============================================================
import { useAuth } from "@/hooks/useAuth";
import { ClockInPopup } from "@/components/attendance/ClockInPopup";
import { AppGrid } from "@/components/dashboard/AppGrid";
import { CalendarWidget } from "@/components/dashboard/CalendarWidget";
import { Badge } from "@/components/ui/badge";
import {
  Bell,
  CheckCircle2,
  AlertCircle,
  FileText,
  ChevronRight,
  LayoutDashboard,
  Sparkles,
} from "lucide-react";

// 가상의 데이터 (기존 데이터 유지)
const mockNotices = [
  { id: "1", type: "notice", title: "2025년 1분기 전사 워크샵 안내", date: "2025-02-14", isNew: true },
  { id: "2", type: "notice", title: "사내 보안 교육 필수 이수 안내 (2/28까지)", date: "2025-02-12", isNew: true },
  { id: "3", type: "notice", title: "복리후생 제도 변경 공지", date: "2025-02-10", isNew: false },
];

const mockReviewItems = [
  { id: "1", title: "견적서 승인 요청 - (주)ABC디자인", status: "pending", from: "김수연", time: "10분 전" },
  { id: "2", title: "지출결의서 검토 - 마케팅팀 캠페인 비용", status: "pending", from: "이준혁", time: "32분 전" },
  { id: "3", title: "휴가 신청 승인 - 박민서 (2/20~2/21)", status: "pending", from: "박민서", time: "1시간 전" },
  { id: "4", title: "차량 운행일지 확인 - 1월분", status: "done", from: "시스템", time: "2시간 전" },
];

const Dashboard = () => {
  const { currentTenant, profile } = useAuth();

  return (
      <div className="p-8 md:p-12 space-y-12 max-w-[1600px] mx-auto animate-in fade-in slide-in-from-bottom-4 duration-700">
        <ClockInPopup />
        
        {/* 상단 웰컴 섹션 */}
        <section className="flex flex-col md:flex-row md:items-end justify-between gap-6">
          <div>
            <div className="flex items-center gap-2 text-blue-600 font-black text-xs uppercase tracking-[0.2em] mb-2">
              <Sparkles className="w-3.5 h-3.5" /> ArkPort Intelligent Workspace
            </div>
            <h1 className="text-4xl font-black text-slate-900 tracking-tighter">
              반갑습니다, <span className="text-blue-600">{profile?.full_name || "사용자"}</span>님.
            </h1>
            <p className="text-slate-500 mt-2 font-medium">
              오늘은 <span className="text-slate-900 font-bold">{currentTenant?.tenant?.name}</span>의 업무를 확인해 보세요.
            </p>
          </div>
          <div className="flex items-center gap-3 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
            <Badge variant="outline" className="bg-slate-50 border-slate-200 text-slate-500 font-bold px-3 py-1">
              Standard Plan
            </Badge>
            <div className="h-8 w-[1px] bg-slate-100" />
            <span className="text-xs font-bold text-slate-400 px-2 uppercase tracking-widest">v1.2.0</span>
          </div>
        </section>

        {/* 1. 비즈니스 솔루션 (앱 그리드) */}
        <section>
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-2">
              <LayoutDashboard className="w-6 h-6 text-blue-600" />
              비즈니스 솔루션 탐색기
            </h2>
            <button className="text-xs font-bold text-blue-600 hover:underline">카테고리 설정</button>
          </div>
          {/* AppGrid 내부의 각 카드들도 세련된 디자인으로 렌더링됨 */}
          <AppGrid />
        </section>

        {/* 2. 통합 스케줄러 (중간 섹션) */}
        <section className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.05)]">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-3">
              <div className="w-1.5 h-7 bg-violet-600 rounded-full" />
              전사 통합 스케줄러
            </h2>
            <div className="flex gap-2">
               <Badge className="bg-violet-50 text-violet-600 border-violet-100 font-black">LIVE</Badge>
            </div>
          </div>
          <CalendarWidget />
        </section>

        {/* 3. 하단 알림 및 워크플로우 (2열 레이아웃) */}
        <section className="grid lg:grid-cols-2 gap-8 pb-12">
          
          {/* 전사 공지사항 */}
          <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/20">
            <div className="flex items-center justify-between mb-8">
              <h3 className="font-black text-xl flex items-center gap-3 text-slate-800">
                <Bell className="w-6 h-6 text-blue-600" />
                사내 주요 공지
              </h3>
              <button className="p-2 rounded-xl hover:bg-slate-50 transition-colors">
                <ChevronRight className="w-5 h-5 text-slate-300" />
              </button>
            </div>
            <div className="space-y-4">
              {mockNotices.map((notice) => (
                <div key={notice.id} className="flex items-start gap-5 p-5 rounded-2xl hover:bg-blue-50/50 transition-all cursor-pointer group border border-transparent hover:border-blue-100">
                  <div className="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center shrink-0 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                    <FileText className="w-6 h-6" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-3 mb-1">
                      <span className="text-md font-bold text-slate-700 truncate group-hover:text-blue-700 transition-colors">
                        {notice.title}
                      </span>
                      {notice.isNew && <Badge className="bg-rose-500 text-[10px] h-4 font-black px-1.5 uppercase border-none">New</Badge>}
                    </div>
                    <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">{notice.date}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* 워크플로우 검토 (결재함) */}
          <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/20">
            <div className="flex items-center justify-between mb-8">
              <h3 className="font-black text-xl flex items-center gap-3 text-slate-800">
                <AlertCircle className="w-6 h-6 text-amber-500" />
                미결재 워크플로우
              </h3>
              <Badge className="bg-amber-100 text-amber-700 hover:bg-amber-100 border-none font-black px-3 py-1 rounded-full">
                {mockReviewItems.filter(i => i.status === "pending").length}건 대기
              </Badge>
            </div>
            <div className="space-y-4">
              {mockReviewItems.map((item) => (
                <div key={item.id} className="flex items-center gap-5 p-5 rounded-2xl hover:bg-slate-50 transition-all cursor-pointer border border-transparent hover:border-slate-100 group">
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center shrink-0 transition-all shadow-sm ${
                    item.status === "done" ? "bg-emerald-50 text-emerald-500" : "bg-amber-50 text-amber-500 group-hover:bg-amber-500 group-hover:text-white"
                  }`}>
                    {item.status === "done" ? (
                      <CheckCircle2 className="w-6 h-6" />
                    ) : (
                      <AlertCircle className="w-6 h-6" />
                    )}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-md font-bold text-slate-700 truncate mb-1 group-hover:text-slate-900 transition-colors">{item.title}</div>
                    <div className="text-[11px] text-slate-400 font-bold uppercase tracking-tight">
                      Requester: <span className="text-slate-600">{item.from}</span> <span className="mx-2 opacity-30">|</span> {item.time}
                    </div>
                  </div>
                  <div className="w-8 h-8 rounded-full flex items-center justify-center bg-slate-50 opacity-0 group-hover:opacity-100 transition-all">
                    <ChevronRight className="w-4 h-4 text-slate-400" />
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>
      </div>
  );
};

export default Dashboard;



============================================================
File Path: src/pages/GmailOAuthCallback.tsx
============================================================
import { useEffect, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";
import { Loader2, CheckCircle2, XCircle } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

const GmailOAuthCallback = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [status, setStatus] = useState<"loading" | "success" | "error">("loading");
  const [message, setMessage] = useState("");

  useEffect(() => {
    const handleCallback = async () => {
      const code = searchParams.get("code");
      const returnedState = searchParams.get("state");
      const storedState = sessionStorage.getItem("gmail_oauth_state");
      const tenantId = sessionStorage.getItem("gmail_oauth_tenant_id");
      const error = searchParams.get("error");

      if (error) {
        setStatus("error");
        setMessage("Google 인증이 취소되었습니다.");
        return;
      }

      if (!code) {
        setStatus("error");
        setMessage("인증 코드가 없습니다.");
        return;
      }

      if (!returnedState || returnedState !== storedState) {
        setStatus("error");
        setMessage("보안 검증에 실패했습니다. 다시 시도해주세요.");
        return;
      }

      if (!tenantId) {
        setStatus("error");
        setMessage("테넌트 정보가 없습니다. 다시 시도해주세요.");
        return;
      }

      // Clean up
      sessionStorage.removeItem("gmail_oauth_state");
      sessionStorage.removeItem("gmail_oauth_tenant_id");

      try {
        const redirectUri = `${window.location.origin}/auth/gmail/callback`;

        const res = await supabase.functions.invoke("gmail-oauth", {
          body: { action: "exchange_code", code, tenantId, redirectUri },
        });

        if (res.error) throw res.error;
        if (res.data?.success) {
          setStatus("success");
          setMessage(`Gmail 연동 완료! (${res.data.email})`);
        } else {
          throw new Error(res.data?.error || "알 수 없는 오류");
        }
      } catch (e: any) {
        setStatus("error");
        setMessage(e.message || "토큰 교환 중 오류가 발생했습니다.");
      }
    };

    handleCallback();
  }, [searchParams]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <Card className="w-full max-w-md border-none shadow-xl rounded-2xl">
        <CardContent className="p-8 text-center space-y-4">
          {status === "loading" && (
            <>
              <Loader2 className="w-12 h-12 animate-spin mx-auto text-primary" />
              <p className="text-lg font-semibold">Gmail 연동 처리 중...</p>
              <p className="text-sm text-muted-foreground">잠시만 기다려 주세요.</p>
            </>
          )}
          {status === "success" && (
            <>
              <CheckCircle2 className="w-12 h-12 text-green-500 mx-auto" />
              <p className="text-lg font-semibold">연동 성공!</p>
              <p className="text-sm text-muted-foreground">{message}</p>
              <Button onClick={() => navigate("/my-page")} className="mt-4 rounded-xl">
                마이페이지로 돌아가기
              </Button>
            </>
          )}
          {status === "error" && (
            <>
              <XCircle className="w-12 h-12 text-destructive mx-auto" />
              <p className="text-lg font-semibold">연동 실패</p>
              <p className="text-sm text-muted-foreground">{message}</p>
              <Button onClick={() => navigate("/my-page")} variant="outline" className="mt-4 rounded-xl">
                마이페이지로 돌아가기
              </Button>
            </>
          )}
        </CardContent>
      </Card>
    </div>
  );
};

export default GmailOAuthCallback;



============================================================
File Path: src/pages/GuestForm.tsx
============================================================
import { useState } from "react";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Upload, 
  FileText, 
  CheckCircle2, 
  Loader2, 
  Sparkles,
  Building2,
  CreditCard,
  User,
  Phone,
  Mail
} from "lucide-react";
import { toast } from "sonner";

// Mock data for demonstration
const mockEmployees = [
  { id: "1", name: "김수연", department: "재무팀", phone: "010-1234-5678", email: "sooyeon@company.com" },
  { id: "2", name: "이준혁", department: "영업팀", phone: "010-2345-6789", email: "junhyuk@company.com" },
  { id: "3", name: "박민서", department: "마케팅팀", phone: "010-3456-7890", email: "minseo@company.com" },
];

const GuestForm = () => {
  const [step, setStep] = useState(1);
  const [isProcessing, setIsProcessing] = useState(false);
  const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);
  const [extractedData, setExtractedData] = useState({
    amount: "",
    businessNumber: "",
    accountNumber: "",
  });
  const [formData, setFormData] = useState({
    companyName: "",
    description: "",
    amount: "",
    bankName: "",
    accountNumber: "",
    accountHolder: "",
    assignedEmployee: "",
  });

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files?.length) return;

    setUploadedFiles(Array.from(files));
    setIsProcessing(true);

    // Simulate AI processing
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Mock extracted data
    setExtractedData({
      amount: "3,500,000",
      businessNumber: "123-45-67890",
      accountNumber: "110-123-456789",
    });

    setFormData(prev => ({
      ...prev,
      amount: "3,500,000",
      accountNumber: "110-123-456789",
    }));

    setIsProcessing(false);
    toast.success("AI가 문서에서 정보를 추출했습니다!", {
      description: "금액, 계좌번호가 자동으로 입력되었습니다.",
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsProcessing(true);
    await new Promise(resolve => setTimeout(resolve, 1500));
    setIsProcessing(false);
    setStep(3);
    toast.success("청구서가 성공적으로 제출되었습니다!", {
      description: "담당자에게 알림이 발송됩니다.",
    });
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />
      
      <main className="pt-24 pb-16 px-4">
        <div className="max-w-2xl mx-auto">
          {/* Header */}
          <div className="text-center mb-10">
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 border border-primary/20 mb-6">
              <FileText className="w-4 h-4 text-primary" />
              <span className="text-sm text-primary font-medium">외부 거래처 청구 폼</span>
            </div>
            <h1 className="text-3xl md:text-4xl font-bold mb-4">
              청구서 <span className="gradient-text">간편 제출</span>
            </h1>
            <p className="text-muted-foreground">
              견적서, 통장사본을 업로드하면 AI가 자동으로 정보를 추출합니다.
            </p>
          </div>

          {/* Progress Steps */}
          <div className="flex items-center justify-center gap-4 mb-10">
            {[1, 2, 3].map((s) => (
              <div key={s} className="flex items-center gap-2">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold transition-all ${
                  s < step ? 'bg-success text-success-foreground' :
                  s === step ? 'bg-primary text-primary-foreground' :
                  'bg-secondary text-muted-foreground'
                }`}>
                  {s < step ? <CheckCircle2 className="w-5 h-5" /> : s}
                </div>
                <span className={`text-sm hidden sm:inline ${s === step ? 'text-foreground font-medium' : 'text-muted-foreground'}`}>
                  {s === 1 ? '파일 업로드' : s === 2 ? '정보 입력' : '완료'}
                </span>
                {s < 3 && <div className={`w-8 h-0.5 ${s < step ? 'bg-success' : 'bg-border'}`} />}
              </div>
            ))}
          </div>

          {/* Step 1: File Upload */}
          {step === 1 && (
            <div className="glass-card p-8">
              <div className="text-center mb-6">
                <h2 className="text-xl font-semibold mb-2">증빙 서류 업로드</h2>
                <p className="text-sm text-muted-foreground">
                  견적서, 통장사본, 사업자등록증 등을 업로드해주세요
                </p>
              </div>

              {/* Upload Area */}
              <label className="block cursor-pointer">
                <div className={`border-2 border-dashed rounded-xl p-8 text-center transition-all ${
                  isProcessing 
                    ? 'border-primary bg-primary/5' 
                    : 'border-border hover:border-primary/50 hover:bg-secondary/30'
                }`}>
                  {isProcessing ? (
                    <div className="flex flex-col items-center gap-4">
                      <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center">
                        <Loader2 className="w-8 h-8 text-primary animate-spin" />
                      </div>
                      <div>
                        <p className="font-medium mb-1">AI가 문서를 분석하고 있습니다...</p>
                        <p className="text-sm text-muted-foreground">금액, 계좌정보 등을 자동 추출합니다</p>
                      </div>
                    </div>
                  ) : uploadedFiles.length > 0 ? (
                    <div className="flex flex-col items-center gap-4">
                      <div className="w-16 h-16 rounded-full bg-success/10 flex items-center justify-center">
                        <CheckCircle2 className="w-8 h-8 text-success" />
                      </div>
                      <div>
                        <p className="font-medium mb-2">{uploadedFiles.length}개 파일 업로드됨</p>
                        <div className="flex flex-wrap gap-2 justify-center">
                          {uploadedFiles.map((file, i) => (
                            <span key={i} className="text-xs px-2 py-1 rounded-full bg-secondary text-muted-foreground">
                              {file.name}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center gap-4">
                      <div className="w-16 h-16 rounded-full bg-secondary flex items-center justify-center">
                        <Upload className="w-8 h-8 text-muted-foreground" />
                      </div>
                      <div>
                        <p className="font-medium mb-1">클릭하여 파일 선택</p>
                        <p className="text-sm text-muted-foreground">PDF, Word, 한글, 이미지 (JPG, PNG)</p>
                      </div>
                    </div>
                  )}
                </div>
                <input 
                  type="file" 
                  className="hidden" 
                  multiple 
                  accept=".pdf,.doc,.docx,.hwp,.jpg,.jpeg,.png"
                  onChange={handleFileUpload}
                />
              </label>

              {/* AI Extract Info */}
              {extractedData.amount && (
                <div className="mt-6 p-4 rounded-lg bg-primary/5 border border-primary/20">
                  <div className="flex items-center gap-2 mb-3">
                    <Sparkles className="w-4 h-4 text-primary" />
                    <span className="text-sm font-medium text-primary">AI 추출 정보</span>
                  </div>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="text-muted-foreground">금액:</span>
                      <span className="ml-2 font-medium">₩{extractedData.amount}</span>
                    </div>
                    <div>
                      <span className="text-muted-foreground">계좌번호:</span>
                      <span className="ml-2 font-medium">{extractedData.accountNumber}</span>
                    </div>
                  </div>
                </div>
              )}

              <Button 
                className="w-full mt-6" 
                size="lg"
                disabled={uploadedFiles.length === 0 || isProcessing}
                onClick={() => setStep(2)}
              >
                다음 단계로
              </Button>
            </div>
          )}

          {/* Step 2: Form Input */}
          {step === 2 && (
            <form onSubmit={handleSubmit} className="glass-card p-8 space-y-6">
              {/* Company Info */}
              <div className="space-y-4">
                <div className="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                  <Building2 className="w-4 h-4" />
                  거래처 정보
                </div>
                <div className="grid sm:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="companyName">회사명</Label>
                    <Input 
                      id="companyName" 
                      placeholder="(주)거래처회사" 
                      value={formData.companyName}
                      onChange={(e) => setFormData(prev => ({ ...prev, companyName: e.target.value }))}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="amount">청구 금액</Label>
                    <Input 
                      id="amount" 
                      placeholder="₩ 0" 
                      value={formData.amount}
                      onChange={(e) => setFormData(prev => ({ ...prev, amount: e.target.value }))}
                      required
                    />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="description">청구 내용</Label>
                  <Textarea 
                    id="description" 
                    placeholder="청구 내용을 상세히 입력해주세요"
                    className="min-h-[100px]"
                    value={formData.description}
                    onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                    required
                  />
                </div>
              </div>

              {/* Bank Info */}
              <div className="space-y-4 pt-4 border-t border-border">
                <div className="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                  <CreditCard className="w-4 h-4" />
                  지급 계좌 정보
                </div>
                <div className="grid sm:grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="bankName">은행명</Label>
                    <Select 
                      value={formData.bankName}
                      onValueChange={(value) => setFormData(prev => ({ ...prev, bankName: value }))}
                    >
                      <SelectTrigger id="bankName" className="bg-background">
                        <SelectValue placeholder="선택" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="kb">국민은행</SelectItem>
                        <SelectItem value="shinhan">신한은행</SelectItem>
                        <SelectItem value="woori">우리은행</SelectItem>
                        <SelectItem value="hana">하나은행</SelectItem>
                        <SelectItem value="nh">농협은행</SelectItem>
                        <SelectItem value="ibk">기업은행</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="accountNumber">계좌번호</Label>
                    <Input 
                      id="accountNumber" 
                      placeholder="계좌번호"
                      value={formData.accountNumber}
                      onChange={(e) => setFormData(prev => ({ ...prev, accountNumber: e.target.value }))}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="accountHolder">예금주</Label>
                    <Input 
                      id="accountHolder" 
                      placeholder="예금주명"
                      value={formData.accountHolder}
                      onChange={(e) => setFormData(prev => ({ ...prev, accountHolder: e.target.value }))}
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Assign Employee */}
              <div className="space-y-4 pt-4 border-t border-border">
                <div className="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                  <User className="w-4 h-4" />
                  내부 담당자 지정
                </div>
                <Select 
                  value={formData.assignedEmployee}
                  onValueChange={(value) => setFormData(prev => ({ ...prev, assignedEmployee: value }))}
                >
                  <SelectTrigger className="bg-background">
                    <SelectValue placeholder="담당자를 선택하세요" />
                  </SelectTrigger>
                  <SelectContent>
                    {mockEmployees.map((emp) => (
                      <SelectItem key={emp.id} value={emp.id}>
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-sm font-medium">
                            {emp.name.charAt(0)}
                          </div>
                          <div className="text-left">
                            <div className="font-medium">{emp.name}</div>
                            <div className="text-xs text-muted-foreground">{emp.department}</div>
                          </div>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {formData.assignedEmployee && (
                  <div className="p-3 rounded-lg bg-secondary/50 flex items-center gap-4">
                    <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                      <User className="w-5 h-5 text-primary" />
                    </div>
                    <div className="flex-1">
                      <div className="font-medium">
                        {mockEmployees.find(e => e.id === formData.assignedEmployee)?.name}
                      </div>
                      <div className="text-xs text-muted-foreground flex items-center gap-3 mt-1">
                        <span className="flex items-center gap-1">
                          <Phone className="w-3 h-3" />
                          {mockEmployees.find(e => e.id === formData.assignedEmployee)?.phone}
                        </span>
                        <span className="flex items-center gap-1">
                          <Mail className="w-3 h-3" />
                          {mockEmployees.find(e => e.id === formData.assignedEmployee)?.email}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="flex gap-3 pt-4">
                <Button type="button" variant="outline" onClick={() => setStep(1)} className="flex-1">
                  이전
                </Button>
                <Button type="submit" variant="hero" className="flex-1" disabled={isProcessing}>
                  {isProcessing ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      제출 중...
                    </>
                  ) : (
                    '청구서 제출'
                  )}
                </Button>
              </div>
            </form>
          )}

          {/* Step 3: Complete */}
          {step === 3 && (
            <div className="glass-card p-8 text-center">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-success/10 flex items-center justify-center">
                <CheckCircle2 className="w-10 h-10 text-success" />
              </div>
              <h2 className="text-2xl font-bold mb-2">청구서 제출 완료!</h2>
              <p className="text-muted-foreground mb-6">
                담당자 {mockEmployees.find(e => e.id === formData.assignedEmployee)?.name}님에게
                <br />카카오톡/이메일 알림이 발송되었습니다.
              </p>
              <div className="p-4 rounded-lg bg-secondary/50 text-left mb-6">
                <div className="text-sm space-y-2">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">청구 금액</span>
                    <span className="font-medium">₩{formData.amount}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">접수 번호</span>
                    <span className="font-mono text-primary">#INV-2025-0042</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">상태</span>
                    <span className="status-badge status-pending">승인 대기</span>
                  </div>
                </div>
              </div>
              <Button variant="outline" onClick={() => { setStep(1); setUploadedFiles([]); setFormData({ companyName: "", description: "", amount: "", bankName: "", accountNumber: "", accountHolder: "", assignedEmployee: "" }); }}>
                새 청구서 작성
              </Button>
            </div>
          )}
        </div>
      </main>
    </div>
  );
};

export default GuestForm;



============================================================
File Path: src/pages/Index.tsx
============================================================
import { Header } from "@/components/landing/Header";
import { HeroSection } from "@/components/landing/HeroSection";
import { FeaturesSection } from "@/components/landing/FeaturesSection";
import { ArchitectureSection } from "@/components/landing/ArchitectureSection";
import { WorkflowIndependence } from "@/components/landing/PartnerControl";
import { PricingSection } from "@/components/landing/PricingSection";
import { Footer } from "@/components/landing/Footer";

const Index = () => {
  return (
    <div className="min-h-screen bg-background">
      <Header />
      <main>
        {/* 1. 첫인상: Arkport OS의 정체성 (운영 인프라) */}
        <HeroSection />

        {/* 2. 주요 기능: 행정 자동화 및 올인원 플랫폼 */}
        <FeaturesSection />

        {/* 3. 시스템 아키텍처: 위장도급 리스크를 제거하는 '권한/로그' 중심 구조 */}
        <ArchitectureSection />

        {/* 4. 워크플로우 독립성: 파트너를 직접 제어하고 데이터를 소유하는 방식 */}
        <WorkflowIndependence />

        {/* 5. 수익 분리 구조: 에이전시(18%)와 인프라(2%)의 명확한 비용 구분 */}
        <PricingSection />
      </main>
      <Footer />
    </div>
  );
};

export default Index;



============================================================
File Path: src/pages/LeaveRequest.tsx
============================================================
import React, { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import { CalendarDays, Plus, Check, X, Palmtree, Clock, TrendingUp } from "lucide-react";

const STATUS_MAP: Record<string, { label: string; variant: "default" | "secondary" | "destructive" | "outline" }> = {
  pending: { label: "대기", variant: "outline" },
  approved: { label: "승인", variant: "default" },
  rejected: { label: "반려", variant: "destructive" },
  cancelled: { label: "취소", variant: "secondary" },
};

const LeaveRequest = () => {
  const { user, currentTenant, isCompanyAdmin } = useAuth();
  const tenantId = currentTenant?.tenant_id;

  const [balances, setBalances] = useState<any[]>([]);
  const [types, setTypes] = useState<any[]>([]);
  const [requests, setRequests] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [requestDialog, setRequestDialog] = useState(false);
  const [form, setForm] = useState({
    leave_type_id: "", start_date: "", end_date: "", start_time: "", end_time: "", reason: "",
  });

  // Admin: pending requests from all members
  const [pendingRequests, setPendingRequests] = useState<any[]>([]);

  useEffect(() => {
    if (tenantId && user) loadAll();
  }, [tenantId, user]);

  const loadAll = async () => {
    if (!tenantId || !user) return;
    setLoading(true);

    const [bRes, tRes, rRes] = await Promise.all([
      supabase.from("leave_balances")
        .select("*, group:leave_groups(name)")
        .eq("tenant_id", tenantId).eq("user_id", user.id)
        .order("valid_from", { ascending: false }),
      supabase.from("leave_types")
        .select("*, group:leave_groups(name)")
        .eq("tenant_id", tenantId).eq("is_active", true),
      supabase.from("leave_requests")
        .select("*, leave_type:leave_types(name, group:leave_groups(name))")
        .eq("tenant_id", tenantId).eq("user_id", user.id)
        .order("created_at", { ascending: false }),
    ]);

    if (bRes.data) setBalances(bRes.data);
    if (tRes.data) setTypes(tRes.data);
    if (rRes.data) setRequests(rRes.data);

    // Admin: load all pending requests
    if (isCompanyAdmin) {
      const { data } = await supabase.from("leave_requests")
        .select("*, leave_type:leave_types(name), profile:profiles(full_name, email)")
        .eq("tenant_id", tenantId).eq("status", "pending")
        .order("created_at", { ascending: true });
      if (data) setPendingRequests(data);
    }
    setLoading(false);
  };

  // 잔여일수 요약 계산
  const balanceSummary: Record<string, { total: number; used: number }> = balances.reduce((acc: Record<string, { total: number; used: number }>, b: any) => {
    const key = b.group?.name || "기타";
    if (!acc[key]) acc[key] = { total: 0, used: 0 };
    acc[key].total += Number(b.total_days);
    acc[key].used += Number(b.used_days);
    return acc;
  }, {} as Record<string, { total: number; used: number }>);

  const submitRequest = async () => {
    if (!tenantId || !user || !form.leave_type_id || !form.start_date || !form.end_date) {
      toast.error("필수 항목을 입력해주세요."); return;
    }
    const selectedType = types.find((t: any) => t.id === form.leave_type_id);
    const startDate = new Date(form.start_date);
    const endDate = new Date(form.end_date);
    const diffDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
    const totalDays = diffDays * (selectedType?.deduction_days || 1);

    const { error } = await supabase.from("leave_requests").insert({
      tenant_id: tenantId, user_id: user.id, leave_type_id: form.leave_type_id,
      start_date: form.start_date, end_date: form.end_date,
      start_time: form.start_time || null, end_time: form.end_time || null,
      total_days: totalDays, reason: form.reason || null,
    } as any);

    if (error) { toast.error("신청 실패: " + error.message); return; }
    toast.success("휴가 신청 완료");
    setRequestDialog(false);
    setForm({ leave_type_id: "", start_date: "", end_date: "", start_time: "", end_time: "", reason: "" });
    loadAll();
  };

  const cancelRequest = async (id: string) => {
    if (!confirm("취소하시겠습니까?")) return;
    await supabase.from("leave_requests").update({ status: "cancelled" }).eq("id", id);
    toast.success("취소 완료");
    loadAll();
  };

  const approveRequest = async (id: string) => {
    if (!user) return;
    // Get request details to update balance
    const req = pendingRequests.find((r: any) => r.id === id);
    await supabase.from("leave_requests").update({ status: "approved", approved_by: user.id, approved_at: new Date().toISOString() }).eq("id", id);
    
    // Update used_days in balance if applicable
    if (req) {
      const { data: typeData } = await supabase.from("leave_types").select("group_id").eq("id", req.leave_type_id).single();
      if (typeData?.group_id) {
        const { data: bal } = await supabase.from("leave_balances")
          .select("id, used_days")
          .eq("tenant_id", tenantId!).eq("user_id", req.user_id).eq("group_id", typeData.group_id)
          .order("valid_from", { ascending: false }).limit(1).single();
        if (bal) {
          await supabase.from("leave_balances").update({ used_days: Number(bal.used_days) + Number(req.total_days) }).eq("id", bal.id);
        }
      }
    }
    toast.success("승인 완료");
    loadAll();
  };

  const rejectRequest = async (id: string) => {
    const reason = prompt("반려 사유를 입력하세요:");
    if (reason === null) return;
    await supabase.from("leave_requests").update({ status: "rejected", approved_by: user?.id, approved_at: new Date().toISOString(), reject_reason: reason }).eq("id", id);
    toast.success("반려 완료");
    loadAll();
  };

  if (loading) return <div className="p-8 text-center text-muted-foreground">로딩 중...</div>;

  const selectedType = types.find((t: any) => t.id === form.leave_type_id);

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold flex items-center gap-2"><Palmtree className="w-6 h-6" />휴가 신청</h1>
        <Button onClick={() => setRequestDialog(true)}><Plus className="w-4 h-4 mr-1" />휴가 신청</Button>
      </div>

      {/* 잔여일수 카드 */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {Object.entries(balanceSummary).map(([group, data]) => (
          <Card key={group}>
            <CardContent className="pt-6">
              <div className="flex items-center gap-2 mb-2">
                <CalendarDays className="w-5 h-5 text-primary" />
                <span className="font-semibold">{group}</span>
              </div>
              <div className="grid grid-cols-3 gap-2 text-center">
                <div>
                  <div className="text-2xl font-bold text-primary">{data.total}</div>
                  <div className="text-xs text-muted-foreground">총 발생</div>
                </div>
                <div>
                  <div className="text-2xl font-bold text-destructive">{data.used}</div>
                  <div className="text-xs text-muted-foreground">사용</div>
                </div>
                <div>
                  <div className="text-2xl font-bold text-accent-foreground">{data.total - data.used}</div>
                  <div className="text-xs text-muted-foreground">잔여</div>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
        {Object.keys(balanceSummary).length === 0 && (
          <Card className="col-span-full"><CardContent className="pt-6 text-center text-muted-foreground">발생된 휴가가 없습니다. 관리자에게 문의하세요.</CardContent></Card>
        )}
      </div>

      <Tabs defaultValue="my-requests">
        <TabsList>
          <TabsTrigger value="my-requests">내 휴가 신청</TabsTrigger>
          {isCompanyAdmin && <TabsTrigger value="approvals">결재함 ({pendingRequests.length})</TabsTrigger>}
        </TabsList>

        <TabsContent value="my-requests">
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>유형</TableHead>
                  <TableHead>기간</TableHead>
                  <TableHead>차감일수</TableHead>
                  <TableHead>사유</TableHead>
                  <TableHead>상태</TableHead>
                  <TableHead>신청일</TableHead>
                  <TableHead className="w-20">관리</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {requests.map((r: any) => {
                  const s = STATUS_MAP[r.status] || STATUS_MAP.pending;
                  return (
                    <TableRow key={r.id}>
                      <TableCell className="font-medium">{r.leave_type?.name || "-"}</TableCell>
                      <TableCell>{r.start_date} ~ {r.end_date}{r.start_time ? ` (${r.start_time}~${r.end_time})` : ""}</TableCell>
                      <TableCell>{r.total_days}일</TableCell>
                      <TableCell className="text-muted-foreground max-w-[200px] truncate">{r.reason || "-"}</TableCell>
                      <TableCell><Badge variant={s.variant}>{s.label}</Badge>{r.reject_reason && <p className="text-xs text-destructive mt-1">{r.reject_reason}</p>}</TableCell>
                      <TableCell className="text-xs">{new Date(r.created_at).toLocaleDateString("ko")}</TableCell>
                      <TableCell>
                        {r.status === "pending" && (
                          <Button size="sm" variant="ghost" onClick={() => cancelRequest(r.id)}><X className="w-4 h-4 text-destructive" /></Button>
                        )}
                      </TableCell>
                    </TableRow>
                  );
                })}
                {requests.length === 0 && <TableRow><TableCell colSpan={7} className="text-center py-8 text-muted-foreground">신청 내역이 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>

        {isCompanyAdmin && (
          <TabsContent value="approvals">
            <Card>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>신청자</TableHead>
                    <TableHead>유형</TableHead>
                    <TableHead>기간</TableHead>
                    <TableHead>차감일수</TableHead>
                    <TableHead>사유</TableHead>
                    <TableHead>신청일</TableHead>
                    <TableHead className="w-28">결재</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {pendingRequests.map((r: any) => (
                    <TableRow key={r.id}>
                      <TableCell className="font-medium">{r.profile?.full_name || r.profile?.email || "-"}</TableCell>
                      <TableCell>{r.leave_type?.name || "-"}</TableCell>
                      <TableCell>{r.start_date} ~ {r.end_date}</TableCell>
                      <TableCell>{r.total_days}일</TableCell>
                      <TableCell className="text-muted-foreground max-w-[200px] truncate">{r.reason || "-"}</TableCell>
                      <TableCell className="text-xs">{new Date(r.created_at).toLocaleDateString("ko")}</TableCell>
                      <TableCell>
                        <div className="flex gap-1">
                          <Button size="sm" variant="default" onClick={() => approveRequest(r.id)}><Check className="w-4 h-4" /></Button>
                          <Button size="sm" variant="destructive" onClick={() => rejectRequest(r.id)}><X className="w-4 h-4" /></Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                  {pendingRequests.length === 0 && <TableRow><TableCell colSpan={7} className="text-center py-8 text-muted-foreground">대기 중인 결재가 없습니다.</TableCell></TableRow>}
                </TableBody>
              </Table>
            </Card>
          </TabsContent>
        )}
      </Tabs>

      {/* 휴가 신청 Dialog */}
      <Dialog open={requestDialog} onOpenChange={setRequestDialog}>
        <DialogContent>
          <DialogHeader><DialogTitle>휴가 신청</DialogTitle></DialogHeader>
          <div className="space-y-4">
            <div>
              <Label>휴가 유형 *</Label>
              <Select value={form.leave_type_id} onValueChange={v => setForm(p => ({ ...p, leave_type_id: v }))}>
                <SelectTrigger><SelectValue placeholder="선택" /></SelectTrigger>
                <SelectContent>
                  {types.map((t: any) => (
                    <SelectItem key={t.id} value={t.id}>
                      {t.group?.name ? `[${t.group.name}] ` : ""}{t.name} ({t.deduction_days}일 차감)
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div><Label>시작일 *</Label><Input type="date" value={form.start_date} onChange={e => setForm(p => ({ ...p, start_date: e.target.value, end_date: p.end_date || e.target.value }))} /></div>
              <div><Label>종료일 *</Label><Input type="date" value={form.end_date} onChange={e => setForm(p => ({ ...p, end_date: e.target.value }))} /></div>
            </div>
            {selectedType?.time_option === "time_input" && (
              <div className="grid grid-cols-2 gap-3">
                <div><Label>시작시간</Label><Input type="time" value={form.start_time} onChange={e => setForm(p => ({ ...p, start_time: e.target.value }))} /></div>
                <div><Label>종료시간</Label><Input type="time" value={form.end_time} onChange={e => setForm(p => ({ ...p, end_time: e.target.value }))} /></div>
              </div>
            )}
            <div><Label>사유</Label><Textarea value={form.reason} onChange={e => setForm(p => ({ ...p, reason: e.target.value }))} placeholder="휴가 사유 입력" /></div>
            {form.start_date && form.end_date && selectedType && (
              <div className="p-3 bg-muted rounded-lg text-sm">
                <p>차감 일수: <strong>{(Math.ceil((new Date(form.end_date).getTime() - new Date(form.start_date).getTime()) / (1000 * 60 * 60 * 24)) + 1) * selectedType.deduction_days}일</strong></p>
              </div>
            )}
            <Button onClick={submitRequest} className="w-full">신청하기</Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default LeaveRequest;



============================================================
File Path: src/pages/MyPage.tsx
============================================================
import { useEffect, useState, useRef, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  ArrowLeft, User, Building2, CreditCard, FileText,
  Mail, Phone, Shield, PenTool, GitBranch,
  Plus, Trash2, GripVertical, Upload, X, ChevronUp, ChevronDown,
  ClipboardList, Save, Loader2, Heart, ExternalLink, Car,
} from "lucide-react";
import { MyVehicleTab } from "@/components/mypage/MyVehicleTab";
import { MailIntegrationTab } from "@/components/mypage/MailIntegrationTab";
import { toast } from "sonner";

interface HRRecord {
  id: string;
  record_type: string;
  title: string;
  description: string | null;
  effective_date: string;
  old_department: string | null;
  new_department: string | null;
  old_job_title: string | null;
  new_job_title: string | null;
  old_role: string | null;
  new_role: string | null;
  created_at: string;
}

interface CorporateCard {
  id: string;
  card_number: string;
  card_name: string | null;
  card_company: string | null;
  monthly_limit: number | null;
  is_active: boolean | null;
  expiry_date: string | null;
}

interface ApprovalLine {
  id: string;
  step_order: number;
  approver_user_id: string;
  approver_name?: string;
  approver_job_title?: string;
}

interface TenantMember {
  user_id: string;
  full_name: string | null;
  job_title: string | null;
  department: string | null;
}

interface EmployeeDetail {
  id: string;
  hire_date: string | null;
  resignation_date: string | null;
  resident_number: string | null;
  is_foreigner: string | null;
  nationality: string | null;
  address: string | null;
  phone_mobile: string | null;
  phone_tel: string | null;
  email: string | null;
  bank_name: string | null;
  account_number: string | null;
  account_holder: string | null;
  emergency_contacts: { relation: string; name: string; phone: string }[] | null;
  id_card_url: string | null;
  bankbook_url: string | null;
}

const roleLabel: Record<string, string> = {
  company_admin: "대표 관리자",
  manager: "매니저",
  employee: "직원",
};

const recordTypeLabel: Record<string, string> = {
  promotion: "승진",
  transfer: "부서이동",
  role_change: "역할변경",
  note: "메모",
  join: "입사",
  leave: "퇴사",
};

const MyPage = () => {
  const navigate = useNavigate();
  const { user, profile, currentTenant, isSuperAdmin } = useAuth();
  const [hrRecords, setHrRecords] = useState<HRRecord[]>([]);
  const [cards, setCards] = useState<CorporateCard[]>([]);
  const [approvalLines, setApprovalLines] = useState<ApprovalLine[]>([]);
  const [tenantMembers, setTenantMembers] = useState<TenantMember[]>([]);
  const [signatureUrl, setSignatureUrl] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [savingApproval, setSavingApproval] = useState(false);
  const [uploadingSignature, setUploadingSignature] = useState(false);

  // Employee details
  const [employeeDetail, setEmployeeDetail] = useState<EmployeeDetail | null>(null);
  const [editingDetail, setEditingDetail] = useState(false);
  const [detailForm, setDetailForm] = useState<Partial<EmployeeDetail>>({});
  const [editContacts, setEditContacts] = useState<{ relation: string; name: string; phone: string }[]>([]);
  const [savingDetail, setSavingDetail] = useState(false);

  // Canvas 서명 관련
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [hasDrawn, setHasDrawn] = useState(false);
  const [signatureMode, setSignatureMode] = useState<"view" | "draw" | "upload">("view");

  useEffect(() => {
    if (!user || !currentTenant) return;

    const fetchData = async () => {
      setLoading(true);
      const [hrRes, cardRes, approvalRes, membersRes, profileRes, detailRes] = await Promise.all([
        supabase
          .from("hr_records")
          .select("*")
          .eq("user_id", user.id)
          .eq("tenant_id", currentTenant.tenant_id)
          .order("effective_date", { ascending: false }),
        supabase
          .from("corporate_cards")
          .select("id, card_number, card_name, card_company, monthly_limit, is_active, expiry_date")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("holder_user_id", user.id),
        supabase
          .from("approval_lines")
          .select("id, step_order, approver_user_id")
          .eq("user_id", user.id)
          .eq("tenant_id", currentTenant.tenant_id)
          .order("step_order", { ascending: true }),
        supabase
          .from("tenant_memberships")
          .select("user_id, job_title, department")
          .eq("tenant_id", currentTenant.tenant_id),
        supabase
          .from("profiles")
          .select("signature_url")
          .eq("id", user.id)
          .single(),
        supabase
          .from("employee_details")
          .select("*")
          .eq("user_id", user.id)
          .eq("tenant_id", currentTenant.tenant_id)
          .maybeSingle(),
      ]);

      if (hrRes.data) setHrRecords(hrRes.data as HRRecord[]);
      if (cardRes.data) setCards(cardRes.data as CorporateCard[]);
      if (profileRes.data) setSignatureUrl((profileRes.data as any).signature_url);
      if (detailRes.data) setEmployeeDetail(detailRes.data as unknown as EmployeeDetail);

      // 멤버 목록에 이름 매핑
      if (membersRes.data) {
        const memberIds = (membersRes.data as any[]).map((m: any) => m.user_id);
        const { data: profilesData } = await supabase
          .from("profiles")
          .select("id, full_name")
          .in("id", memberIds);

        const nameMap = new Map((profilesData || []).map((p: any) => [p.id, p.full_name]));
        const members = (membersRes.data as any[]).map((m: any) => ({
          ...m,
          full_name: nameMap.get(m.user_id) || "이름 없음",
        }));
        setTenantMembers(members);

        if (approvalRes.data) {
          setApprovalLines(
            (approvalRes.data as any[]).map((a: any) => ({
              ...a,
              approver_name: nameMap.get(a.approver_user_id) || "이름 없음",
              approver_job_title: members.find((m: any) => m.user_id === a.approver_user_id)?.job_title || "",
            }))
          );
        }
      }

      setLoading(false);
    };

    fetchData();
  }, [user, currentTenant]);

  const maskCardNumber = (num: string) => {
    if (num.length <= 4) return num;
    return "●●●● ●●●● ●●●● " + num.slice(-4);
  };

  const maskResident = (num: string | null) => {
    if (!num) return "-";
    return num.replace(/(.{6}).+/, "$1-*******");
  };

  // === Employee detail editing ===
  const startEditDetail = () => {
    if (employeeDetail) {
      setDetailForm({ ...employeeDetail });
      setEditContacts(
        Array.isArray(employeeDetail.emergency_contacts) && employeeDetail.emergency_contacts.length > 0
          ? [...employeeDetail.emergency_contacts]
          : [{ relation: "", name: "", phone: "" }]
      );
    } else {
      // New record — blank form
      setDetailForm({
        hire_date: null, resignation_date: null, resident_number: null,
        is_foreigner: "내국인", nationality: "대한민국", address: null,
        phone_mobile: profile?.phone || null, phone_tel: null,
        email: profile?.email || null, bank_name: null, account_number: null,
        account_holder: null, id_card_url: null, bankbook_url: null,
      });
      setEditContacts([{ relation: "", name: "", phone: "" }]);
    }
    setEditingDetail(true);
  };

  const cancelEditDetail = () => {
    setEditingDetail(false);
    setDetailForm({});
    setEditContacts([]);
  };

  // File upload helper for 신분증/통장사본
  const [uploadingDoc, setUploadingDoc] = useState<string | null>(null);
  const handleDocUpload = async (e: React.ChangeEvent<HTMLInputElement>, docType: "id_card" | "bankbook") => {
    const file = e.target.files?.[0];
    if (!file || !user || !currentTenant) return;
    if (!file.type.startsWith("image/") && file.type !== "application/pdf") {
      toast.error("이미지 또는 PDF 파일만 업로드 가능합니다.");
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      toast.error("파일 크기는 5MB 이하여야 합니다.");
      return;
    }
    setUploadingDoc(docType);
    try {
      const ext = file.name.split(".").pop() || "png";
      const filePath = `employee-docs/${currentTenant.tenant_id}/${user.id}/${docType}.${ext}`;
      const { error: uploadError } = await supabase.storage
        .from("artist-assets")
        .upload(filePath, file, { upsert: true, contentType: file.type });
      if (uploadError) throw uploadError;
      const { data: signedData, error: signedError } = await supabase.storage
        .from("artist-assets")
        .createSignedUrl(filePath, 60 * 60 * 24 * 365);
      if (signedError) throw signedError;
      const url = signedData.signedUrl;
      const key = docType === "id_card" ? "id_card_url" : "bankbook_url";
      setDetailForm(prev => ({ ...prev, [key]: url }));
      toast.success(docType === "id_card" ? "신분증이 업로드되었습니다." : "통장사본이 업로드되었습니다.");
    } catch (e: any) {
      toast.error("업로드 실패: " + e.message);
    } finally {
      setUploadingDoc(null);
    }
  };

  const saveDetail = async () => {
    if (!user || !currentTenant) return;
    setSavingDetail(true);
    try {
      const payload = {
        user_id: user.id,
        tenant_id: currentTenant.tenant_id,
        hire_date: detailForm.hire_date || null,
        resignation_date: detailForm.resignation_date || null,
        resident_number: detailForm.resident_number || null,
        is_foreigner: detailForm.is_foreigner || "내국인",
        nationality: detailForm.nationality || "대한민국",
        address: detailForm.address || null,
        phone_mobile: detailForm.phone_mobile || null,
        phone_tel: detailForm.phone_tel || null,
        email: detailForm.email || null,
        bank_name: detailForm.bank_name || null,
        account_number: detailForm.account_number || null,
        account_holder: detailForm.account_holder || null,
        id_card_url: detailForm.id_card_url || null,
        bankbook_url: detailForm.bankbook_url || null,
        emergency_contacts: editContacts.filter(c => c.name || c.phone),
      };

      const { error } = await supabase
        .from("employee_details")
        .upsert(payload, { onConflict: "user_id,tenant_id" });

      if (error) throw error;

      // Update phone in profiles too
      if (detailForm.phone_mobile) {
        await supabase.from("profiles").update({ phone: detailForm.phone_mobile }).eq("id", user.id);
      }

      // Refresh data
      const { data } = await supabase
        .from("employee_details")
        .select("*")
        .eq("user_id", user.id)
        .eq("tenant_id", currentTenant.tenant_id)
        .maybeSingle();
      if (data) setEmployeeDetail(data as unknown as EmployeeDetail);

      setEditingDetail(false);
      toast.success("인사 정보가 저장되었습니다.");
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSavingDetail(false);
    }
  };

  // === 결제라인 관리 ===
  const addApprovalStep = () => {
    setApprovalLines((prev) => [
      ...prev,
      { id: `new-${Date.now()}`, step_order: prev.length + 1, approver_user_id: "", approver_name: "" },
    ]);
  };

  const removeApprovalStep = (index: number) => {
    setApprovalLines((prev) =>
      prev.filter((_, i) => i !== index).map((item, i) => ({ ...item, step_order: i + 1 }))
    );
  };

  const moveStep = (index: number, direction: "up" | "down") => {
    setApprovalLines((prev) => {
      const arr = [...prev];
      const swapIdx = direction === "up" ? index - 1 : index + 1;
      if (swapIdx < 0 || swapIdx >= arr.length) return arr;
      [arr[index], arr[swapIdx]] = [arr[swapIdx], arr[index]];
      return arr.map((item, i) => ({ ...item, step_order: i + 1 }));
    });
  };

  const updateApprover = (index: number, userId: string) => {
    const member = tenantMembers.find((m) => m.user_id === userId);
    setApprovalLines((prev) =>
      prev.map((item, i) =>
        i === index
          ? { ...item, approver_user_id: userId, approver_name: member?.full_name || "", approver_job_title: member?.job_title || "" }
          : item
      )
    );
  };

  const saveApprovalLines = async () => {
    if (!user || !currentTenant) return;
    const invalid = approvalLines.some((a) => !a.approver_user_id);
    if (invalid) {
      toast.error("모든 단계에 결재자를 선택해주세요.");
      return;
    }

    setSavingApproval(true);
    try {
      await supabase
        .from("approval_lines")
        .delete()
        .eq("user_id", user.id)
        .eq("tenant_id", currentTenant.tenant_id);

      if (approvalLines.length > 0) {
        const { error } = await supabase.from("approval_lines").insert(
          approvalLines.map((a, i) => ({
            tenant_id: currentTenant.tenant_id,
            user_id: user.id,
            step_order: i + 1,
            approver_user_id: a.approver_user_id,
          }))
        );
        if (error) throw error;
      }
      toast.success("결제라인이 저장되었습니다.");
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSavingApproval(false);
    }
  };

  // === 서명 캔버스 ===
  const initCanvas = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);
    ctx.strokeStyle = "#1a1a1a";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }, []);

  useEffect(() => {
    if (signatureMode === "draw") {
      setTimeout(initCanvas, 100);
    }
  }, [signatureMode, initCanvas]);

  const getCoords = (e: React.MouseEvent | React.TouchEvent) => {
    const canvas = canvasRef.current;
    if (!canvas) return { x: 0, y: 0 };
    const rect = canvas.getBoundingClientRect();
    if ("touches" in e) {
      return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    }
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  };

  const startDraw = (e: React.MouseEvent | React.TouchEvent) => {
    e.preventDefault();
    setIsDrawing(true);
    const ctx = canvasRef.current?.getContext("2d");
    if (!ctx) return;
    const { x, y } = getCoords(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const draw = (e: React.MouseEvent | React.TouchEvent) => {
    if (!isDrawing) return;
    e.preventDefault();
    const ctx = canvasRef.current?.getContext("2d");
    if (!ctx) return;
    const { x, y } = getCoords(e);
    ctx.lineTo(x, y);
    ctx.stroke();
    setHasDrawn(true);
  };

  const endDraw = () => setIsDrawing(false);

  const clearCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    setHasDrawn(false);
  };

  const saveSignatureFromCanvas = async () => {
    if (!user || !canvasRef.current || !hasDrawn) return;
    setUploadingSignature(true);
    try {
      const blob = await new Promise<Blob | null>((resolve) =>
        canvasRef.current!.toBlob(resolve, "image/png")
      );
      if (!blob) throw new Error("서명 이미지 생성 실패");

      const filePath = `signatures/${user.id}/signature.png`;
      const { error: uploadError } = await supabase.storage
        .from("artist-assets")
        .upload(filePath, blob, { upsert: true, contentType: "image/png" });
      if (uploadError) throw uploadError;

      const { data: signedData1, error: signedError1 } = await supabase.storage
        .from("artist-assets")
        .createSignedUrl(filePath, 60 * 60 * 24 * 365);
      if (signedError1) throw signedError1;
      const url = signedData1.signedUrl;

      await supabase.from("profiles").update({ signature_url: url }).eq("id", user.id);
      setSignatureUrl(url);
      setSignatureMode("view");
      toast.success("서명이 저장되었습니다.");
    } catch (e: any) {
      toast.error("서명 저장 실패: " + e.message);
    } finally {
      setUploadingSignature(false);
    }
  };

  const handleSignatureUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;
    if (!file.type.startsWith("image/")) {
      toast.error("이미지 파일만 업로드 가능합니다.");
      return;
    }
    if (file.size > 2 * 1024 * 1024) {
      toast.error("파일 크기는 2MB 이하여야 합니다.");
      return;
    }
    setUploadingSignature(true);
    try {
      const filePath = `signatures/${user.id}/signature.png`;
      const { error: uploadError } = await supabase.storage
        .from("artist-assets")
        .upload(filePath, file, { upsert: true, contentType: file.type });
      if (uploadError) throw uploadError;

      const { data: signedData2, error: signedError2 } = await supabase.storage
        .from("artist-assets")
        .createSignedUrl(filePath, 60 * 60 * 24 * 365);
      if (signedError2) throw signedError2;
      const url = signedData2.signedUrl;

      await supabase.from("profiles").update({ signature_url: url }).eq("id", user.id);
      setSignatureUrl(url);
      setSignatureMode("view");
      toast.success("서명이 업로드되었습니다.");
    } catch (e: any) {
      toast.error("업로드 실패: " + e.message);
    } finally {
      setUploadingSignature(false);
    }
  };

  const deleteSignature = async () => {
    if (!user) return;
    try {
      await supabase.storage.from("artist-assets").remove([`signatures/${user.id}/signature.png`]);
      await supabase.from("profiles").update({ signature_url: null }).eq("id", user.id);
      setSignatureUrl(null);
      toast.success("서명이 삭제되었습니다.");
    } catch (e: any) {
      toast.error("삭제 실패: " + e.message);
    }
  };

  // Helper for detail info row
  const InfoRow = ({ label, value }: { label: string; value: string | null | undefined }) => (
    <div className="flex justify-between items-start py-2.5 border-b border-border/50 last:border-0">
      <span className="text-xs font-semibold text-muted-foreground w-28 shrink-0">{label}</span>
      <span className="text-sm text-right">{value || "-"}</span>
    </div>
  );

  return (
    <div className="min-h-screen bg-background">
      <Header />
      <main className="pt-28 pb-16 px-4 max-w-4xl mx-auto">
        {/* 헤더 */}
        <div className="flex items-center gap-4 mb-8">
          <Button variant="ghost" size="icon" onClick={() => navigate("/dashboard")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <User className="w-6 h-6 text-primary" /> 마이페이지
            </h1>
            <p className="text-muted-foreground text-sm mt-0.5">내 정보 및 회사 부여 정보 확인</p>
          </div>
        </div>

        {/* 프로필 카드 */}
        <Card className="mb-6 border-none shadow-lg rounded-2xl">
          <CardContent className="p-6">
            <div className="flex items-center gap-5">
              <Avatar className="w-16 h-16">
                <AvatarFallback className="bg-primary/10 text-primary text-xl font-bold">
                  {profile?.full_name?.charAt(0) || profile?.email?.charAt(0) || "?"}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1 min-w-0">
                <h2 className="text-xl font-bold">{profile?.full_name || "이름 미등록"}</h2>
                <div className="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-sm text-muted-foreground">
                  <span className="flex items-center gap-1"><Mail className="w-3.5 h-3.5" /> {profile?.email}</span>
                  {profile?.phone && (
                    <span className="flex items-center gap-1"><Phone className="w-3.5 h-3.5" /> {profile.phone}</span>
                  )}
                </div>
                {isSuperAdmin && (
                  <Badge variant="destructive" className="mt-2">
                    <Shield className="w-3 h-3 mr-1" /> Super Admin
                  </Badge>
                )}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 소속 정보 */}
        {currentTenant && (
          <Card className="mb-6 border-none shadow-lg rounded-2xl">
            <CardHeader className="pb-3">
              <CardTitle className="text-base flex items-center gap-2">
                <Building2 className="w-4 h-4 text-primary" /> 소속 정보
              </CardTitle>
            </CardHeader>
            <CardContent className="pt-0">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <p className="text-xs text-muted-foreground mb-0.5">회사</p>
                  <p className="font-medium text-sm">{currentTenant.tenant.name}</p>
                </div>
                <div>
                  <p className="text-xs text-muted-foreground mb-0.5">부서</p>
                  <p className="font-medium text-sm">{currentTenant.department || "미지정"}</p>
                </div>
                <div>
                  <p className="text-xs text-muted-foreground mb-0.5">직급</p>
                  <p className="font-medium text-sm">{currentTenant.job_title || "미지정"}</p>
                </div>
                <div>
                  <p className="text-xs text-muted-foreground mb-0.5">역할</p>
                  <Badge variant="secondary" className="text-xs">
                    {roleLabel[currentTenant.role] || currentTenant.role}
                  </Badge>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* 탭 */}
        <Tabs defaultValue="details" className="space-y-4">
          <TabsList className="w-full justify-start flex-wrap h-auto gap-1 p-1">
            <TabsTrigger value="details" className="flex items-center gap-1.5">
              <ClipboardList className="w-4 h-4" /> 내 인사정보
            </TabsTrigger>
            <TabsTrigger value="hr" className="flex items-center gap-1.5">
              <FileText className="w-4 h-4" /> 인사 기록
            </TabsTrigger>
            <TabsTrigger value="cards" className="flex items-center gap-1.5">
              <CreditCard className="w-4 h-4" /> 법인카드
            </TabsTrigger>
            <TabsTrigger value="approval" className="flex items-center gap-1.5">
              <GitBranch className="w-4 h-4" /> 결제라인
            </TabsTrigger>
            <TabsTrigger value="signature" className="flex items-center gap-1.5">
              <PenTool className="w-4 h-4" /> 서명 관리
            </TabsTrigger>
            <TabsTrigger value="vehicle" className="flex items-center gap-1.5">
              <Car className="w-4 h-4" /> 차량 관리
            </TabsTrigger>
            <TabsTrigger value="mail" className="flex items-center gap-1.5">
              <Mail className="w-4 h-4" /> 메일 연동
            </TabsTrigger>
          </TabsList>

          {/* 내 인사정보 탭 */}
          <TabsContent value="details">
            <Card className="border-none shadow-xl rounded-[2.5rem] overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-primary/5 to-accent/5 pb-4">
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <ClipboardList className="w-5 h-5 text-primary" /> 내 인사 카드
                    </CardTitle>
                    <p className="text-xs text-muted-foreground mt-1">
                      인사 정보를 등록·수정하면 사내 모든 문서에 자동 반영됩니다.
                    </p>
                  </div>
                  {!editingDetail && (
                    <Button variant={employeeDetail ? "outline" : "default"} size="sm" onClick={startEditDetail}
                      className="rounded-full px-5">
                      <PenTool className="w-3.5 h-3.5 mr-1.5" />
                      {employeeDetail ? "정보 수정" : "정보 등록"}
                    </Button>
                  )}
                </div>
              </CardHeader>
              <CardContent className="p-6 md:p-8">
                {loading ? (
                  <div className="py-8 text-center text-muted-foreground">
                    <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2" />불러오는 중...
                  </div>
                ) : editingDetail ? (
                  /* ─── 편집 모드 ─── */
                  <div className="space-y-8">
                    {/* 기본 정보 */}
                    <div className="space-y-3">
                      <h3 className="text-sm font-bold text-foreground flex items-center gap-2">
                        <User className="w-4 h-4 text-primary" /> 기본 정보
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 rounded-2xl bg-muted/30 border border-border/50">
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">입사일자</Label>
                          <Input type="date" value={detailForm.hire_date || ""} onChange={e => setDetailForm({...detailForm, hire_date: e.target.value})} className="rounded-xl" />
                        </div>
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">퇴사일자</Label>
                          <Input type="date" value={detailForm.resignation_date || ""} onChange={e => setDetailForm({...detailForm, resignation_date: e.target.value})} className="rounded-xl" />
                        </div>
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">주민등록번호</Label>
                          <Input type="password" value={detailForm.resident_number || ""} onChange={e => setDetailForm({...detailForm, resident_number: e.target.value})} placeholder="000000-0000000" className="rounded-xl" />
                        </div>
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">국적</Label>
                          <Input value={detailForm.nationality || ""} onChange={e => setDetailForm({...detailForm, nationality: e.target.value})} className="rounded-xl" />
                        </div>
                      </div>
                    </div>

                    {/* 연락처 & 주소 */}
                    <div className="space-y-3">
                      <h3 className="text-sm font-bold text-foreground flex items-center gap-2">
                        <Phone className="w-4 h-4 text-primary" /> 연락처 & 주소
                      </h3>
                      <div className="grid grid-cols-1 gap-4 p-4 rounded-2xl bg-muted/30 border border-border/50">
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">주소</Label>
                          <Input value={detailForm.address || ""} onChange={e => setDetailForm({...detailForm, address: e.target.value})} placeholder="주소를 입력하세요" className="rounded-xl" />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="space-y-1.5">
                            <Label className="text-xs font-semibold">휴대폰번호</Label>
                            <Input value={detailForm.phone_mobile || ""} onChange={e => setDetailForm({...detailForm, phone_mobile: e.target.value})} placeholder="010-0000-0000" className="rounded-xl" />
                          </div>
                          <div className="space-y-1.5">
                            <Label className="text-xs font-semibold">유선전화</Label>
                            <Input value={detailForm.phone_tel || ""} onChange={e => setDetailForm({...detailForm, phone_tel: e.target.value})} className="rounded-xl" />
                          </div>
                          <div className="space-y-1.5">
                            <Label className="text-xs font-semibold">이메일</Label>
                            <Input value={detailForm.email || ""} onChange={e => setDetailForm({...detailForm, email: e.target.value})} className="rounded-xl" />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 급여 계좌 */}
                    <div className="space-y-3">
                      <h3 className="text-sm font-bold text-foreground flex items-center gap-2">
                        <CreditCard className="w-4 h-4 text-primary" /> 급여 계좌
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 rounded-2xl bg-muted/30 border border-border/50">
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">은행</Label>
                          <Input value={detailForm.bank_name || ""} onChange={e => setDetailForm({...detailForm, bank_name: e.target.value})} placeholder="은행명" className="rounded-xl" />
                        </div>
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">계좌번호</Label>
                          <Input value={detailForm.account_number || ""} onChange={e => setDetailForm({...detailForm, account_number: e.target.value})} placeholder="계좌번호" className="rounded-xl" />
                        </div>
                        <div className="space-y-1.5">
                          <Label className="text-xs font-semibold">예금주</Label>
                          <Input value={detailForm.account_holder || ""} onChange={e => setDetailForm({...detailForm, account_holder: e.target.value})} placeholder="예금주명" className="rounded-xl" />
                        </div>
                      </div>
                    </div>

                    {/* 증빙서류 업로드 */}
                    <div className="space-y-3">
                      <h3 className="text-sm font-bold text-foreground flex items-center gap-2">
                        <Upload className="w-4 h-4 text-primary" /> 증빙 서류
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* 신분증 */}
                        <div className="p-4 rounded-2xl border border-border/50 bg-muted/30">
                          <Label className="text-xs font-semibold mb-2 block">신분증 사본</Label>
                          {detailForm.id_card_url ? (
                            <div className="flex items-center gap-3">
                              <a href={detailForm.id_card_url} target="_blank" rel="noopener noreferrer"
                                className="text-sm text-primary hover:underline flex items-center gap-1">
                                <ExternalLink className="w-3.5 h-3.5" /> 등록된 파일 보기
                              </a>
                              <label className="cursor-pointer">
                                <input type="file" accept="image/*,application/pdf" className="hidden"
                                  onChange={(e) => handleDocUpload(e, "id_card")} disabled={!!uploadingDoc} />
                                <Button variant="ghost" size="sm" asChild className="h-7 text-xs">
                                  <span>{uploadingDoc === "id_card" ? <Loader2 className="w-3 h-3 animate-spin" /> : "변경"}</span>
                                </Button>
                              </label>
                            </div>
                          ) : (
                            <label className="cursor-pointer block">
                              <input type="file" accept="image/*,application/pdf" className="hidden"
                                onChange={(e) => handleDocUpload(e, "id_card")} disabled={!!uploadingDoc} />
                              <div className="border-2 border-dashed border-border rounded-xl p-4 text-center hover:border-primary/40 transition-colors">
                                {uploadingDoc === "id_card" ? (
                                  <Loader2 className="w-5 h-5 animate-spin mx-auto text-primary" />
                                ) : (
                                  <>
                                    <Upload className="w-5 h-5 mx-auto text-muted-foreground/40 mb-1" />
                                    <p className="text-xs text-muted-foreground">클릭하여 업로드</p>
                                  </>
                                )}
                              </div>
                            </label>
                          )}
                        </div>
                        {/* 통장사본 */}
                        <div className="p-4 rounded-2xl border border-border/50 bg-muted/30">
                          <Label className="text-xs font-semibold mb-2 block">통장 사본</Label>
                          {detailForm.bankbook_url ? (
                            <div className="flex items-center gap-3">
                              <a href={detailForm.bankbook_url} target="_blank" rel="noopener noreferrer"
                                className="text-sm text-primary hover:underline flex items-center gap-1">
                                <ExternalLink className="w-3.5 h-3.5" /> 등록된 파일 보기
                              </a>
                              <label className="cursor-pointer">
                                <input type="file" accept="image/*,application/pdf" className="hidden"
                                  onChange={(e) => handleDocUpload(e, "bankbook")} disabled={!!uploadingDoc} />
                                <Button variant="ghost" size="sm" asChild className="h-7 text-xs">
                                  <span>{uploadingDoc === "bankbook" ? <Loader2 className="w-3 h-3 animate-spin" /> : "변경"}</span>
                                </Button>
                              </label>
                            </div>
                          ) : (
                            <label className="cursor-pointer block">
                              <input type="file" accept="image/*,application/pdf" className="hidden"
                                onChange={(e) => handleDocUpload(e, "bankbook")} disabled={!!uploadingDoc} />
                              <div className="border-2 border-dashed border-border rounded-xl p-4 text-center hover:border-primary/40 transition-colors">
                                {uploadingDoc === "bankbook" ? (
                                  <Loader2 className="w-5 h-5 animate-spin mx-auto text-primary" />
                                ) : (
                                  <>
                                    <Upload className="w-5 h-5 mx-auto text-muted-foreground/40 mb-1" />
                                    <p className="text-xs text-muted-foreground">클릭하여 업로드</p>
                                  </>
                                )}
                              </div>
                            </label>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* 비상연락처 */}
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <h3 className="text-sm font-bold text-foreground flex items-center gap-2">
                          <Heart className="w-4 h-4 text-primary" /> 비상 연락처
                        </h3>
                        <Button type="button" variant="outline" size="sm" className="rounded-full h-8 text-xs px-4"
                          onClick={() => setEditContacts([...editContacts, { relation: "", name: "", phone: "" }])}>
                          <Plus className="w-3.5 h-3.5 mr-1" /> 추가
                        </Button>
                      </div>
                      <div className="space-y-2 p-4 rounded-2xl bg-muted/30 border border-border/50">
                        {editContacts.map((c, i) => (
                          <div key={i} className="flex gap-2 items-center">
                            <Input placeholder="관계 (예: 부)" className="w-24 rounded-xl" value={c.relation} onChange={e => {
                              const arr = [...editContacts]; arr[i] = {...arr[i], relation: e.target.value}; setEditContacts(arr);
                            }} />
                            <Input placeholder="성함" className="w-28 rounded-xl" value={c.name} onChange={e => {
                              const arr = [...editContacts]; arr[i] = {...arr[i], name: e.target.value}; setEditContacts(arr);
                            }} />
                            <Input placeholder="연락처" className="flex-1 rounded-xl" value={c.phone} onChange={e => {
                              const arr = [...editContacts]; arr[i] = {...arr[i], phone: e.target.value}; setEditContacts(arr);
                            }} />
                            <Button variant="ghost" size="icon" className="w-8 h-8 shrink-0 text-destructive hover:text-destructive"
                              onClick={() => setEditContacts(editContacts.filter((_, idx) => idx !== i))}>
                              <Trash2 className="w-3.5 h-3.5" />
                            </Button>
                          </div>
                        ))}
                        {editContacts.length === 0 && (
                          <p className="text-xs text-muted-foreground text-center py-3">"추가" 버튼으로 비상 연락처를 등록하세요.</p>
                        )}
                      </div>
                    </div>

                    {/* 저장/취소 */}
                    <div className="flex justify-end gap-3 pt-2">
                      <Button variant="ghost" onClick={cancelEditDetail} className="rounded-full px-6">취소</Button>
                      <Button onClick={saveDetail} disabled={savingDetail} className="rounded-full px-8">
                        {savingDetail ? <Loader2 className="w-4 h-4 animate-spin mr-1.5" /> : <Save className="w-4 h-4 mr-1.5" />}
                        저장
                      </Button>
                    </div>
                  </div>
                ) : !employeeDetail ? (
                  /* ─── 미등록 상태 ─── */
                  <div className="py-12 text-center">
                    <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
                      <ClipboardList className="w-8 h-8 text-primary/50" />
                    </div>
                    <p className="text-foreground font-medium mb-1">아직 인사 정보가 등록되지 않았습니다</p>
                    <p className="text-xs text-muted-foreground mb-5">
                      "정보 등록" 버튼을 눌러 인사 카드를 작성하세요.
                    </p>
                    <Button onClick={startEditDetail} className="rounded-full px-6">
                      <Plus className="w-4 h-4 mr-1.5" /> 정보 등록하기
                    </Button>
                  </div>
                ) : (
                  /* ─── 조회 모드 ─── */
                  <div className="space-y-6">
                    <div>
                      <p className="text-xs font-bold text-muted-foreground mb-2 flex items-center gap-1.5">
                        <User className="w-3.5 h-3.5" /> 기본 정보
                      </p>
                      <div className="bg-muted/30 rounded-2xl p-5 border border-border/30">
                        <InfoRow label="입사일" value={employeeDetail.hire_date} />
                        <InfoRow label="퇴사일" value={employeeDetail.resignation_date} />
                        <InfoRow label="구분" value={employeeDetail.is_foreigner} />
                        <InfoRow label="국적" value={employeeDetail.nationality} />
                      </div>
                    </div>

                    <div>
                      <p className="text-xs font-bold text-muted-foreground mb-2 flex items-center gap-1.5">
                        <Phone className="w-3.5 h-3.5" /> 연락처 & 주소
                      </p>
                      <div className="bg-muted/30 rounded-2xl p-5 border border-border/30">
                        <InfoRow label="주민등록번호" value={maskResident(employeeDetail.resident_number)} />
                        <InfoRow label="주소" value={employeeDetail.address} />
                        <InfoRow label="휴대폰" value={employeeDetail.phone_mobile} />
                        <InfoRow label="유선전화" value={employeeDetail.phone_tel} />
                        <InfoRow label="이메일" value={employeeDetail.email} />
                      </div>
                    </div>

                    <div>
                      <p className="text-xs font-bold text-muted-foreground mb-2 flex items-center gap-1.5">
                        <CreditCard className="w-3.5 h-3.5" /> 급여 계좌
                      </p>
                      <div className="bg-muted/30 rounded-2xl p-5 border border-border/30">
                        <InfoRow label="은행" value={employeeDetail.bank_name} />
                        <InfoRow label="계좌번호" value={employeeDetail.account_number} />
                        <InfoRow label="예금주" value={employeeDetail.account_holder} />
                      </div>
                    </div>

                    {/* 비상연락처 */}
                    <div>
                      <p className="text-xs font-bold text-muted-foreground mb-2 flex items-center gap-1.5">
                        <Heart className="w-3.5 h-3.5" /> 비상 연락처
                      </p>
                      {Array.isArray(employeeDetail.emergency_contacts) && employeeDetail.emergency_contacts.length > 0 ? (
                        <div className="bg-muted/30 rounded-2xl p-5 border border-border/30 space-y-2">
                          {employeeDetail.emergency_contacts.map((c: any, i: number) => (
                            <div key={i} className="flex gap-4 text-sm py-1.5 border-b border-border/50 last:border-0">
                              <span className="text-muted-foreground w-16">{c.relation || "-"}</span>
                              <span className="font-medium">{c.name || "-"}</span>
                              <span className="text-muted-foreground">{c.phone || "-"}</span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="bg-muted/30 rounded-2xl p-5 border border-border/30 text-center">
                          <p className="text-xs text-muted-foreground">등록된 비상 연락처가 없습니다.</p>
                        </div>
                      )}
                    </div>

                    {/* 증빙서류 링크 */}
                    {(employeeDetail.id_card_url || employeeDetail.bankbook_url) && (
                      <div>
                        <p className="text-xs font-bold text-muted-foreground mb-2 flex items-center gap-1.5">
                          <FileText className="w-3.5 h-3.5" /> 증빙 서류
                        </p>
                        <div className="flex flex-wrap gap-3">
                          {employeeDetail.id_card_url && (
                            <a href={employeeDetail.id_card_url} target="_blank" rel="noopener noreferrer"
                              className="flex items-center gap-1.5 text-sm text-primary hover:underline bg-primary/5 px-4 py-2 rounded-full">
                              <ExternalLink className="w-3.5 h-3.5" /> 신분증 사본
                            </a>
                          )}
                          {employeeDetail.bankbook_url && (
                            <a href={employeeDetail.bankbook_url} target="_blank" rel="noopener noreferrer"
                              className="flex items-center gap-1.5 text-sm text-primary hover:underline bg-primary/5 px-4 py-2 rounded-full">
                              <ExternalLink className="w-3.5 h-3.5" /> 통장 사본
                            </a>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 인사 기록 탭 */}
          <TabsContent value="hr">
            <Card className="border-none shadow-lg rounded-2xl">
              <CardContent className="p-0">
                {loading ? (
                  <div className="p-8 text-center text-muted-foreground">불러오는 중...</div>
                ) : hrRecords.length === 0 ? (
                  <div className="p-8 text-center text-muted-foreground">등록된 인사 기록이 없습니다.</div>
                ) : (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead className="w-24">유형</TableHead>
                        <TableHead>제목</TableHead>
                        <TableHead className="w-28">시행일</TableHead>
                        <TableHead className="hidden md:table-cell">변경 내용</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {hrRecords.map((r) => (
                        <TableRow key={r.id}>
                          <TableCell>
                            <Badge variant="outline" className="text-xs">
                              {recordTypeLabel[r.record_type] || r.record_type}
                            </Badge>
                          </TableCell>
                          <TableCell className="font-medium">{r.title}</TableCell>
                          <TableCell className="text-sm text-muted-foreground">{r.effective_date}</TableCell>
                          <TableCell className="hidden md:table-cell text-sm text-muted-foreground">
                            {r.old_department && r.new_department && `${r.old_department} → ${r.new_department}`}
                            {r.old_job_title && r.new_job_title && ` | ${r.old_job_title} → ${r.new_job_title}`}
                            {r.description && !r.old_department && !r.old_job_title && r.description}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 법인카드 탭 */}
          <TabsContent value="cards">
            <Card className="border-none shadow-lg rounded-2xl">
              <CardContent className="p-6">
                {loading ? (
                  <div className="text-center text-muted-foreground">불러오는 중...</div>
                ) : cards.length === 0 ? (
                  <div className="text-center text-muted-foreground">부여된 법인카드가 없습니다.</div>
                ) : (
                  <div className="grid gap-4 sm:grid-cols-2">
                    {cards.map((card) => (
                      <div
                        key={card.id}
                        className="relative p-5 rounded-xl bg-gradient-to-br from-foreground/90 to-foreground text-background overflow-hidden"
                      >
                        <div className="absolute top-3 right-4 text-xs opacity-60">
                          {card.is_active ? "사용중" : "비활성"}
                        </div>
                        <p className="text-xs opacity-60 mb-1">{card.card_company || "카드사"}</p>
                        <p className="font-mono text-lg tracking-widest mb-3">
                          {maskCardNumber(card.card_number)}
                        </p>
                        <div className="flex justify-between text-xs opacity-70">
                          <span>{card.card_name || "법인카드"}</span>
                          {card.expiry_date && <span>만료: {card.expiry_date}</span>}
                        </div>
                        {card.monthly_limit && (
                          <p className="text-xs opacity-50 mt-2">
                            월 한도: ₩{card.monthly_limit.toLocaleString()}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 결제라인 탭 */}
          <TabsContent value="approval">
            <Card className="border-none shadow-lg rounded-2xl">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="text-base">나의 결제라인</CardTitle>
                  <div className="flex items-center gap-2">
                    <Button variant="outline" size="sm" onClick={addApprovalStep}>
                      <Plus className="w-4 h-4 mr-1" /> 단계 추가
                    </Button>
                    <Button size="sm" onClick={saveApprovalLines} disabled={savingApproval}>
                      {savingApproval ? "저장 중..." : "저장"}
                    </Button>
                  </div>
                </div>
                <p className="text-xs text-muted-foreground">
                  전자결재 시 사용할 결제라인을 설정하세요. 순서대로 결재가 진행됩니다.
                </p>
              </CardHeader>
              <CardContent>
                {approvalLines.length === 0 ? (
                  <div className="py-8 text-center text-muted-foreground">
                    <GitBranch className="w-10 h-10 mx-auto mb-3 opacity-30" />
                    <p>등록된 결제라인이 없습니다.</p>
                    <p className="text-xs mt-1">"단계 추가" 버튼으로 결재자를 추가하세요.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {approvalLines.map((line, index) => (
                      <div
                        key={line.id}
                        className="flex items-center gap-3 p-3 rounded-lg border border-border bg-muted/30"
                      >
                        <div className="flex flex-col items-center gap-0.5">
                          <button onClick={() => moveStep(index, "up")} disabled={index === 0}
                            className="p-0.5 hover:bg-muted rounded disabled:opacity-20">
                            <ChevronUp className="w-3.5 h-3.5" />
                          </button>
                          <span className="text-xs font-bold text-primary w-5 text-center">{line.step_order}</span>
                          <button onClick={() => moveStep(index, "down")} disabled={index === approvalLines.length - 1}
                            className="p-0.5 hover:bg-muted rounded disabled:opacity-20">
                            <ChevronDown className="w-3.5 h-3.5" />
                          </button>
                        </div>
                        <div className="flex-1">
                          <Select value={line.approver_user_id} onValueChange={(val) => updateApprover(index, val)}>
                            <SelectTrigger className="h-9"><SelectValue placeholder="결재자 선택" /></SelectTrigger>
                            <SelectContent>
                              {tenantMembers.filter((m) => m.user_id !== user?.id).map((m) => (
                                <SelectItem key={m.user_id} value={m.user_id}>
                                  {m.full_name} {m.job_title ? `(${m.job_title})` : ""} {m.department ? `- ${m.department}` : ""}
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                        {line.approver_name && (
                          <div className="hidden sm:block text-xs text-muted-foreground min-w-[80px]">
                            {line.approver_job_title || ""}
                          </div>
                        )}
                        <Button variant="ghost" size="icon" className="w-8 h-8 text-destructive hover:text-destructive"
                          onClick={() => removeApprovalStep(index)}>
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    ))}
                    <div className="mt-4 p-4 rounded-lg bg-primary/5 border border-primary/10">
                      <p className="text-xs font-semibold text-primary mb-2">결재 흐름 미리보기</p>
                      <div className="flex items-center gap-2 flex-wrap text-sm">
                        <Badge variant="outline" className="text-xs">기안자 (나)</Badge>
                        {approvalLines.filter((a) => a.approver_name).map((a) => (
                          <span key={a.id} className="flex items-center gap-2">
                            <span className="text-primary">→</span>
                            <Badge variant="secondary" className="text-xs">{a.step_order}차 {a.approver_name}</Badge>
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 서명 관리 탭 */}
          <TabsContent value="signature">
            <Card className="border-none shadow-lg rounded-2xl">
              <CardHeader>
                <CardTitle className="text-base">내 서명</CardTitle>
                <p className="text-xs text-muted-foreground">
                  전자결재 및 위임장에 사용할 서명을 등록하세요.
                </p>
              </CardHeader>
              <CardContent>
                {signatureMode === "view" && (
                  <div className="space-y-4">
                    {signatureUrl ? (
                      <div className="border border-border rounded-xl p-6 bg-muted/20 flex flex-col items-center gap-4">
                        <img src={signatureUrl} alt="내 서명" className="max-h-32 object-contain" />
                        <div className="flex gap-2">
                          <Button variant="outline" size="sm" onClick={() => setSignatureMode("draw")}>
                            <PenTool className="w-4 h-4 mr-1" /> 다시 그리기
                          </Button>
                          <Button variant="outline" size="sm" onClick={() => setSignatureMode("upload")}>
                            <Upload className="w-4 h-4 mr-1" /> 이미지 변경
                          </Button>
                          <Button variant="ghost" size="sm" className="text-destructive" onClick={deleteSignature}>
                            <Trash2 className="w-4 h-4 mr-1" /> 삭제
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <div className="border-2 border-dashed border-border rounded-xl p-10 text-center">
                        <PenTool className="w-12 h-12 mx-auto mb-3 text-muted-foreground/30" />
                        <p className="text-muted-foreground mb-4">등록된 서명이 없습니다.</p>
                        <div className="flex justify-center gap-2">
                          <Button variant="outline" onClick={() => setSignatureMode("draw")}>
                            <PenTool className="w-4 h-4 mr-1" /> 직접 그리기
                          </Button>
                          <Button variant="outline" onClick={() => setSignatureMode("upload")}>
                            <Upload className="w-4 h-4 mr-1" /> 이미지 업로드
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {signatureMode === "draw" && (
                  <div className="space-y-4">
                    <div className="border border-border rounded-xl overflow-hidden bg-background">
                      <canvas
                        ref={canvasRef}
                        className="w-full h-48 cursor-crosshair touch-none"
                        onMouseDown={startDraw}
                        onMouseMove={draw}
                        onMouseUp={endDraw}
                        onMouseLeave={endDraw}
                        onTouchStart={startDraw}
                        onTouchMove={draw}
                        onTouchEnd={endDraw}
                      />
                    </div>
                    <p className="text-xs text-muted-foreground text-center">
                      마우스 또는 터치로 서명을 그려주세요.
                    </p>
                    <div className="flex justify-center gap-2">
                      <Button variant="ghost" onClick={() => { setSignatureMode("view"); setHasDrawn(false); }}>
                        <X className="w-4 h-4 mr-1" /> 취소
                      </Button>
                      <Button variant="outline" onClick={clearCanvas}>지우기</Button>
                      <Button onClick={saveSignatureFromCanvas} disabled={!hasDrawn || uploadingSignature}>
                        {uploadingSignature ? "저장 중..." : "서명 저장"}
                      </Button>
                    </div>
                  </div>
                )}

                {signatureMode === "upload" && (
                  <div className="space-y-4">
                    <div className="border-2 border-dashed border-primary/30 rounded-xl p-10 text-center">
                      <Upload className="w-10 h-10 mx-auto mb-3 text-primary/40" />
                      <p className="text-sm text-muted-foreground mb-3">
                        서명 이미지를 업로드하세요 (PNG, JPG / 최대 2MB)
                      </p>
                      <label>
                        <input
                          type="file"
                          accept="image/png,image/jpeg,image/webp"
                          className="hidden"
                          onChange={handleSignatureUpload}
                          disabled={uploadingSignature}
                        />
                        <Button variant="outline" asChild disabled={uploadingSignature}>
                          <span>{uploadingSignature ? "업로드 중..." : "파일 선택"}</span>
                        </Button>
                      </label>
                    </div>
                    <div className="flex justify-center">
                      <Button variant="ghost" onClick={() => setSignatureMode("view")}>
                        <X className="w-4 h-4 mr-1" /> 취소
                      </Button>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 차량 관리 탭 */}
          <TabsContent value="vehicle">
            {user && currentTenant && (
              <MyVehicleTab userId={user.id} tenantId={currentTenant.tenant_id} />
            )}
          </TabsContent>

          {/* 메일 연동 탭 */}
          <TabsContent value="mail">
            {user && currentTenant && (
              <MailIntegrationTab userId={user.id} tenantId={currentTenant.tenant_id} />
            )}
          </TabsContent>
        </Tabs>
      </main>
    </div>
  );
};

export default MyPage;



============================================================
File Path: src/pages/NotFound.tsx
============================================================
import { useLocation } from "react-router-dom";
import { useEffect } from "react";

const NotFound = () => {
  const location = useLocation();

  useEffect(() => {
    console.error("404 Error: User attempted to access non-existent route:", location.pathname);
  }, [location.pathname]);

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted">
      <div className="text-center">
        <h1 className="mb-4 text-4xl font-bold">404</h1>
        <p className="mb-4 text-xl text-muted-foreground">Oops! Page not found</p>
        <a href="/" className="text-primary underline hover:text-primary/90">
          Return to Home
        </a>
      </div>
    </div>
  );
};

export default NotFound;



============================================================
File Path: src/pages/Onboarding.tsx
============================================================
import { useState, useRef, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { 
  Briefcase, ShieldCheck, Landmark, UploadCloud, Heart, 
  CheckCircle2, Loader2, Sparkles, Smartphone, MapPin, Globe, Mail, Hash, CreditCard,
  FileImage, SmartphoneIcon, UserCheck, Plus, Trash2
} from "lucide-react";
import { toast } from "sonner";
import { Separator } from "@/components/ui/separator";
import { ScrollArea } from "@/components/ui/scroll-area";
import { sendFileToTelegram } from "@/lib/telegramApi";
import { generateOnboardingPdf } from "@/lib/generateOnboardingPdf";

interface DeptOption { id: string; name: string; }
interface JobOption { id: string; name: string; }

const Onboarding = () => {
  const { user, profile, currentTenant, signOut } = useAuth();
  const [loading, setLoading] = useState(false);
  const idCardRef = useRef<HTMLInputElement>(null);
  const bankbookRef = useRef<HTMLInputElement>(null);

  const [departments, setDepartments] = useState<DeptOption[]>([]);
  const [jobTitles, setJobTitles] = useState<JobOption[]>([]);

  const [formData, setFormData] = useState({
    hire_date: "", resignation_date: "", department: "", job_title: "",
    resident_number: "", is_foreigner: "내국인", nationality: "대한민국", address: "",
    phone_mobile: "", phone_tel: "", email: profile?.email || "",
    bank_name: "", account_number: "", account_holder: profile?.full_name || "",
  });

  const [emergencyContacts, setEmergencyContacts] = useState([{ relation: "", name: "", phone: "" }]);
  const [bankType, setBankType] = useState<string>("");
  const [manualBankName, setManualBankName] = useState<string>("");
  const [idCardFile, setIdCardFile] = useState<File | null>(null);
  const [bankbookFile, setBankbookFile] = useState<File | null>(null);

  // 부서 및 직급 동적 로드
  useEffect(() => {
    const fetchOrgData = async () => {
      if (!currentTenant?.tenant_id) return;
      const [deptRes, jobRes] = await Promise.all([
        supabase.from("departments").select("id, name").eq("tenant_id", currentTenant.tenant_id).eq("is_active", true).order("sort_order"),
        supabase.from("job_titles").select("id, name").eq("tenant_id", currentTenant.tenant_id).eq("is_active", true).order("level"),
      ]);
      if (deptRes.data) setDepartments(deptRes.data);
      if (jobRes.data) {
        setJobTitles(jobRes.data);
        if (jobRes.data.length > 0 && !formData.job_title) {
          setFormData(prev => ({ ...prev, job_title: jobRes.data[0].name }));
        }
      }
    };
    fetchOrgData();
  }, [currentTenant?.tenant_id]);

  const addContact = () => setEmergencyContacts([...emergencyContacts, { relation: "", name: "", phone: "" }]);
  const removeContact = (index: number) => {
    if (emergencyContacts.length > 1) setEmergencyContacts(emergencyContacts.filter((_, i) => i !== index));
  };
  const updateContact = (index: number, field: string, value: string) => {
    const newContacts = [...emergencyContacts];
    newContacts[index] = { ...newContacts[index], [field]: value };
    setEmergencyContacts(newContacts);
  };

  // 파일을 Supabase Storage에 업로드
  const uploadToStorage = async (file: File, subfolder: string): Promise<string | null> => {
    if (!user || !currentTenant) return null;
    try {
      const ext = file.name.split(".").pop() || "file";
      const filePath = `${currentTenant.tenant_id}/onboarding/${user.id}/${subfolder}/${Date.now()}.${ext}`;
      const { error } = await supabase.storage
        .from("artist-assets")
        .upload(filePath, file, { upsert: true, contentType: file.type });
      if (error) throw error;
      const { data: signedData, error: signedError } = await supabase.storage
        .from("artist-assets")
        .createSignedUrl(filePath, 60 * 60 * 24 * 365); // 1 year for onboarding docs
      if (signedError) throw signedError;
      return signedData.signedUrl;
    } catch (err) {
      console.error(`Storage upload failed (${subfolder}):`, err);
      return null;
    }
  };

  // --- 저장 및 업로드 핵심 로직 ---
  const handleSave = async () => {
    if (!formData.hire_date || !formData.department || !formData.resident_number || !formData.address || !formData.account_number) {
      toast.error("필수 항목(*)을 모두 입력해주세요.");
      return;
    }

    setLoading(true);
    try {
      const tenantId = currentTenant?.tenant_id;
      if (!tenantId || !user) throw new Error("회사 정보를 찾을 수 없습니다.");

      const finalBankName = bankType === "manual" ? manualBankName : bankType;

      // 1. 파일 업로드 (Supabase Storage - 항상 동작)
      let idCardUrl: string | null = null;
      let bankbookUrl: string | null = null;

      if (idCardFile) {
        idCardUrl = await uploadToStorage(idCardFile, "id-card");
        if (!idCardUrl) toast.warning("신분증 파일 저장에 실패했습니다.");
      }

      if (bankbookFile) {
        bankbookUrl = await uploadToStorage(bankbookFile, "bankbook");
        if (!bankbookUrl) toast.warning("통장사본 파일 저장에 실패했습니다.");
      }

      // 2. 텔레그램 봇으로 파일 백업 (설정된 경우에만, 실패해도 진행)
      if (idCardFile) {
        sendFileToTelegram(tenantId, idCardFile, `🪪 신분증 - ${profile?.full_name || user.email}`).catch(() => {});
      }
      if (bankbookFile) {
        sendFileToTelegram(tenantId, bankbookFile, `🏦 통장사본 - ${profile?.full_name || user.email}`).catch(() => {});
      }

      // 3. employee_details에 모든 개인정보 저장 (upsert)
      const { error: detailError } = await supabase
        .from("employee_details")
        .upsert({
          user_id: user.id,
          tenant_id: tenantId,
          hire_date: formData.hire_date || null,
          resignation_date: formData.resignation_date || null,
          resident_number: formData.resident_number,
          is_foreigner: formData.is_foreigner,
          nationality: formData.nationality,
          address: formData.address,
          phone_mobile: formData.phone_mobile,
          phone_tel: formData.phone_tel,
          email: formData.email,
          bank_name: finalBankName,
          account_number: formData.account_number,
          account_holder: formData.account_holder,
          emergency_contacts: emergencyContacts.filter(c => c.name || c.phone),
          id_card_url: idCardUrl,
          bankbook_url: bankbookUrl,
        }, { onConflict: "user_id,tenant_id" });

      if (detailError) {
        console.error("employee_details save error:", detailError);
        throw detailError;
      }

      // 4. tenant_memberships 업데이트 (부서, 직급) - SECURITY DEFINER 함수 사용
      const { error: memberError } = await supabase.rpc("complete_onboarding", {
        _tenant_id: tenantId,
        _department: formData.department,
        _job_title: formData.job_title,
      });

      if (memberError) throw memberError;

      // 5. profiles에 전화번호 업데이트
      if (formData.phone_mobile) {
        await supabase.from("profiles").update({ phone: formData.phone_mobile }).eq("id", user.id);
      }

      // 6. PDF 생성 후 텔레그램으로 전송
      try {
        const pdfFile = await generateOnboardingPdf({
          fullName: profile?.full_name || user.email || "",
          email: formData.email,
          tenantName: currentTenant?.tenant?.name || "",
          hire_date: formData.hire_date,
          resignation_date: formData.resignation_date,
          department: formData.department,
          job_title: formData.job_title,
          resident_number: formData.resident_number,
          is_foreigner: formData.is_foreigner,
          nationality: formData.nationality,
          address: formData.address,
          phone_mobile: formData.phone_mobile,
          phone_tel: formData.phone_tel,
          bank_name: finalBankName,
          account_number: formData.account_number,
          account_holder: formData.account_holder,
          emergency_contacts: emergencyContacts.filter(c => c.name || c.phone),
        });
        sendFileToTelegram(
          tenantId,
          pdfFile,
          `📋 인사정보 등록서 - ${profile?.full_name || user.email}\n🏢 ${currentTenant?.tenant?.name}\n📅 ${new Date().toISOString().split("T")[0]}`
        ).catch(() => {});
      } catch (pdfErr) {
        console.error("PDF generation error:", pdfErr);
      }

      toast.success("인사 정보 및 증빙 서류 등록이 완료되었습니다!");
      
      // 대시보드로 이동 (전체 페이지 리로드로 auth 상태 갱신)
      setTimeout(() => {
        window.location.replace("/dashboard");
      }, 800);

    } catch (error: any) {
      console.error("Onboarding Error:", error);
      toast.error("정보 저장 중 오류가 발생했습니다.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans antialiased text-slate-900">
      <div className="w-full max-w-4xl bg-white rounded-[1.5rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1)] overflow-hidden flex flex-col h-[90vh]">
        
        {/* 헤더 섹션 */}
        <div className="p-7 bg-[#0F172A] text-white shrink-0 relative">
          <div className="relative z-10 flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2 text-blue-400 font-bold text-[11px] tracking-widest uppercase mb-1">
                <Sparkles className="w-3 h-3" /> Step 1. Onboarding
              </div>
              <h1 className="text-2xl font-black tracking-tight">
                정보 등록 <span className="text-blue-400">시작하기</span>
              </h1>
            </div>
            <div className="w-12 h-12 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center">
              <UserCheck className="w-6 h-6 text-blue-400" />
            </div>
          </div>
        </div>

        <ScrollArea className="flex-1 px-8 py-6 text-slate-800">
          <div className="max-w-3xl mx-auto space-y-10">
            
            {/* 01. 인사 정보 */}
            <section className="space-y-4">
              <div className="space-y-0.5 border-l-4 border-blue-600 pl-3">
                <h4 className="text-lg font-bold">소속 및 직무</h4>
                <p className="text-[13px] text-slate-500 font-medium">회사 내에서의 역할과 입사일을 지정합니다.</p>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">입사일자 *</Label>
                  <Input type="date" className="h-10 rounded-lg" value={formData.hire_date} onChange={e => setFormData({...formData, hire_date: e.target.value})} />
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">퇴사일자</Label>
                  <Input type="date" className="h-10 rounded-lg" value={formData.resignation_date} onChange={e => setFormData({...formData, resignation_date: e.target.value})} />
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">부서 *</Label>
                  <Select value={formData.department} onValueChange={val => setFormData({...formData, department: val})}>
                    <SelectTrigger className="h-10 rounded-lg"><SelectValue placeholder="부서 선택" /></SelectTrigger>
                    <SelectContent>
                      {departments.length > 0 ? (
                        departments.map(d => <SelectItem key={d.id} value={d.name}>{d.name}</SelectItem>)
                      ) : (
                        <SelectItem value="__none" disabled>등록된 부서가 없습니다</SelectItem>
                      )}
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">직급 *</Label>
                  <Select value={formData.job_title} onValueChange={val => setFormData({...formData, job_title: val})}>
                    <SelectTrigger className="h-10 rounded-lg"><SelectValue placeholder="직급 선택" /></SelectTrigger>
                    <SelectContent>
                      {jobTitles.length > 0 ? (
                        jobTitles.map(j => <SelectItem key={j.id} value={j.name}>{j.name}</SelectItem>)
                      ) : (
                        <SelectItem value="__none" disabled>등록된 직급이 없습니다</SelectItem>
                      )}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </section>

            <Separator className="bg-slate-100" />

            {/* 02. 개인 정보 */}
            <section className="space-y-5">
              <div className="space-y-0.5 border-l-4 border-blue-600 pl-3">
                <h4 className="text-lg font-bold">인적 사항</h4>
                <p className="text-[13px] text-slate-500 font-medium">급여 신고 및 본인 확인을 위한 정보입니다.</p>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">주민등록번호 *</Label>
                  <Input type="password" placeholder="000000-0000000" className="h-10 rounded-lg" value={formData.resident_number} onChange={e => setFormData({...formData, resident_number: e.target.value})} />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1">
                    <Label className="text-[12px] font-bold text-slate-600">구분 *</Label>
                    <Select value={formData.is_foreigner} onValueChange={val => setFormData({...formData, is_foreigner: val})}>
                      <SelectTrigger className="h-10 rounded-lg"><SelectValue /></SelectTrigger>
                      <SelectContent><SelectItem value="내국인">내국인</SelectItem><SelectItem value="외국인">외국인</SelectItem></SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[12px] font-bold text-slate-600">국적 *</Label>
                    <Input className="h-10 rounded-lg" value={formData.nationality} onChange={e => setFormData({...formData, nationality: e.target.value})} />
                  </div>
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">휴대폰번호 *</Label>
                  <Input placeholder="010-0000-0000" className="h-10 rounded-lg" value={formData.phone_mobile} onChange={e => setFormData({...formData, phone_mobile: e.target.value})} />
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">이메일 *</Label>
                  <Input className="h-10 rounded-lg" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                </div>
                <div className="space-y-1 md:col-span-2">
                  <Label className="text-[12px] font-bold text-slate-600">현재 거주지 주소 *</Label>
                  <Input placeholder="상세 주소를 정확히 입력하세요" className="h-10 rounded-lg" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} />
                </div>
              </div>

              {/* 비상연락처 리스트 */}
              <div className="p-5 rounded-2xl bg-slate-50 border border-slate-100 space-y-4">
                <div className="flex items-center justify-between">
                  <Label className="text-[13px] font-extrabold flex items-center gap-2 text-rose-600">
                    <Heart className="w-3.5 h-3.5 fill-rose-600" /> 비상 연락처 (가족)
                  </Label>
                  <Button type="button" variant="outline" size="sm" onClick={addContact} className="h-7 text-[11px] px-2 rounded-md border-blue-200 text-blue-600">
                    + 추가하기
                  </Button>
                </div>
                <div className="space-y-2">
                  {emergencyContacts.map((contact, index) => (
                    <div key={index} className="flex gap-2 animate-in fade-in slide-in-from-top-1">
                      <Input placeholder="관계" className="h-9 rounded-lg bg-white w-20 text-sm" value={contact.relation} onChange={(e) => updateContact(index, "relation", e.target.value)} />
                      <Input placeholder="성함" className="h-9 rounded-lg bg-white w-24 text-sm" value={contact.name} onChange={(e) => updateContact(index, "name", e.target.value)} />
                      <Input placeholder="연락처" className="h-9 rounded-lg bg-white flex-1 text-sm" value={contact.phone} onChange={(e) => updateContact(index, "phone", e.target.value)} />
                      <Button type="button" variant="ghost" size="icon" onClick={() => removeContact(index)} className="h-9 w-9 text-slate-300 hover:text-rose-500"><Trash2 className="w-4 h-4" /></Button>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            <Separator className="bg-slate-100" />

            {/* 03. 계좌 정보 */}
            <section className="space-y-4">
              <div className="space-y-0.5 border-l-4 border-blue-600 pl-3">
                <h4 className="text-lg font-bold">급여 계좌</h4>
                <p className="text-[13px] text-slate-500 font-medium">급여가 정산될 본인 명의의 계좌입니다.</p>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">입금 은행 *</Label>
                  <Select value={bankType} onValueChange={setBankType}>
                    <SelectTrigger className="h-10 rounded-lg text-sm"><SelectValue placeholder="은행 선택" /></SelectTrigger>
                    <SelectContent>
                      {["국민은행", "신한은행", "우리은행", "하나은행", "manual"].map(b => (
                        <SelectItem key={b} value={b}>{b === "manual" ? "직접 입력" : b}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  {bankType === "manual" && <Input placeholder="은행명 입력" className="h-9 rounded-lg mt-1 text-sm" value={manualBankName} onChange={e => setManualBankName(e.target.value)} />}
                </div>
                <div className="space-y-1">
                  <Label className="text-[12px] font-bold text-slate-600">예금주 *</Label>
                  <Input className="h-10 rounded-lg bg-slate-50 font-bold" value={formData.account_holder} readOnly />
                </div>
                <div className="space-y-1 md:col-span-2">
                  <Label className="text-[12px] font-bold text-slate-600">계좌번호 *</Label>
                  <Input placeholder="숫자만 입력" className="h-10 rounded-lg tabular-nums" value={formData.account_number} onChange={e => setFormData({...formData, account_number: e.target.value})} />
                </div>
              </div>
            </section>

            <Separator className="bg-slate-100" />

            {/* 04. 서류 업로드 */}
            <section className="space-y-4 pb-6">
              <div className="space-y-0.5 border-l-4 border-blue-600 pl-3">
                <h4 className="text-lg font-bold">증빙 서류</h4>
                <p className="text-[13px] text-slate-500 font-medium">보안 폴더에 안전하게 보관됩니다.</p>
              </div>
              <div className="grid grid-cols-2 gap-4">
                {[ { label: "신분증 사본", ref: idCardRef, file: idCardFile, set: setIdCardFile, Icon: SmartphoneIcon },
                   { label: "통장 사본", ref: bankbookRef, file: bankbookFile, set: setBankbookFile, Icon: FileImage }
                ].map((item, idx) => (
                  <div key={idx} onClick={() => item.ref.current?.click()} className={`p-6 border-2 border-dashed rounded-2xl text-center hover:bg-blue-50/50 transition-all cursor-pointer ${item.file ? 'border-green-500 bg-green-50/30' : 'border-slate-200'}`}>
                    <input type="file" ref={item.ref} className="hidden" onChange={e => item.set(e.target.files?.[0] || null)} />
                    {item.file ? (
                      <div className="text-green-600 font-bold animate-in zoom-in-95">
                        <CheckCircle2 className="w-8 h-8 mx-auto mb-1" />
                        <p className="text-[11px] truncate">{item.file.name}</p>
                      </div>
                    ) : (
                      <div className="text-slate-400 group-hover:text-blue-500 transition-colors">
                        <item.Icon className="w-8 h-8 mx-auto mb-2" />
                        <p className="text-sm font-bold text-slate-700">{item.label}</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </section>
          </div>
        </ScrollArea>

        {/* 하단 바 */}
        <div className="px-8 py-5 border-t bg-white flex items-center justify-between shrink-0">
          <Button variant="ghost" className="text-slate-400 text-sm font-bold" onClick={signOut}>나중에 등록</Button>
          <Button variant="hero" size="lg" className="px-12 text-md font-black rounded-xl shadow-lg min-w-[160px]" onClick={handleSave} disabled={loading}>
            {loading ? (
              <div className="flex items-center gap-2">
                <Loader2 className="w-5 h-5 animate-spin" />
                <span>처리 중...</span>
              </div>
            ) : "정보 등록 완료"}
          </Button>
        </div>
      </div>
    </div>
  );
};

export default Onboarding;



============================================================
File Path: src/pages/OrgChart.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Network, Search, Users, Phone, Mail, Building2 } from "lucide-react";
import { Loader2 } from "lucide-react";

interface Member {
  user_id: string;
  department: string | null;
  job_title: string | null;
  role: string;
  profile?: {
    full_name: string | null;
    email: string;
    phone: string | null;
    avatar_url: string | null;
  };
}

interface Department {
  id: string;
  name: string;
  parent_id: string | null;
  description: string | null;
}

const OrgChart = () => {
  const { currentTenant } = useAuth();
  const [members, setMembers] = useState<Member[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");

  useEffect(() => {
    if (currentTenant) fetchData();
  }, [currentTenant]);

  const fetchData = async () => {
    if (!currentTenant) return;
    setLoading(true);

    const [memberRes, deptRes] = await Promise.all([
      supabase
        .from("tenant_memberships")
        .select("user_id, department, job_title, role")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("is_suspended", false),
      supabase
        .from("departments")
        .select("id, name, parent_id, description")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("is_active", true)
        .order("sort_order"),
    ]);

    const memberships = memberRes.data || [];
    
    // Fetch profiles for all members
    if (memberships.length > 0) {
      const userIds = memberships.map(m => m.user_id);
      const { data: profiles } = await supabase
        .from("profiles")
        .select("id, full_name, email, phone, avatar_url")
        .in("id", userIds);

      const enriched = memberships.map(m => ({
        ...m,
        profile: profiles?.find(p => p.id === m.user_id) || undefined,
      }));
      setMembers(enriched);
    } else {
      setMembers([]);
    }

    setDepartments(deptRes.data || []);
    setLoading(false);
  };

  // Group members by department
  const groupedMembers = members.reduce<Record<string, Member[]>>((acc, m) => {
    const dept = m.department || "미배정";
    if (!acc[dept]) acc[dept] = [];
    acc[dept].push(m);
    return acc;
  }, {});

  // Filter by search
  const filteredDepts = Object.entries(groupedMembers).filter(([dept, members]) => {
    if (!search) return true;
    const q = search.toLowerCase();
    return dept.toLowerCase().includes(q) || members.some(m =>
      m.profile?.full_name?.toLowerCase().includes(q) ||
      m.profile?.email?.toLowerCase().includes(q) ||
      m.job_title?.toLowerCase().includes(q)
    );
  });

  // Sort: departments with registered names first, "미배정" last
  const sortedDepts = filteredDepts.sort(([a], [b]) => {
    if (a === "미배정") return 1;
    if (b === "미배정") return -1;
    return a.localeCompare(b);
  });

  const getRoleBadge = (role: string) => {
    switch (role) {
      case "company_admin": return <Badge className="bg-blue-100 text-blue-700 border-blue-200">관리자</Badge>;
      case "manager": return <Badge className="bg-amber-100 text-amber-700 border-amber-200">매니저</Badge>;
      default: return null;
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="p-8 md:p-12 max-w-7xl mx-auto animate-in fade-in duration-500">
      {/* Header */}
      <div className="mb-10">
        <div className="flex items-center gap-3 mb-2">
          <div className="p-2 rounded-xl bg-amber-500 text-white">
            <Network className="w-6 h-6" />
          </div>
          <h1 className="text-3xl font-black text-slate-900 tracking-tight">조직도</h1>
        </div>
        <p className="text-slate-500 font-medium ml-12">
          {currentTenant?.tenant.name || "회사"} 부서별 인원 구성 및 연락처를 확인합니다.
        </p>
      </div>

      {/* Search */}
      <div className="relative mb-8 max-w-md">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
        <Input
          placeholder="이름, 부서, 직급으로 검색"
          value={search}
          onChange={e => setSearch(e.target.value)}
          className="pl-9"
        />
      </div>

      {/* Summary */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <Card className="border-none shadow-sm">
          <CardContent className="p-4 flex items-center gap-3">
            <Users className="w-5 h-5 text-blue-500" />
            <div>
              <p className="text-2xl font-bold">{members.length}</p>
              <p className="text-xs text-slate-500">전체 인원</p>
            </div>
          </CardContent>
        </Card>
        <Card className="border-none shadow-sm">
          <CardContent className="p-4 flex items-center gap-3">
            <Building2 className="w-5 h-5 text-emerald-500" />
            <div>
              <p className="text-2xl font-bold">{Object.keys(groupedMembers).filter(d => d !== "미배정").length}</p>
              <p className="text-xs text-slate-500">부서 수</p>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Org Chart by Department */}
      {sortedDepts.length === 0 ? (
        <div className="text-center py-20 text-slate-400">
          <Network className="w-16 h-16 mx-auto mb-4 opacity-30" />
          <p className="text-lg font-medium">조직도 데이터가 없습니다.</p>
          <p className="text-sm mt-1">관리시스템에서 부서와 직원을 등록해주세요.</p>
        </div>
      ) : (
        <div className="space-y-6">
          {sortedDepts.map(([deptName, deptMembers]) => (
            <Card key={deptName} className="border-none shadow-md bg-white rounded-2xl overflow-hidden">
              <CardHeader className="bg-slate-50 border-b border-slate-100 py-4">
                <CardTitle className="flex items-center gap-3 text-lg">
                  <Building2 className="w-5 h-5 text-emerald-500" />
                  {deptName}
                  <Badge variant="secondary" className="ml-2">{deptMembers.length}명</Badge>
                </CardTitle>
              </CardHeader>
              <CardContent className="p-0">
                <div className="divide-y divide-slate-50">
                  {deptMembers
                    .sort((a, b) => (a.job_title || "").localeCompare(b.job_title || ""))
                    .map(member => (
                      <div key={member.user_id} className="flex items-center gap-4 px-6 py-4 hover:bg-slate-50/50 transition-colors">
                        <Avatar className="w-10 h-10">
                          <AvatarImage src={member.profile?.avatar_url || undefined} />
                          <AvatarFallback className="bg-blue-100 text-blue-700 font-bold text-sm">
                            {(member.profile?.full_name || "?").substring(0, 1)}
                          </AvatarFallback>
                        </Avatar>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-slate-800">
                              {member.profile?.full_name || "이름 없음"}
                            </span>
                            {member.job_title && (
                              <Badge variant="outline" className="text-xs">{member.job_title}</Badge>
                            )}
                            {getRoleBadge(member.role)}
                          </div>
                        </div>
                        <div className="flex items-center gap-4 text-sm text-slate-500">
                          {member.profile?.phone && (
                            <a href={`tel:${member.profile.phone}`} className="flex items-center gap-1 hover:text-blue-600 transition-colors">
                              <Phone className="w-3.5 h-3.5" />
                              <span className="hidden md:inline">{member.profile.phone}</span>
                            </a>
                          )}
                          {member.profile?.email && (
                            <a href={`mailto:${member.profile.email}`} className="flex items-center gap-1 hover:text-blue-600 transition-colors">
                              <Mail className="w-3.5 h-3.5" />
                              <span className="hidden lg:inline">{member.profile.email}</span>
                            </a>
                          )}
                        </div>
                      </div>
                    ))}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
};

export default OrgChart;



============================================================
File Path: src/pages/ProfileManagement.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Separator } from "@/components/ui/separator";
import { Badge } from "@/components/ui/badge";
import { Printer, User, CheckCircle2, FileCheck, Loader2, Sparkles } from "lucide-react";
import { toast } from "sonner";
import { PortalDocTemplate } from "@/components/profile/PortalDocTemplate";

// --- Types ---
export interface Artist {
  id: string;
  name: string;
  stage_name?: string | null;
  birth_date: string;
  gender: string;
  contact_phone?: string | null;
  email?: string | null;
  address: string;
  resident_number: string;
  id_card_url: string;
  id_card_masked_url: string;
  signature_url: string;
}

export interface Employee {
  id: string;
  full_name: string;
  phone: string;
  email: string;
  department?: string;
  job_title?: string;
  join_date?: string;
  birth_date?: string;
  address?: string;
}

export interface TenantInfo {
  name: string;
  rep_name: string;
  address: string;
}

export interface ExtraInfo {
  empBirth: string;
  empAddress: string;
  relation: string;
  date: string;
  usage: string;
}

const ProfileManagement = () => {
  const { currentTenant } = useAuth();
  const [loading, setLoading] = useState(true);
  const [artists, setArtists] = useState<Artist[]>([]);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [tenantInfo, setTenantInfo] = useState<TenantInfo>({ name: "", rep_name: "", address: "" });

  const [selectedArtistId, setSelectedArtistId] = useState("");
  const [selectedEmployeeId, setSelectedEmployeeId] = useState("");

  const [extraInfo, setExtraInfo] = useState<ExtraInfo>({
    empBirth: "",
    empAddress: "",
    relation: "소속사 담당자",
    date: new Date().toISOString().split("T")[0],
    usage: "포털 사이트 인물정보 등록 및 수정 요청",
  });

  const printRef = useRef<HTMLDivElement>(null);
  const [activeTab, setActiveTab] = useState<"naver" | "daum" | "certificate">("naver");

  // 1. 데이터 로드 로직 수정
  useEffect(() => {
    const fetchData = async () => {
      if (!currentTenant) return;
      setLoading(true);

      try {
        // 배우 정보 로드
        const { data: artistData } = await supabase
          .from("artists")
          .select(
            "id, name, stage_name, birth_date, gender, contact_phone, email, address, resident_number, id_card_url, id_card_masked_url, signature_url",
          )
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("is_active", true);

        // [수정] !inner 제거하여 정보 미등록 직원도 모두 불러옴 (Left Join)
        const { data: memberData, error: memberError } = await supabase
          .from("tenant_memberships")
          .select(
            `
            user_id, role, department, job_title, created_at,
            profiles:user_id ( full_name, phone, email )
          `,
          )
          .eq("tenant_id", currentTenant.tenant_id);

        if (memberError) throw memberError;

        // 직원 상세 정보(주소, 주민번호) 별도 로드하여 매핑 (안정성 강화)
        const userIds = memberData.map((m) => m.user_id);
        const { data: detailsData } = await supabase
          .from("employee_details")
          .select("user_id, resident_number, address")
          .in("user_id", userIds);

        const detailsMap = new Map(detailsData?.map((d) => [d.user_id, d]));

        // 회사 정보
        const { data: tInfo } = await supabase
          .from("tenants")
          .select("name, rep_name, address")
          .eq("id", currentTenant.tenant_id)
          .single();

        if (artistData) setArtists(artistData as unknown as Artist[]);

        if (memberData) {
          const formattedEmployees = memberData.map((m: any) => {
            const detail = detailsMap.get(m.user_id);
            const resNum = (detail as any)?.resident_number || "";
            let birth = "";
            if (resNum.length >= 6) {
              const yearPrefix = parseInt(resNum.substring(0, 2)) > 30 ? "19" : "20";
              birth = `${yearPrefix}${resNum.substring(0, 2)}-${resNum.substring(2, 4)}-${resNum.substring(4, 6)}`;
            }

            return {
              id: m.user_id,
              full_name: m.profiles?.full_name || "이름 없음",
              phone: m.profiles?.phone || "",
              email: m.profiles?.email || "",
              department: m.department,
              job_title: m.job_title,
              join_date: m.created_at,
              birth_date: birth,
              address: (detail as any)?.address || "",
            };
          });
          setEmployees(formattedEmployees);
        }

        if (tInfo) setTenantInfo({ name: tInfo.name, rep_name: tInfo.rep_name || "", address: tInfo.address || "" });
      } catch (err) {
        console.error("Data Load Error:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, [currentTenant]);

  // 2. 수임인 선택 시 정보 자동 반영
  useEffect(() => {
    if (selectedEmployeeId) {
      const emp = employees.find((e) => e.id === selectedEmployeeId);
      if (emp) {
        setExtraInfo((prev) => ({
          ...prev,
          empBirth: emp.birth_date || "",
          empAddress: emp.address || "",
        }));
        if (emp.birth_date || emp.address) {
          toast.success(`${emp.full_name}님의 정보를 자동 입력했습니다.`);
        }
      }
    }
  }, [selectedEmployeeId, employees]);

  const selectedArtist = artists.find((a) => a.id === selectedArtistId) || null;
  const selectedEmployee = employees.find((e) => e.id === selectedEmployeeId) || null;

  const handlePrint = () => {
    const printContent = printRef.current;
    if (!printContent) return;
    const iframe = document.createElement("iframe");
    iframe.style.position = "absolute";
    iframe.style.width = "0px";
    iframe.style.height = "0px";
    iframe.style.border = "none";
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow?.document;
    if (!doc) return;
    const existingStyles = Array.from(document.querySelectorAll("style, link[rel='stylesheet']"))
      .map((node) => node.outerHTML)
      .join("");
    doc.open();
    doc.write(
      `<html><head><meta charset="UTF-8" />${existingStyles}<style>@page { size: A4; margin: 0; } .page-break-before-always { page-break-before: always; }</style></head><body>${printContent.innerHTML}<script>window.onload = function() { window.print(); }</script></body></html>`,
    );
    doc.close();
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full p-12">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
      <div className="p-8 md:p-12 max-w-7xl mx-auto">
        <div className="mb-10">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-2 rounded-xl bg-blue-50 text-blue-600">
              <FileCheck className="w-6 h-6" />
            </div>
            <h1 className="text-3xl font-black text-slate-900 tracking-tight">인물정보 등록 관리</h1>
          </div>
          <p className="text-slate-500 text-sm font-medium ml-12">
            인사 데이터 연동을 통해 위임장을 자동으로 완성합니다.
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-8">
          <div className="space-y-6">
            <Card className="border-none shadow-lg rounded-2xl overflow-hidden">
              <CardHeader className="bg-slate-50 border-b py-4">
                <CardTitle className="text-sm font-bold flex items-center gap-2 text-slate-800">
                  <User className="w-4 h-4 text-blue-600" /> 1. 대상 선택
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4 pt-6">
                {activeTab !== "certificate" && (
                  <div className="space-y-2">
                    <Label className="text-xs font-bold text-slate-500 uppercase">위임인 (배우/아티스트)</Label>
                    <Select value={selectedArtistId} onValueChange={setSelectedArtistId}>
                      <SelectTrigger className="rounded-xl h-11 border-slate-200">
                        <SelectValue placeholder="배우 선택" />
                      </SelectTrigger>
                      <SelectContent>
                        {artists.map((a) => (
                          <SelectItem key={a.id} value={a.id}>
                            {a.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                )}
                <div className="space-y-2">
                  <Label className="text-xs font-bold text-slate-500 uppercase">
                    {activeTab === "certificate" ? "발급 대상자 (직원)" : "수임인 (담당 매니저)"}
                  </Label>
                  <Select value={selectedEmployeeId} onValueChange={setSelectedEmployeeId}>
                    <SelectTrigger className="rounded-xl h-11 border-slate-200">
                      <SelectValue placeholder="직원 선택" />
                    </SelectTrigger>
                    <SelectContent>
                      {employees.map((e) => (
                        <SelectItem key={e.id} value={e.id}>
                          {e.full_name} ({e.department || "소속"})
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>

            <Card className="border-none shadow-lg rounded-2xl overflow-hidden">
              <CardHeader className="bg-slate-50 border-b py-4">
                <CardTitle className="text-sm font-bold flex items-center gap-2">
                  <Sparkles className="w-4 h-4 text-blue-500" /> 2. 자동 완성 데이터
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4 pt-6">
                <div className="space-y-1.5">
                  <Label className="text-xs font-bold text-slate-500">대리인 생년월일</Label>
                  <Input
                    type="date"
                    className="rounded-xl h-11 border-slate-200 bg-slate-50 font-medium"
                    value={extraInfo.empBirth}
                    onChange={(e) => setExtraInfo({ ...extraInfo, empBirth: e.target.value })}
                  />
                </div>
                <div className="space-y-1.5">
                  <Label className="text-xs font-bold text-slate-500">대리인 주소</Label>
                  <Input
                    className="rounded-xl h-11 border-slate-200 bg-slate-50 text-sm"
                    value={extraInfo.empAddress}
                    onChange={(e) => setExtraInfo({ ...extraInfo, empAddress: e.target.value })}
                    placeholder="주소 정보 없음"
                  />
                </div>
                <div className="space-y-1.5">
                  <Label className="text-xs font-bold text-slate-500">관계</Label>
                  <Input
                    className="rounded-xl h-11 border-slate-200"
                    value={extraInfo.relation}
                    onChange={(e) => setExtraInfo({ ...extraInfo, relation: e.target.value })}
                  />
                </div>
                <Separator className="my-4" />
                <Button
                  onClick={handlePrint}
                  className="w-full h-12 rounded-xl bg-slate-900 hover:bg-black text-white font-bold shadow-xl transition-all active:scale-95"
                >
                  <Printer className="w-4 h-4 mr-2" /> 위임장 PDF 생성
                </Button>
              </CardContent>
            </Card>
          </div>

          <div className="flex flex-col min-h-0">
            <Tabs
              value={activeTab}
              onValueChange={(v) => setActiveTab(v as any)}
              className="w-full h-full flex flex-col"
            >
              <div className="flex items-center justify-between mb-4 shrink-0">
                <TabsList className="bg-slate-100 p-1 rounded-xl">
                  <TabsTrigger value="naver" className="rounded-lg px-6 font-bold">
                    NAVER
                  </TabsTrigger>
                  <TabsTrigger value="daum" className="rounded-lg px-6 font-bold">
                    DAUM
                  </TabsTrigger>
                  <TabsTrigger value="certificate" className="rounded-lg px-6 font-bold">
                    재직증명
                  </TabsTrigger>
                </TabsList>
                <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full border border-blue-100 font-bold text-[11px] uppercase">
                  <CheckCircle2 className="w-3.5 h-3.5" /> Data Synced
                </div>
              </div>
              <div className="flex-1 bg-slate-100 rounded-[2.5rem] p-12 overflow-auto shadow-inner border-[6px] border-white">
                <div ref={printRef} className="mx-auto bg-white shadow-2xl origin-top">
                  <PortalDocTemplate
                    type={activeTab}
                    artist={selectedArtist}
                    employee={selectedEmployee}
                    tenantInfo={tenantInfo}
                    extraInfo={extraInfo}
                  />
                </div>
              </div>
            </Tabs>
          </div>
        </div>
      </div>
  );
};

export default ProfileManagement;



============================================================
File Path: src/pages/SuperAdmin.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  Building2, Search, Plus, Users, Settings, 
  ShieldCheck, Activity, Database, Server,
  ExternalLink, MoreHorizontal, Check, X, Loader2, Edit2, Trash2, Key,
  MessageSquareShare, Clock, Palmtree
} from "lucide-react";
import { getCompanyTypeBadge } from "@/lib/companyTypes";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import {
  DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator,
} from "@/components/ui/dropdown-menu";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";

interface SignupRequest {
  id: string;
  user_id: string;
  company_name: string;
  status: "pending" | "approved" | "rejected";
  created_at: string;
  assigned_tenant_id: string | null;
  user_email?: string;
  user_name?: string;
}

const SuperAdmin = () => {
  const navigate = useNavigate();
  const [signupRequests, setSignupRequests] = useState<SignupRequest[]>([]);
  const [tenants, setTenants] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedTenants, setSelectedTenants] = useState<Record<string, string>>({});
  const [processingIds, setProcessingIds] = useState<Set<string>>(new Set());
  const [deletingTenantId, setDeletingTenantId] = useState<string | null>(null);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);

  // --- 데이터 Fetching (기존 로직 100% 유지) ---
  const fetchData = async () => {
    try {
      const { data: requests } = await supabase
        .from("signup_requests")
        .select("*")
        .eq("status", "pending")
        .order("created_at", { ascending: false });

      if (requests && requests.length > 0) {
        const userIds = requests.map((r) => r.user_id);
        const { data: profiles } = await supabase
          .from("profiles")
          .select("id, email, full_name")
          .in("id", userIds);

        const enrichedRequests = requests.map((request) => {
          const profile = profiles?.find((p) => p.id === request.user_id);
          return { ...request, user_email: profile?.email, user_name: profile?.full_name };
        });
        setSignupRequests(enrichedRequests as SignupRequest[]);
      } else {
        setSignupRequests([]);
      }

      const { data: tenantsData, error: tenantError } = await supabase
        .from("tenants")
        .select("*")
        .order("created_at", { ascending: false });

      if (tenantError) throw tenantError;
      setTenants(tenantsData || []);
    } catch (error) {
      console.error("Error fetching data:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
    const tenantChannel = supabase.channel("tenants-realtime").on("postgres_changes", { event: "*", schema: "public", table: "tenants" }, () => fetchData()).subscribe();
    const requestChannel = supabase.channel("requests-realtime").on("postgres_changes", { event: "*", schema: "public", table: "signup_requests" }, () => fetchData()).subscribe();
    return () => { supabase.removeChannel(tenantChannel); supabase.removeChannel(requestChannel); };
  }, []);

  // --- 핸들러들 (기존 로직 100% 유지) ---
  const handleDeleteTenant = async () => {
    if (!deletingTenantId) return;
    try {
      const { error } = await supabase.from("tenants").delete().eq("id", deletingTenantId);
      if (error) throw error;
      toast.success("고객사가 영구적으로 삭제되었습니다.");
      setIsDeleteDialogOpen(false);
      fetchData();
    } catch (error: any) {
      toast.error("삭제 실패: " + error.message);
    }
  };

  const handleApprove = async (request: SignupRequest) => {
    const tenantId = selectedTenants[request.id];
    if (!tenantId) { toast.error("배정할 회사를 선택해주세요"); return; }
    setProcessingIds((prev) => new Set(prev).add(request.id));
    try {
      await supabase.from("signup_requests").update({ status: "approved", assigned_tenant_id: tenantId, reviewed_at: new Date().toISOString() }).eq("id", request.id);
      await supabase.from("tenant_memberships").insert({ user_id: request.user_id, tenant_id: tenantId, role: "employee" });
      toast.success("승인 완료");
      fetchData();
    } catch (error) { toast.error("오류 발생"); } 
    finally { setProcessingIds((prev) => { const next = new Set(prev); next.delete(request.id); return next; }); }
  };

  const handleReject = async (request: SignupRequest) => {
    setProcessingIds((prev) => new Set(prev).add(request.id));
    try {
      await supabase.from("signup_requests").update({ status: "rejected", reviewed_at: new Date().toISOString() }).eq("id", request.id);
      toast.success("거절 완료");
      fetchData();
    } catch (error) { toast.error("오류 발생"); }
    finally { setProcessingIds((prev) => { const next = new Set(prev); next.delete(request.id); return next; }); }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-foreground">
      <Header />

      <main className="pt-24 pb-16 px-4 max-w-[1600px] mx-auto space-y-8">
        
        {/* 1. 상단 헤더 & 요약 통계 */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="md:col-span-4 mb-2">
            <h1 className="text-3xl font-black tracking-tight text-slate-900 flex items-center gap-2">
              <ShieldCheck className="w-8 h-8 text-primary" /> Super Admin Center
            </h1>
            <p className="text-slate-500 mt-1">ArkPort 전체 시스템 상태 및 테넌트 관리 콘솔입니다.</p>
          </div>

          <Card className="shadow-sm border-l-4 border-l-blue-500">
            <CardHeader className="pb-2">
              <CardDescription>총 고객사 (Tenants)</CardDescription>
              <CardTitle className="text-3xl font-bold flex items-center gap-2">
                {tenants.length} <span className="text-sm font-normal text-muted-foreground">개 사</span>
              </CardTitle>
            </CardHeader>
          </Card>
          <Card className="shadow-sm border-l-4 border-l-amber-500">
            <CardHeader className="pb-2">
              <CardDescription>가입 승인 대기</CardDescription>
              <CardTitle className="text-3xl font-bold flex items-center gap-2 text-amber-600">
                {signupRequests.length} <span className="text-sm font-normal text-muted-foreground">건</span>
              </CardTitle>
            </CardHeader>
          </Card>
          <Card className="shadow-sm border-l-4 border-l-green-500">
            <CardHeader className="pb-2">
              <CardDescription>시스템 상태</CardDescription>
              <CardTitle className="text-3xl font-bold flex items-center gap-2 text-green-600">
                Healthy <Activity className="w-5 h-5 animate-pulse" />
              </CardTitle>
            </CardHeader>
          </Card>
          <Card className="shadow-sm border-l-4 border-l-purple-500 bg-purple-50/50">
            <CardHeader className="pb-2">
              <CardDescription>이번 달 신규 가입</CardDescription>
              <CardTitle className="text-3xl font-bold text-purple-700">
                +2 <span className="text-sm font-normal text-muted-foreground">건</span>
              </CardTitle>
            </CardHeader>
          </Card>
        </div>

        <Separator />

        {/* 2. 관리 메뉴 그리드 (커뮤니케이션 관리 추가됨) */}
        <div>
          <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <Settings className="w-5 h-5" /> 관리 도구 (Management Tools)
          </h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            {/* 고객사 추가 */}
            <div 
              onClick={() => navigate("/super-admin/tenants/new")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-blue-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                <Plus className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">새 고객사 등록</h3>
                <p className="text-xs text-slate-500 mt-1">새로운 테넌트를 생성하고 초기 설정을 진행합니다.</p>
              </div>
            </div>

            {/* 미디어 관리 */}
            <div 
              onClick={() => navigate("/super-admin/press-contacts")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-indigo-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 group-hover:scale-110 transition-transform">
                <Users className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">미디어 연락처 센터</h3>
                <p className="text-xs text-slate-500 mt-1">공용 기자 DB 및 언론사 연락망을 통합 관리합니다.</p>
              </div>
            </div>

            {/* [신규] 커뮤니케이션 관리 (동적 메시지 설정) */}
            <div 
              onClick={() => navigate("/super-admin/messages")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-orange-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center text-orange-600 group-hover:scale-110 transition-transform">
                <MessageSquareShare className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">커뮤니케이션 관리</h3>
                <p className="text-xs text-slate-500 mt-1">SNS 공유 카드, 이메일, 알림 문구를 동적으로 제어합니다.</p>
              </div>
            </div>

            {/* API 관리 */}
            <div 
              onClick={() => navigate("/super-admin/api-management")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-purple-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 group-hover:scale-110 transition-transform">
                <Key className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">시스템 API 설정</h3>
                <p className="text-xs text-slate-500 mt-1">AI 토큰, 결제 모듈 등 전역 시스템 키를 관리합니다.</p>
              </div>
            </div>

            {/* 근로규칙 기본값 관리 */}
            <div 
              onClick={() => navigate("/super-admin/work-rules")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-teal-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center text-teal-600 group-hover:scale-110 transition-transform">
                <Clock className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">근로규칙 기본값</h3>
                <p className="text-xs text-slate-500 mt-1">모든 회사에 적용할 소정/최대 근로규칙 기본값을 관리합니다.</p>
              </div>
            </div>

            {/* 부서 및 직급 기본값 관리 */}
            <div 
              onClick={() => navigate("/super-admin/org-defaults")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-emerald-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform">
                <Users className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">부서 및 직급 기본값</h3>
                <p className="text-xs text-slate-500 mt-1">모든 회사에 기본으로 적용될 부서와 직급 체계를 관리합니다.</p>
              </div>
            </div>

            {/* 휴가 그룹/유형 기본값 관리 */}
            <div 
              onClick={() => navigate("/super-admin/leave-defaults")}
              className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-green-500 hover:shadow-md transition-all cursor-pointer flex flex-col gap-3"
            >
              <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center text-green-600 group-hover:scale-110 transition-transform">
                <Palmtree className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-900">휴가 그룹/유형 기본값</h3>
                <p className="text-xs text-slate-500 mt-1">모든 회사에 기본으로 적용될 휴가 그룹과 유형을 관리합니다.</p>
              </div>
            </div>

            {/* 서버 로그 (준비 중) */}
            <div className="group bg-slate-50 p-5 rounded-xl border border-dashed border-slate-300 flex flex-col gap-3 opacity-60">
              <div className="w-10 h-10 rounded-lg bg-slate-200 flex items-center justify-center text-slate-500">
                <Server className="w-6 h-6" />
              </div>
              <div>
                <h3 className="font-bold text-slate-700">시스템 감사 로그</h3>
                <p className="text-xs text-slate-500 mt-1">준비 중인 기능입니다.</p>
              </div>
            </div>
          </div>
        </div>

        {/* 3. 승인 대기 목록 (기존 로직 유지) */}
        {signupRequests.length > 0 && (
          <div className="border-2 border-amber-400 bg-amber-50 rounded-xl overflow-hidden shadow-sm animate-in fade-in slide-in-from-bottom-2">
            <div className="p-4 bg-amber-100 border-b border-amber-200 flex items-center justify-between">
              <h3 className="font-bold text-amber-900 flex items-center gap-2">
                <Users className="w-5 h-5" /> 가입 승인 요청 ({signupRequests.length})
              </h3>
              <Badge className="bg-amber-500 hover:bg-amber-600">Action Required</Badge>
            </div>
            <div className="divide-y divide-amber-200/50">
              {signupRequests.map((request) => (
                <div key={request.id} className="p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                  <div>
                    <div className="font-bold text-slate-800">{request.user_name} ({request.user_email})</div>
                    <div className="text-sm text-slate-600 flex items-center gap-1 mt-1">
                      <Building2 className="w-3 h-3" /> 요청 회사명: <span className="font-semibold text-amber-700">{request.company_name}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border border-amber-200">
                    <Select onValueChange={(v) => setSelectedTenants((p) => ({ ...p, [request.id]: v }))}>
                      <SelectTrigger className="w-[180px] h-9 text-xs"><SelectValue placeholder="소속 회사 선택" /></SelectTrigger>
                      <SelectContent>
                        {tenants.map((t) => <SelectItem key={t.id} value={t.id}>{t.name}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Button size="sm" className="h-9 bg-green-600 hover:bg-green-700 text-white" onClick={() => handleApprove(request)} disabled={processingIds.has(request.id)}>
                      승인
                    </Button>
                    <Button size="sm" variant="ghost" className="h-9 text-red-500 hover:bg-red-50 hover:text-red-700" onClick={() => handleReject(request)} disabled={processingIds.has(request.id)}>
                      거절
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 4. 고객사 목록 테이블 (기존 로직 유지) */}
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
          <div className="p-5 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <h2 className="text-lg font-bold flex items-center gap-2">
              <Building2 className="w-5 h-5 text-slate-500" /> 등록된 고객사 목록
            </h2>
            <div className="relative w-full sm:w-72">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input placeholder="고객사명 또는 도메인 검색" className="pl-9 h-10 bg-slate-50 border-slate-200" />
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                <tr>
                  <th className="px-6 py-4 font-semibold">고객사 명</th>
                  <th className="px-6 py-4 font-semibold">유형</th>
                  <th className="px-6 py-4 font-semibold">접속 도메인</th>
                  <th className="px-6 py-4 font-semibold text-center">등록일</th>
                  <th className="px-6 py-4 font-semibold text-right">관리</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {tenants.map((tenant) => (
                  <tr key={tenant.id} className="hover:bg-slate-50/80 transition-colors">
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-3">
                        <div className="w-9 h-9 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                          {tenant.name.substring(0, 1)}
                        </div>
                        <span className="font-semibold text-slate-700">{tenant.name}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <Badge variant="outline" className="text-xs">
                        {getCompanyTypeBadge(tenant.company_type || "talent_agency")}
                      </Badge>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <code className="px-2 py-1 bg-slate-100 rounded text-slate-600 font-mono text-xs border border-slate-200">
                          {tenant.domain || "-"}
                        </code>
                        {tenant.domain && <ExternalLink className="w-3 h-3 text-slate-400 cursor-pointer hover:text-blue-500" onClick={() => window.open(`https://${tenant.domain}`, "_blank")} />}
                      </div>
                    </td>
                    <td className="px-6 py-4 text-center text-slate-500">
                      {new Date(tenant.created_at).toLocaleDateString()}
                    </td>
                    <td className="px-6 py-4 text-right">
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button variant="ghost" size="sm" className="h-8 w-8 p-0"><MoreHorizontal className="w-4 h-4" /></Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          <DropdownMenuItem onClick={() => navigate(`/super-admin/tenants/edit/${tenant.id}`)}>
                            <Edit2 className="w-4 h-4 mr-2" /> 정보 수정
                          </DropdownMenuItem>
                          <DropdownMenuSeparator />
                          <DropdownMenuItem className="text-red-600 focus:text-red-600 focus:bg-red-50" onClick={() => { setDeletingTenantId(tenant.id); setIsDeleteDialogOpen(true); }}>
                            <Trash2 className="w-4 h-4 mr-2" /> 삭제
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </main>

      {/* 삭제 확인 Dialog (기존 유지) */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-destructive font-bold">정말 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription>
              고객사 데이터를 삭제하면 복구할 수 없습니다. 연결된 모든 사용자 계정과 데이터가 함께 삭제됩니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDeleteTenant} className="bg-destructive hover:bg-destructive/90">삭제 확정</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default SuperAdmin;


============================================================
File Path: src/pages/TenantRegistration.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { 
  Globe, 
  FileText, 
  User, 
  Users, 
  Calendar as CalendarIcon, 
  MapPin, 
  Mail, 
  ArrowLeft,
  Save,
  Loader2,
  Info
} from "lucide-react";
import { toast } from "sonner";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { COMPANY_TYPES } from "@/lib/companyTypes";

const TenantRegistration = () => {
  const navigate = useNavigate();
  const { id } = useParams();
  const isEditMode = !!id;

  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(isEditMode);
  const [isJointRep, setIsJointRep] = useState(false);
  const [members, setMembers] = useState<any[]>([]);

  const [formData, setFormData] = useState({
    name: "",
    domain_prefix: "",
    company_type: "talent_agency",
    biz_number: "",
    corp_number: "",
    rep_name: "",
    opening_date: "",
    tax_email: "",
    biz_type: "",
    biz_item: "",
    address: "",
  });

  useEffect(() => {
    if (isEditMode) {
      const getTenantAndMembers = async () => {
        try {
          // 1. 고객사 상세 정보 가져오기
          const { data: tenant, error: tenantError } = await supabase
            .from("tenants")
            .select("*")
            .eq("id", id)
            .single();

          if (tenantError) throw tenantError;

          // 2. 소속 임직원 목록 가져오기 (관계 모호성 해결을 위해 user_id 명시)
          const { data: memberData, error: memberError } = await supabase
            .from("tenant_memberships")
            .select(`
              id,
              role,
              department,
              job_title,
              profiles:user_id (
                id,
                full_name,
                email,
                avatar_url
              )
            `)
            .eq("tenant_id", id);

          if (memberError) throw memberError;

          if (tenant) {
            const prefix = tenant.domain?.split(".")[0] || "";
            setFormData({
              name: tenant.name || "",
              domain_prefix: prefix,
              company_type: (tenant as any).company_type || "talent_agency",
              biz_number: tenant.biz_number || "",
              corp_number: tenant.corp_number || "",
              rep_name: tenant.rep_name || "",
              opening_date: tenant.opening_date || "",
              tax_email: tenant.tax_email || "",
              biz_type: tenant.biz_type || "",
              biz_item: tenant.biz_item || "",
              address: tenant.address || "",
            });
            if (tenant.rep_name?.includes(",")) setIsJointRep(true);
          }

          if (memberData) {
            setMembers(memberData);
          }
        } catch (error: any) {
          console.error("Fetch error:", error);
          toast.error("정보를 불러오는 중 오류가 발생했습니다.");
        } finally {
          setFetching(false);
        }
      };

      getTenantAndMembers();
    }
  }, [id, isEditMode, navigate]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const fullDomain = formData.domain_prefix 
        ? `${formData.domain_prefix.toLowerCase()}.arkport.io` 
        : null;

      const payload = {
        name: formData.name,
        domain: fullDomain,
        company_type: formData.company_type,
        biz_number: formData.biz_number,
        corp_number: formData.corp_number,
        rep_name: formData.rep_name,
        opening_date: formData.opening_date,
        tax_email: formData.tax_email,
        biz_type: formData.biz_type,
        biz_item: formData.biz_item,
        address: formData.address,
      } as any;

      if (isEditMode) {
        const { error } = await supabase.from("tenants").update(payload).eq("id", id);
        if (error) throw error;
        toast.success("정보가 수정되었습니다.");
      } else {
        const { error } = await supabase.from("tenants").insert([payload]);
        if (error) throw error;
        toast.success("새 고객사가 등록되었습니다.");
      }
      navigate("/super-admin");
    } catch (error: any) {
      toast.error("저장 실패: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { id, value } = e.target;
    setFormData(prev => ({ ...prev, [id]: value }));
  };

  if (fetching) {
    return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-primary w-10 h-10" /></div>;
  }

  return (
    <div className="min-h-screen bg-background text-foreground">
      <Header />
      <main className="pt-24 pb-16 px-4">
        <div className="max-w-4xl mx-auto">
          <button onClick={() => navigate("/super-admin")} className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground mb-6 transition-colors">
            <ArrowLeft className="w-4 h-4" /> 슈퍼 어드민 대시보드로 돌아가기
          </button>

          <div className="mb-8">
            <h1 className="text-3xl font-bold tracking-tight">
              고객사 정보 수정
            </h1>
            <p className="text-muted-foreground">테넌트 인프라 및 사업자 세부 정보를 관리합니다.</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-8">
            {/* 1. 시스템 접속 정보 */}
            <Card className="glass-card border-primary/20 shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Globe className="w-5 h-5 text-primary" /> 시스템 접속 정보
                </CardTitle>
              </CardHeader>
              <CardContent className="grid md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="name">회사 식별 이름 (내부용)</Label>
                  <Input id="name" value={formData.name} onChange={handleChange} required />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="domain_prefix">접속 서브도메인</Label>
                  <div className="flex items-center">
                    <Input id="domain_prefix" value={formData.domain_prefix} onChange={handleChange} className="rounded-r-none border-r-0" required />
                    <span className="bg-secondary px-3 h-10 flex items-center border border-input rounded-r-md text-sm">.arkport.io</span>
                  </div>
                </div>
                <div className="space-y-2 md:col-span-2">
                  <Label>회사 유형</Label>
                  <Select value={formData.company_type} onValueChange={(v) => setFormData(prev => ({ ...prev, company_type: v }))}>
                    <SelectTrigger>
                      <SelectValue placeholder="회사 유형 선택" />
                    </SelectTrigger>
                    <SelectContent>
                      {COMPANY_TYPES.map((t) => (
                        <SelectItem key={t.value} value={t.value}>
                          {t.emoji} {t.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>

            {/* 2. 임직원 현황 섹션 */}
            <Card className="glass-card shadow-md border-accent/20">
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Users className="w-5 h-5 text-accent" /> 소속 임직원 현황
                </CardTitle>
                <CardDescription>현재 이 고객사에 등록된 총 {members.length}명의 인력입니다. 대표 관리자는 회사 관리 메뉴에 접근할 수 있습니다.</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {members.length > 0 ? (
                    members.map((member) => (
                      <div key={member.id} className="flex items-center justify-between p-3 rounded-lg bg-secondary/30 border border-border/50">
                        <div className="flex items-center gap-4">
                          <Avatar>
                            <AvatarImage src={member.profiles?.avatar_url} />
                            <AvatarFallback className="bg-primary/10 text-primary">
                              {member.profiles?.full_name?.substring(0, 1) || "U"}
                            </AvatarFallback>
                          </Avatar>
                          <div>
                            <div className="text-sm font-bold flex items-center gap-2">
                              {member.profiles?.full_name}
                              <Badge variant={member.role === 'company_admin' ? 'default' : 'secondary'} className="text-[10px] h-4">
                                {member.role === 'company_admin' ? '대표 관리자' : member.role === 'manager' ? '매니저' : '사원'}
                              </Badge>
                            </div>
                            <div className="text-xs text-muted-foreground">{member.profiles?.email}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="text-right hidden sm:block">
                            <div className="text-xs font-medium">{member.department || "부서 미지정"}</div>
                            <div className="text-[11px] text-muted-foreground">{member.job_title || "직함 미지정"}</div>
                          </div>
                          {member.role !== 'company_admin' ? (
                            <Button 
                              type="button"
                              variant="outline" 
                              size="sm"
                              onClick={async () => {
                                try {
                                  const { error } = await supabase
                                    .from("tenant_memberships")
                                    .update({ role: 'company_admin' })
                                    .eq("id", member.id);
                                  if (error) throw error;
                                  toast.success(`${member.profiles?.full_name}님을 대표 관리자로 지정했습니다.`);
                                  setMembers(prev => prev.map(m => 
                                    m.id === member.id ? { ...m, role: 'company_admin' } : m
                                  ));
                                } catch (error: any) {
                                  toast.error("권한 변경 실패: " + error.message);
                                }
                              }}
                            >
                              관리자 지정
                            </Button>
                          ) : (
                            <Button 
                              type="button"
                              variant="ghost" 
                              size="sm"
                              className="text-destructive hover:text-destructive"
                              onClick={async () => {
                                try {
                                  const { error } = await supabase
                                    .from("tenant_memberships")
                                    .update({ role: 'employee' })
                                    .eq("id", member.id);
                                  if (error) throw error;
                                  toast.success(`${member.profiles?.full_name}님의 관리자 권한을 해제했습니다.`);
                                  setMembers(prev => prev.map(m => 
                                    m.id === member.id ? { ...m, role: 'employee' } : m
                                  ));
                                } catch (error: any) {
                                  toast.error("권한 변경 실패: " + error.message);
                                }
                              }}
                            >
                              권한 해제
                            </Button>
                          )}
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-8 text-muted-foreground text-sm">등록된 임직원이 없습니다.</div>
                  )}
                </div>
              </CardContent>
            </Card>

            {/* 3. 사업자 등록 정보 */}
            <Card className="glass-card shadow-md">
              <CardHeader className="pb-4">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <FileText className="w-5 h-5 text-primary" /> 사업자 등록 정보
                  </CardTitle>
                  <div className="flex items-center gap-2 bg-secondary/50 px-3 py-1.5 rounded-full border border-border">
                    <Label htmlFor="joint-rep-switch" className="text-xs cursor-pointer">공동대표 여부</Label>
                    <Switch id="joint-rep-switch" checked={isJointRep} onCheckedChange={setIsJointRep} />
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="biz_number">등록번호 (사업자번호)</Label>
                    <Input id="biz_number" value={formData.biz_number} onChange={handleChange} placeholder="000-00-00000" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="rep_name">대표자 성명</Label>
                    <div className="relative">
                      {isJointRep ? <Users className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-primary" /> : <User className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />}
                      <Input id="rep_name" value={formData.rep_name} onChange={handleChange} className="pl-10" placeholder={isJointRep ? "쉼표(,)로 구분 입력" : "성함 입력"} />
                    </div>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="corp_number">법인등록번호</Label>
                    <Input id="corp_number" value={formData.corp_number} onChange={handleChange} placeholder="000000-0000000" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="opening_date">개업연월일</Label>
                    <Input id="opening_date" value={formData.opening_date} onChange={handleChange} type="date" />
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="tax_email">전자세금계산서 이메일</Label>
                    <Input id="tax_email" value={formData.tax_email} onChange={handleChange} type="email" placeholder="tax@company.com" />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-2">
                      <Label htmlFor="biz_type">업태</Label>
                      <Input id="biz_type" value={formData.biz_type} onChange={handleChange} placeholder="서비스업" />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="biz_item">종목</Label>
                      <Input id="biz_item" value={formData.biz_item} onChange={handleChange} placeholder="광고 대행" />
                    </div>
                  </div>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="address">사업장 소재지</Label>
                  <Textarea id="address" value={formData.address} onChange={handleChange} className="min-h-[80px]" placeholder="사업장 주소를 입력하세요." />
                </div>
              </CardContent>
            </Card>

            <div className="flex items-center justify-end gap-4 pt-4 border-t border-border">
              <Button type="button" variant="ghost" onClick={() => navigate("/super-admin")}>취소</Button>
              <Button type="submit" variant="hero" size="xl" disabled={loading} className="px-12">
                {loading ? <Loader2 className="mr-2 h-5 w-5 animate-spin" /> : <Save className="mr-2 h-5 w-5" />}
                {isEditMode ? "수정 완료" : "고객사 등록 완료"}
              </Button>
            </div>
          </form>
        </div>
      </main>
    </div>
  );
};

export default TenantRegistration;


============================================================
File Path: src/pages/admin/ArtistManagement.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { ScrollArea } from "@/components/ui/scroll-area";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetFooter,
  SheetClose,
  SheetDescription,
} from "@/components/ui/sheet";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import {
  UserCircle,
  Plus,
  Search,
  Loader2,
  Save,
  Edit2,
  Trash2,
  AlertCircle,
  Star,
  Calendar,
  Globe,
  Instagram,
  Youtube,
  FileImage,
  UploadCloud,
  User,
  Printer,
  Mail,
  Phone,
  ArrowLeft,
  Heart,
  CheckCircle2,
  Shield,
  MapPin,
  Briefcase,
} from "lucide-react";

// --- Types ---
interface Artist {
  id: string;
  tenant_id: string;
  name: string;
  stage_name: string | null;
  birth_date: string | null;
  gender: string | null;
  bio: string | null;
  agency: string | null;
  debut_date: string | null;
  is_active: boolean | null;
  profile_image_url: string | null;
  social_links: any;
  created_at: string;
  created_by: string | null;
  updated_at: string;
  email: string | null;
  contact_phone: string | null;
  resident_number: string | null;
  address: string | null;
  contract_start_date: string | null;
  contract_end_date: string | null;
  namuwiki_url: string | null;
  instagram_url: string | null;
  youtube_url: string | null;
  id_card_url: string | null;
  id_card_masked_url: string | null;
  signature_url: string | null;
}

// --- 인쇄용 컴포넌트 ---
const ArtistProfileDocument = ({ data, tenantName }: { data: any; tenantName: string }) => {
  return (
    <div className="w-[210mm] min-h-[297mm] p-[15mm] bg-white text-black font-sans box-border flex flex-col relative">
      <div className="border-b-2 border-black pb-4 mb-6 flex justify-between items-end">
        <div>
          <h1 className="text-3xl font-black mb-1">ARTIST PROFILE</h1>
          <p className="text-sm font-bold text-gray-600 tracking-widest">{tenantName?.toUpperCase()}</p>
        </div>
        <p className="text-xs text-gray-400">Printed: {new Date().toLocaleDateString()}</p>
      </div>
      <div className="flex gap-6 mb-6">
        <div className="w-[60mm] h-[80mm] bg-gray-100 border border-gray-300 flex items-center justify-center overflow-hidden shrink-0 shadow-sm">
          {data.profile_image_url ? (
            <img src={data.profile_image_url} alt="Profile" className="w-full h-full object-cover" />
          ) : (
            <span className="text-gray-400 text-xs">사진 없음</span>
          )}
        </div>
        <div className="flex-1">
          <table className="w-full text-sm border-collapse border-t-2 border-black">
            <tbody>
              <tr className="border-b border-gray-300">
                <th className="text-left py-3 px-2 w-28 bg-gray-50 font-bold border-r border-gray-200">성명 (본명)</th>
                <td className="py-3 px-4 font-bold text-lg">{data.name}</td>
              </tr>
              <tr className="border-b border-gray-300">
                <th className="text-left py-3 px-2 bg-gray-50 font-bold border-r border-gray-200">활동명 (예명)</th>
                <td className="py-3 px-4 text-base">{data.stage_name || "-"}</td>
              </tr>
              <tr className="border-b border-gray-300">
                <th className="text-left py-3 px-2 bg-gray-50 font-bold border-r border-gray-200">생년월일 / 성별</th>
                <td className="py-3 px-4">
                  {data.birth_date} / {data.gender === "male" ? "남성" : "여성"}
                </td>
              </tr>
              <tr className="border-b border-gray-300">
                <th className="text-left py-3 px-2 bg-gray-50 font-bold border-r border-gray-200">연락처</th>
                <td className="py-3 px-4">
                  HP: {data.contact_phone || "-"} / {data.email || "-"}
                </td>
              </tr>
              <tr className="border-b border-gray-300">
                <th className="text-left py-3 px-2 bg-gray-50 font-bold border-r border-gray-200">주민등록번호</th>
                <td className="py-3 px-4 font-mono tracking-wider">{data.resident_number || "-"}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div className="mb-8">
        <h3 className="text-sm font-bold border-l-4 border-black pl-2 mb-2 uppercase">상세 정보 (Details)</h3>
        <table className="w-full text-sm border-t border-black border-b border-black">
          <tbody>
            <tr className="border-b border-gray-200">
              <th className="py-3 px-3 bg-gray-50 w-32 text-left font-bold border-r border-gray-200 align-top">
                거주지 주소
              </th>
              <td className="py-3 px-4">{data.address || "-"}</td>
            </tr>
            <tr className="border-b border-gray-200">
              <th className="py-3 px-3 bg-gray-50 text-left font-bold border-r border-gray-200">전속계약 기간</th>
              <td className="py-3 px-4 font-mono">
                {data.contract_start_date || "미정"} ~ {data.contract_end_date || "미정"}
              </td>
            </tr>
            <tr>
              <th className="py-3 px-3 bg-gray-50 text-left font-bold border-r border-gray-200 align-top h-32">
                소개 (Bio)
              </th>
              <td className="py-3 px-4 align-top text-xs whitespace-pre-wrap">{data.bio || "-"}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div className="mt-auto pt-4 border-t-2 border-gray-200 text-center text-[10px] text-gray-400 font-bold">
        System Generated by Boteda OS
      </div>
    </div>
  );
};

const ArtistManagement = () => {
  const navigate = useNavigate();
  const { currentTenant, isCompanyAdmin } = useAuth();

  // 데이터 상태
  const [artists, setArtists] = useState<Artist[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");

  // UI 상태
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [currentArtist, setCurrentArtist] = useState<Artist | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  // 미리보기 및 파일 상태
  const [previews, setPreviews] = useState<Record<string, string>>({});
  const [tempFiles, setTempFiles] = useState<Record<string, File>>({});

  const printRef = useRef<HTMLDivElement>(null);

  // [수정] 객체 내부에 정의된 참조
  const fileInputRefs = {
    profile: useRef<HTMLInputElement>(null),
    idCard: useRef<HTMLInputElement>(null),
    idMasked: useRef<HTMLInputElement>(null),
    signature: useRef<HTMLInputElement>(null),
  };

  const [formData, setFormData] = useState<Partial<Artist>>({
    name: "",
    stage_name: "",
    birth_date: "",
    gender: "male",
    bio: "",
    is_active: true,
    email: "",
    contact_phone: "",
    resident_number: "",
    address: "",
    contract_start_date: "",
    contract_end_date: "",
    namuwiki_url: "",
    instagram_url: "",
    youtube_url: "",
    profile_image_url: "",
    id_card_url: "",
    id_card_masked_url: "",
    signature_url: "",
  });

  const fetchArtists = async () => {
    if (!currentTenant) return;
    setLoading(true);
    const { data } = await supabase.from("artists").select("*").eq("tenant_id", currentTenant.tenant_id).order("name");
    if (data) setArtists(data as Artist[]);
    setLoading(false);
  };

  useEffect(() => {
    fetchArtists();
  }, [currentTenant]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, field: string) => {
    const file = e.target.files?.[0];
    if (file) {
      const previewUrl = URL.createObjectURL(file);
      setTempFiles((prev) => ({ ...prev, [field]: file }));
      setPreviews((prev) => ({ ...prev, [field]: previewUrl }));
    }
  };

  const uploadToStorage = async (file: File, folder: string) => {
    const fileExt = file.name.split(".").pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 7)}.${fileExt}`;
    const filePath = `${currentTenant?.tenant_id}/artists/${folder}/${fileName}`;

    const { error: uploadError } = await supabase.storage
      .from("artist-assets")
      .upload(filePath, file, { upsert: true });
    if (uploadError) throw uploadError;

    const { data: signedData, error: signedError } = await supabase.storage
      .from("artist-assets")
      .createSignedUrl(filePath, 60 * 60 * 24 * 365); // 1 year for artist assets
    if (signedError) throw signedError;
    return signedData.signedUrl;
  };

  const uploadToDrive = async (file: File, artistName: string, field: string) => {
    try {
      const reader = new FileReader();
      const base64Content = await new Promise<string>((resolve, reject) => {
        reader.onload = () => {
          const result = reader.result as string;
          const base64 = result.split(",")[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData?.session?.access_token;
      if (!token) return;

      const fieldLabels: Record<string, string> = {
        profile_image_url: "프로필",
        id_card_url: "신분증_원본",
        id_card_masked_url: "신분증_마스킹",
        signature_url: "서명",
      };

      const label = fieldLabels[field] || field;
      const ext = file.name.split(".").pop();
      const driveFileName = `${artistName}_${label}_${new Date().toISOString().slice(0, 10)}.${ext}`;

      await supabase.functions.invoke("upload-to-drive", {
        body: {
          tenantId: currentTenant?.tenant_id,
          fileName: driveFileName,
          fileContent: base64Content,
          mimeType: file.type,
          subfolder: `아티스트/${artistName}`,
        },
      });
    } catch (driveErr) {
      console.warn("Google Drive 업로드 실패 (무시):", driveErr);
    }
  };

  const handleSave = async () => {
    if (!formData.name) {
      toast.error("이름을 입력해주세요.");
      return;
    }
    setIsSaving(true);
    try {
      let finalData = { ...formData };
      const uploadedFiles: { file: File; field: string }[] = [];

      for (const [field, file] of Object.entries(tempFiles)) {
        const publicUrl = await uploadToStorage(file, field);
        (finalData as any)[field] = publicUrl;
        uploadedFiles.push({ file, field });
      }

      const { id, created_at, updated_at, ...cleanData } = finalData as any;
      const payload = { ...cleanData, tenant_id: currentTenant?.tenant_id, bio: formData.bio || "" };

      const { error } = currentArtist
        ? await supabase.from("artists").update(payload).eq("id", currentArtist.id)
        : await supabase.from("artists").insert([payload]);
      if (error) throw error;

      toast.success("저장되었습니다.");

      // Google Drive 자동 업로드 (백그라운드)
      if (uploadedFiles.length > 0) {
        toast.info("Google Drive에 파일 동기화 중...");
        const drivePromises = uploadedFiles.map(({ file, field }) =>
          uploadToDrive(file, formData.name || "unknown", field)
        );
        Promise.all(drivePromises).then(() => {
          toast.success("Google Drive 동기화 완료");
        }).catch(() => {
          toast.warning("일부 파일의 Drive 동기화에 실패했습니다.");
        });
      }

      setIsSheetOpen(false);
      setTempFiles({});
      setPreviews({});
      fetchArtists();
    } catch (e: any) {
      toast.error(`저장 실패: ${e.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDelete = async () => {
    if (!currentArtist) return;
    setIsSaving(true);
    const { error } = await supabase.from("artists").delete().eq("id", currentArtist.id);
    if (!error) {
      toast.success("삭제 완료");
      setIsDeleteDialogOpen(false);
      setIsSheetOpen(false);
      fetchArtists();
    }
    setIsSaving(false);
  };

  const handlePrint = () => {
    const printContent = printRef.current;
    if (!printContent) return;
    const win = window.open("", "", "height=800,width=1000");
    if (win) {
      win.document.write(
        "<html><head><title>Artist Profile</title><style>body{font-family:sans-serif;}</style></head><body>",
      );
      win.document.write(printContent.innerHTML);
      win.document.write("</body></html>");
      win.document.close();
      win.focus();
      setTimeout(() => {
        win.print();
        win.close();
      }, 500);
    }
  };

  if (!isCompanyAdmin) return <div className="p-20 text-center text-slate-400 font-bold">권한이 없습니다.</div>;

  return (
    <div className="min-h-screen bg-[#F1F5F9]">
      <Header />
      <main className="pt-24 pb-16 px-6 max-w-7xl mx-auto">
        {/* 헤더 */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              className="rounded-lg bg-white border border-slate-300 w-9 h-9"
              onClick={() => navigate("/admin")}
            >
              <ArrowLeft className="w-4 h-4 text-slate-600" />
            </Button>
            <div>
              <h1 className="text-xl font-black text-slate-900 tracking-tight flex items-center gap-2">
                배우 관리{" "}
                <Badge
                  variant="outline"
                  className="text-[9px] h-4 bg-indigo-50 border-indigo-200 text-indigo-600 font-black uppercase"
                >
                  Talent DB
                </Badge>
              </h1>
              <p className="text-slate-500 text-[11px] font-bold">아티스트 프로필 및 계약 증빙 통합 관리</p>
            </div>
          </div>
          <Button
            onClick={() => {
              setCurrentArtist(null);
              setFormData({ name: "", stage_name: "", birth_date: "", gender: "male", bio: "", is_active: true });
              setTempFiles({});
              setPreviews({});
              setIsSheetOpen(true);
            }}
            size="sm"
            className="bg-blue-600 h-9 font-bold px-5 rounded-lg shadow-md active:scale-95"
          >
            <Plus className="mr-1.5 w-4 h-4" /> 배우 등록
          </Button>
        </div>

        {/* 통계 */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          {[
            { label: "전체 아티스트", val: artists.length, icon: Star, color: "text-indigo-600", bg: "bg-indigo-50" },
            {
              label: "활동중",
              val: artists.filter((a) => a.is_active).length,
              icon: CheckCircle2,
              color: "text-emerald-600",
              bg: "bg-emerald-50",
            },
            {
              label: "비활동",
              val: artists.filter((a) => !a.is_active).length,
              icon: AlertCircle,
              color: "text-slate-400",
              bg: "bg-slate-50",
            },
            { label: "만료 임박", val: 0, icon: Calendar, color: "text-orange-600", bg: "bg-orange-50" },
          ].map((s, i) => (
            <Card key={i} className="border border-slate-300 shadow-sm bg-white overflow-hidden">
              <CardContent className="p-4 flex items-center gap-3">
                <div className={`w-10 h-10 rounded-lg ${s.bg} flex items-center justify-center ${s.color}`}>
                  <s.icon size={20} />
                </div>
                <div>
                  <p className="text-[9px] font-black text-slate-400 uppercase">{s.label}</p>
                  <p className="text-lg font-black text-slate-800">{s.val}</p>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="mb-6 relative group">
          <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500" />
          <Input
            placeholder="이름 또는 활동명 검색..."
            className="pl-10 h-10 rounded-lg border border-slate-300 bg-white text-xs font-medium"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>

        {/* 아티스트 그리드 */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
          {artists
            .filter((a) => a.name.includes(searchQuery))
            .map((artist) => (
              <Card
                key={artist.id}
                className="border border-slate-300 shadow-sm overflow-hidden bg-white hover:border-blue-500 transition-all cursor-pointer group"
                onClick={() => {
                  setCurrentArtist(artist);
                  setFormData(artist);
                  setTempFiles({});
                  setPreviews({});
                  setIsSheetOpen(true);
                }}
              >
                <div className="aspect-[3/4] bg-slate-100 relative overflow-hidden">
                  {artist.profile_image_url ? (
                    <img
                      src={artist.profile_image_url}
                      className="w-full h-full object-cover transition-transform group-hover:scale-105"
                      alt={artist.name}
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-slate-300">
                      <UserCircle size={48} />
                    </div>
                  )}
                  <Badge
                    className={`absolute top-2 left-2 ${artist.is_active ? "bg-emerald-500" : "bg-slate-400"} border-none text-[8px] h-4 font-black`}
                  >
                    {artist.is_active ? "ACTIVE" : "INACTIVE"}
                  </Badge>
                </div>
                <div className="p-3">
                  <p className="font-black text-slate-800 text-sm tracking-tight">{artist.name}</p>
                  <p className="text-[10px] font-bold text-blue-600">{artist.stage_name || "-"}</p>
                </div>
              </Card>
            ))}
        </div>
      </main>

      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className="sm:max-w-4xl p-0 flex flex-col bg-[#F8FAFC]">
          <SheetHeader className="p-4 border-b bg-white flex flex-row items-center justify-between">
            <SheetTitle className="text-md font-black flex items-center gap-2">
              <Star size={18} className="text-indigo-500" /> {currentArtist ? "아티스트 정보 수정" : "신규 등록"}
            </SheetTitle>
            <SheetDescription className="hidden">에디터</SheetDescription>
            <div className="flex items-center gap-3 mr-8">
              <Label className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Status</Label>
              <Switch
                checked={formData.is_active}
                onCheckedChange={(v) => setFormData({ ...formData, is_active: v })}
              />
            </div>
          </SheetHeader>

          <ScrollArea className="flex-1 p-6">
            <div className="space-y-8 pb-10">
              <div className="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div className="md:col-span-3">
                  <Label className="text-[10px] font-black text-slate-400 uppercase mb-2 block">Profile Image</Label>
                  <div
                    onClick={() => fileInputRefs.profile.current?.click()}
                    className="aspect-[3/4] bg-white border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all overflow-hidden relative"
                  >
                    {previews.profile_image_url || formData.profile_image_url ? (
                      <img
                        src={previews.profile_image_url || formData.profile_image_url || ""}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <UploadCloud className="text-slate-300" />
                    )}
                    <input
                      type="file"
                      ref={fileInputRefs.profile}
                      className="hidden"
                      accept="image/*"
                      onChange={(e) => handleFileChange(e, "profile_image_url")}
                    />
                  </div>
                </div>
                <div className="md:col-span-9 grid grid-cols-2 gap-4">
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">본명 *</Label>
                    <Input
                      value={formData.name || ""}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className="h-9 text-sm font-bold border-slate-300"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">활동명</Label>
                    <Input
                      value={formData.stage_name || ""}
                      onChange={(e) => setFormData({ ...formData, stage_name: e.target.value })}
                      className="h-9 text-sm font-bold border-slate-300"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">생년월일</Label>
                    <Input
                      type="date"
                      value={formData.birth_date || ""}
                      onChange={(e) => setFormData({ ...formData, birth_date: e.target.value })}
                      className="h-9 border-slate-300"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">성별</Label>
                    <Select
                      value={formData.gender || "male"}
                      onValueChange={(v) => setFormData({ ...formData, gender: v })}
                    >
                      <SelectTrigger className="h-9 border-slate-300">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="male">남성</SelectItem>
                        <SelectItem value="female">여성</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">연락처</Label>
                    <div className="relative">
                      <Phone size={12} className="absolute left-3 top-2.5 text-slate-400" />
                      <Input
                        value={formData.contact_phone || ""}
                        onChange={(e) => setFormData({ ...formData, contact_phone: e.target.value })}
                        className="h-9 pl-8 border-slate-300"
                      />
                    </div>
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">이메일</Label>
                    <div className="relative">
                      <Mail size={12} className="absolute left-3 top-2.5 text-slate-400" />
                      <Input
                        value={formData.email || ""}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        className="h-9 pl-8 border-slate-300"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <Separator className="bg-slate-200" />

              <div className="space-y-4">
                <h4 className="text-xs font-black flex items-center gap-2 text-slate-700 uppercase">
                  <Shield size={14} className="text-blue-500" /> Personal & Confidential
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">주민등록번호</Label>
                    <Input
                      value={formData.resident_number || ""}
                      onChange={(e) => setFormData({ ...formData, resident_number: e.target.value })}
                      className="h-9 font-mono tracking-widest border-slate-300"
                      placeholder="000000-0000000"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-[10px] font-black uppercase text-slate-500">거주지 주소</Label>
                    <div className="relative">
                      <MapPin size={12} className="absolute left-3 top-2.5 text-slate-400" />
                      <Input
                        value={formData.address || ""}
                        onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                        className="h-9 pl-8 border-slate-300"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <Separator className="bg-slate-200" />

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="space-y-4">
                  <h4 className="text-xs font-black flex items-center gap-2 text-slate-700 uppercase">
                    <Briefcase size={14} className="text-orange-500" /> Contract Info
                  </h4>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="space-y-1">
                      <Label className="text-[10px] text-slate-500 font-bold uppercase">Start</Label>
                      <Input
                        type="date"
                        value={formData.contract_start_date || ""}
                        onChange={(e) => setFormData({ ...formData, contract_start_date: e.target.value })}
                        className="h-9 border-slate-300"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-[10px] text-slate-500 font-bold uppercase">End</Label>
                      <Input
                        type="date"
                        value={formData.contract_end_date || ""}
                        onChange={(e) => setFormData({ ...formData, contract_end_date: e.target.value })}
                        className="h-9 border-slate-300"
                      />
                    </div>
                  </div>
                </div>
                <div className="space-y-4">
                  <h4 className="text-xs font-black flex items-center gap-2 text-slate-700 uppercase">
                    <Globe size={14} className="text-emerald-500" /> Social Links
                  </h4>
                  <div className="space-y-2">
                    <div className="relative">
                      <Instagram size={12} className="absolute left-3 top-2.5 text-pink-500" />
                      <Input
                        value={formData.instagram_url || ""}
                        onChange={(e) => setFormData({ ...formData, instagram_url: e.target.value })}
                        className="h-8 pl-8 text-xs border-slate-300"
                        placeholder="Instagram URL"
                      />
                    </div>
                    <div className="relative">
                      <Youtube size={12} className="absolute left-3 top-2.5 text-red-500" />
                      <Input
                        value={formData.youtube_url || ""}
                        onChange={(e) => setFormData({ ...formData, youtube_url: e.target.value })}
                        className="h-8 pl-8 text-xs border-slate-300"
                        placeholder="YouTube URL"
                      />
                    </div>
                    <div className="relative">
                      <span className="absolute left-3 top-1.5 text-[9px] font-black text-green-600">N</span>
                      <Input
                        value={formData.namuwiki_url || ""}
                        onChange={(e) => setFormData({ ...formData, namuwiki_url: e.target.value })}
                        className="h-8 pl-8 text-xs border-slate-300"
                        placeholder="Namuwiki URL"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label className="text-[10px] font-black uppercase text-slate-500">아티스트 소개 (Bio)</Label>
                <Textarea
                  value={formData.bio || ""}
                  onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                  className="min-h-[80px] text-xs leading-relaxed border-slate-300"
                />
              </div>

              <Separator className="bg-slate-200" />

              <div className="space-y-4">
                <h4 className="text-xs font-black flex items-center gap-2 text-slate-700 uppercase">
                  <FileImage size={14} className="text-blue-500" /> Documents & Signature
                </h4>
                <div className="grid grid-cols-3 gap-4">
                  {[
                    { label: "신분증 원본", field: "id_card_url", ref: fileInputRefs.idCard },
                    { label: "신분증(마스킹)", field: "id_card_masked_url", ref: fileInputRefs.idMasked },
                    { label: "자필 서명", field: "signature_url", ref: fileInputRefs.signature },
                  ].map((f, i) => (
                    <div key={i} className="space-y-1">
                      <Label className="text-[9px] font-bold text-slate-400 uppercase">{f.label}</Label>
                      <div
                        onClick={() => (f.ref.current as any)?.click()}
                        className="h-24 bg-white border border-slate-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-slate-50 relative overflow-hidden transition-all"
                      >
                        {previews[f.field] || (formData as any)[f.field] ? (
                          <img
                            src={previews[f.field] || (formData as any)[f.field]}
                            className="h-full object-contain p-1"
                            alt={f.label}
                          />
                        ) : (
                          <UploadCloud size={16} className="text-slate-300" />
                        )}
                        <input
                          type="file"
                          ref={f.ref as any}
                          className="hidden"
                          accept="image/*,application/pdf"
                          onChange={(e) => handleFileChange(e, f.field)}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </ScrollArea>

          <div className="hidden">
            <div ref={printRef}>
              <ArtistProfileDocument data={formData} tenantName={currentTenant?.tenant.name || ""} />
            </div>
          </div>

          <SheetFooter className="p-4 border-t bg-white flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={handlePrint}
              className="h-9 px-4 font-black text-[10px] uppercase tracking-tighter"
            >
              <Printer size={14} className="mr-1.5" /> Export PDF
            </Button>
            <div className="flex-1" />
            <SheetClose asChild>
              <Button variant="ghost" size="sm" className="font-bold text-xs text-slate-500">
                취소
              </Button>
            </SheetClose>
            {currentArtist && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setIsDeleteDialogOpen(true)}
                className="text-rose-500 font-bold text-xs hover:bg-rose-50"
              >
                삭제
              </Button>
            )}
            <Button
              onClick={handleSave}
              disabled={isSaving}
              size="sm"
              className="bg-blue-600 px-8 font-bold text-xs min-w-[100px]"
            >
              {isSaving ? <Loader2 className="animate-spin w-3.5 h-3.5 mr-1.5" /> : null}
              {isSaving ? "저장중" : "정보 저장"}
            </Button>
          </SheetFooter>
        </SheetContent>
      </Sheet>

      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent className="rounded-[2rem] border-none shadow-2xl p-8">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-rose-600 font-black flex items-center gap-2 text-xl">
              <Trash2 size={24} /> 데이터 영구 삭제
            </AlertDialogTitle>
            <AlertDialogDescription className="py-4 font-bold text-slate-500 leading-relaxed italic">
              "{currentArtist?.name}" 아티스트의 모든 정보와 증빙 서류가 삭제됩니다. 계속하시겠습니까?
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="flex gap-2">
            <AlertDialogCancel className="rounded-xl font-bold flex-1 border-slate-300">취소</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              className="bg-rose-600 hover:bg-rose-700 rounded-xl font-bold flex-1"
            >
              삭제 확정
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default ArtistManagement;



============================================================
File Path: src/pages/admin/AttendanceManagement.tsx
============================================================
import React, { useState, useEffect, useCallback } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Clock, LogIn, LogOut, Calendar, ChevronLeft, ChevronRight, Edit2, TrendingUp, AlertTriangle, Gift } from "lucide-react";
import { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameDay, addMonths, subMonths, isToday, startOfWeek, getISOWeek } from "date-fns";
import { ko } from "date-fns/locale";
import { cn } from "@/lib/utils";

interface AttendanceRecord {
  id: string;
  user_id: string;
  tenant_id: string;
  date: string;
  clock_in: string | null;
  clock_out: string | null;
  clock_in_method: string;
  clock_out_method: string;
  memo: string | null;
}

interface MonthlyWorkData {
  work_date: string;
  hours_worked: number;
  clock_in_time: string | null;
  clock_out_time: string | null;
  clock_out_method: string | null;
}

const STANDARD_WEEKLY_HOURS = 40;

const AttendanceManagement = () => {
  const { user, currentTenant } = useAuth();
  const [todayRecord, setTodayRecord] = useState<AttendanceRecord | null>(null);
  const [monthRecords, setMonthRecords] = useState<AttendanceRecord[]>([]);
  const [monthlyWorkData, setMonthlyWorkData] = useState<MonthlyWorkData[]>([]);
  const [weeklyHours, setWeeklyHours] = useState<number>(0);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [loading, setLoading] = useState(true);
  const [editingMemo, setEditingMemo] = useState(false);
  const [memo, setMemo] = useState("");

  const tenantId = currentTenant?.tenant_id;
  const todayStr = format(new Date(), "yyyy-MM-dd");

  const fetchTodayRecord = useCallback(async () => {
    if (!user || !tenantId) return;
    const { data } = await supabase
      .from("attendance_records")
      .select("*")
      .eq("user_id", user.id)
      .eq("tenant_id", tenantId)
      .eq("date", todayStr)
      .maybeSingle();
    setTodayRecord(data as AttendanceRecord | null);
    if (data?.memo) setMemo(data.memo);
  }, [user, tenantId, todayStr]);

  const fetchMonthRecords = useCallback(async () => {
    if (!user || !tenantId) return;
    const start = format(startOfMonth(currentMonth), "yyyy-MM-dd");
    const end = format(endOfMonth(currentMonth), "yyyy-MM-dd");
    const { data } = await supabase
      .from("attendance_records")
      .select("*")
      .eq("user_id", user.id)
      .eq("tenant_id", tenantId)
      .gte("date", start)
      .lte("date", end)
      .order("date", { ascending: true });
    setMonthRecords((data || []) as AttendanceRecord[]);
  }, [user, tenantId, currentMonth]);

  const fetchWeeklyHours = useCallback(async () => {
    if (!user || !tenantId) return;
    const weekStart = startOfWeek(new Date(), { weekStartsOn: 1 });
    const { data, error } = await (supabase.rpc as any)("get_weekly_work_hours", {
      _user_id: user.id,
      _tenant_id: tenantId,
      _week_start: format(weekStart, "yyyy-MM-dd"),
    });
    if (!error && data !== null) setWeeklyHours(Number(data));
  }, [user, tenantId]);

  const fetchMonthlyWorkData = useCallback(async () => {
    if (!user || !tenantId) return;
    const { data, error } = await (supabase.rpc as any)("get_monthly_work_hours", {
      _user_id: user.id,
      _tenant_id: tenantId,
      _year: currentMonth.getFullYear(),
      _month: currentMonth.getMonth() + 1,
    });
    if (!error && data) setMonthlyWorkData(data as MonthlyWorkData[]);
  }, [user, tenantId, currentMonth]);

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      await Promise.all([fetchTodayRecord(), fetchMonthRecords(), fetchWeeklyHours(), fetchMonthlyWorkData()]);
      setLoading(false);
    };
    load();
  }, [fetchTodayRecord, fetchMonthRecords, fetchWeeklyHours, fetchMonthlyWorkData]);

  const handleClockIn = async () => {
    if (!user || !tenantId) return;
    const now = new Date().toISOString();
    const { error } = await supabase.from("attendance_records").upsert({
      user_id: user.id,
      tenant_id: tenantId,
      date: todayStr,
      clock_in: now,
      clock_in_method: "manual",
    }, { onConflict: "user_id,tenant_id,date" });
    if (error) {
      toast.error("출근 기록 실패: " + error.message);
    } else {
      toast.success("출근이 기록되었습니다.");
      await Promise.all([fetchTodayRecord(), fetchMonthRecords(), fetchWeeklyHours(), fetchMonthlyWorkData()]);
    }
  };

  const handleClockOut = async () => {
    if (!user || !tenantId || !todayRecord) return;
    const now = new Date().toISOString();
    const { error } = await supabase
      .from("attendance_records")
      .update({ clock_out: now, clock_out_method: "manual" })
      .eq("id", todayRecord.id);
    if (error) {
      toast.error("퇴근 기록 실패: " + error.message);
    } else {
      toast.success("퇴근이 기록되었습니다.");
      await Promise.all([fetchTodayRecord(), fetchMonthRecords(), fetchWeeklyHours(), fetchMonthlyWorkData()]);
    }
  };

  const handleSaveMemo = async () => {
    if (!todayRecord) return;
    const { error } = await supabase
      .from("attendance_records")
      .update({ memo })
      .eq("id", todayRecord.id);
    if (error) toast.error("메모 저장 실패");
    else {
      toast.success("메모가 저장되었습니다.");
      setEditingMemo(false);
      await fetchTodayRecord();
    }
  };

  const formatTime = (iso: string | null) => {
    if (!iso) return "--:--";
    return format(new Date(iso), "HH:mm");
  };

  const getWorkHours = (record: AttendanceRecord) => {
    if (!record.clock_in || !record.clock_out) return null;
    const diff = new Date(record.clock_out).getTime() - new Date(record.clock_in).getTime();
    const hours = Math.floor(diff / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    return `${hours}시간 ${mins}분`;
  };

  const totalMonthlyHours = monthlyWorkData.reduce((sum, d) => sum + (d.hours_worked || 0), 0);
  const overtimeHours = Math.max(0, weeklyHours - STANDARD_WEEKLY_HOURS);
  const weeklyProgress = Math.min((weeklyHours / STANDARD_WEEKLY_HOURS) * 100, 100);

  const days = eachDayOfInterval({
    start: startOfMonth(currentMonth),
    end: endOfMonth(currentMonth),
  });

  const getRecordForDay = (day: Date) =>
    monthRecords.find((r) => isSameDay(new Date(r.date + "T00:00:00"), day));

  const getWorkDataForDay = (day: Date) =>
    monthlyWorkData.find((d) => isSameDay(new Date(d.work_date + "T00:00:00"), day));

  const getStatusBadge = (record: AttendanceRecord | undefined) => {
    if (!record) return null;
    if (record.clock_in && record.clock_out) return <Badge className="bg-emerald-100 text-emerald-700 text-[10px]">완료</Badge>;
    if (record.clock_in && !record.clock_out) return <Badge className="bg-amber-100 text-amber-700 text-[10px]">근무중</Badge>;
    return null;
  };

  const getMethodLabel = (method: string | null) => {
    if (!method) return "";
    switch (method) {
      case "popup": return "자동(팝업)";
      case "schedule": return "일정연동";
      case "auto": return "자동(18시)";
      default: return "수동";
    }
  };

  if (loading) {
    return <div className="p-12 text-center text-muted-foreground">로딩 중...</div>;
  }

  return (
    <div className="p-6 md:p-10 max-w-6xl mx-auto animate-in fade-in duration-500 space-y-8">
      {/* 헤더 */}
      <div className="flex items-center gap-3">
        <div className="p-2.5 rounded-2xl bg-amber-500 text-white">
          <Clock className="w-6 h-6" />
        </div>
        <div>
          <h1 className="text-2xl font-black text-foreground tracking-tight">출퇴근 관리</h1>
          <p className="text-sm text-muted-foreground">일일 근태를 기록하고 근무시간을 관리합니다.</p>
        </div>
      </div>

      {/* 주간 근무시간 통계 */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card className="rounded-2xl border-none shadow-md bg-gradient-to-br from-blue-50 to-indigo-50">
          <CardContent className="p-6 text-center">
            <TrendingUp className="w-6 h-6 mx-auto text-blue-600 mb-2" />
            <p className="text-xs text-muted-foreground font-semibold uppercase tracking-wider">이번 주 근무</p>
            <p className="text-3xl font-black text-foreground mt-1">{weeklyHours.toFixed(1)}<span className="text-sm font-medium text-muted-foreground">h</span></p>
            <div className="mt-3 h-2 bg-blue-100 rounded-full overflow-hidden">
              <div className="h-full bg-blue-600 rounded-full transition-all" style={{ width: `${weeklyProgress}%` }} />
            </div>
            <p className="text-[10px] text-muted-foreground mt-1">{STANDARD_WEEKLY_HOURS}시간 기준 {weeklyProgress.toFixed(0)}%</p>
          </CardContent>
        </Card>

        <Card className={cn("rounded-2xl border-none shadow-md", overtimeHours > 0 ? "bg-gradient-to-br from-rose-50 to-orange-50" : "bg-gradient-to-br from-emerald-50 to-green-50")}>
          <CardContent className="p-6 text-center">
            {overtimeHours > 0 ? <AlertTriangle className="w-6 h-6 mx-auto text-rose-600 mb-2" /> : <Clock className="w-6 h-6 mx-auto text-emerald-600 mb-2" />}
            <p className="text-xs text-muted-foreground font-semibold uppercase tracking-wider">주간 초과근무</p>
            <p className={cn("text-3xl font-black mt-1", overtimeHours > 0 ? "text-rose-600" : "text-emerald-600")}>{overtimeHours.toFixed(1)}<span className="text-sm font-medium text-muted-foreground">h</span></p>
            {overtimeHours > 0 && <p className="text-[10px] text-rose-500 mt-1">보상휴가 대상</p>}
          </CardContent>
        </Card>

        <Card className="rounded-2xl border-none shadow-md bg-gradient-to-br from-violet-50 to-purple-50">
          <CardContent className="p-6 text-center">
            <Gift className="w-6 h-6 mx-auto text-violet-600 mb-2" />
            <p className="text-xs text-muted-foreground font-semibold uppercase tracking-wider">이번 달 총 근무</p>
            <p className="text-3xl font-black text-foreground mt-1">{totalMonthlyHours.toFixed(1)}<span className="text-sm font-medium text-muted-foreground">h</span></p>
            <p className="text-[10px] text-muted-foreground mt-1">{monthlyWorkData.length}일 출근</p>
          </CardContent>
        </Card>
      </div>

      {/* 오늘의 출퇴근 카드 */}
      <Card className="rounded-[2rem] border-none shadow-xl bg-gradient-to-br from-amber-50 to-orange-50">
        <CardHeader className="pb-2">
          <CardTitle className="text-lg font-bold flex items-center gap-2">
            <Calendar className="w-5 h-5 text-amber-600" />
            오늘의 근태 — {format(new Date(), "yyyy년 M월 d일 (EEEE)", { locale: ko })}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm text-center space-y-3">
              <LogIn className="w-8 h-8 mx-auto text-blue-500" />
              <p className="text-sm text-muted-foreground font-medium">출근 시간</p>
              <p className="text-3xl font-black text-foreground">{formatTime(todayRecord?.clock_in ?? null)}</p>
              {todayRecord?.clock_in && (
                <Badge variant="outline" className="text-[10px]">{getMethodLabel(todayRecord.clock_in_method)}</Badge>
              )}
              {!todayRecord?.clock_in && (
                <Button onClick={handleClockIn} className="w-full rounded-xl bg-blue-600 hover:bg-blue-700">
                  <LogIn className="w-4 h-4 mr-2" /> 출근하기
                </Button>
              )}
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm text-center space-y-3">
              <LogOut className="w-8 h-8 mx-auto text-rose-500" />
              <p className="text-sm text-muted-foreground font-medium">퇴근 시간</p>
              <p className="text-3xl font-black text-foreground">{formatTime(todayRecord?.clock_out ?? null)}</p>
              {todayRecord?.clock_out && (
                <Badge variant="outline" className="text-[10px]">{getMethodLabel(todayRecord.clock_out_method)}</Badge>
              )}
              {todayRecord?.clock_in && !todayRecord?.clock_out && (
                <Button onClick={handleClockOut} variant="outline" className="w-full rounded-xl border-rose-300 text-rose-600 hover:bg-rose-50">
                  <LogOut className="w-4 h-4 mr-2" /> 퇴근하기
                </Button>
              )}
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm text-center space-y-3">
              <Clock className="w-8 h-8 mx-auto text-emerald-500" />
              <p className="text-sm text-muted-foreground font-medium">총 근무시간</p>
              <p className="text-3xl font-black text-foreground">{todayRecord ? (getWorkHours(todayRecord) || "근무 중") : "--"}</p>
              {!todayRecord?.clock_out && todayRecord?.clock_in && (
                <p className="text-xs text-muted-foreground">퇴근 미기록 시 18:00 또는 일정 종료시간 자동 처리</p>
              )}
            </div>
          </div>

          {todayRecord && (
            <div className="bg-white rounded-2xl p-4 shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <p className="text-sm font-semibold text-muted-foreground">메모</p>
                {!editingMemo && (
                  <Button variant="ghost" size="sm" onClick={() => setEditingMemo(true)}>
                    <Edit2 className="w-3 h-3 mr-1" /> 수정
                  </Button>
                )}
              </div>
              {editingMemo ? (
                <div className="flex gap-2">
                  <Input value={memo} onChange={(e) => setMemo(e.target.value)} placeholder="오늘의 업무 메모..." className="rounded-xl" />
                  <Button onClick={handleSaveMemo} size="sm" className="rounded-xl">저장</Button>
                  <Button onClick={() => setEditingMemo(false)} size="sm" variant="ghost" className="rounded-xl">취소</Button>
                </div>
              ) : (
                <p className="text-sm text-foreground">{todayRecord.memo || "메모 없음"}</p>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* 월간 근무 로그 테이블 */}
      <Card className="rounded-[2rem] border-none shadow-lg">
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-lg font-bold">월간 근무 로그</CardTitle>
            <div className="flex items-center gap-2">
              <Button variant="ghost" size="icon" onClick={() => setCurrentMonth(subMonths(currentMonth, 1))}>
                <ChevronLeft className="w-4 h-4" />
              </Button>
              <span className="font-bold text-foreground min-w-[120px] text-center">{format(currentMonth, "yyyy년 M월", { locale: ko })}</span>
              <Button variant="ghost" size="icon" onClick={() => setCurrentMonth(addMonths(currentMonth, 1))}>
                <ChevronRight className="w-4 h-4" />
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {/* 상세 로그 테이블 */}
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b text-muted-foreground">
                  <th className="text-left py-3 px-2 font-semibold">날짜</th>
                  <th className="text-center py-3 px-2 font-semibold">출근</th>
                  <th className="text-center py-3 px-2 font-semibold">퇴근</th>
                  <th className="text-center py-3 px-2 font-semibold">퇴근 방식</th>
                  <th className="text-right py-3 px-2 font-semibold">근무시간</th>
                </tr>
              </thead>
              <tbody>
                {monthlyWorkData.length === 0 ? (
                  <tr><td colSpan={5} className="text-center py-8 text-muted-foreground">이번 달 출근 기록이 없습니다.</td></tr>
                ) : monthlyWorkData.map((d) => (
                  <tr key={d.work_date} className={cn("border-b last:border-none hover:bg-muted/30 transition-colors", isSameDay(new Date(d.work_date + "T00:00:00"), new Date()) && "bg-amber-50/50")}>
                    <td className="py-3 px-2 font-medium">{format(new Date(d.work_date + "T00:00:00"), "M/d (EEE)", { locale: ko })}</td>
                    <td className="py-3 px-2 text-center">{formatTime(d.clock_in_time)}</td>
                    <td className="py-3 px-2 text-center">{formatTime(d.clock_out_time)}</td>
                    <td className="py-3 px-2 text-center">
                      <Badge variant="outline" className="text-[10px]">{getMethodLabel(d.clock_out_method)}</Badge>
                    </td>
                    <td className="py-3 px-2 text-right font-bold">
                      <span className={cn(d.hours_worked > 9 ? "text-rose-600" : "text-foreground")}>
                        {d.hours_worked.toFixed(1)}h
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
              {monthlyWorkData.length > 0 && (
                <tfoot>
                  <tr className="border-t-2 font-bold">
                    <td colSpan={4} className="py-3 px-2 text-right text-muted-foreground">월간 합계</td>
                    <td className="py-3 px-2 text-right text-lg">{totalMonthlyHours.toFixed(1)}h</td>
                  </tr>
                </tfoot>
              )}
            </table>
          </div>
        </CardContent>
      </Card>

      {/* 미니 캘린더 */}
      <Card className="rounded-[2rem] border-none shadow-lg">
        <CardHeader>
          <CardTitle className="text-lg font-bold">출근 캘린더</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-7 gap-1 mb-2">
            {["일", "월", "화", "수", "목", "금", "토"].map((d) => (
              <div key={d} className="text-center text-xs font-bold text-muted-foreground py-2">{d}</div>
            ))}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {Array.from({ length: startOfMonth(currentMonth).getDay() }).map((_, i) => (
              <div key={`empty-${i}`} className="h-16" />
            ))}
            {days.map((day) => {
              const record = getRecordForDay(day);
              const workData = getWorkDataForDay(day);
              const today = isToday(day);
              return (
                <div
                  key={day.toISOString()}
                  className={cn(
                    "h-16 rounded-xl p-1.5 text-xs border transition-colors",
                    today ? "border-amber-400 bg-amber-50/50" : "border-transparent hover:bg-muted/30",
                    record ? "bg-emerald-50/50" : ""
                  )}
                >
                  <div className="flex items-center justify-between mb-0.5">
                    <span className={cn("font-bold text-[11px]", today ? "text-amber-600" : day.getDay() === 0 ? "text-rose-500" : day.getDay() === 6 ? "text-blue-500" : "text-foreground")}>
                      {format(day, "d")}
                    </span>
                    {getStatusBadge(record)}
                  </div>
                  {workData && (
                    <p className="text-[10px] font-semibold text-muted-foreground">{workData.hours_worked.toFixed(1)}h</p>
                  )}
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default AttendanceManagement;



============================================================
File Path: src/pages/admin/CompanyManagement.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { 
  Building, Save, Globe, MessageSquare, ShieldCheck, Loader2, ArrowLeft, 
  CreditCard, Landmark, FileText, Image as ImageIcon, 
  User, UploadCloud, Edit2, FileCheck, FileDown, ExternalLink
} from "lucide-react";
import { Header } from "@/components/landing/Header";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Separator } from "@/components/ui/separator";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { useNavigate } from "react-router-dom";

const CompanyManagement = () => {
  const { currentTenant } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // 파일 업로드 참조용 Ref
  const logoRef = useRef<HTMLInputElement>(null);
  const sealRef = useRef<HTMLInputElement>(null);
  const signatureRef = useRef<HTMLInputElement>(null);

  const [formData, setFormData] = useState({
    name: "", rep_name: "", biz_number: "", corp_number: "", address: "", zip_code: "",
    biz_type: "", biz_item: "", pr_intro: "", naver_id: "", daum_id: "", contact_email: "",
    bank_name_kr: "", account_number_kr: "", account_holder_kr: "",
    bank_name_en: "", account_number_en: "", account_name_en: "", swift_code: "",
    branch_name_en: "", bank_address_en: "", rep_home_address: "", rep_resident_number: "",
    // 이미지용 URL (직접 업로드 후 생성됨)
    logo_url: "", seal_url: "", signature_url: "",
    // 서류용 URL (구글 드라이브 링크 입력)
    biz_reg_doc_url: "", bank_copy_kr_url: "", bank_copy_en_url: ""
  });

  useEffect(() => {
    const fetchCompanyData = async () => {
      if (!currentTenant) return;
      setLoading(true);
      const { data, error } = await supabase.from("tenants").select("*").eq("id", currentTenant.tenant_id).single();
      if (data) {
        const sanitizedData = Object.keys(data).reduce((acc: any, key) => {
          acc[key] = data[key] === null ? "" : data[key];
          return acc;
        }, {});
        setFormData(prev => ({ ...prev, ...sanitizedData, contact_email: data.tax_email || "" }));
      }
      setLoading(false);
    };
    fetchCompanyData();
  }, [currentTenant]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { id, value } = e.target;
    setFormData(prev => ({ ...prev, [id]: value }));
  };

  // --- [핵심] 이미지 직접 업로드 핸들러 ---
  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>, fieldName: string) => {
    const file = e.target.files?.[0];
    if (!file || !currentTenant) return;

    setSaving(true);
    try {
      const fileExt = file.name.split('.').pop();
      // 경로를 [테넌트ID/파일명] 구조로 단순화하여 생성
      const filePath = `${currentTenant.tenant_id}/${fieldName}_${Date.now()}.${fileExt}`;

      const { error: uploadError } = await supabase.storage
        .from('tenant-assets') // 버킷 이름 확인
        .upload(filePath, file, {
          upsert: true // 동일 파일이 있어도 덮어쓰기 허용
        });

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage
        .from('tenant-assets')
        .getPublicUrl(filePath);

      setFormData(prev => ({ ...prev, [fieldName]: publicUrl }));
      toast.success("파일이 성공적으로 업로드되었습니다.");
    } catch (error: any) {
      console.error("Storage Error:", error);
      toast.error(`업로드 실패: ${error.message}. 버킷이 존재하고 Public으로 설정되어 있는지 확인하세요.`);
    } finally {
      setSaving(false);
    }
  };

  const handleSave = async () => {
    if (!currentTenant) return;
    setSaving(true);
    try {
      // DB 컬럼명과 정확히 일치하는 데이터만 추출하여 전송
      const { error } = await supabase
        .from("tenants")
        .update({
          name: formData.name,
          rep_name: formData.rep_name,
          biz_number: formData.biz_number,
          corp_number: formData.corp_number,
          address: formData.address,
          zip_code: formData.zip_code,
          biz_type: formData.biz_type,
          biz_item: formData.biz_item,
          tax_email: formData.contact_email, // 매핑 주의
          pr_intro: formData.pr_intro,
          naver_id: formData.naver_id,
          daum_id: formData.daum_id,
          bank_name_kr: formData.bank_name_kr,
          account_number_kr: formData.account_number_kr,
          account_holder_kr: formData.account_holder_kr,
          bank_name_en: formData.bank_name_en,
          account_number_en: formData.account_number_en,
          account_name_en: formData.account_name_en,
          swift_code: formData.swift_code,
          branch_name_en: formData.branch_name_en,
          bank_address_en: formData.bank_address_en,
          rep_home_address: formData.rep_home_address,
          rep_resident_number: formData.rep_resident_number,
          logo_url: formData.logo_url,
          seal_url: formData.seal_url,
          signature_url: formData.signature_url,
          biz_reg_doc_url: formData.biz_reg_doc_url,
          bank_copy_kr_url: formData.bank_copy_kr_url,
          bank_copy_en_url: formData.bank_copy_en_url,
          updated_at: new Date().toISOString()
        })
        .eq("id", currentTenant.tenant_id);

      if (error) throw error;
      toast.success("회사 정보가 성공적으로 업데이트되었습니다.");
    } catch (error: any) {
      console.error("Save Error:", error);
      toast.error(`저장 실패: ${error.message}`);
    } finally {
      setSaving(false);
    }
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-primary w-10 h-10" /></div>;

  return (
    <div className="min-h-screen bg-slate-50/50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}><ArrowLeft className="w-5 h-5" /></Button>
            <div>
              <h1 className="text-3xl font-bold tracking-tight">회사 정보 및 자산 관리</h1>
              <p className="text-slate-500 font-medium">사업자 정보 및 금융/인감 데이터를 통합 관리합니다.</p>
            </div>
          </div>
          <Button onClick={handleSave} disabled={saving} className="gap-2 px-10 h-12 text-md font-bold shadow-lg">
            {saving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
            설정 저장하기
          </Button>
        </div>

        <Tabs defaultValue="basic" className="space-y-6">
          <TabsList className="bg-white border p-1 h-12 shadow-sm inline-flex w-full md:w-auto">
            <TabsTrigger value="basic" className="px-6">사업자 기본정보</TabsTrigger>
            <TabsTrigger value="finance" className="px-6">금융 및 인보이스</TabsTrigger>
            <TabsTrigger value="assets" className="px-6 font-bold text-blue-600">인감 및 증빙서류</TabsTrigger>
            <TabsTrigger value="pr" className="px-6">대외 홍보 설정</TabsTrigger>
          </TabsList>

          {/* 1. 기본 정보 탭 (기존과 동일) */}
          <TabsContent value="basic" className="space-y-6">
            <Card className="border-none shadow-sm">
              <CardHeader><CardTitle className="text-lg flex items-center gap-2"><FileText className="w-5 h-5 text-blue-500" /> 공식 사업자 등록 정보</CardTitle></CardHeader>
              <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="space-y-2"><Label>법인/상호명</Label><Input id="name" value={formData.name} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>사업자 등록번호</Label><Input id="biz_number" value={formData.biz_number} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>법인 등록번호</Label><Input id="corp_number" value={formData.corp_number} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>업태</Label><Input id="biz_type" value={formData.biz_type} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>종목</Label><Input id="biz_item" value={formData.biz_item} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>우편번호</Label><Input id="zip_code" value={formData.zip_code} onChange={handleChange} /></div>
                <div className="md:col-span-3 space-y-2"><Label>사업장 소재지 (도로명)</Label><Input id="address" value={formData.address} onChange={handleChange} /></div>
              </CardContent>
            </Card>
            <Card className="border-none shadow-sm bg-blue-50/30">
              <CardHeader><CardTitle className="text-lg flex items-center gap-2"><User className="w-5 h-5 text-blue-600" /> 대표이사 상세 보안 정보</CardTitle></CardHeader>
              <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2"><Label>대표이사 성명</Label><Input id="rep_name" value={formData.rep_name} onChange={handleChange} /></div>
                <div className="space-y-2"><Label>주민/외국인 등록번호</Label><Input id="rep_resident_number" type="password" value={formData.rep_resident_number} onChange={handleChange} /></div>
                <div className="md:col-span-2 space-y-2"><Label>대표이사 거주지 주소</Label><Input id="rep_home_address" value={formData.rep_home_address} onChange={handleChange} /></div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* 2. 금융 정보 탭 (기존과 동일) */}
          <TabsContent value="finance" className="space-y-6">
            <Card className="border-none shadow-sm">
              <CardHeader><CardTitle className="text-lg flex items-center gap-2"><CreditCard className="w-5 h-5 text-green-600" /> 결제 및 인보이스 정보</CardTitle></CardHeader>
              <CardContent className="space-y-8">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="space-y-2"><Label>거래은행 (국문)</Label><Input id="bank_name_kr" value={formData.bank_name_kr} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label>계좌번호 (국문)</Label><Input id="account_number_kr" value={formData.account_number_kr} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label>예금주 (국문)</Label><Input id="account_holder_kr" value={formData.account_holder_kr} onChange={handleChange} /></div>
                </div>
                <Separator />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">BANK NAME (ENG)</Label><Input id="bank_name_en" value={formData.bank_name_en} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">ACCOUNT NAME (ENG)</Label><Input id="account_name_en" value={formData.account_name_en} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">ACCOUNT NUMBER</Label><Input id="account_number_en" value={formData.account_number_en} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">SWIFT CODE</Label><Input id="swift_code" value={formData.swift_code} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">BRANCH NAME</Label><Input id="branch_name_en" value={formData.branch_name_en} onChange={handleChange} /></div>
                  <div className="space-y-2"><Label className="text-slate-500 font-bold">BANK ADDRESS</Label><Input id="bank_address_en" value={formData.bank_address_en} onChange={handleChange} /></div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* 3. [핵심] 하이브리드 자산 탭 (업로드 + 링크) */}
          <TabsContent value="assets" className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {/* 이미지 업로드 영역 (서버 저장) */}
              <ImageAssetCard title="회사 CI / 로고" url={formData.logo_url} inputRef={logoRef} onUpload={(e) => handleImageUpload(e, 'logo_url')} />
              <ImageAssetCard title="법인 인감 (도장)" url={formData.seal_url} inputRef={sealRef} onUpload={(e) => handleImageUpload(e, 'seal_url')} isSquare />
              <ImageAssetCard title="대표자 서명" url={formData.signature_url} inputRef={signatureRef} onUpload={(e) => handleImageUpload(e, 'signature_url')} />

              {/* 문서 링크 영역 (드라이브 저장) */}
              <Card className="md:col-span-3 border-none shadow-sm bg-slate-900 text-white">
                <CardHeader>
                  <CardTitle className="text-sm font-bold flex items-center gap-2"><ShieldCheck className="w-4 h-4 text-blue-400" /> 외부 서류 보관함 (Google Drive Link)</CardTitle>
                </CardHeader>
                <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="space-y-2">
                    <Label className="text-slate-400">사업자등록증 사본 (링크)</Label>
                    <div className="flex gap-2"><Input id="biz_reg_doc_url" value={formData.biz_reg_doc_url} onChange={handleChange} className="bg-slate-800 border-slate-700 text-blue-300" />{formData.biz_reg_doc_url && <Button variant="secondary" size="icon" onClick={() => window.open(formData.biz_reg_doc_url)}><ExternalLink className="w-4 h-4" /></Button>}</div>
                  </div>
                  <div className="space-y-2">
                    <Label className="text-slate-400">통장사본 국문 (링크)</Label>
                    <div className="flex gap-2"><Input id="bank_copy_kr_url" value={formData.bank_copy_kr_url} onChange={handleChange} className="bg-slate-800 border-slate-700 text-blue-300" />{formData.bank_copy_kr_url && <Button variant="secondary" size="icon" onClick={() => window.open(formData.bank_copy_kr_url)}><ExternalLink className="w-4 h-4" /></Button>}</div>
                  </div>
                  <div className="space-y-2">
                    <Label className="text-slate-400">통장사본 영문 (링크)</Label>
                    <div className="flex gap-2"><Input id="bank_copy_en_url" value={formData.bank_copy_en_url} onChange={handleChange} className="bg-slate-800 border-slate-700 text-blue-300" />{formData.bank_copy_en_url && <Button variant="secondary" size="icon" onClick={() => window.open(formData.bank_copy_en_url)}><ExternalLink className="w-4 h-4" /></Button>}</div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>
          
          <TabsContent value="pr" className="space-y-6">
             <Card className="border-none shadow-sm"><CardHeader><CardTitle className="text-lg">보도자료 공식 소개문</CardTitle></CardHeader><CardContent><Textarea id="pr_intro" value={formData.pr_intro} onChange={handleChange} className="min-h-[200px]" placeholder="배포용 회사 소개문을 작성하십시오." /></CardContent></Card>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card className="border-none shadow-sm"><CardHeader className="pb-2"><CardTitle className="text-sm font-bold">네이버 인물정보 관리자 ID</CardTitle></CardHeader><CardContent><Input id="naver_id" value={formData.naver_id} onChange={handleChange} /></CardContent></Card>
                <Card className="border-none shadow-sm"><CardHeader className="pb-2"><CardTitle className="text-sm font-bold">다음 인물정보 관리자 ID</CardTitle></CardHeader><CardContent><Input id="daum_id" value={formData.daum_id} onChange={handleChange} /></CardContent></Card>
             </div>
          </TabsContent>
        </Tabs>
      </main>
    </div>
  );
};

// --- 서브 컴포넌트: 이미지 자산 카드 ---
const ImageAssetCard = ({ title, url, inputRef, onUpload, isSquare = false }: any) => (
  <Card className="border-none shadow-sm text-center bg-white">
    <CardHeader className="pb-2"><CardTitle className="text-xs font-bold text-slate-500 uppercase">{title}</CardTitle></CardHeader>
    <CardContent className="flex flex-col items-center gap-4">
      <div className="h-32 w-full border-2 border-dashed rounded-xl bg-slate-50 flex items-center justify-center relative overflow-hidden group hover:border-blue-400 transition-colors">
        {url ? (
          <img src={url} className={`h-full w-full object-contain p-2 ${isSquare ? 'max-w-[100px]' : ''}`} alt={title} />
        ) : (
          <UploadCloud className="text-slate-300 w-10 h-10" />
        )}
        <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onClick={() => inputRef.current?.click()}>
          <Edit2 className="text-white w-6 h-6" />
        </div>
        <input type="file" ref={inputRef} className="hidden" accept="image/*" onChange={onUpload} />
      </div>
    </CardContent>
  </Card>
);

export default CompanyManagement;


============================================================
File Path: src/pages/admin/CorporateCardManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import {
  CreditCard,
  ArrowLeft,
  Plus,
  Pencil,
  Trash2,
  Search,
  Plane,
  ImagePlus,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Switch } from "@/components/ui/switch";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { format } from "date-fns";

interface CorporateCard {
  id: string;
  card_number: string;
  card_name: string | null;
  card_company: string | null;
  card_type: string | null;
  card_holder_name: string | null;
  holder_user_id: string | null;
  monthly_limit: number | null;
  is_active: boolean;
  is_skypass: boolean | null;
  cvc: string | null;
  card_image_url: string | null;
  expiry_date: string | null;
  created_at: string;
}

interface TenantMember {
  user_id: string;
  profile: { full_name: string | null; email: string } | null;
}

const CARD_TYPES = ["일반", "하이패스", "클린카드"] as const;

const CorporateCardManagement = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();

  const [cards, setCards] = useState<CorporateCard[]>([]);
  const [members, setMembers] = useState<TenantMember[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");

  const [dialogOpen, setDialogOpen] = useState(false);
  const [editing, setEditing] = useState<CorporateCard | null>(null);
  const [form, setForm] = useState({
    card_number: "",
    card_name: "",
    card_company: "",
    card_type: "일반",
    card_holder_name: "",
    holder_user_id: "",
    monthly_limit: "",
    expiry_date: "",
    is_active: true,
    is_skypass: false,
    cvc: "",
    card_image_url: "",
  });
  const [imageFile, setImageFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);

  const [deleteTarget, setDeleteTarget] = useState<CorporateCard | null>(null);

  useEffect(() => {
    if (currentTenant) {
      fetchData();
      fetchMembers();
    }
  }, [currentTenant]);

  const fetchData = async () => {
    if (!currentTenant) return;
    setLoading(true);
    const { data, error } = await supabase
      .from("corporate_cards")
      .select("*")
      .eq("tenant_id", currentTenant.tenant_id)
      .order("created_at", { ascending: false });
    if (error) toast.error("데이터 로드 실패");
    else setCards((data as CorporateCard[]) || []);
    setLoading(false);
  };

  const fetchMembers = async () => {
    if (!currentTenant) return;
    const { data } = await supabase
      .from("tenant_memberships")
      .select("user_id, profiles:user_id(full_name, email)")
      .eq("tenant_id", currentTenant.tenant_id);
    if (data) {
      setMembers(
        data.map((d: any) => ({
          user_id: d.user_id,
          profile: d.profiles,
        }))
      );
    }
  };

  const openDialog = (card?: CorporateCard) => {
    if (card) {
      setEditing(card);
      setForm({
        card_number: card.card_number,
        card_name: card.card_name || "",
        card_company: card.card_company || "",
        card_type: card.card_type || "일반",
        card_holder_name: card.card_holder_name || "",
        holder_user_id: card.holder_user_id || "",
        monthly_limit: card.monthly_limit?.toString() || "",
        expiry_date: card.expiry_date || "",
        is_active: card.is_active,
        is_skypass: card.is_skypass || false,
        cvc: card.cvc || "",
        card_image_url: card.card_image_url || "",
      });
    } else {
      setEditing(null);
      setForm({
        card_number: "",
        card_name: "",
        card_company: "",
        card_type: "일반",
        card_holder_name: "",
        holder_user_id: "",
        monthly_limit: "",
        expiry_date: "",
        is_active: true,
        is_skypass: false,
        cvc: "",
        card_image_url: "",
      });
    }
    setImageFile(null);
    setDialogOpen(true);
  };

  const uploadImage = async (): Promise<string | null> => {
    if (!imageFile || !currentTenant) return form.card_image_url || null;
    setUploading(true);
    const ext = imageFile.name.split(".").pop();
    const path = `${currentTenant.tenant_id}/cards/${Date.now()}.${ext}`;
    const { error } = await supabase.storage
      .from("artist-assets")
      .upload(path, imageFile, { upsert: true });
    setUploading(false);
    if (error) {
      toast.error("이미지 업로드 실패");
      return form.card_image_url || null;
    }
    const { data: signedData, error: signedError } = await supabase.storage
      .from("artist-assets")
      .createSignedUrl(path, 60 * 60 * 24 * 365); // 1 year for card images
    if (signedError) {
      toast.error("URL 생성 실패");
      return form.card_image_url || null;
    }
    return signedData.signedUrl;
  };

  const saveCard = async () => {
    if (!currentTenant || !form.card_number.trim()) return;

    const imageUrl = await uploadImage();

    const payload: any = {
      tenant_id: currentTenant.tenant_id,
      card_number: form.card_number.trim(),
      card_name: form.card_name.trim() || null,
      card_company: form.card_company.trim() || null,
      card_type: form.card_type,
      card_holder_name: form.card_holder_name.trim() || null,
      holder_user_id: form.holder_user_id || null,
      monthly_limit: form.monthly_limit ? parseFloat(form.monthly_limit) : null,
      expiry_date: form.expiry_date || null,
      is_active: form.is_active,
      is_skypass: form.is_skypass,
      cvc: form.cvc.trim() || null,
      card_image_url: imageUrl,
    };

    if (editing) {
      const { error } = await supabase
        .from("corporate_cards")
        .update(payload)
        .eq("id", editing.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("카드 정보가 수정되었습니다");
    } else {
      const { error } = await supabase.from("corporate_cards").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("카드가 등록되었습니다");
    }

    setDialogOpen(false);
    fetchData();
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    const { error } = await supabase
      .from("corporate_cards")
      .delete()
      .eq("id", deleteTarget.id);
    if (error) toast.error("삭제 실패: " + error.message);
    else toast.success("카드가 삭제되었습니다");
    setDeleteTarget(null);
    fetchData();
  };

  const maskCardNumber = (num: string) => {
    if (num.length < 8) return num;
    return num.slice(0, 4) + "-****-****-" + num.slice(-4);
  };

  const formatCurrency = (amount: number) =>
    new Intl.NumberFormat("ko-KR").format(amount) + "원";

  const getMemberName = (userId: string | null) => {
    if (!userId) return null;
    const m = members.find((m) => m.user_id === userId);
    return m?.profile?.full_name || m?.profile?.email || null;
  };

  const getCardTypeColor = (type: string | null) => {
    switch (type) {
      case "하이패스":
        return "bg-gradient-to-br from-blue-500 to-indigo-600";
      case "클린카드":
        return "bg-gradient-to-br from-emerald-500 to-teal-600";
      default:
        return "bg-gradient-to-br from-orange-500 to-amber-600";
    }
  };

  const filteredCards = cards.filter(
    (c) =>
      c.card_number.includes(searchQuery) ||
      c.card_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.card_company?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.card_holder_name?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <CreditCard className="w-8 h-8 text-orange-600" /> 법인카드 관리
            </h1>
            <p className="text-slate-500 mt-1">
              {currentTenant?.tenant.name || "회사"} 법인카드 마스터 데이터 관리
            </p>
          </div>
          <Button onClick={() => openDialog()} className="gap-2">
            <Plus className="w-4 h-4" /> 카드 추가
          </Button>
        </div>

        {/* Search */}
        <div className="relative max-w-md mb-6">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="카드번호, 카드명, 카드사, 명의자 검색..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="pl-10"
          />
        </div>

        {/* Card Grid */}
        {loading ? (
          <div className="text-center py-12 text-slate-400">로딩 중...</div>
        ) : filteredCards.length === 0 ? (
          <Card className="border-none shadow-xl bg-white rounded-3xl">
            <CardContent className="py-12 text-center text-slate-400">
              {searchQuery ? "검색 결과가 없습니다" : "등록된 카드가 없습니다"}
            </CardContent>
          </Card>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredCards.map((card) => (
              <Card
                key={card.id}
                className={`border-none shadow-lg rounded-2xl overflow-hidden group relative ${
                  card.is_active
                    ? getCardTypeColor(card.card_type)
                    : "bg-gradient-to-br from-slate-400 to-slate-500"
                }`}
              >
                <CardContent className="p-6 text-white">
                  {/* Actions */}
                  <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 flex gap-1 transition-opacity">
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8 text-white/80 hover:text-white hover:bg-white/20"
                      onClick={() => openDialog(card)}
                    >
                      <Pencil className="w-4 h-4" />
                    </Button>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8 text-white/80 hover:text-white hover:bg-white/20"
                      onClick={() => setDeleteTarget(card)}
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>

                  {/* Top: Company + Badges */}
                  <div className="flex items-center justify-between mb-6">
                    <span className="text-white/80 text-sm font-medium">
                      {card.card_company || "카드사 미지정"}
                    </span>
                    <div className="flex gap-1.5">
                      {card.card_type && card.card_type !== "일반" && (
                        <Badge
                          variant="secondary"
                          className="bg-white/20 text-white text-xs"
                        >
                          {card.card_type}
                        </Badge>
                      )}
                      {card.is_skypass && (
                        <Badge
                          variant="secondary"
                          className="bg-white/20 text-white text-xs gap-1"
                        >
                          <Plane className="w-3 h-3" /> SKY
                        </Badge>
                      )}
                      {!card.is_active && (
                        <Badge
                          variant="secondary"
                          className="bg-white/20 text-white text-xs"
                        >
                          비활성
                        </Badge>
                      )}
                    </div>
                  </div>

                  {/* Card Image (if exists) */}
                  {card.card_image_url && (
                    <div className="mb-4 rounded-lg overflow-hidden bg-white/10">
                      <img
                        src={card.card_image_url}
                        alt="카드 이미지"
                        className="w-full h-24 object-contain"
                      />
                    </div>
                  )}

                  {/* Card Number */}
                  <div className="mb-4">
                    <p className="font-mono text-xl tracking-widest">
                      {maskCardNumber(card.card_number)}
                    </p>
                  </div>

                  {/* Card Info */}
                  <div className="flex items-end justify-between mb-2">
                    <div>
                      <p className="text-white/60 text-xs mb-1">카드명</p>
                      <p className="font-medium text-sm">
                        {card.card_name || "-"}
                      </p>
                    </div>
                    {card.expiry_date && (
                      <div className="text-right">
                        <p className="text-white/60 text-xs mb-1">유효기간</p>
                        <p className="font-medium text-sm">
                          {format(new Date(card.expiry_date), "MM/yy")}
                        </p>
                      </div>
                    )}
                  </div>

                  {/* Holder Info */}
                  <div className="flex items-end justify-between">
                    {card.card_holder_name && (
                      <div>
                        <p className="text-white/60 text-xs mb-1">명의자</p>
                        <p className="font-medium text-sm">
                          {card.card_holder_name}
                        </p>
                      </div>
                    )}
                    {card.holder_user_id && (
                      <div className="text-right">
                        <p className="text-white/60 text-xs mb-1">사용자</p>
                        <p className="font-medium text-sm">
                          {getMemberName(card.holder_user_id) || "-"}
                        </p>
                      </div>
                    )}
                  </div>

                  {/* Monthly Limit */}
                  {card.monthly_limit && (
                    <div className="mt-4 pt-3 border-t border-white/20">
                      <p className="text-white/60 text-xs">월 한도</p>
                      <p className="font-bold text-lg">
                        {formatCurrency(card.monthly_limit)}
                      </p>
                    </div>
                  )}
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </main>

      {/* Dialog */}
      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editing ? "카드 정보 수정" : "법인카드 추가"}
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            {/* Card Number + CVC */}
            <div className="grid grid-cols-3 gap-4">
              <div className="col-span-2 space-y-2">
                <Label>카드번호 *</Label>
                <Input
                  value={form.card_number}
                  onChange={(e) =>
                    setForm((f) => ({
                      ...f,
                      card_number: e.target.value.replace(/\D/g, ""),
                    }))
                  }
                  placeholder="숫자만 입력 (16자리)"
                  maxLength={16}
                />
              </div>
              <div className="space-y-2">
                <Label>CVC</Label>
                <Input
                  value={form.cvc}
                  onChange={(e) =>
                    setForm((f) => ({
                      ...f,
                      cvc: e.target.value.replace(/\D/g, ""),
                    }))
                  }
                  placeholder="3자리"
                  maxLength={4}
                  type="password"
                />
              </div>
            </div>

            {/* Card Name + Company */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>카드명</Label>
                <Input
                  value={form.card_name}
                  onChange={(e) =>
                    setForm((f) => ({ ...f, card_name: e.target.value }))
                  }
                  placeholder="예: 대표이사 법인카드"
                />
              </div>
              <div className="space-y-2">
                <Label>카드사</Label>
                <Input
                  value={form.card_company}
                  onChange={(e) =>
                    setForm((f) => ({ ...f, card_company: e.target.value }))
                  }
                  placeholder="예: 삼성카드"
                />
              </div>
            </div>

            {/* Card Type + Holder Name */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>카드 종류</Label>
                <Select
                  value={form.card_type}
                  onValueChange={(v) => setForm((f) => ({ ...f, card_type: v }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {CARD_TYPES.map((t) => (
                      <SelectItem key={t} value={t}>
                        {t}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>실제 명의자</Label>
                <Input
                  value={form.card_holder_name}
                  onChange={(e) =>
                    setForm((f) => ({
                      ...f,
                      card_holder_name: e.target.value,
                    }))
                  }
                  placeholder="카드 명의자 이름"
                />
              </div>
            </div>

            {/* User + Limit */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>사용자 (직원)</Label>
                <Select
                  value={form.holder_user_id}
                  onValueChange={(v) =>
                    setForm((f) => ({
                      ...f,
                      holder_user_id: v === "none" ? "" : v,
                    }))
                  }
                >
                  <SelectTrigger>
                    <SelectValue placeholder="사용자 선택" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">미지정</SelectItem>
                    {members.map((m) => (
                      <SelectItem key={m.user_id} value={m.user_id}>
                        {m.profile?.full_name || m.profile?.email}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>월 한도 (원)</Label>
                <Input
                  type="number"
                  value={form.monthly_limit}
                  onChange={(e) =>
                    setForm((f) => ({ ...f, monthly_limit: e.target.value }))
                  }
                  placeholder="예: 5000000"
                />
              </div>
            </div>

            {/* Expiry Date */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>유효기간</Label>
                <Input
                  type="date"
                  value={form.expiry_date}
                  onChange={(e) =>
                    setForm((f) => ({ ...f, expiry_date: e.target.value }))
                  }
                />
              </div>
              <div className="space-y-2 flex flex-col justify-end">
                <div className="flex items-center justify-between h-10">
                  <Label>스카이패스 적립</Label>
                  <Switch
                    checked={form.is_skypass}
                    onCheckedChange={(v) =>
                      setForm((f) => ({ ...f, is_skypass: v }))
                    }
                  />
                </div>
              </div>
            </div>

            {/* Card Image */}
            <div className="space-y-2">
              <Label>카드 이미지</Label>
              {(form.card_image_url || imageFile) && (
                <div className="rounded-lg overflow-hidden border bg-slate-50 mb-2">
                  <img
                    src={
                      imageFile
                        ? URL.createObjectURL(imageFile)
                        : form.card_image_url
                    }
                    alt="카드 이미지 미리보기"
                    className="w-full h-32 object-contain"
                  />
                </div>
              )}
              <label className="flex items-center gap-2 cursor-pointer border rounded-lg p-3 hover:bg-slate-50 transition-colors">
                <ImagePlus className="w-5 h-5 text-slate-400" />
                <span className="text-sm text-slate-500">
                  {imageFile
                    ? imageFile.name
                    : "카드 이미지를 업로드하세요"}
                </span>
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={(e) => {
                    const file = e.target.files?.[0];
                    if (file) setImageFile(file);
                  }}
                />
              </label>
            </div>

            {/* Active */}
            <div className="flex items-center justify-between">
              <Label>카드 활성화</Label>
              <Switch
                checked={form.is_active}
                onCheckedChange={(v) =>
                  setForm((f) => ({ ...f, is_active: v }))
                }
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDialogOpen(false)}>
              취소
            </Button>
            <Button
              onClick={saveCard}
              disabled={!form.card_number.trim() || uploading}
            >
              {uploading ? "업로드 중..." : "저장"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog
        open={!!deleteTarget}
        onOpenChange={() => setDeleteTarget(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>카드 삭제</AlertDialogTitle>
            <AlertDialogDescription>
              "
              {deleteTarget?.card_name ||
                maskCardNumber(deleteTarget?.card_number || "")}
              " 카드를 삭제하시겠습니까?
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              className="bg-red-500 hover:bg-red-600"
            >
              삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default CorporateCardManagement;



============================================================
File Path: src/pages/admin/DriveSettings.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import {
  ArrowLeft, CheckCircle, Trash2, Settings2, Info,
  Plus, Link, FolderTree, Database, Edit2, Save, Upload,
  XCircle, AlertCircle, RefreshCw,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "sonner";
import { Badge } from "@/components/ui/badge";

interface FolderMapping {
  id: string;
  folder_key: string;
  folder_id: string;
  folder_name: string | null;
  folder_path: string | null;
  is_active: boolean;
}

const PRESET_KEYS = [
  { key: "bank_transactions", label: "은행 거래내역", icon: "🏦" },
  { key: "card_transactions", label: "카드 이용내역", icon: "💳" },
  { key: "hr_documents", label: "인사 서류", icon: "👤" },
  { key: "artist_assets", label: "아티스트 자산", icon: "🎭" },
  { key: "invoices", label: "세금계산서/청구서", icon: "📄" },
  { key: "contracts", label: "계약서", icon: "📝" },
  { key: "backups", label: "시스템 백업", icon: "💾" },
];

const DriveSettings = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  const [folderId, setFolderId] = useState("");
  const [hasExistingCredentials, setHasExistingCredentials] = useState(false);
  const [mappings, setMappings] = useState<FolderMapping[]>([]);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editValues, setEditValues] = useState({ folder_id: "", folder_name: "", folder_path: "" });

  // Credential upload state
  const [credentialJson, setCredentialJson] = useState("");
  const [newFolderIdInput, setNewFolderIdInput] = useState("");
  const [savingCredentials, setSavingCredentials] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // New mapping form
  const [newKey, setNewKey] = useState("");
  const [newCustomKey, setNewCustomKey] = useState("");
  const [newFolderId, setNewFolderId] = useState("");
  const [newName, setNewName] = useState("");
  const [newPath, setNewPath] = useState("");

  useEffect(() => { fetchSettings(); }, [currentTenant]);

  const fetchSettings = async () => {
    if (!currentTenant) return;
    setLoading(true);
    try {
      const [tenantRes, mappingsRes] = await Promise.all([
        supabase.from("tenants").select("drive_folder_id, google_credentials").eq("id", currentTenant.tenant_id).single(),
        supabase.from("drive_folder_mappings").select("*").eq("tenant_id", currentTenant.tenant_id).order("created_at"),
      ]);

      if (tenantRes.data) {
        setFolderId(tenantRes.data.drive_folder_id || "");
        setHasExistingCredentials(!!tenantRes.data.google_credentials);
      }
      setMappings((mappingsRes.data || []) as FolderMapping[]);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  const handleCredentialFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const text = ev.target?.result as string;
        JSON.parse(text); // validate JSON
        setCredentialJson(text);
        toast.success("JSON 파일이 로드되었습니다. 저장 버튼을 눌러 연동하세요.");
      } catch {
        toast.error("올바른 JSON 파일이 아닙니다.");
      }
    };
    reader.readAsText(file);
  };

  const handleSaveCredentials = async () => {
    if (!credentialJson) {
      toast.error("Service Account JSON을 업로드해주세요.");
      return;
    }
    setSavingCredentials(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const updatePayload: any = {
        google_credentials: credentialJson,
        drive_connected_at: new Date().toISOString(),
      };
      if (newFolderIdInput) updatePayload.drive_folder_id = newFolderIdInput;
      if (user?.id) updatePayload.drive_connected_by = user.id;

      const { error } = await supabase.from("tenants").update(updatePayload).eq("id", currentTenant!.tenant_id);


      if (error) throw error;
      toast.success("Google Drive 연동이 완료되었습니다.");
      setCredentialJson("");
      setNewFolderIdInput("");
      fetchSettings();
    } catch (e: any) {
      toast.error("연동 실패: " + e.message);
    } finally {
      setSavingCredentials(false);
    }
  };

  const handleDisconnect = async () => {
    if (!confirm("Google Drive 연동을 해제하시겠습니까?")) return;
    try {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const { error } = await supabase.from("tenants").update({
        google_credentials: null,
        drive_folder_id: null,
      } as any).eq("id", currentTenant!.tenant_id);
      if (error) throw error;
      toast.success("연동이 해제되었습니다.");
      setFolderId("");
      fetchSettings();
    } catch (e: any) {
      toast.error("해제 실패: " + e.message);
    }
  };

  const handleAddMapping = async () => {
    const key = newKey === "custom" ? newCustomKey.toLowerCase().replace(/\s+/g, "_") : newKey;
    if (!key || !newFolderId) {
      toast.error("분류와 폴더 ID를 입력해주세요.");
      return;
    }

    if (mappings.some(m => m.folder_key === key)) {
      toast.error("이미 등록된 분류입니다.");
      return;
    }

    setSaving(true);
    try {
      const { error } = await supabase.from("drive_folder_mappings").insert({
        tenant_id: currentTenant?.tenant_id,
        folder_key: key,
        folder_id: newFolderId,
        folder_name: newName || (PRESET_KEYS.find(p => p.key === key)?.label || key),
        folder_path: newPath || null,
      });
      if (error) throw error;
      toast.success("폴더 매핑이 추가되었습니다.");
      setNewKey(""); setNewCustomKey(""); setNewFolderId(""); setNewName(""); setNewPath("");
      fetchSettings();
    } catch (e: any) {
      toast.error("추가 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteMapping = async (id: string) => {
    try {
      const { error } = await supabase.from("drive_folder_mappings").delete().eq("id", id);
      if (error) throw error;
      toast.success("삭제되었습니다.");
      fetchSettings();
    } catch (e: any) {
      toast.error("삭제 실패");
    }
  };

  const handleStartEdit = (m: FolderMapping) => {
    setEditingId(m.id);
    setEditValues({ folder_id: m.folder_id, folder_name: m.folder_name || "", folder_path: m.folder_path || "" });
  };

  const handleSaveEdit = async (id: string) => {
    try {
      const { error } = await supabase.from("drive_folder_mappings").update({
        folder_id: editValues.folder_id,
        folder_name: editValues.folder_name,
        folder_path: editValues.folder_path || null,
      }).eq("id", id);
      if (error) throw error;
      toast.success("수정되었습니다.");
      setEditingId(null);
      fetchSettings();
    } catch (e: any) {
      toast.error("수정 실패");
    }
  };

  const getPresetInfo = (key: string) => PRESET_KEYS.find(p => p.key === key);
  const usedKeys = mappings.map(m => m.folder_key);
  const availablePresets = PRESET_KEYS.filter(p => !usedKeys.includes(p.key));

  if (loading) return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
    </div>
  );

  return (
    <div className="min-h-screen bg-background pb-20 text-foreground">
      <Header />
      <div className="max-w-5xl mx-auto p-6 pt-28 space-y-8">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-black tracking-tight">통합 저장소 설정</h1>
            <p className="text-primary font-bold flex items-center gap-1.5">
              <Database className="w-4 h-4" /> {currentTenant?.tenant.name} · 데이터 소유권 관리
            </p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2 space-y-8">
            {/* Master connection status */}
            <Card className="shadow-md border-none rounded-2xl overflow-hidden">
              <CardHeader className="bg-primary text-primary-foreground">
                <CardTitle className="text-lg flex items-center gap-2">
                  <Settings2 className="h-5 w-5" /> Google Drive 마스터 연동
                </CardTitle>
                <CardDescription className="text-primary-foreground/70">
                  Service Account JSON 키로 Google Drive를 연동하세요
                </CardDescription>
              </CardHeader>
              <CardContent className="pt-6 space-y-4">
                {/* Connection status badge */}
                <div className="p-4 rounded-xl bg-muted/50 border flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg ${hasExistingCredentials ? "bg-primary/10 text-primary" : "bg-destructive/10 text-destructive"}`}>
                      {hasExistingCredentials ? <CheckCircle size={20} /> : <XCircle size={20} />}
                    </div>
                    <div>
                      <p className="text-sm font-bold">
                        인증 상태: {hasExistingCredentials
                          ? <span className="text-primary">연결됨</span>
                          : <span className="text-destructive">미연결</span>}
                      </p>
                      <p className="text-xs text-muted-foreground">
                        {hasExistingCredentials
                          ? (folderId ? `마스터 폴더: ${folderId.substring(0, 28)}...` : "Service Account JSON 연동됨")
                          : "Service Account JSON이 없습니다. 아래에서 업로드하세요."}
                      </p>
                    </div>
                  </div>
                  {hasExistingCredentials && (
                    <Button variant="ghost" size="sm" className="text-destructive hover:text-destructive gap-1.5" onClick={handleDisconnect}>
                      <XCircle size={14} /> 연동 해제
                    </Button>
                  )}
                </div>

                {/* Upload section - always visible */}
                <div className="space-y-3 p-4 rounded-xl border bg-muted/20">
                  <p className="text-sm font-bold flex items-center gap-2">
                    <Upload size={14} />
                    {hasExistingCredentials ? "Service Account JSON 재업로드" : "Service Account JSON 업로드로 연동 시작"}
                  </p>

                  {/* File picker */}
                  <div
                    className="border-2 border-dashed rounded-xl p-5 text-center cursor-pointer hover:border-primary/50 hover:bg-primary/5 transition-all group"
                    onClick={() => fileInputRef.current?.click()}
                  >
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".json,application/json"
                      className="hidden"
                      onChange={handleCredentialFileUpload}
                    />
                    {credentialJson ? (
                      <div className="flex items-center justify-center gap-2 text-primary">
                        <CheckCircle size={18} />
                        <span className="text-sm font-medium">JSON 파일 로드 완료 — 저장 버튼을 눌러 연동하세요</span>
                      </div>
                    ) : (
                      <div className="text-muted-foreground">
                        <Upload size={24} className="mx-auto mb-2 group-hover:text-primary transition-colors" />
                        <p className="text-sm">클릭하여 JSON 파일 선택</p>
                        <p className="text-xs mt-1 opacity-60">Google Cloud Console에서 발급한 Service Account Key (.json)</p>
                      </div>
                    )}
                  </div>

                  {/* Optional master folder ID */}
                  <div className="space-y-1.5">
                    <Label className="text-xs font-bold text-muted-foreground uppercase">마스터 폴더 ID (선택)</Label>
                    <Input
                      placeholder="최상위 Drive 폴더 ID (선택 사항)"
                      value={newFolderIdInput}
                      onChange={(e) => setNewFolderIdInput(e.target.value)}
                    />
                    <p className="text-[11px] text-muted-foreground">폴더 매핑을 통해 기능별로 지정하는 경우 생략 가능합니다.</p>
                  </div>

                  <Button
                    className="w-full gap-2 font-bold"
                    onClick={handleSaveCredentials}
                    disabled={!credentialJson || savingCredentials}
                  >
                    {savingCredentials ? <RefreshCw size={16} className="animate-spin" /> : <CheckCircle size={16} />}
                    {hasExistingCredentials ? "재연동 저장" : "Google Drive 연동하기"}
                  </Button>

                  {!hasExistingCredentials && (
                    <div className="flex items-start gap-2 text-xs text-destructive bg-destructive/5 border border-destructive/20 rounded-lg p-3">
                      <AlertCircle size={14} className="mt-0.5 shrink-0" />
                      <span>Service Account JSON이 없으면 아래 폴더 매핑 및 자동 동기화가 작동하지 않습니다.</span>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>


            {/* Folder Mappings */}
            <Card className="shadow-md border-none rounded-2xl overflow-hidden">
              <CardHeader className="border-b bg-muted/30">
                <CardTitle className="text-lg flex items-center gap-2">
                  <FolderTree className="h-5 w-5 text-primary" /> 메뉴별 저장 경로 매핑
                </CardTitle>
                <CardDescription>
                  각 기능(은행, 카드, 인사 등)에서 발생한 데이터가 저장될 Google Drive 폴더를 지정하세요.
                </CardDescription>
              </CardHeader>
              <CardContent className="pt-6 space-y-6">
                {/* Add form */}
                <div className="p-4 rounded-2xl bg-muted/30 border space-y-3">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className="space-y-1.5">
                      <Label className="text-xs font-bold text-muted-foreground uppercase">분류 선택</Label>
                      <Select value={newKey} onValueChange={(v) => { setNewKey(v); if (v !== "custom") setNewName(PRESET_KEYS.find(p => p.key === v)?.label || ""); }}>
                        <SelectTrigger><SelectValue placeholder="분류를 선택하세요" /></SelectTrigger>
                        <SelectContent>
                          {availablePresets.map(p => (
                            <SelectItem key={p.key} value={p.key}>{p.icon} {p.label}</SelectItem>
                          ))}
                          <SelectItem value="custom">✏️ 직접 입력</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    {newKey === "custom" && (
                      <div className="space-y-1.5">
                        <Label className="text-xs font-bold text-muted-foreground uppercase">커스텀 키</Label>
                        <Input placeholder="예: monthly_reports" value={newCustomKey}
                          onChange={(e) => setNewCustomKey(e.target.value)} />
                      </div>
                    )}
                    <div className="space-y-1.5">
                      <Label className="text-xs font-bold text-muted-foreground uppercase">Google Drive 폴더 ID</Label>
                      <Input placeholder="Drive 폴더 URL의 마지막 부분" value={newFolderId}
                        onChange={(e) => setNewFolderId(e.target.value)} />
                    </div>
                    <div className="space-y-1.5">
                      <Label className="text-xs font-bold text-muted-foreground uppercase">표시 이름</Label>
                      <Input placeholder="예: 재무팀 은행 내역" value={newName}
                        onChange={(e) => setNewName(e.target.value)} />
                    </div>
                  </div>
                  <div className="flex gap-3 items-end">
                    <div className="flex-1 space-y-1.5">
                      <Label className="text-xs font-bold text-muted-foreground uppercase">경로 메모 (선택)</Label>
                      <Input placeholder="예: 재무/은행거래/2026" value={newPath}
                        onChange={(e) => setNewPath(e.target.value)} />
                    </div>
                    <Button onClick={handleAddMapping} disabled={saving} className="gap-2 font-bold">
                      <Plus className="w-4 h-4" /> 추가
                    </Button>
                  </div>
                </div>

                {/* Mapping list */}
                <div className="space-y-3">
                  {mappings.length === 0 ? (
                    <div className="py-10 text-center text-muted-foreground text-sm italic">
                      등록된 폴더 매핑이 없습니다.
                    </div>
                  ) : mappings.map((m) => {
                    const preset = getPresetInfo(m.folder_key);
                    const isEditing = editingId === m.id;

                    return (
                      <div key={m.id} className="p-4 border rounded-2xl hover:bg-muted/20 group transition-all space-y-2">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center text-lg">
                              {preset?.icon || "📁"}
                            </div>
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="font-bold">{m.folder_name || preset?.label || m.folder_key}</span>
                                <Badge variant="outline" className="text-[10px] font-mono opacity-50">
                                  {m.folder_key}
                                </Badge>
                              </div>
                              {m.folder_path && (
                                <p className="text-xs text-muted-foreground mt-0.5">📂 {m.folder_path}</p>
                              )}
                            </div>
                          </div>
                          <div className="flex gap-1">
                            {isEditing ? (
                              <Button size="icon" variant="ghost" onClick={() => handleSaveEdit(m.id)} className="text-primary">
                                <Save size={16} />
                              </Button>
                            ) : (
                              <Button size="icon" variant="ghost" onClick={() => handleStartEdit(m)}
                                className="opacity-0 group-hover:opacity-100">
                                <Edit2 size={16} />
                              </Button>
                            )}
                            <Button size="icon" variant="ghost"
                              className="opacity-0 group-hover:opacity-100 text-destructive"
                              onClick={() => handleDeleteMapping(m.id)}>
                              <Trash2 size={16} />
                            </Button>
                          </div>
                        </div>

                        {isEditing ? (
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-2 pt-2">
                            <Input placeholder="폴더 ID" value={editValues.folder_id}
                              onChange={(e) => setEditValues({ ...editValues, folder_id: e.target.value })} />
                            <Input placeholder="표시 이름" value={editValues.folder_name}
                              onChange={(e) => setEditValues({ ...editValues, folder_name: e.target.value })} />
                            <Input placeholder="경로 메모" value={editValues.folder_path}
                              onChange={(e) => setEditValues({ ...editValues, folder_path: e.target.value })} />
                          </div>
                        ) : (
                          <div className="flex items-center gap-1.5 text-xs text-muted-foreground font-mono pl-13">
                            <Link size={12} /> {m.folder_id}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Right sidebar */}
          <div className="space-y-6">
            <Card className="border-none shadow-md bg-primary text-primary-foreground rounded-2xl">
              <CardHeader>
                <CardTitle className="text-md flex items-center gap-2">
                  <Info className="h-5 w-5" /> 경로 지정 가이드
                </CardTitle>
              </CardHeader>
              <CardContent className="text-xs leading-relaxed opacity-90 space-y-4">
                <div className="space-y-2">
                  <p className="font-bold border-b border-primary-foreground/20 pb-1">📂 폴더 ID 찾는 법</p>
                  <p>Google Drive에서 폴더를 열고, URL 마지막 부분이 폴더 ID입니다.</p>
                  <p className="font-mono bg-primary-foreground/10 rounded p-1 text-[10px] break-all">
                    drive.google.com/drive/folders/<strong>1abc...xyz</strong>
                  </p>
                </div>
                <div className="space-y-2">
                  <p className="font-bold border-b border-primary-foreground/20 pb-1">⏰ 자동 동기화</p>
                  <p>은행/카드 거래내역은 매일 오전 10시에 자동으로 CSV 파일로 저장됩니다.</p>
                </div>
                <div className="space-y-2">
                  <p className="font-bold border-b border-primary-foreground/20 pb-1">💡 분류 활용 예시</p>
                  <ul className="list-disc list-inside space-y-1">
                    <li><strong>은행 거래내역:</strong> 재무팀 공유 폴더</li>
                    <li><strong>카드 이용내역:</strong> 증빙 보관 폴더</li>
                    <li><strong>인사 서류:</strong> 보안 인사 폴더</li>
                  </ul>
                </div>
              </CardContent>
            </Card>

            <Card className="border-none shadow-md rounded-2xl">
              <CardHeader className="pb-3 border-b">
                <CardTitle className="text-sm font-bold">권장 폴더 구조</CardTitle>
              </CardHeader>
              <CardContent className="pt-4 text-xs font-mono text-muted-foreground space-y-1">
                <p>📁 회사명</p>
                <p className="pl-4">├── 📁 재무</p>
                <p className="pl-8">├── 📁 은행거래내역</p>
                <p className="pl-8">└── 📁 카드이용내역</p>
                <p className="pl-4">├── 📁 인사</p>
                <p className="pl-8">└── 📁 입사서류</p>
                <p className="pl-4">├── 📁 아티스트</p>
                <p className="pl-4">└── 📁 계약서</p>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DriveSettings;



============================================================
File Path: src/pages/admin/DrivingControl.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { 
  Navigation, ArrowLeft, Play, Square, MapPin, Clock, Car, 
  Route, Gauge, AlertCircle, CheckCircle, History, Loader2 
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { useGeolocation } from "@/hooks/useGeolocation";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";
import { format } from "date-fns";
import { ko } from "date-fns/locale";

interface Vehicle {
  id: string;
  plate_number: string;
  model: string | null;
  manufacturer: string | null;
}

interface DrivingLog {
  id: string;
  vehicle_id: string;
  driver_user_id: string | null;
  start_time: string;
  end_time: string | null;
  start_address: string | null;
  end_address: string | null;
  distance_km: number;
  purpose: string | null;
  memo: string | null;
  status: string;
  vehicle?: Vehicle;
}

const DrivingControl = () => {
  const navigate = useNavigate();
  const { currentTenant, user } = useAuth();
  const geo = useGeolocation({ enableHighAccuracy: true });

  const [vehicles, setVehicles] = useState<Vehicle[]>([]);
  const [drivingLogs, setDrivingLogs] = useState<DrivingLog[]>([]);
  const [selectedVehicle, setSelectedVehicle] = useState<string>("");
  const [purpose, setPurpose] = useState("");
  const [activeLog, setActiveLog] = useState<DrivingLog | null>(null);
  const [loading, setLoading] = useState(false);
  const [endTripDialog, setEndTripDialog] = useState(false);
  const [endMemo, setEndMemo] = useState("");

  // Fetch vehicles
  useEffect(() => {
    const fetchVehicles = async () => {
      if (!currentTenant?.tenant_id) return;
      const { data, error } = await supabase
        .from("vehicles")
        .select("id, plate_number, model, manufacturer")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("is_active", true);
      
      if (error) {
        toast({ title: "차량 목록 조회 실패", variant: "destructive" });
        return;
      }
      setVehicles(data || []);
    };
    fetchVehicles();
  }, [currentTenant?.tenant_id]);

  // Fetch driving logs
  useEffect(() => {
    const fetchLogs = async () => {
      if (!currentTenant?.tenant_id) return;
      const { data, error } = await supabase
        .from("driving_logs")
        .select(`
          *,
          vehicle:vehicles(id, plate_number, model, manufacturer)
        `)
        .eq("tenant_id", currentTenant.tenant_id)
        .order("start_time", { ascending: false })
        .limit(50);
      
      if (error) {
        console.error(error);
        return;
      }
      setDrivingLogs(data || []);
      
      // Check if there's an active log for current user
      const active = data?.find(log => log.status === "in_progress" && log.driver_user_id === user?.id);
      if (active) {
        setActiveLog(active);
        setSelectedVehicle(active.vehicle_id);
        setPurpose(active.purpose || "");
        geo.startTracking();
      }
    };
    fetchLogs();
  }, [currentTenant?.tenant_id, user?.id]);

  const reverseGeocode = async (lat: number, lng: number): Promise<string> => {
    // Simple reverse geocoding using Nominatim (free, no API key needed)
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ko`
      );
      const data = await response.json();
      return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    } catch {
      return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
  };

  const startTrip = async () => {
    if (!selectedVehicle || !currentTenant?.tenant_id || !user?.id) {
      toast({ title: "차량을 선택해주세요", variant: "destructive" });
      return;
    }

    setLoading(true);
    try {
      const position = await geo.getCurrentPosition();
      const { latitude, longitude } = position.coords;
      const address = await reverseGeocode(latitude, longitude);

      const { data, error } = await supabase
        .from("driving_logs")
        .insert({
          tenant_id: currentTenant.tenant_id,
          vehicle_id: selectedVehicle,
          driver_user_id: user.id,
          start_location_lat: latitude,
          start_location_lng: longitude,
          start_address: address,
          purpose: purpose || null,
          status: "in_progress",
        })
        .select(`*, vehicle:vehicles(id, plate_number, model, manufacturer)`)
        .single();

      if (error) throw error;

      setActiveLog(data);
      geo.startTracking();
      toast({ title: "운행을 시작합니다", description: address });

      // Add first waypoint
      await supabase.from("driving_log_waypoints").insert({
        log_id: data.id,
        latitude,
        longitude,
        speed_kmh: geo.speed,
        heading: geo.heading,
      });
    } catch (error) {
      console.error(error);
      toast({ title: "운행 시작 실패", variant: "destructive" });
    } finally {
      setLoading(false);
    }
  };

  const endTrip = async () => {
    if (!activeLog) return;

    setLoading(true);
    try {
      const position = await geo.getCurrentPosition();
      const { latitude, longitude } = position.coords;
      const address = await reverseGeocode(latitude, longitude);
      const distance = geo.getTotalDistance();

      // Add final waypoint
      await supabase.from("driving_log_waypoints").insert({
        log_id: activeLog.id,
        latitude,
        longitude,
        speed_kmh: 0,
        heading: geo.heading,
      });

      const { error } = await supabase
        .from("driving_logs")
        .update({
          end_time: new Date().toISOString(),
          end_location_lat: latitude,
          end_location_lng: longitude,
          end_address: address,
          distance_km: Math.round(distance * 100) / 100,
          memo: endMemo || null,
          status: "completed",
        })
        .eq("id", activeLog.id);

      if (error) throw error;

      geo.stopTracking();
      setActiveLog(null);
      setEndTripDialog(false);
      setEndMemo("");
      setPurpose("");
      setSelectedVehicle("");
      
      toast({ 
        title: "운행이 종료되었습니다", 
        description: `총 ${distance.toFixed(2)}km 주행` 
      });

      // Refresh logs
      const { data: refreshedLogs } = await supabase
        .from("driving_logs")
        .select(`*, vehicle:vehicles(id, plate_number, model, manufacturer)`)
        .eq("tenant_id", currentTenant?.tenant_id)
        .order("start_time", { ascending: false })
        .limit(50);
      
      setDrivingLogs(refreshedLogs || []);
    } catch (error) {
      console.error(error);
      toast({ title: "운행 종료 실패", variant: "destructive" });
    } finally {
      setLoading(false);
    }
  };

  // Periodically save waypoints during active trip
  useEffect(() => {
    if (!activeLog || !geo.isTracking || !geo.latitude || !geo.longitude) return;

    const interval = setInterval(async () => {
      if (geo.latitude && geo.longitude) {
        await supabase.from("driving_log_waypoints").insert({
          log_id: activeLog.id,
          latitude: geo.latitude,
          longitude: geo.longitude,
          speed_kmh: geo.speed,
          heading: geo.heading,
        });
      }
    }, 30000); // Save every 30 seconds

    return () => clearInterval(interval);
  }, [activeLog, geo.isTracking, geo.latitude, geo.longitude]);

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "in_progress":
        return <Badge className="bg-emerald-500">운행 중</Badge>;
      case "completed":
        return <Badge variant="secondary">완료</Badge>;
      default:
        return <Badge variant="outline">{status}</Badge>;
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 text-white">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-7xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" className="text-white hover:bg-white/10" onClick={() => navigate("/admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <Navigation className="w-8 h-8 text-emerald-400" /> 실시간 운행 관제
            </h1>
            <p className="text-slate-400 mt-1">GPS 기반 주행일지 자동 생성 시스템</p>
          </div>
        </div>

        <Tabs defaultValue="control" className="space-y-6">
          <TabsList className="bg-white/10">
            <TabsTrigger value="control" className="data-[state=active]:bg-emerald-500">
              <Gauge className="w-4 h-4 mr-2" /> 운행 관제
            </TabsTrigger>
            <TabsTrigger value="history" className="data-[state=active]:bg-emerald-500">
              <History className="w-4 h-4 mr-2" /> 운행 기록
            </TabsTrigger>
          </TabsList>

          <TabsContent value="control" className="space-y-6">
            {/* Active Trip Status */}
            {activeLog ? (
              <Card className="border-emerald-500/50 bg-emerald-500/10">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-emerald-400">
                    <div className="w-3 h-3 bg-emerald-400 rounded-full animate-pulse" />
                    운행 중
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-white/5 rounded-xl p-4">
                      <div className="text-sm text-slate-400 mb-1">차량</div>
                      <div className="font-bold">
                        {activeLog.vehicle?.plate_number}
                        <span className="text-sm text-slate-400 ml-2">
                          {activeLog.vehicle?.manufacturer} {activeLog.vehicle?.model}
                        </span>
                      </div>
                    </div>
                    <div className="bg-white/5 rounded-xl p-4">
                      <div className="text-sm text-slate-400 mb-1">출발 시간</div>
                      <div className="font-bold">
                        {format(new Date(activeLog.start_time), "HH:mm", { locale: ko })}
                      </div>
                    </div>
                    <div className="bg-white/5 rounded-xl p-4">
                      <div className="text-sm text-slate-400 mb-1">주행 거리</div>
                      <div className="font-bold">{geo.getTotalDistance().toFixed(2)} km</div>
                    </div>
                    <div className="bg-white/5 rounded-xl p-4">
                      <div className="text-sm text-slate-400 mb-1">현재 속도</div>
                      <div className="font-bold">{geo.speed?.toFixed(0) || 0} km/h</div>
                    </div>
                  </div>

                  <div className="bg-white/5 rounded-xl p-4">
                    <div className="text-sm text-slate-400 mb-2">출발지</div>
                    <div className="flex items-start gap-2">
                      <MapPin className="w-4 h-4 text-emerald-400 mt-1 flex-shrink-0" />
                      <span className="text-sm">{activeLog.start_address || "위치 확인 중..."}</span>
                    </div>
                  </div>

                  {geo.latitude && geo.longitude && (
                    <div className="bg-white/5 rounded-xl p-4">
                      <div className="text-sm text-slate-400 mb-2">현재 위치</div>
                      <div className="flex items-start gap-2">
                        <MapPin className="w-4 h-4 text-blue-400 mt-1 flex-shrink-0" />
                        <span className="text-sm">
                          {geo.latitude.toFixed(6)}, {geo.longitude.toFixed(6)}
                          {geo.accuracy && (
                            <span className="text-slate-500 ml-2">(±{geo.accuracy.toFixed(0)}m)</span>
                          )}
                        </span>
                      </div>
                    </div>
                  )}

                  <Button
                    className="w-full bg-red-500 hover:bg-red-600 text-white"
                    size="lg"
                    onClick={() => setEndTripDialog(true)}
                    disabled={loading}
                  >
                    {loading ? (
                      <Loader2 className="w-5 h-5 animate-spin mr-2" />
                    ) : (
                      <Square className="w-5 h-5 mr-2" />
                    )}
                    운행 종료
                  </Button>
                </CardContent>
              </Card>
            ) : (
              <Card className="border-none bg-white/5">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Car className="w-5 h-5 text-slate-400" />
                    새 운행 시작
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">차량 선택</label>
                    <Select value={selectedVehicle} onValueChange={setSelectedVehicle}>
                      <SelectTrigger className="bg-white/5 border-white/10">
                        <SelectValue placeholder="차량을 선택하세요" />
                      </SelectTrigger>
                      <SelectContent>
                        {vehicles.map((v) => (
                          <SelectItem key={v.id} value={v.id}>
                            {v.plate_number} - {v.manufacturer} {v.model}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">운행 목적 (선택)</label>
                    <Textarea
                      value={purpose}
                      onChange={(e) => setPurpose(e.target.value)}
                      placeholder="출장, 미팅, 거래처 방문 등"
                      className="bg-white/5 border-white/10 resize-none"
                      rows={2}
                    />
                  </div>

                  {geo.error && (
                    <div className="flex items-center gap-2 text-red-400 text-sm">
                      <AlertCircle className="w-4 h-4" />
                      {geo.error}
                    </div>
                  )}

                  <Button
                    className="w-full bg-emerald-500 hover:bg-emerald-600"
                    size="lg"
                    onClick={startTrip}
                    disabled={!selectedVehicle || loading}
                  >
                    {loading ? (
                      <Loader2 className="w-5 h-5 animate-spin mr-2" />
                    ) : (
                      <Play className="w-5 h-5 mr-2" />
                    )}
                    운행 시작
                  </Button>
                </CardContent>
              </Card>
            )}

            {/* Recent Activity */}
            <Card className="border-none bg-white/5">
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Clock className="w-5 h-5 text-slate-400" />
                  최근 운행
                </CardTitle>
              </CardHeader>
              <CardContent>
                {drivingLogs.length === 0 ? (
                  <div className="text-center py-8 text-slate-500">
                    운행 기록이 없습니다
                  </div>
                ) : (
                  <div className="space-y-3">
                    {drivingLogs.slice(0, 5).map((log) => (
                      <div key={log.id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                        <div className="flex items-center gap-3">
                          <div className="p-2 bg-emerald-500/20 rounded-lg">
                            <Route className="w-4 h-4 text-emerald-400" />
                          </div>
                          <div>
                            <div className="font-medium">
                              {log.vehicle?.plate_number}
                            </div>
                            <div className="text-xs text-slate-400">
                              {format(new Date(log.start_time), "MM/dd HH:mm", { locale: ko })}
                              {log.end_time && ` - ${format(new Date(log.end_time), "HH:mm", { locale: ko })}`}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-300">{log.distance_km} km</span>
                          {getStatusBadge(log.status)}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="history">
            <Card className="border-none bg-white/5">
              <CardHeader>
                <CardTitle>운행 기록</CardTitle>
              </CardHeader>
              <CardContent>
                <Table>
                  <TableHeader>
                    <TableRow className="border-white/10 hover:bg-white/5">
                      <TableHead className="text-slate-400">차량</TableHead>
                      <TableHead className="text-slate-400">출발</TableHead>
                      <TableHead className="text-slate-400">도착</TableHead>
                      <TableHead className="text-slate-400">거리</TableHead>
                      <TableHead className="text-slate-400">목적</TableHead>
                      <TableHead className="text-slate-400">상태</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {drivingLogs.map((log) => (
                      <TableRow key={log.id} className="border-white/10 hover:bg-white/5">
                        <TableCell>
                          <div className="font-medium">{log.vehicle?.plate_number}</div>
                          <div className="text-xs text-slate-500">
                            {log.vehicle?.manufacturer} {log.vehicle?.model}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div>{format(new Date(log.start_time), "MM/dd HH:mm")}</div>
                          <div className="text-xs text-slate-500 truncate max-w-[150px]">
                            {log.start_address}
                          </div>
                        </TableCell>
                        <TableCell>
                          {log.end_time ? (
                            <>
                              <div>{format(new Date(log.end_time), "MM/dd HH:mm")}</div>
                              <div className="text-xs text-slate-500 truncate max-w-[150px]">
                                {log.end_address}
                              </div>
                            </>
                          ) : (
                            <span className="text-slate-500">-</span>
                          )}
                        </TableCell>
                        <TableCell>{log.distance_km} km</TableCell>
                        <TableCell>
                          <span className="text-slate-300">{log.purpose || "-"}</span>
                        </TableCell>
                        <TableCell>{getStatusBadge(log.status)}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* End Trip Dialog */}
        <Dialog open={endTripDialog} onOpenChange={setEndTripDialog}>
          <DialogContent className="bg-slate-800 border-slate-700">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <CheckCircle className="w-5 h-5 text-emerald-400" />
                운행 종료
              </DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <label className="text-sm text-slate-400 mb-2 block">메모 (선택)</label>
                <Textarea
                  value={endMemo}
                  onChange={(e) => setEndMemo(e.target.value)}
                  placeholder="특이사항, 주유, 주차 위치 등"
                  className="bg-white/5 border-white/10 resize-none"
                  rows={3}
                />
              </div>
              <div className="bg-white/5 rounded-lg p-4 space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-slate-400">총 주행 거리</span>
                  <span className="font-bold text-emerald-400">{geo.getTotalDistance().toFixed(2)} km</span>
                </div>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setEndTripDialog(false)}>
                취소
              </Button>
              <Button 
                onClick={endTrip} 
                disabled={loading}
                className="bg-emerald-500 hover:bg-emerald-600"
              >
                {loading ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : null}
                운행 종료 확인
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </main>
    </div>
  );
};

export default DrivingControl;



============================================================
File Path: src/pages/admin/FinanceSettings.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import {
  Landmark, CreditCard, Plus, Trash2, ShieldCheck, Database,
  RefreshCw, Save, Settings, Eye, EyeOff,
} from "lucide-react";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter,
} from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";

const BANK_CODES = [
  { code: "0002", name: "산업은행" }, { code: "0003", name: "기업은행" },
  { code: "0004", name: "국민은행" }, { code: "0007", name: "수협은행" },
  { code: "0011", name: "농협은행" }, { code: "0020", name: "우리은행" },
  { code: "0023", name: "SC제일은행" }, { code: "0027", name: "씨티은행" },
  { code: "0031", name: "대구은행" }, { code: "0032", name: "부산은행" },
  { code: "0034", name: "광주은행" }, { code: "0035", name: "제주은행" },
  { code: "0037", name: "전북은행" }, { code: "0039", name: "경남은행" },
  { code: "0045", name: "새마을금고" }, { code: "0048", name: "신협은행" },
  { code: "0071", name: "우체국" }, { code: "0081", name: "하나은행" },
  { code: "0088", name: "신한은행" }, { code: "0089", name: "K뱅크" },
];

const CARD_CODES = [
  { code: "0301", name: "국민카드" }, { code: "0302", name: "현대카드" },
  { code: "0303", name: "삼성카드" }, { code: "0304", name: "신한카드" },
  { code: "0305", name: "롯데카드" }, { code: "0306", name: "BC카드" },
  { code: "0307", name: "하나카드" }, { code: "0308", name: "우리카드" },
];

const getOrgName = (code: string, type: string) => {
  const list = type === "BK" ? BANK_CODES : CARD_CODES;
  return list.find((i) => i.code === code)?.name || code;
};

const FinanceSettings = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);

  const [masterConfigs, setMasterConfigs] = useState({
    CODEF_CLIENT_ID: "", CODEF_CLIENT_SECRET: "", CODEF_PUBLIC_KEY: "",
  });
  const [connectedIds, setConnectedIds] = useState<any[]>([]);
  const [accounts, setAccounts] = useState<any[]>([]);

  // 발급 다이얼로그
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [form, setForm] = useState({ type: "BK", orgCode: "0004", password: "", loginId: "" });
  const [derFile, setDerFile] = useState<File | null>(null);
  const [keyFile, setKeyFile] = useState<File | null>(null);

  // 계좌 등록 다이얼로그
  const [isAccountDialogOpen, setIsAccountDialogOpen] = useState(false);
  const [accountForm, setAccountForm] = useState({
    connectedIdKey: "", businessType: "BK", organization: "",
    accountNumber: "", accountAlias: "",
  });

  useEffect(() => {
    if (currentTenant) fetchAll();
  }, [currentTenant]);

  const fetchAll = async () => {
    setLoading(true);
    const [configRes, accountRes] = await Promise.all([
      supabase.from("tenant_api_configs").select("*").eq("tenant_id", currentTenant?.tenant_id),
      supabase.from("finance_accounts").select("*").eq("tenant_id", currentTenant?.tenant_id).eq("is_active", true),
    ]);

    if (configRes.data) {
      const masters = { CODEF_CLIENT_ID: "", CODEF_CLIENT_SECRET: "", CODEF_PUBLIC_KEY: "" };
      configRes.data.forEach((item: any) => {
        if (item.config_key in masters) (masters as any)[item.config_key] = item.config_value;
      });
      setMasterConfigs(masters);
      setConnectedIds(configRes.data.filter((item: any) => item.config_key.startsWith("CONNECTED_ID_")));
    }
    if (accountRes.data) setAccounts(accountRes.data);
    setLoading(false);
  };

  const handleSaveMasters = async () => {
    setProcessing(true);
    const updates = Object.entries(masterConfigs).map(([key, value]) => ({
      tenant_id: currentTenant?.tenant_id, config_key: key, config_value: value, category: "finance_master",
    }));
    await supabase.from("tenant_api_configs").upsert(updates, { onConflict: "tenant_id,config_key" });
    toast.success("마스터 설정 저장 완료");
    setProcessing(false);
  };

  const fileToBase64 = (file: File): Promise<string> =>
    new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve((reader.result as string).split(",")[1]);
      reader.onerror = reject;
    });

  const handleGenerateId = async () => {
    if (form.type === "BK" && (!derFile || !keyFile)) return toast.error("은행 연동에는 인증서 파일이 필요합니다.");
    if (form.type === "CD" && !form.loginId) return toast.error("카드 연동에는 로그인 ID가 필요합니다.");
    if (!form.password) return toast.error("비밀번호를 입력하세요.");

    setProcessing(true);
    try {
      const bodyPayload: any = {
        action: "create_connected_id", tenantId: currentTenant?.tenant_id,
        businessType: form.type, organization: form.orgCode, password: form.password,
      };
      if (form.type === "BK") {
        bodyPayload.derFile = await fileToBase64(derFile!);
        bodyPayload.keyFile = await fileToBase64(keyFile!);
      } else {
        bodyPayload.loginId = form.loginId;
      }

      const { data, error } = await supabase.functions.invoke("codef-api", { body: bodyPayload });
      if (error) throw error;
      if (data.result.code !== "CF-00000") throw new Error(data.result.message);

      toast.success(`${form.type === "BK" ? "은행" : "카드"} 연동 성공!`);
      setIsDialogOpen(false);
      fetchAll();
    } catch (e: any) {
      toast.error("발급 실패: " + e.message);
    } finally {
      setProcessing(false);
    }
  };

  const openAddAccount = (connectedItem: any) => {
    const key = connectedItem.config_key;
    const type = key.includes("_BK_") ? "BK" : "CD";
    const org = key.split("_").pop()!;
    setAccountForm({
      connectedIdKey: key, businessType: type, organization: org,
      accountNumber: "", accountAlias: "",
    });
    setIsAccountDialogOpen(true);
  };

  const handleAddAccount = async () => {
    if (!accountForm.accountNumber && accountForm.businessType === "BK") {
      return toast.error("계좌번호를 입력하세요.");
    }
    setProcessing(true);
    try {
      const { error } = await supabase.from("finance_accounts").insert({
        tenant_id: currentTenant?.tenant_id,
        connected_id_key: accountForm.connectedIdKey,
        business_type: accountForm.businessType,
        organization: accountForm.organization,
        account_number: accountForm.accountNumber || null,
        account_alias: accountForm.accountAlias || null,
      });
      if (error) throw error;
      toast.success("계좌/카드 등록 완료");
      setIsAccountDialogOpen(false);
      fetchAll();
    } catch (e: any) {
      toast.error("등록 실패: " + e.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleDeleteAccount = async (id: string) => {
    await supabase.from("finance_accounts").delete().eq("id", id);
    toast.success("삭제 완료");
    fetchAll();
  };

  const handleDeleteConnectedId = async (configId: string, configKey: string) => {
    await supabase.from("tenant_api_configs").delete().eq("id", configId);
    // 연관 계좌도 삭제
    await supabase.from("finance_accounts")
      .delete()
      .eq("tenant_id", currentTenant?.tenant_id)
      .eq("connected_id_key", configKey);
    toast.success("연동 삭제 완료");
    fetchAll();
  };

  const renderConnectedSection = (type: "BK" | "CD", icon: React.ReactNode, title: string, color: string) => {
    const filtered = connectedIds.filter((id) => id.config_key.includes(`_${type}_`));
    return (
      <Card className="border-none shadow-md rounded-2xl">
        <CardHeader>
          <CardTitle className={`text-md flex items-center gap-2 ${color}`}>
            {icon} {title}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {filtered.length === 0 && (
            <p className="text-sm text-muted-foreground text-center py-4">연동된 {type === "BK" ? "은행" : "카드"}이 없습니다.</p>
          )}
          {filtered.map((item) => {
            const orgCode = item.config_key.split("_").pop()!;
            const orgName = getOrgName(orgCode, type);
            const relatedAccounts = accounts.filter((a) => a.connected_id_key === item.config_key);

            return (
              <div key={item.id} className="p-4 bg-muted/50 rounded-xl border space-y-3">
                <div className="flex justify-between items-center">
                  <div>
                    <p className="text-sm font-bold">{orgName}</p>
                    <p className="text-[10px] font-mono text-muted-foreground">{item.config_value}</p>
                  </div>
                  <div className="flex gap-1">
                    <Button size="sm" variant="outline" className="text-xs h-7"
                      onClick={() => openAddAccount(item)}>
                      <Plus className="w-3 h-3 mr-1" /> {type === "BK" ? "계좌" : "카드"} 추가
                    </Button>
                    <Button variant="ghost" size="icon" className="text-destructive h-7 w-7"
                      onClick={() => handleDeleteConnectedId(item.id, item.config_key)}>
                      <Trash2 size={14} />
                    </Button>
                  </div>
                </div>

                {relatedAccounts.length > 0 && (
                  <div className="space-y-1.5 pl-3 border-l-2 border-primary/20">
                    {relatedAccounts.map((acc) => (
                      <div key={acc.id} className="flex items-center justify-between text-xs bg-background p-2 rounded-lg">
                        <div className="flex items-center gap-2">
                          <Badge variant="secondary" className="text-[10px]">
                            {acc.account_alias || (type === "BK" ? "계좌" : "카드")}
                          </Badge>
                          <span className="font-mono text-muted-foreground">
                            {acc.account_number || "전체"}
                          </span>
                        </div>
                        <Button variant="ghost" size="icon" className="h-6 w-6 text-destructive"
                          onClick={() => handleDeleteAccount(acc.id)}>
                          <Trash2 size={12} />
                        </Button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </CardContent>
      </Card>
    );
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto space-y-8">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <Database className="text-primary" /> 금융 연동 마스터
          </h1>
          <Button onClick={() => setIsDialogOpen(true)} className="rounded-xl px-6 h-12 font-bold shadow-lg">
            <Plus className="mr-2" /> 신규 Connected ID 발급
          </Button>
        </div>

        {/* CODEF 마스터 키 */}
        <Card className="border-none shadow-md rounded-2xl">
          <CardHeader>
            <CardTitle className="text-lg">CODEF API 설정 (공통)</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1">
                <Label>Client ID</Label>
                <Input value={masterConfigs.CODEF_CLIENT_ID}
                  onChange={(e) => setMasterConfigs({ ...masterConfigs, CODEF_CLIENT_ID: e.target.value })} />
              </div>
              <div className="space-y-1">
                <Label>Client Secret</Label>
                <Input type="password" value={masterConfigs.CODEF_CLIENT_SECRET}
                  onChange={(e) => setMasterConfigs({ ...masterConfigs, CODEF_CLIENT_SECRET: e.target.value })} />
              </div>
            </div>
            <div className="space-y-1">
              <Label>RSA Public Key</Label>
              <Textarea className="font-mono text-xs h-24" value={masterConfigs.CODEF_PUBLIC_KEY}
                onChange={(e) => setMasterConfigs({ ...masterConfigs, CODEF_PUBLIC_KEY: e.target.value })} />
            </div>
            <Button onClick={handleSaveMasters} disabled={processing} className="w-full">
              <Save className="mr-2 w-4 h-4" /> 마스터 정보 저장
            </Button>
          </CardContent>
        </Card>

        {/* 은행/카드 연동 목록 + 계좌 */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {renderConnectedSection("BK", <Landmark size={18} />, "은행 연동 & 계좌", "text-amber-600")}
          {renderConnectedSection("CD", <CreditCard size={18} />, "카드 연동", "text-blue-600")}
        </div>

        {/* Connected ID 발급 다이얼로그 */}
        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent className="sm:max-w-md rounded-3xl">
            <DialogHeader>
              <DialogTitle>신규 Connected ID 생성</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1.5">
                  <Label>유형</Label>
                  <Select value={form.type} onValueChange={(v) => setForm({ ...form, type: v, orgCode: v === "BK" ? "0004" : "0301" })}>
                    <SelectTrigger><SelectValue /></SelectTrigger>
                    <SelectContent>
                      <SelectItem value="BK">은행 (계좌)</SelectItem>
                      <SelectItem value="CD">카드 (법인)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-1.5">
                  <Label>기관 선택</Label>
                  <Select value={form.orgCode} onValueChange={(v) => setForm({ ...form, orgCode: v })}>
                    <SelectTrigger><SelectValue /></SelectTrigger>
                    <SelectContent>
                      {(form.type === "BK" ? BANK_CODES : CARD_CODES).map((b) => (
                        <SelectItem key={b.code} value={b.code}>{b.name}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              {form.type === "BK" ? (
                <div className="space-y-2">
                  <Label>공동인증서 (NPKI)</Label>
                  <Input type="file" className="text-xs" onChange={(e) => setDerFile(e.target.files?.[0] || null)} />
                  <Input type="file" className="text-xs" onChange={(e) => setKeyFile(e.target.files?.[0] || null)} />
                </div>
              ) : (
                <div className="space-y-1.5">
                  <Label>카드사 로그인 ID</Label>
                  <Input value={form.loginId} onChange={(e) => setForm({ ...form, loginId: e.target.value })}
                    placeholder="카드사 웹사이트 로그인 아이디" />
                </div>
              )}
              <div className="space-y-1.5">
                <Label>{form.type === "BK" ? "인증서 비밀번호" : "카드사 로그인 비밀번호"}</Label>
                <Input type="password" value={form.password}
                  onChange={(e) => setForm({ ...form, password: e.target.value })} />
              </div>
            </div>
            <DialogFooter>
              <Button onClick={handleGenerateId} disabled={processing} className="w-full h-11 font-bold">
                {processing ? <RefreshCw className="animate-spin mr-2" /> : <ShieldCheck className="mr-2" />}
                연동 ID 발급 시작
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* 계좌/카드 추가 다이얼로그 */}
        <Dialog open={isAccountDialogOpen} onOpenChange={setIsAccountDialogOpen}>
          <DialogContent className="sm:max-w-md rounded-3xl">
            <DialogHeader>
              <DialogTitle>
                {accountForm.businessType === "BK" ? "계좌번호 등록" : "카드번호 등록"}
              </DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="space-y-1.5">
                <Label>기관</Label>
                <Input value={getOrgName(accountForm.organization, accountForm.businessType)} disabled />
              </div>
              <div className="space-y-1.5">
                <Label>{accountForm.businessType === "BK" ? "계좌번호" : "카드번호"}</Label>
                <Input value={accountForm.accountNumber}
                  onChange={(e) => setAccountForm({ ...accountForm, accountNumber: e.target.value })}
                  placeholder={accountForm.businessType === "BK" ? "예: 08660104141706" : "비워두면 전체 카드"} />
              </div>
              <div className="space-y-1.5">
                <Label>별칭 (선택)</Label>
                <Input value={accountForm.accountAlias}
                  onChange={(e) => setAccountForm({ ...accountForm, accountAlias: e.target.value })}
                  placeholder="예: 급여통장, 운영자금" />
              </div>
            </div>
            <DialogFooter>
              <Button onClick={handleAddAccount} disabled={processing} className="w-full h-11 font-bold">
                {processing ? <RefreshCw className="animate-spin mr-2" /> : <Plus className="mr-2" />}
                등록
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </main>
    </div>
  );
};

export default FinanceSettings;



============================================================
File Path: src/pages/admin/HRManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Users, UserPlus, Search, Loader2, ChevronRight, Navigation, ArrowLeft, ShieldCheck, Zap, Ban, UserCheck } from "lucide-react";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

const HRManagement = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [members, setMembers] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");

  const fetchMembers = async () => {
    if (!currentTenant) return;
    setLoading(true);

    // 쿼리문에서 주석(//)을 모두 제거한 깨끗한 상태여야 합니다.
    const { data, error } = await supabase
      .from("tenant_memberships")
      .select(
        `
        user_id,
        id,
        role,
        department,
        job_title,
        is_suspended,
        suspended_at,
        profiles:user_id ( id, full_name, email, avatar_url )
      `,
      )
      .eq("tenant_id", currentTenant.tenant_id);

    if (error) {
      console.error("멤버 로드 에러:", error);
    } else {
      setMembers(data || []);
    }
    setLoading(false);
  };

  useEffect(() => {
    fetchMembers();
  }, [currentTenant]);

  const activeMembers = members.filter((m) => !m.is_suspended);
  const suspendedMembers = members.filter((m) => m.is_suspended);

  const filteredMembers = activeMembers.filter(
    (m) =>
      m.profiles?.full_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.department?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.profiles?.email?.toLowerCase().includes(searchQuery.toLowerCase()),
  );

  const filteredSuspended = suspendedMembers.filter(
    (m) =>
      m.profiles?.full_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.department?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.profiles?.email?.toLowerCase().includes(searchQuery.toLowerCase()),
  );

  return (
    <div className="min-h-screen bg-[#F1F5F9]">
      <Header />
      <main className="pt-24 pb-16 px-6 max-w-7xl mx-auto">
        {/* 1. 상단 헤더 & 액션 바 - 사이즈 축소 */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              className="rounded-lg bg-white shadow-sm border border-slate-300 w-9 h-9 hover:bg-slate-50 transition-all"
              onClick={() => navigate("/admin")}
            >
              <ArrowLeft className="w-4 h-4 text-slate-600" />
            </Button>
            <div>
              <div className="flex items-center gap-1.5">
                <h1 className="text-xl font-black tracking-tight text-slate-900">인사 관리</h1>
                <Badge variant="outline" className="bg-blue-50 text-blue-600 border-blue-100 text-[10px] h-4">
                  ADMIN
                </Badge>
              </div>
              <p className="text-slate-500 text-[11px] font-bold">임직원 데이터 및 시스템 권한 통합 관리</p>
            </div>
          </div>
          <Button
            onClick={() => navigate("/onboarding")}
            size="sm"
            className="bg-blue-600 hover:bg-blue-700 h-9 px-4 rounded-lg font-bold text-xs shadow-md transition-all active:scale-95"
          >
            <UserPlus className="mr-1.5 w-3.5 h-3.5" /> 직원 등록
          </Button>
        </div>

        {/* 2. 인사 통계 요약 (Dashboard Cards) */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                <Users size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">활성 인원</p>
                <p className="text-lg font-black text-slate-800">
                  {activeMembers.length} <span className="text-[10px] font-medium text-slate-400">명</span>
                </p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600">
                <Zap size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">부서 수</p>
                <p className="text-lg font-black text-slate-800">
                  {new Set(members.map((m) => m.department).filter(Boolean)).size}{" "}
                  <span className="text-[10px] font-medium text-slate-400">개</span>
                </p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600">
                <ShieldCheck size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">관리자</p>
                <p className="text-lg font-black text-slate-800">
                  {activeMembers.filter((m) => m.role === "company_admin").length}{" "}
                  <span className="text-[10px] font-medium text-slate-400">명</span>
                </p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center text-red-600">
                <Ban size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">정지 인원</p>
                <p className="text-lg font-black text-slate-800">
                  {suspendedMembers.length}{" "}
                  <span className="text-[10px] font-medium text-slate-400">명</span>
                </p>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* 3. 검색 영역 - 슬림화 (h-10) */}
        <div className="mb-6 relative group">
          <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors" />
          <Input
            placeholder="이름, 부서 또는 이메일 검색..."
            className="pl-10 h-10 rounded-lg border border-slate-300 shadow-sm bg-white text-xs font-medium placeholder:text-slate-300 focus:ring-1 focus:ring-blue-200 transition-all"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>

        {/* 4. 직원 테이블 리스트 - 타이틀 레이블 등 정보 밀도 상향 */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-300 overflow-hidden">
          <Table>
            <TableHeader className="bg-slate-50 border-b border-slate-300">
              <TableRow className="hover:bg-transparent border-none">
                <TableHead className="w-[300px] py-3 px-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  Employee
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  Team / Pos
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Role</TableHead>
                <TableHead className="text-right px-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  Mgt
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={4} className="h-40 text-center">
                    <Loader2 className="animate-spin mx-auto text-blue-600 w-6 h-6" />
                  </TableCell>
                </TableRow>
              ) : filteredMembers.length > 0 ? (
                filteredMembers.map((member) => (
                  <TableRow
                    key={member.id}
                    className="cursor-pointer hover:bg-slate-50 transition-all group border-b border-slate-200 last:border-none"
                    onClick={() => navigate(`/admin/hr/${member.user_id}`)}
                  >
                    <TableCell className="py-3 px-6">
                      <div className="flex items-center gap-3">
                        <Avatar className="w-9 h-9 border border-slate-200 shadow-sm">
                          <AvatarImage src={member.profiles?.avatar_url} />
                          <AvatarFallback className="bg-slate-100 text-slate-600 font-bold text-xs">
                            {member.profiles?.full_name?.charAt(0)}
                          </AvatarFallback>
                        </Avatar>
                        <div>
                          <div className="font-bold text-slate-900 text-sm tracking-tight">
                            {member.profiles?.full_name}
                          </div>
                          <div className="text-[10px] text-slate-400 font-medium">{member.profiles?.email}</div>
                        </div>
                      </div>
                    </TableCell>
                    <TableCell>
                      <div className="flex flex-col">
                        <div className="text-xs font-bold text-slate-700">{member.job_title || "미지정"}</div>
                        <div className="text-[9px] font-bold text-blue-500 uppercase">{member.department || "N/A"}</div>
                      </div>
                    </TableCell>
                    <TableCell>
                      <Badge variant="outline" className="text-[9px] font-black px-2 py-0">
                        {member.role === "company_admin" ? "관리자" : member.role === "manager" ? "매니저" : "사원"}
                      </Badge>
                    </TableCell>
                    <TableCell className="text-right px-6">
                      <div className="inline-flex items-center justify-center w-7 h-7 rounded-lg bg-slate-50 border border-slate-200 text-slate-400 group-hover:bg-blue-600 group-hover:text-white group-hover:border-blue-600 transition-all">
                        <ChevronRight className="w-3.5 h-3.5" />
                      </div>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={4} className="h-40 text-center">
                    <p className="text-slate-300 font-bold text-sm">데이터가 없습니다.</p>
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </div>

        {/* 5. 정지된 직원 리스트 */}
        {suspendedMembers.length > 0 && (
          <>
            <h2 className="text-sm font-black text-red-600 mt-8 mb-3 flex items-center gap-2">
              <Ban className="w-4 h-4" /> 정지된 직원 ({filteredSuspended.length}명)
            </h2>
            <div className="bg-white rounded-xl shadow-sm border border-red-200 overflow-hidden mb-6">
              <Table>
                <TableHeader className="bg-red-50 border-b border-red-200">
                  <TableRow className="hover:bg-transparent border-none">
                    <TableHead className="w-[300px] py-3 px-6 text-[9px] font-black text-red-400 uppercase tracking-widest">
                      Employee
                    </TableHead>
                    <TableHead className="text-[9px] font-black text-red-400 uppercase tracking-widest">
                      Team / Pos
                    </TableHead>
                    <TableHead className="text-[9px] font-black text-red-400 uppercase tracking-widest">상태</TableHead>
                    <TableHead className="text-right px-6 text-[9px] font-black text-red-400 uppercase tracking-widest">
                      Mgt
                    </TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredSuspended.map((member) => (
                    <TableRow
                      key={member.id}
                      className="cursor-pointer hover:bg-red-50/50 transition-all group border-b border-red-100 last:border-none opacity-70"
                      onClick={() => navigate(`/admin/hr/${member.user_id}`)}
                    >
                      <TableCell className="py-3 px-6">
                        <div className="flex items-center gap-3">
                          <Avatar className="w-9 h-9 border border-red-200 shadow-sm grayscale">
                            <AvatarImage src={member.profiles?.avatar_url} />
                            <AvatarFallback className="bg-red-50 text-red-400 font-bold text-xs">
                              {member.profiles?.full_name?.charAt(0)}
                            </AvatarFallback>
                          </Avatar>
                          <div>
                            <div className="font-bold text-slate-600 text-sm tracking-tight line-through">
                              {member.profiles?.full_name}
                            </div>
                            <div className="text-[10px] text-slate-400 font-medium">{member.profiles?.email}</div>
                          </div>
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex flex-col">
                          <div className="text-xs font-bold text-slate-500">{member.job_title || "미지정"}</div>
                          <div className="text-[9px] font-bold text-slate-400 uppercase">{member.department || "N/A"}</div>
                        </div>
                      </TableCell>
                      <TableCell>
                        <Badge className="bg-red-600 text-[9px] font-black px-2 py-0">
                          정지됨
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right px-6">
                        <div className="inline-flex items-center justify-center w-7 h-7 rounded-lg bg-red-50 border border-red-200 text-red-400 group-hover:bg-red-600 group-hover:text-white group-hover:border-red-600 transition-all">
                          <ChevronRight className="w-3.5 h-3.5" />
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          </>
        )}
      </main>
    </div>
  );
};

export default HRManagement;



============================================================
File Path: src/pages/admin/InternalMail.tsx
============================================================
import { useState, useEffect } from "react";
import DOMPurify from "dompurify";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { 
  Mail, Inbox, Send, Star, Trash2, Search, ArrowLeft, 
  Paperclip, Reply, Forward, Loader2, AlertCircle, Settings
} from "lucide-react";
import { cn } from "@/lib/utils";
import { toast } from "sonner";

interface MailItem {
  id: string;
  subject: string;
  sender: string;
  date: string;
  snippet: string;
  unread: boolean;
}

interface MailDetail {
  id: string;
  subject: string;
  sender: string;
  to: string;
  date: string;
  body: string;
  attachments: { id: string; filename: string; mimeType: string; size: number }[];
}

interface MailConfig {
  id: string;
  provider: string;
  is_active: boolean;
  google_email: string | null;
  nw_user_id: string | null;
}

const InternalMail = () => {
  const navigate = useNavigate();
  const { user, currentTenant } = useAuth();
  const [configs, setConfigs] = useState<MailConfig[]>([]);
  const [activeConfig, setActiveConfig] = useState<MailConfig | null>(null);
  const [mails, setMails] = useState<MailItem[]>([]);
  const [selectedMailId, setSelectedMailId] = useState<string | null>(null);
  const [mailDetail, setMailDetail] = useState<MailDetail | null>(null);
  const [loading, setLoading] = useState(true);
  const [loadingDetail, setLoadingDetail] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");

  // Load mail configs
  useEffect(() => {
    if (!user || !currentTenant) return;
    const load = async () => {
      const { data } = await supabase
        .from("user_mail_configs")
        .select("id, provider, is_active, google_email, nw_user_id")
        .eq("user_id", user.id)
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("is_active", true);

      if (data && data.length > 0) {
        setConfigs(data as MailConfig[]);
        setActiveConfig(data[0] as MailConfig);
      }
      setLoading(false);
    };
    load();
  }, [user, currentTenant]);

  // Fetch mails when active config changes
  useEffect(() => {
    if (!activeConfig) return;
    fetchMails();
  }, [activeConfig]);

  const fetchMails = async () => {
    if (!activeConfig) return;
    setLoading(true);
    try {
      const res = await supabase.functions.invoke("fetch-mail", {
        body: {
          action: "list",
          configId: activeConfig.id,
          provider: activeConfig.provider,
          maxResults: 20,
        },
      });

      if (res.error) throw res.error;
      if (res.data?.mails) {
        setMails(res.data.mails);
      } else if (res.data?.error) {
        toast.error(res.data.error);
      }
    } catch (e: any) {
      toast.error("메일 목록 불러오기 실패: " + e.message);
    } finally {
      setLoading(false);
    }
  };

  const readMail = async (mailId: string) => {
    if (!activeConfig) return;
    setSelectedMailId(mailId);
    setLoadingDetail(true);
    try {
      const res = await supabase.functions.invoke("fetch-mail", {
        body: {
          action: "read",
          configId: activeConfig.id,
          provider: activeConfig.provider,
          messageId: mailId,
        },
      });

      if (res.error) throw res.error;
      if (res.data) {
        setMailDetail(res.data as MailDetail);
      }
    } catch (e: any) {
      toast.error("메일 읽기 실패: " + e.message);
    } finally {
      setLoadingDetail(false);
    }
  };

  const filteredMails = searchQuery
    ? mails.filter(m => 
        m.subject.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.sender.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : mails;

  // No config - show setup prompt
  if (!loading && configs.length === 0) {
    return (
      <div className="h-full flex flex-col bg-background overflow-hidden">
        <div className="h-14 border-b flex items-center px-6 shrink-0 bg-muted/30">
          <Button variant="ghost" size="sm" onClick={() => navigate(-1)} className="gap-2">
            <ArrowLeft className="w-4 h-4" /> 뒤로가기
          </Button>
        </div>
        <div className="flex-1 flex items-center justify-center">
          <div className="text-center max-w-md px-6">
            <div className="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-6">
              <Mail className="w-10 h-10 text-primary/50" />
            </div>
            <h2 className="text-xl font-bold mb-2">메일 연동이 필요합니다</h2>
            <p className="text-sm text-muted-foreground mb-6">
              사내 메일함을 사용하려면 먼저 마이페이지에서 Gmail 또는 네이버웍스 계정을 연동해주세요.
            </p>
            <div className="flex gap-3 justify-center">
              <Button variant="outline" onClick={() => navigate("/my-page")} className="rounded-xl gap-2">
                <Settings className="w-4 h-4" /> 마이페이지에서 설정
              </Button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full flex flex-col bg-background overflow-hidden">
      {/* 상단 컨트롤 바 */}
      <div className="h-14 border-b flex items-center justify-between px-6 shrink-0 bg-muted/30">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" onClick={() => navigate(-1)} className="gap-2">
            <ArrowLeft className="w-4 h-4" /> 뒤로가기
          </Button>
          <div className="h-4 w-px bg-border" />
          <h2 className="font-bold text-foreground flex items-center gap-2">
            <Inbox className="w-4 h-4 text-primary" /> 수신함
          </h2>
          {/* Provider selector */}
          {configs.length > 1 && (
            <div className="flex gap-1">
              {configs.map(c => (
                <Button
                  key={c.id}
                  variant={activeConfig?.id === c.id ? "default" : "ghost"}
                  size="sm"
                  className="h-7 text-xs rounded-full px-3"
                  onClick={() => { setActiveConfig(c); setSelectedMailId(null); setMailDetail(null); }}
                >
                  {c.provider === "gmail" ? "Gmail" : "네이버웍스"}
                </Button>
              ))}
            </div>
          )}
          {activeConfig && (
            <Badge variant="secondary" className="text-[10px]">
              {activeConfig.provider === "gmail" ? activeConfig.google_email : activeConfig.nw_user_id}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-2">
          <div className="relative w-64">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input 
              placeholder="메일 검색..." 
              className="pl-9 h-9 text-xs border-border rounded-xl"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
            />
          </div>
          <Button size="sm" variant="ghost" onClick={fetchMails} disabled={loading}>
            <Loader2 className={cn("w-4 h-4", loading && "animate-spin")} />
          </Button>
        </div>
      </div>

      {/* 메인 레이아웃 */}
      <ResizablePanelGroup direction="horizontal" className="flex-1">
        {/* 폴더 목록 */}
        <ResizablePanel defaultSize={15} minSize={12} className="bg-muted/20 border-r">
          <div className="p-4 space-y-1">
            <Button variant="ghost" className="w-full justify-start gap-3 bg-primary/10 text-primary font-bold rounded-xl h-11">
              <Inbox className="w-4 h-4" /> 수신함
              {mails.filter(m => m.unread).length > 0 && (
                <Badge className="ml-auto">{mails.filter(m => m.unread).length}</Badge>
              )}
            </Button>
            <Button variant="ghost" className="w-full justify-start gap-3 text-muted-foreground hover:bg-muted rounded-xl h-11">
              <Star className="w-4 h-4" /> 중요 메일
            </Button>
            <Button variant="ghost" className="w-full justify-start gap-3 text-muted-foreground hover:bg-muted rounded-xl h-11">
              <Send className="w-4 h-4" /> 보낸 메일함
            </Button>
            <Button variant="ghost" className="w-full justify-start gap-3 text-muted-foreground hover:bg-muted rounded-xl h-11">
              <Trash2 className="w-4 h-4" /> 휴지통
            </Button>
          </div>
        </ResizablePanel>

        <ResizableHandle withHandle />

        {/* 메일 리스트 */}
        <ResizablePanel defaultSize={35} minSize={25}>
          <ScrollArea className="h-full">
            {loading ? (
              <div className="p-8 text-center">
                <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2 text-primary" />
                <p className="text-sm text-muted-foreground">메일을 불러오는 중...</p>
              </div>
            ) : filteredMails.length === 0 ? (
              <div className="p-8 text-center">
                <Mail className="w-10 h-10 mx-auto mb-3 text-muted-foreground/20" />
                <p className="text-sm text-muted-foreground">메일이 없습니다.</p>
              </div>
            ) : (
              <div className="divide-y border-r">
                {filteredMails.map((mail) => (
                  <div
                    key={mail.id}
                    onClick={() => readMail(mail.id)}
                    className={cn(
                      "p-5 cursor-pointer transition-all hover:bg-muted/50 flex flex-col gap-1 relative",
                      selectedMailId === mail.id ? "bg-primary/5 border-l-4 border-l-primary" : "bg-background"
                    )}
                  >
                    <div className="flex justify-between items-center">
                      <span className={cn("text-xs font-bold", mail.unread ? "text-primary" : "text-muted-foreground")}>
                        {mail.sender.replace(/<.*>/, "").trim()}
                      </span>
                      <span className="text-[10px] text-muted-foreground">{formatDate(mail.date)}</span>
                    </div>
                    <h4 className={cn("text-sm truncate", mail.unread ? "font-black text-foreground" : "font-medium text-foreground/80")}>
                      {mail.subject}
                    </h4>
                    <p className="text-xs text-muted-foreground line-clamp-1">{mail.snippet}</p>
                    {mail.unread && (
                      <div className="absolute top-5 right-5 w-2 h-2 rounded-full bg-primary" />
                    )}
                  </div>
                ))}
              </div>
            )}
          </ScrollArea>
        </ResizablePanel>

        <ResizableHandle withHandle />

        {/* 메일 본문 */}
        <ResizablePanel defaultSize={50}>
          {loadingDetail ? (
            <div className="h-full flex items-center justify-center">
              <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
          ) : mailDetail ? (
            <div className="h-full flex flex-col animate-in fade-in slide-in-from-right-1 duration-300">
              <div className="p-8 border-b">
                <div className="flex justify-between items-start mb-6">
                  <h1 className="text-2xl font-black text-foreground tracking-tight leading-tight flex-1 mr-4">
                    {mailDetail.subject}
                  </h1>
                  <div className="flex gap-2 shrink-0">
                    <Button variant="outline" size="icon" className="rounded-full w-8 h-8 text-muted-foreground hover:text-primary">
                      <Reply className="w-4 h-4"/>
                    </Button>
                    <Button variant="outline" size="icon" className="rounded-full w-8 h-8 text-muted-foreground hover:text-amber-500">
                      <Star className="w-4 h-4"/>
                    </Button>
                    <Button variant="outline" size="icon" className="rounded-full w-8 h-8 text-muted-foreground hover:text-destructive">
                      <Trash2 className="w-4 h-4"/>
                    </Button>
                  </div>
                </div>
                
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary font-black text-xl">
                    {mailDetail.sender.charAt(0).toUpperCase()}
                  </div>
                  <div className="flex-1">
                    <div className="font-bold text-foreground">{mailDetail.sender.replace(/<.*>/, "").trim()}</div>
                    <div className="text-xs text-muted-foreground">
                      받는 사람: {mailDetail.to} · {formatDate(mailDetail.date)}
                    </div>
                  </div>
                </div>
              </div>

              <ScrollArea className="flex-1 p-8">
                <div 
                  className="max-w-3xl text-foreground/80 leading-relaxed whitespace-pre-wrap text-[15px]"
                  dangerouslySetInnerHTML={
                    mailDetail.body.includes("<") 
                      ? { __html: sanitizeHtml(mailDetail.body) } 
                      : undefined
                  }
                >
                  {!mailDetail.body.includes("<") ? mailDetail.body : undefined}
                </div>
                
                {/* 첨부파일 */}
                {mailDetail.attachments.length > 0 && (
                  <div className="mt-8 space-y-2">
                    <p className="text-xs font-bold text-muted-foreground">첨부파일 ({mailDetail.attachments.length})</p>
                    {mailDetail.attachments.map(att => (
                      <div key={att.id} className="p-3 rounded-2xl border bg-muted/30 flex items-center gap-3 w-fit">
                        <div className="w-10 h-10 bg-background rounded-lg border flex items-center justify-center">
                          <Paperclip className="w-4 h-4 text-muted-foreground" />
                        </div>
                        <div>
                          <div className="text-xs font-bold text-foreground">{att.filename}</div>
                          <div className="text-[10px] text-muted-foreground uppercase">
                            {formatFileSize(att.size)} · {att.mimeType}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </ScrollArea>
              
              <div className="p-6 border-t bg-muted/20 flex gap-3">
                <Button variant="outline" className="rounded-xl flex-1 gap-2">
                  <Reply className="w-4 h-4"/> 답장하기
                </Button>
                <Button variant="outline" className="rounded-xl flex-1 gap-2">
                  <Forward className="w-4 h-4"/> 전달하기
                </Button>
              </div>
            </div>
          ) : (
            <div className="h-full flex items-center justify-center text-muted-foreground flex-col gap-4">
              <Mail className="w-16 h-16 opacity-10" />
              <p className="font-bold text-muted-foreground">조회할 메일을 선택해 주세요.</p>
            </div>
          )}
        </ResizablePanel>
      </ResizablePanelGroup>
    </div>
  );
};

// Helpers
function formatDate(dateStr: string): string {
  if (!dateStr) return "";
  try {
    const d = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - d.getTime();
    const days = Math.floor(diff / 86400000);
    
    if (days === 0) {
      return d.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit" });
    } else if (days === 1) {
      return "어제";
    } else if (days < 7) {
      return `${days}일 전`;
    }
    return d.toLocaleDateString("ko-KR", { month: "short", day: "numeric" });
  } catch {
    return dateStr;
  }
}

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return bytes + "B";
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + "KB";
  return (bytes / 1048576).toFixed(1) + "MB";
}

function sanitizeHtml(html: string): string {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      "p", "br", "b", "i", "u", "strong", "em", "a", "ul", "ol", "li",
      "h1", "h2", "h3", "h4", "h5", "h6", "blockquote", "span", "div",
      "table", "thead", "tbody", "tr", "th", "td", "pre", "code", "hr",
    ],
    ALLOWED_ATTR: ["href", "target", "rel", "style", "class"],
    FORBID_TAGS: ["script", "object", "embed", "form", "input", "iframe", "svg"],
    FORBID_ATTR: ["onerror", "onload", "onclick", "onmouseover"],
    ALLOW_DATA_ATTR: false,
  });
}

export default InternalMail;



============================================================
File Path: src/pages/admin/KeywordManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from "@/components/ui/table";
import {
  Sheet, SheetContent, SheetHeader, SheetTitle, SheetFooter, SheetClose
} from "@/components/ui/sheet";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue
} from "@/components/ui/select";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import {
  Hash, Plus, Search, Loader2, Save, Edit2, Trash2, AlertCircle, Tags, ArrowUpDown
} from "lucide-react";

interface Keyword {
  id: string;
  tenant_id: string;
  keyword: string;
  category: string | null;
  priority: number;
  is_active: boolean;
  created_at: string;
}

const categoryOptions = ["브랜드", "제품", "이벤트", "인물", "기타"];

const KeywordManagement = () => {
  const { currentTenant, isCompanyAdmin, isSuperAdmin } = useAuth();
  const [keywords, setKeywords] = useState<Keyword[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [filterCategory, setFilterCategory] = useState("");

  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [currentKeyword, setCurrentKeyword] = useState<Keyword | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  const [formData, setFormData] = useState({
    keyword: "",
    category: "",
    priority: 0,
    is_active: true,
  });

  const fetchKeywords = async () => {
    if (!currentTenant) return;
    setLoading(true);

    let query = supabase
      .from("keywords")
      .select("*")
      .eq("tenant_id", currentTenant.tenant_id)
      .order("priority", { ascending: false });

    if (searchQuery) {
      query = query.ilike("keyword", `%${searchQuery}%`);
    }
    if (filterCategory && filterCategory !== "ALL") {
      query = query.eq("category", filterCategory);
    }

    const { data, error } = await query;
    if (error) {
      toast.error("키워드를 불러오는 데 실패했습니다.");
    } else {
      setKeywords(data || []);
    }
    setLoading(false);
  };

  useEffect(() => {
    fetchKeywords();
  }, [currentTenant, searchQuery, filterCategory]);

  const handleSave = async () => {
    if (!formData.keyword || !currentTenant) {
      toast.error("키워드는 필수 입력 항목입니다.");
      return;
    }
    setIsSaving(true);

    try {
      const payload = {
        tenant_id: currentTenant.tenant_id,
        keyword: formData.keyword,
        category: formData.category || null,
        priority: formData.priority,
        is_active: formData.is_active,
      };

      if (currentKeyword) {
        const { error } = await supabase
          .from("keywords")
          .update(payload)
          .eq("id", currentKeyword.id);
        if (error) throw error;
        toast.success("키워드가 수정되었습니다.");
      } else {
        const { error } = await supabase
          .from("keywords")
          .insert(payload);
        if (error) throw error;
        toast.success("키워드가 등록되었습니다.");
      }
      setIsSheetOpen(false);
      fetchKeywords();
    } catch (error: any) {
      toast.error(`저장 실패: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDelete = async () => {
    if (!currentKeyword) return;
    setIsSaving(true);
    try {
      const { error } = await supabase
        .from("keywords")
        .delete()
        .eq("id", currentKeyword.id);
      if (error) throw error;
      toast.success("키워드가 삭제되었습니다.");
      setIsDeleteDialogOpen(false);
      fetchKeywords();
    } catch (error: any) {
      toast.error(`삭제 실패: ${error.message}`);
    } finally {
      setIsSaving(false);
      setCurrentKeyword(null);
    }
  };

  const handleNewKeyword = () => {
    setCurrentKeyword(null);
    setFormData({ keyword: "", category: "", priority: 0, is_active: true });
    setIsSheetOpen(true);
  };

  const handleEditKeyword = (kw: Keyword) => {
    setCurrentKeyword(kw);
    setFormData({
      keyword: kw.keyword,
      category: kw.category || "",
      priority: kw.priority,
      is_active: kw.is_active,
    });
    setIsSheetOpen(true);
  };

  if (!isCompanyAdmin) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="text-center space-y-4">
          <AlertCircle className="w-12 h-12 text-destructive mx-auto" />
          <p className="text-muted-foreground font-medium">접근 권한이 없습니다.</p>
          <Button onClick={() => window.history.back()} variant="outline">뒤로 가기</Button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background text-foreground">
      <Header />
      <main className="pt-24 pb-16 px-4 max-w-7xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-3">
              <Tags className="w-8 h-8 text-primary" /> 키워드 관리
            </h1>
            <p className="text-muted-foreground mt-1">
              {isSuperAdmin ? "전체 회사" : currentTenant?.tenant.name}의 모니터링 키워드를 관리합니다.
            </p>
          </div>
          <Button variant="hero" className="gap-2" size="lg" onClick={handleNewKeyword}>
            <Plus className="w-5 h-5" /> 키워드 추가
          </Button>
        </div>

        {/* 요약 카드 */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <Card className="glass-card shadow-sm border-primary/10">
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <p className="text-sm font-medium text-muted-foreground">전체 키워드</p>
                <Hash className="w-4 h-4 text-primary" />
              </div>
              <div className="text-2xl font-bold mt-2">{keywords.length}개</div>
            </CardContent>
          </Card>
          <Card className="glass-card shadow-sm border-green-500/10">
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <p className="text-sm font-medium text-muted-foreground">활성 키워드</p>
                <Tags className="w-4 h-4 text-green-500" />
              </div>
              <div className="text-2xl font-bold mt-2">{keywords.filter(k => k.is_active).length}개</div>
            </CardContent>
          </Card>
          <Card className="glass-card shadow-sm border-amber-500/10">
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <p className="text-sm font-medium text-muted-foreground">비활성 키워드</p>
                <ArrowUpDown className="w-4 h-4 text-amber-500" />
              </div>
              <div className="text-2xl font-bold mt-2">{keywords.filter(k => !k.is_active).length}개</div>
            </CardContent>
          </Card>
        </div>

        {/* 필터/검색 */}
        <Card className="glass-card shadow-sm border border-border mb-8">
          <CardContent className="pt-4 flex flex-col sm:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
              <Input
                placeholder="키워드 검색"
                className="pl-9 bg-secondary/50 border-none h-10 text-sm"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
            <Select onValueChange={setFilterCategory} value={filterCategory}>
              <SelectTrigger className="w-full sm:w-[150px] bg-secondary/50 border-none h-10">
                <SelectValue placeholder="카테고리 필터" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="ALL">전체</SelectItem>
                {categoryOptions.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
              </SelectContent>
            </Select>
            <Button variant="outline" onClick={() => { setSearchQuery(""); setFilterCategory(""); }}>
              초기화
            </Button>
          </CardContent>
        </Card>

        {/* 테이블 */}
        <div className="glass-card overflow-hidden shadow-sm border border-border">
          <Table>
            <TableHeader className="bg-secondary/50">
              <TableRow>
                <TableHead className="w-[250px]">키워드</TableHead>
                <TableHead>카테고리</TableHead>
                <TableHead className="text-center">우선순위</TableHead>
                <TableHead className="text-center">상태</TableHead>
                <TableHead className="text-right w-[100px]">액션</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow><TableCell colSpan={5} className="h-32 text-center"><Loader2 className="w-8 h-8 animate-spin mx-auto text-primary" /></TableCell></TableRow>
              ) : keywords.length > 0 ? (
                keywords.map((kw) => (
                  <TableRow key={kw.id} className="hover:bg-secondary/30 transition-colors">
                    <TableCell className="font-semibold">{kw.keyword}</TableCell>
                    <TableCell>
                      {kw.category ? (
                        <Badge variant="outline">{kw.category}</Badge>
                      ) : (
                        <span className="text-muted-foreground text-xs">-</span>
                      )}
                    </TableCell>
                    <TableCell className="text-center">{kw.priority}</TableCell>
                    <TableCell className="text-center">
                      <Badge variant={kw.is_active ? "default" : "secondary"}>
                        {kw.is_active ? "활성" : "비활성"}
                      </Badge>
                    </TableCell>
                    <TableCell className="text-right">
                      <Button variant="ghost" size="icon" className="w-8 h-8" onClick={() => handleEditKeyword(kw)}>
                        <Edit2 className="w-4 h-4 text-blue-500" />
                      </Button>
                      <Button variant="ghost" size="icon" className="w-8 h-8 text-destructive" onClick={() => { setCurrentKeyword(kw); setIsDeleteDialogOpen(true); }}>
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow><TableCell colSpan={5} className="h-32 text-center text-muted-foreground">등록된 키워드가 없습니다.</TableCell></TableRow>
              )}
            </TableBody>
          </Table>
        </div>
      </main>

      {/* 추가/수정 Sheet */}
      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className="sm:max-w-md p-0 overflow-hidden flex flex-col">
          <SheetHeader className="p-6 border-b">
            <SheetTitle className="text-xl font-bold flex items-center gap-2">
              <Tags className="w-5 h-5 text-primary" />
              {currentKeyword ? "키워드 수정" : "새 키워드 등록"}
            </SheetTitle>
          </SheetHeader>
          <div className="p-6 space-y-6 overflow-y-auto flex-1">
            <div className="space-y-2">
              <Label htmlFor="keyword">키워드 *</Label>
              <Input
                id="keyword"
                placeholder="예: 삼성전자, 갤럭시"
                value={formData.keyword}
                onChange={(e) => setFormData({ ...formData, keyword: e.target.value })}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="category">카테고리</Label>
              <Select value={formData.category} onValueChange={(val) => setFormData({ ...formData, category: val })}>
                <SelectTrigger id="category">
                  <SelectValue placeholder="카테고리 선택" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="">선택 안 함</SelectItem>
                  {categoryOptions.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label htmlFor="priority">우선순위 (높을수록 먼저 표시)</Label>
              <Input
                id="priority"
                type="number"
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) || 0 })}
              />
            </div>
            <div className="flex items-center justify-between">
              <Label htmlFor="is_active">활성 상태</Label>
              <Switch
                id="is_active"
                checked={formData.is_active}
                onCheckedChange={(checked) => setFormData({ ...formData, is_active: checked })}
              />
            </div>
          </div>
          <SheetFooter className="p-6 border-t">
            <SheetClose asChild>
              <Button variant="outline" disabled={isSaving}>취소</Button>
            </SheetClose>
            <Button onClick={handleSave} disabled={isSaving || !formData.keyword}>
              {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
              {currentKeyword ? "수정 완료" : "등록"}
            </Button>
          </SheetFooter>
        </SheetContent>
      </Sheet>

      {/* 삭제 확인 Dialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-destructive font-bold text-xl">키워드를 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription>
              "{currentKeyword?.keyword}" 키워드가 영구적으로 삭제됩니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isSaving}>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} disabled={isSaving} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
              {isSaving ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : null}삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default KeywordManagement;



============================================================
File Path: src/pages/admin/LeaveManagement.tsx
============================================================
import React, { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Switch } from "@/components/ui/switch";
import { Textarea } from "@/components/ui/textarea";
import { Plus, Pencil, Trash2, FolderOpen, CalendarPlus, Users, RefreshCw, Download } from "lucide-react";

interface LeaveGroup {
  id: string;
  name: string;
  description: string | null;
  overdraft_limit: number | null;
  is_active: boolean;
  sort_order: number;
}

interface LeaveType {
  id: string;
  group_id: string | null;
  name: string;
  display_name: string | null;
  time_option: string;
  paid_hours: number;
  deduction_days: number;
  special_option: string;
  min_consecutive_days: number;
  max_consecutive_days: number | null;
  include_holidays_in_consecutive: boolean;
  is_paid: boolean;
  is_active: boolean;
}

interface LeaveBalance {
  id: string;
  user_id: string;
  group_id: string | null;
  total_days: number;
  used_days: number;
  generation_type: string;
  memo: string | null;
  valid_from: string;
  valid_until: string | null;
  profile?: { full_name: string | null; email: string };
  group?: { name: string } | null;
}

const LeaveManagement = () => {
  const { currentTenant, isSuperAdmin } = useAuth();
  const tenantId = currentTenant?.tenant_id;

  const [groups, setGroups] = useState<LeaveGroup[]>([]);
  const [types, setTypes] = useState<LeaveType[]>([]);
  const [balances, setBalances] = useState<LeaveBalance[]>([]);
  const [members, setMembers] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // Group form
  const [groupDialog, setGroupDialog] = useState(false);
  const [editGroup, setEditGroup] = useState<LeaveGroup | null>(null);
  const [groupForm, setGroupForm] = useState({ name: "", description: "", overdraft_limit: "" });

  // Type form
  const [typeDialog, setTypeDialog] = useState(false);
  const [editType, setEditType] = useState<LeaveType | null>(null);
  const [typeForm, setTypeForm] = useState({
    group_id: "", name: "", display_name: "", time_option: "full_day",
    paid_hours: "8", deduction_days: "1", special_option: "none",
    min_consecutive_days: "1", max_consecutive_days: "", is_paid: true,
    include_holidays_in_consecutive: false,
  });

  // Balance form
  const [balanceDialog, setBalanceDialog] = useState(false);
  const [balanceForm, setBalanceForm] = useState({
    user_id: "", group_id: "", total_days: "", memo: "",
    valid_from: new Date().toISOString().split("T")[0], valid_until: "",
  });

  useEffect(() => {
    if (tenantId) loadAll();
  }, [tenantId]);

  const loadAll = async () => {
    if (!tenantId) return;
    setLoading(true);
    const [g, t, b, m] = await Promise.all([
      supabase.from("leave_groups").select("*").eq("tenant_id", tenantId).order("sort_order"),
      supabase.from("leave_types").select("*").eq("tenant_id", tenantId).order("sort_order"),
      supabase.from("leave_balances").select("*, profile:profiles(full_name, email), group:leave_groups(name)").eq("tenant_id", tenantId).order("created_at", { ascending: false }),
      supabase.from("tenant_memberships").select("user_id, department, job_title, profile:profiles(full_name, email)").eq("tenant_id", tenantId).eq("is_suspended", false),
    ]);
    if (g.data) setGroups(g.data as any);
    if (t.data) setTypes(t.data as any);
    if (b.data) setBalances(b.data as any);
    if (m.data) setMembers(m.data as any);
    setLoading(false);
  };

  // ===== Group CRUD =====
  const openGroupDialog = (group?: LeaveGroup) => {
    if (group) {
      setEditGroup(group);
      setGroupForm({ name: group.name, description: group.description || "", overdraft_limit: group.overdraft_limit?.toString() ?? "" });
    } else {
      setEditGroup(null);
      setGroupForm({ name: "", description: "", overdraft_limit: "" });
    }
    setGroupDialog(true);
  };

  const saveGroup = async () => {
    if (!tenantId || !groupForm.name.trim()) return;
    const payload = {
      tenant_id: tenantId,
      name: groupForm.name.trim(),
      description: groupForm.description.trim() || null,
      overdraft_limit: groupForm.overdraft_limit === "" ? null : Number(groupForm.overdraft_limit),
    };
    if (editGroup) {
      const { error } = await supabase.from("leave_groups").update(payload).eq("id", editGroup.id);
      if (error) { toast.error("수정 실패: " + error.message); return; }
      toast.success("휴가 그룹 수정 완료");
    } else {
      const { error } = await supabase.from("leave_groups").insert(payload as any);
      if (error) { toast.error("추가 실패: " + error.message); return; }
      toast.success("휴가 그룹 추가 완료");
    }
    setGroupDialog(false);
    loadAll();
  };

  const deleteGroup = async (id: string) => {
    if (!confirm("삭제하시겠습니까?")) return;
    await supabase.from("leave_groups").delete().eq("id", id);
    toast.success("삭제 완료");
    loadAll();
  };

  // ===== Type CRUD =====
  const openTypeDialog = (type?: LeaveType) => {
    if (type) {
      setEditType(type);
      setTypeForm({
        group_id: type.group_id || "", name: type.name, display_name: type.display_name || "",
        time_option: type.time_option, paid_hours: type.paid_hours.toString(),
        deduction_days: type.deduction_days.toString(), special_option: type.special_option,
        min_consecutive_days: type.min_consecutive_days.toString(),
        max_consecutive_days: type.max_consecutive_days?.toString() || "",
        is_paid: type.is_paid, include_holidays_in_consecutive: type.include_holidays_in_consecutive,
      });
    } else {
      setEditType(null);
      setTypeForm({ group_id: "", name: "", display_name: "", time_option: "full_day", paid_hours: "8", deduction_days: "1", special_option: "none", min_consecutive_days: "1", max_consecutive_days: "", is_paid: true, include_holidays_in_consecutive: false });
    }
    setTypeDialog(true);
  };

  const saveType = async () => {
    if (!tenantId || !typeForm.name.trim()) return;
    const payload = {
      tenant_id: tenantId,
      group_id: typeForm.group_id || null,
      name: typeForm.name.trim(),
      display_name: typeForm.display_name.trim() || null,
      time_option: typeForm.time_option,
      paid_hours: Number(typeForm.paid_hours),
      deduction_days: Number(typeForm.deduction_days),
      special_option: typeForm.special_option,
      min_consecutive_days: Number(typeForm.min_consecutive_days),
      max_consecutive_days: typeForm.max_consecutive_days ? Number(typeForm.max_consecutive_days) : null,
      is_paid: typeForm.is_paid,
      include_holidays_in_consecutive: typeForm.include_holidays_in_consecutive,
    };
    if (editType) {
      const { error } = await supabase.from("leave_types").update(payload).eq("id", editType.id);
      if (error) { toast.error("수정 실패: " + error.message); return; }
      toast.success("휴가 유형 수정 완료");
    } else {
      const { error } = await supabase.from("leave_types").insert(payload as any);
      if (error) { toast.error("추가 실패: " + error.message); return; }
      toast.success("휴가 유형 추가 완료");
    }
    setTypeDialog(false);
    loadAll();
  };

  const deleteType = async (id: string) => {
    if (!confirm("삭제하시겠습니까?")) return;
    const { error } = await supabase.from("leave_types").delete().eq("id", id);
    if (error) { toast.error("삭제 실패 (사용 중인 유형은 삭제 불가)"); return; }
    toast.success("삭제 완료");
    loadAll();
  };

  // ===== Balance (휴가 발생) =====
  const saveBalance = async () => {
    if (!tenantId || !balanceForm.user_id || !balanceForm.total_days) return;
    const { error } = await supabase.from("leave_balances").insert({
      tenant_id: tenantId,
      user_id: balanceForm.user_id,
      group_id: balanceForm.group_id || null,
      total_days: Number(balanceForm.total_days),
      generation_type: "manual",
      memo: balanceForm.memo || null,
      valid_from: balanceForm.valid_from,
      valid_until: balanceForm.valid_until || null,
    } as any);
    if (error) { toast.error("발생 실패: " + error.message); return; }
    toast.success("휴가 발생 완료");
    setBalanceDialog(false);
    setBalanceForm({ user_id: "", group_id: "", total_days: "", memo: "", valid_from: new Date().toISOString().split("T")[0], valid_until: "" });
    loadAll();
  };

  // ===== 연차 자동 발생 =====
  const autoGenerateAnnualLeave = async () => {
    if (!tenantId) return;
    // 연차 그룹 확인/생성
    let annualGroupId: string;
    const existing = groups.find(g => g.name === "연차");
    if (existing) {
      annualGroupId = existing.id;
    } else {
      const { data, error } = await supabase.from("leave_groups").insert({ tenant_id: tenantId, name: "연차", description: "근로기준법 기반 연차휴가", overdraft_limit: 0 } as any).select().single();
      if (error || !data) { toast.error("연차 그룹 생성 실패"); return; }
      annualGroupId = data.id;
    }

    // 직원별 입사일 조회 & 연차 계산
    const { data: details } = await supabase.from("employee_details").select("user_id, hire_date").eq("tenant_id", tenantId);
    if (!details || details.length === 0) { toast.info("입사일이 등록된 직원이 없습니다."); return; }

    let count = 0;
    const year = new Date().getFullYear();
    const validFrom = `${year}-01-01`;
    const validUntil = `${year}-12-31`;

    for (const d of details) {
      if (!d.hire_date) continue;
      // 이미 올해 연차 발생 건이 있는지 확인
      const { data: existingBal } = await supabase.from("leave_balances")
        .select("id").eq("tenant_id", tenantId).eq("user_id", d.user_id)
        .eq("group_id", annualGroupId).eq("generation_type", "auto_annual")
        .gte("valid_from", validFrom).lte("valid_from", validUntil).limit(1);
      if (existingBal && existingBal.length > 0) continue;

      // DB 함수로 연차 일수 계산
      const { data: calcResult } = await supabase.rpc("calculate_annual_leave_days", { _hire_date: d.hire_date });
      const days = calcResult as unknown as number;
      if (!days || days <= 0) continue;

      await supabase.from("leave_balances").insert({
        tenant_id: tenantId, user_id: d.user_id, group_id: annualGroupId,
        total_days: days, generation_type: "auto_annual",
        memo: `${year}년 연차 자동발생 (입사일: ${d.hire_date})`,
        valid_from: validFrom, valid_until: validUntil,
      } as any);
      count++;
    }
    toast.success(`${count}명의 연차가 자동 발생되었습니다.`);
    loadAll();
  };

  const deleteBalance = async (id: string) => {
    if (!confirm("삭제하시겠습니까?")) return;
    await supabase.from("leave_balances").delete().eq("id", id);
    toast.success("삭제 완료");
    loadAll();
  };

  // ===== 기본값 불러오기 =====
  const loadDefaults = async () => {
    if (!tenantId) return;
    if (!confirm("시스템 기본 휴가 그룹/유형을 불러오시겠습니까? 기존 데이터와 중복되지 않는 항목만 추가됩니다.")) return;

    const [gRes, tRes] = await Promise.all([
      supabase.from("leave_groups").select("*").is("tenant_id", null),
      supabase.from("leave_types").select("*").is("tenant_id", null),
    ]);

    const defaultGroups = gRes.data || [];
    const defaultTypes = tRes.data || [];
    if (defaultGroups.length === 0 && defaultTypes.length === 0) {
      toast.info("등록된 시스템 기본값이 없습니다."); return;
    }

    let groupCount = 0;
    const groupIdMap: Record<string, string> = {};

    for (const dg of defaultGroups) {
      const exists = groups.find(g => g.name === dg.name);
      if (exists) { groupIdMap[dg.id] = exists.id; continue; }
      const { data } = await supabase.from("leave_groups").insert({
        tenant_id: tenantId, name: dg.name, description: dg.description,
        overdraft_limit: dg.overdraft_limit, sort_order: dg.sort_order,
      } as any).select().single();
      if (data) { groupIdMap[dg.id] = data.id; groupCount++; }
    }

    let typeCount = 0;
    for (const dt of defaultTypes) {
      const exists = types.find(t => t.name === dt.name);
      if (exists) continue;
      await supabase.from("leave_types").insert({
        tenant_id: tenantId, name: dt.name, display_name: dt.display_name,
        group_id: dt.group_id ? (groupIdMap[dt.group_id] || null) : null,
        time_option: dt.time_option, paid_hours: dt.paid_hours,
        deduction_days: dt.deduction_days, special_option: dt.special_option,
        is_paid: dt.is_paid, min_consecutive_days: dt.min_consecutive_days,
        max_consecutive_days: dt.max_consecutive_days,
        include_holidays_in_consecutive: dt.include_holidays_in_consecutive,
      } as any);
      typeCount++;
    }

    toast.success(`그룹 ${groupCount}개, 유형 ${typeCount}개가 추가되었습니다.`);
    loadAll();
  };

  if (loading) return <div className="p-8 text-center text-muted-foreground">로딩 중...</div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-6">
      <h1 className="text-2xl font-bold">휴가 관리</h1>

      <Tabs defaultValue="groups">
        <TabsList>
          <TabsTrigger value="groups">휴가 그룹</TabsTrigger>
          <TabsTrigger value="types">휴가 유형</TabsTrigger>
          <TabsTrigger value="balances">휴가 발생</TabsTrigger>
        </TabsList>

        {/* ===== 휴가 그룹 ===== */}
        <TabsContent value="groups" className="space-y-4">
          <div className="flex justify-between items-center">
            <p className="text-sm text-muted-foreground">비슷한 유형의 휴가를 그룹으로 관리합니다.</p>
            <div className="flex gap-2">
              <Button variant="outline" onClick={loadDefaults}><Download className="w-4 h-4 mr-1" />기본값 불러오기</Button>
              <Button onClick={() => openGroupDialog()}><Plus className="w-4 h-4 mr-1" />휴가 그룹 추가</Button>
            </div>
          </div>
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>그룹명</TableHead>
                  <TableHead>설명</TableHead>
                  <TableHead>초과사용 제한</TableHead>
                  <TableHead>상태</TableHead>
                  <TableHead className="w-24">관리</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {groups.map(g => (
                  <TableRow key={g.id}>
                    <TableCell className="font-medium">{g.name}</TableCell>
                    <TableCell className="text-muted-foreground">{g.description || "-"}</TableCell>
                    <TableCell>
                      {g.overdraft_limit === null ? "제한 없음" : g.overdraft_limit === 0 ? "초과 불가" : `최대 -${g.overdraft_limit}일`}
                    </TableCell>
                    <TableCell><Badge variant={g.is_active ? "default" : "secondary"}>{g.is_active ? "활성" : "비활성"}</Badge></TableCell>
                    <TableCell>
                      <div className="flex gap-1">
                        <Button size="icon" variant="ghost" onClick={() => openGroupDialog(g)}><Pencil className="w-4 h-4" /></Button>
                        <Button size="icon" variant="ghost" onClick={() => deleteGroup(g.id)}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                {groups.length === 0 && <TableRow><TableCell colSpan={5} className="text-center py-8 text-muted-foreground">등록된 휴가 그룹이 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>

        {/* ===== 휴가 유형 ===== */}
        <TabsContent value="types" className="space-y-4">
          <div className="flex justify-between items-center">
            <p className="text-sm text-muted-foreground">다양한 휴가 유형을 등록합니다.</p>
            <Button onClick={() => openTypeDialog()}><Plus className="w-4 h-4 mr-1" />휴가 유형 추가</Button>
          </div>
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>유형명</TableHead>
                  <TableHead>그룹</TableHead>
                  <TableHead>시간옵션</TableHead>
                  <TableHead>유급시간</TableHead>
                  <TableHead>차감일수</TableHead>
                  <TableHead>특별옵션</TableHead>
                  <TableHead>유급</TableHead>
                  <TableHead className="w-24">관리</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {types.map(t => (
                  <TableRow key={t.id}>
                    <TableCell className="font-medium">{t.name}{t.display_name ? ` (${t.display_name})` : ""}</TableCell>
                    <TableCell>{groups.find(g => g.id === t.group_id)?.name || "-"}</TableCell>
                    <TableCell>{t.time_option === "full_day" ? "하루 종일" : "시간 입력"}</TableCell>
                    <TableCell>{t.paid_hours}h</TableCell>
                    <TableCell>{t.deduction_days}일</TableCell>
                    <TableCell>
                      {{ none: "해당없음", long_term: "장기휴가", day_off: "휴무", holiday: "휴일" }[t.special_option] || "-"}
                    </TableCell>
                    <TableCell><Badge variant={t.is_paid ? "default" : "outline"}>{t.is_paid ? "유급" : "무급"}</Badge></TableCell>
                    <TableCell>
                      <div className="flex gap-1">
                        <Button size="icon" variant="ghost" onClick={() => openTypeDialog(t)}><Pencil className="w-4 h-4" /></Button>
                        <Button size="icon" variant="ghost" onClick={() => deleteType(t.id)}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                {types.length === 0 && <TableRow><TableCell colSpan={8} className="text-center py-8 text-muted-foreground">등록된 휴가 유형이 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>

        {/* ===== 휴가 발생 ===== */}
        <TabsContent value="balances" className="space-y-4">
          <div className="flex justify-between items-center flex-wrap gap-2">
            <p className="text-sm text-muted-foreground">직원별 휴가 발생 현황을 관리합니다.</p>
            <div className="flex gap-2">
              <Button variant="outline" onClick={autoGenerateAnnualLeave}><RefreshCw className="w-4 h-4 mr-1" />연차 자동발생</Button>
              <Button onClick={() => setBalanceDialog(true)}><CalendarPlus className="w-4 h-4 mr-1" />수동 발생</Button>
            </div>
          </div>
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>직원</TableHead>
                  <TableHead>휴가 그룹</TableHead>
                  <TableHead>총 발생</TableHead>
                  <TableHead>사용</TableHead>
                  <TableHead>잔여</TableHead>
                  <TableHead>유형</TableHead>
                  <TableHead>유효기간</TableHead>
                  <TableHead>메모</TableHead>
                  <TableHead className="w-16">삭제</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {balances.map(b => (
                  <TableRow key={b.id}>
                    <TableCell className="font-medium">{(b as any).profile?.full_name || (b as any).profile?.email || "-"}</TableCell>
                    <TableCell>{(b as any).group?.name || "-"}</TableCell>
                    <TableCell>{b.total_days}일</TableCell>
                    <TableCell>{b.used_days}일</TableCell>
                    <TableCell className="font-bold">{b.total_days - b.used_days}일</TableCell>
                    <TableCell><Badge variant="outline">{{ manual: "수동", auto_annual: "연차자동", compensatory: "보상" }[b.generation_type] || b.generation_type}</Badge></TableCell>
                    <TableCell className="text-xs">{b.valid_from} ~ {b.valid_until || "무제한"}</TableCell>
                    <TableCell className="text-xs text-muted-foreground">{b.memo || "-"}</TableCell>
                    <TableCell><Button size="icon" variant="ghost" onClick={() => deleteBalance(b.id)}><Trash2 className="w-4 h-4 text-destructive" /></Button></TableCell>
                  </TableRow>
                ))}
                {balances.length === 0 && <TableRow><TableCell colSpan={9} className="text-center py-8 text-muted-foreground">발생된 휴가가 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>
      </Tabs>

      {/* ===== Group Dialog ===== */}
      <Dialog open={groupDialog} onOpenChange={setGroupDialog}>
        <DialogContent>
          <DialogHeader><DialogTitle>{editGroup ? "휴가 그룹 수정" : "휴가 그룹 추가"}</DialogTitle></DialogHeader>
          <div className="space-y-4">
            <div><Label>그룹명 *</Label><Input value={groupForm.name} onChange={e => setGroupForm(p => ({ ...p, name: e.target.value }))} /></div>
            <div><Label>설명</Label><Textarea value={groupForm.description} onChange={e => setGroupForm(p => ({ ...p, description: e.target.value }))} /></div>
            <div>
              <Label>초과사용 제한 (비워두면 제한 없음, 0=초과불가)</Label>
              <Input type="number" value={groupForm.overdraft_limit} onChange={e => setGroupForm(p => ({ ...p, overdraft_limit: e.target.value }))} placeholder="비워두면 제한 없음" />
            </div>
            <Button onClick={saveGroup} className="w-full">{editGroup ? "수정" : "추가"}</Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* ===== Type Dialog ===== */}
      <Dialog open={typeDialog} onOpenChange={setTypeDialog}>
        <DialogContent className="max-w-lg max-h-[80vh] overflow-y-auto">
          <DialogHeader><DialogTitle>{editType ? "휴가 유형 수정" : "휴가 유형 추가"}</DialogTitle></DialogHeader>
          <div className="space-y-4">
            <div>
              <Label>휴가 그룹</Label>
              <Select value={typeForm.group_id} onValueChange={v => setTypeForm(p => ({ ...p, group_id: v }))}>
                <SelectTrigger><SelectValue placeholder="그룹 없음" /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">그룹 없음</SelectItem>
                  {groups.map(g => <SelectItem key={g.id} value={g.id}>{g.name}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
            <div><Label>유형명 *</Label><Input value={typeForm.name} onChange={e => setTypeForm(p => ({ ...p, name: e.target.value }))} /></div>
            <div><Label>표시 이름</Label><Input value={typeForm.display_name} onChange={e => setTypeForm(p => ({ ...p, display_name: e.target.value }))} placeholder="다른 직원에게 보이는 이름" /></div>
            <div>
              <Label>시간 옵션</Label>
              <Select value={typeForm.time_option} onValueChange={v => setTypeForm(p => ({ ...p, time_option: v }))}>
                <SelectTrigger><SelectValue /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="full_day">하루 종일</SelectItem>
                  <SelectItem value="time_input">시간 입력</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div><Label>유급시간 (h)</Label><Input type="number" value={typeForm.paid_hours} onChange={e => setTypeForm(p => ({ ...p, paid_hours: e.target.value }))} /></div>
              <div><Label>차감일수</Label><Input type="number" step="0.5" value={typeForm.deduction_days} onChange={e => setTypeForm(p => ({ ...p, deduction_days: e.target.value }))} /></div>
            </div>
            {typeForm.time_option === "full_day" && (
              <>
                <div>
                  <Label>특별 옵션</Label>
                  <Select value={typeForm.special_option} onValueChange={v => setTypeForm(p => ({ ...p, special_option: v }))}>
                    <SelectTrigger><SelectValue /></SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">해당 없음</SelectItem>
                      <SelectItem value="long_term">장기 휴가</SelectItem>
                      <SelectItem value="day_off">휴무</SelectItem>
                      <SelectItem value="holiday">휴일</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div><Label>최소 연속일수</Label><Input type="number" value={typeForm.min_consecutive_days} onChange={e => setTypeForm(p => ({ ...p, min_consecutive_days: e.target.value }))} /></div>
                  <div><Label>최대 연속일수</Label><Input type="number" value={typeForm.max_consecutive_days} onChange={e => setTypeForm(p => ({ ...p, max_consecutive_days: e.target.value }))} placeholder="제한없음" /></div>
                </div>
                <div className="flex items-center gap-2">
                  <Switch checked={typeForm.include_holidays_in_consecutive} onCheckedChange={v => setTypeForm(p => ({ ...p, include_holidays_in_consecutive: v }))} />
                  <Label>연속일수에 휴무/휴일 포함</Label>
                </div>
              </>
            )}
            <div className="flex items-center gap-2">
              <Switch checked={typeForm.is_paid} onCheckedChange={v => setTypeForm(p => ({ ...p, is_paid: v }))} />
              <Label>유급 휴가</Label>
            </div>
            <Button onClick={saveType} className="w-full">{editType ? "수정" : "추가"}</Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* ===== Balance Dialog ===== */}
      <Dialog open={balanceDialog} onOpenChange={setBalanceDialog}>
        <DialogContent>
          <DialogHeader><DialogTitle>휴가 수동 발생</DialogTitle></DialogHeader>
          <div className="space-y-4">
            <div>
              <Label>직원 *</Label>
              <Select value={balanceForm.user_id} onValueChange={v => setBalanceForm(p => ({ ...p, user_id: v }))}>
                <SelectTrigger><SelectValue placeholder="직원 선택" /></SelectTrigger>
                <SelectContent>
                  {members.map((m: any) => (
                    <SelectItem key={m.user_id} value={m.user_id}>{m.profile?.full_name || m.profile?.email}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>휴가 그룹</Label>
              <Select value={balanceForm.group_id} onValueChange={v => setBalanceForm(p => ({ ...p, group_id: v }))}>
                <SelectTrigger><SelectValue placeholder="그룹 선택" /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">그룹 없음</SelectItem>
                  {groups.map(g => <SelectItem key={g.id} value={g.id}>{g.name}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
            <div><Label>발생 일수 *</Label><Input type="number" step="0.5" value={balanceForm.total_days} onChange={e => setBalanceForm(p => ({ ...p, total_days: e.target.value }))} /></div>
            <div className="grid grid-cols-2 gap-3">
              <div><Label>유효 시작일</Label><Input type="date" value={balanceForm.valid_from} onChange={e => setBalanceForm(p => ({ ...p, valid_from: e.target.value }))} /></div>
              <div><Label>유효 종료일</Label><Input type="date" value={balanceForm.valid_until} onChange={e => setBalanceForm(p => ({ ...p, valid_until: e.target.value }))} /></div>
            </div>
            <div><Label>메모</Label><Textarea value={balanceForm.memo} onChange={e => setBalanceForm(p => ({ ...p, memo: e.target.value }))} /></div>
            <Button onClick={saveBalance} className="w-full">휴가 발생</Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default LeaveManagement;



============================================================
File Path: src/pages/admin/MailSettings.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "sonner";
import { Mail, ArrowLeft, Key, Info, Copy, Save, Loader2, Globe } from "lucide-react";

const MailSettings = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [configs, setConfigs] = useState({ clientId: "", clientSecret: "" });

  const redirectUri = `${window.location.origin}/auth/gmail/callback`;

  useEffect(() => {
    if (currentTenant) fetchConfigs();
  }, [currentTenant]);

  const fetchConfigs = async () => {
    setLoading(true);
    const { data } = await supabase
      .from("tenant_api_configs")
      .select("config_key, config_value")
      .eq("tenant_id", currentTenant?.tenant_id)
      .in("config_key", ["GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET"]);

    if (data) {
      const cid = data.find(d => d.config_key === "GOOGLE_CLIENT_ID")?.config_value || "";
      const sec = data.find(d => d.config_key === "GOOGLE_CLIENT_SECRET")?.config_value || "";
      setConfigs({ clientId: cid, clientSecret: sec });
    }
    setLoading(false);
  };

  const handleSave = async () => {
    if (!currentTenant) return;
    setSaving(true);
    try {
      const updates = [
        { tenant_id: currentTenant.tenant_id, config_key: "GOOGLE_CLIENT_ID", config_value: configs.clientId, category: "email" },
        { tenant_id: currentTenant.tenant_id, config_key: "GOOGLE_CLIENT_SECRET", config_value: configs.clientSecret, category: "email" }
      ];

      const { error } = await supabase.from("tenant_api_configs").upsert(updates, { onConflict: "tenant_id,config_key" });
      if (error) throw error;
      toast.success("메일 서버 설정이 저장되었습니다.");
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success("클립보드에 복사되었습니다.");
  };

  if (loading) return <div className="flex justify-center pt-40"><Loader2 className="animate-spin" /></div>;

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-4xl mx-auto">
        <div className="flex items-center gap-4 mb-8">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}><ArrowLeft className="w-5 h-5" /></Button>
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2"><Mail className="text-blue-500" /> 전사 메일 연동 설정</h1>
            <p className="text-sm text-slate-500">직원들이 Gmail을 연동할 수 있도록 OAuth 클라이언트 정보를 설정합니다.</p>
          </div>
        </div>

        <Alert className="mb-8 bg-blue-50 border-blue-200">
          <Info className="h-4 w-4 text-blue-600" />
          <AlertTitle className="text-blue-800 font-bold">필독: Google Cloud Console 설정</AlertTitle>
          <AlertDescription className="text-blue-700 text-xs space-y-2">
            <p>1. Google Cloud Console에서 [OAuth 2.0 클라이언트 ID]를 생성하세요.</p>
            <p>2. <strong>승인된 리디렉션 URI</strong>에 아래 주소를 반드시 추가해야 합니다:</p>
            <div className="flex items-center gap-2 mt-1">
              <code className="bg-white px-2 py-1 rounded border border-blue-200 flex-1">{redirectUri}</code>
              <Button size="sm" variant="outline" onClick={() => copyToClipboard(redirectUri)}><Copy className="w-3 h-3 mr-1" /> 복사</Button>
            </div>
          </AlertDescription>
        </Alert>

        <Card className="border-none shadow-lg">
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2"><Key className="w-5 h-5 text-amber-500" /> Google OAuth 자격 증명</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div className="space-y-2">
              <Label>Google Client ID</Label>
              <Input value={configs.clientId} onChange={e => setConfigs({...configs, clientId: e.target.value})} placeholder="000000000000-xxx.apps.googleusercontent.com" />
            </div>
            <div className="space-y-2">
              <Label>Google Client Secret</Label>
              <Input type="password" value={configs.clientSecret} onChange={e => setConfigs({...configs, clientSecret: e.target.value})} placeholder="GOCSPX-xxxxxxxxx" />
            </div>
            <Button onClick={handleSave} disabled={saving} className="w-full h-12 text-md font-bold">
              {saving ? <Loader2 className="animate-spin mr-2" /> : <Save className="w-4 h-4 mr-2" />}
              설정 저장
            </Button>
          </CardContent>
        </Card>
      </main>
    </div>
  );
};

export default MailSettings;



============================================================
File Path: src/pages/admin/MediaPitching.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { Card } from "@/components/ui/card";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import { 
  Send, Users, FileText, CheckCircle2, AlertCircle, 
  Search, Filter, Loader2, RefreshCw, Mail, Sparkles, XCircle 
} from "lucide-react";

// 타입 정의
interface Reporter {
  id: string;
  media_company: string;
  reporter_name: string;
  contact_email: string;
  purpose: string | null;
}

interface SendingLog {
  id: string;
  reporter_name: string;
  email: string;
  status: "pending" | "success" | "failed";
  timestamp: string;
}

const MediaPitching = () => {
  // --- 상태 관리 ---
  const [reporters, setReporters] = useState<Reporter[]>([]);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [searchQuery, setSearchQuery] = useState("");
  const [emailSubject, setEmailSubject] = useState("");
  const [emailBody, setEmailBody] = useState(`안녕하십니까, {{언론사명}} {{기자명}} 기자님.\n\n[보도자료 핵심 내용 요약]\n\n귀사의 무궁한 발전을 기원합니다.`);
  
  // 발송 관련 상태
  const [isSending, setIsSending] = useState(false);
  const [sendingLogs, setSendingLogs] = useState<SendingLog[]>([]);
  const [showResults, setShowResults] = useState(false);

  // AI 처리 상태
  const [isPolishing, setIsPolishing] = useState(false);

  // --- 데이터 로드 ---
  useEffect(() => {
    const fetchReporters = async () => {
      const { data, error } = await supabase
        .from("press_contacts")
        .select("*")
        .order("media_company");
      
      if (data) setReporters(data);
    };
    fetchReporters();
  }, []);

  // --- 필터링 로직 ---
  const filteredReporters = reporters.filter(r => 
    r.media_company.includes(searchQuery) || 
    r.reporter_name.includes(searchQuery) ||
    (r.purpose && r.purpose.includes(searchQuery))
  );

  // --- 핸들러 ---
  const toggleSelection = (id: string) => {
    const newSet = new Set(selectedIds);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedIds(newSet);
  };

  const toggleSelectAll = () => {
    if (selectedIds.size === filteredReporters.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(filteredReporters.map(r => r.id)));
    }
  };

  // --- AI 문장 다듬기 핸들러 (Edge Function 호출) ---
  const handleAIPolish = async () => {
    // 본문이 비어있으면 실행하지 않음
    if (!emailBody.trim()) {
      toast.error("다듬을 내용을 본문에 입력해주세요.");
      return;
    }

    setIsPolishing(true);
    
    try {
      // Supabase Edge Function 호출 ('polish-text')
      const { data, error } = await supabase.functions.invoke('polish-text', {
        body: { text: emailBody }
      });

      if (error) {
        throw new Error(error.message || "AI 서버 통신 오류");
      }

      // 결과 처리
      if (data && data.result) {
        setEmailBody(data.result); // 본문을 AI 결과로 교체
        toast.success("AI가 문장을 더 세련되게 다듬었습니다!");
      } else {
        throw new Error("AI 응답이 올바르지 않습니다.");
      }

    } catch (error: any) {
      console.error("AI Polish Error:", error);
      toast.error(`AI 요청 실패: ${error.message}`);
    } finally {
      setIsPolishing(false);
    }
  };

  // --- 발송 시뮬레이션 (실제로는 Edge Function 호출) ---
  const handleBulkSend = async () => {
    if (!emailSubject.trim() || !emailBody.trim()) {
      toast.error("제목과 본문을 입력해주세요.");
      return;
    }
    if (selectedIds.size === 0) {
      toast.error("발송할 기자를 선택해주세요.");
      return;
    }

    setShowResults(true);
    setIsSending(true);
    
    // 1. 발송 대기 목록 생성
    const targetReporters = reporters.filter(r => selectedIds.has(r.id));
    const initialLogs: SendingLog[] = targetReporters.map(r => ({
      id: r.id,
      reporter_name: r.reporter_name,
      email: r.contact_email,
      status: "pending",
      timestamp: new Date().toLocaleTimeString()
    }));
    setSendingLogs(initialLogs);

    // 2. 순차 발송 시뮬레이션
    for (let i = 0; i < initialLogs.length; i++) {
      await new Promise(resolve => setTimeout(resolve, 800)); // 0.8초 딜레이 시뮬레이션

      setSendingLogs(prev => {
        const newLogs = [...prev];
        // 90% 성공 확률 시뮬레이션
        const isSuccess = Math.random() > 0.1;
        newLogs[i] = { 
          ...newLogs[i], 
          status: isSuccess ? "success" : "failed",
          timestamp: new Date().toLocaleTimeString()
        };
        return newLogs;
      });
    }

    setIsSending(false);
    toast.success("발송 작업이 완료되었습니다.");
  };

  return (
    <div className="min-h-screen bg-background flex flex-col">
      <Header />
      
      <main className="flex-1 pt-16 px-4 pb-4 h-[calc(100vh-theme(spacing.4))]">
        <div className="h-full max-w-[1600px] mx-auto flex flex-col">
          {/* Top Bar */}
          <div className="flex items-center justify-between py-4 shrink-0">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <Mail className="w-6 h-6 text-primary" /> 미디어 피칭 센터
              </h1>
              <p className="text-muted-foreground text-sm">슈퍼 어드민이 관리하는 미디어 풀을 활용해 보도자료를 배포합니다.</p>
            </div>
            <div className="flex gap-2">
               <Button variant="outline" onClick={() => {setShowResults(false); setSendingLogs([]);}}>
                <RefreshCw className="w-4 h-4 mr-2" /> 초기화
               </Button>
            </div>
          </div>

          {/* 3-Column Layout */}
          <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0">
            
            {/* Panel 1: 작성 (Write) - 4/12 */}
            <Card className="lg:col-span-4 flex flex-col overflow-hidden border-t-4 border-t-primary shadow-sm h-full">
              <div className="p-4 border-b bg-secondary/20 flex justify-between items-center shrink-0">
                <h3 className="font-bold flex items-center gap-2">
                  <FileText className="w-4 h-4 text-primary" /> 1. 보도자료 작성
                </h3>
                <Badge variant="outline" className="text-xs">Variable Supported</Badge>
              </div>
              <div className="flex-1 p-4 flex flex-col gap-4 overflow-y-auto">
                <div className="space-y-2">














                  
                  <label className="text-sm font-medium">이메일 제목</label>
                  <Input 
                    placeholder="[보도자료] OOO 배우 전속 계약 체결 기사" 
                    value={emailSubject}
                    onChange={(e) => setEmailSubject(e.target.value)}
                    className="font-medium"
                  />
                </div>
                <div className="space-y-2 flex-1 flex flex-col">
                  <div className="flex justify-between items-center">
                    <label className="text-sm font-medium">이메일 본문</label>
                    <Button 
                      variant="ghost" 
                      size="sm" 
                      className="h-6 text-xs text-purple-600 hover:text-purple-700 hover:bg-purple-50"
                      onClick={handleAIPolish} // AI 함수 연결
                      disabled={isPolishing}   // 로딩 중 비활성화
                    >
                      {isPolishing ? (
                        <>
                          <Loader2 className="w-3 h-3 mr-1 animate-spin" /> 다듬는 중...
                        </>
                      ) : (
                        <>
                          <Sparkles className="w-3 h-3 mr-1" /> AI 문장 다듬기
                        </>
                      )}
                    </Button>
                  </div>
                  <Textarea 
                    placeholder="내용을 입력하세요..." 
                    className="flex-1 min-h-[300px] resize-none leading-relaxed"
                    value={emailBody}
                    onChange={(e) => setEmailBody(e.target.value)}
                    disabled={isPolishing} // AI 처리 중 입력 방지
                  />
                  <div className="text-xs text-muted-foreground bg-secondary/50 p-2 rounded">
                    <span className="font-bold">Tip:</span> <code>{'{{기자명}}'}</code>, <code>{'{{언론사명}}'}</code>을 입력하면 발송 시 자동으로 대상의 정보로 치환됩니다.
                  </div>
                </div>
                <div className="pt-2 border-t">
                  <label className="text-sm font-medium mb-2 block">첨부파일</label>
                  <div className="border-2 border-dashed rounded-lg p-4 text-center text-sm text-muted-foreground hover:bg-secondary/50 cursor-pointer transition-colors">
                    클릭하여 보도자료(PDF, Word) 및 이미지 업로드
                  </div>
                </div>
              </div>
            </Card>

            {/* Panel 2: 선택 (Select) - 4/12 */}
            <Card className="lg:col-span-4 flex flex-col overflow-hidden border-t-4 border-t-blue-500 shadow-sm h-full">
              <div className="p-4 border-b bg-secondary/20 shrink-0">
                <h3 className="font-bold flex items-center gap-2 mb-3">
                  <Users className="w-4 h-4 text-blue-500" /> 2. 수신 기자 선택
                </h3>
                <div className="flex gap-2">
                  <div className="relative flex-1">
                    <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted-foreground" />
                    <Input 
                      placeholder="언론사, 기자명 검색" 
                      className="pl-8 h-9 text-sm"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                  </div>
                  <Button variant="ghost" size="icon" className="h-9 w-9 shrink-0">
                    <Filter className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              {/* List Header */}
              <div className="px-4 py-2 border-b bg-white flex items-center justify-between text-sm shrink-0">
                <div className="flex items-center gap-2">
                  <Checkbox 
                    checked={selectedIds.size === filteredReporters.length && filteredReporters.length > 0}
                    onCheckedChange={toggleSelectAll}
                  />
                  <span className="font-medium text-muted-foreground">전체 선택 ({filteredReporters.length})</span>
                </div>
                <span className="text-blue-600 font-bold">{selectedIds.size}명 선택됨</span>
              </div>

              <ScrollArea className="flex-1 bg-slate-50">
                <div className="divide-y divide-border">
                  {filteredReporters.length === 0 ? (
                    <div className="p-8 text-center text-muted-foreground text-sm">검색 결과가 없습니다.</div>
                  ) : (
                    filteredReporters.map((reporter) => (
                      <div 
                        key={reporter.id} 
                        className={`p-3 flex items-start gap-3 transition-colors hover:bg-white ${selectedIds.has(reporter.id) ? 'bg-blue-50/60' : ''}`}
                        onClick={() => toggleSelection(reporter.id)}
                      >
                        <Checkbox 
                          checked={selectedIds.has(reporter.id)}
                          className="mt-1"
                        />
                        <div className="flex-1 min-w-0 cursor-pointer">
                          <div className="flex items-center justify-between mb-0.5">
                            <span className="font-semibold text-sm truncate">{reporter.media_company}</span>
                            {reporter.purpose && <Badge variant="secondary" className="text-[10px] h-5">{reporter.purpose}</Badge>}
                          </div>
                          <div className="text-sm font-medium">{reporter.reporter_name} 기자</div>
                          <div className="text-xs text-muted-foreground truncate">{reporter.contact_email}</div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </ScrollArea>
            </Card>

            {/* Panel 3: 결과 (Result) - 4/12 */}
            <Card className="lg:col-span-4 flex flex-col overflow-hidden border-t-4 border-t-green-500 shadow-sm h-full">
              <div className="p-4 border-b bg-secondary/20 shrink-0">
                <h3 className="font-bold flex items-center gap-2">
                  {showResults ? (
                     <><Send className="w-4 h-4 text-green-600 animate-pulse" /> 3. 발송 현황</>
                  ) : (
                     <><CheckCircle2 className="w-4 h-4 text-green-600" /> 3. 발송 및 결과</>
                  )}
                </h3>
              </div>

              {/* A. 발송 전 미리보기 상태 */}
              {!showResults ? (
                <div className="flex-1 p-6 flex flex-col items-center justify-center text-center space-y-4 bg-slate-50/50">
                  <div className="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-2">
                    <Send className="w-8 h-8 text-green-600 ml-1" />
                  </div>
                  <div>
                    <h4 className="text-lg font-bold">발송 준비 완료</h4>
                    <p className="text-sm text-muted-foreground mt-1">
                      총 <span className="text-foreground font-bold">{selectedIds.size}명</span>의 기자에게 이메일을 발송합니다.<br/>
                      내용을 마지막으로 확인해주세요.
                    </p>
                  </div>
                  
                  <div className="w-full max-w-xs bg-white p-4 rounded-lg border text-left text-xs shadow-sm mt-4">
                    <p className="font-bold mb-1 truncate">받는사람: {Array.from(selectedIds).length}명 (개별 발송)</p>
                    <p className="font-bold mb-2 truncate">제목: {emailSubject || "(제목 없음)"}</p>
                    <div className="text-muted-foreground line-clamp-3">
                      {emailBody.replace("{{기자명}}", "홍길동").replace("{{언론사명}}", "OO일보")}
                    </div>
                  </div>

                  <Button 
                    size="lg" 
                    className="w-full max-w-xs mt-6 bg-green-600 hover:bg-green-700"
                    onClick={handleBulkSend}
                    disabled={selectedIds.size === 0}
                  >
                    일괄 발송 시작
                  </Button>
                </div>
              ) : (
                /* B. 발송 중/완료 로그 상태 */
                <div className="flex-1 flex flex-col h-full">
                  <div className="p-3 bg-slate-100 text-xs font-medium flex justify-between shrink-0">
                    <span>처리 상태: {isSending ? "전송 중..." : "완료"}</span>
                    <span>
                      성공 <span className="text-green-600">{sendingLogs.filter(l => l.status === 'success').length}</span> / 
                      실패 <span className="text-red-600">{sendingLogs.filter(l => l.status === 'failed').length}</span>
                    </span>
                  </div>
                  <ScrollArea className="flex-1">
                    <div className="divide-y divide-border">
                      {sendingLogs.map((log) => (
                        <div key={log.id} className="p-3 flex items-center justify-between text-sm">
                          <div className="flex items-center gap-3">
                            {log.status === "pending" && <Loader2 className="w-4 h-4 text-muted-foreground animate-spin" />}
                            {log.status === "success" && <CheckCircle2 className="w-4 h-4 text-green-500" />}
                            {log.status === "failed" && <XCircle className="w-4 h-4 text-red-500" />}
                            <div>
                              <div className="font-medium">{log.reporter_name}</div>
                              <div className="text-xs text-muted-foreground">{log.email}</div>
                            </div>
                          </div>
                          <div className="text-xs text-right">
                             <span className={`
                                px-2 py-0.5 rounded-full text-[10px] font-bold
                                ${log.status === 'success' ? 'bg-green-100 text-green-700' : 
                                  log.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-500'}
                             `}>
                               {log.status === 'pending' ? '대기중' : log.status === 'success' ? '발송성공' : '오류'}
                             </span>
                             <div className="text-[10px] text-muted-foreground mt-0.5">{log.timestamp}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </ScrollArea>
                  {!isSending && (
                    <div className="p-4 border-t bg-white shrink-0">
                      <Button className="w-full" variant="outline" onClick={() => setShowResults(false)}>
                        추가 발송하기
                      </Button>
                    </div>
                  )}
                </div>
              )}
            </Card>
          </div>
        </div>
      </main>
    </div>
  );
};

export default MediaPitching;


============================================================
File Path: src/pages/admin/MemberDetail.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import {
  UserCircle,
  ArrowLeft,
  Mail,
  Phone,
  Building,
  Briefcase,
  Calendar,
  History,
  Edit,
  Plus,
  Trash2,
  AlertCircle,
  Loader2,
  UserCog,
  FileText,
  Ban,
  UserCheck,
} from "lucide-react";
import { useNavigate, useParams } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "@/hooks/use-toast";
import { format } from "date-fns";
import { ko } from "date-fns/locale";

interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
  phone: string | null;
}

interface Membership {
  id: string;
  user_id: string;
  tenant_id: string;
  role: "company_admin" | "manager" | "employee";
  department: string | null;
  job_title: string | null;
  created_at: string;
  is_suspended: boolean;
  suspended_at: string | null;
  suspended_by: string | null;
  suspension_reason: string | null;
}

interface HRRecord {
  id: string;
  tenant_id: string;
  user_id: string;
  record_type: string;
  title: string;
  description: string | null;
  effective_date: string;
  old_department: string | null;
  new_department: string | null;
  old_job_title: string | null;
  new_job_title: string | null;
  old_role: string | null;
  new_role: string | null;
  created_at: string;
  created_by: string | null;
}

interface Department {
  id: string;
  name: string;
}

interface JobTitle {
  id: string;
  name: string;
}

const recordTypeLabels: Record<string, { label: string; color: string }> = {
  hire: { label: "입사", color: "bg-emerald-500" },
  promotion: { label: "승진", color: "bg-blue-500" },
  transfer: { label: "부서 이동", color: "bg-violet-500" },
  leave: { label: "휴직", color: "bg-amber-500" },
  return: { label: "복직", color: "bg-teal-500" },
  resignation: { label: "퇴사", color: "bg-red-500" },
  suspension: { label: "정지", color: "bg-red-600" },
  reactivation: { label: "복원", color: "bg-green-500" },
  note: { label: "기타", color: "bg-slate-500" },
};

const roleLabels: Record<string, string> = {
  company_admin: "관리자",
  manager: "매니저",
  employee: "직원",
};

const MemberDetail = () => {
  const navigate = useNavigate();
  const { id: memberId } = useParams<{ id: string }>();
  const { currentTenant, isCompanyAdmin, user } = useAuth();

  const [profile, setProfile] = useState<Profile | null>(null);
  const [membership, setMembership] = useState<Membership | null>(null);
  const [hrRecords, setHRRecords] = useState<HRRecord[]>([]);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [jobTitles, setJobTitles] = useState<JobTitle[]>([]);
  const [loading, setLoading] = useState(true);

  // Edit membership dialog
  const [editMembershipDialog, setEditMembershipDialog] = useState(false);
  const [editForm, setEditForm] = useState({
    department: "",
    job_title: "",
    role: "employee" as "company_admin" | "manager" | "employee",
  });

  // Add HR record dialog
  const [addRecordDialog, setAddRecordDialog] = useState(false);
  const [recordForm, setRecordForm] = useState({
    record_type: "note",
    title: "",
    description: "",
    effective_date: format(new Date(), "yyyy-MM-dd"),
  });

  // Fetch member data
  useEffect(() => {
    const fetchData = async () => {
      if (!currentTenant?.tenant_id || !memberId) return;

      setLoading(true);
      try {
        // Fetch membership
        const { data: membershipData, error: membershipError } = await supabase
          .from("tenant_memberships")
          .select("*")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("user_id", memberId) // <--- "id"를 "user_id"로 변경
          .single();

        if (membershipError) throw membershipError;
        setMembership(membershipData);

        // 2. 프로필 정보 가져오기 (이건 그대로 둠)
        const { data: profileData, error: profileError } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", memberId) // memberId가 user_id이므로 정상 작동함
          .single();

        if (profileError) throw profileError;
        setProfile(profileData);

        // Fetch HR records
        const { data: recordsData } = await supabase
          .from("hr_records")
          .select("*")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("user_id", memberId)
          .order("effective_date", { ascending: false });

        setHRRecords(recordsData || []);

        // Fetch departments
        const { data: deptData } = await supabase
          .from("departments")
          .select("id, name")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("is_active", true)
          .order("name");

        setDepartments(deptData || []);

        // Fetch job titles
        const { data: titleData } = await supabase
          .from("job_titles")
          .select("id, name")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("is_active", true)
          .order("level");

        setJobTitles(titleData || []);
      } catch (error) {
        console.error(error);
        toast({ title: "직원 정보 조회 실패", variant: "destructive" });
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [currentTenant?.tenant_id, memberId]);

  const openEditMembership = () => {
    if (!membership) return;
    setEditForm({
      department: membership.department || "",
      job_title: membership.job_title || "",
      role: membership.role,
    });
    setEditMembershipDialog(true);
  };

  const handleUpdateMembership = async () => {
    if (!membership || !currentTenant?.tenant_id) return;

    const oldDept = membership.department;
    const oldTitle = membership.job_title;
    const oldRole = membership.role;

    try {
      // Update membership
      const { error } = await supabase
        .from("tenant_memberships")
        .update({
          department: editForm.department || null,
          job_title: editForm.job_title || null,
          role: editForm.role,
        })
        .eq("id", membership.id);

      if (error) throw error;

      // Create HR record for the change
      const changes: string[] = [];
      if (oldDept !== editForm.department) {
        changes.push(`부서: ${oldDept || "없음"} → ${editForm.department || "없음"}`);
      }
      if (oldTitle !== editForm.job_title) {
        changes.push(`직급: ${oldTitle || "없음"} → ${editForm.job_title || "없음"}`);
      }
      if (oldRole !== editForm.role) {
        changes.push(`권한: ${roleLabels[oldRole]} → ${roleLabels[editForm.role]}`);
      }

      if (changes.length > 0) {
        await supabase.from("hr_records").insert({
          tenant_id: currentTenant.tenant_id,
          user_id: memberId,
          record_type: oldDept !== editForm.department ? "transfer" : "promotion",
          title: "인사 정보 변경",
          description: changes.join("\n"),
          effective_date: new Date().toISOString().split("T")[0],
          old_department: oldDept,
          new_department: editForm.department || null,
          old_job_title: oldTitle,
          new_job_title: editForm.job_title || null,
          old_role: oldRole,
          new_role: editForm.role,
          created_by: user?.id,
        });
      }

      // Refresh data
      setMembership({
        ...membership,
        department: editForm.department || null,
        job_title: editForm.job_title || null,
        role: editForm.role,
      });

      const { data: refreshedRecords } = await supabase
        .from("hr_records")
        .select("*")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("user_id", memberId)
        .order("effective_date", { ascending: false });

      setHRRecords(refreshedRecords || []);
      setEditMembershipDialog(false);
      toast({ title: "인사 정보가 수정되었습니다" });
    } catch (error) {
      console.error(error);
      toast({ title: "수정 실패", variant: "destructive" });
    }
  };

  const handleAddRecord = async () => {
    if (!currentTenant?.tenant_id || !memberId) return;

    try {
      const { error } = await supabase.from("hr_records").insert({
        tenant_id: currentTenant.tenant_id,
        user_id: memberId,
        record_type: recordForm.record_type,
        title: recordForm.title,
        description: recordForm.description || null,
        effective_date: recordForm.effective_date,
        created_by: user?.id,
      });

      if (error) throw error;

      // Refresh records
      const { data: refreshedRecords } = await supabase
        .from("hr_records")
        .select("*")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("user_id", memberId)
        .order("effective_date", { ascending: false });

      setHRRecords(refreshedRecords || []);
      setAddRecordDialog(false);
      setRecordForm({
        record_type: "note",
        title: "",
        description: "",
        effective_date: format(new Date(), "yyyy-MM-dd"),
      });
      toast({ title: "인사 기록이 추가되었습니다" });
    } catch (error) {
      console.error(error);
      toast({ title: "추가 실패", variant: "destructive" });
    }
  };

  const handleDeleteRecord = async (recordId: string) => {
    if (!confirm("이 인사 기록을 삭제하시겠습니까?")) return;

    try {
      const { error } = await supabase.from("hr_records").delete().eq("id", recordId);
      if (error) throw error;

      setHRRecords(hrRecords.filter((r) => r.id !== recordId));
      toast({ title: "인사 기록이 삭제되었습니다" });
    } catch (error) {
      console.error(error);
      toast({ title: "삭제 실패", variant: "destructive" });
    }
  };

  const handleToggleSuspension = async () => {
    if (!membership || !currentTenant?.tenant_id || !memberId) return;

    const isSuspending = !membership.is_suspended;
    const confirmMsg = isSuspending
      ? "이 직원의 계정을 정지하시겠습니까? 정지된 직원은 시스템에 접근할 수 없습니다."
      : "이 직원의 계정을 재활성화하시겠습니까?";

    if (!confirm(confirmMsg)) return;

    try {
      const { error } = await supabase
        .from("tenant_memberships")
        .update({
          is_suspended: isSuspending,
          suspended_at: isSuspending ? new Date().toISOString() : null,
          suspended_by: isSuspending ? user?.id : null,
          suspension_reason: null,
        })
        .eq("id", membership.id);

      if (error) throw error;

      // HR 기록 남기기
      await supabase.from("hr_records").insert({
        tenant_id: currentTenant.tenant_id,
        user_id: memberId,
        record_type: isSuspending ? "suspension" : "reactivation",
        title: isSuspending ? "계정 정지" : "계정 재활성화",
        description: isSuspending
          ? `관리자에 의해 계정이 정지되었습니다.`
          : `관리자에 의해 계정이 재활성화되었습니다.`,
        effective_date: new Date().toISOString().split("T")[0],
        created_by: user?.id,
      });

      setMembership({
        ...membership,
        is_suspended: isSuspending,
        suspended_at: isSuspending ? new Date().toISOString() : null,
        suspended_by: isSuspending ? user?.id || null : null,
      });

      // Refresh HR records
      const { data: refreshedRecords } = await supabase
        .from("hr_records")
        .select("*")
        .eq("tenant_id", currentTenant.tenant_id)
        .eq("user_id", memberId)
        .order("effective_date", { ascending: false });

      setHRRecords(refreshedRecords || []);
      toast({
        title: isSuspending ? "계정이 정지되었습니다" : "계정이 재활성화되었습니다",
      });
    } catch (error) {
      console.error(error);
      toast({ title: "처리 실패", variant: "destructive" });
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!profile || !membership) {
    return (
      <div className="min-h-screen bg-slate-50">
        <Header />
        <main className="pt-28 pb-16 px-6 max-w-4xl mx-auto text-center">
          <AlertCircle className="w-16 h-16 text-red-400 mx-auto mb-4" />
          <h1 className="text-2xl font-bold text-slate-800">직원을 찾을 수 없습니다</h1>
          <Button className="mt-6" onClick={() => navigate("/admin/hr")}>
            인사 관리로 돌아가기
          </Button>
        </main>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        <div className="flex items-center gap-4 mb-8">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin/hr")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <UserCircle className="w-8 h-8 text-primary" /> 직원 상세 정보
            </h1>
            <p className="text-muted-foreground mt-1">인사 기록 및 부서 배정 관리</p>
          </div>
        </div>

        {/* Profile Header Card */}
        <Card className="border-none shadow-lg mb-6">
          <CardContent className="p-6">
            <div className="flex flex-col md:flex-row items-start gap-6">
              <Avatar className="w-24 h-24">
                <AvatarImage src={profile.avatar_url || undefined} />
                <AvatarFallback className="text-2xl bg-primary/10 text-primary">
                  {profile.full_name?.charAt(0) || profile.email.charAt(0).toUpperCase()}
                </AvatarFallback>
              </Avatar>

              <div className="flex-1">
                <div className="flex items-start justify-between">
                  <div>
                    <h2 className="text-2xl font-bold">{profile.full_name || "이름 없음"}</h2>
                    <div className="flex items-center gap-2 mt-2">
                      <Badge
                        className={`${
                          membership.role === "company_admin"
                            ? "bg-violet-500"
                            : membership.role === "manager"
                              ? "bg-blue-500"
                              : "bg-slate-500"
                        }`}
                      >
                        {roleLabels[membership.role]}
                      </Badge>
                      {membership.is_suspended && (
                        <Badge className="bg-red-600">정지됨</Badge>
                      )}
                      {membership.department && <Badge variant="outline">{membership.department}</Badge>}
                      {membership.job_title && <Badge variant="secondary">{membership.job_title}</Badge>}
                    </div>
                  </div>
                  {isCompanyAdmin && (
                    <div className="flex gap-2">
                      <Button onClick={openEditMembership} size="sm" variant="outline">
                        <Edit className="w-4 h-4 mr-2" /> 수정
                      </Button>
                      <Button
                        onClick={handleToggleSuspension}
                        size="sm"
                        variant={membership.is_suspended ? "default" : "destructive"}
                      >
                        {membership.is_suspended ? (
                          <><UserCheck className="w-4 h-4 mr-2" /> 재활성화</>
                        ) : (
                          <><Ban className="w-4 h-4 mr-2" /> 정지</>
                        )}
                      </Button>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                  <div className="flex items-center gap-2 text-sm">
                    <Mail className="w-4 h-4 text-muted-foreground" />
                    <span>{profile.email}</span>
                  </div>
                  {profile.phone && (
                    <div className="flex items-center gap-2 text-sm">
                      <Phone className="w-4 h-4 text-muted-foreground" />
                      <span>{profile.phone}</span>
                    </div>
                  )}
                  <div className="flex items-center gap-2 text-sm">
                    <Calendar className="w-4 h-4 text-muted-foreground" />
                    <span>입사: {format(new Date(membership.created_at), "yyyy.MM.dd", { locale: ko })}</span>
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Tabs for different sections */}
        <Tabs defaultValue="hr-records" className="space-y-4">
          <TabsList>
            <TabsTrigger value="hr-records">
              <History className="w-4 h-4 mr-2" /> 인사 기록
            </TabsTrigger>
            <TabsTrigger value="info">
              <FileText className="w-4 h-4 mr-2" /> 기본 정보
            </TabsTrigger>
          </TabsList>

          <TabsContent value="hr-records">
            <Card className="border-none shadow-lg">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle className="flex items-center gap-2">
                  <History className="w-5 h-5" /> 인사 이력
                </CardTitle>
                {isCompanyAdmin && (
                  <Button onClick={() => setAddRecordDialog(true)} size="sm">
                    <Plus className="w-4 h-4 mr-2" /> 기록 추가
                  </Button>
                )}
              </CardHeader>
              <CardContent>
                {hrRecords.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">인사 기록이 없습니다</div>
                ) : (
                  <div className="relative">
                    {/* Timeline line */}
                    <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-border" />

                    <div className="space-y-6">
                      {hrRecords.map((record) => {
                        const typeInfo = recordTypeLabels[record.record_type] || recordTypeLabels.note;
                        return (
                          <div key={record.id} className="relative pl-10">
                            {/* Timeline dot */}
                            <div
                              className={`absolute left-2 w-5 h-5 rounded-full ${typeInfo.color} flex items-center justify-center`}
                            >
                              <div className="w-2 h-2 bg-white rounded-full" />
                            </div>

                            <Card className="bg-muted/30">
                              <CardContent className="p-4">
                                <div className="flex items-start justify-between">
                                  <div>
                                    <div className="flex items-center gap-2 mb-1">
                                      <Badge className={typeInfo.color}>{typeInfo.label}</Badge>
                                      <span className="text-sm text-muted-foreground">
                                        {format(new Date(record.effective_date), "yyyy.MM.dd", { locale: ko })}
                                      </span>
                                    </div>
                                    <h4 className="font-semibold">{record.title}</h4>
                                    {record.description && (
                                      <p className="text-sm text-muted-foreground mt-1 whitespace-pre-line">
                                        {record.description}
                                      </p>
                                    )}
                                  </div>
                                  {isCompanyAdmin && (
                                    <Button
                                      variant="ghost"
                                      size="icon"
                                      className="text-destructive hover:text-destructive"
                                      onClick={() => handleDeleteRecord(record.id)}
                                    >
                                      <Trash2 className="w-4 h-4" />
                                    </Button>
                                  )}
                                </div>
                              </CardContent>
                            </Card>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="info">
            <Card className="border-none shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <UserCog className="w-5 h-5" /> 기본 정보
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div>
                      <Label className="text-muted-foreground">이름</Label>
                      <p className="font-medium">{profile.full_name || "-"}</p>
                    </div>
                    <div>
                      <Label className="text-muted-foreground">이메일</Label>
                      <p className="font-medium">{profile.email}</p>
                    </div>
                    <div>
                      <Label className="text-muted-foreground">연락처</Label>
                      <p className="font-medium">{profile.phone || "-"}</p>
                    </div>
                  </div>
                  <div className="space-y-4">
                    <div>
                      <Label className="text-muted-foreground">부서</Label>
                      <p className="font-medium">{membership.department || "-"}</p>
                    </div>
                    <div>
                      <Label className="text-muted-foreground">직급</Label>
                      <p className="font-medium">{membership.job_title || "-"}</p>
                    </div>
                    <div>
                      <Label className="text-muted-foreground">권한</Label>
                      <p className="font-medium">{roleLabels[membership.role]}</p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Edit Membership Dialog */}
        <Dialog open={editMembershipDialog} onOpenChange={setEditMembershipDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>인사 정보 수정</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>부서</Label>
                <Select value={editForm.department} onValueChange={(v) => setEditForm({ ...editForm, department: v })}>
                  <SelectTrigger>
                    <SelectValue placeholder="부서 선택" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">없음</SelectItem>
                    {departments.map((d) => (
                      <SelectItem key={d.id} value={d.name}>
                        {d.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>직급</Label>
                <Select value={editForm.job_title} onValueChange={(v) => setEditForm({ ...editForm, job_title: v })}>
                  <SelectTrigger>
                    <SelectValue placeholder="직급 선택" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">없음</SelectItem>
                    {jobTitles.map((j) => (
                      <SelectItem key={j.id} value={j.name}>
                        {j.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>권한</Label>
                <Select
                  value={editForm.role}
                  onValueChange={(v) =>
                    setEditForm({ ...editForm, role: v as "company_admin" | "manager" | "employee" })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="employee">직원</SelectItem>
                    <SelectItem value="manager">매니저</SelectItem>
                    <SelectItem value="company_admin">관리자</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setEditMembershipDialog(false)}>
                취소
              </Button>
              <Button onClick={handleUpdateMembership}>저장</Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Add HR Record Dialog */}
        <Dialog open={addRecordDialog} onOpenChange={setAddRecordDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>인사 기록 추가</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>유형</Label>
                <Select
                  value={recordForm.record_type}
                  onValueChange={(v) => setRecordForm({ ...recordForm, record_type: v })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.entries(recordTypeLabels).map(([key, val]) => (
                      <SelectItem key={key} value={key}>
                        {val.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>제목</Label>
                <Input
                  value={recordForm.title}
                  onChange={(e) => setRecordForm({ ...recordForm, title: e.target.value })}
                  placeholder="예: 마케팅팀 이동"
                />
              </div>
              <div>
                <Label>발효일</Label>
                <Input
                  type="date"
                  value={recordForm.effective_date}
                  onChange={(e) => setRecordForm({ ...recordForm, effective_date: e.target.value })}
                />
              </div>
              <div>
                <Label>상세 내용 (선택)</Label>
                <Textarea
                  value={recordForm.description}
                  onChange={(e) => setRecordForm({ ...recordForm, description: e.target.value })}
                  placeholder="추가 설명을 입력하세요"
                  rows={3}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setAddRecordDialog(false)}>
                취소
              </Button>
              <Button onClick={handleAddRecord} disabled={!recordForm.title}>
                추가
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </main>
    </div>
  );
};

export default MemberDetail;



============================================================
File Path: src/pages/admin/OrgManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { 
  FolderTree, 
  ArrowLeft, 
  Plus, 
  Pencil, 
  Trash2, 
  Building2,
  Briefcase,
  GripVertical,
  ChevronRight,
  ChevronDown,
  Download
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

interface Department {
  id: string;
  name: string;
  parent_id: string | null;
  description: string | null;
  sort_order: number;
  is_active: boolean;
  children?: Department[];
}

interface JobTitle {
  id: string;
  name: string;
  level: number;
  description: string | null;
  is_active: boolean;
}

const OrgManagement = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  
  const [departments, setDepartments] = useState<Department[]>([]);
  const [jobTitles, setJobTitles] = useState<JobTitle[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Department dialog
  const [deptDialogOpen, setDeptDialogOpen] = useState(false);
  const [editingDept, setEditingDept] = useState<Department | null>(null);
  const [deptForm, setDeptForm] = useState({ name: "", description: "", parent_id: "" });
  
  // JobTitle dialog
  const [jobDialogOpen, setJobDialogOpen] = useState(false);
  const [editingJob, setEditingJob] = useState<JobTitle | null>(null);
  const [jobForm, setJobForm] = useState({ name: "", level: 0, description: "" });
  
  // Delete confirmation
  const [deleteTarget, setDeleteTarget] = useState<{ type: "dept" | "job"; id: string; name: string } | null>(null);
  
  // Expanded departments
  const [expandedDepts, setExpandedDepts] = useState<Set<string>>(new Set());
  const [importingDefaults, setImportingDefaults] = useState(false);

  useEffect(() => {
    if (currentTenant) {
      fetchData();
    }
  }, [currentTenant]);

  const fetchData = async () => {
    if (!currentTenant) return;
    setLoading(true);
    
    const [deptRes, jobRes] = await Promise.all([
      supabase
        .from("departments")
        .select("*")
        .eq("tenant_id", currentTenant.tenant_id)
        .order("sort_order"),
      supabase
        .from("job_titles")
        .select("*")
        .eq("tenant_id", currentTenant.tenant_id)
        .order("level"),
    ]);
    
    if (deptRes.data) setDepartments(deptRes.data);
    if (jobRes.data) setJobTitles(jobRes.data);
    setLoading(false);
  };

  // Build tree structure for departments
  const buildDeptTree = (depts: Department[], parentId: string | null = null): Department[] => {
    return depts
      .filter(d => d.parent_id === parentId)
      .map(d => ({
        ...d,
        children: buildDeptTree(depts, d.id),
      }));
  };

  const deptTree = buildDeptTree(departments);

  const toggleExpand = (id: string) => {
    setExpandedDepts(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  // Department CRUD
  const openDeptDialog = (dept?: Department) => {
    if (dept) {
      setEditingDept(dept);
      setDeptForm({ name: dept.name, description: dept.description || "", parent_id: dept.parent_id || "" });
    } else {
      setEditingDept(null);
      setDeptForm({ name: "", description: "", parent_id: "" });
    }
    setDeptDialogOpen(true);
  };

  const saveDepartment = async () => {
    if (!currentTenant || !deptForm.name.trim()) return;
    
    const payload = {
      tenant_id: currentTenant.tenant_id,
      name: deptForm.name.trim(),
      description: deptForm.description.trim() || null,
      parent_id: deptForm.parent_id || null,
      sort_order: departments.length,
    };
    
    if (editingDept) {
      const { error } = await supabase
        .from("departments")
        .update(payload)
        .eq("id", editingDept.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("부서가 수정되었습니다");
    } else {
      const { error } = await supabase.from("departments").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("부서가 등록되었습니다");
    }
    
    setDeptDialogOpen(false);
    fetchData();
  };

  // JobTitle CRUD
  const openJobDialog = (job?: JobTitle) => {
    if (job) {
      setEditingJob(job);
      setJobForm({ name: job.name, level: job.level, description: job.description || "" });
    } else {
      setEditingJob(null);
      setJobForm({ name: "", level: jobTitles.length, description: "" });
    }
    setJobDialogOpen(true);
  };

  const saveJobTitle = async () => {
    if (!currentTenant || !jobForm.name.trim()) return;
    
    const payload = {
      tenant_id: currentTenant.tenant_id,
      name: jobForm.name.trim(),
      level: jobForm.level,
      description: jobForm.description.trim() || null,
    };
    
    if (editingJob) {
      const { error } = await supabase
        .from("job_titles")
        .update(payload)
        .eq("id", editingJob.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("직급이 수정되었습니다");
    } else {
      const { error } = await supabase.from("job_titles").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("직급이 등록되었습니다");
    }
    
    setJobDialogOpen(false);
    fetchData();
  };

  // Delete
  const handleDelete = async () => {
    if (!deleteTarget) return;
    
    const table = deleteTarget.type === "dept" ? "departments" : "job_titles";
    const { error } = await supabase.from(table).delete().eq("id", deleteTarget.id);
    
    if (error) toast.error("삭제 실패: " + error.message);
    else toast.success(`${deleteTarget.name}이(가) 삭제되었습니다`);
    
    setDeleteTarget(null);
    fetchData();
  };

  // Import system defaults
  const importDefaults = async (type: "dept" | "job") => {
    if (!currentTenant) return;
    setImportingDefaults(true);
    try {
      if (type === "dept") {
        const { data: defaults } = await supabase
          .from("departments")
          .select("name, description, parent_id, sort_order")
          .is("tenant_id", null);
        if (!defaults || defaults.length === 0) {
          toast.info("등록된 기본 부서가 없습니다.");
          return;
        }
        // Insert defaults with current tenant_id, skip duplicates
        const existingNames = new Set(departments.map(d => d.name));
        const newDepts = defaults.filter(d => !existingNames.has(d.name));
        if (newDepts.length === 0) {
          toast.info("이미 모든 기본 부서가 등록되어 있습니다.");
          return;
        }
        const { error } = await supabase.from("departments").insert(
          newDepts.map((d, i) => ({
            tenant_id: currentTenant.tenant_id,
            name: d.name,
            description: d.description,
            parent_id: null,
            sort_order: departments.length + i,
          }))
        );
        if (error) throw error;
        toast.success(`${newDepts.length}개 기본 부서를 불러왔습니다.`);
      } else {
        const { data: defaults } = await supabase
          .from("job_titles")
          .select("name, level, description")
          .is("tenant_id", null);
        if (!defaults || defaults.length === 0) {
          toast.info("등록된 기본 직급이 없습니다.");
          return;
        }
        const existingNames = new Set(jobTitles.map(j => j.name));
        const newJobs = defaults.filter(d => !existingNames.has(d.name));
        if (newJobs.length === 0) {
          toast.info("이미 모든 기본 직급이 등록되어 있습니다.");
          return;
        }
        const { error } = await supabase.from("job_titles").insert(
          newJobs.map(j => ({
            tenant_id: currentTenant.tenant_id,
            name: j.name,
            level: j.level,
            description: j.description,
          }))
        );
        if (error) throw error;
        toast.success(`${newJobs.length}개 기본 직급을 불러왔습니다.`);
      }
      fetchData();
    } catch (error: any) {
      toast.error("불러오기 실패: " + error.message);
    } finally {
      setImportingDefaults(false);
    }
  };

  // Render department tree item
  const renderDeptItem = (dept: Department, level: number = 0) => {
    const hasChildren = dept.children && dept.children.length > 0;
    const isExpanded = expandedDepts.has(dept.id);
    
    return (
      <div key={dept.id}>
        <div 
          className="flex items-center gap-2 p-3 rounded-lg hover:bg-slate-50 group"
          style={{ paddingLeft: `${level * 24 + 12}px` }}
        >
          <GripVertical className="w-4 h-4 text-slate-300 cursor-grab" />
          {hasChildren ? (
            <button onClick={() => toggleExpand(dept.id)} className="p-0.5">
              {isExpanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
            </button>
          ) : (
            <div className="w-5" />
          )}
          <Building2 className="w-4 h-4 text-emerald-500" />
          <span className="flex-1 font-medium">{dept.name}</span>
          {dept.description && (
            <span className="text-sm text-slate-400 hidden md:block">{dept.description}</span>
          )}
          <div className="opacity-0 group-hover:opacity-100 flex gap-1">
            <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openDeptDialog(dept)}>
              <Pencil className="w-4 h-4" />
            </Button>
            <Button 
              variant="ghost" 
              size="icon" 
              className="h-8 w-8 text-red-500 hover:text-red-600"
              onClick={() => setDeleteTarget({ type: "dept", id: dept.id, name: dept.name })}
            >
              <Trash2 className="w-4 h-4" />
            </Button>
          </div>
        </div>
        {hasChildren && isExpanded && dept.children?.map(child => renderDeptItem(child, level + 1))}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-5xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <FolderTree className="w-8 h-8 text-emerald-600" /> 부서 및 직급 관리
            </h1>
            <p className="text-slate-500 mt-1">
              {currentTenant?.tenant.name || "회사"} 조직도 및 직급 체계 설정
            </p>
          </div>
        </div>

        <Tabs defaultValue="departments" className="space-y-6">
          <TabsList className="grid w-full max-w-md grid-cols-2">
            <TabsTrigger value="departments" className="gap-2">
              <Building2 className="w-4 h-4" /> 부서 관리
            </TabsTrigger>
            <TabsTrigger value="jobtitles" className="gap-2">
              <Briefcase className="w-4 h-4" /> 직급 관리
            </TabsTrigger>
          </TabsList>

          {/* 부서 탭 */}
          <TabsContent value="departments">
            <Card className="border-none shadow-xl bg-white rounded-3xl">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>부서 목록</CardTitle>
                <div className="flex gap-2">
                  <Button variant="outline" onClick={() => importDefaults("dept")} disabled={importingDefaults} className="gap-2">
                    <Download className="w-4 h-4" /> 기본값 불러오기
                  </Button>
                  <Button onClick={() => openDeptDialog()} className="gap-2">
                    <Plus className="w-4 h-4" /> 부서 추가
                  </Button>
                </div>
              </CardHeader>
              <CardContent>
                {loading ? (
                  <div className="text-center py-12 text-slate-400">로딩 중...</div>
                ) : deptTree.length === 0 ? (
                  <div className="text-center py-12 text-slate-400">
                    등록된 부서가 없습니다. 첫 부서를 추가해보세요.
                  </div>
                ) : (
                  <div className="divide-y">
                    {deptTree.map(dept => renderDeptItem(dept))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* 직급 탭 */}
          <TabsContent value="jobtitles">
            <Card className="border-none shadow-xl bg-white rounded-3xl">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>직급 목록</CardTitle>
                <div className="flex gap-2">
                  <Button variant="outline" onClick={() => importDefaults("job")} disabled={importingDefaults} className="gap-2">
                    <Download className="w-4 h-4" /> 기본값 불러오기
                  </Button>
                  <Button onClick={() => openJobDialog()} className="gap-2">
                    <Plus className="w-4 h-4" /> 직급 추가
                  </Button>
                </div>
              </CardHeader>
              <CardContent>
                {loading ? (
                  <div className="text-center py-12 text-slate-400">로딩 중...</div>
                ) : jobTitles.length === 0 ? (
                  <div className="text-center py-12 text-slate-400">
                    등록된 직급이 없습니다. 첫 직급을 추가해보세요.
                  </div>
                ) : (
                  <div className="space-y-2">
                    {jobTitles.map((job, idx) => (
                      <div 
                        key={job.id}
                        className="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 group"
                      >
                        <GripVertical className="w-4 h-4 text-slate-300 cursor-grab" />
                        <div className="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-600 font-bold text-sm">
                          {idx + 1}
                        </div>
                        <Briefcase className="w-4 h-4 text-violet-500" />
                        <span className="flex-1 font-medium">{job.name}</span>
                        {job.description && (
                          <span className="text-sm text-slate-400 hidden md:block">{job.description}</span>
                        )}
                        <div className="opacity-0 group-hover:opacity-100 flex gap-1">
                          <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openJobDialog(job)}>
                            <Pencil className="w-4 h-4" />
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-8 w-8 text-red-500 hover:text-red-600"
                            onClick={() => setDeleteTarget({ type: "job", id: job.id, name: job.name })}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </main>

      {/* Department Dialog */}
      <Dialog open={deptDialogOpen} onOpenChange={setDeptDialogOpen}>
        <DialogContent aria-describedby="dept-dialog-description">
          <DialogHeader>
            <DialogTitle>{editingDept ? "부서 수정" : "부서 추가"}</DialogTitle>
          </DialogHeader>
          <p id="dept-dialog-description" className="sr-only">
            부서 정보를 입력하세요
          </p>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="dept-name">부서명 *</Label>
              <Input 
                id="dept-name"
                value={deptForm.name}
                onChange={(e) => setDeptForm(prev => ({ ...prev, name: e.target.value }))}
                placeholder="예: 경영지원팀"
                autoComplete="off"
              />
            </div>
            <div className="space-y-2">
              <Label>상위 부서</Label>
              <Select 
                value={deptForm.parent_id} 
                onValueChange={v => setDeptForm(f => ({ ...f, parent_id: v === "none" ? "" : v }))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="상위 부서 선택 (선택사항)" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">없음 (최상위)</SelectItem>
                  {departments
                    .filter(d => d.id !== editingDept?.id)
                    .map(d => (
                      <SelectItem key={d.id} value={d.id}>{d.name}</SelectItem>
                    ))}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label>설명</Label>
              <Textarea 
                value={deptForm.description}
                onChange={e => setDeptForm(f => ({ ...f, description: e.target.value }))}
                placeholder="부서에 대한 간단한 설명"
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDeptDialogOpen(false)}>취소</Button>
            <Button 
              onClick={saveDepartment} 
              disabled={!deptForm.name.trim() || !currentTenant}
            >
              저장
            </Button>
          </DialogFooter>
          {!currentTenant && (
            <p className="text-sm text-red-500 mt-2">회사가 선택되지 않았습니다. 다시 로그인해주세요.</p>
          )}
        </DialogContent>
      </Dialog>

      {/* JobTitle Dialog */}
      <Dialog open={jobDialogOpen} onOpenChange={setJobDialogOpen}>
        <DialogContent aria-describedby="job-dialog-description">
          <DialogHeader>
            <DialogTitle>{editingJob ? "직급 수정" : "직급 추가"}</DialogTitle>
          </DialogHeader>
          <p id="job-dialog-description" className="sr-only">
            직급 정보를 입력하세요
          </p>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="job-name">직급명 *</Label>
              <Input 
                id="job-name"
                value={jobForm.name}
                onChange={(e) => setJobForm(prev => ({ ...prev, name: e.target.value }))}
                placeholder="예: 대리"
                autoComplete="off"
              />
            </div>
            <div className="space-y-2">
              <Label>레벨 (순서)</Label>
              <Input 
                type="number"
                value={jobForm.level}
                onChange={e => setJobForm(f => ({ ...f, level: parseInt(e.target.value) || 0 }))}
                placeholder="숫자가 낮을수록 높은 직급"
              />
            </div>
            <div className="space-y-2">
              <Label>설명</Label>
              <Textarea 
                value={jobForm.description}
                onChange={e => setJobForm(f => ({ ...f, description: e.target.value }))}
                placeholder="직급에 대한 간단한 설명"
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setJobDialogOpen(false)}>취소</Button>
            <Button 
              onClick={saveJobTitle} 
              disabled={!jobForm.name.trim() || !currentTenant}
            >
              저장
            </Button>
          </DialogFooter>
          {!currentTenant && (
            <p className="text-sm text-red-500 mt-2">회사가 선택되지 않았습니다. 다시 로그인해주세요.</p>
          )}
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteTarget} onOpenChange={() => setDeleteTarget(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>정말 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription>
              "{deleteTarget?.name}"을(를) 삭제합니다. 이 작업은 되돌릴 수 없습니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-red-500 hover:bg-red-600">
              삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default OrgManagement;



============================================================
File Path: src/pages/admin/PartnerDataView.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import {
  ArrowLeft, Building2, Users, UserCog, Target, Key, CreditCard, Loader2, Eye, Lock, Film, CalendarDays, Clock,
} from "lucide-react";
import { format } from "date-fns";
import { ko } from "date-fns/locale";
import { useNavigate } from "react-router-dom";
import { getCompanyTypeBadge } from "@/lib/companyTypes";

interface PartnerTenant {
  id: string;
  name: string;
  company_type: string | null;
  scopes: string[];
}

const SCOPE_META: Record<string, { label: string; icon: any; key: string }> = {
  artists: { label: "배우/아티스트", icon: UserCog, key: "artists" },
  schedules: { label: "스케줄", icon: CalendarDays, key: "schedules" },
  projects: { label: "프로젝트", icon: Target, key: "projects" },
  production: { label: "제작", icon: Film, key: "production" },
  hr: { label: "인사 정보", icon: Users, key: "hr" },
  finance: { label: "재무 정보", icon: CreditCard, key: "finance" },
  keywords: { label: "키워드/미디어", icon: Key, key: "keywords" },
};

const PartnerDataView = () => {
  const { currentTenant } = useAuth();
  const navigate = useNavigate();
  const [partners, setPartners] = useState<PartnerTenant[]>([]);
  const [selectedPartner, setSelectedPartner] = useState<string>("");
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState("artists");

  // Data states
  const [artists, setArtists] = useState<any[]>([]);
  const [schedules, setSchedules] = useState<any[]>([]);
  const [projects, setProjects] = useState<any[]>([]);
  const [members, setMembers] = useState<any[]>([]);
  const [keywords, setKeywords] = useState<any[]>([]);
  const [dataLoading, setDataLoading] = useState(false);

  const myTenantId = currentTenant?.tenant_id;

  useEffect(() => {
    if (!myTenantId) return;
    fetchPartners();
  }, [myTenantId]);

  const fetchPartners = async () => {
    if (!myTenantId) return;
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from("tenant_partnerships")
        .select(`
          *,
          requester_tenant:requester_tenant_id ( id, name, company_type ),
          target_tenant:target_tenant_id ( id, name, company_type )
        ` as any)
        .eq("status", "active")
        .or(`requester_tenant_id.eq.${myTenantId},target_tenant_id.eq.${myTenantId}`);

      if (error) throw error;

      const partnerList: PartnerTenant[] = ((data || []) as any[]).map((p: any) => {
        const isRequester = p.requester_tenant_id === myTenantId;
        const other = isRequester ? p.target_tenant : p.requester_tenant;
        return {
          id: other?.id,
          name: other?.name || "알 수 없음",
          company_type: other?.company_type,
          scopes: p.data_scopes || [],
        };
      });

      setPartners(partnerList);
      if (partnerList.length > 0) {
        setSelectedPartner(partnerList[0].id);
      }
    } catch (error) {
      console.error("Partner fetch error:", error);
    } finally {
      setLoading(false);
    }
  };

  const currentPartner = partners.find(p => p.id === selectedPartner);
  const allowedScopes = currentPartner?.scopes || [];

  useEffect(() => {
    if (!selectedPartner || !currentPartner) return;
    // Set active tab to first allowed scope
    if (allowedScopes.length > 0 && !allowedScopes.includes(activeTab)) {
      setActiveTab(allowedScopes[0]);
    }
    fetchPartnerData();
  }, [selectedPartner]);

  const fetchPartnerData = async () => {
    if (!selectedPartner) return;
    setDataLoading(true);
    try {
      const partner = partners.find(p => p.id === selectedPartner);
      if (!partner) return;
      const scopes = partner.scopes;

      const promises: Promise<void>[] = [];

      if (scopes.includes("artists")) {
        promises.push(
          supabase.from("artists").select("*").eq("tenant_id", selectedPartner).eq("is_active", true)
            .then(({ data }) => { setArtists(data || []); }) as any
        );
        // Also fetch schedule availability for artists scope
        promises.push(
          supabase.from("artist_schedule_availability" as any).select("*").eq("tenant_id", selectedPartner)
            .gte("end_time", new Date().toISOString())
            .order("start_time", { ascending: true })
            .then(({ data }) => { setSchedules((data || []) as any[]); }) as any
        );
      } else { setArtists([]); setSchedules([]); }

      if (scopes.includes("projects")) {
        promises.push(
          supabase.from("projects").select("*").eq("tenant_id", selectedPartner).eq("is_active", true)
            .then(({ data }) => { setProjects(data || []); }) as any
        );
      } else { setProjects([]); }

      if (scopes.includes("hr")) {
        promises.push(
          supabase.from("tenant_memberships").select(`
            id, role, department, job_title,
            profile:user_id ( id, full_name, email )
          ` as any).eq("tenant_id", selectedPartner)
            .then(({ data }) => { setMembers((data || []) as any[]); }) as any
        );
      } else { setMembers([]); }

      if (scopes.includes("keywords")) {
        promises.push(
          supabase.from("keywords").select("*").eq("tenant_id", selectedPartner).eq("is_active", true)
            .then(({ data }) => { setKeywords(data || []); }) as any
        );
      } else { setKeywords([]); }

      await Promise.all(promises);
    } catch (error) {
      console.error("Data fetch error:", error);
    } finally {
      setDataLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50">
        <Header />
        <div className="pt-28 flex justify-center"><Loader2 className="w-8 h-8 animate-spin text-primary" /></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <div className="flex items-center gap-2 text-primary font-bold text-sm mb-1">
              <Eye className="w-5 h-5" /> Partner Data Hub
            </div>
            <h1 className="text-3xl font-extrabold tracking-tight text-slate-900">파트너사 데이터 열람</h1>
            <p className="text-slate-500 mt-1">연결된 파트너 회사의 공유 데이터를 열람합니다.</p>
          </div>
          <Button variant="ghost" onClick={() => navigate("/admin")} className="gap-2">
            <ArrowLeft className="w-4 h-4" /> 관리 시스템
          </Button>
        </div>

        {partners.length === 0 ? (
          <Card>
            <CardContent className="py-16 text-center text-slate-400">
              <Building2 className="w-12 h-12 mx-auto mb-3 opacity-30" />
              <p className="font-medium text-lg">연결된 파트너사가 없습니다.</p>
              <p className="text-sm mt-1">파트너사 관리에서 파트너를 초대하고 연결하세요.</p>
              <Button className="mt-4" onClick={() => navigate("/admin/partnerships")}>파트너사 관리로 이동</Button>
            </CardContent>
          </Card>
        ) : (
          <>
            {/* Partner selector */}
            <div className="mb-6">
              <Select value={selectedPartner} onValueChange={setSelectedPartner}>
                <SelectTrigger className="w-full max-w-md bg-white">
                  <SelectValue placeholder="파트너사를 선택하세요" />
                </SelectTrigger>
                <SelectContent>
                  {partners.map(p => (
                    <SelectItem key={p.id} value={p.id}>
                      <span className="flex items-center gap-2">
                        <Building2 className="w-4 h-4 text-slate-400" />
                        {p.name}
                        <Badge variant="outline" className="text-xs ml-1">{getCompanyTypeBadge(p.company_type || "talent_agency")}</Badge>
                      </span>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Scope tabs */}
            {currentPartner && (
              <Tabs value={activeTab} onValueChange={setActiveTab}>
                <TabsList className="mb-6">
                  {Object.entries(SCOPE_META).map(([key, meta]) => {
                    const allowed = allowedScopes.includes(key);
                    const Icon = meta.icon;
                    return (
                      <TabsTrigger key={key} value={key} disabled={!allowed} className="gap-2">
                        {allowed ? <Icon className="w-4 h-4" /> : <Lock className="w-4 h-4 opacity-40" />}
                        {meta.label}
                      </TabsTrigger>
                    );
                  })}
                </TabsList>

                {dataLoading ? (
                  <div className="flex justify-center py-12"><Loader2 className="w-6 h-6 animate-spin text-primary" /></div>
                ) : (
                  <>
                    <TabsContent value="artists">
                      <ArtistList data={artists} />
                    </TabsContent>
                    <TabsContent value="schedules">
                      <ScheduleAvailability data={schedules} artists={artists} />
                    </TabsContent>
                    <TabsContent value="projects">
                      <ProjectList data={projects} />
                    </TabsContent>
                    <TabsContent value="production">
                      <Card><CardContent className="py-12 text-center text-slate-400">
                        <Film className="w-10 h-10 mx-auto mb-2 opacity-30" />
                        <p>제작 데이터 열람은 추후 지원 예정입니다.</p>
                      </CardContent></Card>
                    </TabsContent>
                    <TabsContent value="hr">
                      <MemberList data={members} />
                    </TabsContent>
                    <TabsContent value="finance">
                      <Card><CardContent className="py-12 text-center text-slate-400">
                        <CreditCard className="w-10 h-10 mx-auto mb-2 opacity-30" />
                        <p>재무 데이터 열람은 추후 지원 예정입니다.</p>
                      </CardContent></Card>
                    </TabsContent>
                    <TabsContent value="keywords">
                      <KeywordList data={keywords} />
                    </TabsContent>
                  </>
                )}
              </Tabs>
            )}
          </>
        )}
      </main>
    </div>
  );
};

// Schedule Availability (partner view - no content details)
const ScheduleAvailability = ({ data, artists }: { data: any[]; artists: any[] }) => {
  const artistMap = Object.fromEntries(artists.map(a => [a.id, a]));
  const typeLabels: Record<string, string> = {
    schedule: "일정",
    shooting: "촬영",
    meeting: "미팅",
    event: "행사",
    rehearsal: "리허설",
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg flex items-center gap-2">
          <CalendarDays className="w-5 h-5" />
          스케줄 현황 ({data.length})
        </CardTitle>
        <CardDescription>파트너사 배우들의 일정 유무를 확인할 수 있습니다. 상세 내용은 비공개입니다.</CardDescription>
      </CardHeader>
      <CardContent>
        {data.length === 0 ? (
          <p className="text-slate-400 text-center py-8">등록된 스케줄이 없습니다.</p>
        ) : (
          <div className="space-y-2">
            {data.map(s => {
              const artist = artistMap[s.artist_id];
              const startDate = new Date(s.start_time);
              const endDate = new Date(s.end_time);
              return (
                <div key={s.id} className="flex items-center gap-3 p-3 rounded-xl border bg-white hover:shadow-sm transition-shadow">
                  <div className="w-10 h-10 rounded-full bg-violet-100 flex items-center justify-center text-violet-600 font-bold text-sm">
                    {artist?.name?.charAt(0) || "?"}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-sm">{artist?.name || "배우"}</p>
                    <div className="flex items-center gap-1 text-xs text-slate-500 mt-0.5">
                      <Clock className="w-3 h-3" />
                      {s.is_all_day
                        ? format(startDate, "yyyy.MM.dd (eee)", { locale: ko }) + " 종일"
                        : `${format(startDate, "yyyy.MM.dd (eee) HH:mm", { locale: ko })} ~ ${format(endDate, "HH:mm")}`
                      }
                    </div>
                  </div>
                  <Badge variant="secondary" className="text-xs shrink-0">
                    {typeLabels[s.schedule_type] || "일정"}
                  </Badge>
                </div>
              );
            })}
          </div>
        )}
      </CardContent>
    </Card>
  );
};

// Sub-components
const ArtistList = ({ data }: { data: any[] }) => (
  <Card>
    <CardHeader>
      <CardTitle className="text-lg">배우/아티스트 ({data.length})</CardTitle>
      <CardDescription>파트너사에 등록된 활성 아티스트 목록입니다.</CardDescription>
    </CardHeader>
    <CardContent>
      {data.length === 0 ? (
        <p className="text-slate-400 text-center py-8">등록된 아티스트가 없습니다.</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {data.map(a => (
            <div key={a.id} className="p-4 rounded-xl border bg-white hover:shadow-md transition-shadow">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
                  {a.name?.charAt(0)}
                </div>
                <div>
                  <p className="font-bold">{a.name}</p>
                  {a.stage_name && <p className="text-xs text-slate-500">{a.stage_name}</p>}
                </div>
              </div>
              {a.agency && <Badge variant="secondary" className="text-xs">{a.agency}</Badge>}
              {a.bio && <p className="text-xs text-slate-500 mt-2 line-clamp-2">{a.bio}</p>}
            </div>
          ))}
        </div>
      )}
    </CardContent>
  </Card>
);

const ProjectList = ({ data }: { data: any[] }) => (
  <Card>
    <CardHeader>
      <CardTitle className="text-lg">프로젝트 ({data.length})</CardTitle>
      <CardDescription>파트너사의 진행 중인 프로젝트 목록입니다.</CardDescription>
    </CardHeader>
    <CardContent>
      {data.length === 0 ? (
        <p className="text-slate-400 text-center py-8">등록된 프로젝트가 없습니다.</p>
      ) : (
        <div className="space-y-3">
          {data.map(p => (
            <div key={p.id} className="flex items-center justify-between p-4 rounded-xl border bg-white hover:shadow-sm transition-shadow">
              <div>
                <p className="font-bold">{p.name}</p>
                {p.code && <p className="text-xs text-slate-500">코드: {p.code}</p>}
                {p.description && <p className="text-sm text-slate-600 mt-1 line-clamp-1">{p.description}</p>}
              </div>
              <div className="flex items-center gap-2">
                <Badge variant={p.status === "active" ? "default" : "secondary"} className="text-xs">
                  {p.status === "active" ? "진행중" : p.status}
                </Badge>
                {p.start_date && <span className="text-xs text-slate-400">{p.start_date}</span>}
              </div>
            </div>
          ))}
        </div>
      )}
    </CardContent>
  </Card>
);

const MemberList = ({ data }: { data: any[] }) => (
  <Card>
    <CardHeader>
      <CardTitle className="text-lg">직원 정보 ({data.length})</CardTitle>
      <CardDescription>파트너사의 조직 구성원 목록입니다.</CardDescription>
    </CardHeader>
    <CardContent>
      {data.length === 0 ? (
        <p className="text-slate-400 text-center py-8">열람 가능한 직원 정보가 없습니다.</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {data.map((m: any) => (
            <div key={m.id} className="flex items-center gap-3 p-4 rounded-xl border bg-white">
              <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">
                {(m.profile?.full_name || "?").charAt(0)}
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-semibold text-sm">{m.profile?.full_name || "이름 없음"}</p>
                <p className="text-xs text-slate-500">{m.department || "부서 미지정"} · {m.job_title || "직급 미지정"}</p>
              </div>
              <Badge variant="outline" className="text-xs shrink-0">
                {m.role === "company_admin" ? "관리자" : m.role === "manager" ? "매니저" : "직원"}
              </Badge>
            </div>
          ))}
        </div>
      )}
    </CardContent>
  </Card>
);

const KeywordList = ({ data }: { data: any[] }) => (
  <Card>
    <CardHeader>
      <CardTitle className="text-lg">키워드 ({data.length})</CardTitle>
      <CardDescription>파트너사의 모니터링 키워드 목록입니다.</CardDescription>
    </CardHeader>
    <CardContent>
      {data.length === 0 ? (
        <p className="text-slate-400 text-center py-8">등록된 키워드가 없습니다.</p>
      ) : (
        <div className="flex flex-wrap gap-2">
          {data.map(k => (
            <Badge key={k.id} className="px-3 py-1.5 text-sm bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200">
              {k.keyword}
              {k.category && <span className="ml-1 text-xs opacity-60">({k.category})</span>}
            </Badge>
          ))}
        </div>
      )}
    </CardContent>
  </Card>
);

export default PartnerDataView;



============================================================
File Path: src/pages/admin/PartnershipManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter,
} from "@/components/ui/dialog";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import {
  ArrowLeft, Handshake, Plus, Check, X, Loader2, Send, Building2, Eye, Trash2,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { toast } from "sonner";
import { getCompanyTypeBadge } from "@/lib/companyTypes";

interface Partnership {
  id: string;
  requester_tenant_id: string;
  target_tenant_id: string;
  status: string;
  data_scopes: string[];
  message: string | null;
  invited_by: string | null;
  accepted_by: string | null;
  accepted_at: string | null;
  created_at: string;
  requester_tenant?: { id: string; name: string; company_type: string | null };
  target_tenant?: { id: string; name: string; company_type: string | null };
}

const DATA_SCOPE_OPTIONS = [
  { value: "artists", label: "배우/아티스트 정보", desc: "프로필, 포트폴리오" },
  { value: "schedules", label: "배우 스케줄", desc: "일정 가용성 공유 (상세 내용 비공개)" },
  { value: "projects", label: "프로젝트 정보", desc: "진행 사업 및 일정" },
  { value: "production", label: "제작 정보", desc: "제작 관련 데이터 공유" },
  { value: "hr", label: "인사 정보", desc: "직원 명부 및 조직도" },
  { value: "finance", label: "재무 정보", desc: "카드 내역, 청구서, 정산" },
  { value: "keywords", label: "키워드/미디어", desc: "모니터링 키워드 및 언론 데이터" },
];

const PartnershipManagement = () => {
  const { currentTenant, profile } = useAuth();
  const navigate = useNavigate();
  const [partnerships, setPartnerships] = useState<Partnership[]>([]);
  const [allTenants, setAllTenants] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [processing, setProcessing] = useState(false);

  // 새 파트너십 폼
  const [targetTenantId, setTargetTenantId] = useState("");
  const [selectedScopes, setSelectedScopes] = useState<string[]>([]);
  const [inviteMessage, setInviteMessage] = useState("");

  const myTenantId = currentTenant?.tenant_id;

  const fetchData = async () => {
    if (!myTenantId) return;
    setLoading(true);
    try {
      // 파트너십 목록 (양방향 조회)
      const { data: pData, error: pError } = await supabase
        .from("tenant_partnerships")
        .select(`
          *,
          requester_tenant:requester_tenant_id ( id, name, company_type ),
          target_tenant:target_tenant_id ( id, name, company_type )
        ` as any)
        .or(`requester_tenant_id.eq.${myTenantId},target_tenant_id.eq.${myTenantId}`)
        .order("created_at", { ascending: false });

      if (pError) throw pError;
      setPartnerships((pData || []) as unknown as Partnership[]);

      // 전체 테넌트 목록 (초대 대상 선택용)
      const { data: tData } = await supabase
        .from("tenants")
        .select("id, name, company_type")
        .neq("id", myTenantId)
        .order("name");
      setAllTenants(tData || []);
    } catch (error) {
      console.error("Fetch error:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [myTenantId]);

  const handleInvite = async () => {
    if (!targetTenantId || selectedScopes.length === 0) {
      toast.error("대상 회사와 공유할 데이터를 선택해주세요.");
      return;
    }
    setProcessing(true);
    try {
      const { error } = await supabase.from("tenant_partnerships").insert({
        requester_tenant_id: myTenantId,
        target_tenant_id: targetTenantId,
        data_scopes: selectedScopes,
        message: inviteMessage || null,
        invited_by: profile?.id,
      } as any);

      if (error) {
        if (error.code === "23505") {
          toast.error("이미 해당 회사와의 파트너십이 존재합니다.");
        } else {
          throw error;
        }
      } else {
        toast.success("파트너십 초대가 전송되었습니다.");
        setIsDialogOpen(false);
        resetForm();
        fetchData();
      }
    } catch (error: any) {
      toast.error("초대 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleAccept = async (partnership: Partnership) => {
    setProcessing(true);
    try {
      const { error } = await supabase
        .from("tenant_partnerships")
        .update({
          status: "active",
          accepted_by: profile?.id,
          accepted_at: new Date().toISOString(),
        } as any)
        .eq("id", partnership.id);
      if (error) throw error;
      toast.success("파트너십이 수락되었습니다!");
      fetchData();
    } catch (error: any) {
      toast.error("수락 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleReject = async (partnership: Partnership) => {
    setProcessing(true);
    try {
      const { error } = await supabase
        .from("tenant_partnerships")
        .update({ status: "rejected" } as any)
        .eq("id", partnership.id);
      if (error) throw error;
      toast.success("파트너십을 거절했습니다.");
      fetchData();
    } catch (error: any) {
      toast.error("거절 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleRevoke = async (partnership: Partnership) => {
    setProcessing(true);
    try {
      const { error } = await supabase
        .from("tenant_partnerships")
        .update({ status: "revoked" } as any)
        .eq("id", partnership.id);
      if (error) throw error;
      toast.success("파트너십이 해제되었습니다.");
      fetchData();
    } catch (error: any) {
      toast.error("해제 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const resetForm = () => {
    setTargetTenantId("");
    setSelectedScopes([]);
    setInviteMessage("");
  };

  const toggleScope = (scope: string) => {
    setSelectedScopes(prev =>
      prev.includes(scope) ? prev.filter(s => s !== scope) : [...prev, scope]
    );
  };

  // 파트너십 분류
  const pendingReceived = partnerships.filter(p => p.status === "pending" && p.target_tenant_id === myTenantId);
  const pendingSent = partnerships.filter(p => p.status === "pending" && p.requester_tenant_id === myTenantId);
  const activePartners = partnerships.filter(p => p.status === "active");
  const inactivePartners = partnerships.filter(p => ["rejected", "revoked"].includes(p.status));

  const getPartnerName = (p: Partnership) => {
    const other = p.requester_tenant_id === myTenantId ? p.target_tenant : p.requester_tenant;
    return other?.name || "알 수 없음";
  };

  const getPartnerType = (p: Partnership) => {
    const other = p.requester_tenant_id === myTenantId ? p.target_tenant : p.requester_tenant;
    return other?.company_type || "talent_agency";
  };

  const getScopeLabel = (scope: string) => {
    return DATA_SCOPE_OPTIONS.find(o => o.value === scope)?.label || scope;
  };

  // 이미 파트너십이 있는 테넌트 제외
  const existingPartnerIds = new Set(partnerships.filter(p => p.status !== "rejected" && p.status !== "revoked").map(p =>
    p.requester_tenant_id === myTenantId ? p.target_tenant_id : p.requester_tenant_id
  ));
  const availableTenants = allTenants.filter(t => !existingPartnerIds.has(t.id));

  const statusBadge = (status: string) => {
    switch (status) {
      case "active": return <Badge className="bg-green-100 text-green-700 hover:bg-green-100">활성</Badge>;
      case "pending": return <Badge className="bg-amber-100 text-amber-700 hover:bg-amber-100">대기중</Badge>;
      case "rejected": return <Badge variant="destructive">거절됨</Badge>;
      case "revoked": return <Badge variant="secondary">해제됨</Badge>;
      default: return <Badge variant="outline">{status}</Badge>;
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50">
        <Header />
        <div className="pt-28 flex justify-center"><Loader2 className="w-8 h-8 animate-spin text-primary" /></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-7xl mx-auto">
        {/* 헤더 */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <div className="flex items-center gap-2 text-primary font-bold text-sm mb-1">
              <Handshake className="w-5 h-5" /> Partnership Hub
            </div>
            <h1 className="text-3xl font-extrabold tracking-tight text-slate-900">파트너사 관리</h1>
            <p className="text-slate-500 mt-1">외부 파트너 회사와의 데이터 공유 및 협업을 관리합니다.</p>
          </div>
          <div className="flex gap-3">
            <Button variant="ghost" onClick={() => navigate("/admin")} className="gap-2">
              <ArrowLeft className="w-4 h-4" /> 관리 시스템
            </Button>
            <Button onClick={() => { resetForm(); setIsDialogOpen(true); }} className="gap-2">
              <Plus className="w-4 h-4" /> 파트너 초대
            </Button>
          </div>
        </div>

        {/* 수신된 초대 */}
        {pendingReceived.length > 0 && (
          <Card className="mb-6 border-2 border-amber-400 bg-amber-50/50">
            <CardHeader className="pb-3">
              <CardTitle className="text-lg flex items-center gap-2 text-amber-800">
                <Send className="w-5 h-5" /> 받은 파트너십 요청 ({pendingReceived.length})
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {pendingReceived.map((p) => (
                <div key={p.id} className="bg-white rounded-xl p-5 border border-amber-200 flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-bold text-lg">{getPartnerName(p)}</span>
                      <Badge variant="outline" className="text-xs">{getCompanyTypeBadge(getPartnerType(p))}</Badge>
                    </div>
                    {p.message && <p className="text-sm text-slate-600 mb-2">"{p.message}"</p>}
                    <div className="flex flex-wrap gap-1.5">
                      {p.data_scopes.map(s => (
                        <Badge key={s} variant="secondary" className="text-xs">{getScopeLabel(s)}</Badge>
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-2 shrink-0">
                    <Button size="sm" className="gap-1 bg-green-600 hover:bg-green-700" onClick={() => handleAccept(p)} disabled={processing}>
                      <Check className="w-4 h-4" /> 수락
                    </Button>
                    <Button size="sm" variant="ghost" className="gap-1 text-red-500 hover:text-red-700" onClick={() => handleReject(p)} disabled={processing}>
                      <X className="w-4 h-4" /> 거절
                    </Button>
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        {/* 활성 파트너십 */}
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              <Handshake className="w-5 h-5 text-green-600" /> 활성 파트너십 ({activePartners.length})
            </CardTitle>
            <CardDescription>현재 데이터를 공유하고 있는 파트너 회사입니다.</CardDescription>
          </CardHeader>
          <CardContent>
            {activePartners.length === 0 ? (
              <div className="text-center py-12 text-slate-400">
                <Handshake className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p className="font-medium">아직 활성화된 파트너십이 없습니다.</p>
                <p className="text-sm mt-1">파트너 초대 버튼으로 협업할 회사를 연결하세요.</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {activePartners.map(p => (
                  <div key={p.id} className="bg-white rounded-xl p-5 border border-slate-200 hover:shadow-md transition-shadow">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <div className="flex items-center gap-2">
                          <Building2 className="w-5 h-5 text-slate-400" />
                          <span className="font-bold text-lg">{getPartnerName(p)}</span>
                        </div>
                        <Badge variant="outline" className="text-xs mt-1">{getCompanyTypeBadge(getPartnerType(p))}</Badge>
                      </div>
                      {statusBadge(p.status)}
                    </div>
                    <div className="flex flex-wrap gap-1.5 mb-4">
                      {p.data_scopes.map(s => (
                        <Badge key={s} className="bg-blue-50 text-blue-700 hover:bg-blue-50 text-xs">{getScopeLabel(s)}</Badge>
                      ))}
                    </div>
                    <div className="flex items-center justify-between text-xs text-slate-400">
                      <span>연결일: {p.accepted_at ? new Date(p.accepted_at).toLocaleDateString() : "-"}</span>
                      <Button size="sm" variant="ghost" className="text-red-400 hover:text-red-600 h-7 text-xs" onClick={() => handleRevoke(p)}>
                        파트너 해제
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* 보낸 초대 (대기중) */}
        {pendingSent.length > 0 && (
          <Card className="mb-6">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2 text-slate-600">
                <Send className="w-5 h-5" /> 보낸 요청 ({pendingSent.length})
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {pendingSent.map(p => (
                <div key={p.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg border">
                  <div className="flex items-center gap-3">
                    <span className="font-semibold">{getPartnerName(p)}</span>
                    <Badge variant="outline" className="text-xs">{getCompanyTypeBadge(getPartnerType(p))}</Badge>
                    {statusBadge(p.status)}
                  </div>
                  <span className="text-xs text-slate-400">{new Date(p.created_at).toLocaleDateString()}</span>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        {/* 비활성 파트너십 */}
        {inactivePartners.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle className="text-lg text-slate-400">종료된 파트너십 ({inactivePartners.length})</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              {inactivePartners.map(p => (
                <div key={p.id} className="flex items-center justify-between p-3 rounded-lg bg-slate-50/50 opacity-60">
                  <div className="flex items-center gap-3">
                    <span className="font-medium">{getPartnerName(p)}</span>
                    {statusBadge(p.status)}
                  </div>
                  <span className="text-xs text-slate-400">{new Date(p.created_at).toLocaleDateString()}</span>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        {/* 초대 다이얼로그 */}
        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent className="sm:max-w-lg">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Handshake className="w-5 h-5 text-primary" /> 파트너십 초대
              </DialogTitle>
              <DialogDescription>
                협업할 회사를 선택하고, 공유할 데이터 범위를 지정하세요.
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-5 py-4">
              <div className="space-y-2">
                <Label>대상 회사 *</Label>
                <Select value={targetTenantId} onValueChange={setTargetTenantId}>
                  <SelectTrigger>
                    <SelectValue placeholder="파트너 회사를 선택하세요" />
                  </SelectTrigger>
                  <SelectContent>
                    {availableTenants.length === 0 ? (
                      <SelectItem value="__none" disabled>초대 가능한 회사가 없습니다</SelectItem>
                    ) : (
                      availableTenants.map(t => (
                        <SelectItem key={t.id} value={t.id}>
                          {t.name} ({getCompanyTypeBadge(t.company_type || "talent_agency")})
                        </SelectItem>
                      ))
                    )}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-3">
                <Label>공유 데이터 범위 *</Label>
                <div className="space-y-2">
                  {DATA_SCOPE_OPTIONS.map(opt => (
                    <label key={opt.value} className="flex items-start gap-3 p-3 rounded-lg border hover:bg-slate-50 cursor-pointer transition-colors">
                      <Checkbox
                        checked={selectedScopes.includes(opt.value)}
                        onCheckedChange={() => toggleScope(opt.value)}
                        className="mt-0.5"
                      />
                      <div>
                        <span className="font-medium text-sm">{opt.label}</span>
                        <p className="text-xs text-slate-500">{opt.desc}</p>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className="space-y-2">
                <Label>초대 메시지 (선택)</Label>
                <Textarea
                  placeholder="파트너사에 전달할 메시지를 입력하세요..."
                  value={inviteMessage}
                  onChange={(e) => setInviteMessage(e.target.value)}
                  rows={3}
                />
              </div>
            </div>

            <DialogFooter>
              <Button variant="ghost" onClick={() => setIsDialogOpen(false)}>취소</Button>
              <Button onClick={handleInvite} disabled={processing || !targetTenantId || selectedScopes.length === 0} className="gap-2">
                {processing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                초대 전송
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </main>
    </div>
  );
};

export default PartnershipManagement;



============================================================
File Path: src/pages/admin/ProfileManagement.tsx
============================================================
import { Header } from "@/components/landing/Header";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { User, ArrowLeft, Construction } from "lucide-react";
import { useNavigate } from "react-router-dom";

const ProfileManagement = () => {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-4xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <User className="w-8 h-8 text-primary" /> 인물정보 등록 관리
            </h1>
            <p className="text-slate-500 mt-1">네이버/다음 인물검색 위임장 자동 생성</p>
          </div>
        </div>

        <Card className="border-none shadow-xl bg-white rounded-3xl overflow-hidden">
          <CardContent className="p-16 text-center">
            <div className="inline-flex p-6 rounded-full bg-primary/10 mb-6">
              <Construction className="w-16 h-16 text-primary/60" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-3">기능 준비 중</h2>
            <p className="text-slate-500 max-w-md mx-auto leading-relaxed">
              인물정보 관리 기능이 곧 제공됩니다.<br />
              네이버/다음 위임장 자동 생성, 신분증 관리 등의 기능이 포함될 예정입니다.
            </p>
            <Button 
              variant="outline" 
              className="mt-8"
              onClick={() => navigate("/admin")}
            >
              관리자 홈으로 돌아가기
            </Button>
          </CardContent>
        </Card>
      </main>
    </div>
  );
};

export default ProfileManagement;



============================================================
File Path: src/pages/admin/ProjectManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { 
  Target, 
  ArrowLeft, 
  Plus, 
  Pencil, 
  Trash2,
  Calendar,
  DollarSign,
  Search,
  Filter
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { format } from "date-fns";
import { ko } from "date-fns/locale";

interface Project {
  id: string;
  name: string;
  code: string | null;
  description: string | null;
  status: string;
  start_date: string | null;
  end_date: string | null;
  budget: number | null;
  is_active: boolean;
  created_at: string;
}

const statusColors: Record<string, string> = {
  active: "bg-green-100 text-green-700",
  pending: "bg-yellow-100 text-yellow-700",
  completed: "bg-blue-100 text-blue-700",
  cancelled: "bg-red-100 text-red-700",
};

const statusLabels: Record<string, string> = {
  active: "진행중",
  pending: "대기",
  completed: "완료",
  cancelled: "취소",
};

const ProjectManagement = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState<string>("all");
  
  // Dialog
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editing, setEditing] = useState<Project | null>(null);
  const [form, setForm] = useState({
    name: "",
    code: "",
    description: "",
    status: "active",
    start_date: "",
    end_date: "",
    budget: "",
  });
  
  // Delete
  const [deleteTarget, setDeleteTarget] = useState<Project | null>(null);

  useEffect(() => {
    if (currentTenant) fetchData();
  }, [currentTenant]);

  const fetchData = async () => {
    if (!currentTenant) return;
    setLoading(true);
    
    const { data, error } = await supabase
      .from("projects")
      .select("*")
      .eq("tenant_id", currentTenant.tenant_id)
      .order("created_at", { ascending: false });
    
    if (error) toast.error("데이터 로드 실패");
    else setProjects(data || []);
    setLoading(false);
  };

  const openDialog = (project?: Project) => {
    if (project) {
      setEditing(project);
      setForm({
        name: project.name,
        code: project.code || "",
        description: project.description || "",
        status: project.status,
        start_date: project.start_date || "",
        end_date: project.end_date || "",
        budget: project.budget?.toString() || "",
      });
    } else {
      setEditing(null);
      setForm({
        name: "",
        code: "",
        description: "",
        status: "active",
        start_date: "",
        end_date: "",
        budget: "",
      });
    }
    setDialogOpen(true);
  };

  const saveProject = async () => {
    if (!currentTenant || !form.name.trim()) return;
    
    const payload = {
      tenant_id: currentTenant.tenant_id,
      name: form.name.trim(),
      code: form.code.trim() || null,
      description: form.description.trim() || null,
      status: form.status,
      start_date: form.start_date || null,
      end_date: form.end_date || null,
      budget: form.budget ? parseFloat(form.budget) : null,
    };
    
    if (editing) {
      const { error } = await supabase
        .from("projects")
        .update(payload)
        .eq("id", editing.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("프로젝트가 수정되었습니다");
    } else {
      const { error } = await supabase.from("projects").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("프로젝트가 등록되었습니다");
    }
    
    setDialogOpen(false);
    fetchData();
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    
    const { error } = await supabase.from("projects").delete().eq("id", deleteTarget.id);
    if (error) toast.error("삭제 실패: " + error.message);
    else toast.success("프로젝트가 삭제되었습니다");
    
    setDeleteTarget(null);
    fetchData();
  };

  const filteredProjects = projects.filter(p => {
    const matchesSearch = 
      p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      (p.code?.toLowerCase().includes(searchQuery.toLowerCase()));
    const matchesStatus = statusFilter === "all" || p.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("ko-KR", { style: "currency", currency: "KRW" }).format(amount);
  };

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <Target className="w-8 h-8 text-violet-600" /> 프로젝트 마스터
            </h1>
            <p className="text-slate-500 mt-1">
              {currentTenant?.tenant.name || "회사"} 진행 사업 관리 및 비용 정산 코드 제어
            </p>
          </div>
          <Button onClick={() => openDialog()} className="gap-2">
            <Plus className="w-4 h-4" /> 프로젝트 추가
          </Button>
        </div>

        {/* Filters */}
        <div className="flex gap-4 mb-6">
          <div className="relative flex-1 max-w-md">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
            <Input 
              placeholder="프로젝트명 또는 코드 검색..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>
          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="w-40">
              <Filter className="w-4 h-4 mr-2" />
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">전체 상태</SelectItem>
              <SelectItem value="active">진행중</SelectItem>
              <SelectItem value="pending">대기</SelectItem>
              <SelectItem value="completed">완료</SelectItem>
              <SelectItem value="cancelled">취소</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Project List */}
        <Card className="border-none shadow-xl bg-white rounded-3xl">
          <CardContent className="p-0">
            {loading ? (
              <div className="text-center py-12 text-slate-400">로딩 중...</div>
            ) : filteredProjects.length === 0 ? (
              <div className="text-center py-12 text-slate-400">
                {searchQuery || statusFilter !== "all" 
                  ? "검색 결과가 없습니다" 
                  : "등록된 프로젝트가 없습니다"}
              </div>
            ) : (
              <div className="divide-y">
                {filteredProjects.map(project => (
                  <div key={project.id} className="p-6 hover:bg-slate-50 group">
                    <div className="flex items-start gap-4">
                      <div className="w-12 h-12 rounded-xl bg-violet-100 flex items-center justify-center">
                        <Target className="w-6 h-6 text-violet-600" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-3 mb-1">
                          <h3 className="font-bold text-lg truncate">{project.name}</h3>
                          {project.code && (
                            <Badge variant="outline" className="font-mono text-xs">
                              {project.code}
                            </Badge>
                          )}
                          <Badge className={statusColors[project.status] || "bg-gray-100"}>
                            {statusLabels[project.status] || project.status}
                          </Badge>
                        </div>
                        {project.description && (
                          <p className="text-slate-500 text-sm mb-2 line-clamp-1">{project.description}</p>
                        )}
                        <div className="flex items-center gap-4 text-sm text-slate-400">
                          {(project.start_date || project.end_date) && (
                            <span className="flex items-center gap-1">
                              <Calendar className="w-4 h-4" />
                              {project.start_date && format(new Date(project.start_date), "yy.MM.dd", { locale: ko })}
                              {project.start_date && project.end_date && " ~ "}
                              {project.end_date && format(new Date(project.end_date), "yy.MM.dd", { locale: ko })}
                            </span>
                          )}
                          {project.budget && (
                            <span className="flex items-center gap-1">
                              <DollarSign className="w-4 h-4" />
                              {formatCurrency(project.budget)}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="opacity-0 group-hover:opacity-100 flex gap-1">
                        <Button variant="ghost" size="icon" onClick={() => openDialog(project)}>
                          <Pencil className="w-4 h-4" />
                        </Button>
                        <Button 
                          variant="ghost" 
                          size="icon" 
                          className="text-red-500 hover:text-red-600"
                          onClick={() => setDeleteTarget(project)}
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </main>

      {/* Dialog */}
      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>{editing ? "프로젝트 수정" : "프로젝트 추가"}</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>프로젝트명 *</Label>
                <Input 
                  value={form.name}
                  onChange={e => setForm(f => ({ ...f, name: e.target.value }))}
                  placeholder="예: 2024 신규 캠페인"
                />
              </div>
              <div className="space-y-2">
                <Label>프로젝트 코드</Label>
                <Input 
                  value={form.code}
                  onChange={e => setForm(f => ({ ...f, code: e.target.value }))}
                  placeholder="예: PRJ-2024-001"
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label>상태</Label>
              <Select value={form.status} onValueChange={v => setForm(f => ({ ...f, status: v }))}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="active">진행중</SelectItem>
                  <SelectItem value="pending">대기</SelectItem>
                  <SelectItem value="completed">완료</SelectItem>
                  <SelectItem value="cancelled">취소</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>시작일</Label>
                <Input 
                  type="date"
                  value={form.start_date}
                  onChange={e => setForm(f => ({ ...f, start_date: e.target.value }))}
                />
              </div>
              <div className="space-y-2">
                <Label>종료일</Label>
                <Input 
                  type="date"
                  value={form.end_date}
                  onChange={e => setForm(f => ({ ...f, end_date: e.target.value }))}
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label>예산 (원)</Label>
              <Input 
                type="number"
                value={form.budget}
                onChange={e => setForm(f => ({ ...f, budget: e.target.value }))}
                placeholder="예: 50000000"
              />
            </div>
            <div className="space-y-2">
              <Label>설명</Label>
              <Textarea 
                value={form.description}
                onChange={e => setForm(f => ({ ...f, description: e.target.value }))}
                placeholder="프로젝트에 대한 설명"
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDialogOpen(false)}>취소</Button>
            <Button onClick={saveProject} disabled={!form.name.trim()}>저장</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteTarget} onOpenChange={() => setDeleteTarget(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>프로젝트 삭제</AlertDialogTitle>
            <AlertDialogDescription>
              "{deleteTarget?.name}" 프로젝트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-red-500 hover:bg-red-600">
              삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default ProjectManagement;



============================================================
File Path: src/pages/admin/ScheduleManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter,
} from "@/components/ui/dialog";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Switch } from "@/components/ui/switch";
import {
  ArrowLeft, Calendar, Plus, Loader2, Edit2, Trash2, Clock, MapPin, User, List, CalendarDays,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { toast } from "sonner";
import { format } from "date-fns";
import { ScheduleCalendar } from "@/components/schedule/ScheduleCalendar";

interface Schedule {
  id: string;
  artist_id: string;
  tenant_id: string;
  title: string;
  description: string | null;
  start_time: string;
  end_time: string;
  is_all_day: boolean;
  schedule_type: string;
  location: string | null;
  created_at: string;
  artist?: { id: string; name: string; stage_name: string | null };
}

interface Artist {
  id: string;
  name: string;
  stage_name: string | null;
}

const SCHEDULE_TYPES = [
  { value: "schedule", label: "일반 일정" },
  { value: "filming", label: "촬영" },
  { value: "meeting", label: "미팅" },
  { value: "event", label: "행사" },
  { value: "rehearsal", label: "리허설" },
  { value: "interview", label: "인터뷰" },
  { value: "travel", label: "이동" },
  { value: "rest", label: "휴식" },
];

const ScheduleManagement = () => {
  const { currentTenant, profile } = useAuth();
  const navigate = useNavigate();
  const myTenantId = currentTenant?.tenant_id;

  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [artists, setArtists] = useState<Artist[]>([]);
  const [loading, setLoading] = useState(true);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<Schedule | null>(null);
  const [deleteTarget, setDeleteTarget] = useState<Schedule | null>(null);
  const [processing, setProcessing] = useState(false);
  const [filterArtistId, setFilterArtistId] = useState("all");
  const [pageView, setPageView] = useState<"list" | "calendar">("calendar");

  // Form state
  const [form, setForm] = useState({
    artist_id: "",
    title: "",
    description: "",
    start_time: "",
    end_time: "",
    is_all_day: false,
    schedule_type: "schedule",
    location: "",
  });

  const fetchData = async () => {
    if (!myTenantId) return;
    setLoading(true);
    try {
      const [scheduleRes, artistRes] = await Promise.all([
        supabase
          .from("artist_schedules")
          .select("*, artist:artist_id ( id, name, stage_name )" as any)
          .eq("tenant_id", myTenantId)
          .order("start_time", { ascending: false }),
        supabase
          .from("artists")
          .select("id, name, stage_name")
          .eq("tenant_id", myTenantId)
          .eq("is_active", true)
          .order("name"),
      ]);

      if (scheduleRes.error) throw scheduleRes.error;
      setSchedules((scheduleRes.data || []) as unknown as Schedule[]);
      setArtists((artistRes.data || []) as Artist[]);
    } catch (error) {
      console.error("Fetch error:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [myTenantId]);

  const resetForm = () => {
    setForm({
      artist_id: "",
      title: "",
      description: "",
      start_time: "",
      end_time: "",
      is_all_day: false,
      schedule_type: "schedule",
      location: "",
    });
    setEditingSchedule(null);
  };

  const openCreate = () => {
    resetForm();
    setIsDialogOpen(true);
  };

  const openEdit = (s: Schedule) => {
    setEditingSchedule(s);
    setForm({
      artist_id: s.artist_id,
      title: s.title,
      description: s.description || "",
      start_time: s.start_time.slice(0, 16),
      end_time: s.end_time.slice(0, 16),
      is_all_day: s.is_all_day,
      schedule_type: s.schedule_type || "schedule",
      location: s.location || "",
    });
    setIsDialogOpen(true);
  };

  const handleSave = async () => {
    if (!form.artist_id || !form.title || !form.start_time || !form.end_time) {
      toast.error("배우, 제목, 시작/종료 시간을 입력해주세요.");
      return;
    }
    if (new Date(form.end_time) <= new Date(form.start_time)) {
      toast.error("종료 시간은 시작 시간 이후여야 합니다.");
      return;
    }

    setProcessing(true);
    try {
      const payload = {
        artist_id: form.artist_id,
        tenant_id: myTenantId,
        title: form.title,
        description: form.description || null,
        start_time: new Date(form.start_time).toISOString(),
        end_time: new Date(form.end_time).toISOString(),
        is_all_day: form.is_all_day,
        schedule_type: form.schedule_type,
        location: form.location || null,
        ...(editingSchedule ? {} : { created_by: profile?.id }),
      };

      if (editingSchedule) {
        const { error } = await supabase
          .from("artist_schedules")
          .update(payload as any)
          .eq("id", editingSchedule.id);
        if (error) throw error;
        toast.success("일정이 수정되었습니다.");
      } else {
        const { error } = await supabase
          .from("artist_schedules")
          .insert(payload as any);
        if (error) throw error;
        toast.success("일정이 등록되었습니다.");
      }

      setIsDialogOpen(false);
      resetForm();
      fetchData();
    } catch (error: any) {
      toast.error("저장 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    setProcessing(true);
    try {
      const { error } = await supabase
        .from("artist_schedules")
        .delete()
        .eq("id", deleteTarget.id);
      if (error) throw error;
      toast.success("일정이 삭제되었습니다.");
      setDeleteTarget(null);
      fetchData();
    } catch (error: any) {
      toast.error("삭제 실패: " + error.message);
    } finally {
      setProcessing(false);
    }
  };

  const filteredSchedules = filterArtistId === "all"
    ? schedules
    : schedules.filter(s => s.artist_id === filterArtistId);

  const getTypeLabel = (type: string) =>
    SCHEDULE_TYPES.find(t => t.value === type)?.label || type;

  const getTypeBadgeColor = (type: string) => {
    const colors: Record<string, string> = {
      filming: "bg-red-100 text-red-700",
      meeting: "bg-blue-100 text-blue-700",
      event: "bg-purple-100 text-purple-700",
      rehearsal: "bg-amber-100 text-amber-700",
      interview: "bg-cyan-100 text-cyan-700",
      travel: "bg-green-100 text-green-700",
      rest: "bg-slate-100 text-slate-500",
    };
    return colors[type] || "bg-slate-100 text-slate-600";
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50">
        <Header />
        <div className="pt-28 flex justify-center">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <div className="flex items-center gap-2 text-primary font-bold text-sm mb-1">
              <Calendar className="w-5 h-5" /> Schedule Hub
            </div>
            <h1 className="text-3xl font-extrabold tracking-tight text-slate-900">배우 스케줄 관리</h1>
            <p className="text-slate-500 mt-1">배우별 일정을 등록하고 관리합니다.</p>
          </div>
          <div className="flex gap-3">
            <Button variant="ghost" onClick={() => navigate("/admin")} className="gap-2">
              <ArrowLeft className="w-4 h-4" /> 관리 시스템
            </Button>
            <Button onClick={openCreate} className="gap-2">
              <Plus className="w-4 h-4" /> 일정 등록
            </Button>
          </div>
        </div>

        {/* Filter & View Toggle */}
        <div className="mb-6 flex items-center justify-between">
          <Select value={filterArtistId} onValueChange={setFilterArtistId}>
            <SelectTrigger className="w-64">
              <SelectValue placeholder="배우 필터" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">전체 배우</SelectItem>
              {artists.map(a => (
                <SelectItem key={a.id} value={a.id}>
                  {a.name}{a.stage_name ? ` (${a.stage_name})` : ""}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <div className="flex gap-1 bg-muted rounded-lg p-0.5">
            <Button
              variant={pageView === "calendar" ? "default" : "ghost"}
              size="sm"
              className="gap-1.5 h-8 text-xs"
              onClick={() => setPageView("calendar")}
            >
              <CalendarDays className="w-3.5 h-3.5" /> 캘린더
            </Button>
            <Button
              variant={pageView === "list" ? "default" : "ghost"}
              size="sm"
              className="gap-1.5 h-8 text-xs"
              onClick={() => setPageView("list")}
            >
              <List className="w-3.5 h-3.5" /> 목록
            </Button>
          </div>
        </div>

        {/* Calendar View */}
        {pageView === "calendar" && (
          <div className="mb-6">
            <ScheduleCalendar
              schedules={filteredSchedules}
              onEventClick={(s) => openEdit(s as any)}
            />
          </div>
        )}

        {/* Schedule List */}
        {pageView === "list" && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              <Calendar className="w-5 h-5 text-primary" /> 일정 목록 ({filteredSchedules.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {filteredSchedules.length === 0 ? (
              <div className="text-center py-16 text-slate-400">
                <Calendar className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p className="font-medium">등록된 일정이 없습니다.</p>
                <p className="text-sm mt-1">일정 등록 버튼으로 새 일정을 추가하세요.</p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredSchedules.map(s => (
                  <div
                    key={s.id}
                    className="bg-white rounded-xl p-5 border border-slate-200 hover:shadow-md transition-shadow flex flex-col md:flex-row md:items-center justify-between gap-4"
                  >
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <Badge className={`text-xs ${getTypeBadgeColor(s.schedule_type)}`}>
                          {getTypeLabel(s.schedule_type)}
                        </Badge>
                        {s.is_all_day && (
                          <Badge variant="outline" className="text-xs">종일</Badge>
                        )}
                      </div>
                      <h3 className="font-bold text-lg text-slate-900 truncate">{s.title}</h3>
                      <div className="flex flex-wrap items-center gap-3 mt-1 text-sm text-slate-500">
                        <span className="flex items-center gap-1">
                          <User className="w-3.5 h-3.5" />
                          {(s.artist as any)?.name || "알 수 없음"}
                        </span>
                        <span className="flex items-center gap-1">
                          <Clock className="w-3.5 h-3.5" />
                          {format(new Date(s.start_time), "MM/dd HH:mm")} ~ {format(new Date(s.end_time), "MM/dd HH:mm")}
                        </span>
                        {s.location && (
                          <span className="flex items-center gap-1">
                            <MapPin className="w-3.5 h-3.5" />
                            {s.location}
                          </span>
                        )}
                      </div>
                      {s.description && (
                        <p className="text-sm text-slate-400 mt-1 truncate">{s.description}</p>
                      )}
                    </div>
                    <div className="flex gap-2 shrink-0">
                      <Button size="sm" variant="ghost" className="gap-1" onClick={() => openEdit(s)}>
                        <Edit2 className="w-4 h-4" /> 수정
                      </Button>
                      <Button
                        size="sm"
                        variant="ghost"
                        className="gap-1 text-red-500 hover:text-red-700"
                        onClick={() => setDeleteTarget(s)}
                      >
                        <Trash2 className="w-4 h-4" /> 삭제
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
        )}

        {/* Create/Edit Dialog */}
        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent className="sm:max-w-lg">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Calendar className="w-5 h-5 text-primary" />
                {editingSchedule ? "일정 수정" : "일정 등록"}
              </DialogTitle>
              <DialogDescription>
                배우의 스케줄을 {editingSchedule ? "수정" : "등록"}합니다.
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label>배우 *</Label>
                <Select value={form.artist_id} onValueChange={v => setForm(f => ({ ...f, artist_id: v }))}>
                  <SelectTrigger>
                    <SelectValue placeholder="배우를 선택하세요" />
                  </SelectTrigger>
                  <SelectContent>
                    {artists.map(a => (
                      <SelectItem key={a.id} value={a.id}>
                        {a.name}{a.stage_name ? ` (${a.stage_name})` : ""}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>제목 *</Label>
                <Input
                  value={form.title}
                  onChange={e => setForm(f => ({ ...f, title: e.target.value }))}
                  placeholder="일정 제목"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>일정 유형</Label>
                  <Select value={form.schedule_type} onValueChange={v => setForm(f => ({ ...f, schedule_type: v }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {SCHEDULE_TYPES.map(t => (
                        <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>장소</Label>
                  <Input
                    value={form.location}
                    onChange={e => setForm(f => ({ ...f, location: e.target.value }))}
                    placeholder="장소 (선택)"
                  />
                </div>
              </div>

              <div className="flex items-center gap-3">
                <Switch
                  checked={form.is_all_day}
                  onCheckedChange={v => setForm(f => ({ ...f, is_all_day: v }))}
                />
                <Label>종일 일정</Label>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>시작 *</Label>
                  <Input
                    type="datetime-local"
                    value={form.start_time}
                    onChange={e => setForm(f => ({ ...f, start_time: e.target.value }))}
                  />
                </div>
                <div className="space-y-2">
                  <Label>종료 *</Label>
                  <Input
                    type="datetime-local"
                    value={form.end_time}
                    onChange={e => setForm(f => ({ ...f, end_time: e.target.value }))}
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label>설명 (선택)</Label>
                <Textarea
                  value={form.description}
                  onChange={e => setForm(f => ({ ...f, description: e.target.value }))}
                  placeholder="상세 내용을 입력하세요..."
                  rows={3}
                />
              </div>
            </div>

            <DialogFooter>
              <Button variant="ghost" onClick={() => setIsDialogOpen(false)}>취소</Button>
              <Button
                onClick={handleSave}
                disabled={processing || !form.artist_id || !form.title || !form.start_time || !form.end_time}
                className="gap-2"
              >
                {processing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Calendar className="w-4 h-4" />}
                {editingSchedule ? "수정" : "등록"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Delete Confirm */}
        <AlertDialog open={!!deleteTarget} onOpenChange={open => !open && setDeleteTarget(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>일정 삭제</AlertDialogTitle>
              <AlertDialogDescription>
                "{deleteTarget?.title}" 일정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>취소</AlertDialogCancel>
              <AlertDialogAction onClick={handleDelete} className="bg-red-600 hover:bg-red-700">
                삭제
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </main>
    </div>
  );
};

export default ScheduleManagement;



============================================================
File Path: src/pages/admin/TenantAPISettings.tsx
============================================================
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Settings, Save, Key, RefreshCw, Eye, EyeOff, AlertCircle, Plus, Loader2, Trash2 } from "lucide-react";
import {
  Sheet, SheetContent, SheetHeader, SheetTitle, SheetFooter, SheetClose
} from "@/components/ui/sheet";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue
} from "@/components/ui/select";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";

interface ConfigItem {
  id: string;
  tenant_id: string;
  config_key: string;
  config_value: string;
  description: string | null;
  category: string;
  is_encrypted: boolean;
}

const categoryOptions = ["general", "ai", "social", "analytics", "payment", "telegram"];

const categoryPresetKeys: Record<string, { key: string; description: string }[]> = {
  general: [],
  ai: [
    { key: "GEMINI_API_KEY", description: "Google Gemini API 키" },
    { key: "OPENAI_API_KEY", description: "OpenAI API 키" },
    { key: "HUGGINGFACE_API_KEY", description: "Hugging Face API 키" },
  ],
  social: [
    { key: "NAVER_CLIENT_ID", description: "네이버 검색 API Client ID" },
    { key: "NAVER_CLIENT_SECRET", description: "네이버 검색 API Client Secret" },
    { key: "KAKAO_REST_API_KEY", description: "카카오 REST API 키" },
    { key: "INSTAGRAM_ACCESS_TOKEN", description: "인스타그램 액세스 토큰" },
  ],
  analytics: [
    { key: "GA_MEASUREMENT_ID", description: "Google Analytics 측정 ID" },
    { key: "GA_API_SECRET", description: "Google Analytics API Secret" },
  ],
  payment: [
    { key: "TOSS_SECRET_KEY", description: "토스페이먼츠 시크릿 키" },
    { key: "TOSS_CLIENT_KEY", description: "토스페이먼츠 클라이언트 키" },
  ],
  telegram: [
    { key: "TELEGRAM_BOT_TOKEN", description: "텔레그램 봇 토큰 (@BotFather)" },
    { key: "TELEGRAM_CHAT_ID", description: "텔레그램 채팅/그룹 ID" },
  ],
};

const TenantAPISettings = () => {
  const { currentTenant, isCompanyAdmin, isSuperAdmin } = useAuth();
  const [configs, setConfigs] = useState<ConfigItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [showKey, setShowKey] = useState<Record<string, boolean>>({});

  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [currentConfig, setCurrentConfig] = useState<ConfigItem | null>(null);

  const [formData, setFormData] = useState({
    config_key: "",
    config_value: "",
    description: "",
    category: "general",
  });

  const fetchConfigs = async () => {
    if (!currentTenant) return;
    setLoading(true);
    const { data, error } = await supabase
      .from("tenant_api_configs")
      .select("*")
      .eq("tenant_id", currentTenant.tenant_id)
      .order("category");

    if (error) {
      toast.error("설정을 불러오지 못했습니다.");
    } else {
      setConfigs(data || []);
    }
    setLoading(false);
  };

  useEffect(() => {
    fetchConfigs();
  }, [currentTenant]);

  const handleChange = (id: string, newValue: string) => {
    setConfigs(prev => prev.map(item =>
      item.id === id ? { ...item, config_value: newValue } : item
    ));
  };

  const handleSaveValue = async (config: ConfigItem) => {
    setSaving(true);
    const { error } = await supabase
      .from("tenant_api_configs")
      .update({
        config_value: config.config_value,
        updated_at: new Date().toISOString()
      })
      .eq("id", config.id);

    if (error) {
      toast.error("저장 실패");
    } else {
      toast.success("설정이 업데이트되었습니다.");
    }
    setSaving(false);
  };

  const handleAddConfig = async () => {
    if (!formData.config_key || !currentTenant) {
      toast.error("설정 키는 필수입니다.");
      return;
    }
    setSaving(true);
    try {
      const { error } = await supabase
        .from("tenant_api_configs")
        .insert({
          tenant_id: currentTenant.tenant_id,
          config_key: formData.config_key,
          config_value: formData.config_value,
          description: formData.description || null,
          category: formData.category,
        });
      if (error) throw error;
      toast.success("새 설정이 추가되었습니다.");
      setIsSheetOpen(false);
      fetchConfigs();
    } catch (error: any) {
      if (error.code === '23505') {
        toast.error("이미 존재하는 설정 키입니다.");
      } else {
        toast.error(`추가 실패: ${error.message}`);
      }
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async () => {
    if (!currentConfig) return;
    setSaving(true);
    try {
      const { error } = await supabase
        .from("tenant_api_configs")
        .delete()
        .eq("id", currentConfig.id);
      if (error) throw error;
      toast.success("설정이 삭제되었습니다.");
      setIsDeleteDialogOpen(false);
      fetchConfigs();
    } catch (error: any) {
      toast.error(`삭제 실패: ${error.message}`);
    } finally {
      setSaving(false);
      setCurrentConfig(null);
    }
  };

  const toggleShow = (id: string) => {
    setShowKey(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const openAddSheet = () => {
    setFormData({ config_key: "", config_value: "", description: "", category: "general" });
    setIsSheetOpen(true);
  };

  if (!isCompanyAdmin) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="text-center space-y-4">
          <AlertCircle className="w-12 h-12 text-destructive mx-auto" />
          <p className="text-muted-foreground font-medium">접근 권한이 없습니다.</p>
          <Button onClick={() => window.history.back()} variant="outline">뒤로 가기</Button>
        </div>
      </div>
    );
  }

  // 카테고리별 그룹핑
  const groupedConfigs = configs.reduce((acc, config) => {
    const cat = config.category || "general";
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(config);
    return acc;
  }, {} as Record<string, ConfigItem[]>);

  const categoryLabels: Record<string, string> = {
    general: "일반 설정",
    ai: "AI / LLM",
    social: "소셜 미디어",
    analytics: "분석 도구",
    payment: "결제",
    telegram: "📨 텔레그램 봇",
  };

  return (
    <div className="min-h-screen bg-background text-foreground">
      <Header />
      <main className="pt-24 pb-16 px-4 max-w-5xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Settings className="w-8 h-8 text-primary" /> 회사 API 설정
            </h1>
            <p className="text-muted-foreground mt-2">
              {isSuperAdmin ? "전체 회사" : currentTenant?.tenant.name}의 API 키와 설정을 관리합니다.
            </p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={fetchConfigs}>
              <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} /> 새로고침
            </Button>
            <Button variant="hero" onClick={openAddSheet}>
              <Plus className="w-4 h-4 mr-2" /> 설정 추가
            </Button>
          </div>
        </div>

        {loading ? (
          <div className="flex items-center justify-center h-64">
            <Loader2 className="w-8 h-8 animate-spin text-primary" />
          </div>
        ) : configs.length === 0 ? (
          <Card className="glass-card">
            <CardContent className="py-16 text-center text-muted-foreground">
              등록된 API 설정이 없습니다. 새 설정을 추가해 보세요.
            </CardContent>
          </Card>
        ) : (
          <div className="grid gap-6">
            {Object.entries(groupedConfigs).map(([category, items]) => (
              <Card key={category} className="glass-card border-l-4 border-l-primary/50">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Key className="w-5 h-5 text-primary" /> {categoryLabels[category] || category}
                  </CardTitle>
                  <CardDescription>{items.length}개 설정</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  {items.map((config) => (
                    <div key={config.id} className="grid gap-2 p-4 rounded-xl bg-secondary/20 border border-border/50">
                      <div className="flex justify-between items-center">
                        <Label className="font-bold text-sm flex items-center gap-2">
                          <Key className="w-3 h-3 text-muted-foreground" /> {config.config_key}
                        </Label>
                        <div className="flex items-center gap-2">
                          {config.description && (
                            <Badge variant="outline" className="text-[10px]">{config.description}</Badge>
                          )}
                          <Button
                            variant="ghost"
                            size="icon"
                            className="w-7 h-7 text-destructive"
                            onClick={() => { setCurrentConfig(config); setIsDeleteDialogOpen(true); }}
                          >
                            <Trash2 className="w-3 h-3" />
                          </Button>
                        </div>
                      </div>

                      <div className="flex gap-2">
                        <div className="relative flex-1">
                          <Input
                            type={showKey[config.id] ? "text" : "password"}
                            value={config.config_value}
                            onChange={(e) => handleChange(config.id, e.target.value)}
                            className="pr-10 font-mono text-sm"
                            placeholder="값을 입력하세요"
                          />
                          <button
                            onClick={() => toggleShow(config.id)}
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                          >
                            {showKey[config.id] ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                          </button>
                        </div>
                        <Button
                          onClick={() => handleSaveValue(config)}
                          disabled={saving}
                          size="sm"
                          className="w-20"
                        >
                          {saving ? "저장..." : <><Save className="w-4 h-4 mr-1" /> 저장</>}
                        </Button>
                      </div>
                    </div>
                  ))}
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </main>

      {/* 설정 추가 Sheet */}
      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className="sm:max-w-md p-0 overflow-hidden flex flex-col">
          <SheetHeader className="p-6 border-b">
            <SheetTitle className="text-xl font-bold flex items-center gap-2">
              <Plus className="w-5 h-5 text-primary" /> 새 API 설정 추가
            </SheetTitle>
          </SheetHeader>
          <div className="p-6 space-y-6 overflow-y-auto flex-1">
            <div className="space-y-2">
              <Label htmlFor="category">카테고리</Label>
              <Select value={formData.category} onValueChange={(val) => setFormData({ ...formData, category: val, config_key: "", description: "" })}>
                <SelectTrigger id="category">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {categoryOptions.map(c => (
                    <SelectItem key={c} value={c}>{categoryLabels[c] || c}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            {categoryPresetKeys[formData.category]?.length > 0 && (
              <div className="space-y-2">
                <Label>빠른 선택</Label>
                <div className="flex flex-wrap gap-2">
                  {categoryPresetKeys[formData.category].map(preset => (
                    <Button
                      key={preset.key}
                      type="button"
                      variant={formData.config_key === preset.key ? "default" : "outline"}
                      size="sm"
                      className="text-xs"
                      onClick={() => setFormData({ ...formData, config_key: preset.key, description: preset.description })}
                    >
                      {preset.key}
                    </Button>
                  ))}
                </div>
              </div>
            )}
            <div className="space-y-2">
              <Label htmlFor="config_key">설정 키 *</Label>
              <Input
                id="config_key"
                placeholder="예: OPENAI_API_KEY"
                value={formData.config_key}
                onChange={(e) => setFormData({ ...formData, config_key: e.target.value.toUpperCase().replace(/\s/g, '_') })}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="config_value">값</Label>
              <Input
                id="config_value"
                type="password"
                placeholder="API 키 또는 설정값"
                value={formData.config_value}
                onChange={(e) => setFormData({ ...formData, config_value: e.target.value })}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="description">설명</Label>
              <Input
                id="description"
                placeholder="예: OpenAI GPT-4 API 키"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              />
            </div>
          </div>
          <SheetFooter className="p-6 border-t">
            <SheetClose asChild>
              <Button variant="outline" disabled={saving}>취소</Button>
            </SheetClose>
            <Button onClick={handleAddConfig} disabled={saving || !formData.config_key}>
              {saving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Plus className="w-4 h-4 mr-2" />}
              추가
            </Button>
          </SheetFooter>
        </SheetContent>
      </Sheet>

      {/* 삭제 확인 Dialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-destructive font-bold text-xl">설정을 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription>
              "{currentConfig?.config_key}" 설정이 영구적으로 삭제됩니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={saving}>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} disabled={saving} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
              {saving ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : null}삭제
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default TenantAPISettings;



============================================================
File Path: src/pages/admin/VehicleManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/hooks/useAuth";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  CarFront,
  Plus,
  Edit2,
  Trash2,
  ArrowLeft,
  Fuel,
  Loader2,
  Save,
  ShieldCheck,
  Building,
  CalendarClock,
  Briefcase,
  Search,
  Zap,
  AlertCircle,
  Phone,
  Landmark,
  Gauge,
  Route,
  CreditCard,
  User,
} from "lucide-react";
import { toast } from "sonner";
import { differenceInDays, parseISO } from "date-fns";

const VehicleManagement = () => {
  const { currentTenant } = useAuth();
  const navigate = useNavigate();
  const [vehicles, setVehicles] = useState<any[]>([]);
  const [employees, setEmployees] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");

  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [deleteId, setDeleteId] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  // 모든 필드를 포함한 초기 상태
  const initialFormState = {
    vehicle_number: "",
    model_name: "",
    fuel_type: "휘발유",
    initial_mileage: 0,
    usage_category: "비영업용승용차",
    ownership_type: "리스",
    vendor_name: "",
    contract_manager: "",
    contact_number: "",
    monthly_fee: 0,
    payment_day: 1,
    payment_method: "카드 결제",
    primary_driver: "",
    requires_log: false,
    insurance_company: "",
    insurance_start_date: "",
    insurance_end_date: "",
    insurance_driver_age: "만 26세 이상",
    contract_start_date: "",
    contract_end_date: "",
    annual_contract_mileage: 20000,
    excess_mileage_fee: 0,
  };

  const [formData, setFormData] = useState<any>(initialFormState);

  useEffect(() => {
    if (currentTenant) fetchInitialData();
  }, [currentTenant]);

  const fetchInitialData = async () => {
    setLoading(true);
    const { data: empData } = await supabase
      .from("tenant_memberships")
      .select(`user_id, profiles:user_id ( full_name, email )`)
      .eq("tenant_id", currentTenant.tenant_id);
    if (empData) setEmployees(empData);
    await fetchVehicles();
    setLoading(false);
  };

  const fetchVehicles = async () => {
    const { data, error } = await supabase
      .from("vehicles")
      .select(`*`)
      .eq("tenant_id", currentTenant.tenant_id)
      .order("created_at", { ascending: false });
    if (error) {
      console.error("차량 조회 오류:", error);
      return;
    }
    if (data) setVehicles(data);
  };

  const handleEditClick = (v: any) => {
    const sanitizedData = { ...initialFormState };
    Object.keys(initialFormState).forEach((key) => {
      sanitizedData[key] = v[key] ?? (initialFormState as any)[key];
    });
    setFormData(sanitizedData);
    setEditingId(v.id);
    setIsAddDialogOpen(true);
  };

  const handleSave = async () => {
    if (!formData.vehicle_number) return toast.error("차량 번호를 입력해주세요.");
    setIsSaving(true);
    try {
      const submitData = {
        ...formData,
        plate_number: formData.vehicle_number,
        tenant_id: currentTenant.tenant_id,
        primary_driver: formData.primary_driver === "none" || !formData.primary_driver ? null : formData.primary_driver,
        insurance_start_date: formData.insurance_start_date || null,
        insurance_end_date: formData.insurance_end_date || null,
        contract_start_date: formData.contract_start_date || null,
        contract_end_date: formData.contract_end_date || null,
      };

      let result;
      if (editingId) {
        result = await supabase.from("vehicles").update(submitData).eq("id", editingId);
      } else {
        result = await supabase.from("vehicles").insert([submitData]);
      }

      if (result.error) {
        throw result.error;
      }

      toast.success("차량 마스터 정보가 저장되었습니다.");
      setIsAddDialogOpen(false);
      resetForm();
      await fetchVehicles();
    } catch (error: any) {
      toast.error(`저장 실패: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const resetForm = () => {
    setFormData(initialFormState);
    setEditingId(null);
  };

  const getDDay = (dateStr: string) => {
    if (!dateStr) return null;
    try {
      return differenceInDays(parseISO(dateStr), new Date());
    } catch (e) {
      return null;
    }
  };

  const filteredVehicles = vehicles.filter(
    (v) => v.vehicle_number.includes(searchQuery) || v.model_name?.includes(searchQuery),
  );

  return (
    <div className="min-h-screen bg-[#F1F5F9]">
      <Header />
      <main className="pt-24 pb-16 px-6 max-w-[1600px] mx-auto">
        {/* 1. 상단 헤더 */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              className="rounded-lg bg-white shadow-sm border border-slate-300 w-9 h-9"
              onClick={() => navigate("/admin")}
            >
              <ArrowLeft className="w-4 h-4 text-slate-600" />
            </Button>
            <div>
              <div className="flex items-center gap-1.5">
                <h1 className="text-xl font-black tracking-tight text-slate-900">차량 관리 대장</h1>
                <Badge
                  variant="outline"
                  className="bg-blue-50 text-blue-600 border-blue-100 text-[10px] h-4 uppercase font-black"
                >
                  법인 자산
                </Badge>
              </div>
              <p className="text-slate-500 text-[11px] font-bold">전사 법인 차량 계약, 금융, 보험 마스터 데이터 관리</p>
            </div>
          </div>
          <Button
            onClick={() => {
              resetForm();
              setIsAddDialogOpen(true);
            }}
            size="sm"
            className="bg-blue-600 hover:bg-blue-700 h-9 px-4 rounded-lg font-bold text-xs shadow-md transition-all active:scale-95"
          >
            <Plus className="mr-1.5 w-3.5 h-3.5" /> 차량 신규 등록
          </Button>
        </div>

        {/* 2. 요약 통계 카드 */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                <CarFront size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">전체 보유 차량</p>
                <p className="text-lg font-black text-slate-800">{vehicles.length} 대</p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600">
                <ShieldCheck size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">보험 상태</p>
                <p className="text-lg font-black text-slate-800 uppercase tracking-tighter">검증 완료</p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600">
                <CalendarClock size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">60일내 계약만료</p>
                <p className="text-lg font-black text-slate-800">
                  {
                    vehicles.filter((v) => {
                      const d = getDDay(v.contract_end_date);
                      return d !== null && d <= 60;
                    }).length
                  }{" "}
                  대
                </p>
              </div>
            </CardContent>
          </Card>
          <Card className="border border-slate-300 shadow-sm bg-white overflow-hidden">
            <CardContent className="p-4 flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600">
                <Zap size={20} />
              </div>
              <div>
                <p className="text-[9px] font-black text-slate-400 uppercase">운행일지 대상</p>
                <p className="text-lg font-black text-slate-800">{vehicles.filter((v) => v.requires_log).length} 대</p>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* 3. 검색 영역 */}
        <div className="mb-6 relative group">
          <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors" />
          <Input
            placeholder="차량 번호 또는 모델명 검색..."
            className="pl-10 h-10 rounded-lg border border-slate-300 shadow-sm bg-white text-xs font-medium"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>

        {/* 4. 차량 리스트 테이블 */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-300 overflow-hidden">
          <Table>
            <TableHeader className="bg-slate-50 border-b border-slate-300">
              <TableRow className="hover:bg-transparent border-none">
                <TableHead className="py-3 px-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  차량 식별 정보
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  계약처 (업체명)
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  운행자 / 보험
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  금융 (월 이용료)
                </TableHead>
                <TableHead className="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  운행 / 세무 설정
                </TableHead>
                <TableHead className="text-right px-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                  관리
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={6} className="h-40 text-center">
                    <Loader2 className="animate-spin mx-auto text-blue-600" />
                  </TableCell>
                </TableRow>
              ) : filteredVehicles.length > 0 ? (
                filteredVehicles.map((v) => {
                  const insDDay = getDDay(v.insurance_end_date);
                  const conDDay = getDDay(v.contract_end_date);
                  return (
                    <TableRow
                      key={v.id}
                      className="hover:bg-slate-50 transition-all border-b border-slate-200 last:border-none group"
                    >
                      <TableCell className="py-4 px-6">
                        <div className="flex flex-col">
                          <span className="text-sm font-black text-slate-900 tracking-tighter">{v.vehicle_number}</span>
                          <span className="text-[10px] font-bold text-slate-400 uppercase">
                            {v.model_name || "미지정"}
                          </span>
                          <div className="flex gap-1 mt-1">
                            <Badge
                              variant="outline"
                              className="h-4 text-[8px] px-1 border-slate-200 text-slate-500 font-bold uppercase"
                            >
                              {v.fuel_type}
                            </Badge>
                            <Badge
                              variant="outline"
                              className="h-4 text-[8px] px-1 border-slate-200 text-blue-600 font-bold uppercase"
                            >
                              {v.ownership_type}
                            </Badge>
                          </div>
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex flex-col">
                          <span className="text-xs font-bold text-slate-700">{v.vendor_name || "-"}</span>
                          <span className="text-[10px] text-slate-400">
                            {v.contract_manager} | {v.contact_number}
                          </span>
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex flex-col">
                          <div className="flex items-center gap-1.5 mb-1">
                            <User size={12} className="text-slate-300" />
                            <span className="text-xs font-bold text-slate-700">
                              {employees.find(e => e.user_id === v.primary_driver)?.profiles?.full_name || "미지정"}
                            </span>
                          </div>
                          <div className="flex items-center gap-1">
                            <ShieldCheck
                              size={12}
                              className={insDDay !== null && insDDay <= 30 ? "text-rose-500" : "text-emerald-500"}
                            />
                            <span className="text-[10px] font-bold text-slate-600">{v.insurance_company || "-"}</span>
                          </div>
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex flex-col">
                          <span className="text-xs font-bold text-blue-600">
                            {Number(v.monthly_fee || 0).toLocaleString()}원
                          </span>
                          <span className="text-[10px] text-slate-400">
                            매월 {v.payment_day}일 ({v.payment_method})
                          </span>
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex flex-col">
                          <span className="text-[10px] font-bold text-slate-600">
                            연 {Number(v.annual_contract_mileage || 0).toLocaleString()}km
                          </span>
                          <div className="mt-1.5">
                            {v.requires_log ? (
                              <Badge className="bg-orange-50 text-orange-600 border-orange-100 text-[9px] font-black h-4 px-1.5 uppercase">
                                세무일지 대상
                              </Badge>
                            ) : (
                              <span className="text-[9px] text-slate-300 uppercase italic">수동 관리</span>
                            )}
                          </div>
                        </div>
                      </TableCell>
                      <TableCell className="text-right px-6">
                        <div className="flex justify-end gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <Button
                            variant="ghost"
                            size="icon"
                            className="w-7 h-7 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-all"
                            onClick={() => handleEditClick(v)}
                          >
                            <Edit2 className="w-3.5 h-3.5" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="w-7 h-7 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-all"
                            onClick={() => {
                              setDeleteId(v.id);
                              setIsDeleteDialogOpen(true);
                            }}
                          >
                            <Trash2 className="w-3.5 h-3.5" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  );
                })
              ) : (
                <TableRow>
                  <TableCell colSpan={6} className="h-40 text-center text-slate-300 font-bold">
                    등록된 차량 정보가 없습니다.
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </div>
      </main>

      {/* 등록 및 수정 다이얼로그 */}
      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
        <DialogContent className="sm:max-w-7xl w-[95vw] p-0 overflow-hidden rounded-2xl border-none shadow-2xl">
          <DialogHeader className="p-6 bg-slate-50 border-b">
            <DialogTitle className="text-lg font-black text-slate-900 tracking-tight flex items-center gap-2">
              <CarFront className="w-5 h-5 text-blue-600" />
              {editingId ? "차량 정보 마스터 수정" : "신규 법인 차량 마스터 등록"}
            </DialogTitle>
            <DialogDescription className="text-xs font-bold text-slate-400 uppercase">
              차량 자산 및 계약 마스터 데이터 관리
            </DialogDescription>
          </DialogHeader>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-0 h-[65vh] overflow-y-auto">
            {/* 컬럼 1: 기초 제원 */}
            <div className="p-8 border-r border-slate-100 space-y-6">
              <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-1 flex items-center gap-2">
                <Gauge size={14} /> 01. 기초 제원 및 운행자
              </h4>
              <div className="space-y-4">
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">차량 번호 *</Label>
                  <Input
                    value={formData.vehicle_number}
                    onChange={(e) => setFormData({ ...formData, vehicle_number: e.target.value })}
                    className="h-10 rounded-xl font-bold"
                    placeholder="예: 12가 3456"
                  />
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">모델명</Label>
                  <Input
                    value={formData.model_name}
                    onChange={(e) => setFormData({ ...formData, model_name: e.target.value })}
                    className="h-10 rounded-xl"
                    placeholder="예: 제네시스 G80"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">유종</Label>
                    <Select
                      value={formData.fuel_type}
                      onValueChange={(v) => setFormData({ ...formData, fuel_type: v })}
                    >
                      <SelectTrigger className="h-10 rounded-xl">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {["휘발유", "경유", "LPG", "전기", "하이브리드"].map((f) => (
                          <SelectItem key={f} value={f}>
                            {f}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">초기 적산(km)</Label>
                    <Input
                      type="number"
                      value={formData.initial_mileage}
                      onChange={(e) => setFormData({ ...formData, initial_mileage: Number(e.target.value) })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">전담 운행자</Label>
                  <Select
                    value={formData.primary_driver || "none"}
                    onValueChange={(v) => setFormData({ ...formData, primary_driver: v === "none" ? "" : v })}
                  >
                    <SelectTrigger className="h-10 rounded-xl">
                      <SelectValue placeholder="직원 선택" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">전담자 미지정</SelectItem>
                      {employees.map((e) => (
                        <SelectItem key={e.user_id} value={e.user_id}>
                          {e.profiles.full_name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">차량 용도 구분</Label>
                  <Select
                    value={formData.usage_category}
                    onValueChange={(v) => setFormData({ ...formData, usage_category: v })}
                  >
                    <SelectTrigger className="h-10 rounded-xl">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {["비영업용승용차", "영업용승용차", "승합차", "화물차"].map((u) => (
                        <SelectItem key={u} value={u}>
                          {u}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </div>

            {/* 컬럼 2: 계약 및 금융 */}
            <div className="p-8 border-r border-slate-100 space-y-6">
              <h4 className="text-[10px] font-black text-orange-500 uppercase tracking-widest border-b pb-1 flex items-center gap-2">
                <Building size={14} /> 02. 계약 및 금융 정보
              </h4>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">소유 형태</Label>
                    <Select
                      value={formData.ownership_type}
                      onValueChange={(v) => setFormData({ ...formData, ownership_type: v })}
                    >
                      <SelectTrigger className="h-10 rounded-xl">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {["리스", "렌트", "법인자산", "개인소유"].map((o) => (
                          <SelectItem key={o} value={o}>
                            {o}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">월 이용료(원)</Label>
                    <Input
                      type="number"
                      value={formData.monthly_fee}
                      onChange={(e) => setFormData({ ...formData, monthly_fee: Number(e.target.value) })}
                      className="h-10 rounded-xl font-bold"
                    />
                  </div>
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">계약 업체명</Label>
                  <Input
                    value={formData.vendor_name}
                    onChange={(e) => setFormData({ ...formData, vendor_name: e.target.value })}
                    className="h-10 rounded-xl"
                    placeholder="예: 현대캐피탈"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">담당자</Label>
                    <Input
                      value={formData.contract_manager}
                      onChange={(e) => setFormData({ ...formData, contract_manager: e.target.value })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">연락처</Label>
                    <Input
                      value={formData.contact_number}
                      onChange={(e) => setFormData({ ...formData, contact_number: e.target.value })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">계약 시작일</Label>
                    <Input
                      type="date"
                      value={formData.contract_start_date}
                      onChange={(e) => setFormData({ ...formData, contract_start_date: e.target.value })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">계약 종료일</Label>
                    <Input
                      type="date"
                      value={formData.contract_end_date}
                      onChange={(e) => setFormData({ ...formData, contract_end_date: e.target.value })}
                      className="h-10 rounded-xl font-bold"
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">납부일</Label>
                    <Input
                      type="number"
                      placeholder="일"
                      value={formData.payment_day}
                      onChange={(e) => setFormData({ ...formData, payment_day: Number(e.target.value) })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">결제 수단</Label>
                    <Select
                      value={formData.payment_method}
                      onValueChange={(v) => setFormData({ ...formData, payment_method: v })}
                    >
                      <SelectTrigger className="h-10 rounded-xl">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {["카드 결제", "자동 이체", "가상 계좌"].map((m) => (
                          <SelectItem key={m} value={m}>
                            {m}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>
            </div>

            {/* 컬럼 3: 보험 및 세무 */}
            <div className="p-8 space-y-6">
              <h4 className="text-[10px] font-black text-emerald-600 uppercase tracking-widest border-b pb-1 flex items-center gap-2">
                <ShieldCheck size={14} /> 03. 보험 및 세무 설정
              </h4>
              <div className="space-y-4">
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">보험사명</Label>
                  <Input
                    value={formData.insurance_company}
                    onChange={(e) => setFormData({ ...formData, insurance_company: e.target.value })}
                    className="h-10 rounded-xl"
                    placeholder="예: 삼성화재"
                  />
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">운전자 한정 연령</Label>
                  <Select
                    value={formData.insurance_driver_age}
                    onValueChange={(v) => setFormData({ ...formData, insurance_driver_age: v })}
                  >
                    <SelectTrigger className="h-10 rounded-xl">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {["전연령", "만 21세 이상", "만 26세 이상", "만 30세 이상"].map((a) => (
                        <SelectItem key={a} value={a}>
                          {a}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">보험 시작일</Label>
                    <Input
                      type="date"
                      value={formData.insurance_start_date}
                      onChange={(e) => setFormData({ ...formData, insurance_start_date: e.target.value })}
                      className="h-10 rounded-xl"
                    />
                  </div>
                  <div className="space-y-1.5">
                    <Label className="text-[11px] font-black text-slate-400 uppercase">보험 만료일</Label>
                    <Input
                      type="date"
                      value={formData.insurance_end_date}
                      onChange={(e) => setFormData({ ...formData, insurance_end_date: e.target.value })}
                      className="h-10 rounded-xl font-bold"
                    />
                  </div>
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">연간 약정 거리 (km)</Label>
                  <Input
                    type="number"
                    value={formData.annual_contract_mileage}
                    onChange={(e) => setFormData({ ...formData, annual_contract_mileage: Number(e.target.value) })}
                    className="h-10 rounded-xl"
                  />
                </div>
                <div className="space-y-1.5">
                  <Label className="text-[11px] font-black text-slate-400 uppercase">초과 시 km당 수수료 (원)</Label>
                  <Input
                    type="number"
                    value={formData.excess_mileage_fee}
                    onChange={(e) => setFormData({ ...formData, excess_mileage_fee: Number(e.target.value) })}
                    className="h-10 rounded-xl"
                  />
                </div>

                <div className="flex items-center justify-between p-5 bg-[#F8FAFC] rounded-2xl border border-slate-100">
                  <div className="space-y-0.5">
                    <Label className="text-sm font-bold">운행일지 작성 대상</Label>
                    <p className="text-[10px] text-slate-400 uppercase font-black tracking-tighter">
                      세무 신고용 기록 필수
                    </p>
                  </div>
                  <Switch
                    checked={formData.requires_log}
                    onCheckedChange={(val) => setFormData({ ...formData, requires_log: val })}
                  />
                </div>
              </div>
            </div>
          </div>

          <DialogFooter className="p-6 border-t bg-white">
            <div className="flex gap-2 w-full">
              <Button
                variant="ghost"
                onClick={() => setIsAddDialogOpen(false)}
                className="flex-1 font-bold text-slate-400"
              >
                취소
              </Button>
              <Button
                onClick={handleSave}
                disabled={isSaving}
                className="flex-[2] bg-blue-600 font-bold h-11 rounded-xl shadow-lg shadow-blue-100"
              >
                {isSaving ? <Loader2 className="animate-spin mr-2" /> : "마스터 정보 저장 완료"}
              </Button>
            </div>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* 삭제 확인 AlertDialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent className="rounded-2xl border-none p-8">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-rose-600 font-black flex items-center gap-2 text-xl">
              <AlertCircle className="w-5 h-5" /> 법인 자산 삭제 확정
            </AlertDialogTitle>
            <AlertDialogDescription className="py-4 font-bold text-slate-500 leading-relaxed italic">
              이 차량의 모든 데이터와 운행 기록 정보가 시스템에서 영구 삭제됩니다. 삭제하시겠습니까?
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="flex gap-2">
            <AlertDialogCancel className="flex-1 rounded-xl font-bold border-slate-200">취소</AlertDialogCancel>
            <AlertDialogAction
              onClick={async () => {
                await supabase.from("vehicles").delete().eq("id", deleteId);
                toast.success("삭제되었습니다.");
                fetchVehicles();
                setIsDeleteDialogOpen(false);
              }}
              className="flex-1 bg-rose-600 hover:bg-rose-700 rounded-xl font-bold"
            >
              삭제 확정
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default VehicleManagement;



============================================================
File Path: src/pages/admin/WorkRuleManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from "@/components/ui/separator";
import {
  ArrowLeft, Plus, Save, Loader2, Trash2, Clock,
  Download, PenTool, AlertTriangle, ShieldCheck,
} from "lucide-react";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "sonner";

interface WorkRule {
  id: string;
  name: string;
  work_days: string[];
  standard_work_unit: string;
  standard_work_hours: number;
  overtime_min_unit: string;
  overtime_min_hours: number;
  overtime_max_unit: string;
  overtime_max_hours: number;
  standard_period: string;
  standard_period_start_day: number | null;
  standard_include_holidays: boolean;
  max_work_unit: string;
  max_work_hours: number;
  max_period: string;
  max_period_start_day: number | null;
  max_include_holidays: boolean;
  is_default: boolean;
  is_active: boolean;
  description: string | null;
  created_at: string;
}

const ALL_DAYS = ["월", "화", "수", "목", "금", "토", "일"];
const UNITS = ["1일", "1주", "1개월"];
const PERIODS = ["1주", "2주", "1개월", "3개월", "6개월", "1년"];

const WorkRuleManagement = () => {
  const navigate = useNavigate();
  const { user, currentTenant } = useAuth();
  const [rules, setRules] = useState<WorkRule[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [loadingDefaults, setLoadingDefaults] = useState(false);
  const [editingRule, setEditingRule] = useState<Partial<WorkRule> | null>(null);
  const [isNew, setIsNew] = useState(false);

  const tenantId = currentTenant?.tenant_id;

  const fetchRules = async () => {
    if (!tenantId) return;
    setLoading(true);
    const { data, error } = await supabase
      .from("work_rules")
      .select("*")
      .eq("tenant_id", tenantId)
      .order("created_at", { ascending: false });
    if (data) setRules(data as unknown as WorkRule[]);
    if (error) toast.error("불러오기 실패: " + error.message);
    setLoading(false);
  };

  useEffect(() => { fetchRules(); }, [tenantId]);

  const loadSystemDefaults = async () => {
    if (!tenantId) return;
    setLoadingDefaults(true);
    try {
      const { data: defaults, error } = await supabase
        .from("work_rules")
        .select("*")
        .is("tenant_id", null)
        .eq("is_active", true)
        .order("is_default", { ascending: false });

      if (error) throw error;
      if (!defaults || defaults.length === 0) {
        toast.info("등록된 시스템 기본 근로규칙이 없습니다.");
        return;
      }

      // Insert copies for this tenant
      const inserts = defaults.map((d: any) => ({
        tenant_id: tenantId,
        name: d.name,
        work_days: d.work_days,
        standard_work_unit: d.standard_work_unit,
        standard_work_hours: d.standard_work_hours,
        overtime_min_unit: d.overtime_min_unit,
        overtime_min_hours: d.overtime_min_hours,
        overtime_max_unit: d.overtime_max_unit,
        overtime_max_hours: d.overtime_max_hours,
        standard_period: d.standard_period,
        standard_period_start_day: d.standard_period_start_day,
        standard_include_holidays: d.standard_include_holidays,
        max_work_unit: d.max_work_unit,
        max_work_hours: d.max_work_hours,
        max_period: d.max_period,
        max_period_start_day: d.max_period_start_day,
        max_include_holidays: d.max_include_holidays,
        is_default: d.is_default,
        is_active: true,
        description: d.description,
        created_by: user?.id,
      }));

      const { error: insertError } = await supabase.from("work_rules").insert(inserts as any);
      if (insertError) throw insertError;

      toast.success(`${defaults.length}개의 기본 근로규칙을 불러왔습니다.`);
      fetchRules();
    } catch (e: any) {
      toast.error("불러오기 실패: " + e.message);
    } finally {
      setLoadingDefaults(false);
    }
  };

  const openNew = () => {
    setIsNew(true);
    setEditingRule({
      name: "",
      work_days: ["월", "화", "수", "목", "금"],
      standard_work_unit: "1주",
      standard_work_hours: 40,
      overtime_min_unit: "1주",
      overtime_min_hours: 0,
      overtime_max_unit: "1주",
      overtime_max_hours: 12,
      standard_period: "1주",
      standard_period_start_day: 1,
      standard_include_holidays: false,
      max_work_unit: "1주",
      max_work_hours: 52,
      max_period: "1주",
      max_period_start_day: 1,
      max_include_holidays: false,
      is_default: false,
      is_active: true,
      description: "",
    });
  };

  const openEdit = (rule: WorkRule) => {
    setIsNew(false);
    setEditingRule({ ...rule });
  };

  const saveRule = async () => {
    if (!editingRule?.name || !tenantId) { toast.error("규칙명을 입력해주세요."); return; }
    setSaving(true);
    try {
      const payload = {
        tenant_id: tenantId,
        name: editingRule.name,
        work_days: editingRule.work_days || ["월", "화", "수", "목", "금"],
        standard_work_unit: editingRule.standard_work_unit || "1주",
        standard_work_hours: editingRule.standard_work_hours || 40,
        overtime_min_unit: editingRule.overtime_min_unit || "1주",
        overtime_min_hours: editingRule.overtime_min_hours || 0,
        overtime_max_unit: editingRule.overtime_max_unit || "1주",
        overtime_max_hours: editingRule.overtime_max_hours || 12,
        standard_period: editingRule.standard_period || "1주",
        standard_period_start_day: editingRule.standard_period_start_day,
        standard_include_holidays: editingRule.standard_include_holidays || false,
        max_work_unit: editingRule.max_work_unit || "1주",
        max_work_hours: editingRule.max_work_hours || 52,
        max_period: editingRule.max_period || "1주",
        max_period_start_day: editingRule.max_period_start_day,
        max_include_holidays: editingRule.max_include_holidays || false,
        is_default: editingRule.is_default || false,
        is_active: editingRule.is_active !== false,
        description: editingRule.description || null,
        created_by: user?.id,
      };

      if (isNew) {
        const { error } = await supabase.from("work_rules").insert(payload as any);
        if (error) throw error;
        toast.success("근로규칙이 등록되었습니다.");
      } else {
        const { error } = await supabase.from("work_rules").update(payload as any).eq("id", editingRule.id!);
        if (error) throw error;
        toast.success("근로규칙이 수정되었습니다.");
      }
      setEditingRule(null);
      fetchRules();
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const deleteRule = async (id: string) => {
    if (!confirm("이 근로규칙을 삭제하시겠습니까?")) return;
    const { error } = await supabase.from("work_rules").delete().eq("id", id);
    if (error) toast.error("삭제 실패: " + error.message);
    else { toast.success("삭제되었습니다."); fetchRules(); }
  };

  const toggleDay = (day: string) => {
    if (!editingRule) return;
    const days = editingRule.work_days || [];
    setEditingRule({
      ...editingRule,
      work_days: days.includes(day) ? days.filter(d => d !== day) : [...days, day],
    });
  };

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-24 pb-16 px-4 max-w-5xl mx-auto space-y-6">
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div>
            <Button variant="ghost" size="sm" className="gap-1 mb-2" onClick={() => navigate("/admin")}>
              <ArrowLeft className="w-4 h-4" /> 관리 시스템
            </Button>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Clock className="w-6 h-6 text-primary" /> 근로규칙 관리
            </h1>
            <p className="text-muted-foreground text-sm mt-1">
              소정근로규칙 및 최대근로규칙을 설정하여 근무시간 관리 기준을 정의합니다.
            </p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={loadSystemDefaults} disabled={loadingDefaults} className="gap-1.5">
              {loadingDefaults ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />}
              초기 셋팅값 불러오기
            </Button>
            <Button onClick={openNew} className="gap-1.5">
              <Plus className="w-4 h-4" /> 근로규칙 추가
            </Button>
          </div>
        </div>

        {/* 편집 폼 */}
        {editingRule && (
          <Card className="border-2 border-primary/20 shadow-lg">
            <CardHeader>
              <CardTitle className="text-base flex items-center gap-2">
                <PenTool className="w-4 h-4 text-primary" />
                {isNew ? "새 근로규칙 등록" : "근로규칙 수정"}
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label className="text-xs font-semibold">규칙명 *</Label>
                  <Input
                    value={editingRule.name || ""}
                    onChange={e => setEditingRule({ ...editingRule, name: e.target.value })}
                    placeholder="예: 주 52시간제"
                    className="mt-1"
                  />
                </div>
                <div>
                  <Label className="text-xs font-semibold">설명</Label>
                  <Input
                    value={editingRule.description || ""}
                    onChange={e => setEditingRule({ ...editingRule, description: e.target.value })}
                    placeholder="규칙 설명"
                    className="mt-1"
                  />
                </div>
              </div>

              {/* 소정근로요일 */}
              <div>
                <Label className="text-xs font-semibold mb-2 block">소정근로요일</Label>
                <div className="flex gap-2">
                  {ALL_DAYS.map(day => (
                    <button
                      key={day}
                      onClick={() => toggleDay(day)}
                      className={`w-10 h-10 rounded-lg text-sm font-bold transition-all ${
                        (editingRule.work_days || []).includes(day)
                          ? "bg-primary text-primary-foreground shadow-sm"
                          : "bg-muted text-muted-foreground hover:bg-muted/80"
                      }`}
                    >
                      {day}
                    </button>
                  ))}
                </div>
              </div>

              <Separator />

              {/* 소정근로규칙 */}
              <div>
                <h4 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <Clock className="w-4 h-4 text-blue-500" /> 소정근로규칙
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <Label className="text-xs">소정근로 단위</Label>
                    <Select value={editingRule.standard_work_unit} onValueChange={v => setEditingRule({ ...editingRule, standard_work_unit: v })}>
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label className="text-xs">소정근로시간</Label>
                    <Input type="number" value={editingRule.standard_work_hours ?? 40} onChange={e => setEditingRule({ ...editingRule, standard_work_hours: Number(e.target.value) })} className="mt-1" />
                  </div>
                  <div>
                    <Label className="text-xs">연장근로 최소기준</Label>
                    <div className="flex gap-1 mt-1">
                      <Select value={editingRule.overtime_min_unit} onValueChange={v => setEditingRule({ ...editingRule, overtime_min_unit: v })}>
                        <SelectTrigger className="w-20"><SelectValue /></SelectTrigger>
                        <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                      </Select>
                      <Input type="number" value={editingRule.overtime_min_hours ?? 0} onChange={e => setEditingRule({ ...editingRule, overtime_min_hours: Number(e.target.value) })} className="flex-1" />
                    </div>
                  </div>
                  <div>
                    <Label className="text-xs">연장근로 최대기준</Label>
                    <div className="flex gap-1 mt-1">
                      <Select value={editingRule.overtime_max_unit} onValueChange={v => setEditingRule({ ...editingRule, overtime_max_unit: v })}>
                        <SelectTrigger className="w-20"><SelectValue /></SelectTrigger>
                        <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                      </Select>
                      <Input type="number" value={editingRule.overtime_max_hours ?? 12} onChange={e => setEditingRule({ ...editingRule, overtime_max_hours: Number(e.target.value) })} className="flex-1" />
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
                  <div>
                    <Label className="text-xs">단위기간</Label>
                    <Select value={editingRule.standard_period} onValueChange={v => setEditingRule({ ...editingRule, standard_period: v })}>
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{PERIODS.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div className="flex items-end gap-2 pb-1">
                    <Switch checked={editingRule.standard_include_holidays} onCheckedChange={v => setEditingRule({ ...editingRule, standard_include_holidays: v })} />
                    <Label className="text-xs">휴일 포함</Label>
                  </div>
                </div>
              </div>

              <Separator />

              {/* 최대근로규칙 */}
              <div>
                <h4 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <AlertTriangle className="w-4 h-4 text-amber-500" /> 최대근로규칙
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <Label className="text-xs">최대근로 단위</Label>
                    <Select value={editingRule.max_work_unit} onValueChange={v => setEditingRule({ ...editingRule, max_work_unit: v })}>
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label className="text-xs">최대근로시간</Label>
                    <Input type="number" value={editingRule.max_work_hours ?? 52} onChange={e => setEditingRule({ ...editingRule, max_work_hours: Number(e.target.value) })} className="mt-1" />
                  </div>
                  <div>
                    <Label className="text-xs">단위기간</Label>
                    <Select value={editingRule.max_period} onValueChange={v => setEditingRule({ ...editingRule, max_period: v })}>
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{PERIODS.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div className="flex items-end gap-2 pb-1">
                    <Switch checked={editingRule.max_include_holidays} onCheckedChange={v => setEditingRule({ ...editingRule, max_include_holidays: v })} />
                    <Label className="text-xs">휴일 포함</Label>
                  </div>
                </div>
              </div>

              <Separator />

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-2">
                    <Switch checked={editingRule.is_default} onCheckedChange={v => setEditingRule({ ...editingRule, is_default: v })} />
                    <Label className="text-xs">기본 규칙</Label>
                  </div>
                  <div className="flex items-center gap-2">
                    <Switch checked={editingRule.is_active !== false} onCheckedChange={v => setEditingRule({ ...editingRule, is_active: v })} />
                    <Label className="text-xs">활성화</Label>
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button variant="ghost" size="sm" onClick={() => setEditingRule(null)}>취소</Button>
                  <Button size="sm" onClick={saveRule} disabled={saving}>
                    {saving ? <Loader2 className="w-4 h-4 animate-spin mr-1" /> : <Save className="w-4 h-4 mr-1" />}
                    저장
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* 규칙 목록 */}
        {loading ? (
          <div className="flex justify-center py-12"><Loader2 className="w-6 h-6 animate-spin text-muted-foreground" /></div>
        ) : rules.length === 0 ? (
          <Card className="border-dashed">
            <CardContent className="py-12 text-center text-muted-foreground">
              <Clock className="w-10 h-10 mx-auto mb-3 opacity-30" />
              <p className="text-sm">등록된 근로규칙이 없습니다.</p>
              <p className="text-xs mt-1">"초기 셋팅값 불러오기"로 시스템 기본값을 가져오거나 직접 추가하세요.</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-3">
            {rules.map(rule => (
              <Card key={rule.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-5">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className="font-bold text-sm">{rule.name}</h3>
                        {rule.is_default && <Badge variant="default" className="text-[10px]">기본값</Badge>}
                        <Badge variant={rule.is_active ? "secondary" : "outline"} className="text-[10px]">
                          {rule.is_active ? "활성" : "비활성"}
                        </Badge>
                      </div>
                      {rule.description && <p className="text-xs text-muted-foreground mb-3">{rule.description}</p>}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                        <div className="bg-blue-50 rounded-lg p-2.5">
                          <p className="text-blue-400 font-medium mb-0.5">소정근로</p>
                          <p className="font-bold text-blue-700">{rule.standard_work_unit} {rule.standard_work_hours}시간</p>
                        </div>
                        <div className="bg-amber-50 rounded-lg p-2.5">
                          <p className="text-amber-400 font-medium mb-0.5">연장근로</p>
                          <p className="font-bold text-amber-700">최소 {rule.overtime_min_hours}h / 최대 {rule.overtime_max_hours}h</p>
                        </div>
                        <div className="bg-red-50 rounded-lg p-2.5">
                          <p className="text-red-400 font-medium mb-0.5">최대근로</p>
                          <p className="font-bold text-red-700">{rule.max_work_unit} {rule.max_work_hours}시간</p>
                        </div>
                        <div className="bg-slate-50 rounded-lg p-2.5">
                          <p className="text-slate-400 font-medium mb-0.5">소정근로요일</p>
                          <p className="font-bold text-slate-700">{(rule.work_days || []).join(", ")}</p>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-1 ml-4">
                      <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openEdit(rule)}>
                        <PenTool className="w-3.5 h-3.5" />
                      </Button>
                      <Button variant="ghost" size="icon" className="h-8 w-8 text-destructive" onClick={() => deleteRule(rule.id)}>
                        <Trash2 className="w-3.5 h-3.5" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </main>
    </div>
  );
};

export default WorkRuleManagement;



============================================================
File Path: src/pages/finance/BankTransactions.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Landmark, RefreshCw, Search, ArrowUpCircle, ArrowDownCircle, 
  Wallet, Settings, HardDrive, Zap, FileText,
} from "lucide-react";
import { format, subDays } from "date-fns";
import { toast } from "sonner";

interface FinanceAccount {
  id: string;
  connected_id_key: string;
  business_type: string;
  organization: string;
  account_number: string | null;
  account_alias: string | null;
}

const BANK_NAMES: Record<string, string> = {
  "0002": "산업은행", "0003": "기업은행", "0004": "국민은행", "0007": "수협은행",
  "0011": "농협은행", "0020": "우리은행", "0023": "SC제일은행", "0027": "씨티은행",
  "0031": "대구은행", "0032": "부산은행", "0034": "광주은행", "0035": "제주은행",
  "0037": "전북은행", "0039": "경남은행", "0045": "새마을금고", "0048": "신협은행",
  "0071": "우체국", "0081": "하나은행", "0088": "신한은행", "0089": "K뱅크",
};

const BankTransactions = () => {
  const navigate = useNavigate();
  const { currentTenant } = useAuth();
  const [loading, setLoading] = useState(false);
  const [transactions, setTransactions] = useState<any[]>([]);
  const [accounts, setAccounts] = useState<FinanceAccount[]>([]);
  const [connectedIdMap, setConnectedIdMap] = useState<Record<string, string>>({});
  const [selectedAccountId, setSelectedAccountId] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [dataSource, setDataSource] = useState<"drive" | "realtime">("drive");
  const [driveFiles, setDriveFiles] = useState<any[]>([]);
  const [hasDriveMapping, setHasDriveMapping] = useState(false);

  const today = new Date();
  const [startDate, setStartDate] = useState(format(subDays(today, 30), "yyyy-MM-dd"));
  const [endDate, setEndDate] = useState(format(today, "yyyy-MM-dd"));

  useEffect(() => {
    if (!currentTenant) return;
    const load = async () => {
      const [accRes, configRes, mappingRes] = await Promise.all([
        supabase.from("finance_accounts").select("*")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("business_type", "BK").eq("is_active", true),
        supabase.from("tenant_api_configs").select("config_key, config_value")
          .eq("tenant_id", currentTenant.tenant_id)
          .like("config_key", "CONNECTED_ID_BK_%"),
        supabase.from("drive_folder_mappings").select("id")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("folder_key", "bank_transactions")
          .eq("is_active", true),
      ]);

      const accs = (accRes.data || []) as FinanceAccount[];
      setAccounts(accs);
      setHasDriveMapping((mappingRes.data || []).length > 0);

      const idMap: Record<string, string> = {};
      (configRes.data || []).forEach((c: any) => { idMap[c.config_key] = c.config_value; });
      setConnectedIdMap(idMap);

      if (accs.length > 0) setSelectedAccountId(accs[0].id);
    };
    load();
  }, [currentTenant]);

  // Fetch from Drive CSV files
  const fetchFromDrive = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke("read-drive-csv", {
        body: {
          tenantId: currentTenant?.tenant_id,
          folderKey: "bank_transactions",
          dateRange: {
            startDate: startDate,
            endDate: endDate,
          },
        },
      });

      if (error) throw error;
      if (data?.error) throw new Error(data.error);

      setDriveFiles(data.files || []);

      // Map CSV rows to transaction-like format
      const rows = (data.data || []).map((row: any) => ({
        resAccountTrDate: row["거래일"] || "",
        resAccountTrTime: row["거래시간"] || "",
        resAccountIn: row["입금"] || "0",
        resAccountOut: row["출금"] || "0",
        resAfterTranBalance: row["거래후잔액"] || "0",
        resAccountDesc1: row["적요1"] || "",
        resAccountDesc2: row["적요2"] || "",
        resAccountDesc3: row["적요3"] || "",
        _fileName: row["_fileName"] || "",
        _accountNumber: row["계좌번호"] || "",
        _accountName: row["계좌명"] || "",
      }));

      setTransactions(rows);
      if (rows.length === 0) toast.info("해당 기간 Drive 데이터가 없습니다.");
      else toast.success(`Drive에서 ${rows.length}건 로드 (${data.files?.length || 0}개 파일)`);

    } catch (e: any) {
      toast.error("Drive 조회 실패: " + e.message);
      setTransactions([]);
    } finally {
      setLoading(false);
    }
  };

  // Fetch realtime from CODEF
  const fetchRealtime = async () => {
    const account = accounts.find((a) => a.id === selectedAccountId);
    if (!account) return toast.error("조회할 계좌를 선택하세요.");

    const connectedId = connectedIdMap[account.connected_id_key];
    if (!connectedId) return toast.error("Connected ID를 찾을 수 없습니다.");

    setLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke("codef-api", {
        body: {
          action: "transaction_list",
          tenantId: currentTenant?.tenant_id,
          connectedId,
          organization: account.organization,
          account: account.account_number || "",
          startDate: startDate.replace(/-/g, ""),
          endDate: endDate.replace(/-/g, ""),
          orderBy: "0",
        },
      });
      if (error) throw error;
      if (data?.result?.code === "CF-00000") {
        const list = Array.isArray(data.data) ? data.data : (data.data?.resTrHistoryList || []);
        setTransactions(list);
        if (list.length === 0) toast.info("해당 기간 거래내역이 없습니다.");
      } else {
        throw new Error(data?.result?.message || "조회 실패");
      }
    } catch (e: any) {
      toast.error("실시간 조회 실패: " + e.message);
      setTransactions([]);
    } finally {
      setLoading(false);
    }
  };

  const handleFetch = () => {
    if (dataSource === "drive") fetchFromDrive();
    else fetchRealtime();
  };

  const formatCurrency = (val: string | number) => {
    const num = typeof val === "string" ? parseInt(val, 10) : val;
    if (isNaN(num) || num === 0) return "-";
    return new Intl.NumberFormat("ko-KR").format(num) + "원";
  };

  const totalIn = transactions.reduce((sum, t) => sum + (parseInt(t.resAccountIn || "0", 10)), 0);
  const totalOut = transactions.reduce((sum, t) => sum + (parseInt(t.resAccountOut || "0", 10)), 0);
  const lastBalance = transactions.length > 0 ? parseInt(transactions[0].resAfterTranBalance || "0", 10) : 0;

  const filtered = transactions.filter((t) => {
    if (!searchTerm) return true;
    const desc = [t.resAccountDesc1, t.resAccountDesc2, t.resAccountDesc3].filter(Boolean).join(" ");
    return desc.includes(searchTerm);
  });

  return (
    <div className="p-8 md:p-12 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div className="flex items-center gap-3">
          <div className="p-2.5 rounded-2xl bg-amber-500 text-white shadow-lg shadow-amber-200">
            <Landmark className="w-6 h-6" />
          </div>
          <div>
            <h1 className="text-2xl font-black text-foreground tracking-tight">거래내역조회 (통장)</h1>
            <p className="text-sm text-muted-foreground font-medium">
              {dataSource === "drive" ? "Google Drive CSV에서 조회" : "CODEF 실시간 조회"}
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => navigate("/admin/drive-settings")} className="gap-2">
            <Settings className="w-4 h-4" /> 저장소 설정
          </Button>
          <Button onClick={handleFetch} disabled={loading} className="gap-2">
            <RefreshCw className={loading ? "animate-spin w-4 h-4" : "w-4 h-4"} /> 조회
          </Button>
        </div>
      </div>

      {/* Data source selector */}
      <Card className="border-none shadow-sm">
        <CardContent className="p-4 space-y-4">
          <Tabs value={dataSource} onValueChange={(v) => setDataSource(v as "drive" | "realtime")}>
            <TabsList className="w-full grid grid-cols-2">
              <TabsTrigger value="drive" className="gap-2">
                <HardDrive className="w-4 h-4" /> Drive (저장된 데이터)
              </TabsTrigger>
              <TabsTrigger value="realtime" className="gap-2">
                <Zap className="w-4 h-4" /> 실시간 (CODEF)
              </TabsTrigger>
            </TabsList>
          </Tabs>

          <div className="flex flex-wrap gap-4 items-end">
            {dataSource === "realtime" && (
              <div className="flex-1 min-w-[200px] space-y-1">
                <label className="text-xs font-bold text-muted-foreground">계좌 선택</label>
                <Select value={selectedAccountId} onValueChange={setSelectedAccountId}>
                  <SelectTrigger><SelectValue placeholder="계좌를 선택하세요" /></SelectTrigger>
                  <SelectContent>
                    {accounts.map((a) => (
                      <SelectItem key={a.id} value={a.id}>
                        {BANK_NAMES[a.organization] || a.organization} - {a.account_alias || a.account_number || "전체"}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            )}
            <div className="space-y-1">
              <label className="text-xs font-bold text-muted-foreground">시작일</label>
              <Input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-40" />
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-muted-foreground">종료일</label>
              <Input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-40" />
            </div>
            <div className="relative flex-1 min-w-[180px]">
              <Search className="absolute left-3 top-2.5 w-4 h-4 text-muted-foreground" />
              <Input placeholder="적요 검색..." className="pl-9" value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)} />
            </div>
          </div>

          {/* Drive mapping warning */}
          {dataSource === "drive" && !hasDriveMapping && (
            <div className="p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-800 text-sm flex items-center gap-2">
              <FileText className="w-4 h-4 flex-shrink-0" />
              <span>
                은행 거래내역 Drive 폴더가 미설정입니다. 
                <Button variant="link" className="text-amber-800 underline h-auto p-0 ml-1"
                  onClick={() => navigate("/admin/drive-settings")}>
                  저장소 설정
                </Button>에서 'bank_transactions' 폴더를 등록하세요.
              </span>
            </div>
          )}

          {/* Drive file info */}
          {dataSource === "drive" && driveFiles.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {driveFiles.map((f, i) => (
                <Badge key={i} variant="secondary" className="text-xs font-mono">
                  📄 {f.name}
                </Badge>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Summary cards */}
      {transactions.length > 0 && (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card className="border-none shadow-md">
            <CardContent className="p-6 flex items-center gap-4">
              <div className="p-3 rounded-xl bg-blue-50 text-blue-600"><Wallet /></div>
              <div>
                <p className="text-xs font-bold text-muted-foreground uppercase">최근 잔액</p>
                <p className="text-2xl font-black text-foreground">{formatCurrency(lastBalance)}</p>
              </div>
            </CardContent>
          </Card>
          <Card className="border-none shadow-md">
            <CardContent className="p-6 flex items-center gap-4">
              <div className="p-3 rounded-xl bg-emerald-50 text-emerald-600"><ArrowUpCircle /></div>
              <div>
                <p className="text-xs font-bold text-muted-foreground uppercase">기간 입금</p>
                <p className="text-2xl font-black text-emerald-600">+ {formatCurrency(totalIn)}</p>
              </div>
            </CardContent>
          </Card>
          <Card className="border-none shadow-md">
            <CardContent className="p-6 flex items-center gap-4">
              <div className="p-3 rounded-xl bg-rose-50 text-rose-600"><ArrowDownCircle /></div>
              <div>
                <p className="text-xs font-bold text-muted-foreground uppercase">기간 출금</p>
                <p className="text-2xl font-black text-rose-600">- {formatCurrency(totalOut)}</p>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Empty state */}
      {accounts.length === 0 && !loading && dataSource === "realtime" && (
        <Card className="border-none shadow-md">
          <CardContent className="p-12 text-center space-y-3">
            <Landmark className="w-12 h-12 text-muted-foreground mx-auto" />
            <p className="text-lg font-bold text-foreground">등록된 계좌가 없습니다</p>
            <p className="text-sm text-muted-foreground">금융 연동 설정에서 계좌를 등록해주세요.</p>
            <Button onClick={() => navigate("/admin/finance-settings")} className="mt-2">금융 연동 설정</Button>
          </CardContent>
        </Card>
      )}

      {/* Table */}
      {(transactions.length > 0 || loading) && (
        <Card className="border-none shadow-lg rounded-2xl overflow-hidden">
          <Table>
            <TableHeader className="bg-muted/50">
              <TableRow>
                <TableHead className="w-32">거래일시</TableHead>
                <TableHead>적요</TableHead>
                <TableHead className="text-right">입금</TableHead>
                <TableHead className="text-right">출금</TableHead>
                <TableHead className="text-right">잔액</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={5} className="h-40 text-center text-muted-foreground">
                    <RefreshCw className="animate-spin w-6 h-6 mx-auto mb-2" />
                    {dataSource === "drive" ? "Drive에서 데이터를 불러오는 중..." : "거래내역을 조회 중..."}
                  </TableCell>
                </TableRow>
              ) : filtered.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={5} className="h-40 text-center text-muted-foreground">
                    거래내역이 없습니다.
                  </TableCell>
                </TableRow>
              ) : filtered.map((t, idx) => {
                const inAmt = parseInt(t.resAccountIn || "0", 10);
                const outAmt = parseInt(t.resAccountOut || "0", 10);
                return (
                  <TableRow key={idx} className="hover:bg-muted/30">
                    <TableCell className="text-xs text-muted-foreground font-mono">
                      {t.resAccountTrDate || ""} {t.resAccountTrTime || ""}
                    </TableCell>
                    <TableCell className="font-bold text-foreground">
                      {[t.resAccountDesc2, t.resAccountDesc3].filter(Boolean).join(" / ") || t.resAccountDesc1 || "-"}
                    </TableCell>
                    <TableCell className="text-right font-bold text-blue-600">
                      {inAmt > 0 ? `+ ${formatCurrency(inAmt)}` : "-"}
                    </TableCell>
                    <TableCell className="text-right font-bold text-rose-600">
                      {outAmt > 0 ? `- ${formatCurrency(outAmt)}` : "-"}
                    </TableCell>
                    <TableCell className="text-right font-medium text-muted-foreground">
                      {formatCurrency(t.resAfterTranBalance || "0")}
                    </TableCell>
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </Card>
      )}
    </div>
  );
};

export default BankTransactions;



============================================================
File Path: src/pages/finance/CardHistory.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "@/hooks/useAuth";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { 
  CreditCard, ArrowLeft, RefreshCw, FileCheck2, 
  Receipt, ShoppingBag, Utensils, Car, MoreHorizontal 
} from "lucide-react";
import { toast } from "sonner";

const CardHistory = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [history, setHistory] = useState<any[]>([]);

  const mockCards = [
    { id: 1, date: "2024-02-17 12:30", merchant: "쿠팡(Coupang)", category: "소모품", amount: 45000, card: "신한 1234", status: "pending" },
    { id: 2, date: "2024-02-17 13:00", merchant: "본가정육식당", category: "식대", amount: 88000, card: "신한 1234", status: "approved" },
    { id: 3, date: "2024-02-16 18:45", merchant: "카카오택시", category: "교통비", amount: 12400, card: "국민 5678", status: "pending" },
  ];

  useEffect(() => {
    setTimeout(() => {
      setHistory(mockCards);
      setLoading(false);
    }, 800);
  }, []);

  const getStatusBadge = (status: string) => {
    if (status === "approved") return <Badge className="bg-emerald-500">정산완료</Badge>;
    return <Badge variant="outline" className="text-rose-500 border-rose-200 bg-rose-50">미정산</Badge>;
  };

  return (
    <div className="p-8 md:p-12 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2.5 rounded-2xl bg-blue-600 text-white shadow-lg shadow-blue-200">
            <CreditCard className="w-6 h-6" />
          </div>
          <div>
            <h1 className="text-2xl font-black text-slate-900 tracking-tight">법인카드 사용내역</h1>
            <p className="text-sm text-slate-500 font-medium">실시간 카드 승인 내역을 확인하고 지출 결의를 진행합니다.</p>
          </div>
        </div>
        <Button onClick={() => setLoading(true)} variant="outline" className="gap-2">
          <RefreshCw className={loading ? "animate-spin w-4 h-4" : "w-4 h-4"} /> 내역 가져오기
        </Button>
      </div>

      {/* 대시보드 위젯 */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card className="border-none shadow-sm bg-blue-600 text-white">
          <CardContent className="p-6">
            <p className="text-xs font-bold opacity-70 uppercase">이번 달 총 사용액</p>
            <p className="text-2xl font-black mt-1">4,250,000원</p>
          </CardContent>
        </Card>
        <Card className="border-none shadow-sm bg-white">
          <CardContent className="p-6">
            <p className="text-xs font-bold text-slate-400 uppercase">미정산 내역</p>
            <p className="text-2xl font-black text-rose-500 mt-1">12건</p>
          </CardContent>
        </Card>
        <Card className="border-none shadow-sm bg-white">
          <CardContent className="p-6">
            <p className="text-xs font-bold text-slate-400 uppercase">가장 많이 쓴 카테고리</p>
            <p className="text-xl font-black text-slate-800 mt-1 flex items-center gap-2"><Utensils size={18}/> 식대</p>
          </CardContent>
        </Card>
        <Card className="border-none shadow-sm bg-white">
          <CardContent className="p-6">
            <p className="text-xs font-bold text-slate-400 uppercase">사용 인원</p>
            <p className="text-2xl font-black text-slate-800 mt-1">8명</p>
          </CardContent>
        </Card>
      </div>

      {/* 내역 리스트 */}
      <Card className="border-none shadow-lg bg-white rounded-2xl overflow-hidden">
        <Table>
          <TableHeader className="bg-slate-50">
            <TableRow>
              <TableHead>승인일시</TableHead>
              <TableHead>가맹점명</TableHead>
              <TableHead>사용카드</TableHead>
              <TableHead>금액</TableHead>
              <TableHead>상태</TableHead>
              <TableHead className="text-right">액션</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {loading ? (
              <TableRow><TableCell colSpan={6} className="h-40 text-center">데이터 로딩 중...</TableCell></TableRow>
            ) : (
              history.map((h) => (
                <TableRow key={h.id}>
                  <TableCell className="text-xs font-mono text-slate-500">{h.date}</TableCell>
                  <TableCell>
                    <div className="flex flex-col">
                      <span className="font-bold text-slate-800">{h.merchant}</span>
                      <span className="text-[10px] text-blue-500 font-bold uppercase">{h.category}</span>
                    </div>
                  </TableCell>
                  <TableCell className="text-sm">{h.card}</TableCell>
                  <TableCell className="font-black text-slate-900">{h.amount.toLocaleString()}원</TableCell>
                  <TableCell>{getStatusBadge(h.status)}</TableCell>
                  <TableCell className="text-right">
                    {h.status === "pending" ? (
                      <Button size="sm" className="bg-blue-600 gap-1.5 h-8 text-xs font-bold">
                        <FileCheck2 size={14} /> 결의서 작성
                      </Button>
                    ) : (
                      <Button size="sm" variant="ghost" className="h-8 text-xs text-slate-400">
                        상세보기
                      </Button>
                    )}
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </Card>
    </div>
  );
};

export default CardHistory;


============================================================
File Path: src/pages/finance/MyCardExpenses.tsx
============================================================
// File Path: src/pages/finance/MyCardExpenses.tsx

import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { 
  CreditCard, Calendar, ArrowLeft, Receipt, Store, 
  TrendingUp, AlertCircle, Loader2, Download 
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { format } from "date-fns";
import { ko } from "date-fns/locale";
import { Progress } from "@/components/ui/progress";
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from "@/components/ui/table";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";

interface MyCard {
  id: string;
  card_number: string;
  card_name: string | null;
  card_company: string | null;
  monthly_limit: number | null;
  expiry_date: string | null;
}

interface Transaction {
  id: string;
  transaction_date: string;
  merchant_name: string | null;
  amount: number;
  category: string | null;
  status: string | null;
  receipt_url: string | null;
  memo: string | null;
}

const MyCardExpenses = () => {
  const { user, currentTenant } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [cards, setCards] = useState<MyCard[]>([]);
  const [selectedCardId, setSelectedCardId] = useState<string>("");
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [currentMonthSpend, setCurrentMonthSpend] = useState(0);

  // 1. 내 카드 목록 불러오기
  useEffect(() => {
    const fetchMyCards = async () => {
      if (!user || !currentTenant) return;
      
      try {
        const { data, error } = await supabase
          .from("corporate_cards")
          .select("*")
          .eq("tenant_id", currentTenant.tenant_id)
          .eq("holder_user_id", user.id)
          .eq("is_active", true);

        if (error) throw error;

        if (data && data.length > 0) {
          setCards(data);
          setSelectedCardId(data[0].id); // 첫 번째 카드를 기본 선택
        }
      } catch (error) {
        console.error("Error fetching cards:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchMyCards();
  }, [user, currentTenant]);

  // 2. 선택된 카드의 내역 불러오기
  useEffect(() => {
    const fetchTransactions = async () => {
      if (!selectedCardId) return;

      const { data, error } = await supabase
        .from("card_transactions")
        .select("*")
        .eq("card_id", selectedCardId)
        .order("transaction_date", { ascending: false });

      if (!error && data) {
        setTransactions(data);
        
        // 이번 달 사용 금액 계산
        const now = new Date();
        const thisMonthTotal = data
          .filter(t => {
            const tDate = new Date(t.transaction_date);
            return tDate.getMonth() === now.getMonth() && 
                   tDate.getFullYear() === now.getFullYear() &&
                   t.status !== 'cancelled';
          })
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        setCurrentMonthSpend(thisMonthTotal);
      }
    };

    fetchTransactions();
  }, [selectedCardId]);

  const selectedCard = cards.find(c => c.id === selectedCardId);
  const limitPercentage = selectedCard?.monthly_limit 
    ? Math.min((currentMonthSpend / selectedCard.monthly_limit) * 100, 100)
    : 0;

  const formatCurrency = (amount: number) => 
    new Intl.NumberFormat("ko-KR", { style: "currency", currency: "KRW" }).format(amount);

  const maskCardNumber = (num: string) => {
    if (num.length < 8) return num;
    return num.slice(0, 4) + "-****-****-" + num.slice(-4);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        {/* 헤더 */}
        <div className="flex items-center gap-4 mb-8">
          <Button variant="ghost" size="icon" onClick={() => navigate("/apps/finance")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <CreditCard className="w-6 h-6 text-emerald-600" /> 내 법인카드 사용 내역
            </h1>
            <p className="text-muted-foreground text-sm mt-1">
              본인에게 지급된 법인카드의 한도 및 승인 내역을 확인합니다.
            </p>
          </div>
        </div>

        {cards.length === 0 ? (
          <Card className="border-none shadow-lg py-16">
            <CardContent className="text-center text-muted-foreground">
              <AlertCircle className="w-12 h-12 mx-auto mb-4 opacity-20" />
              <p className="text-lg font-medium">사용 가능한 법인카드가 없습니다.</p>
              <p className="text-sm">관리자에게 카드 지급 여부를 확인해주세요.</p>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* 왼쪽: 카드 정보 및 한도 현황 */}
            <div className="space-y-6">
              {/* 카드 선택 (카드가 여러 장일 경우) */}
              {cards.length > 1 && (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                  <label className="text-xs font-bold text-slate-500 mb-2 block">카드 선택</label>
                  <Select value={selectedCardId} onValueChange={setSelectedCardId}>
                    <SelectTrigger>
                      <SelectValue placeholder="카드를 선택하세요" />
                    </SelectTrigger>
                    <SelectContent>
                      {cards.map(card => (
                        <SelectItem key={card.id} value={card.id}>
                          {card.card_company} ({card.card_number.slice(-4)})
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              )}

              {/* 실물 카드 비주얼 */}
              <div className="relative h-56 w-full rounded-2xl overflow-hidden shadow-2xl bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 flex flex-col justify-between">
                <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/4 blur-3xl"></div>
                
                <div className="flex justify-between items-start z-10">
                  <div>
                    <p className="text-xs text-white/60 font-medium">Corporate Card</p>
                    <p className="font-bold text-lg mt-1">{selectedCard?.card_company}</p>
                  </div>
                  {/* EMV Chip Visual */}
                  <div className="w-10 h-8 bg-yellow-200/80 rounded-md"></div>
                </div>

                <div className="z-10">
                  <p className="font-mono text-2xl tracking-widest text-shadow">
                    {maskCardNumber(selectedCard?.card_number || "")}
                  </p>
                </div>

                <div className="flex justify-between items-end z-10">
                  <div>
                    <p className="text-[10px] text-white/60 uppercase">Card Holder</p>
                    <p className="font-medium tracking-wide">{user?.user_metadata.full_name || selectedCard?.card_name}</p>
                  </div>
                  {selectedCard?.expiry_date && (
                    <div className="text-right">
                      <p className="text-[10px] text-white/60 uppercase">Expires</p>
                      <p className="font-medium tracking-wide">
                        {format(new Date(selectedCard.expiry_date), "MM/yy")}
                      </p>
                    </div>
                  )}
                </div>
              </div>

              {/* 이번 달 사용 현황 */}
              <Card className="border-none shadow-lg">
                <CardHeader className="pb-2">
                  <CardTitle className="text-base flex justify-between items-center">
                    <span>이번 달 사용 현황</span>
                    <Badge variant="outline" className="text-emerald-600 bg-emerald-50">
                      {format(new Date(), "M월")}
                    </Badge>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="mb-4">
                    <div className="flex justify-between items-end mb-2">
                      <span className="text-2xl font-bold text-slate-900">
                        {formatCurrency(currentMonthSpend)}
                      </span>
                      <span className="text-xs text-muted-foreground mb-1">
                        / 한도 {selectedCard?.monthly_limit ? formatCurrency(selectedCard.monthly_limit) : "무제한"}
                      </span>
                    </div>
                    <Progress value={limitPercentage} className="h-2" />
                    <p className="text-xs text-muted-foreground mt-2 text-right">
                      {limitPercentage.toFixed(1)}% 사용 중
                    </p>
                  </div>
                  
                  <div className="bg-slate-50 p-3 rounded-lg flex gap-3 text-xs text-slate-600">
                    <AlertCircle className="w-4 h-4 text-slate-400 shrink-0" />
                    <p>
                      법인카드 사용 후 영수증은 반드시 전자결재 시스템을 통해 제출해야 합니다.
                    </p>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* 오른쪽: 승인 내역 리스트 */}
            <Card className="lg:col-span-2 border-none shadow-lg h-fit">
              <CardHeader className="flex flex-row items-center justify-between pb-4">
                <div>
                  <CardTitle className="text-lg">승인 내역</CardTitle>
                  <CardDescription>최근 결제된 내역입니다.</CardDescription>
                </div>
                <Button variant="outline" size="sm" className="gap-2">
                  <Download className="w-4 h-4" /> 엑셀 다운로드
                </Button>
              </CardHeader>
              <CardContent className="p-0">
                <Table>
                  <TableHeader>
                    <TableRow className="bg-slate-50 hover:bg-slate-50">
                      <TableHead className="w-[120px]">승인일시</TableHead>
                      <TableHead>사용처</TableHead>
                      <TableHead>용도 (프로젝트)</TableHead>
                      <TableHead className="text-right">금액</TableHead>
                      <TableHead className="text-center w-[80px]">증빙</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {transactions.length === 0 ? (
                      <TableRow>
                        <TableCell colSpan={5} className="h-32 text-center text-muted-foreground">
                          사용 내역이 없습니다.
                        </TableCell>
                      </TableRow>
                    ) : (
                      transactions.map((tx) => (
                        <TableRow key={tx.id} className="group hover:bg-slate-50">
                          <TableCell className="text-xs text-muted-foreground">
                            <div className="font-medium text-slate-700">
                              {format(new Date(tx.transaction_date), "MM.dd")}
                            </div>
                            {format(new Date(tx.transaction_date), "HH:mm")}
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <div className="p-1.5 rounded-full bg-slate-100 text-slate-500">
                                <Store className="w-3.5 h-3.5" />
                              </div>
                              <span className="font-medium text-sm">{tx.merchant_name}</span>
                            </div>
                            <div className="text-[10px] text-muted-foreground mt-0.5 ml-7">
                              {tx.category || "일반"}
                            </div>
                          </TableCell>
                          <TableCell className="text-xs text-muted-foreground">
                            {tx.memo || "-"}
                          </TableCell>
                          <TableCell className="text-right font-bold text-sm">
                            {formatCurrency(tx.amount)}
                          </TableCell>
                          <TableCell className="text-center">
                            {tx.receipt_url ? (
                              <Button 
                                variant="ghost" 
                                size="icon" 
                                className="h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                                onClick={() => window.open(tx.receipt_url || "", "_blank")}
                              >
                                <Receipt className="w-4 h-4" />
                              </Button>
                            ) : (
                              <span className="text-[10px] text-red-400 bg-red-50 px-2 py-0.5 rounded-full">
                                미제출
                              </span>
                            )}
                          </TableCell>
                        </TableRow>
                      ))
                    )}
                  </TableBody>
                </Table>
              </CardContent>
            </Card>
          </div>
        )}
      </main>
    </div>
  );
};

export default MyCardExpenses;


============================================================
File Path: src/pages/SuperAdmin/APIManagement.tsx
============================================================
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { 
  Settings, Save, RefreshCw, EyeOff, 
  ShieldAlert, Mail, Brain, Sparkles, Cpu, 
  ArrowLeft, Terminal, Globe, CheckCircle2, AlertCircle
} from "lucide-react";
import { useNavigate } from "react-router-dom";

interface ConfigItem {
  key: string;
  value: string; // masked value from edge function
  is_set: boolean;
  description: string | null;
  category: string | null;
}

// New value inputs tracked separately from masked display values
type InputMap = Record<string, string>;

const categoryStyles: Record<string, { icon: any, color: string, label: string }> = {
  EMAIL: { icon: <Mail className="w-5 h-5" />, color: "border-l-blue-500", label: "이메일 인프라" },
  AI_GEMINI: { icon: <Sparkles className="w-5 h-5" />, color: "border-l-orange-500", label: "Google Gemini AI" },
  AI_HUGGINGFACE: { icon: <Brain className="w-5 h-5" />, color: "border-l-yellow-500", label: "Hugging Face AI" },
  SYSTEM: { icon: <Globe className="w-5 h-5" />, color: "border-l-slate-500", label: "시스템 네트워크" },
  TELEGRAM: { icon: <Globe className="w-5 h-5" />, color: "border-l-cyan-500", label: "📨 텔레그램 봇" },
};

const APIManagement = () => {
  const navigate = useNavigate();
  const [configs, setConfigs] = useState<ConfigItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState<Record<string, boolean>>({});
  // Track new values being typed — separate from masked display
  const [newValues, setNewValues] = useState<InputMap>({});

  const fetchConfigs = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.functions.invoke("manage-system-config", {
        method: "GET",
      });
      if (error) throw error;
      setConfigs(data?.data || []);
      // Reset new value inputs on refresh
      setNewValues({});
    } catch (error: any) {
      toast.error("데이터 로드 실패");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchConfigs();
  }, []);

  const handleSave = async (key: string) => {
    const value = newValues[key];
    if (value === undefined || value.trim() === "") {
      toast.error("저장할 값을 입력하세요.");
      return;
    }
    setSaving(prev => ({ ...prev, [key]: true }));
    try {
      const { error } = await supabase.functions.invoke("manage-system-config", {
        method: "POST",
        body: { key, value: value.trim() },
      });
      if (error) throw error;
      toast.success(`${key} 설정 저장 완료`);
      // Clear the input and re-fetch to update masked display
      setNewValues(prev => { const n = { ...prev }; delete n[key]; return n; });
      await fetchConfigs();
    } catch (error: any) {
      toast.error("저장 실패");
    } finally {
      setSaving(prev => ({ ...prev, [key]: false }));
    }
  };

  const categories = Array.from(new Set(configs.map(c => c.category)));

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-6xl mx-auto">
        
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-10">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" onClick={() => navigate("/super-admin")}>
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-3xl font-bold flex items-center gap-3">
                <Settings className="w-8 h-8 text-indigo-600" /> 시스템 마스터 API 관리
              </h1>
              <p className="text-slate-500 mt-1">플랫폼 전체에서 사용하는 AI 모델, 메일 서버, 인프라 키를 통합 통제합니다.</p>
            </div>
          </div>
          <Button variant="outline" onClick={fetchConfigs} className="bg-white">
            <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} /> 데이터 동기화
          </Button>
        </div>

        {/* Security notice */}
        <div className="mb-8 flex items-start gap-3 bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
          <EyeOff className="w-5 h-5 mt-0.5 flex-shrink-0 text-blue-500" />
          <div>
            <span className="font-semibold">보안 보호 모드:</span> 실제 API 키 값은 서버에서만 처리되며 브라우저로 전송되지 않습니다.
            설정된 키는 <span className="font-mono bg-blue-100 px-1 rounded">abc••••••••••••••••</span> 형태로 표시됩니다.
            변경하려면 새 값을 입력 후 저장하세요.
          </div>
        </div>

        <div className="space-y-12">
          {categories.map(cat => (
            <section key={cat} className="animate-in fade-in slide-in-from-bottom-3 duration-500">
              <div className="flex items-center gap-3 mb-4 px-1">
                <div className="p-2 bg-white rounded-lg shadow-sm border border-slate-100">
                  {categoryStyles[cat ?? ""]?.icon || <Cpu className="w-5 h-5" />}
                </div>
                <div>
                  <h2 className="text-lg font-bold text-slate-800">{categoryStyles[cat ?? ""]?.label || cat}</h2>
                  <p className="text-xs text-slate-400">Infrastructure Group: {cat}</p>
                </div>
                <div className="h-px flex-1 bg-slate-200 ml-4 opacity-50"></div>
              </div>

              <div className="grid grid-cols-1 gap-4">
                {configs.filter(c => c.category === cat).map((config) => (
                  <Card key={config.key} className={`border-none shadow-sm border-l-4 ${categoryStyles[cat ?? ""]?.color || 'border-l-slate-300'} bg-white overflow-hidden`}>
                    <CardContent className="p-5 flex flex-col lg:flex-row lg:items-center gap-6">
                      <div className="lg:w-1/4">
                        <div className="flex items-center gap-2 mb-1">
                          <Terminal className="w-3.5 h-3.5 text-indigo-400" />
                          <span className="font-bold text-slate-900 text-sm">{config.key}</span>
                        </div>
                        <p className="text-[11px] text-slate-500 leading-relaxed font-medium">{config.description}</p>
                        <div className="mt-2">
                          {config.is_set ? (
                            <Badge variant="outline" className="text-green-600 border-green-200 bg-green-50 text-[10px] gap-1">
                              <CheckCircle2 className="w-3 h-3" /> 설정됨
                            </Badge>
                          ) : (
                            <Badge variant="outline" className="text-amber-600 border-amber-200 bg-amber-50 text-[10px] gap-1">
                              <AlertCircle className="w-3 h-3" /> 미설정
                            </Badge>
                          )}
                        </div>
                      </div>

                      <div className="flex-1 flex flex-col gap-2">
                        {/* Masked current value display */}
                        {config.is_set && (
                          <div className="flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-lg border border-slate-200">
                            <EyeOff className="w-3.5 h-3.5 text-slate-400" />
                            <span className="font-mono text-sm text-slate-500">{config.value}</span>
                            <span className="text-[10px] text-slate-400 ml-auto">현재 저장된 값 (마스킹됨)</span>
                          </div>
                        )}
                        {/* New value input */}
                        <div className="flex gap-2">
                          <Input
                            type="password"
                            value={newValues[config.key] ?? ""}
                            onChange={(e) => setNewValues(prev => ({ ...prev, [config.key]: e.target.value }))}
                            className="font-mono text-sm bg-white border-slate-200 h-11"
                            placeholder={config.is_set ? "새 값으로 변경하려면 입력..." : "값을 입력하세요..."}
                          />
                          <Button 
                            onClick={() => handleSave(config.key)} 
                            disabled={saving[config.key] || !newValues[config.key]?.trim()}
                            className="w-24 font-bold h-11 shadow-sm"
                          >
                            {saving[config.key] ? <RefreshCw className="w-4 h-4 animate-spin" /> : <><Save className="w-4 h-4 mr-2"/>저장</>}
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </section>
          ))}
        </div>

        {/* 하단 보안 가이드 */}
        <div className="mt-16 bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden shadow-2xl">
          <div className="absolute -top-10 -right-10 opacity-10">
             <ShieldAlert className="w-64 h-64" />
          </div>
          <div className="relative z-10">
            <h3 className="text-xl font-bold flex items-center gap-2 mb-4">
               <ShieldAlert className="text-amber-400" /> 슈퍼 어드민 보안 프로토콜
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
               <div className="space-y-3">
                  <p className="text-sm text-slate-300 font-bold">1. 데이터 가용성</p>
                  <p className="text-xs text-slate-400 leading-relaxed">
                    이곳에서 변경된 API 키와 모델 설정은 Edge Function 및 모든 서비스 페이지에 실시간으로 반영됩니다. 잘못된 모델 ID를 입력할 경우 시스템 장애의 원인이 될 수 있습니다.
                  </p>
               </div>
               <div className="space-y-3">
                  <p className="text-sm text-slate-300 font-bold">2. 모델 설정 팁</p>
                  <p className="text-xs text-slate-400 leading-relaxed">
                    Hugging Face 모델 ID는 <code>author/model-name</code> 형식을 준수해야 합니다. Gemini API 키는 Google Cloud Console에서 발급받은 최신 버전을 권장합니다.
                  </p>
               </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default APIManagement;



============================================================
File Path: src/pages/SuperAdmin/LeaveDefaults.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  ArrowLeft, Plus, Pencil, Trash2, Palmtree, FolderOpen,
} from "lucide-react";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter,
} from "@/components/ui/dialog";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";

interface LeaveGroup {
  id: string;
  name: string;
  description: string | null;
  overdraft_limit: number | null;
  is_active: boolean;
  sort_order: number | null;
}

interface LeaveType {
  id: string;
  group_id: string | null;
  name: string;
  display_name: string | null;
  time_option: string;
  paid_hours: number | null;
  deduction_days: number | null;
  special_option: string | null;
  is_paid: boolean | null;
  is_active: boolean;
  min_consecutive_days: number | null;
  max_consecutive_days: number | null;
  include_holidays_in_consecutive: boolean | null;
}

// tenant_id가 NULL인 레코드 = 시스템 기본값
const SYSTEM_TENANT_ID = null;

const LeaveDefaults = () => {
  const navigate = useNavigate();
  const [groups, setGroups] = useState<LeaveGroup[]>([]);
  const [types, setTypes] = useState<LeaveType[]>([]);
  const [loading, setLoading] = useState(true);

  // Group dialog
  const [groupDialog, setGroupDialog] = useState(false);
  const [editGroup, setEditGroup] = useState<LeaveGroup | null>(null);
  const [groupForm, setGroupForm] = useState({ name: "", description: "", overdraft_limit: "" });

  // Type dialog
  const [typeDialog, setTypeDialog] = useState(false);
  const [editType, setEditType] = useState<LeaveType | null>(null);
  const [typeForm, setTypeForm] = useState({
    group_id: "", name: "", display_name: "", time_option: "full_day",
    paid_hours: "8", deduction_days: "1", special_option: "none", is_paid: true,
    min_consecutive_days: "1", max_consecutive_days: "",
    include_holidays_in_consecutive: false,
  });

  const [deleteTarget, setDeleteTarget] = useState<{ type: "group" | "type"; id: string; name: string } | null>(null);

  useEffect(() => { fetchData(); }, []);

  const fetchData = async () => {
    setLoading(true);
    const [gRes, tRes] = await Promise.all([
      supabase.from("leave_groups").select("*").is("tenant_id", null).order("sort_order"),
      supabase.from("leave_types").select("*").is("tenant_id", null).order("sort_order"),
    ]);
    if (gRes.data) setGroups(gRes.data as LeaveGroup[]);
    if (tRes.data) setTypes(tRes.data as LeaveType[]);
    setLoading(false);
  };

  // ===== Group CRUD =====
  const openGroupDialog = (group?: LeaveGroup) => {
    if (group) {
      setEditGroup(group);
      setGroupForm({ name: group.name, description: group.description || "", overdraft_limit: group.overdraft_limit?.toString() ?? "" });
    } else {
      setEditGroup(null);
      setGroupForm({ name: "", description: "", overdraft_limit: "" });
    }
    setGroupDialog(true);
  };

  const saveGroup = async () => {
    if (!groupForm.name.trim()) { toast.error("그룹명을 입력하세요."); return; }
    const payload: any = {
      tenant_id: SYSTEM_TENANT_ID,
      name: groupForm.name.trim(),
      description: groupForm.description.trim() || null,
      overdraft_limit: groupForm.overdraft_limit === "" ? null : Number(groupForm.overdraft_limit),
    };
    if (editGroup) {
      const { error } = await supabase.from("leave_groups").update(payload).eq("id", editGroup.id);
      if (error) { toast.error("수정 실패: " + error.message); return; }
      toast.success("수정 완료");
    } else {
      const { error } = await supabase.from("leave_groups").insert(payload);
      if (error) { toast.error("추가 실패: " + error.message); return; }
      toast.success("추가 완료");
    }
    setGroupDialog(false);
    fetchData();
  };

  // ===== Type CRUD =====
  const openTypeDialog = (type?: LeaveType) => {
    if (type) {
      setEditType(type);
      setTypeForm({
        group_id: type.group_id || "", name: type.name, display_name: type.display_name || "",
        time_option: type.time_option, paid_hours: (type.paid_hours ?? 8).toString(),
        deduction_days: (type.deduction_days ?? 1).toString(), special_option: type.special_option || "none",
        is_paid: type.is_paid ?? true,
        min_consecutive_days: (type.min_consecutive_days ?? 1).toString(),
        max_consecutive_days: type.max_consecutive_days?.toString() || "",
        include_holidays_in_consecutive: type.include_holidays_in_consecutive ?? false,
      });
    } else {
      setEditType(null);
      setTypeForm({ group_id: "", name: "", display_name: "", time_option: "full_day", paid_hours: "8", deduction_days: "1", special_option: "none", is_paid: true, min_consecutive_days: "1", max_consecutive_days: "", include_holidays_in_consecutive: false });
    }
    setTypeDialog(true);
  };

  const saveType = async () => {
    if (!typeForm.name.trim()) { toast.error("유형명을 입력하세요."); return; }
    const payload: any = {
      tenant_id: SYSTEM_TENANT_ID,
      group_id: typeForm.group_id || null,
      name: typeForm.name.trim(),
      display_name: typeForm.display_name.trim() || null,
      time_option: typeForm.time_option,
      paid_hours: Number(typeForm.paid_hours),
      deduction_days: Number(typeForm.deduction_days),
      special_option: typeForm.special_option,
      is_paid: typeForm.is_paid,
      min_consecutive_days: Number(typeForm.min_consecutive_days),
      max_consecutive_days: typeForm.max_consecutive_days ? Number(typeForm.max_consecutive_days) : null,
      include_holidays_in_consecutive: typeForm.include_holidays_in_consecutive,
    };
    if (editType) {
      const { error } = await supabase.from("leave_types").update(payload).eq("id", editType.id);
      if (error) { toast.error("수정 실패: " + error.message); return; }
      toast.success("수정 완료");
    } else {
      const { error } = await supabase.from("leave_types").insert(payload);
      if (error) { toast.error("추가 실패: " + error.message); return; }
      toast.success("추가 완료");
    }
    setTypeDialog(false);
    fetchData();
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    const table = deleteTarget.type === "group" ? "leave_groups" : "leave_types";
    const { error } = await supabase.from(table).delete().eq("id", deleteTarget.id);
    if (error) { toast.error("삭제 실패: " + error.message); }
    else { toast.success("삭제 완료"); }
    setDeleteTarget(null);
    fetchData();
  };

  if (loading) return <div className="p-8 text-center text-muted-foreground">로딩 중...</div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-6">
      <div className="flex items-center gap-3">
        <Button variant="ghost" size="icon" onClick={() => navigate("/super-admin")}>
          <ArrowLeft className="w-5 h-5" />
        </Button>
        <div className="flex items-center gap-2">
          <Palmtree className="w-6 h-6 text-emerald-600" />
          <h1 className="text-2xl font-bold">휴가 그룹/유형 기본값 관리</h1>
        </div>
      </div>
      <p className="text-sm text-muted-foreground ml-12">
        모든 회사에 기본으로 적용될 휴가 그룹과 유형을 관리합니다. 각 테넌트는 '기본값 불러오기'로 이 데이터를 복사할 수 있습니다.
      </p>

      <Tabs defaultValue="groups">
        <TabsList>
          <TabsTrigger value="groups">휴가 그룹</TabsTrigger>
          <TabsTrigger value="types">휴가 유형</TabsTrigger>
        </TabsList>

        {/* 휴가 그룹 */}
        <TabsContent value="groups" className="space-y-4">
          <div className="flex justify-end">
            <Button onClick={() => openGroupDialog()}><Plus className="w-4 h-4 mr-1" />휴가 그룹 추가</Button>
          </div>
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>그룹명</TableHead>
                  <TableHead>설명</TableHead>
                  <TableHead>초과사용 제한</TableHead>
                  <TableHead>상태</TableHead>
                  <TableHead className="w-24">관리</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {groups.map(g => (
                  <TableRow key={g.id}>
                    <TableCell className="font-medium">{g.name}</TableCell>
                    <TableCell className="text-muted-foreground">{g.description || "-"}</TableCell>
                    <TableCell>
                      {g.overdraft_limit === null ? "제한 없음" : g.overdraft_limit === 0 ? "초과 불가" : `최대 -${g.overdraft_limit}일`}
                    </TableCell>
                    <TableCell><Badge variant={g.is_active ? "default" : "secondary"}>{g.is_active ? "활성" : "비활성"}</Badge></TableCell>
                    <TableCell>
                      <div className="flex gap-1">
                        <Button size="icon" variant="ghost" onClick={() => openGroupDialog(g)}><Pencil className="w-4 h-4" /></Button>
                        <Button size="icon" variant="ghost" onClick={() => setDeleteTarget({ type: "group", id: g.id, name: g.name })}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                {groups.length === 0 && <TableRow><TableCell colSpan={5} className="text-center py-8 text-muted-foreground">등록된 기본 휴가 그룹이 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>

        {/* 휴가 유형 */}
        <TabsContent value="types" className="space-y-4">
          <div className="flex justify-end">
            <Button onClick={() => openTypeDialog()}><Plus className="w-4 h-4 mr-1" />휴가 유형 추가</Button>
          </div>
          <Card>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>유형명</TableHead>
                  <TableHead>그룹</TableHead>
                  <TableHead>시간옵션</TableHead>
                  <TableHead>차감일수</TableHead>
                  <TableHead>유급</TableHead>
                  <TableHead>특별옵션</TableHead>
                  <TableHead className="w-24">관리</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {types.map(t => (
                  <TableRow key={t.id}>
                    <TableCell className="font-medium">{t.name}{t.display_name ? ` (${t.display_name})` : ""}</TableCell>
                    <TableCell>{groups.find(g => g.id === t.group_id)?.name || "-"}</TableCell>
                    <TableCell>{t.time_option === "full_day" ? "하루 종일" : "시간 입력"}</TableCell>
                    <TableCell>{t.deduction_days ?? 1}일</TableCell>
                    <TableCell><Badge variant={t.is_paid ? "default" : "outline"}>{t.is_paid ? "유급" : "무급"}</Badge></TableCell>
                    <TableCell>
                      {{ none: "해당없음", long_term: "장기휴가", day_off: "휴무", holiday: "휴일" }[t.special_option || "none"] || "-"}
                    </TableCell>
                    <TableCell>
                      <div className="flex gap-1">
                        <Button size="icon" variant="ghost" onClick={() => openTypeDialog(t)}><Pencil className="w-4 h-4" /></Button>
                        <Button size="icon" variant="ghost" onClick={() => setDeleteTarget({ type: "type", id: t.id, name: t.name })}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                {types.length === 0 && <TableRow><TableCell colSpan={7} className="text-center py-8 text-muted-foreground">등록된 기본 휴가 유형이 없습니다.</TableCell></TableRow>}
              </TableBody>
            </Table>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Group Dialog */}
      <Dialog open={groupDialog} onOpenChange={setGroupDialog}>
        <DialogContent>
          <DialogHeader><DialogTitle>{editGroup ? "휴가 그룹 수정" : "휴가 그룹 추가"}</DialogTitle></DialogHeader>
          <div className="space-y-4">
            <div><Label>그룹명 *</Label><Input value={groupForm.name} onChange={e => setGroupForm(p => ({ ...p, name: e.target.value }))} /></div>
            <div><Label>설명</Label><Textarea value={groupForm.description} onChange={e => setGroupForm(p => ({ ...p, description: e.target.value }))} /></div>
            <div>
              <Label>초과사용 제한 (일)</Label>
              <Input type="number" value={groupForm.overdraft_limit} onChange={e => setGroupForm(p => ({ ...p, overdraft_limit: e.target.value }))} placeholder="비워두면 제한 없음, 0이면 초과 불가" />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setGroupDialog(false)}>취소</Button>
            <Button onClick={saveGroup}>{editGroup ? "수정" : "추가"}</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Type Dialog */}
      <Dialog open={typeDialog} onOpenChange={setTypeDialog}>
        <DialogContent className="max-w-lg">
          <DialogHeader><DialogTitle>{editType ? "휴가 유형 수정" : "휴가 유형 추가"}</DialogTitle></DialogHeader>
          <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
            <div>
              <Label>휴가 그룹</Label>
              <Select value={typeForm.group_id} onValueChange={v => setTypeForm(p => ({ ...p, group_id: v }))}>
                <SelectTrigger><SelectValue placeholder="그룹 선택 (선택사항)" /></SelectTrigger>
                <SelectContent>
                  {groups.map(g => <SelectItem key={g.id} value={g.id}>{g.name}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div><Label>유형명 *</Label><Input value={typeForm.name} onChange={e => setTypeForm(p => ({ ...p, name: e.target.value }))} /></div>
              <div><Label>표시 이름</Label><Input value={typeForm.display_name} onChange={e => setTypeForm(p => ({ ...p, display_name: e.target.value }))} /></div>
            </div>
            <div>
              <Label>시간 옵션</Label>
              <Select value={typeForm.time_option} onValueChange={v => setTypeForm(p => ({ ...p, time_option: v }))}>
                <SelectTrigger><SelectValue /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="full_day">하루 종일</SelectItem>
                  <SelectItem value="time_input">시간 입력</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div><Label>유급시간 (h)</Label><Input type="number" value={typeForm.paid_hours} onChange={e => setTypeForm(p => ({ ...p, paid_hours: e.target.value }))} /></div>
              <div><Label>차감일수</Label><Input type="number" step="0.5" value={typeForm.deduction_days} onChange={e => setTypeForm(p => ({ ...p, deduction_days: e.target.value }))} /></div>
            </div>
            <div>
              <Label>특별 옵션</Label>
              <Select value={typeForm.special_option} onValueChange={v => setTypeForm(p => ({ ...p, special_option: v }))}>
                <SelectTrigger><SelectValue /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">해당 없음</SelectItem>
                  <SelectItem value="long_term">장기 휴가</SelectItem>
                  <SelectItem value="day_off">휴무</SelectItem>
                  <SelectItem value="holiday">휴일</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center gap-3">
              <Switch checked={typeForm.is_paid} onCheckedChange={v => setTypeForm(p => ({ ...p, is_paid: v }))} />
              <Label>유급 여부</Label>
            </div>
            {typeForm.time_option === "full_day" && (
              <>
                <div className="grid grid-cols-2 gap-3">
                  <div><Label>최소 연속일수</Label><Input type="number" value={typeForm.min_consecutive_days} onChange={e => setTypeForm(p => ({ ...p, min_consecutive_days: e.target.value }))} /></div>
                  <div><Label>최대 연속일수</Label><Input type="number" value={typeForm.max_consecutive_days} onChange={e => setTypeForm(p => ({ ...p, max_consecutive_days: e.target.value }))} placeholder="제한 없음" /></div>
                </div>
                <div className="flex items-center gap-3">
                  <Switch checked={typeForm.include_holidays_in_consecutive} onCheckedChange={v => setTypeForm(p => ({ ...p, include_holidays_in_consecutive: v }))} />
                  <Label>연속일수에 휴무/휴일 포함</Label>
                </div>
              </>
            )}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setTypeDialog(false)}>취소</Button>
            <Button onClick={saveType}>{editType ? "수정" : "추가"}</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirm */}
      <AlertDialog open={!!deleteTarget} onOpenChange={(o) => { if (!o) setDeleteTarget(null); }}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>삭제 확인</AlertDialogTitle>
            <AlertDialogDescription>'{deleteTarget?.name}'을(를) 삭제하시겠습니까?</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-destructive hover:bg-destructive/90">삭제</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default LeaveDefaults;



============================================================
File Path: src/pages/SuperAdmin/MessageManagement.tsx
============================================================
import { Header } from "@/components/landing/Header";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { MessageSquare, ArrowLeft, Construction } from "lucide-react";
import { useNavigate } from "react-router-dom";

const MessageManagement = () => {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-4xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/super-admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <MessageSquare className="w-8 h-8 text-primary" /> 커뮤니케이션 관리
            </h1>
            <p className="text-slate-500 mt-1">SNS 공유 카드 및 이메일 문구 관리</p>
          </div>
        </div>

        <Card className="border-none shadow-xl bg-white rounded-3xl overflow-hidden">
          <CardContent className="p-16 text-center">
            <div className="inline-flex p-6 rounded-full bg-primary/10 mb-6">
              <Construction className="w-16 h-16 text-primary/60" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-3">기능 준비 중</h2>
            <p className="text-slate-500 max-w-md mx-auto leading-relaxed">
              커뮤니케이션 템플릿 관리 기능이 곧 제공됩니다.<br />
              SNS 공유 카드, 이메일 템플릿 등의 기능이 포함될 예정입니다.
            </p>
            <Button 
              variant="outline" 
              className="mt-8"
              onClick={() => navigate("/super-admin")}
            >
              슈퍼 관리자 홈으로 돌아가기
            </Button>
          </CardContent>
        </Card>
      </main>
    </div>
  );
};

export default MessageManagement;



============================================================
File Path: src/pages/SuperAdmin/OrgDefaults.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  ArrowLeft, Plus, Pencil, Trash2, Building2, Briefcase, GripVertical,
  ChevronRight, ChevronDown, FolderTree
} from "lucide-react";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter,
} from "@/components/ui/dialog";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";

interface Department {
  id: string;
  name: string;
  parent_id: string | null;
  description: string | null;
  sort_order: number;
  is_active: boolean;
  children?: Department[];
}

interface JobTitle {
  id: string;
  name: string;
  level: number;
  description: string | null;
  is_active: boolean;
}

const OrgDefaults = () => {
  const navigate = useNavigate();
  const [departments, setDepartments] = useState<Department[]>([]);
  const [jobTitles, setJobTitles] = useState<JobTitle[]>([]);
  const [loading, setLoading] = useState(true);

  const [deptDialogOpen, setDeptDialogOpen] = useState(false);
  const [editingDept, setEditingDept] = useState<Department | null>(null);
  const [deptForm, setDeptForm] = useState({ name: "", description: "", parent_id: "" });

  const [jobDialogOpen, setJobDialogOpen] = useState(false);
  const [editingJob, setEditingJob] = useState<JobTitle | null>(null);
  const [jobForm, setJobForm] = useState({ name: "", level: 0, description: "" });

  const [deleteTarget, setDeleteTarget] = useState<{ type: "dept" | "job"; id: string; name: string } | null>(null);
  const [expandedDepts, setExpandedDepts] = useState<Set<string>>(new Set());

  useEffect(() => { fetchData(); }, []);

  const fetchData = async () => {
    setLoading(true);
    const [deptRes, jobRes] = await Promise.all([
      supabase.from("departments").select("*").is("tenant_id", null).order("sort_order"),
      supabase.from("job_titles").select("*").is("tenant_id", null).order("level"),
    ]);
    if (deptRes.data) setDepartments(deptRes.data);
    if (jobRes.data) setJobTitles(jobRes.data);
    setLoading(false);
  };

  const buildDeptTree = (depts: Department[], parentId: string | null = null): Department[] => {
    return depts
      .filter(d => d.parent_id === parentId)
      .map(d => ({ ...d, children: buildDeptTree(depts, d.id) }));
  };

  const deptTree = buildDeptTree(departments);

  const toggleExpand = (id: string) => {
    setExpandedDepts(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id); else next.add(id);
      return next;
    });
  };

  const openDeptDialog = (dept?: Department) => {
    if (dept) {
      setEditingDept(dept);
      setDeptForm({ name: dept.name, description: dept.description || "", parent_id: dept.parent_id || "" });
    } else {
      setEditingDept(null);
      setDeptForm({ name: "", description: "", parent_id: "" });
    }
    setDeptDialogOpen(true);
  };

  const saveDepartment = async () => {
    if (!deptForm.name.trim()) return;
    const payload = {
      tenant_id: null as any,
      name: deptForm.name.trim(),
      description: deptForm.description.trim() || null,
      parent_id: deptForm.parent_id || null,
      sort_order: departments.length,
    };
    if (editingDept) {
      const { error } = await supabase.from("departments").update(payload).eq("id", editingDept.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("기본 부서가 수정되었습니다");
    } else {
      const { error } = await supabase.from("departments").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("기본 부서가 등록되었습니다");
    }
    setDeptDialogOpen(false);
    fetchData();
  };

  const openJobDialog = (job?: JobTitle) => {
    if (job) {
      setEditingJob(job);
      setJobForm({ name: job.name, level: job.level, description: job.description || "" });
    } else {
      setEditingJob(null);
      setJobForm({ name: "", level: jobTitles.length, description: "" });
    }
    setJobDialogOpen(true);
  };

  const saveJobTitle = async () => {
    if (!jobForm.name.trim()) return;
    const payload = {
      tenant_id: null as any,
      name: jobForm.name.trim(),
      level: jobForm.level,
      description: jobForm.description.trim() || null,
    };
    if (editingJob) {
      const { error } = await supabase.from("job_titles").update(payload).eq("id", editingJob.id);
      if (error) toast.error("수정 실패: " + error.message);
      else toast.success("기본 직급이 수정되었습니다");
    } else {
      const { error } = await supabase.from("job_titles").insert(payload);
      if (error) toast.error("등록 실패: " + error.message);
      else toast.success("기본 직급이 등록되었습니다");
    }
    setJobDialogOpen(false);
    fetchData();
  };

  const handleDelete = async () => {
    if (!deleteTarget) return;
    const table = deleteTarget.type === "dept" ? "departments" : "job_titles";
    const { error } = await supabase.from(table).delete().eq("id", deleteTarget.id);
    if (error) toast.error("삭제 실패: " + error.message);
    else toast.success(`${deleteTarget.name}이(가) 삭제되었습니다`);
    setDeleteTarget(null);
    fetchData();
  };

  const renderDeptItem = (dept: Department, level: number = 0) => {
    const hasChildren = dept.children && dept.children.length > 0;
    const isExpanded = expandedDepts.has(dept.id);
    return (
      <div key={dept.id}>
        <div className="flex items-center gap-2 p-3 rounded-lg hover:bg-slate-50 group" style={{ paddingLeft: `${level * 24 + 12}px` }}>
          <GripVertical className="w-4 h-4 text-slate-300" />
          {hasChildren ? (
            <button onClick={() => toggleExpand(dept.id)} className="p-0.5">
              {isExpanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
            </button>
          ) : <div className="w-5" />}
          <Building2 className="w-4 h-4 text-emerald-500" />
          <span className="flex-1 font-medium">{dept.name}</span>
          {dept.description && <span className="text-sm text-slate-400 hidden md:block">{dept.description}</span>}
          <div className="opacity-0 group-hover:opacity-100 flex gap-1">
            <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openDeptDialog(dept)}>
              <Pencil className="w-4 h-4" />
            </Button>
            <Button variant="ghost" size="icon" className="h-8 w-8 text-red-500 hover:text-red-600" onClick={() => setDeleteTarget({ type: "dept", id: dept.id, name: dept.name })}>
              <Trash2 className="w-4 h-4" />
            </Button>
          </div>
        </div>
        {hasChildren && isExpanded && dept.children?.map(child => renderDeptItem(child, level + 1))}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-28 pb-16 px-6 max-w-5xl mx-auto">
        <div className="flex items-center gap-4 mb-10">
          <Button variant="ghost" size="icon" onClick={() => navigate("/super-admin")}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <FolderTree className="w-8 h-8 text-emerald-600" /> 부서 및 직급 기본값
            </h1>
            <p className="text-slate-500 mt-1">모든 회사에 기본으로 적용될 부서와 직급 체계를 관리합니다.</p>
          </div>
        </div>

        <Tabs defaultValue="departments" className="space-y-6">
          <TabsList className="grid w-full max-w-md grid-cols-2">
            <TabsTrigger value="departments" className="gap-2"><Building2 className="w-4 h-4" /> 기본 부서</TabsTrigger>
            <TabsTrigger value="jobtitles" className="gap-2"><Briefcase className="w-4 h-4" /> 기본 직급</TabsTrigger>
          </TabsList>

          <TabsContent value="departments">
            <Card className="border-none shadow-xl bg-white rounded-3xl">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>기본 부서 목록</CardTitle>
                <Button onClick={() => openDeptDialog()} className="gap-2"><Plus className="w-4 h-4" /> 부서 추가</Button>
              </CardHeader>
              <CardContent>
                {loading ? (
                  <div className="text-center py-12 text-slate-400">로딩 중...</div>
                ) : deptTree.length === 0 ? (
                  <div className="text-center py-12 text-slate-400">등록된 기본 부서가 없습니다.</div>
                ) : (
                  <div className="divide-y">{deptTree.map(dept => renderDeptItem(dept))}</div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="jobtitles">
            <Card className="border-none shadow-xl bg-white rounded-3xl">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>기본 직급 목록</CardTitle>
                <Button onClick={() => openJobDialog()} className="gap-2"><Plus className="w-4 h-4" /> 직급 추가</Button>
              </CardHeader>
              <CardContent>
                {loading ? (
                  <div className="text-center py-12 text-slate-400">로딩 중...</div>
                ) : jobTitles.length === 0 ? (
                  <div className="text-center py-12 text-slate-400">등록된 기본 직급이 없습니다.</div>
                ) : (
                  <div className="space-y-2">
                    {jobTitles.map((job, idx) => (
                      <div key={job.id} className="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 group">
                        <GripVertical className="w-4 h-4 text-slate-300" />
                        <div className="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-600 font-bold text-sm">{idx + 1}</div>
                        <Briefcase className="w-4 h-4 text-violet-500" />
                        <span className="flex-1 font-medium">{job.name}</span>
                        {job.description && <span className="text-sm text-slate-400 hidden md:block">{job.description}</span>}
                        <div className="opacity-0 group-hover:opacity-100 flex gap-1">
                          <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openJobDialog(job)}><Pencil className="w-4 h-4" /></Button>
                          <Button variant="ghost" size="icon" className="h-8 w-8 text-red-500 hover:text-red-600" onClick={() => setDeleteTarget({ type: "job", id: job.id, name: job.name })}><Trash2 className="w-4 h-4" /></Button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </main>

      {/* Department Dialog */}
      <Dialog open={deptDialogOpen} onOpenChange={setDeptDialogOpen}>
        <DialogContent aria-describedby="dept-dialog-desc">
          <DialogHeader><DialogTitle>{editingDept ? "기본 부서 수정" : "기본 부서 추가"}</DialogTitle></DialogHeader>
          <p id="dept-dialog-desc" className="sr-only">부서 정보를 입력하세요</p>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="dept-name">부서명 *</Label>
              <Input id="dept-name" value={deptForm.name} onChange={e => setDeptForm(p => ({ ...p, name: e.target.value }))} placeholder="예: 경영지원팀" autoComplete="off" />
            </div>
            <div className="space-y-2">
              <Label>상위 부서</Label>
              <Select value={deptForm.parent_id} onValueChange={v => setDeptForm(f => ({ ...f, parent_id: v === "none" ? "" : v }))}>
                <SelectTrigger><SelectValue placeholder="상위 부서 선택 (선택사항)" /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">없음 (최상위)</SelectItem>
                  {departments.filter(d => d.id !== editingDept?.id).map(d => (
                    <SelectItem key={d.id} value={d.id}>{d.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label>설명</Label>
              <Textarea value={deptForm.description} onChange={e => setDeptForm(f => ({ ...f, description: e.target.value }))} placeholder="부서에 대한 간단한 설명" />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDeptDialogOpen(false)}>취소</Button>
            <Button onClick={saveDepartment} disabled={!deptForm.name.trim()}>저장</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* JobTitle Dialog */}
      <Dialog open={jobDialogOpen} onOpenChange={setJobDialogOpen}>
        <DialogContent aria-describedby="job-dialog-desc">
          <DialogHeader><DialogTitle>{editingJob ? "기본 직급 수정" : "기본 직급 추가"}</DialogTitle></DialogHeader>
          <p id="job-dialog-desc" className="sr-only">직급 정보를 입력하세요</p>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="job-name">직급명 *</Label>
              <Input id="job-name" value={jobForm.name} onChange={e => setJobForm(p => ({ ...p, name: e.target.value }))} placeholder="예: 대리" autoComplete="off" />
            </div>
            <div className="space-y-2">
              <Label>레벨 (순서)</Label>
              <Input type="number" value={jobForm.level} onChange={e => setJobForm(f => ({ ...f, level: parseInt(e.target.value) || 0 }))} placeholder="숫자가 낮을수록 높은 직급" />
            </div>
            <div className="space-y-2">
              <Label>설명</Label>
              <Textarea value={jobForm.description} onChange={e => setJobForm(f => ({ ...f, description: e.target.value }))} placeholder="직급에 대한 간단한 설명" />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setJobDialogOpen(false)}>취소</Button>
            <Button onClick={saveJobTitle} disabled={!jobForm.name.trim()}>저장</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteTarget} onOpenChange={() => setDeleteTarget(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>정말 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription>{deleteTarget?.name}을(를) 삭제하면 복구할 수 없습니다.</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>취소</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-red-600 hover:bg-red-700">삭제</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default OrgDefaults;



============================================================
File Path: src/pages/SuperAdmin/PressContacts.tsx
============================================================
import { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from "@/components/ui/table";
import {
  Sheet, SheetContent, SheetHeader, SheetTitle, SheetClose, SheetFooter
} from "@/components/ui/sheet";
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue
} from "@/components/ui/select";
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";
import {
  Users, Plus, Search, Filter, MoreHorizontal, Mail, Phone, Globe,
  Loader2, Save, Edit2, Trash2, ArrowLeft, Terminal, Upload, Download
} from "lucide-react";
import { Tables } from "@/integrations/supabase/types";
import * as XLSX from "xlsx";

// DB 타입 정의
type PressContact = Tables<'press_contacts'>;

// 목적 옵션 (Select 오류 방지를 위해 '전체' 및 '선택 안 함' 항목은 별도로 관리)
const purposeOptions = ["PR (언론 홍보)", "브랜드 마케팅", "광고 제휴", "기타"];

const PressContacts = () => {
  const navigate = useNavigate();
  // user 객체는 useAuth에서 가져오지 않아도 되지만, currentTenant가 필요하다면 가져와야 합니다.
  // 이 페이지는 requireSuperAdmin이므로 user 정보는 보호됩니다.
  const [contacts, setContacts] = useState<PressContact[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  // filterPurpose의 초기값은 빈 문자열("")이며, 이는 '전체'를 의미합니다.
  const [filterPurpose, setFilterPurpose] = useState<string>("");
  
  // Sheet 및 Dialog 상태
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [currentContact, setCurrentContact] = useState<PressContact | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // 폼 데이터 상태
  const [formData, setFormData] = useState({
    media_company: "",
    reporter_name: "",
    contact_phone: "",
    contact_email: "",
    purpose: "", // DB에 null이 들어가야 하므로 ""을 기본값으로 사용
  });

  // --- 데이터 로드 ---
  const fetchContacts = async () => {
    setLoading(true);
    let query = supabase.from("press_contacts").select("*").order("created_at", { ascending: false });
    
    // 검색 쿼리 적용 (언론사, 기자명 OR 조건 검색)
    if (searchQuery) {
      query = query.or(`media_company.ilike.%${searchQuery}%,reporter_name.ilike.%${searchQuery}%`);
    }
    // 목적 필터 적용: filterPurpose가 ""일 때는 전체 조회
    if (filterPurpose && filterPurpose !== "ALL") { // ALL은 필터링 전체 항목을 위한 임시 값
      query = query.eq("purpose", filterPurpose);
    }
    // '선택 안 함' 항목은 purpose가 null인 경우를 조회합니다.
    if (filterPurpose === "N/A") {
      query = query.is("purpose", null);
    }


    const { data, error } = await query;
    
    if (error) {
      console.error("Error fetching press contacts:", error);
      // RLS 에러는 보통 권한 문제(is_sys_super_admin 함수 오류 등)이므로 디버깅 안내
      toast.error("연락처를 불러오는데 실패했습니다. (DB/RLS 정책 확인 필요)");
    } else {
      setContacts(data as PressContact[]);
    }
    setLoading(false);
  };

  // --- useEffect: 데이터 로드 및 실시간 구독 ---
  useEffect(() => {
    fetchContacts();
    
    // 실시간 업데이트 구독: DB 변경 시 목록 자동 갱신
    const channel = supabase
      .channel('press_contacts_changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'press_contacts' }, 
        () => fetchContacts()
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [searchQuery, filterPurpose]); // 검색/필터 변경 시 재조회

  // --- CRUD 핸들러: 저장 (Create/Update) ---
  const handleSave = async () => {
    if (!formData.media_company || !formData.reporter_name || !formData.contact_email) {
      toast.error("언론사, 기자명, 이메일은 필수 입력 항목입니다.");
      return;
    }

    setIsSaving(true);
    try {
      // DB에 저장할 최종 페이로드
      const payload: Omit<PressContact, 'id' | 'created_at' | 'updated_at' | 'created_by'> = { 
        media_company: formData.media_company,
        reporter_name: formData.reporter_name,
        contact_email: formData.contact_email,
        contact_phone: formData.contact_phone || null,
        // purpose가 ""이면 DB에 NULL이 들어가도록 처리합니다.
        purpose: formData.purpose === "N/A" || !formData.purpose ? null : formData.purpose, 
      };

      if (currentContact) {
        // Update 모드
        const { error } = await supabase
          .from("press_contacts")
          .update(payload)
          .eq("id", currentContact.id);
        if (error) throw error;
        toast.success(`${formData.media_company} 기자 정보를 수정했습니다.`);
      } else {
        // Create 모드
        const { error } = await supabase
          .from("press_contacts")
          .insert(payload);
        if (error) throw error;
        toast.success(`${formData.media_company} 기자 정보를 새로 등록했습니다.`);
      }

      setIsSheetOpen(false);
    } catch (error: any) {
      console.error("Save error:", error);
      let errorMessage = error.message;
      if (error.code === '23505' && errorMessage.includes('contact_email')) {
          errorMessage = "이미 등록된 이메일 주소입니다. 이메일 주소는 중복될 수 없습니다.";
      }
      toast.error(`저장 실패: ${errorMessage}`);
    } finally {
      setIsSaving(false);
    }
  };

  // --- CRUD 핸들러: 삭제 (Delete) ---
  const handleDelete = async () => {
    if (!currentContact) return;
    setIsSaving(true);
    try {
      const { error } = await supabase
        .from("press_contacts")
        .delete()
        .eq("id", currentContact.id);
      if (error) throw error;
      toast.success(`${currentContact.reporter_name} 기자 정보를 삭제했습니다.`);
      setIsDeleteDialogOpen(false);
    } catch (error: any) {
      toast.error(`삭제 실패: ${error.message || "서버 오류가 발생했습니다."}`);
    } finally {
      setIsSaving(false);
      setCurrentContact(null);
    }
  };

  // --- UI 상호작용 ---
  // --- 엑셀 템플릿 다운로드 ---
  const handleDownloadTemplate = () => {
    const templateData = [
      { "언론사": "조선일보", "기자명": "홍길동", "이메일": "hong@chosun.com", "연락처": "010-1234-5678", "목적": "PR (언론 홍보)" },
      { "언론사": "블로터", "기자명": "김철수", "이메일": "kim@bloter.net", "연락처": "010-9876-5432", "목적": "" },
    ];
    const ws = XLSX.utils.json_to_sheet(templateData);
    ws["!cols"] = [{ wch: 15 }, { wch: 10 }, { wch: 25 }, { wch: 15 }, { wch: 20 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "연락처");
    XLSX.writeFile(wb, "미디어_연락처_템플릿.xlsx");
    toast.success("템플릿 파일이 다운로드되었습니다.");
  };

  // --- 엑셀 업로드 처리 ---
  const handleExcelUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    // 파일 input 초기화
    if (fileInputRef.current) fileInputRef.current.value = "";

    setIsUploading(true);
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json<Record<string, string>>(sheet);

      if (rows.length === 0) {
        toast.error("엑셀 파일에 데이터가 없습니다.");
        setIsUploading(false);
        return;
      }

      // 컬럼 매핑 (한글 헤더 → DB 컬럼)
      const mapped = rows.map((row) => ({
        media_company: (row["언론사"] || "").toString().trim(),
        reporter_name: (row["기자명"] || "").toString().trim(),
        contact_email: (row["이메일"] || "").toString().trim(),
        contact_phone: (row["연락처"] || "").toString().trim() || null,
        purpose: (row["목적"] || "").toString().trim() || null,
      }));

      // 필수값 검증: 누락된 행은 건너뛰고 유효한 행만 처리
      const valid = mapped.filter((r) => r.media_company && r.reporter_name && r.contact_email);
      const skippedCount = mapped.length - valid.length;

      if (valid.length === 0) {
        toast.error("유효한 데이터가 없습니다. 언론사, 기자명, 이메일은 필수입니다.");
        setIsUploading(false);
        return;
      }

      // 기존 연락처 조회 (이메일 기준 중복 체크)
      const { data: existing } = await supabase
        .from("press_contacts")
        .select("id, contact_email");

      const existingMap = new Map<string, string>();
      (existing || []).forEach((c) => existingMap.set(c.contact_email, c.id));

      let insertCount = 0;
      let updateCount = 0;
      let errorCount = 0;
      const processedEmails = new Set<string>();

      // 업서트 처리 (이메일 기준, 엑셀 내 중복도 처리)
      for (const row of valid) {
        // 엑셀 내 같은 이메일 중복 방지: 마지막 행이 우선
        if (processedEmails.has(row.contact_email)) {
          // 이미 이번 업로드에서 처리한 이메일 → 업데이트로 처리
          try {
            const { error } = await supabase
              .from("press_contacts")
              .update({
                media_company: row.media_company,
                reporter_name: row.reporter_name,
                contact_phone: row.contact_phone,
                purpose: row.purpose,
              })
              .eq("contact_email", row.contact_email);
            if (error) throw error;
            updateCount++;
          } catch {
            errorCount++;
          }
          continue;
        }
        processedEmails.add(row.contact_email);

        const existingId = existingMap.get(row.contact_email);
        if (existingId) {
          try {
            const { error } = await supabase
              .from("press_contacts")
              .update({
                media_company: row.media_company,
                reporter_name: row.reporter_name,
                contact_phone: row.contact_phone,
                purpose: row.purpose,
              })
              .eq("id", existingId);
            if (error) throw error;
            updateCount++;
          } catch {
            errorCount++;
          }
        } else {
          try {
            const { error } = await supabase
              .from("press_contacts")
              .insert(row);
            if (error) throw error;
            insertCount++;
          } catch {
            errorCount++;
          }
        }
      }

      let msg = `업로드 완료: 신규 ${insertCount}건, 업데이트 ${updateCount}건`;
      if (skippedCount > 0) msg += `, 누락 건너뜀 ${skippedCount}건`;
      if (errorCount > 0) msg += `, 오류 ${errorCount}건`;
      toast.success(msg);
      fetchContacts();
    } catch (error: any) {
      console.error("Excel upload error:", error);
      toast.error(`업로드 실패: ${error.message}`);
    } finally {
      setIsUploading(false);
    }
  };

  // --- UI 상호작용 ---
  const handleNewContact = () => {
    setCurrentContact(null);
    setFormData({ media_company: "", reporter_name: "", contact_phone: "", contact_email: "", purpose: "" }); 
    setIsSheetOpen(true);
  };

  const handleEditContact = (contact: PressContact) => {
    setCurrentContact(contact);
    // 폼에 현재 연락처 정보 채우기: purpose가 null이면 빈 문자열("")로 채움
    setFormData({
      media_company: contact.media_company,
      reporter_name: contact.reporter_name,
      contact_phone: contact.contact_phone || "",
      contact_email: contact.contact_email,
      purpose: contact.purpose || "",
    });
    setIsSheetOpen(true);
  };

  const handleOpenDelete = (contact: PressContact) => {
    setCurrentContact(contact);
    setIsDeleteDialogOpen(true);
  };

  return (
    <div className="min-h-screen bg-background text-foreground">
      <Header />

      <main className="pt-24 pb-16 px-4 max-w-7xl mx-auto">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
          <div className="flex items-center gap-3">
            <button onClick={() => navigate("/super-admin")} className="text-muted-foreground hover:text-foreground">
              <ArrowLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
                <Terminal className="w-6 h-6 text-primary" /> 미디어 연락처 관리
              </h1>
              <p className="text-muted-foreground mt-1">
                전 고객사가 공유할 수 있는 언론사/기자 통합 데이터베이스입니다.
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-2 flex-wrap">
            <input
              ref={fileInputRef}
              type="file"
              accept=".xlsx,.xls,.csv"
              className="hidden"
              onChange={handleExcelUpload}
            />
            <Button variant="outline" className="gap-2" onClick={handleDownloadTemplate}>
              <Download className="w-4 h-4" /> 템플릿 다운로드
            </Button>
            <Button
              variant="outline"
              className="gap-2"
              onClick={() => fileInputRef.current?.click()}
              disabled={isUploading}
            >
              {isUploading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Upload className="w-4 h-4" />}
              엑셀 업로드
            </Button>
            <Button variant="hero" className="gap-2" size="lg" onClick={handleNewContact}>
              <Plus className="w-5 h-5" /> 새 연락처 등록
            </Button>
          </div>
        </div>

        {/* 필터 및 검색 바 */}
        <Card className="glass-card shadow-sm border border-border mb-8">
          <CardContent className="pt-4 flex flex-col sm:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
              <Input 
                placeholder="언론사, 기자명으로 검색" 
                className="pl-9 bg-secondary/50 border-none h-10 text-sm"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
            
            {/* [수정 반영] Select 오류 수정 및 필터링 로직 강화 */}
            <div className="flex items-center gap-2 w-full sm:w-auto">
              <Filter className="w-4 h-4 text-muted-foreground shrink-0" />
              <Select onValueChange={setFilterPurpose} value={filterPurpose}>
                <SelectTrigger className="w-full sm:w-[150px] bg-secondary/50 border-none h-10">
                  <SelectValue placeholder="목적 필터" />
                </SelectTrigger>
                <SelectContent>
                  {/* [수정] 빈 문자열 대신 유효한 값을 사용하거나, 아예 제거 */}
                  {/* '전체'와 '선택 안 함'을 필터링 옵션으로 명시 */}
                  <SelectItem value="ALL">전체 목적</SelectItem> 
                  <SelectItem value="N/A">목적 미지정</SelectItem> 
                  {purposeOptions.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
                        
            <Button variant="outline" className="w-full sm:w-auto" onClick={() => { setSearchQuery(""); setFilterPurpose(""); }}>
              초기화
            </Button>
          </CardContent>
        </Card>

        {/* 연락처 목록 테이블 */}
        <div className="glass-card overflow-hidden shadow-sm border border-border">
          <Table>
            <TableHeader className="bg-secondary/50">
              <TableRow>
                <TableHead className="w-[150px]">언론사</TableHead>
                <TableHead className="w-[120px]">기자명</TableHead>
                <TableHead>이메일</TableHead>
                <TableHead>연락처</TableHead>
                <TableHead className="w-[150px]">목적</TableHead>
                <TableHead className="text-right w-[80px]">액션</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow><TableCell colSpan={6} className="h-32 text-center"><Loader2 className="w-8 h-8 animate-spin mx-auto text-primary" /></TableCell></TableRow>
              ) : contacts.length > 0 ? (
                contacts.map((contact) => (
                  <TableRow key={contact.id} className="hover:bg-secondary/30 transition-colors">
                    <TableCell className="font-semibold text-sm">{contact.media_company}</TableCell>
                    <TableCell className="text-sm">{contact.reporter_name}</TableCell>
                    <TableCell className="text-sm text-primary flex items-center gap-2">
                        <Mail className="w-3 h-3 text-muted-foreground" />
                        {contact.contact_email}
                    </TableCell>
                    <TableCell className="text-sm text-muted-foreground flex items-center gap-2">
                        <Phone className="w-3 h-3" />
                        {contact.contact_phone || "-"}
                    </TableCell>
                    <TableCell className="text-xs text-muted-foreground">{contact.purpose || "미지정"}</TableCell>
                    <TableCell className="text-right">
                        <Button variant="ghost" size="icon" className="w-8 h-8" onClick={() => handleEditContact(contact)}>
                            <Edit2 className="w-4 h-4 text-blue-500" />
                        </Button>
                        <Button variant="ghost" size="icon" className="w-8 h-8 text-destructive" onClick={() => handleOpenDelete(contact)}>
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow><TableCell colSpan={6} className="h-32 text-center text-muted-foreground">등록된 미디어 연락처가 없습니다.</TableCell></TableRow>
              )}
            </TableBody>
          </Table>
        </div>
      </main>
      
      {/* --- 연락처 추가/수정 Sheet --- */}
      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className="sm:max-w-md p-0 overflow-hidden flex flex-col">
          <SheetHeader className="p-6 border-b">
            <SheetTitle className="text-xl font-bold flex items-center gap-2">
                <Users className="w-5 h-5 text-primary" /> 
                {currentContact ? "연락처 수정" : "새 연락처 등록"}
            </SheetTitle>
          </SheetHeader>
          <div className="p-6 space-y-6 overflow-y-auto flex-1">
            <div className="space-y-2">
              <Label htmlFor="media_company">언론사/매체명 *</Label>
              <Input 
                id="media_company" 
                placeholder="예: 조선일보, 블로터" 
                value={formData.media_company} 
                onChange={(e) => setFormData({...formData, media_company: e.target.value})}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="reporter_name">기자명 *</Label>
              <Input 
                id="reporter_name" 
                placeholder="예: 홍길동" 
                value={formData.reporter_name} 
                onChange={(e) => setFormData({...formData, reporter_name: e.target.value})}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="contact_email">이메일 *</Label>
              <Input 
                id="contact_email" 
                type="email"
                placeholder="reporter@media.com" 
                value={formData.contact_email} 
                onChange={(e) => setFormData({...formData, contact_email: e.target.value})}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="contact_phone">연락처</Label>
              <Input 
                id="contact_phone" 
                placeholder="010-0000-0000" 
                value={formData.contact_phone} 
                onChange={(e) => setFormData({...formData, contact_phone: e.target.value})}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="purpose">목적 (필터링 용도)</Label>
              <Select value={formData.purpose} onValueChange={(val) => setFormData({...formData, purpose: val})}>
                <SelectTrigger id="purpose">
                  <SelectValue placeholder="목적 선택" />
                </SelectTrigger>
                <SelectContent>
                  {/* [수정] Select 오류를 막기 위해 유효한 값('N/A')을 사용하고, 
                       DB에는 null이 들어가도록 핸들러에서 처리합니다. */}
                  <SelectItem value="N/A">선택 안 함</SelectItem> 
                  {purposeOptions.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}
                </SelectContent>
              </Select>
            </div>
          </div>
          <SheetFooter className="p-6 border-t">
            <SheetClose asChild>
              <Button variant="outline" disabled={isSaving}>취소</Button>
            </SheetClose>
            <Button onClick={handleSave} disabled={isSaving || !formData.media_company || !formData.reporter_name || !formData.contact_email}>
              {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
              {currentContact ? "수정 완료" : "등록"}
            </Button>
          </SheetFooter>
        </SheetContent>
      </Sheet>

      {/* --- 삭제 확인 AlertDialog --- */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-destructive font-bold text-xl">연락처를 삭제하시겠습니까?</AlertDialogTitle>
            <AlertDialogDescription className="py-2">
              **{currentContact?.reporter_name} 기자 ({currentContact?.media_company})**의 연락처가 영구적으로 삭제됩니다. 이 작업은 되돌릴 수 없습니다.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isSaving}>취소</AlertDialogCancel>
            <AlertDialogAction 
                onClick={handleDelete} 
                disabled={isSaving} 
                className="bg-destructive hover:bg-destructive/90 text-destructive-foreground"
            >
              {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Trash2 className="w-4 h-4 mr-2" />}
              삭제 확정
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

    </div>
  );
};

export default PressContacts;


============================================================
File Path: src/pages/SuperAdmin/WorkRuleDefaults.tsx
============================================================
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Header } from "@/components/landing/Header";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from "@/components/ui/separator";
import { Checkbox } from "@/components/ui/checkbox";
import {
  ArrowLeft, Plus, Save, Loader2, Trash2, Clock,
  ShieldCheck, PenTool, AlertTriangle,
} from "lucide-react";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";

interface WorkRule {
  id: string;
  name: string;
  work_days: string[];
  standard_work_unit: string;
  standard_work_hours: number;
  overtime_min_unit: string;
  overtime_min_hours: number;
  overtime_max_unit: string;
  overtime_max_hours: number;
  standard_period: string;
  standard_period_start_day: number | null;
  standard_include_holidays: boolean;
  max_work_unit: string;
  max_work_hours: number;
  max_period: string;
  max_period_start_day: number | null;
  max_include_holidays: boolean;
  is_default: boolean;
  is_active: boolean;
  description: string | null;
  created_at: string;
}

const ALL_DAYS = ["월", "화", "수", "목", "금", "토", "일"];
const UNITS = ["1일", "1주", "1개월"];
const PERIODS = ["1주", "2주", "1개월", "3개월", "6개월", "1년"];

const WorkRuleDefaults = () => {
  const navigate = useNavigate();
  const [rules, setRules] = useState<WorkRule[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [editingRule, setEditingRule] = useState<Partial<WorkRule> | null>(null);
  const [isNew, setIsNew] = useState(false);

  const fetchRules = async () => {
    setLoading(true);
    const { data, error } = await supabase
      .from("work_rules")
      .select("*")
      .is("tenant_id", null)
      .order("created_at", { ascending: false });
    if (data) setRules(data as unknown as WorkRule[]);
    if (error) toast.error("불러오기 실패: " + error.message);
    setLoading(false);
  };

  useEffect(() => { fetchRules(); }, []);

  const openNew = () => {
    setIsNew(true);
    setEditingRule({
      name: "",
      work_days: ["월", "화", "수", "목", "금"],
      standard_work_unit: "1주",
      standard_work_hours: 40,
      overtime_min_unit: "1주",
      overtime_min_hours: 0,
      overtime_max_unit: "1주",
      overtime_max_hours: 12,
      standard_period: "1주",
      standard_period_start_day: 1,
      standard_include_holidays: false,
      max_work_unit: "1주",
      max_work_hours: 52,
      max_period: "1주",
      max_period_start_day: 1,
      max_include_holidays: false,
      is_default: false,
      is_active: true,
      description: "",
    });
  };

  const openEdit = (rule: WorkRule) => {
    setIsNew(false);
    setEditingRule({ ...rule });
  };

  const saveRule = async () => {
    if (!editingRule?.name) { toast.error("규칙명을 입력해주세요."); return; }
    setSaving(true);
    try {
      const payload = {
        name: editingRule.name,
        work_days: editingRule.work_days || ["월", "화", "수", "목", "금"],
        standard_work_unit: editingRule.standard_work_unit || "1주",
        standard_work_hours: editingRule.standard_work_hours || 40,
        overtime_min_unit: editingRule.overtime_min_unit || "1주",
        overtime_min_hours: editingRule.overtime_min_hours || 0,
        overtime_max_unit: editingRule.overtime_max_unit || "1주",
        overtime_max_hours: editingRule.overtime_max_hours || 12,
        standard_period: editingRule.standard_period || "1주",
        standard_period_start_day: editingRule.standard_period_start_day,
        standard_include_holidays: editingRule.standard_include_holidays || false,
        max_work_unit: editingRule.max_work_unit || "1주",
        max_work_hours: editingRule.max_work_hours || 52,
        max_period: editingRule.max_period || "1주",
        max_period_start_day: editingRule.max_period_start_day,
        max_include_holidays: editingRule.max_include_holidays || false,
        is_default: editingRule.is_default || false,
        is_active: editingRule.is_active !== false,
        description: editingRule.description || null,
        tenant_id: null,
      };

      if (isNew) {
        const { error } = await supabase.from("work_rules").insert(payload as any);
        if (error) throw error;
        toast.success("근로규칙이 등록되었습니다.");
      } else {
        const { error } = await supabase.from("work_rules").update(payload as any).eq("id", editingRule.id!);
        if (error) throw error;
        toast.success("근로규칙이 수정되었습니다.");
      }
      setEditingRule(null);
      fetchRules();
    } catch (e: any) {
      toast.error("저장 실패: " + e.message);
    } finally {
      setSaving(false);
    }
  };

  const deleteRule = async (id: string) => {
    if (!confirm("이 근로규칙을 삭제하시겠습니까?")) return;
    const { error } = await supabase.from("work_rules").delete().eq("id", id);
    if (error) toast.error("삭제 실패: " + error.message);
    else { toast.success("삭제되었습니다."); fetchRules(); }
  };

  const toggleDay = (day: string) => {
    if (!editingRule) return;
    const days = editingRule.work_days || [];
    setEditingRule({
      ...editingRule,
      work_days: days.includes(day) ? days.filter(d => d !== day) : [...days, day],
    });
  };

  return (
    <div className="min-h-screen bg-slate-50">
      <Header />
      <main className="pt-24 pb-16 px-4 max-w-5xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <Button variant="ghost" size="sm" className="gap-1 mb-2" onClick={() => navigate("/super-admin")}>
              <ArrowLeft className="w-4 h-4" /> Super Admin
            </Button>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Clock className="w-6 h-6 text-primary" /> 근로규칙 기본값 관리
            </h1>
            <p className="text-muted-foreground text-sm mt-1">
              모든 회사에 초기 셋팅값으로 부여될 소정근로규칙 및 최대근로규칙을 관리합니다.
            </p>
          </div>
          <Button onClick={openNew} className="gap-1.5">
            <Plus className="w-4 h-4" /> 근로규칙 추가
          </Button>
        </div>

        {/* 편집 폼 */}
        {editingRule && (
          <Card className="border-2 border-primary/20 shadow-lg">
            <CardHeader>
              <CardTitle className="text-base flex items-center gap-2">
                <PenTool className="w-4 h-4 text-primary" />
                {isNew ? "새 근로규칙 등록" : "근로규칙 수정"}
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* 기본정보 */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label className="text-xs font-semibold">규칙명 *</Label>
                  <Input
                    value={editingRule.name || ""}
                    onChange={e => setEditingRule({ ...editingRule, name: e.target.value })}
                    placeholder="예: 주 52시간제 (기본)"
                    className="mt-1"
                  />
                </div>
                <div>
                  <Label className="text-xs font-semibold">설명</Label>
                  <Input
                    value={editingRule.description || ""}
                    onChange={e => setEditingRule({ ...editingRule, description: e.target.value })}
                    placeholder="규칙 설명"
                    className="mt-1"
                  />
                </div>
              </div>

              {/* 소정근로요일 */}
              <div>
                <Label className="text-xs font-semibold mb-2 block">소정근로요일</Label>
                <div className="flex gap-2">
                  {ALL_DAYS.map(day => (
                    <button
                      key={day}
                      onClick={() => toggleDay(day)}
                      className={`w-10 h-10 rounded-lg text-sm font-bold transition-all ${
                        (editingRule.work_days || []).includes(day)
                          ? "bg-primary text-primary-foreground shadow-sm"
                          : "bg-muted text-muted-foreground hover:bg-muted/80"
                      }`}
                    >
                      {day}
                    </button>
                  ))}
                </div>
              </div>

              <Separator />

              {/* 소정근로규칙 */}
              <div>
                <h4 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <Clock className="w-4 h-4 text-blue-500" /> 소정근로규칙
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <Label className="text-xs">소정근로 단위</Label>
                    <Select
                      value={editingRule.standard_work_unit}
                      onValueChange={v => setEditingRule({ ...editingRule, standard_work_unit: v })}
                    >
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label className="text-xs">소정근로시간</Label>
                    <Input
                      type="number"
                      value={editingRule.standard_work_hours ?? 40}
                      onChange={e => setEditingRule({ ...editingRule, standard_work_hours: Number(e.target.value) })}
                      className="mt-1"
                    />
                  </div>
                  <div>
                    <Label className="text-xs">연장근로 최소기준</Label>
                    <div className="flex gap-1 mt-1">
                      <Select
                        value={editingRule.overtime_min_unit}
                        onValueChange={v => setEditingRule({ ...editingRule, overtime_min_unit: v })}
                      >
                        <SelectTrigger className="w-20"><SelectValue /></SelectTrigger>
                        <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                      </Select>
                      <Input
                        type="number"
                        value={editingRule.overtime_min_hours ?? 0}
                        onChange={e => setEditingRule({ ...editingRule, overtime_min_hours: Number(e.target.value) })}
                        className="flex-1"
                        placeholder="시간"
                      />
                    </div>
                  </div>
                  <div>
                    <Label className="text-xs">연장근로 최대기준</Label>
                    <div className="flex gap-1 mt-1">
                      <Select
                        value={editingRule.overtime_max_unit}
                        onValueChange={v => setEditingRule({ ...editingRule, overtime_max_unit: v })}
                      >
                        <SelectTrigger className="w-20"><SelectValue /></SelectTrigger>
                        <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                      </Select>
                      <Input
                        type="number"
                        value={editingRule.overtime_max_hours ?? 12}
                        onChange={e => setEditingRule({ ...editingRule, overtime_max_hours: Number(e.target.value) })}
                        className="flex-1"
                        placeholder="시간"
                      />
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
                  <div>
                    <Label className="text-xs">단위기간</Label>
                    <Select
                      value={editingRule.standard_period}
                      onValueChange={v => setEditingRule({ ...editingRule, standard_period: v })}
                    >
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{PERIODS.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div className="flex items-end gap-2 pb-1">
                    <div className="flex items-center gap-2">
                      <Switch
                        checked={editingRule.standard_include_holidays}
                        onCheckedChange={v => setEditingRule({ ...editingRule, standard_include_holidays: v })}
                      />
                      <Label className="text-xs">휴일 포함</Label>
                    </div>
                  </div>
                </div>
              </div>

              <Separator />

              {/* 최대근로규칙 */}
              <div>
                <h4 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <AlertTriangle className="w-4 h-4 text-amber-500" /> 최대근로규칙
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <Label className="text-xs">최대근로 단위</Label>
                    <Select
                      value={editingRule.max_work_unit}
                      onValueChange={v => setEditingRule({ ...editingRule, max_work_unit: v })}
                    >
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{UNITS.map(u => <SelectItem key={u} value={u}>{u}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label className="text-xs">최대근로시간</Label>
                    <Input
                      type="number"
                      value={editingRule.max_work_hours ?? 52}
                      onChange={e => setEditingRule({ ...editingRule, max_work_hours: Number(e.target.value) })}
                      className="mt-1"
                    />
                  </div>
                  <div>
                    <Label className="text-xs">단위기간</Label>
                    <Select
                      value={editingRule.max_period}
                      onValueChange={v => setEditingRule({ ...editingRule, max_period: v })}
                    >
                      <SelectTrigger className="mt-1"><SelectValue /></SelectTrigger>
                      <SelectContent>{PERIODS.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}</SelectContent>
                    </Select>
                  </div>
                  <div className="flex items-end gap-2 pb-1">
                    <div className="flex items-center gap-2">
                      <Switch
                        checked={editingRule.max_include_holidays}
                        onCheckedChange={v => setEditingRule({ ...editingRule, max_include_holidays: v })}
                      />
                      <Label className="text-xs">휴일 포함</Label>
                    </div>
                  </div>
                </div>
              </div>

              <Separator />

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-2">
                    <Switch
                      checked={editingRule.is_default}
                      onCheckedChange={v => setEditingRule({ ...editingRule, is_default: v })}
                    />
                    <Label className="text-xs">기본 규칙으로 설정</Label>
                  </div>
                  <div className="flex items-center gap-2">
                    <Switch
                      checked={editingRule.is_active !== false}
                      onCheckedChange={v => setEditingRule({ ...editingRule, is_active: v })}
                    />
                    <Label className="text-xs">활성화</Label>
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button variant="ghost" size="sm" onClick={() => setEditingRule(null)}>취소</Button>
                  <Button size="sm" onClick={saveRule} disabled={saving}>
                    {saving ? <Loader2 className="w-4 h-4 animate-spin mr-1" /> : <Save className="w-4 h-4 mr-1" />}
                    저장
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* 규칙 목록 */}
        {loading ? (
          <div className="flex justify-center py-12"><Loader2 className="w-6 h-6 animate-spin text-muted-foreground" /></div>
        ) : rules.length === 0 ? (
          <Card className="border-dashed">
            <CardContent className="py-12 text-center text-muted-foreground">
              <Clock className="w-10 h-10 mx-auto mb-3 opacity-30" />
              <p className="text-sm">등록된 기본 근로규칙이 없습니다.</p>
              <p className="text-xs mt-1">위의 버튼을 눌러 규칙을 추가하세요.</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-3">
            {rules.map(rule => (
              <Card key={rule.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-5">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className="font-bold text-sm">{rule.name}</h3>
                        {rule.is_default && <Badge variant="default" className="text-[10px]">기본값</Badge>}
                        <Badge variant={rule.is_active ? "secondary" : "outline"} className="text-[10px]">
                          {rule.is_active ? "활성" : "비활성"}
                        </Badge>
                      </div>
                      {rule.description && <p className="text-xs text-muted-foreground mb-3">{rule.description}</p>}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                        <div className="bg-blue-50 rounded-lg p-2.5">
                          <p className="text-blue-400 font-medium mb-0.5">소정근로</p>
                          <p className="font-bold text-blue-700">{rule.standard_work_unit} {rule.standard_work_hours}시간</p>
                        </div>
                        <div className="bg-amber-50 rounded-lg p-2.5">
                          <p className="text-amber-400 font-medium mb-0.5">연장근로</p>
                          <p className="font-bold text-amber-700">최소 {rule.overtime_min_hours}h / 최대 {rule.overtime_max_hours}h</p>
                        </div>
                        <div className="bg-red-50 rounded-lg p-2.5">
                          <p className="text-red-400 font-medium mb-0.5">최대근로</p>
                          <p className="font-bold text-red-700">{rule.max_work_unit} {rule.max_work_hours}시간</p>
                        </div>
                        <div className="bg-slate-50 rounded-lg p-2.5">
                          <p className="text-slate-400 font-medium mb-0.5">소정근로요일</p>
                          <p className="font-bold text-slate-700">{(rule.work_days || []).join(", ")}</p>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-1 ml-4">
                      <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openEdit(rule)}>
                        <PenTool className="w-3.5 h-3.5" />
                      </Button>
                      <Button variant="ghost" size="icon" className="h-8 w-8 text-destructive" onClick={() => deleteRule(rule.id)}>
                        <Trash2 className="w-3.5 h-3.5" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </main>
    </div>
  );
};

export default WorkRuleDefaults;



============================================================
File Path: src/test/example.test.ts
============================================================
import { describe, it, expect } from "vitest";

describe("example", () => {
  it("should pass", () => {
    expect(true).toBe(true);
  });
});



============================================================
File Path: src/test/setup.ts
============================================================
import "@testing-library/jest-dom";

Object.defineProperty(window, "matchMedia", {
  writable: true,
  value: (query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: () => {},
    removeListener: () => {},
    addEventListener: () => {},
    removeEventListener: () => {},
    dispatchEvent: () => {},
  }),
});

